```sql
select * from information_schema.processlist where time > 10 and info is not null;

SELECT * 
FROM information_schema.processlist
WHERE INFO LIKE 'INSERT%' 
   OR INFO LIKE 'UPDATE%' 
   OR INFO LIKE 'DELETE%' 
   OR INFO LIKE 'SELECT%';


SELECT * 
FROM information_schema.processlist
WHERE INFO IS NOT NULL;
```

以下是我为你整理的 **MySQL 日常运维命令合集文档**，内容包括常用 SQL 命令、监控诊断语句、故障排查技巧及注释，适合日常巡检、调优、故障处理等场景使用。也提供部分 Shell 命令配合使用。

---

# 🐬 MySQL 日常运维命令合集（含注释）
适用版本：MySQL 5.7 / 8.0  
推荐工具：MySQL CLI / Shell / watch / pt-query-digest

---

## 📁 1. 数据库与表管理
```sql
-- 查看所有数据库
SHOW DATABASES;

-- 查看当前使用的数据库
SELECT DATABASE();

-- 切换数据库
USE your_db;

-- 查看某库下的所有表
SHOW TABLES;

-- 查看表结构
DESC your_table;
SHOW CREATE TABLE your_table\G;

-- 创建数据库（UTF8MB4 推荐用于支持 Emoji 等）
CREATE DATABASE your_db DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_general_ci;

-- 删除数据库
DROP DATABASE your_db;
```

---

## 🧾 2. 表操作命令（数据与结构）
```sql
-- 查询前10行数据
SELECT * FROM your_table LIMIT 10;

-- 插入数据
INSERT INTO your_table (col1, col2) VALUES ('val1', 'val2');

-- 更新数据
UPDATE your_table SET col1='new_value' WHERE id=1;

-- 删除数据
DELETE FROM your_table WHERE id=1;

-- 复制表结构（不带数据）
CREATE TABLE new_table LIKE your_table;

-- 复制表结构和数据
CREATE TABLE new_table AS SELECT * FROM your_table;
```

---

## 🔍 3. 查询当前连接与执行状态
```sql
-- 当前连接总数
SHOW STATUS LIKE 'Threads_connected';

-- 最大历史连接数
SHOW STATUS LIKE 'Max_used_connections';

-- 查看所有连接和执行语句
SELECT * FROM information_schema.processlist WHERE INFO IS NOT NULL;

-- 查看正在执行 SELECT/INSERT/UPDATE/DELETE 的语句
SELECT * FROM information_schema.processlist 
WHERE INFO REGEXP '^(SELECT|INSERT|UPDATE|DELETE)' AND COMMAND = 'Query';

-- 终止某个线程（慎用）
KILL 12345;  -- processlist 的 ID
```

---

## 🛠️ 4. 慢查询与性能分析
```sql
-- 是否开启慢查询日志
SHOW VARIABLES LIKE 'slow_query_log';

-- 查看慢查询日志文件位置
SHOW VARIABLES LIKE 'slow_query_log_file';

-- 设置慢查询阈值（单位：秒）
SET GLOBAL long_query_time = 1;

-- 查询慢查询次数
SHOW STATUS LIKE 'Slow_queries';
```

### 🐚 Shell 命令配合 `pt-query-digest`
```bash
# 安装 Percona 工具包后使用
pt-query-digest /var/lib/mysql/mysql-slow.log > slow_report.txt
```

---

## 📊 5. 表和数据库空间使用情况
```sql
-- 查询所有数据库大小（单位：MB）
SELECT table_schema AS db_name,
       ROUND(SUM(data_length + index_length)/1024/1024, 2) AS size_mb
FROM information_schema.tables
GROUP BY table_schema
ORDER BY size_mb DESC;

-- 查询某个表的大小
SELECT table_name,
       ROUND((data_length + index_length)/1024/1024, 2) AS size_mb
FROM information_schema.tables
WHERE table_schema = 'your_db'
ORDER BY size_mb DESC;
```

---

## 🔒 6. 锁与事务排查
### 6.1 MySQL 8.0 推荐方式（替代已弃用的 innodb_locks）
```sql
-- 查询正在持有锁的事务
SELECT * FROM performance_schema.data_locks;

-- 查询锁等待情况
SELECT * FROM performance_schema.data_lock_waits;

-- 查询事务级别信息（锁源）
SELECT * FROM performance_schema.threads 
WHERE PROCESSLIST_COMMAND = 'Query';
```

---

## 🔐 7. 用户与权限管理
```sql
-- 查看所有用户
SELECT User, Host FROM mysql.user;

-- 创建用户
CREATE USER 'user1'@'%' IDENTIFIED BY 'passwd123';

-- 授权某数据库权限
GRANT ALL PRIVILEGES ON db1.* TO 'user1'@'%';

-- 查看某用户权限
SHOW GRANTS FOR 'user1'@'%';

-- 删除用户
DROP USER 'user1'@'%';

-- 刷新权限
FLUSH PRIVILEGES;
```

---

## 🧹 8. 优化与维护命令
```sql
-- 优化表（清理碎片）
OPTIMIZE TABLE your_table;

-- 修复表（MyISAM 用）
REPAIR TABLE your_table;

-- 分析表（更新统计信息）
ANALYZE TABLE your_table;
```

---

## 🚨 9. MySQL 服务与配置排查
### 9.1 配置变量查看与修改
```sql
-- 查看某个配置变量
SHOW VARIABLES LIKE 'max_connections';

-- 动态设置变量（重启失效）
SET GLOBAL max_connections = 1000;
```

### 9.2 Shell 实时监控连接状态
```bash
# 每秒刷新当前 SQL 运行状态
watch -n 1 "mysql -e 'SELECT ID, USER, DB, TIME, STATE, INFO FROM information_schema.processlist WHERE INFO IS NOT NULL \G'"

# 当前 QPS（每秒执行的查询数）
mysqladmin -uroot -p extended-status | grep -w "Queries"
```

---

## 🧾 10. SQL备份与恢复（mysqldump）
```bash
# 备份单个数据库
mysqldump -u root -p your_db > your_db.sql

# 备份所有数据库
mysqldump -u root -p --all-databases > all.sql

# 还原数据库
mysql -u root -p your_db < your_db.sql
```

---

## 📝 建议：定期巡检脚本（可每日定时执行）
```bash
#!/bin/bash
echo "🕵️‍♂️ 当前连接数:"
mysql -e "SHOW STATUS LIKE 'Threads_connected';"

echo "📈 当前慢查询数:"
mysql -e "SHOW STATUS LIKE 'Slow_queries';"

echo "🔐 锁等待事务:"
mysql -e "SELECT * FROM performance_schema.data_lock_waits\G"

echo "📦 数据库空间使用:"
mysql -e "SELECT table_schema, ROUND(SUM(data_length+index_length)/1024/1024,2) AS size_mb FROM information_schema.tables GROUP BY table_schema;"
```

---

## 📎 附加工具推荐
| 工具名称 | 用途 |
| --- | --- |
| `mysqladmin` | 管理 MySQL 服务、状态监控 |
| `pt-query-digest` | 慢查询日志分析 |
| `mytop` | 类似 `top`<br/> 的实时连接监控工具 |


---

如需打包成 `.sh`、`.md` 或 `.pdf` 运维手册，或者集成到你们的自动巡检平台中，我可以帮你生成模板，欢迎继续告诉我目标环境或格式要求。



