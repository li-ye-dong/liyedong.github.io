---

# 📚 MySQL 8.0 学习笔记（5天计划）
---

## Day1：认识 MySQL
### 1.1 MySQL 简介
+ 什么是 MySQL？
    - 开源的关系型数据库管理系统（RDBMS）
    - 使用 SQL（结构化查询语言）进行数据管理
    - 属于 Oracle 公司维护（但仍然有社区版）
+ MySQL 的特点
    - 跨平台，稳定高效
    - 支持大型数据库（数亿行记录）
    - 支持多种存储引擎（InnoDB、MyISAM等）
    - 强大的复制、高可用和集群功能

### 1.2 安装与升级 MySQL
+ 安装方法
    - 使用官方源安装（推荐）
    - rpm/deb 包安装
    - Docker 安装（开发环	境很方便）
+ 升级注意事项
    - 备份所有数据
    - 测试兼容性（尤其是从5.x升级到8.0）
    - 使用 `mysql_upgrade` 工具更新系统表

**补充建议**：

生产环境一定不要直接覆盖升级，建议旁路安装新版本，导数据迁移。

### 1.3 理解 MySQL 架构
+ 连接层（连接管理、授权认证）
+ SQL层（解析器、优化器、缓存）
+ 存储引擎层（InnoDB最常用）
+ 日志系统（Redo、Undo、Binary Log）
+ Buffer Pool（缓存管理）

**图示**：

```plain
客户端 -> 连接层 -> SQL层 -> 存储引擎 -> 磁盘
```

---

## Day2：配置与监控
### 2.1 配置 MySQL
+ 重要配置参数
    - `max_connections`
    - `innodb_buffer_pool_size`
    - `query_cache_size`（注意：8.0已经废弃）
    - `default_authentication_plugin`
    - 字符集设置（`utf8mb4`）
+ my.cnf 文件位置
+ 启动参数 vs 配置文件参数优先级

### 2.2 监控 MySQL
+ 基础监控命令

```sql
SHOW GLOBAL STATUS;
SHOW PROCESSLIST;
SHOW VARIABLES;
```

+ 慢查询日志
+ 性能模式（Performance Schema）

**补充建议**：

安装 `Percona Toolkit` 和 `sys schema`，可以极大地提升监控分析效率！

### 2.3 管理 MySQL 用户
+ 创建用户
+ 授权与回收权限
+ 密码策略（validate_password 插件）
+ 用户登录限制（如指定IP）

---

## Day3：安全与维护
### 3.1 加固 MySQL 安全
+ 删除匿名账户
+ 关闭远程root登录
+ 开启 SSL/TLS 加密连接
+ 定期更改密码
+ 开启审计日志（需要企业版或开源插件）

### 3.2 保持系统稳定
+ 参数调优（如连接数、超时时间）
+ 日志轮转与归档
+ 定期巡检表碎片（OPTIMIZE TABLE）
+ 防止表锁死（监控锁等待）

**补充建议**：

开启 `innodb_print_all_deadlocks=ON`，便于排查死锁问题。

---

## Day4：性能与备份
### 4.1 查询优化
+ 使用正确索引
+ 读写分离（读多写少场景）
+ 减少子查询，使用 JOIN
+ 避免SELECT *，明确列名
+ 使用 `EXPLAIN` 分析执行计划
+ 用 `SHOW PROFILE` 精细分析查询步骤

### 4.2 选择备份策略
+ 逻辑备份（mysqldump）
+ 物理备份（XtraBackup）
+ 冷备（关机直接拷贝数据目录）

### 4.3 执行备份与恢复
+ 定时备份
+ 自动化备份脚本
+ 灾难恢复测试（必须验证备份有效性）

---

## Day5：复制与高可用
### 5.1 配置复制拓扑
+ 主从复制（传统）
+ 多主复制（Multi-Source Replication）
+ 延迟从库（防止误操作同步）

### 5.2 管理复制环境
+ 监控复制延迟（Seconds Behind Master）
+ GTID复制（简化故障切换）
+ 半同步复制配置（提高数据安全）

### 5.3 实现高可用：MySQL InnoDB Cluster
+ Group Replication
+ MySQL Router 配置
+ 自动故障转移

**补充建议**：

InnoDB Cluster 是官方强推的高可用方案，比传统 MHA 要简单且集成性好。

---

# 📖 结语
+ 学好 MySQL，不仅要掌握安装运维，更要理解架构原理。
+ 备份与高可用不是选项，是必备。
+ 查询优化是性能提升最直接有效的手段。
+ 监控和安全要养成习惯，不要等出问题才想起来。

---

太好了！  
那我现在就给你整理出**Day1 完整版**，按照你的要求，内容**详细到命令行操作、配置示例、注意事项**，并加上我自己的**补充建议**，保证学习起来非常顺畅。

---

# 📚 MySQL 8.0 学习笔记 Day1 完整版
（Introduction to MySQL + Installing and Upgrading MySQL + Understanding MySQL Architecture）

---

## 1.1 认识 MySQL
### 什么是 MySQL？
+ MySQL 是一个开源的关系型数据库管理系统（RDBMS）。
+ 由瑞典 MySQL AB 公司开发，后来被 Oracle 收购。
+ 当前主流版本是 MySQL 8.0 系列。
+ 使用 SQL（结构化查询语言）进行数据管理。

**特点：**

+ 开源免费，社区活跃。
+ 支持海量数据，事务处理能力强（尤其是 InnoDB 存储引擎）。
+ 支持主从复制、分区、全文索引、GIS功能。
+ 丰富的连接器（如 JDBC、ODBC、Python、PHP、Node.js）。

---

### MySQL 和其他数据库对比
| 特性 | MySQL | PostgreSQL | Oracle |
| --- | --- | --- | --- |
| 事务支持 | 很好（InnoDB） | 更好（原生支持） | 完美（商业级） |
| 扩展性 | 中等 | 很高 | 很高 |
| 易用性 | 非常好 | 稍复杂 | 较复杂 |
| 成本 | 低 | 低 | 很高 |


**补充：**

MySQL 更适合 Web 应用场景，尤其是中小型项目和互联网公司。

---

## 1.2 安装与升级 MySQL
### MySQL 安装（以 CentOS 和 Ubuntu 为例）
#### 🛠 CentOS 安装示例（推荐官方源）
```bash
# 1. 安装官方YUM源
yum install https://dev.mysql.com/get/mysql80-community-release-el8-1.noarch.rpm -y

yum makecache
# 2. 安装 MySQL Server 和客户端
sudo yum install -y mysql-server mysql --nogpgcheck

# 3. 启动并设置开机自启
sudo systemctl start mysqld
sudo systemctl enable mysqld
```

🔔 **注意**：安装完后，MySQL会自动生成一个随机 root 密码，在 `/var/log/mysqld.log` 里。

查看初始密码：

```bash
sudo grep 'temporary password' /var/log/mysqld.log
```

第一次登录并修改密码：

```bash
mysql -uroot -p
ALTER USER 'root'@'localhost' IDENTIFIED BY 'P@ssw0rd';
```

---

#### 🛠 Ubuntu 安装示例
```bash
# 1. 更新包
sudo apt update

# 2. 安装 MySQL Server
sudo apt install mysql-server

# 3. 检查服务状态
sudo systemctl status mysql
```

配置 root 密码：

```bash
sudo mysql_secure_installation
```

这个命令会引导你完成：

+ 设置 root 密码
+ 删除匿名用户
+ 禁止远程root登录
+ 删除测试数据库

---

### Docker 安装示例（开发环境快速部署）
```bash
docker run --name mysql8 -e MYSQL_ROOT_PASSWORD=my-secret-pw -p 3306:3306 -d mysql:8.0
```

**补充建议：**

建议在生产环境还是用裸机或虚拟机部署，Docker适合开发环境。

---

### MySQL 升级指南
1. **备份所有数据！**
2. **检查版本兼容性**：
    - 5.7 升级到 8.0 时注意 JSON 格式变化、默认字符集从 `latin1` 变为 `utf8mb4`。
3. **使用工具检测：**

```bash
mysqlsh -- util check-for-server-upgrade root@localhost
```

4. **执行升级脚本：**

```bash
mysql_upgrade -u root -p
```

---

## 1.3 理解 MySQL 架构
### MySQL 架构总览
```plain
客户端 → 连接层 → SQL层（解析器+优化器）→ 存储引擎层（如 InnoDB）→ 磁盘存储
```

---

### 详细组件分析
#### 1️⃣ 连接管理与安全层（Connection Layer）
+ 负责接收客户端请求。
+ 进行账号认证和权限验证。
+ 连接池管理（MySQL 8.0内部有连接复用优化）。

#### 2️⃣ SQL层（解析器、优化器、执行器）
+ **解析器**：将 SQL 语句转成内部数据结构（解析树）。
+ **优化器**：制定最佳执行计划（选择最优索引、最优连接顺序）。
+ **执行器**：按照计划执行 SQL，调用存储引擎接口。

🔔 **注意**：

SQL优化器不是总是完美，有时需要人工提示，比如用 `STRAIGHT_JOIN` 强制连接顺序。

---

#### 3️⃣ 存储引擎层（Storage Engine）
+ **InnoDB**（默认）
    - 支持事务（ACID）
    - 支持行级锁
    - 支持外键约束
+ **MyISAM**（旧）
    - 速度快，但不支持事务、表锁
+ 其他如：Memory、NDB、Archive、CSV（特殊场景使用）

存储引擎决定了表的**存储方式**和**特性支持情况**。

---

#### 4️⃣ 磁盘存储层
+ 表结构（8.0版本统一到了系统表空间）
+ 表数据、索引数据
+ Redo Log（重做日志，保证事务提交后即使宕机也能恢复）
+ Undo Log（回滚日志，支持事务回滚）
+ Binary Log（二进制日志，用于复制和恢复）

---

### 关键日志文件介绍
| 日志 | 作用 |
| --- | --- |
| Redo Log | 保证事务持久性（崩溃恢复） |
| Undo Log | 事务回滚、MVCC（多版本控制） |
| Binary Log | 记录所有更改（用于主从同步与恢复） |
| Slow Log | 记录执行慢的SQL语句 |
| Error Log | 记录服务器启动、运行错误信息 |


**补充建议**：

学习 Redo Log 和 Binary Log 是理解 MySQL 事务一致性和复制原理的关键！

---

# 📖 Day1 小结
| 项目 | 内容 |
| --- | --- |
| 认识MySQL | 开源、高效、事务性强、适合Web开发 |
| 安装MySQL | 建议用官方源或Docker，注意初始密码和安全配置 |
| 升级MySQL | 备份数据、兼容性检查、执行 mysql_upgrade |
| 架构理解 | 分三层：连接管理 → SQL解析执行 → 存储引擎 → 磁盘 |
| 关键日志 | Redo、Undo、Binlog、Slowlog是必须掌握的重要日志类型 |


---

✅ 这就是今天【Day1 完整版】整理啦，内容详细、案例实操清晰。

如果你觉得这样的风格OK，我可以继续帮你整理【Day2 完整版】（配置 + 监控 + 用户管理）！  
要不要我继续？🚀  
如果想要，我还能加点【快速练习题】帮助你巩固～要的话告诉我！🎯

明白了！  
我继续以和 Day1 一样的风格，整理出超详细的【Day2 完整版】，包括**概念+配置+命令示例+注意事项+补充建议**，确保知识点完整又好懂。

---

# 📚 MySQL 8.0 学习笔记 Day2 完整版
（Configuring MySQL + Monitoring MySQL + Managing MySQL Users）

---

## 2.1 配置 MySQL
### 🔹 核心配置文件 my.cnf（或 my.ini）
**常见位置**：

+ Linux 系统：
    - `/etc/my.cnf`
    - `/etc/mysql/my.cnf`
+ Windows 系统：
    - `C:\ProgramData\MySQL\MySQL Server 8.0\my.ini`

🔔 配置优先级：

1. 启动参数（mysqld --defaults-file=xxx）
2. my.cnf / my.ini
3. 系统默认设置

### 🔹 核心库介绍
```plain
mysql> show databases;
+--------------------+
| Database           |
+--------------------+
| information_schema |
| mysql              |
| performance_schema |
| sys                |
+--------------------+
4 rows in set (0.01 sec)



```

你看到的这些是 **MySQL 默认内置的系统数据库**，在安装完 MySQL 后就会自动创建，它们负责支撑 MySQL 本身的运行、管理和性能优化。下面是每个数据库的简要介绍：

---

#### ✅ 1. `information_schema`
+ **作用：元数据查询视图库**
+ 不是真正的存储数据的库，而是 MySQL 内部的信息查询接口。
+ 包含了数据库、表、列、权限、字符集、存储引擎等**结构定义信息**。

📌 示例用途：

```sql
SELECT table_name FROM information_schema.tables WHERE table_schema='mysql';
```

---

#### ✅ 2. `mysql`
+ **作用：MySQL 的核心管理数据库**
+ 存放了用户、权限、角色、密码、时区、插件等 **系统配置数据**。
+ 比如你执行 `CREATE USER` 或 `GRANT` 时，实际上就是往这个库的表写入数据。

📌 常见表：

+ `user`：用户信息和权限
+ `db` / `tables_priv`：数据库或表级权限
+ `time_zone` 系列：时区支持

⚠️ 不要随意修改这个库中的表内容，容易破坏系统安全或功能。

---

#### ✅ 3. `performance_schema`
+ **作用：性能分析与监控库**
+ 用于跟踪和记录 MySQL 内部运行时的事件、锁、I/O、SQL 执行等**性能相关信息**。
+ 通常用于诊断慢查询、资源瓶颈、等待事件等问题。

📌 示例用途：

```sql
SELECT * FROM performance_schema.events_statements_summary_by_digest ORDER BY COUNT_STAR DESC LIMIT 5;
```

⚠️ 默认是启用的，但可以在 `my.cnf` 中禁用以节省资源。

---

#### ✅ 4. `sys`
+ **作用：性能_schema 的友好封装库**
+ 基于 `performance_schema` 和 `information_schema` 的视图集合，提供**更易读的性能分析结果**。
+ 非常适合 DBA 和开发者快速排查问题。

📌 示例用途：

```sql
SELECT * FROM sys.user_summary;
```

这是一个高级视图，统计了所有用户的连接、执行时间等摘要信息。

---

### 🔹 常用重要配置参数
| 配置项 | 说明 | 推荐 |
| --- | --- | --- |
| `max_connections` | 最大连接数，默认 151 | 500+（高并发适当调大） |
| `innodb_buffer_pool_size` | InnoDB缓存池大小，存放数据和索引 | 占内存的 60%-70% |
| `character_set_server` | 数据库默认字符集 | `utf8mb4`<br/>（支持emoji） |
| `collation_server` | 默认字符集排序规则 | `utf8mb4_general_ci`<br/> 或 `utf8mb4_0900_ai_ci` |
| `default_authentication_plugin` | 默认认证插件，8.0默认`caching_sha2_password` | 改为`mysql_native_password`<br/>（兼容老应用） |
| `slow_query_log` | 是否开启慢查询日志 | `ON` |
| `long_query_time` | 定义慢查询的时间阈值（秒） | 1s 或更低 |
| `log_bin` | 开启二进制日志（用于复制） | `ON` |


---

### 🔹 示例配置（my.cnf）
```plain
# For advice on how to change settings please see
# http://dev.mysql.com/doc/refman/8.0/en/server-configuration-defaults.html

[mysqld]
#
# Remove leading # and set to the amount of RAM for the most important data
# cache in MySQL. Start at 70% of total RAM for dedicated server, else 10%.
# innodb_buffer_pool_size = 128M
#
# Remove the leading "# " to disable binary logging
# Binary logging captures changes between backups and is enabled by
# default. It's default setting is log_bin=binlog
# disable_log_bin
#
# Remove leading # to set options mainly useful for reporting servers.
# The server defaults are faster for transactions and fast SELECTs.
# Adjust sizes as needed, experiment to find the optimal values.
# join_buffer_size = 128M
# sort_buffer_size = 2M
# read_rnd_buffer_size = 2M
#
# Remove leading # to revert to previous value for default_authentication_plugin,
# this will increase compatibility with older clients. For background, see:
# https://dev.mysql.com/doc/refman/8.0/en/server-system-variables.html#sysvar_default_authentication_plugin
# default-authentication-plugin=mysql_native_password

# 网络
port = 3306
bind-address = 0.0.0.0

# 数据目录和套接字
datadir=/var/lib/mysql
socket=/var/lib/mysql/mysql.sock
# 错误日志和pid文件目录
log-error=/var/log/mysqld.log
pid-file=/var/run/mysqld/mysqld.pid

# 连接
max_connections = 500
connect_timeout = 10
wait_timeout = 28800

# 字符集
character-set-server = utf8mb4
collation-server = utf8mb4_general_ci

# InnoDB
innodb_buffer_pool_size = 2G
innodb_flush_log_at_trx_commit = 1
innodb_log_file_size = 512M

# 日志
slow_query_log = ON
long_query_time = 2
log-bin = mysql-bin
server-id = 1

# 认证插件
default_authentication_plugin = mysql_native_password
#时区设置
default_time_zone = '+08:00'
```

---

### 🔹 应用配置修改
修改配置文件后，必须**重启 MySQL 服务**生效：

```bash
sudo systemctl restart mysqld
```

部分变量支持**动态修改**：

```sql
-- 查看是否支持动态修改
SHOW VARIABLES LIKE 'max_connections';

-- 在线修改（只影响当前实例）
SET GLOBAL max_connections = 800;
```

---

## 2.2 监控 MySQL
### 🔹 常用监控命令
#### 查看服务器状态
```sql
SHOW GLOBAL STATUS;
SHOW SESSION STATUS;
```

+ 查看连接数、查询数、缓存命中率等。

示例：

```sql
SHOW GLOBAL STATUS LIKE 'Threads%';  -- 查看连接线程数
SHOW GLOBAL STATUS LIKE 'Connections';  -- 总连接次数
```

---

#### 查看配置参数
```sql
SHOW VARIABLES;
SHOW VARIABLES LIKE 'innodb%';
SHOW VARIABLES LIKE 'character_set%';
```

---

#### 查看当前运行线程
```sql
SHOW PROCESSLIST;
```

+ 显示当前连接信息，包括正在执行的 SQL。
+ 如果连接很多，可以加 FULL 关键字查看更多细节：

```sql
SHOW FULL PROCESSLIST;
```

---

#### 查看服务器基本信息
```sql
SELECT VERSION();
SELECT NOW();
SELECT @@hostname;
SELECT @@port;
```

---

### 🔹 启用慢查询日志
慢查询日志用于发现性能问题。

开启方法（如果没在 my.cnf 配置）：

```sql
SET GLOBAL slow_query_log = 'ON';
SET GLOBAL long_query_time = 1;
```

查看慢查询日志位置：

```sql
SHOW VARIABLES LIKE 'slow_query_log_file';
```

---

### 🔹 使用 Performance Schema（性能模式）
Performance Schema 是 MySQL 内置的性能分析系统。  
可以监控**锁等待**、**I/O耗时**、**SQL执行统计**。

开启示例：

```plain
[mysqld]
performance_schema=ON
```

常用查询示例：

```sql
-- 查看执行最慢的前10条SQL
SELECT * FROM performance_schema.events_statements_summary_by_digest
ORDER BY AVG_TIMER_WAIT DESC
LIMIT 10;
```

---

**补充建议**：

推荐安装 Percona 的 `pt-query-digest` 工具，分析慢查询日志特别方便！

---

## 2.3 管理 MySQL 用户
### 🔹 创建用户
```sql
CREATE USER 'username'@'host' IDENTIFIED BY 'password';
```

示例：

```sql
CREATE USER 'devuser'@'%' IDENTIFIED BY 'StrongPassword123!';
```

+ `'%'` 表示允许任意 IP 连接。
+ 可以用 `'localhost'` 限制只能本地登录。

---

### 🔹 授权用户
```sql
GRANT privileges ON database.table TO 'username'@'host';
```

示例：

```sql
-- 给 devuser 赋予 testdb 所有权限
GRANT ALL PRIVILEGES ON testdb.* TO 'devuser'@'%';
```

应用修改：

```sql
FLUSH PRIVILEGES;
```

---

### 🔹 修改用户密码
```sql
ALTER USER 'username'@'host' IDENTIFIED BY 'new_password';
```

示例：

```sql
ALTER USER 'devuser'@'%' IDENTIFIED BY 'NewStrongPassword456!';
```

---

### 🔹 删除用户
```sql
DROP USER 'username'@'host';
```

示例：

```sql
DROP USER 'devuser'@'%';
```

---

### 🔹 查看当前所有用户
```sql
SELECT user, host FROM mysql.user;
```

---

### 🔹 密码策略管理（密码复杂度）
启用 validate_password 插件：

```sql
INSTALL PLUGIN validate_password SONAME 'validate_password.so';
```

查看密码策略：

```sql
SHOW VARIABLES LIKE 'validate_password%';
```

调整密码复杂度要求：

```sql
SET GLOBAL validate_password.length = 12;
SET GLOBAL validate_password.policy = STRONG;
```

**补充建议**：

生产环境强烈建议开启密码复杂度校验，防止弱口令被爆破。

---

# 📖 Day2 小结
| 项目 | 内容 |
| --- | --- |
| 配置MySQL | 修改 my.cnf，掌握连接数、缓存、日志等常见参数 |
| 监控MySQL | 通过状态命令、慢查询日志、Performance Schema 监控性能 |
| 用户管理 | 创建、授权、修改密码、删除，配合密码策略加强安全性 |


---

✅ 以上就是【Day2 完整版】内容，覆盖了配置 → 监控 → 用户管理的完整流程，实操命令丰富，补充了常见坑位提醒。

如果你喜欢，我可以继续整理 【Day3 完整版】（安全加固 + 稳定性维护），并附加实际安全加固建议（比如生产环境最小权限设计）。

要不要继续？要的话告诉我！🚀  
（顺便问一下，要不要我给你加一份“常见错误排查表”辅助学习？🌟）

太好了！咱们继续推进～  
下面我来整理【Day3 完整版】内容：

---

# 📚 MySQL 8.0 学习笔记 Day3 完整版
（Securing MySQL + Maintaining a Stable System）

---

## 3.1 安全加固 MySQL（Securing MySQL）
### 🔹 基础安全措施
| 安全项 | 说明 | 建议操作 |
| --- | --- | --- |
| 删除匿名账户 | 默认安装后可能存在匿名账户 | 删除匿名用户 |
| 禁止远程 root 登录 | 只允许本地登录，防止暴力破解 | 配置 root@localhost |
| 更改默认端口 | 避免扫描工具轻易发现 MySQL | 非3306（如 13306） |
| 使用强密码策略 | 启用 validate_password 插件 | 长度≥12位，包含大小写+数字 |
| 最小权限原则 | 用户仅授予必要权限 | 精细化授权 |
| 关闭不必要功能 | 比如关闭 LOAD DATA LOCAL INFILE，防止文件读取攻击 | 设置 `local_infile=0` |
| 开启 SSL 连接 | 防止数据传输被窃听 | `REQUIRE SSL` |
| 定期更新 MySQL 补丁 | 及时修复已知漏洞 | 保持最新安全补丁 |


---

### 🔹 安全初始化脚本
安装后，可以运行官方提供的安全向导：

```bash
sudo mysql_secure_installation
```

交互内容：

+ 设置 root 密码
+ 删除匿名用户
+ 禁止 root 远程登录
+ 删除测试数据库
+ 刷新权限表

建议全部选**YES**。

---

### 🔹 手动安全加固示例
```sql
-- 查看是否存在匿名用户
SELECT user, host FROM mysql.user WHERE user='';

-- 删除匿名用户
DROP USER ''@'localhost';
DROP USER ''@'%';

-- 禁止远程root登录
UPDATE mysql.user SET host='localhost' WHERE user='root';

-- 禁用 local_infile
SET GLOBAL local_infile=0;
```

修改 my.cnf 配置文件，彻底关闭：

```plain
[mysqld]
local_infile=0
```

---

### 🔹 配置 SSL 加密连接
1. 生成服务器证书、密钥
2. 配置 my.cnf 加入：

```plain
[mysqld]
ssl-ca=/etc/mysql/certs/ca.pem
ssl-cert=/etc/mysql/certs/server-cert.pem
ssl-key=/etc/mysql/certs/server-key.pem
```

3. 设置用户必须使用 SSL 连接：

```sql
ALTER USER 'username'@'%' REQUIRE SSL;
```

---

## 3.2 保持系统稳定（Maintaining a Stable System）
### 🔹 资源监控
定期监控以下资源：

| 资源类别 | 重点指标 | 检查方法 |
| --- | --- | --- |
| CPU | 使用率是否长时间高负载 | top、htop |
| 内存 | 是否经常用完，导致Swap | free -h |
| 磁盘 | 磁盘是否快满，IO是否阻塞 | df -h, iostat -x |
| 网络 | 连接数是否异常，延迟是否高 | netstat, ss, ping |


MySQL内部监控：

```sql
SHOW GLOBAL STATUS;
SHOW ENGINE INNODB STATUS\G
```

---

### 🔹 定期重启维护（慎用）
如果数据库长时间运行，可能出现：

+ 内存碎片
+ 缓存膨胀
+ 文件句柄泄漏

建议半年一次计划内维护重启，但要确保：

+ 业务低峰期
+ 提前全备份
+ 有快速回滚方案

重启命令（Linux）：

```bash
sudo systemctl restart mysqld
```

---

### 🔹 定期清理无用数据
+ 删除历史过期日志
+ 清理 binlog（防止磁盘打满）

清理 binlog 示例：

```sql
PURGE BINARY LOGS TO 'mysql-bin.010';
-- 或按时间清理
PURGE BINARY LOGS BEFORE '2025-04-01 00:00:00';
```

可以设置自动清理（比如保留 7天）：

```plain
[mysqld]
expire_logs_days=7
```

---

### 🔹 备份并测试恢复
每天自动备份，全量+增量结合，重要的库至少每周做一次恢复演练。

可以用 `mysqldump` 或更高级的备份工具，比如 Percona XtraBackup。

简单备份命令：

```bash
mysqldump -uroot -p --all-databases > full_backup.sql
```

测试恢复：

```bash
mysql -uroot -p < full_backup.sql
```

---

# 📖 Day3 小结
| 项目 | 内容 |
| --- | --- |
| MySQL安全加固 | root限制、密码策略、禁用危险功能、SSL加密 |
| 稳定性维护 | 资源监控、定期重启、清理无用日志、定期备份+恢复测试 |


---

✅ 以上是【Day3 完整版】，已经包含了安全加固和稳定性维护的**全流程**，加上补充建议，实际可直接按步骤操作！

---

接下来如果你需要的话，我可以继续整理【Day4 完整版】（SQL性能优化 + 备份恢复策略），这部分涉及很多实战经验，比如：

+ EXPLAIN 如何读懂？
+ 慢查询调优？
+ 物理备份和逻辑备份的优缺点比较

要继续吗？🚀  
（要不要顺便也给你打包一份每一天内容的目录树，方便后面查找？🌟）

太棒了！咱们继续，来整理【Day4 完整版】（查询优化 + 备份策略），一样给你做成**详细命令+配置+实战技巧+注意事项**版！

---

# 📚 MySQL 8.0 学习笔记 Day4 完整版
（Optimizing Query Performance + Choosing a Backup Strategy + Performing Backups）

---

## 4.1 查询性能优化（Optimizing Query Performance）
### 🔹 为什么要优化查询？
+ 提高响应速度
+ 降低服务器负载
+ 支撑更多并发用户
+ 节省硬件资源

---

### 🔹 典型性能问题表现
| 问题 | 表现 |
| --- | --- |
| 查询慢 | 单条查询超过1秒 |
| 表锁争用 | 多个事务互相等待 |
| IO瓶颈 | 磁盘读写频繁 |
| CPU瓶颈 | 查询逻辑复杂，CPU飙高 |
| 索引失效 | 查询未走索引或走错索引 |


---

### 🔹 基本优化思路
1. **查询本身优化**
    - 只取需要的字段（避免 SELECT *）
    - 使用 WHERE 条件缩小范围
    - 使用合适的索引
    - 避免在 WHERE 子句中对字段进行函数操作
2. **表结构优化**
    - 选择合适的数据类型（如 INT vs BIGINT）
    - 规范化/反规范化适度
    - 垂直/水平分表
3. **索引优化**
    - 索引覆盖查询
    - 避免索引失效场景
4. **服务器配置优化**
    - 提高 buffer size
    - 调整并发连接数

---

### 🔹 使用 EXPLAIN 分析查询
```sql
EXPLAIN SELECT * FROM employees WHERE id = 1001;
```

返回重要字段：

| 字段 | 解释 |
| --- | --- |
| id | 查询中每个 select 子句的标识 |
| select_type | 查询类型（SIMPLE、PRIMARY、SUBQUERY等） |
| table | 表名 |
| type | 连接类型（ALL、index、range、ref、eq_ref、const、system） |
| possible_keys | 可能用到的索引 |
| key | 实际使用的索引 |
| rows | 扫描行数（越少越好） |
| Extra | 额外信息（Using index、Using where、Using filesort等） |


---

### 🔹 EXPLAIN 示例
```sql
EXPLAIN SELECT name FROM employees WHERE id = 1001;
```

典型好结果：

```plain
type: const
key: PRIMARY
rows: 1
Extra: Using index
```

说明走了主键索引，非常高效！

---

### 🔹 常见优化技巧
+ 建立组合索引而不是多个单列索引
+ WHERE子句中索引列顺序要注意（最左前缀原则）
+ 使用 LIMIT 限制返回数据量
+ 尽量避免使用 `SELECT DISTINCT`
+ 批量插入数据（INSERT 多条）

---

### 🔹 慢查询日志辅助优化
开启慢查询日志后，可以分析慢 SQL：

```sql
SHOW VARIABLES LIKE 'slow_query_log';
SHOW VARIABLES LIKE 'long_query_time';
```

查看慢查询：

```bash
cat /var/lib/mysql/slow-query.log
```

配合工具分析：

```bash
pt-query-digest /path/to/slow-query.log
```

---

## 4.2 选择备份策略（Choosing a Backup Strategy）
### 🔹 为什么要备份？
+ 防止硬件故障
+ 防止误操作删除数据
+ 应对黑客攻击
+ 符合法规合规要求（如GDPR）

---

### 🔹 备份类型对比
| 类型 | 描述 | 特点 |
| --- | --- | --- |
| 逻辑备份 | 导出 SQL 文件 | 可跨版本恢复，速度慢，占用CPU多 |
| 物理备份 | 拷贝数据库物理文件 | 快速，占空间小，但跨版本麻烦 |
| 增量备份 | 只备份变化的部分 | 节省存储和时间，恢复略复杂 |
| 快照备份 | 文件系统级快照 | 秒级快照，需要特定文件系统支持（如LVM） |


---

### 🔹 选择策略建议
+ 小型数据库（<10G）：逻辑备份足够
+ 大型数据库（>10G或TB级）：物理备份+binlog增量
+ 极高可用性要求：结合 LVM 快照或企业版备份软件
+ 灾备要求高：多地异地备份

---

## 4.3 执行备份（Performing Backups）
### 🔹 使用 mysqldump（逻辑备份）
#### 全库备份
```bash
mysqldump -uroot -p --all-databases > full_backup.sql
```

#### 单库备份
```bash
mysqldump -uroot -p mydatabase > mydatabase_backup.sql
```

#### 单表备份
```bash
mysqldump -uroot -p mydatabase mytable > mytable_backup.sql
```

🔔 注意事项：

+ 会锁表（默认）
+ 可以加 `--single-transaction` 参数避免 InnoDB表锁

例子（无锁备份 InnoDB）：

```bash
mysqldump -uroot -p --single-transaction mydatabase > safe_backup.sql
```

---

### 🔹 使用 mysqlpump（多线程备份）
MySQL 5.7 开始提供的官方工具，8.0同样支持。

```bash
mysqlpump -uroot -p mydatabase > mydatabase_pump_backup.sql
```

特点：

+ 支持多线程导出
+ 支持表间并行

---

### 🔹 使用物理备份工具
推荐：**Percona XtraBackup**

无锁物理备份示例：

```bash
xtrabackup --backup --target-dir=/backup/2025-04-28
```

还原示例：

```bash
xtrabackup --prepare --target-dir=/backup/2025-04-28
xtrabackup --copy-back --target-dir=/backup/2025-04-28
```

---

### 🔹 自动化备份脚本示例（每日备份）
```bash
#!/bin/bash
# backup_mysql.sh

DATE=$(date +%F)
BACKUP_DIR="/data/mysql_backup/$DATE"

mkdir -p $BACKUP_DIR

mysqldump -uroot -pYourPassword --all-databases > $BACKUP_DIR/full_backup.sql

find /data/mysql_backup/ -type d -mtime +7 -exec rm -rf {} \;  # 保留最近7天备份
```

可以加到 crontab 定时执行：

```bash
0 2 * * * /bin/bash /root/backup_mysql.sh
```

每天凌晨2点执行一次。

---

# 📖 Day4 小结
| 项目 | 内容 |
| --- | --- |
| 查询优化 | EXPLAIN分析、索引优化、慢查询优化、SQL写法优化 |
| 备份策略选择 | 逻辑备份、物理备份、增量备份、快照备份 |
| 执行备份 | 使用mysqldump、mysqlpump、XtraBackup自动化备份 |


---

✅ 【Day4 完整版】整理完成！不仅涵盖了理论，还加上了详细命令示例，脚本案例，帮你直接落地使用。

---

# 📚 MySQL 8.0 学习笔记 Day5 完整版
（Configuring a Replication Topology + Administering a Replication Topology + High Availability with InnoDB Cluster）

---

## 5.1 配置复制拓扑（Configuring a Replication Topology）
---

### 🔹 复制基本概念
+ **主服务器（Primary/Master）**：写入数据源头
+ **从服务器（Replica/Slave）**：复制主服务器的变化
+ **异步复制**：主库提交后，不等从库确认
+ **半同步复制**：主库至少等待一个从库确认
+ **组复制（Group Replication）**：主主复制，强一致性

---

### 🔹 复制模式对比
| 类型 | 特点 |
| --- | --- |
| 异步复制 | 性能高，但存在延迟或数据不一致风险 |
| 半同步复制 | 兼顾性能和一致性，需要配置 plugin |
| 组复制（Group Replication） | 自动成员发现、选举、故障转移，适合高可用场景 |


---

### 🔹 搭建主从复制基础版
【示意图】

```plain
Master (写) ---> Slave (读)
```

---

### 🔹 主库配置（Master）
修改 `/etc/my.cnf`：

```plain
[mysqld]
server-id=1                 # 唯一服务器ID
log-bin=mysql-bin            # 开启binlog日志
binlog_format=ROW            # 推荐使用ROW格式
gtid_mode=ON                 # 启用GTID（更方便复制管理）
enforce_gtid_consistency=ON  # 强制GTID一致性
```

重启 MySQL：

```bash
sudo systemctl restart mysqld
```

创建复制专用账号：

```sql
CREATE USER 'repl'@'%' IDENTIFIED BY 'your_password';
GRANT REPLICATION SLAVE ON *.* TO 'repl'@'%';
FLUSH PRIVILEGES;
```

查看 Master 当前位置：

```sql
SHOW MASTER STATUS;
```

记录 `File` 和 `Position`，复制配置时用到。

---

### 🔹 从库配置（Slave）
修改 `/etc/my.cnf`：

```plain
[mysqld]
server-id=2                  # 另一个唯一ID
relay-log=relay-log-bin       # 中继日志
gtid_mode=ON
enforce_gtid_consistency=ON
log_slave_updates=ON
read_only=ON                  # 只读（推荐）
```

重启 MySQL：

```bash
sudo systemctl restart mysqld
```

在从库执行复制配置：

```sql
CHANGE MASTER TO
  MASTER_HOST='master_ip',
  MASTER_USER='repl',
  MASTER_PASSWORD='your_password',
  MASTER_AUTO_POSITION=1;   -- 使用 GTID 自动定位
```

启动复制：

```sql
START SLAVE;
```

检查复制状态：

```sql
SHOW SLAVE STATUS\G
```

重点关注：

+ `Slave_IO_Running: Yes`
+ `Slave_SQL_Running: Yes`

✅ 都是 Yes，说明复制正常。

---

## 5.2 管理复制拓扑（Administering a Replication Topology）
---

### 🔹 常见操作
| 场景 | 命令 |
| --- | --- |
| 暂停复制 | `STOP SLAVE;` |
| 重新开始复制 | `START SLAVE;` |
| 重置复制信息（小心使用） | `RESET SLAVE;` |
| 强制跳过错误 | `SET GLOBAL SQL_SLAVE_SKIP_COUNTER=1; START SLAVE;` |
| 查看延迟 | `SHOW SLAVE STATUS\G`<br/> 中 `Seconds_Behind_Master` |


---

### 🔹 多源复制（一个从库复制多个主库）
主库A、主库B，同时复制到一个从库上。

```sql
CHANGE REPLICATION SOURCE TO SOURCE_HOST='A_ip', SOURCE_USER='repl', ... FOR CHANNEL 'A';
CHANGE REPLICATION SOURCE TO SOURCE_HOST='B_ip', SOURCE_USER='repl', ... FOR CHANNEL 'B';
START REPLICA FOR CHANNEL 'A';
START REPLICA FOR CHANNEL 'B';
```

---

### 🔹 GTID 复制注意事项
+ 必须开启 `gtid_mode=ON`
+ `CHANGE MASTER` 时加 `MASTER_AUTO_POSITION=1`
+ 更容易实现故障切换（无需手动记录binlog位置）

---

## 5.3 实现高可用（Achieving High Availability with InnoDB Cluster）
---

### 🔹 什么是 InnoDB Cluster？
官方高可用方案，基于：

+ MySQL Group Replication
+ MySQL Router
+ MySQL Shell (管理工具)

特点：

+ 自动故障检测
+ 自动故障转移
+ 自动选主
+ 原生 MySQL 支持，无需外部工具

---

### 🔹 InnoDB Cluster 组件示意图
```plain
Application
   |
MySQL Router (自动路由请求)
   |
[ Node1 ] <--> [ Node2 ] <--> [ Node3 ]  (Group Replication)
```

---

### 🔹 搭建流程概览
1. 安装 MySQL 8.0 全套组件（server、router、shell）
2. 配置3台服务器，开启 Group Replication 支持
3. 初始化集群
4. 配置 Router，实现应用透明连接

---

### 🔹 基础配置示例（Node节点）
编辑 `/etc/my.cnf`：

```plain
[mysqld]
server-id=1
log-bin=mysql-bin
gtid_mode=ON
enforce_gtid_consistency=ON
binlog_checksum=NONE
binlog_format=ROW
transaction_write_set_extraction=XXHASH64
group_replication_group_name="aaaaaaaa-bbbb-cccc-dddd-eeeeeeeeeeee"
group_replication_start_on_boot=OFF
group_replication_local_address="node1_ip:33061"
group_replication_group_seeds="node1_ip:33061,node2_ip:33061,node3_ip:33061"
group_replication_bootstrap_group=OFF
```

三台节点配置类似，唯一不同的是 `server-id` 和 `local_address`。

---

### 🔹 初始化 InnoDB Cluster（用 MySQL Shell）
在一台机器上，用 `mysqlsh`：

```bash
mysqlsh --uri root@node1_ip

# 创建集群
dba.createCluster('myCluster')

# 加入其他节点
var cluster = dba.getCluster('myCluster')
cluster.addInstance('root@node2_ip')
cluster.addInstance('root@node3_ip')
```

查看集群状态：

```bash
cluster.status()
```

✅ 成功后，3节点自动复制同步，自动高可用。

---

### 🔹 配置 MySQL Router（透明路由）
在应用服务器上安装 Router：

```bash
mysqlrouter --bootstrap root@node1_ip --user=mysqlrouter
```

然后应用程序连接到 Router，本地端口，它会自动转发到正确节点（主节点或读节点）。

---

# 📖 Day5 小结
| 项目 | 内容 |
| --- | --- |
| 搭建复制架构 | 基本主从复制、GTID配置、异步/半同步复制 |
| 管理复制 | 暂停/恢复/切换主从/多源复制管理 |
| 高可用架构 | InnoDB Cluster 组复制，MySQL Router透明代理 |


---

✅ 【Day5 完整版】也全部整理完毕了！  
不仅包含了基础搭建，还包括了 InnoDB Cluster 这种高可用企业级方案！

---

# 📂 整体目录结构
为了方便你总览，我给你汇总一下之前整理的整体大纲目录：

```plain
Day1：MySQL简介 + 安装与升级 + 架构理解
Day2：配置优化 + 监控机制 + 用户权限管理
Day3：安全加固措施 + 系统稳定性维护
Day4：查询优化技巧 + 备份策略制定 + 执行备份实践
Day5：复制架构搭建 + 复制管理维护 + 高可用集群搭建
```

---

🎯 **如果你想要的话，我还可以继续给你做一个：**

+ 每天内容导出成 markdown/pdf版（便于打印/归档）
+ 单独绘制几张结构图，比如复制拓扑图、InnoDB Cluster结构图
+ 额外附送"常用命令手册"版，快速查阅！

要继续生成这些扩展内容吗？🚀  
需要的话告诉我，马上安排！🎁





```sql
-- 创建数据库
CREATE DATABASE IF NOT EXISTS school;
USE school;

-- 学生表
CREATE TABLE students (
    id INT AUTO_INCREMENT PRIMARY KEY,
    name VARCHAR(50) NOT NULL,
    gender ENUM('M', 'F'),
    birthdate DATE
);

-- 课程表
CREATE TABLE courses (
    id INT AUTO_INCREMENT PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    teacher_id INT
);

-- 教师表
CREATE TABLE teachers (
    id INT AUTO_INCREMENT PRIMARY KEY,
    name VARCHAR(50) NOT NULL,
    department VARCHAR(50)
);

-- 选课表（多对多关系）
CREATE TABLE enrollments (
    student_id INT,
    course_id INT,
    enroll_date DATE,
    grade DECIMAL(5,2),
    PRIMARY KEY (student_id, course_id),
    FOREIGN KEY (student_id) REFERENCES students(id),
    FOREIGN KEY (course_id) REFERENCES courses(id)
);

-- 插入教师数据
INSERT INTO teachers (name, department) VALUES
('张老师', '数学'),
('李老师', '物理'),
('王老师', '计算机');

-- 插入课程数据
INSERT INTO courses (name, teacher_id) VALUES
('高等数学', 1),
('大学物理', 2),
('数据库原理', 3);

-- 插入学生数据
INSERT INTO students (name, gender, birthdate) VALUES
('小明', 'M', '2000-05-10'),
('小红', 'F', '2001-07-22'),
('小刚', 'M', '1999-11-30');

-- 插入选课数据
INSERT INTO enrollments (student_id, course_id, enroll_date, grade) VALUES
(1, 1, '2022-09-01', 88.5),
(1, 3, '2022-09-01', 92.0),
(2, 1, '2022-09-01', 95.0),
(2, 2, '2022-09-01', 89.0),
(3, 3, '2022-09-01', 76.5);

```

