## 概览
关于vsphere虚拟化的cpu有多种情况分配，超分配是一个很正常的现象。超分配多了，会发生cpu争用，导致虚拟机性能变差。但是查阅了很多资料，好像没有什么分配的规范，都是根据虚拟机上的资源负载情况来分配。

## 虚拟机类型
首先关于虚拟机类型，看了很多帖子，和自己工作来看，可以把虚拟机分为

+ 计算密集型
+ 内存密集型  
+  I/O密集型  
+  混合型  

分别介绍这四种类型

### 1. **计算密集型虚拟机**
+ **特点**：
    - 主要依赖CPU进行大量的计算操作，如数据分析、模拟计算、科学计算等。
    - 通常需要较高的CPU频率和多个核心，以处理大量的计算任务。
+ **资源分配**：
    - 分配较高的CPU核心数和较高的CPU频率。
    - 优先确保虚拟机获得充足的CPU资源，避免因CPU资源不足导致性能瓶颈。

### 2. **内存密集型虚拟机**
+ **特点**：
    - 主要依赖大量内存进行数据处理和缓存操作，如大数据处理、数据库应用等。
    - 虽然CPU也是重要的资源，但内存使用量是关键。
+ **资源分配**：
    - 分配较大的内存资源，但对CPU核心数的需求可能相对较低。
    - 在CPU资源分配上，可以适度配置，确保CPU不会成为性能瓶颈。

### 3. **I/O密集型虚拟机**
+ **特点**：
    - 主要依赖磁盘和网络I/O操作，如文件服务器、网络服务、数据传输等。
    - 虽然CPU和内存都重要，但I/O性能（磁盘和网络带宽）是关键。
+ **资源分配**：
    - 优化磁盘I/O性能和网络带宽分配，确保I/O操作的高效执行。
    - CPU和内存的分配根据I/O操作的复杂程度进行适当调整。

### 4. **混合型虚拟机**
+ **特点**：
    - 同时具有计算、内存和I/O的负载需求，没有特别的偏向。
    - 常见于一些通用的应用服务器或开发环境。
+ **资源分配**：
    - 根据应用的实际需求进行平衡分配。
    - 在设计资源分配策略时，需要综合考虑计算、内存和I/O的需求，进行合理的配置。

## 如何识别和配置
1. **分析工作负载**：
    - 监控虚拟机的资源使用情况，如CPU、内存、磁盘I/O和网络流量，了解其主要的资源需求。
    - 根据工作负载的特点，选择合适的虚拟机类型和资源配置。
2. **调整资源分配**：
    - 对于计算密集型虚拟机，分配更多的CPU核心和更高的频率。
    - 对于内存密集型虚拟机，优先配置更大的内存。
    - 对于I/O密集型虚拟机，优化磁盘和网络I/O性能，确保资源的充足。
3. **优化性能**：
    - 根据监控和分析结果，调整资源配置，确保虚拟机的性能达到最佳状态。
    - 定期评估虚拟机的资源使用情况，进行动态调整。

## 关于工作的一些实践
### vcpu方面
首先因为，顶级的物理CPU非常贵，我们公司采用的CPU并没有到intel高端的CPU，而是中端的CPU系列。目前公司采用的私有桌面云vmware horizon，使用的是

| 型号 |  Intel(R) Xeon(R) Gold 6346 CPU @ 3.10GHz  |
| --- | --- |
| 处理器速度 |  3.09 GHz  |
| 处理器插槽 |  2  |
| 每个插槽的处理器内核数 |  16  |
| 逻辑处理器 |  64  |
| 超线程 |  活动  |


 容量: 98.98 GHz

超线程并不能算入容量。

容量=处理器速度*处理器插槽*每个插槽的处理器内核数=3.09*2*16=98.98GHz

逻辑处理器为64个。

一般来说可以分配64个vcpu。

超分配1.5-2倍可以正常使用，不会造成资源严重浪费，超分配太多多造成CPU争用，导致卡顿

之前就是桌面超分配严重，刚好桌面比较多人使用的时候造成的卡顿，导致被用户投诉。当时每台服务器的vcpu分配了大约200个，比较多人在使用的时候，卡顿很严重。

优化方案从我的角度有两种

1.通过自动化工具vrops监控工具进行优化资源分配。可以自动批量的对资源分配不合理的虚拟机进行调整。

2.通过编写Python代码，批量调整虚拟机分配的vcpu个数。

推荐使用工具调整，工具会监控虚拟机的资源消耗来建议调整，比我们自己规划来的更好点。

如果是就是提供服务的虚拟机。一般主频不会太高，逻辑处理器个数会比较多。比如公司采用的cpu逻辑处理大约80个左右。

按照资源分配比。如果计算密集型虚拟机较多，不要超分配太多，1-2左右最佳即80-160最佳。发生争用的话，会严重影响性能。

# 总结
从虚拟机CPU分配的角度来看，虚拟机可以根据其主要的工作负载特性被分类为计算密集型、内存密集型、I/O密集型或混合型。每种类型的虚拟机在资源分配上有不同的需求和优先级，通过合理的资源配置和优化，可以确保虚拟机的性能和稳定性。

其实虚拟化分配资源可以在初始时判断虚拟机类型，再进行分配。这样可以减少上线后的卡顿现象出现。分配CPU个数时需要注意CPU的逻辑处理器，超分配太多很影响性能。

最后一句，如果公司不舍得花钱，硬是要强制的网上堆虚拟机，且不加资源，这个不跑等什么。等背锅吗？

