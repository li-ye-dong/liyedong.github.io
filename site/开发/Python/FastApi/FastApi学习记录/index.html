
<!doctype html>
<html lang="zh" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="ç¾å°‘ç”·">
      
      
        <meta name="author" content="æçƒ¨æ ‹">
      
      
        <link rel="canonical" href="https://li-ye-dong.github.io/%E5%BC%80%E5%8F%91/Python/FastApi/FastApi%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/">
      
      
        <link rel="prev" href="../FastAPI%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5/">
      
      
        <link rel="next" href="../Fastapi%E6%89%93%E5%8C%85exe%E5%92%8Cvue%E6%89%93%E5%8C%85/">
      
      
      <link rel="icon" href="../../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.7">
    
    
      
        <title>FastApiå­¦ä¹ è®°å½• - æçƒ¨æ ‹çš„åšå®¢</title>
      
    
    
      <link rel="stylesheet" href="../../../../assets/stylesheets/main.8608ea7d.min.css">
      
        
        <link rel="stylesheet" href="../../../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
    
    
      <link rel="stylesheet" href="../../../../static/stylesheets/google_font.css">
    
    <script>__md_scope=new URL("../../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="green" data-md-color-accent="green">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#æ¦‚è¿°" class="md-skip">
          è·³è½¬è‡³
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow md-header--lifted" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="é¡µçœ‰">
    <a href="../../../.." title="æçƒ¨æ ‹çš„åšå®¢" class="md-header__button md-logo" aria-label="æçƒ¨æ ‹çš„åšå®¢" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            æçƒ¨æ ‹çš„åšå®¢
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              FastApiå­¦ä¹ è®°å½•
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="green" data-md-color-accent="green"  aria-label="æ—¥é—´æ¨¡å¼"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="æ—¥é—´æ¨¡å¼" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="blue" data-md-color-accent="blue"  aria-label="å¤œé—´æ¨¡å¼"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="å¤œé—´æ¨¡å¼" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="æœç´¢" placeholder="æœç´¢" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="æŸ¥æ‰¾">
        
          <a href="javascript:void(0)" class="md-search__icon md-icon" title="åˆ†äº«" aria-label="åˆ†äº«" data-clipboard data-clipboard-text="" data-md-component="search-share" tabindex="-1">
            
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91s2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08"/></svg>
          </a>
        
        <button type="reset" class="md-search__icon md-icon" title="æ¸…ç©ºå½“å‰å†…å®¹" aria-label="æ¸…ç©ºå½“å‰å†…å®¹" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            æ­£åœ¨åˆå§‹åŒ–æœç´¢å¼•æ“
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/li-ye-dong/liyedong.github.io.git" title="å‰å¾€ä»“åº“" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    li-ye-dong.github.io
  </div>
</a>
      </div>
    
  </nav>
  
    
      
<nav class="md-tabs" aria-label="æ ‡ç­¾" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../../.." class="md-tabs__link">
        
  
    
  
  çŸ¥è¯†åº“ç´¢å¼•

      </a>
    </li>
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../../k8s%E5%92%8C%E5%AE%B9%E5%99%A8/Helm%20%E6%97%A5%E5%B8%B8%E4%BD%BF%E7%94%A8%E4%B8%8E%E5%B0%81%E8%A3%85%E8%87%AA%E5%AE%9A%E4%B9%89%E5%BA%94%E7%94%A8%E5%8F%91%E5%B8%83%E7%AC%94%E8%AE%B0/" class="md-tabs__link">
          
  
    
  
  K8så’Œå®¹å™¨

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../../%E4%B8%AD%E9%97%B4%E4%BB%B6/ELK/alertmanager/" class="md-tabs__link">
          
  
    
  
  ä¸­é—´ä»¶

        </a>
      </li>
    
  

    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../../%E5%88%86%E4%BA%AB/1.ai%E6%95%B0%E5%AD%97%E4%BA%BA/" class="md-tabs__link">
          
  
    
  
  åˆ†äº«

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../../%E5%AE%89%E5%85%A8/Burp%20Suite%E6%8A%93%E5%8C%85%E5%B7%A5%E5%85%B7/" class="md-tabs__link">
          
  
    
  
  å®‰å…¨

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../../%E5%B7%A5%E5%85%B7%E4%BD%BF%E7%94%A8/2024%E5%B9%B46%E6%9C%88%E6%80%BB%E7%BB%93/" class="md-tabs__link">
          
  
    
  
  å·¥å…·ä½¿ç”¨

        </a>
      </li>
    
  

      
        
  
  
    
  
  
    
    
      
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../../../Django/Aliphe.js%E6%A1%86%E6%9E%B6/" class="md-tabs__link">
          
  
    
  
  å¼€å‘

        </a>
      </li>
    
  

    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../../%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/windows%E6%96%87%E4%BB%B6%E5%A4%8D%E5%88%B6%E5%B8%A6%E6%9D%83%E9%99%90/" class="md-tabs__link">
          
  
    
  
  æ“ä½œç³»ç»Ÿ

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../../%E6%95%B0%E6%8D%AE%E5%BA%93%E7%AC%94%E8%AE%B0/Elasticsearch%20%E6%95%99%E7%A8%8B/" class="md-tabs__link">
          
  
    
  
  æ•°æ®åº“ç¬”è®°

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../../%E6%B5%8F%E8%A7%88%E5%99%A8%E4%B9%A6%E7%AD%BE%E6%94%B6%E8%97%8F/%E5%9C%B0%E5%9D%801/" class="md-tabs__link">
          
  
    
  
  æµè§ˆå™¨ä¹¦ç­¾æ”¶è—

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../../%E7%9B%91%E6%8E%A7/zabbix%E7%9B%91%E6%8E%A74.2/" class="md-tabs__link">
          
  
    
  
  ç›‘æ§

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../../%E8%99%9A%E6%8B%9F%E5%8C%96/%E8%99%9A%E6%8B%9F%E5%8C%96/RVtools%E4%BD%BF%E7%94%A8/" class="md-tabs__link">
          
  
    
  
  è™šæ‹ŸåŒ–

        </a>
      </li>
    
  

    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../../%E8%AE%A4%E8%AF%81%E7%9B%B8%E5%85%B3/credly%E6%9F%A5%E7%9C%8B%E5%8B%8B%E7%AB%A0/" class="md-tabs__link">
          
  
    
  
  è®¤è¯ç›¸å…³

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
    
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


  

<nav class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" aria-label="å¯¼èˆªæ " data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../../.." title="æçƒ¨æ ‹çš„åšå®¢" class="md-nav__button md-logo" aria-label="æçƒ¨æ ‹çš„åšå®¢" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    æçƒ¨æ ‹çš„åšå®¢
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/li-ye-dong/liyedong.github.io.git" title="å‰å¾€ä»“åº“" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    li-ye-dong.github.io
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    çŸ¥è¯†åº“ç´¢å¼•
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
        
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../../../k8s%E5%92%8C%E5%AE%B9%E5%99%A8/Helm%20%E6%97%A5%E5%B8%B8%E4%BD%BF%E7%94%A8%E4%B8%8E%E5%B0%81%E8%A3%85%E8%87%AA%E5%AE%9A%E4%B9%89%E5%BA%94%E7%94%A8%E5%8F%91%E5%B8%83%E7%AC%94%E8%AE%B0/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    K8så’Œå®¹å™¨
    
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
    
    
      
      
        
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    
  
  
    <a href="../../../../%E4%B8%AD%E9%97%B4%E4%BB%B6/ELK/alertmanager/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    ä¸­é—´ä»¶
    
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

  

      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
        
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../../../%E5%88%86%E4%BA%AB/1.ai%E6%95%B0%E5%AD%97%E4%BA%BA/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    åˆ†äº«
    
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
    
    
      
      
        
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../../../%E5%AE%89%E5%85%A8/Burp%20Suite%E6%8A%93%E5%8C%85%E5%B7%A5%E5%85%B7/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    å®‰å…¨
    
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
        
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../../../%E5%B7%A5%E5%85%B7%E4%BD%BF%E7%94%A8/2024%E5%B9%B46%E6%9C%88%E6%80%BB%E7%BB%93/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    å·¥å…·ä½¿ç”¨
    
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
        
        
      
      
        
      
    
    
      
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7" checked>
        
          
          <label class="md-nav__link" for="__nav_7" id="__nav_7_label" tabindex="">
            
  
  <span class="md-ellipsis">
    å¼€å‘
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_7">
            <span class="md-nav__icon md-icon"></span>
            å¼€å‘
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
        
          
          
        
      
    
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_7_1" >
        
          
          <label class="md-nav__link" for="__nav_7_1" id="__nav_7_1_label" tabindex="">
            
  
  <span class="md-ellipsis">
    Django
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_7_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7_1">
            <span class="md-nav__icon md-icon"></span>
            Django
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Django/Aliphe.js%E6%A1%86%E6%9E%B6/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Aliphe.jsæ¡†æ¶
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Django/Bootstrap/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Bootstrap
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Django/Django%E6%A1%86%E6%9E%B6%E5%9F%BA%E7%A1%80/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    åäºŒï¼ŒDjangoæ¡†æ¶åŸºç¡€
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Django/Tailwind%20CSS/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Tailwind CSS
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
        
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../../Django/DRF%E6%A1%86%E6%9E%B6/JWT%E8%AE%A4%E8%AF%81/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    DRFæ¡†æ¶
    
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
        
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../../Django/Django%E5%9F%BA%E7%A1%80/Django%20%E8%B7%AF%E7%94%B1%E9%85%8D%E7%BD%AEURLConf/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    DjangoåŸºç¡€
    
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
        
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../../Django/Django%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98-luffycity/ES%E5%85%A8%E6%96%87%E6%A3%80%E7%B4%A2/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    Djangoé¡¹ç›®å®æˆ˜ luffycity
    
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
        
          
          
        
      
    
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_7_2" >
        
          
          <label class="md-nav__link" for="__nav_7_2" id="__nav_7_2_label" tabindex="">
            
  
  <span class="md-ellipsis">
    Golang
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_7_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7_2">
            <span class="md-nav__icon md-icon"></span>
            Golang
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Golang/GO%E8%AF%AD%E8%A8%80%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    GOè¯­è¨€åŸºç¡€å…¥é—¨å­¦ä¹ ç¬”è®°
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Golang/Go%20%E5%BC%80%E5%8F%91%E6%8A%80%E5%B7%A7%E5%AF%B9%E7%85%A7%E8%A1%A8/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Go å¼€å‘æŠ€å·§å¯¹ç…§è¡¨
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Golang/Go%20%E8%B7%A8%E5%8C%85%E8%B0%83%E7%94%A8%20%2B%20%E9%A1%B9%E7%9B%AE%E5%B7%A5%E7%A8%8B%E5%8C%96/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Go è·¨åŒ…è°ƒç”¨ + é¡¹ç›®å·¥ç¨‹åŒ–
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Golang/Golang%E6%89%93%E5%8C%85/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Golangæ‰“åŒ…
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Golang/Go%E5%91%BD%E4%BB%A4%E5%B8%AE%E5%8A%A9%E6%96%87%E6%A1%A3/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Goå‘½ä»¤å¸®åŠ©æ–‡æ¡£
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Golang/http%E8%AF%B7%E6%B1%82%E7%AC%AC%E4%B8%89%E6%96%B9%E5%BA%93/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Httpè¯·æ±‚ç¬¬ä¸‰æ–¹åº“
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
        
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../../Golang/goblog/Elasticsearch/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    Goblog
    
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
    
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
        
          
          
        
      
    
    
      
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7_3" checked>
        
          
          <label class="md-nav__link" for="__nav_7_3" id="__nav_7_3_label" tabindex="">
            
  
  <span class="md-ellipsis">
    Python
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_7_3_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_7_3">
            <span class="md-nav__icon md-icon"></span>
            Python
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Flet%E5%BA%93%20GUI%E8%B7%A8%E5%B9%B3%E5%8F%B0%E5%AD%A6%E4%B9%A0/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Fletåº“ GUIè·¨å¹³å°å­¦ä¹ 
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Python%E2%80%94%E2%80%94Gooey%E5%B0%81%E8%A3%85%E5%91%BD%E4%BB%A4%E8%A1%8CGUI%E5%B7%A5%E5%85%B7/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Pythonâ€”â€”Gooeyå°è£…å‘½ä»¤è¡ŒGUIå·¥å…·
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
        
      
    
    
      
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7_3_3" checked>
        
          
          <label class="md-nav__link" for="__nav_7_3_3" id="__nav_7_3_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    FastApi
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_7_3_3_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_7_3_3">
            <span class="md-nav__icon md-icon"></span>
            FastApi
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../FastAPI%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    FastAPIæœ€ä½³å®è·µ
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    FastApiå­¦ä¹ è®°å½•
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    FastApiå­¦ä¹ è®°å½•
    
  </span>
  

      </a>
      
        

  

<nav class="md-nav md-nav--secondary" aria-label="åœ¨è¿™ä¸ªé¡µé¢">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      åœ¨è¿™ä¸ªé¡µé¢
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#æ¦‚è¿°" class="md-nav__link">
    <span class="md-ellipsis">
      æ¦‚è¿°
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#quick-start" class="md-nav__link">
    <span class="md-ellipsis">
      quick start
    </span>
  </a>
  
    <nav class="md-nav" aria-label="quick start">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ç®€å•æ¡ˆä¾‹" class="md-nav__link">
    <span class="md-ellipsis">
      ç®€å•æ¡ˆä¾‹
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#è·¯å¾„æ“ä½œ" class="md-nav__link">
    <span class="md-ellipsis">
      è·¯å¾„æ“ä½œ
    </span>
  </a>
  
    <nav class="md-nav" aria-label="è·¯å¾„æ“ä½œ">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#è·¯å¾„æ“ä½œè£…é¥°å™¨" class="md-nav__link">
    <span class="md-ellipsis">
      è·¯å¾„æ“ä½œè£…é¥°å™¨
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#include_router" class="md-nav__link">
    <span class="md-ellipsis">
      include_router
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#è¯·æ±‚ä¸å“åº”" class="md-nav__link">
    <span class="md-ellipsis">
      è¯·æ±‚ä¸å“åº”
    </span>
  </a>
  
    <nav class="md-nav" aria-label="è¯·æ±‚ä¸å“åº”">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#41è·¯å¾„å‚æ•°" class="md-nav__link">
    <span class="md-ellipsis">
      4.1ã€è·¯å¾„å‚æ•°
    </span>
  </a>
  
    <nav class="md-nav" aria-label="4.1ã€è·¯å¾„å‚æ•°">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1åŸºæœ¬ç”¨æ³•" class="md-nav__link">
    <span class="md-ellipsis">
      ï¼ˆ1ï¼‰åŸºæœ¬ç”¨æ³•
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2æœ‰ç±»å‹çš„è·¯å¾„å‚æ•°" class="md-nav__link">
    <span class="md-ellipsis">
      ï¼ˆ2ï¼‰æœ‰ç±»å‹çš„è·¯å¾„å‚æ•°
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3æ³¨æ„é¡ºåº" class="md-nav__link">
    <span class="md-ellipsis">
      ï¼ˆ3ï¼‰æ³¨æ„é¡ºåº
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#42æŸ¥è¯¢å‚æ•°è¯·æ±‚å‚æ•°" class="md-nav__link">
    <span class="md-ellipsis">
      4.2ã€æŸ¥è¯¢å‚æ•°ï¼ˆè¯·æ±‚å‚æ•°ï¼‰
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#43è¯·æ±‚ä½“æ•°æ®" class="md-nav__link">
    <span class="md-ellipsis">
      4.3ã€è¯·æ±‚ä½“æ•°æ®
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#44formè¡¨å•æ•°æ®" class="md-nav__link">
    <span class="md-ellipsis">
      4.4ã€formè¡¨å•æ•°æ®
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#45æ–‡ä»¶ä¸Šä¼ " class="md-nav__link">
    <span class="md-ellipsis">
      4.5ã€æ–‡ä»¶ä¸Šä¼ 
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#46reqeustå¯¹è±¡" class="md-nav__link">
    <span class="md-ellipsis">
      4.6ã€Reqeustå¯¹è±¡
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#47è¯·æ±‚é™æ€æ–‡ä»¶" class="md-nav__link">
    <span class="md-ellipsis">
      4.7ã€è¯·æ±‚é™æ€æ–‡ä»¶
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#48å“åº”æ¨¡å‹ç›¸å…³å‚æ•°" class="md-nav__link">
    <span class="md-ellipsis">
      4.8ã€å“åº”æ¨¡å‹ç›¸å…³å‚æ•°
    </span>
  </a>
  
    <nav class="md-nav" aria-label="4.8ã€å“åº”æ¨¡å‹ç›¸å…³å‚æ•°">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1response_model" class="md-nav__link">
    <span class="md-ellipsis">
      ï¼ˆ1ï¼‰response_model
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2response_model_exclude_unset" class="md-nav__link">
    <span class="md-ellipsis">
      ï¼ˆ2ï¼‰response_model_exclude_unset
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3includeå’Œexclude" class="md-nav__link">
    <span class="md-ellipsis">
      ï¼ˆ3ï¼‰INCLUDEå’ŒEXCLUDE
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#jinja2æ¨¡æ¿" class="md-nav__link">
    <span class="md-ellipsis">
      jinja2æ¨¡æ¿
    </span>
  </a>
  
    <nav class="md-nav" aria-label="jinja2æ¨¡æ¿">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#51jinja2-çš„å˜é‡" class="md-nav__link">
    <span class="md-ellipsis">
      5.1ã€jinja2 çš„å˜é‡
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#52jinja2-çš„è¿‡æ»¤å™¨" class="md-nav__link">
    <span class="md-ellipsis">
      5.2ã€jinja2 çš„è¿‡æ»¤å™¨
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#53jinja2-çš„æ§åˆ¶ç»“æ„" class="md-nav__link">
    <span class="md-ellipsis">
      5.3ã€jinja2 çš„æ§åˆ¶ç»“æ„
    </span>
  </a>
  
    <nav class="md-nav" aria-label="5.3ã€jinja2 çš„æ§åˆ¶ç»“æ„">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#531åˆ†æ”¯æ§åˆ¶" class="md-nav__link">
    <span class="md-ellipsis">
      5.3.1ã€åˆ†æ”¯æ§åˆ¶
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#532å¾ªç¯æ§åˆ¶" class="md-nav__link">
    <span class="md-ellipsis">
      5.3.2ã€å¾ªç¯æ§åˆ¶
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ormæ“ä½œ" class="md-nav__link">
    <span class="md-ellipsis">
      ORMæ“ä½œ
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ORMæ“ä½œ">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#61åˆ›å»ºæ¨¡å‹" class="md-nav__link">
    <span class="md-ellipsis">
      6.1ã€åˆ›å»ºæ¨¡å‹
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#62aerichè¿ç§»å·¥å…·" class="md-nav__link">
    <span class="md-ellipsis">
      6.2ã€aerichè¿ç§»å·¥å…·
    </span>
  </a>
  
    <nav class="md-nav" aria-label="6.2ã€aerichè¿ç§»å·¥å…·">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-åˆå§‹åŒ–é…ç½®åªéœ€è¦ä½¿ç”¨ä¸€æ¬¡" class="md-nav__link">
    <span class="md-ellipsis">
      1. åˆå§‹åŒ–é…ç½®ï¼Œåªéœ€è¦ä½¿ç”¨ä¸€æ¬¡
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-åˆå§‹åŒ–æ•°æ®åº“ä¸€èˆ¬æƒ…å†µä¸‹åªç”¨ä¸€æ¬¡" class="md-nav__link">
    <span class="md-ellipsis">
      2. åˆå§‹åŒ–æ•°æ®åº“ï¼Œä¸€èˆ¬æƒ…å†µä¸‹åªç”¨ä¸€æ¬¡
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-æ›´æ–°æ¨¡å‹å¹¶è¿›è¡Œè¿ç§»" class="md-nav__link">
    <span class="md-ellipsis">
      3. æ›´æ–°æ¨¡å‹å¹¶è¿›è¡Œè¿ç§»
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4-é‡æ–°æ‰§è¡Œè¿ç§»å†™å…¥æ•°æ®åº“" class="md-nav__link">
    <span class="md-ellipsis">
      4. é‡æ–°æ‰§è¡Œè¿ç§»ï¼Œå†™å…¥æ•°æ®åº“
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#5-å›åˆ°ä¸Šä¸€ä¸ªç‰ˆæœ¬" class="md-nav__link">
    <span class="md-ellipsis">
      5. å›åˆ°ä¸Šä¸€ä¸ªç‰ˆæœ¬
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#6-æŸ¥çœ‹å†å²è¿ç§»è®°å½•" class="md-nav__link">
    <span class="md-ellipsis">
      6. æŸ¥çœ‹å†å²è¿ç§»è®°å½•
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#63apiæ¥å£ä¸restfulè§„èŒƒ" class="md-nav__link">
    <span class="md-ellipsis">
      6.3ã€apiæ¥å£ä¸restfulè§„èŒƒ
    </span>
  </a>
  
    <nav class="md-nav" aria-label="6.3ã€apiæ¥å£ä¸restfulè§„èŒƒ">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#apiæ¥å£" class="md-nav__link">
    <span class="md-ellipsis">
      apiæ¥å£
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#restfulè§„èŒƒ" class="md-nav__link">
    <span class="md-ellipsis">
      restfulè§„èŒƒ
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#64é€‰è¯¾ç³»ç»Ÿæ¥å£å¼€å‘" class="md-nav__link">
    <span class="md-ellipsis">
      6.4ã€é€‰è¯¾ç³»ç»Ÿæ¥å£å¼€å‘
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ä¸­é—´ä»¶ä¸corsè·¨åŸŸ" class="md-nav__link">
    <span class="md-ellipsis">
      ä¸­é—´ä»¶ä¸CORSè·¨åŸŸ
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ä¸­é—´ä»¶ä¸CORSè·¨åŸŸ">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ä¸­é—´ä»¶" class="md-nav__link">
    <span class="md-ellipsis">
      ä¸­é—´ä»¶
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#corsè·¨åŸŸ" class="md-nav__link">
    <span class="md-ellipsis">
      CORSè·¨åŸŸ
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#å…¨å±€å¼‚å¸¸å¤„ç†" class="md-nav__link">
    <span class="md-ellipsis">
      å…¨å±€å¼‚å¸¸å¤„ç†
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#å­—å…¸jsonå’Œå¯¹è±¡çš„è½¬æ¢" class="md-nav__link">
    <span class="md-ellipsis">
      å­—å…¸jsonå’Œå¯¹è±¡çš„è½¬æ¢
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ç”Ÿå‘½å‘¨æœŸç®¡ç†" class="md-nav__link">
    <span class="md-ellipsis">
      ç”Ÿå‘½å‘¨æœŸç®¡ç†
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#swaggeræ–‡æ¡£" class="md-nav__link">
    <span class="md-ellipsis">
      swaggeræ–‡æ¡£
    </span>
  </a>
  
    <nav class="md-nav" aria-label="swaggeræ–‡æ¡£">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#é…ç½®" class="md-nav__link">
    <span class="md-ellipsis">
      é…ç½®
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#å…³é—­" class="md-nav__link">
    <span class="md-ellipsis">
      å…³é—­
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#envé…ç½®è¯¦è§£" class="md-nav__link">
    <span class="md-ellipsis">
      .envé…ç½®è¯¦è§£
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#åå°ä»»åŠ¡tasks" class="md-nav__link">
    <span class="md-ellipsis">
      åå°ä»»åŠ¡tasks
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#è¯·æ±‚å‚æ•°æ ¡éªŒè§„åˆ™å®šä¹‰" class="md-nav__link">
    <span class="md-ellipsis">
      è¯·æ±‚å‚æ•°æ ¡éªŒè§„åˆ™å®šä¹‰
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ä¾èµ–æ³¨å…¥depends" class="md-nav__link">
    <span class="md-ellipsis">
      ä¾èµ–æ³¨å…¥Depends
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ä¾èµ–æ³¨å…¥Depends">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#å®ç°ä¸€ä¸ªç®€å•çš„ç”¨æˆ·éªŒè¯æœºåˆ¶" class="md-nav__link">
    <span class="md-ellipsis">
      å®ç°ä¸€ä¸ªç®€å•çš„ç”¨æˆ·éªŒè¯æœºåˆ¶
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#æ•°æ®åº“è¿æ¥ä¾èµ–ä»¥-sqlalchemy-ä¸ºä¾‹" class="md-nav__link">
    <span class="md-ellipsis">
      æ•°æ®åº“è¿æ¥ä¾èµ–ï¼ˆä»¥ SQLAlchemy ä¸ºä¾‹ï¼‰
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#æƒé™æ§åˆ¶è§’è‰²æƒé™ä¾èµ–" class="md-nav__link">
    <span class="md-ellipsis">
      æƒé™æ§åˆ¶ï¼ˆè§’è‰²æƒé™ä¾èµ–ï¼‰
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ä½¿ç”¨ä¾èµ–" class="md-nav__link">
    <span class="md-ellipsis">
      ä½¿ç”¨ä¾èµ–
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#è¿”å›è‡ªå®šä¹‰-response" class="md-nav__link">
    <span class="md-ellipsis">
      è¿”å›è‡ªå®šä¹‰ Response
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#æ—¥å¿—é…ç½®" class="md-nav__link">
    <span class="md-ellipsis">
      æ—¥å¿—é…ç½®
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#rediså¼‚æ­¥æ“ä½œé›†æˆ" class="md-nav__link">
    <span class="md-ellipsis">
      rediså¼‚æ­¥æ“ä½œé›†æˆ
    </span>
  </a>
  
    <nav class="md-nav" aria-label="rediså¼‚æ­¥æ“ä½œé›†æˆ">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#-å®‰è£…ä¾èµ–" class="md-nav__link">
    <span class="md-ellipsis">
      ğŸ“¦ å®‰è£…ä¾èµ–
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#-mainpy" class="md-nav__link">
    <span class="md-ellipsis">
      ğŸ”§ main.pyï¼š
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#é›†æˆcelery" class="md-nav__link">
    <span class="md-ellipsis">
      é›†æˆcelery
    </span>
  </a>
  
    <nav class="md-nav" aria-label="é›†æˆcelery">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#é…ç½®tasks" class="md-nav__link">
    <span class="md-ellipsis">
      ğŸ’ é…ç½®tasks
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ğŸ’ é…ç½®tasks">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#-å®‰è£…ä¾èµ–_1" class="md-nav__link">
    <span class="md-ellipsis">
      ğŸ§° å®‰è£…ä¾èµ–
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#-é¡¹ç›®ç»“æ„" class="md-nav__link">
    <span class="md-ellipsis">
      ğŸ“¦ é¡¹ç›®ç»“æ„
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#-taskspyå®šä¹‰å¼‚æ­¥ä»»åŠ¡" class="md-nav__link">
    <span class="md-ellipsis">
      ğŸ”§ tasks.pyï¼šå®šä¹‰å¼‚æ­¥ä»»åŠ¡
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#-mainpyfastapi-æ¥å£è§¦å‘ä»»åŠ¡" class="md-nav__link">
    <span class="md-ellipsis">
      ğŸš€ main.pyï¼šFastAPI æ¥å£è§¦å‘ä»»åŠ¡
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#-celery_workerpyå¯åŠ¨-worker-ä½¿ç”¨çš„è„šæœ¬" class="md-nav__link">
    <span class="md-ellipsis">
      ğŸ›  celery_worker.pyï¼šå¯åŠ¨ worker ä½¿ç”¨çš„è„šæœ¬
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#-å¯åŠ¨æœåŠ¡" class="md-nav__link">
    <span class="md-ellipsis">
      â–¶ å¯åŠ¨æœåŠ¡
    </span>
  </a>
  
    <nav class="md-nav" aria-label="â–¶ å¯åŠ¨æœåŠ¡">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-å¯åŠ¨-redis" class="md-nav__link">
    <span class="md-ellipsis">
      1ï¸âƒ£ å¯åŠ¨ Redis
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-å¯åŠ¨-celery-worker" class="md-nav__link">
    <span class="md-ellipsis">
      2ï¸âƒ£ å¯åŠ¨ Celery worker
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-å¯åŠ¨-fastapi-åº”ç”¨" class="md-nav__link">
    <span class="md-ellipsis">
      3ï¸âƒ£ å¯åŠ¨ FastAPI åº”ç”¨
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#-é›†æˆ-flower-å¯è§†åŒ–ç›‘æ§" class="md-nav__link">
    <span class="md-ellipsis">
      ğŸŒ¸ é›†æˆ Flower å¯è§†åŒ–ç›‘æ§
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ğŸŒ¸ é›†æˆ Flower å¯è§†åŒ–ç›‘æ§">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#-å®‰è£…-flower" class="md-nav__link">
    <span class="md-ellipsis">
      ğŸ”§ å®‰è£… Flower
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#-å¯åŠ¨-flower-ç›‘æ§" class="md-nav__link">
    <span class="md-ellipsis">
      ğŸš€ å¯åŠ¨ Flower ç›‘æ§
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#-è®¿é—®ç›‘æ§é¡µé¢" class="md-nav__link">
    <span class="md-ellipsis">
      ğŸ“Œ è®¿é—®ç›‘æ§é¡µé¢
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#-é…ç½®ä»»åŠ¡ç»“æœå­˜å‚¨result_backend" class="md-nav__link">
    <span class="md-ellipsis">
      âœ… é…ç½®ä»»åŠ¡ç»“æœå­˜å‚¨ï¼ˆresult_backendï¼‰
    </span>
  </a>
  
    <nav class="md-nav" aria-label="âœ… é…ç½®ä»»åŠ¡ç»“æœå­˜å‚¨ï¼ˆresult_backendï¼‰">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#-åœ¨-fastapi-ä¸­è·å–ä»»åŠ¡ç»“æœå¯é€‰" class="md-nav__link">
    <span class="md-ellipsis">
      ğŸ¯ åœ¨ FastAPI ä¸­è·å–ä»»åŠ¡ç»“æœï¼ˆå¯é€‰ï¼‰
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#-docker-åŒ–éƒ¨ç½²ç¤ºä¾‹" class="md-nav__link">
    <span class="md-ellipsis">
      ğŸ³ Docker åŒ–éƒ¨ç½²ï¼ˆç¤ºä¾‹ï¼‰
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ğŸ³ Docker åŒ–éƒ¨ç½²ï¼ˆç¤ºä¾‹ï¼‰">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#-åˆ›å»º-dockerfile" class="md-nav__link">
    <span class="md-ellipsis">
      ğŸ“ åˆ›å»º Dockerfile
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#-docker-composeyml-ç¤ºä¾‹" class="md-nav__link">
    <span class="md-ellipsis">
      ğŸ“ docker-compose.yml ç¤ºä¾‹
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#-ä»»åŠ¡é‡è¯•æœºåˆ¶ä¸è¶…æ—¶è®¾ç½®" class="md-nav__link">
    <span class="md-ellipsis">
      ğŸ” ä»»åŠ¡é‡è¯•æœºåˆ¶ä¸è¶…æ—¶è®¾ç½®
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#é›†æˆmongodb" class="md-nav__link">
    <span class="md-ellipsis">
      é›†æˆMongodb
    </span>
  </a>
  
    <nav class="md-nav" aria-label="é›†æˆMongodb">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#é›†æˆmotorå¼‚æ­¥client" class="md-nav__link">
    <span class="md-ellipsis">
      é›†æˆmotorå¼‚æ­¥client
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#é›†æˆbeanie-odmæ¡†æ¶" class="md-nav__link">
    <span class="md-ellipsis">
      é›†æˆBeanie odmæ¡†æ¶
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#odmå¤æ‚åµŒå¥—æ¨¡å‹å¦‚ç”¨æˆ·æ¡£æ¡ˆåœ°å€ä¿¡æ¯" class="md-nav__link">
    <span class="md-ellipsis">
      ODMå¤æ‚åµŒå¥—æ¨¡å‹ï¼ˆå¦‚ç”¨æˆ·æ¡£æ¡ˆã€åœ°å€ä¿¡æ¯ï¼‰
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#mongodb-å‰¯æœ¬é›†--é›†ç¾¤è®¤è¯é…ç½®" class="md-nav__link">
    <span class="md-ellipsis">
      MongoDB å‰¯æœ¬é›† / é›†ç¾¤è®¤è¯é…ç½®
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#curdå’Œåˆ†é¡µæ¨¡ç³Šæœç´¢" class="md-nav__link">
    <span class="md-ellipsis">
      curdå’Œåˆ†é¡µ+æ¨¡ç³Šæœç´¢
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#é›†æˆoauth2å®‰å…¨é‰´æƒ" class="md-nav__link">
    <span class="md-ellipsis">
      é›†æˆOAuth2å®‰å…¨é‰´æƒ
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#http-basic-è®¤è¯ç¤ºä¾‹" class="md-nav__link">
    <span class="md-ellipsis">
      HTTP Basic è®¤è¯ç¤ºä¾‹
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#websocketèŠå¤©å®¤" class="md-nav__link">
    <span class="md-ellipsis">
      WebSocketèŠå¤©å®¤
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#openapi-å›è°ƒ" class="md-nav__link">
    <span class="md-ellipsis">
      OpenAPI å›è°ƒ
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#webhook" class="md-nav__link">
    <span class="md-ellipsis">
      Webhook
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Webhook">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#webhookæ˜¯ä»€ä¹ˆ" class="md-nav__link">
    <span class="md-ellipsis">
      Webhookæ˜¯ä»€ä¹ˆ
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ä½¿ç”¨åœºæ™¯" class="md-nav__link">
    <span class="md-ellipsis">
      ä½¿ç”¨åœºæ™¯
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#å‚è€ƒä»£ç " class="md-nav__link">
    <span class="md-ellipsis">
      å‚è€ƒä»£ç 
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../Fastapi%E6%89%93%E5%8C%85exe%E5%92%8Cvue%E6%89%93%E5%8C%85/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Fastapiæ‰“åŒ…exeå’Œvueæ‰“åŒ…
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../fastapi-users%E6%A1%86%E6%9E%B6/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Fastapi usersæ¡†æ¶
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../full-stack-fastapi-template%E5%85%A8%E6%A0%88%E6%A8%A1%E6%9D%BF/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Full stack fastapi templateå…¨æ ˆæ¨¡æ¿
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
        
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../Flask/Flask%20%E6%96%B9%E6%A1%88/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    Flask
    
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
        
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../Pandas/Pandas%20DataFrame/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    Pandas
    
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
        
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../Python%E5%8C%85%E7%AE%A1%E7%90%86%E5%99%A8/PDM/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    PythonåŒ…ç®¡ç†å™¨
    
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
        
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../Python%E5%9F%BA%E7%A1%80/Python%20gui%E8%87%AA%E5%8A%A8%E5%8C%96/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    PythonåŸºç¡€
    
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
        
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../Python%E5%B7%A5%E7%A8%8B%E5%8C%96/Docker%E5%88%9D%E5%A7%8B%E5%8C%96/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    Pythonå·¥ç¨‹åŒ–
    
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
    
    
      
      
        
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../Python%E6%89%93%E5%8C%85/Python%E6%89%93%E5%8C%85glibc%E5%85%BC%E5%AE%B9/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    Pythonæ‰“åŒ…
    
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
        
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../%E7%88%AC%E8%99%AB%E5%92%8Cweb%E8%87%AA%E5%8A%A8%E5%8C%96/Base64%E7%BC%96%E7%A0%81/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    çˆ¬è™«å’Œwebè‡ªåŠ¨åŒ–
    
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
        
          
          
        
      
    
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_7_4" >
        
          
          <label class="md-nav__link" for="__nav_7_4" id="__nav_7_4_label" tabindex="">
            
  
  <span class="md-ellipsis">
    Rust
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_7_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7_4">
            <span class="md-nav__icon md-icon"></span>
            Rust
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Rust/Cargo%E5%8C%85%E7%AE%A1%E7%90%86%E5%99%A8/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    CargoåŒ…ç®¡ç†å™¨
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Rust/Rust%20Slice%EF%BC%88%E5%88%87%E7%89%87%EF%BC%89%E7%B1%BB%E5%9E%8B/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Rust Sliceï¼ˆåˆ‡ç‰‡ï¼‰ç±»å‹
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Rust/Rust%20%E5%87%BD%E6%95%B0/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Rust å‡½æ•°
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Rust/Rust%20%E5%9F%BA%E7%A1%80%E8%AF%AD%E6%B3%95/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Rust åŸºç¡€è¯­æ³•
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Rust/Rust%20%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Rust å¹¶å‘ç¼–ç¨‹
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Rust/Rust%20%E5%BE%AA%E7%8E%AF/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Rust å¾ªç¯
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Rust/Rust%20%E6%89%80%E6%9C%89%E6%9D%83/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Rust æ‰€æœ‰æƒ
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Rust/Rust%20%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Rust æ•°æ®ç±»å‹
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Rust/Rust%20%E6%96%87%E4%BB%B6%E4%B8%8E%20IO/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Rust æ–‡ä»¶ä¸ IO
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Rust/Rust%20%E6%9D%A1%E4%BB%B6%E8%AF%AD%E5%8F%A5/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Rust æ¡ä»¶è¯­å¥
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Rust/Rust%20%E6%9E%9A%E4%B8%BE%E7%B1%BB/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Rust æšä¸¾ç±»
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Rust/Rust%20%E6%B3%9B%E5%9E%8B%E4%B8%8E%E7%89%B9%E6%80%A7/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Rust æ³›å‹ä¸ç‰¹æ€§
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Rust/Rust%20%E6%B3%A8%E9%87%8A/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Rust æ³¨é‡Š
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Rust/Rust%20%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Rust ç”Ÿå‘½å‘¨æœŸ
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Rust/Rust%20%E7%BB%84%E7%BB%87%E7%AE%A1%E7%90%86/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Rust ç»„ç»‡ç®¡ç†
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Rust/Rust%20%E7%BB%93%E6%9E%84%E4%BD%93/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Rust ç»“æ„ä½“
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Rust/Rust%20%E8%BE%93%E5%87%BA%E5%88%B0%E5%91%BD%E4%BB%A4%E8%A1%8C/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Rust è¾“å‡ºåˆ°å‘½ä»¤è¡Œ
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Rust/Rust%20%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Rust é”™è¯¯å¤„ç†
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Rust/Rust%20%E9%9B%86%E5%90%88%E4%B8%8E%E5%AD%97%E7%AC%A6%E4%B8%B2/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Rust é›†åˆä¸å­—ç¬¦ä¸²
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Rust/Rust%20%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Rust é¢å‘å¯¹è±¡
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Rust/Rust%E5%AE%89%E8%A3%85%E5%92%8CHelloWorld/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Rustå®‰è£…å’ŒHelloWorld
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
    
    
      
      
        
          
          
        
      
    
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_7_5" >
        
          
          <label class="md-nav__link" for="__nav_7_5" id="__nav_7_5_label" tabindex="">
            
  
  <span class="md-ellipsis">
    å‰ç«¯
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_7_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7_5">
            <span class="md-nav__icon md-icon"></span>
            å‰ç«¯
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%89%8D%E7%AB%AF/P1-html%2Bcss%2Bjs%2Bes6%20%281%29/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ä¸€ï¼ŒäºŒã€HTMLï¼‹CSSå­¦ä¹ ç¬”è®°
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%89%8D%E7%AB%AF/p2-jquery%2Bajax%2Bpromise%2Bnpm%2Bgit/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    äº”ã€JQuery
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%89%8D%E7%AB%AF/p3-vue%2Bnodejs%2Btypescript%2Breact%2B%E5%B0%8F%E7%A8%8B%E5%BA%8F/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    åã€Vue
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
        
          
          
        
      
    
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_7_6" >
        
          
          <label class="md-nav__link" for="__nav_7_6" id="__nav_7_6_label" tabindex="">
            
  
  <span class="md-ellipsis">
    å¼€å‘
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_7_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7_6">
            <span class="md-nav__icon md-icon"></span>
            å¼€å‘
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%BC%80%E5%8F%91/Git%E6%95%99%E7%A8%8B/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Gitæ•™ç¨‹
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%BC%80%E5%8F%91/Java/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Javaç¬”è®°
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%BC%80%E5%8F%91/Uniapp%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%EF%BC%88Vue2%EF%BC%89/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Uniappå­¦ä¹ ç¬”è®°ï¼ˆVue2ï¼‰
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%BC%80%E5%8F%91/Vue3%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Vue3å­¦ä¹ ç¬”è®°
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%BC%80%E5%8F%91/rust%E5%AD%A6%E4%B9%A0/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    rustå­¦ä¹ 
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%BC%80%E5%8F%91/typescript%E5%AD%A6%E4%B9%A0/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    typescriptå­¦ä¹ 
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%BC%80%E5%8F%91/windows%E4%BD%BF%E7%94%A8wsl%E5%BC%80%E5%8F%91/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Windowsä½¿ç”¨wslå¼€å‘
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%BC%80%E5%8F%91/%E5%89%8D%E7%AB%AF%E5%8C%85%E7%AE%A1%E7%90%86%E5%99%A8/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    å‰ç«¯åŒ…ç®¡ç†å™¨
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%BC%80%E5%8F%91/%E6%95%B0%E6%8D%AE%E5%BA%93ORM%E7%9B%B8%E5%85%B3/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    æ•°æ®åº“ORMç›¸å…³
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
    
    
      
      
        
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../../%E5%BC%80%E5%8F%91/grpc/Go/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    Grpc
    
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
    
    
      
      
        
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../../%E5%BC%80%E5%8F%91/%E5%9B%BE%E5%83%8F%E5%A4%84%E7%90%86/Python%E5%AE%9E%E7%8E%B0/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    å›¾åƒå¤„ç†
    
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
    
    
      
      
        
          
          
        
      
    
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_7_7" >
        
          
          <label class="md-nav__link" for="__nav_7_7" id="__nav_7_7_label" tabindex="">
            
  
  <span class="md-ellipsis">
    å¾®ä¿¡å¼€å‘
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_7_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7_7">
            <span class="md-nav__icon md-icon"></span>
            å¾®ä¿¡å¼€å‘
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%BE%AE%E4%BF%A1%E5%BC%80%E5%8F%91/%E5%85%AC%E4%BC%97%E5%8F%B7/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    å…¬ä¼—å·
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%BE%AE%E4%BF%A1%E5%BC%80%E5%8F%91/%E5%86%85%E7%BD%91%E7%A9%BF%E9%80%8F/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    å†…ç½‘ç©¿é€
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%BE%AE%E4%BF%A1%E5%BC%80%E5%8F%91/%E5%9B%9E%E8%B0%83%E6%8E%A5%E5%85%A5/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    å›è°ƒæ¥å…¥
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%BE%AE%E4%BF%A1%E5%BC%80%E5%8F%91/%E6%96%87%E6%A1%A3%E5%8F%82%E8%80%83/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    æ–‡æ¡£å‚è€ƒ
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
    
    
      
      
        
          
          
        
      
    
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_7_8" >
        
          
          <label class="md-nav__link" for="__nav_7_8" id="__nav_7_8_label" tabindex="">
            
  
  <span class="md-ellipsis">
    é™æ€ç½‘ç«™åšå®¢
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_7_8_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7_8">
            <span class="md-nav__icon md-icon"></span>
            é™æ€ç½‘ç«™åšå®¢
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E9%9D%99%E6%80%81%E7%BD%91%E7%AB%99%E5%8D%9A%E5%AE%A2/GithubPage%E6%90%AD%E5%BB%BA%E5%8D%9A%E5%AE%A2/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    GithubPageæ­å»ºåšå®¢
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E9%9D%99%E6%80%81%E7%BD%91%E7%AB%99%E5%8D%9A%E5%AE%A2/mkdocs%E8%AF%A6%E7%BB%86%E9%85%8D%E7%BD%AE/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    mkdocsæ–‡æ¡£ç”Ÿæˆå™¨
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E9%9D%99%E6%80%81%E7%BD%91%E7%AB%99%E5%8D%9A%E5%AE%A2/%E9%9D%99%E6%80%81%E7%AB%99%E7%82%B9%E7%94%9F%E6%88%90%E5%99%A8/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    é™æ€ç«™ç‚¹ç”Ÿæˆå™¨
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
    
    
      
      
        
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../../../%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/windows%E6%96%87%E4%BB%B6%E5%A4%8D%E5%88%B6%E5%B8%A6%E6%9D%83%E9%99%90/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    æ“ä½œç³»ç»Ÿ
    
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
        
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../../../%E6%95%B0%E6%8D%AE%E5%BA%93%E7%AC%94%E8%AE%B0/Elasticsearch%20%E6%95%99%E7%A8%8B/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    æ•°æ®åº“ç¬”è®°
    
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
    
    
      
      
        
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../../../%E6%B5%8F%E8%A7%88%E5%99%A8%E4%B9%A6%E7%AD%BE%E6%94%B6%E8%97%8F/%E5%9C%B0%E5%9D%801/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    æµè§ˆå™¨ä¹¦ç­¾æ”¶è—
    
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
    
    
      
      
        
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../../../%E7%9B%91%E6%8E%A7/zabbix%E7%9B%91%E6%8E%A74.2/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    ç›‘æ§
    
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
    
    
      
      
        
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    
  
  
    <a href="../../../../%E8%99%9A%E6%8B%9F%E5%8C%96/%E8%99%9A%E6%8B%9F%E5%8C%96/RVtools%E4%BD%BF%E7%94%A8/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    è™šæ‹ŸåŒ–
    
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

  

      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
    
    
      
      
        
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../../../%E8%AE%A4%E8%AF%81%E7%9B%B8%E5%85%B3/credly%E6%9F%A5%E7%9C%8B%E5%8B%8B%E7%AB%A0/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    è®¤è¯ç›¸å…³
    
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  
  


  <h1>FastApiå­¦ä¹ è®°å½•</h1>

<h2 id="æ¦‚è¿°"><font style="color:rgb(51, 51, 51);background-color:rgb(243, 244, 244);">æ¦‚è¿°</font><a class="headerlink" href="#æ¦‚è¿°" title="Permanent link">&para;</a></h2>
<p><code>&lt;font style="color:rgb(51, 51, 51);background-color:rgb(243, 244, 244);"&gt;fastapi&lt;/font&gt;</code><font style="color:rgb(51, 51, 51);">ï¼Œä¸€ä¸ªç”¨äºæ„å»º API çš„ç°ä»£ã€å¿«é€Ÿï¼ˆé«˜æ€§èƒ½ï¼‰çš„webæ¡†æ¶ã€‚</font></p>
<p><code>&lt;font style="color:rgb(51, 51, 51);background-color:rgb(243, 244, 244);"&gt;fastapi&lt;/font&gt;</code><font style="color:rgb(51, 51, 51);">æ˜¯å»ºç«‹åœ¨Starletteå’ŒPydanticåŸºç¡€ä¸Šçš„ï¼ŒPydanticæ˜¯ä¸€ä¸ªåŸºäºPythonç±»å‹æç¤ºæ¥å®šä¹‰æ•°æ®éªŒè¯ã€åºåˆ—åŒ–å’Œæ–‡æ¡£çš„åº“ã€‚Starletteæ˜¯ä¸€ç§è½»é‡çº§çš„ASGIæ¡†æ¶/å·¥å…·åŒ…ï¼Œæ˜¯æ„å»ºé«˜æ€§èƒ½AsyncioæœåŠ¡çš„ç†æ€§é€‰æ‹©ã€‚</font></p>
<ul>
<li><font style="color:rgb(119, 119, 119);">å¿«é€Ÿï¼šå¯ä¸ NodeJS å’Œ Go æ¯”è‚©çš„</font><code>&lt;font style="color:rgb(119, 119, 119);background-color:rgb(243, 244, 244);"&gt;æé«˜æ€§èƒ½&lt;/font&gt;</code><font style="color:rgb(119, 119, 119);">ï¼ˆå½’åŠŸäº </font><code>&lt;font style="color:rgb(119, 119, 119);background-color:rgb(243, 244, 244);"&gt;Starlette&lt;/font&gt;</code><font style="color:rgb(119, 119, 119);"> å’Œ </font><code>&lt;font style="color:rgb(119, 119, 119);background-color:rgb(243, 244, 244);"&gt;Pydantic&lt;/font&gt;</code><font style="color:rgb(119, 119, 119);">ï¼‰ï¼Œæ˜¯æœ€å¿«çš„ Python web æ¡†æ¶ä¹‹ä¸€ã€‚</font></li>
<li><font style="color:rgb(119, 119, 119);">é«˜æ•ˆç¼–ç ï¼šæé«˜åŠŸèƒ½å¼€å‘é€Ÿåº¦çº¦ 200ï¼… è‡³ 300ï¼…ã€‚</font></li>
<li><font style="color:rgb(119, 119, 119);">æ›´å°‘bugï¼šå‡å°‘çº¦ 40ï¼… çš„äººä¸ºï¼ˆå¼€å‘è€…ï¼‰å¯¼è‡´é”™è¯¯ã€‚</font></li>
<li><font style="color:rgb(119, 119, 119);">æ™ºèƒ½ï¼šæä½³çš„ç¼–è¾‘å™¨æ”¯æŒã€‚å¤„å¤„çš†å¯è‡ªåŠ¨è¡¥å…¨ï¼Œå‡å°‘è°ƒè¯•æ—¶é—´ã€‚</font></li>
<li><font style="color:rgb(119, 119, 119);">ç®€å•ï¼šè®¾è®¡çš„</font><code>&lt;font style="color:rgb(119, 119, 119);background-color:rgb(243, 244, 244);"&gt;æ˜“äºä½¿ç”¨å’Œå­¦ä¹ &lt;/font&gt;</code><font style="color:rgb(119, 119, 119);">ï¼Œé˜…è¯»æ–‡æ¡£çš„æ—¶é—´æ›´çŸ­ã€‚</font></li>
<li><font style="color:rgb(119, 119, 119);">ç®€çŸ­ï¼šä½¿ä»£ç é‡å¤æœ€å°åŒ–ã€‚é€šè¿‡ä¸åŒçš„å‚æ•°å£°æ˜å®ç°ä¸°å¯ŒåŠŸèƒ½ã€‚</font></li>
<li><font style="color:rgb(119, 119, 119);">å¥å£®ï¼šç”Ÿäº§å¯ç”¨çº§åˆ«çš„ä»£ç ã€‚è¿˜æœ‰</font><code>&lt;font style="color:rgb(119, 119, 119);background-color:rgb(243, 244, 244);"&gt;è‡ªåŠ¨ç”Ÿæˆçš„äº¤äº’å¼æ–‡æ¡£&lt;/font&gt;</code><font style="color:rgb(119, 119, 119);">ã€‚</font></li>
</ul>
<p><font style="color:rgb(51, 51, 51);">ä¾èµ–ï¼šPython 3.6 åŠæ›´é«˜ç‰ˆæœ¬ï¼ŒFastAPI ç«™åœ¨ä»¥ä¸‹å·¨äººçš„è‚©è†€ä¹‹ä¸Š</font></p>
<p><a href="https://www.starlette.io/"><font style="color:rgb(119, 119, 119);">Starlette</font></a><font style="color:rgb(119, 119, 119);"> è´Ÿè´£ web éƒ¨åˆ†(Asyncio)</font></p>
<p><a href="https://pydantic-docs.helpmanual.io/"><font style="color:rgb(119, 119, 119);">Pydantic</font></a><font style="color:rgb(119, 119, 119);"> è´Ÿè´£æ•°æ®éƒ¨åˆ†(ç±»å‹æç¤º)</font></p>
<p><font style="color:rgb(51, 51, 51);">FastApiæ˜¯ç«™åœ¨å‰äººè‚©è†€ä¸Šï¼Œé›†æˆäº†å¤šç§æ¡†æ¶çš„ä¼˜ç‚¹çš„æ–°ç§€æ¡†æ¶ã€‚å®ƒå‡ºç°çš„æ¯”è¾ƒæ™šï¼Œ2018å¹´åº•æ‰å‘å¸ƒåœ¨githubä¸Šã€‚å¹¿æ³›åº”ç”¨äºå½“å‰å„ç§å‰åç«¯åˆ†ç¦»çš„é¡¹ç›®å¼€å‘ï¼Œæµ‹è¯•è¿ç»´è‡ªåŠ¨åŒ–ä»¥åŠå¾®æœåŠ¡çš„åœºæ™¯ä¸­ã€‚</font></p>
<h2 id="quick-start"><font style="color:rgb(51, 51, 51);">quick start</font><a class="headerlink" href="#quick-start" title="Permanent link">&para;</a></h2>
<h3 id="ç®€å•æ¡ˆä¾‹"><font style="color:rgb(51, 51, 51);">ç®€å•æ¡ˆä¾‹</font><a class="headerlink" href="#ç®€å•æ¡ˆä¾‹" title="Permanent link">&para;</a></h3>
<p><strong><font style="color:rgb(51, 51, 51);">å®‰è£…</font></strong></p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Python</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="n">pip</span> <span class="n">install</span> <span class="n">fastapi</span>
</code></pre></div></td></tr></table></div>
<p><font style="color:rgb(51, 51, 51);">ä½ è¿˜ä¼šéœ€è¦ä¸€ä¸ª ASGI æœåŠ¡å™¨ï¼Œç”Ÿäº§ç¯å¢ƒå¯ä»¥ä½¿ç”¨ </font><a href="https://www.uvicorn.org/"><font style="color:rgb(51, 51, 51);">Uvicorn</font></a></p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Python</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-1-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1"></a><span class="n">pip</span> <span class="n">install</span> <span class="n">uvicorn</span>
</code></pre></div></td></tr></table></div>
<p><strong><font style="color:rgb(51, 51, 51);">ä»£ç </font></strong></p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Python</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-2-1">1</a></span>
<span class="normal"><a href="#__codelineno-2-2">2</a></span>
<span class="normal"><a href="#__codelineno-2-3">3</a></span>
<span class="normal"><a href="#__codelineno-2-4">4</a></span>
<span class="normal"><a href="#__codelineno-2-5">5</a></span>
<span class="normal"><a href="#__codelineno-2-6">6</a></span>
<span class="normal"><a href="#__codelineno-2-7">7</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">fastapi</span><span class="w"> </span><span class="kn">import</span> <span class="n">FastAPI</span>  <span class="c1"># FastAPI æ˜¯ä¸€ä¸ªä¸ºä½ çš„ API æä¾›äº†æ‰€æœ‰åŠŸèƒ½çš„ Python ç±»ã€‚</span>
<a id="__codelineno-2-2" name="__codelineno-2-2"></a>
<a id="__codelineno-2-3" name="__codelineno-2-3"></a><span class="n">app</span> <span class="o">=</span> <span class="n">FastAPI</span><span class="p">()</span>  <span class="c1"># è¿™ä¸ªå®ä¾‹å°†æ˜¯åˆ›å»ºä½ æ‰€æœ‰ API çš„ä¸»è¦äº¤äº’å¯¹è±¡ã€‚è¿™ä¸ª app åŒæ ·åœ¨å¦‚ä¸‹å‘½ä»¤ä¸­è¢« uvicorn æ‰€å¼•ç”¨</span>
<a id="__codelineno-2-4" name="__codelineno-2-4"></a>
<a id="__codelineno-2-5" name="__codelineno-2-5"></a><span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
<a id="__codelineno-2-6" name="__codelineno-2-6"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">root</span><span class="p">():</span>
<a id="__codelineno-2-7" name="__codelineno-2-7"></a>    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;Hello yuan&quot;</span><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p><font style="color:rgb(51, 51, 51);">é€šè¿‡ä»¥ä¸‹å‘½ä»¤è¿è¡ŒæœåŠ¡å™¨ï¼š</font></p>
<p><font style="color:rgb(51, 51, 51);">uvicorn main:app --reload</font></p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Python</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-3-1">1</a></span>
<span class="normal"><a href="#__codelineno-3-2">2</a></span>
<span class="normal"><a href="#__codelineno-3-3">3</a></span>
<span class="normal"><a href="#__codelineno-3-4">4</a></span>
<span class="normal"><a href="#__codelineno-3-5">5</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1"></a><span class="n">INFO</span><span class="p">:</span>     <span class="n">Uvicorn</span> <span class="n">running</span> <span class="n">on</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="mf">127.0.0.1</span><span class="p">:</span><span class="mi">8000</span> <span class="p">(</span><span class="n">Press</span> <span class="n">CTRL</span><span class="o">+</span><span class="n">C</span> <span class="n">to</span> <span class="n">quit</span><span class="p">)</span>
<a id="__codelineno-3-2" name="__codelineno-3-2"></a><span class="n">INFO</span><span class="p">:</span>     <span class="n">Started</span> <span class="n">reloader</span> <span class="n">process</span> <span class="p">[</span><span class="mi">73408</span><span class="p">]</span>
<a id="__codelineno-3-3" name="__codelineno-3-3"></a><span class="n">INFO</span><span class="p">:</span>     <span class="n">Started</span> <span class="n">server</span> <span class="n">process</span> <span class="p">[</span><span class="mi">73408</span><span class="p">]</span>
<a id="__codelineno-3-4" name="__codelineno-3-4"></a><span class="n">INFO</span><span class="p">:</span>     <span class="n">Waiting</span> <span class="k">for</span> <span class="n">application</span> <span class="n">startup</span>
<a id="__codelineno-3-5" name="__codelineno-3-5"></a><span class="n">INFO</span><span class="p">:</span>     <span class="n">Application</span> <span class="n">startup</span> <span class="n">complete</span>
</code></pre></div></td></tr></table></div>
<p><font style="color:rgb(51, 51, 51);">ä¹Ÿå¯ä»¥ç›´æ¥è¿è¡Œï¼š</font></p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Python</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-4-1">1</a></span>
<span class="normal"><a href="#__codelineno-4-2">2</a></span>
<span class="normal"><a href="#__codelineno-4-3">3</a></span>
<span class="normal"><a href="#__codelineno-4-4">4</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1"></a><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
<a id="__codelineno-4-2" name="__codelineno-4-2"></a>    <span class="kn">import</span><span class="w"> </span><span class="nn">uvicorn</span>
<a id="__codelineno-4-3" name="__codelineno-4-3"></a>
<a id="__codelineno-4-4" name="__codelineno-4-4"></a>    <span class="n">uvicorn</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s2">&quot;main:app&quot;</span><span class="p">,</span> <span class="n">host</span><span class="o">=</span><span class="s2">&quot;127.0.0.1&quot;</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">8080</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">reload</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
<p><font style="color:rgb(119, 119, 119);">ï¼ˆ1ï¼‰å¯¼å…¥ FastAPIã€‚ï¼ˆ2ï¼‰åˆ›å»ºä¸€ä¸ª app å®ä¾‹ã€‚ï¼ˆ3ï¼‰ç¼–å†™ä¸€ä¸ªè·¯å¾„æ“ä½œè£…é¥°å™¨ï¼ˆå¦‚ @app.get("/")ï¼‰ã€‚ï¼ˆ4ï¼‰ç¼–å†™ä¸€ä¸ªè·¯å¾„æ“ä½œå‡½æ•°ï¼ˆå¦‚ä¸Šé¢çš„ def root(): ...ï¼‰ï¼ˆ5ï¼‰å®šä¹‰è¿”å›å€¼ï¼ˆ6ï¼‰è¿è¡Œå¼€å‘æœåŠ¡å™¨ï¼ˆå¦‚ uvicorn main:app --reloadï¼‰</font></p>
<p><font style="color:rgb(51, 51, 51);">æ­¤å¤–ï¼Œfastapiæœ‰ç€</font><strong><font style="color:rgb(51, 51, 51);">éå¸¸æ£’çš„äº¤äº’å¼ API æ–‡æ¡£</font></strong><font style="color:rgb(51, 51, 51);">ï¼Œè¿™ä¸€ç‚¹å¾ˆå¸å¼•äººã€‚</font></p>
<p><font style="color:rgb(51, 51, 51);">è·³è½¬åˆ° </font><a href="http://127.0.0.1:8080/docs"><font style="color:rgb(51, 51, 51);">http://127.0.0.1:8080/docs</font></a><font style="color:rgb(51, 51, 51);">ã€‚ä½ å°†ä¼šçœ‹åˆ°</font><strong><font style="color:rgb(51, 51, 51);">è‡ªåŠ¨ç”Ÿæˆ</font></strong><font style="color:rgb(51, 51, 51);">çš„äº¤äº’å¼ API æ–‡æ¡£ã€‚</font></p>
<h2 id="è·¯å¾„æ“ä½œ"><font style="color:rgb(51, 51, 51);">è·¯å¾„æ“ä½œ</font><a class="headerlink" href="#è·¯å¾„æ“ä½œ" title="Permanent link">&para;</a></h2>
<h3 id="è·¯å¾„æ“ä½œè£…é¥°å™¨"><font style="color:rgb(51, 51, 51);">è·¯å¾„æ“ä½œè£…é¥°å™¨</font><a class="headerlink" href="#è·¯å¾„æ“ä½œè£…é¥°å™¨" title="Permanent link">&para;</a></h3>
<p><font style="color:rgb(51, 51, 51);">fastapiæ”¯æŒå„ç§è¯·æ±‚æ–¹å¼ï¼š</font></p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Python</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-5-1">1</a></span>
<span class="normal"><a href="#__codelineno-5-2">2</a></span>
<span class="normal"><a href="#__codelineno-5-3">3</a></span>
<span class="normal"><a href="#__codelineno-5-4">4</a></span>
<span class="normal"><a href="#__codelineno-5-5">5</a></span>
<span class="normal"><a href="#__codelineno-5-6">6</a></span>
<span class="normal"><a href="#__codelineno-5-7">7</a></span>
<span class="normal"><a href="#__codelineno-5-8">8</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1"></a><span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
<a id="__codelineno-5-2" name="__codelineno-5-2"></a><span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">()</span>
<a id="__codelineno-5-3" name="__codelineno-5-3"></a><span class="nd">@app</span><span class="o">.</span><span class="n">put</span><span class="p">()</span>
<a id="__codelineno-5-4" name="__codelineno-5-4"></a><span class="nd">@app</span><span class="o">.</span><span class="n">patch</span><span class="p">()</span>
<a id="__codelineno-5-5" name="__codelineno-5-5"></a><span class="nd">@app</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
<a id="__codelineno-5-6" name="__codelineno-5-6"></a><span class="nd">@app</span><span class="o">.</span><span class="n">options</span><span class="p">()</span>
<a id="__codelineno-5-7" name="__codelineno-5-7"></a><span class="nd">@app</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
<a id="__codelineno-5-8" name="__codelineno-5-8"></a><span class="nd">@app</span><span class="o">.</span><span class="n">trace</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
<table>
<thead>
<tr>
<th>FastAPI è£…é¥°å™¨</th>
<th>HTTP æ–¹æ³•</th>
<th>æ“ä½œç±»å‹</th>
<th>å¸¸è§ç”¨é€”</th>
<th>æ˜¯å¦å¹‚ç­‰</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>@app.get()</code></td>
<td>GET</td>
<td>è¯»å–èµ„æº</td>
<td>æŸ¥è¯¢æ•°æ®ã€è·å–åˆ—è¡¨æˆ–è¯¦æƒ…</td>
<td>âœ… æ˜¯</td>
</tr>
<tr>
<td><code>@app.post()</code></td>
<td>POST</td>
<td>åˆ›å»ºèµ„æº</td>
<td>æ–°å¢æ•°æ®ã€æäº¤è¡¨å•ã€ä¸Šä¼ æ–‡ä»¶</td>
<td>âŒ å¦</td>
</tr>
<tr>
<td><code>@app.put()</code></td>
<td>PUT</td>
<td>æ›´æ–°èµ„æºï¼ˆæ•´ä½“ï¼‰</td>
<td>æ›¿æ¢å¯¹è±¡æ‰€æœ‰å­—æ®µ</td>
<td>âœ… æ˜¯</td>
</tr>
<tr>
<td><code>@app.patch()</code></td>
<td>PATCH</td>
<td>æ›´æ–°èµ„æºï¼ˆéƒ¨åˆ†ï¼‰</td>
<td>å±€éƒ¨ä¿®æ”¹å¯¹è±¡å­—æ®µ</td>
<td>âŒ/âœ… è§†å®ç°è€Œå®š</td>
</tr>
<tr>
<td><code>@app.delete()</code></td>
<td>DELETE</td>
<td>åˆ é™¤èµ„æº</td>
<td>åˆ é™¤è®°å½•ã€æ³¨é”€è´¦å·ç­‰</td>
<td>âœ… æ˜¯</td>
</tr>
<tr>
<td><code>@app.options()</code></td>
<td>OPTIONS</td>
<td>è·å–é€šä¿¡é€‰é¡¹</td>
<td>æŸ¥çœ‹å…è®¸çš„æ–¹æ³•ï¼ˆCORS è¯·æ±‚é¢„æ£€ï¼‰</td>
<td>âœ… æ˜¯</td>
</tr>
<tr>
<td><code>@app.head()</code></td>
<td>HEAD</td>
<td>ç±»ä¼¼ GETï¼Œä½†æ— å“åº”ä½“</td>
<td>ç”¨äºæ£€æŸ¥èµ„æºæ˜¯å¦å­˜åœ¨</td>
<td>âœ… æ˜¯</td>
</tr>
<tr>
<td><code>@app.trace()</code></td>
<td>TRACE</td>
<td>å›æ˜¾è¯·æ±‚å†…å®¹</td>
<td>è°ƒè¯•ç”¨é€”ï¼ˆä¸å¸¸ç”¨ï¼‰</td>
<td>âœ… æ˜¯</td>
</tr>
</tbody>
</table>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Python</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-6-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-6-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-6-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-6-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-6-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-6-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-6-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-6-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-6-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-6-10">10</a></span>
<span class="normal"><a href="#__codelineno-6-11">11</a></span>
<span class="normal"><a href="#__codelineno-6-12">12</a></span>
<span class="normal"><a href="#__codelineno-6-13">13</a></span>
<span class="normal"><a href="#__codelineno-6-14">14</a></span>
<span class="normal"><a href="#__codelineno-6-15">15</a></span>
<span class="normal"><a href="#__codelineno-6-16">16</a></span>
<span class="normal"><a href="#__codelineno-6-17">17</a></span>
<span class="normal"><a href="#__codelineno-6-18">18</a></span>
<span class="normal"><a href="#__codelineno-6-19">19</a></span>
<span class="normal"><a href="#__codelineno-6-20">20</a></span>
<span class="normal"><a href="#__codelineno-6-21">21</a></span>
<span class="normal"><a href="#__codelineno-6-22">22</a></span>
<span class="normal"><a href="#__codelineno-6-23">23</a></span>
<span class="normal"><a href="#__codelineno-6-24">24</a></span>
<span class="normal"><a href="#__codelineno-6-25">25</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Union</span>
<a id="__codelineno-6-2" name="__codelineno-6-2"></a>
<a id="__codelineno-6-3" name="__codelineno-6-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">fastapi</span><span class="w"> </span><span class="kn">import</span> <span class="n">FastAPI</span>
<a id="__codelineno-6-4" name="__codelineno-6-4"></a>
<a id="__codelineno-6-5" name="__codelineno-6-5"></a><span class="n">app</span> <span class="o">=</span> <span class="n">FastAPI</span><span class="p">()</span>
<a id="__codelineno-6-6" name="__codelineno-6-6"></a>
<a id="__codelineno-6-7" name="__codelineno-6-7"></a>
<a id="__codelineno-6-8" name="__codelineno-6-8"></a><span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/get&quot;</span><span class="p">)</span>
<a id="__codelineno-6-9" name="__codelineno-6-9"></a><span class="k">def</span><span class="w"> </span><span class="nf">get_test</span><span class="p">():</span>
<a id="__codelineno-6-10" name="__codelineno-6-10"></a>    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;method&quot;</span><span class="p">:</span> <span class="s2">&quot;getæ–¹æ³•&quot;</span><span class="p">}</span>
<a id="__codelineno-6-11" name="__codelineno-6-11"></a>
<a id="__codelineno-6-12" name="__codelineno-6-12"></a>
<a id="__codelineno-6-13" name="__codelineno-6-13"></a><span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/post&quot;</span><span class="p">)</span>
<a id="__codelineno-6-14" name="__codelineno-6-14"></a><span class="k">def</span><span class="w"> </span><span class="nf">post_test</span><span class="p">():</span>
<a id="__codelineno-6-15" name="__codelineno-6-15"></a>    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;method&quot;</span><span class="p">:</span> <span class="s2">&quot;postæ–¹æ³•&quot;</span><span class="p">}</span>
<a id="__codelineno-6-16" name="__codelineno-6-16"></a>
<a id="__codelineno-6-17" name="__codelineno-6-17"></a>
<a id="__codelineno-6-18" name="__codelineno-6-18"></a><span class="nd">@app</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s2">&quot;/put&quot;</span><span class="p">)</span>
<a id="__codelineno-6-19" name="__codelineno-6-19"></a><span class="k">def</span><span class="w"> </span><span class="nf">put_test</span><span class="p">():</span>
<a id="__codelineno-6-20" name="__codelineno-6-20"></a>    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;method&quot;</span><span class="p">:</span> <span class="s2">&quot;putæ–¹æ³•&quot;</span><span class="p">}</span>
<a id="__codelineno-6-21" name="__codelineno-6-21"></a>
<a id="__codelineno-6-22" name="__codelineno-6-22"></a>
<a id="__codelineno-6-23" name="__codelineno-6-23"></a><span class="nd">@app</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="s2">&quot;/delete&quot;</span><span class="p">)</span>
<a id="__codelineno-6-24" name="__codelineno-6-24"></a><span class="k">def</span><span class="w"> </span><span class="nf">delete_test</span><span class="p">():</span>
<a id="__codelineno-6-25" name="__codelineno-6-25"></a>    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;method&quot;</span><span class="p">:</span> <span class="s2">&quot;deleteæ–¹æ³•&quot;</span><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p><img alt="" src="../../../../images/1721480552012-92ce2005-e3c1-43fe-9dfd-64ff2639e308.png" /></p>
<p><font style="color:rgb(51, 51, 51);">è·¯å¾„æ“ä½œè£…é¥°å™¨å‚æ•°ï¼š</font></p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Python</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-7-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-7-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-7-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-7-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-7-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-7-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-7-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-7-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-7-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-7-10">10</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1"></a><span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
<a id="__codelineno-7-2" name="__codelineno-7-2"></a>    <span class="s2">&quot;/items/</span><span class="si">{item_id}</span><span class="s2">&quot;</span><span class="p">,</span>
<a id="__codelineno-7-3" name="__codelineno-7-3"></a>    <span class="n">response_model</span><span class="o">=</span><span class="n">Item</span><span class="p">,</span>
<a id="__codelineno-7-4" name="__codelineno-7-4"></a>    <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_200_OK</span><span class="p">,</span>
<a id="__codelineno-7-5" name="__codelineno-7-5"></a>    <span class="n">tags</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;AAA&quot;</span><span class="p">],</span>
<a id="__codelineno-7-6" name="__codelineno-7-6"></a>    <span class="n">summary</span><span class="o">=</span><span class="s2">&quot;this is summary&quot;</span><span class="p">,</span>
<a id="__codelineno-7-7" name="__codelineno-7-7"></a>    <span class="n">description</span><span class="o">=</span><span class="s2">&quot;this is description&quot;</span><span class="p">,</span>
<a id="__codelineno-7-8" name="__codelineno-7-8"></a>    <span class="n">response_description</span><span class="o">=</span> <span class="s2">&quot;this is response_description&quot;</span><span class="p">,</span>
<a id="__codelineno-7-9" name="__codelineno-7-9"></a>    <span class="n">deprecated</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-7-10" name="__codelineno-7-10"></a><span class="p">)</span>
</code></pre></div></td></tr></table></div>
<h3 id="include_router"><font style="color:rgb(51, 51, 51);">include_router</font><a class="headerlink" href="#include_router" title="Permanent link">&para;</a></h3>
<p><font style="color:rgb(51, 51, 51);">main.py</font></p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Python</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-8-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-8-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-8-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-8-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-8-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-8-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-8-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-8-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-8-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-8-10">10</a></span>
<span class="normal"><a href="#__codelineno-8-11">11</a></span>
<span class="normal"><a href="#__codelineno-8-12">12</a></span>
<span class="normal"><a href="#__codelineno-8-13">13</a></span>
<span class="normal"><a href="#__codelineno-8-14">14</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Union</span>
<a id="__codelineno-8-2" name="__codelineno-8-2"></a>
<a id="__codelineno-8-3" name="__codelineno-8-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">fastapi</span><span class="w"> </span><span class="kn">import</span> <span class="n">FastAPI</span>
<a id="__codelineno-8-4" name="__codelineno-8-4"></a><span class="kn">import</span><span class="w"> </span><span class="nn">uvicorn</span>
<a id="__codelineno-8-5" name="__codelineno-8-5"></a>
<a id="__codelineno-8-6" name="__codelineno-8-6"></a><span class="kn">from</span><span class="w"> </span><span class="nn">apps</span><span class="w"> </span><span class="kn">import</span> <span class="n">app01</span><span class="p">,</span> <span class="n">app02</span>
<a id="__codelineno-8-7" name="__codelineno-8-7"></a>
<a id="__codelineno-8-8" name="__codelineno-8-8"></a><span class="n">app</span> <span class="o">=</span> <span class="n">FastAPI</span><span class="p">()</span>
<a id="__codelineno-8-9" name="__codelineno-8-9"></a>
<a id="__codelineno-8-10" name="__codelineno-8-10"></a><span class="n">app</span><span class="o">.</span><span class="n">include_router</span><span class="p">(</span><span class="n">app01</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;/app01&quot;</span><span class="p">,</span> <span class="n">tags</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;ç¬¬ä¸€ç« èŠ‚ï¼šå•†åŸæ¥å£&quot;</span><span class="p">,</span> <span class="p">])</span>
<a id="__codelineno-8-11" name="__codelineno-8-11"></a><span class="n">app</span><span class="o">.</span><span class="n">include_router</span><span class="p">(</span><span class="n">app02</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;/app02&quot;</span><span class="p">,</span> <span class="n">tags</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;ç¬¬äºŒç« èŠ‚ï¼šç”¨æˆ·ä¸­å¿ƒæ¥å£&quot;</span><span class="p">,</span> <span class="p">])</span>
<a id="__codelineno-8-12" name="__codelineno-8-12"></a>
<a id="__codelineno-8-13" name="__codelineno-8-13"></a><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
<a id="__codelineno-8-14" name="__codelineno-8-14"></a>    <span class="n">uvicorn</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s2">&quot;main:app&quot;</span><span class="p">,</span> <span class="n">host</span><span class="o">=</span><span class="s2">&quot;127.0.0.1&quot;</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">8080</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">reload</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
<p><font style="color:rgb(51, 51, 51);">ä¸main.pyåŒçº§ç›®å½•appsï¼š</font><img alt="" src="../../../../images/1721480539015-94eda5aa-d243-48b0-9d52-487e1859d160.png" /></p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Python</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-9-1">1</a></span>
<span class="normal"><a href="#__codelineno-9-2">2</a></span>
<span class="normal"><a href="#__codelineno-9-3">3</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-9-1" name="__codelineno-9-1"></a><span class="c1"># __init__.py</span>
<a id="__codelineno-9-2" name="__codelineno-9-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">.app01</span><span class="w"> </span><span class="kn">import</span> <span class="n">app01</span>
<a id="__codelineno-9-3" name="__codelineno-9-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">.app02</span><span class="w"> </span><span class="kn">import</span> <span class="n">app02</span>
</code></pre></div></td></tr></table></div>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Python</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-10-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-10-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-10-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-10-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-10-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-10-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-10-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-10-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-10-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-10-10">10</a></span>
<span class="normal"><a href="#__codelineno-10-11">11</a></span>
<span class="normal"><a href="#__codelineno-10-12">12</a></span>
<span class="normal"><a href="#__codelineno-10-13">13</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-10-1" name="__codelineno-10-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">fastapi</span><span class="w"> </span><span class="kn">import</span> <span class="n">APIRouter</span>
<a id="__codelineno-10-2" name="__codelineno-10-2"></a>
<a id="__codelineno-10-3" name="__codelineno-10-3"></a><span class="n">app01</span> <span class="o">=</span> <span class="n">APIRouter</span><span class="p">()</span>
<a id="__codelineno-10-4" name="__codelineno-10-4"></a>
<a id="__codelineno-10-5" name="__codelineno-10-5"></a>
<a id="__codelineno-10-6" name="__codelineno-10-6"></a><span class="nd">@app01</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/shop/food&quot;</span><span class="p">)</span>
<a id="__codelineno-10-7" name="__codelineno-10-7"></a><span class="k">def</span><span class="w"> </span><span class="nf">shop_food</span><span class="p">():</span>
<a id="__codelineno-10-8" name="__codelineno-10-8"></a>    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;shop&quot;</span><span class="p">:</span> <span class="s2">&quot;food&quot;</span><span class="p">}</span>
<a id="__codelineno-10-9" name="__codelineno-10-9"></a>
<a id="__codelineno-10-10" name="__codelineno-10-10"></a>
<a id="__codelineno-10-11" name="__codelineno-10-11"></a><span class="nd">@app01</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/shop/bed&quot;</span><span class="p">)</span>
<a id="__codelineno-10-12" name="__codelineno-10-12"></a><span class="k">def</span><span class="w"> </span><span class="nf">shop_food</span><span class="p">():</span>
<a id="__codelineno-10-13" name="__codelineno-10-13"></a>    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;shop&quot;</span><span class="p">:</span> <span class="s2">&quot;bed&quot;</span><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Python</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-11-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-11-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-11-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-11-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-11-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-11-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-11-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-11-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-11-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-11-10">10</a></span>
<span class="normal"><a href="#__codelineno-11-11">11</a></span>
<span class="normal"><a href="#__codelineno-11-12">12</a></span>
<span class="normal"><a href="#__codelineno-11-13">13</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-11-1" name="__codelineno-11-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">fastapi</span><span class="w"> </span><span class="kn">import</span> <span class="n">APIRouter</span>
<a id="__codelineno-11-2" name="__codelineno-11-2"></a>
<a id="__codelineno-11-3" name="__codelineno-11-3"></a><span class="n">app02</span> <span class="o">=</span> <span class="n">APIRouter</span><span class="p">()</span>
<a id="__codelineno-11-4" name="__codelineno-11-4"></a>
<a id="__codelineno-11-5" name="__codelineno-11-5"></a>
<a id="__codelineno-11-6" name="__codelineno-11-6"></a><span class="nd">@app02</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/user/login&quot;</span><span class="p">)</span>
<a id="__codelineno-11-7" name="__codelineno-11-7"></a><span class="k">def</span><span class="w"> </span><span class="nf">user_login</span><span class="p">():</span>
<a id="__codelineno-11-8" name="__codelineno-11-8"></a>    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;user&quot;</span><span class="p">:</span> <span class="s2">&quot;login&quot;</span><span class="p">}</span>
<a id="__codelineno-11-9" name="__codelineno-11-9"></a>
<a id="__codelineno-11-10" name="__codelineno-11-10"></a>
<a id="__codelineno-11-11" name="__codelineno-11-11"></a><span class="nd">@app02</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/user/reg&quot;</span><span class="p">)</span>
<a id="__codelineno-11-12" name="__codelineno-11-12"></a><span class="k">def</span><span class="w"> </span><span class="nf">user_reg</span><span class="p">():</span>
<a id="__codelineno-11-13" name="__codelineno-11-13"></a>    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;user&quot;</span><span class="p">:</span> <span class="s2">&quot;reg&quot;</span><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p><img alt="" src="../../../../images/1721480570631-48b71f7e-0f45-4d38-bfb9-b2b1cb2e8de0.png" /></p>
<h2 id="è¯·æ±‚ä¸å“åº”"><font style="color:rgb(51, 51, 51);">è¯·æ±‚ä¸å“åº”</font><a class="headerlink" href="#è¯·æ±‚ä¸å“åº”" title="Permanent link">&para;</a></h2>
<h3 id="41è·¯å¾„å‚æ•°"><font style="color:rgb(51, 51, 51);">4.1ã€è·¯å¾„å‚æ•°</font><a class="headerlink" href="#41è·¯å¾„å‚æ•°" title="Permanent link">&para;</a></h3>
<h4 id="1åŸºæœ¬ç”¨æ³•"><font style="color:rgb(51, 51, 51);">ï¼ˆ1ï¼‰åŸºæœ¬ç”¨æ³•</font><a class="headerlink" href="#1åŸºæœ¬ç”¨æ³•" title="Permanent link">&para;</a></h4>
<p><font style="color:rgb(51, 51, 51);">ä»¥ä½¿ç”¨ä¸ Python æ ¼å¼åŒ–å­—ç¬¦ä¸²ç›¸åŒçš„è¯­æ³•æ¥å£°æ˜è·¯å¾„"å‚æ•°"æˆ–"å˜é‡"ï¼š</font></p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Python</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-12-1">1</a></span>
<span class="normal"><a href="#__codelineno-12-2">2</a></span>
<span class="normal"><a href="#__codelineno-12-3">3</a></span>
<span class="normal"><a href="#__codelineno-12-4">4</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-12-1" name="__codelineno-12-1"></a><span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/user/</span><span class="si">{user_id}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-12-2" name="__codelineno-12-2"></a><span class="k">def</span><span class="w"> </span><span class="nf">get_user</span><span class="p">(</span><span class="n">user_id</span><span class="p">):</span>
<a id="__codelineno-12-3" name="__codelineno-12-3"></a>    <span class="nb">print</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">user_id</span><span class="p">))</span>
<a id="__codelineno-12-4" name="__codelineno-12-4"></a>    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;user_id&quot;</span><span class="p">:</span> <span class="n">user_id</span><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p><font style="color:rgb(51, 51, 51);">è·¯å¾„å‚æ•° </font><code>&lt;font style="color:rgb(51, 51, 51);background-color:rgb(243, 244, 244);"&gt;user_id&lt;/font&gt;</code><font style="color:rgb(51, 51, 51);"> çš„å€¼å°†ä½œä¸ºå‚æ•° </font><code>&lt;font style="color:rgb(51, 51, 51);background-color:rgb(243, 244, 244);"&gt;user_id&lt;/font&gt;</code><font style="color:rgb(51, 51, 51);"> ä¼ é€’ç»™ä½ çš„å‡½æ•°ã€‚</font></p>
<h4 id="2æœ‰ç±»å‹çš„è·¯å¾„å‚æ•°"><font style="color:rgb(51, 51, 51);">ï¼ˆ2ï¼‰æœ‰ç±»å‹çš„è·¯å¾„å‚æ•°</font><a class="headerlink" href="#2æœ‰ç±»å‹çš„è·¯å¾„å‚æ•°" title="Permanent link">&para;</a></h4>
<p><font style="color:rgb(51, 51, 51);">ä½ å¯ä»¥ä½¿ç”¨æ ‡å‡†çš„ Python ç±»å‹æ ‡æ³¨ä¸ºå‡½æ•°ä¸­çš„è·¯å¾„å‚æ•°å£°æ˜ç±»å‹ã€‚</font></p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Python</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-13-1">1</a></span>
<span class="normal"><a href="#__codelineno-13-2">2</a></span>
<span class="normal"><a href="#__codelineno-13-3">3</a></span>
<span class="normal"><a href="#__codelineno-13-4">4</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-13-1" name="__codelineno-13-1"></a><span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/user/</span><span class="si">{user_id}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-13-2" name="__codelineno-13-2"></a><span class="k">def</span><span class="w"> </span><span class="nf">get_user</span><span class="p">(</span><span class="n">user_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
<a id="__codelineno-13-3" name="__codelineno-13-3"></a>    <span class="nb">print</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">user_id</span><span class="p">))</span>
<a id="__codelineno-13-4" name="__codelineno-13-4"></a>    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;user_id&quot;</span><span class="p">:</span> <span class="n">user_id</span><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p><font style="color:rgb(51, 51, 51);">åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œ</font><code>&lt;font style="color:rgb(51, 51, 51);background-color:rgb(243, 244, 244);"&gt;user_id&lt;/font&gt;</code><font style="color:rgb(51, 51, 51);"> è¢«å£°æ˜ä¸º </font><code>&lt;font style="color:rgb(51, 51, 51);background-color:rgb(243, 244, 244);"&gt;int&lt;/font&gt;</code><font style="color:rgb(51, 51, 51);"> ç±»å‹ã€‚</font></p>
<p><font style="color:rgb(119, 119, 119);">è¿™å°†ä¸ºä½ çš„å‡½æ•°æä¾›ç¼–è¾‘å™¨æ”¯æŒï¼ŒåŒ…æ‹¬é”™è¯¯æ£€æŸ¥ã€ä»£ç è¡¥å…¨ç­‰ç­‰ã€‚</font></p>
<h4 id="3æ³¨æ„é¡ºåº"><font style="color:rgb(51, 51, 51);">ï¼ˆ3ï¼‰æ³¨æ„é¡ºåº</font><a class="headerlink" href="#3æ³¨æ„é¡ºåº" title="Permanent link">&para;</a></h4>
<p><font style="color:rgb(51, 51, 51);">åœ¨åˆ›å»º</font><em><font style="color:rgb(51, 51, 51);">è·¯å¾„æ“ä½œ</font></em><font style="color:rgb(51, 51, 51);">æ—¶ï¼Œä½ ä¼šå‘ç°æœ‰äº›æƒ…å†µä¸‹è·¯å¾„æ˜¯å›ºå®šçš„ã€‚</font></p>
<p><font style="color:rgb(51, 51, 51);">æ¯”å¦‚ </font><code>&lt;font style="color:rgb(51, 51, 51);background-color:rgb(243, 244, 244);"&gt;/users/me&lt;/font&gt;</code><font style="color:rgb(51, 51, 51);">ï¼Œæˆ‘ä»¬å‡è®¾å®ƒç”¨æ¥è·å–å…³äºå½“å‰ç”¨æˆ·çš„æ•°æ®.</font></p>
<p><font style="color:rgb(51, 51, 51);">ç„¶åï¼Œä½ è¿˜å¯ä»¥ä½¿ç”¨è·¯å¾„ </font><code>&lt;font style="color:rgb(51, 51, 51);background-color:rgb(243, 244, 244);"&gt;/user/{username}&lt;/font&gt;</code><font style="color:rgb(51, 51, 51);"> æ¥é€šè¿‡ç”¨æˆ·å è·å–å…³äºç‰¹å®šç”¨æˆ·çš„æ•°æ®ã€‚</font></p>
<p><font style="color:rgb(51, 51, 51);">ç”±äº</font><em><font style="color:rgb(51, 51, 51);">è·¯å¾„æ“ä½œ</font></em><font style="color:rgb(51, 51, 51);">æ˜¯æŒ‰é¡ºåºä¾æ¬¡è¿è¡Œçš„ï¼Œä½ éœ€è¦ç¡®ä¿è·¯å¾„ </font><code>&lt;font style="color:rgb(51, 51, 51);background-color:rgb(243, 244, 244);"&gt;/user/me&lt;/font&gt;</code><font style="color:rgb(51, 51, 51);"> å£°æ˜åœ¨è·¯å¾„ </font><code>&lt;font style="color:rgb(51, 51, 51);background-color:rgb(243, 244, 244);"&gt;/user/{username}&lt;/font&gt;</code><font style="color:rgb(51, 51, 51);">ä¹‹å‰ï¼š</font></p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Python</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-14-1">1</a></span>
<span class="normal"><a href="#__codelineno-14-2">2</a></span>
<span class="normal"><a href="#__codelineno-14-3">3</a></span>
<span class="normal"><a href="#__codelineno-14-4">4</a></span>
<span class="normal"><a href="#__codelineno-14-5">5</a></span>
<span class="normal"><a href="#__codelineno-14-6">6</a></span>
<span class="normal"><a href="#__codelineno-14-7">7</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-14-1" name="__codelineno-14-1"></a><span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/user/me&quot;</span><span class="p">)</span>
<a id="__codelineno-14-2" name="__codelineno-14-2"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">read_user_me</span><span class="p">():</span>
<a id="__codelineno-14-3" name="__codelineno-14-3"></a>    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;username&quot;</span><span class="p">:</span> <span class="s2">&quot;the current user&quot;</span><span class="p">}</span>
<a id="__codelineno-14-4" name="__codelineno-14-4"></a>
<a id="__codelineno-14-5" name="__codelineno-14-5"></a><span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/user/</span><span class="si">{username}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-14-6" name="__codelineno-14-6"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">read_user</span><span class="p">(</span><span class="n">username</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<a id="__codelineno-14-7" name="__codelineno-14-7"></a>    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;username&quot;</span><span class="p">:</span> <span class="n">username</span><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p><font style="color:rgb(51, 51, 51);">å¦åˆ™ï¼Œ</font><code>&lt;font style="color:rgb(51, 51, 51);background-color:rgb(243, 244, 244);"&gt;/user/{username}&lt;/font&gt;</code><font style="color:rgb(51, 51, 51);"> çš„è·¯å¾„è¿˜å°†ä¸ </font><code>&lt;font style="color:rgb(51, 51, 51);background-color:rgb(243, 244, 244);"&gt;/user/me&lt;/font&gt;</code><font style="color:rgb(51, 51, 51);"> ç›¸åŒ¹é…ï¼Œ"è®¤ä¸º"è‡ªå·±æ­£åœ¨æ¥æ”¶ä¸€ä¸ªå€¼ä¸º </font><code>&lt;font style="color:rgb(51, 51, 51);background-color:rgb(243, 244, 244);"&gt;"me"&lt;/font&gt;</code><font style="color:rgb(51, 51, 51);"> çš„ </font><code>&lt;font style="color:rgb(51, 51, 51);background-color:rgb(243, 244, 244);"&gt;username&lt;/font&gt;</code><font style="color:rgb(51, 51, 51);"> å‚æ•°ã€‚</font></p>
<h3 id="42æŸ¥è¯¢å‚æ•°è¯·æ±‚å‚æ•°"><font style="color:rgb(51, 51, 51);">4.2ã€æŸ¥è¯¢å‚æ•°ï¼ˆè¯·æ±‚å‚æ•°ï¼‰</font><a class="headerlink" href="#42æŸ¥è¯¢å‚æ•°è¯·æ±‚å‚æ•°" title="Permanent link">&para;</a></h3>
<p><font style="color:rgb(51, 51, 51);">è·¯å¾„å‡½æ•°ä¸­å£°æ˜ä¸å±äºè·¯å¾„å‚æ•°çš„å…¶ä»–å‡½æ•°å‚æ•°æ—¶ï¼Œå®ƒä»¬å°†è¢«è‡ªåŠ¨è§£é‡Šä¸º"æŸ¥è¯¢å­—ç¬¦ä¸²"å‚æ•°ï¼Œå°±æ˜¯ url? ä¹‹åç”¨</font><code>&lt;font style="color:rgb(51, 51, 51);background-color:rgb(243, 244, 244);"&gt;&amp;&lt;/font&gt;</code><font style="color:rgb(51, 51, 51);">åˆ†å‰²çš„ key-value é”®å€¼å¯¹ã€‚</font></p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Python</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-15-1">1</a></span>
<span class="normal"><a href="#__codelineno-15-2">2</a></span>
<span class="normal"><a href="#__codelineno-15-3">3</a></span>
<span class="normal"><a href="#__codelineno-15-4">4</a></span>
<span class="normal"><a href="#__codelineno-15-5">5</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-15-1" name="__codelineno-15-1"></a><span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/jobs/</span><span class="si">{kd}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-15-2" name="__codelineno-15-2"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">search_jobs</span><span class="p">(</span><span class="n">kd</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">city</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">xl</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>  <span class="c1"># æœ‰é»˜è®¤å€¼å³å¯é€‰ï¼Œå¦åˆ™å¿…é€‰</span>
<a id="__codelineno-15-3" name="__codelineno-15-3"></a>    <span class="k">if</span> <span class="n">city</span> <span class="ow">or</span> <span class="n">xl</span><span class="p">:</span>
<a id="__codelineno-15-4" name="__codelineno-15-4"></a>        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;kd&quot;</span><span class="p">:</span> <span class="n">kd</span><span class="p">,</span> <span class="s2">&quot;city&quot;</span><span class="p">:</span> <span class="n">city</span><span class="p">,</span> <span class="s2">&quot;xl&quot;</span><span class="p">:</span> <span class="n">xl</span><span class="p">}</span>
<a id="__codelineno-15-5" name="__codelineno-15-5"></a>    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;kd&quot;</span><span class="p">:</span> <span class="n">kd</span><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p><img alt="" src="../../../../images/1721480586637-cb58f6aa-7016-4b10-9e3a-7ea56057004d.png" /></p>
<p><font style="color:rgb(51, 51, 51);">åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œå‡½æ•°å‚æ•° </font><code>&lt;font style="color:rgb(51, 51, 51);background-color:rgb(243, 244, 244);"&gt;city&lt;/font&gt;</code><font style="color:rgb(51, 51, 51);">å’Œ</font><code>&lt;font style="color:rgb(51, 51, 51);background-color:rgb(243, 244, 244);"&gt;xl&lt;/font&gt;</code><font style="color:rgb(51, 51, 51);"> æ˜¯å¯é€‰çš„ï¼Œå¹¶ä¸”é»˜è®¤å€¼ä¸º </font><code>&lt;font style="color:rgb(51, 51, 51);background-color:rgb(243, 244, 244);"&gt;None&lt;/font&gt;</code><font style="color:rgb(51, 51, 51);">ã€‚</font></p>
<p><font style="color:rgb(51, 51, 51);">è‡ªpython3.5å¼€å§‹ï¼ŒPEP484ä¸ºpythonå¼•å…¥äº†ç±»å‹æ³¨è§£(type hints)ï¼Œtypingçš„ä¸»è¦ä½œç”¨æœ‰ï¼š</font></p>
<ol>
<li><font style="color:rgb(119, 119, 119);">ç±»å‹æ£€æŸ¥ï¼Œé˜²æ­¢è¿è¡Œæ—¶å‡ºç°å‚æ•°ã€è¿”å›å€¼ç±»å‹ä¸ç¬¦ã€‚</font></li>
<li><font style="color:rgb(119, 119, 119);">ä½œä¸ºå¼€å‘æ–‡æ¡£é™„åŠ è¯´æ˜ï¼Œæ–¹ä¾¿ä½¿ç”¨è€…è°ƒç”¨æ—¶ä¼ å…¥å’Œè¿”å›å‚æ•°ç±»å‹ã€‚</font></li>
<li><font style="color:rgb(119, 119, 119);">æ¨¡å—åŠ å…¥ä¸ä¼šå½±å“ç¨‹åºçš„è¿è¡Œä¸ä¼šæŠ¥æ­£å¼çš„é”™è¯¯ï¼Œpycharmæ”¯æŒtypingæ£€æŸ¥é”™è¯¯æ—¶ä¼šå‡ºç°é»„è‰²è­¦å‘Šã€‚</font></li>
</ol>
<p><code>&lt;font style="color:rgb(51, 51, 51);background-color:rgb(243, 244, 244);"&gt;type hints&lt;/font&gt;</code><font style="color:rgb(51, 51, 51);">ä¸»è¦æ˜¯è¦æŒ‡ç¤ºå‡½æ•°çš„è¾“å…¥å’Œè¾“å‡ºçš„æ•°æ®ç±»å‹ï¼Œæ•°æ®ç±»å‹åœ¨typing åŒ…ä¸­ï¼ŒåŸºæœ¬ç±»å‹æœ‰str list dictç­‰ç­‰ï¼Œ</font></p>
<p><font style="color:rgb(51, 51, 51);">Union æ˜¯å½“æœ‰å¤šç§å¯èƒ½çš„æ•°æ®ç±»å‹æ—¶ä½¿ç”¨ï¼Œæ¯”å¦‚å‡½æ•°æœ‰å¯èƒ½æ ¹æ®ä¸åŒæƒ…å†µæœ‰æ—¶è¿”å›stræˆ–è¿”å›listï¼Œé‚£ä¹ˆå°±å¯ä»¥å†™æˆUnion[list, str]Optional æ˜¯Unionçš„ä¸€ä¸ªç®€åŒ–ï¼Œ å½“ æ•°æ®ç±»å‹ä¸­æœ‰å¯èƒ½æ˜¯Noneæ—¶ï¼Œæ¯”å¦‚æœ‰å¯èƒ½æ˜¯strä¹Ÿæœ‰å¯èƒ½æ˜¯Noneï¼Œåˆ™Optional[str], ç›¸å½“äºUnion[str, None]</font></p>
<h3 id="43è¯·æ±‚ä½“æ•°æ®"><font style="color:rgb(51, 51, 51);">4.3ã€è¯·æ±‚ä½“æ•°æ®</font><a class="headerlink" href="#43è¯·æ±‚ä½“æ•°æ®" title="Permanent link">&para;</a></h3>
<p><font style="color:rgb(51, 51, 51);">å½“ä½ éœ€è¦å°†æ•°æ®ä»å®¢æˆ·ç«¯ï¼ˆä¾‹å¦‚æµè§ˆå™¨ï¼‰å‘é€ç»™ API æ—¶ï¼Œä½ å°†å…¶ä½œä¸ºã€Œè¯·æ±‚ä½“ã€å‘é€ã€‚</font><strong><font style="color:rgb(51, 51, 51);">è¯·æ±‚</font></strong><font style="color:rgb(51, 51, 51);">ä½“æ˜¯å®¢æˆ·ç«¯å‘é€ç»™ API çš„æ•°æ®ã€‚</font><strong><font style="color:rgb(51, 51, 51);">å“åº”</font></strong><font style="color:rgb(51, 51, 51);">ä½“æ˜¯ API å‘é€ç»™å®¢æˆ·ç«¯çš„æ•°æ®ã€‚</font></p>
<p><font style="color:rgb(51, 51, 51);">FastAPI åŸºäº </font><code>&lt;font style="color:rgb(51, 51, 51);background-color:rgb(243, 244, 244);"&gt;Pydantic&lt;/font&gt;</code><font style="color:rgb(51, 51, 51);"> ï¼Œ</font><code>&lt;font style="color:rgb(51, 51, 51);background-color:rgb(243, 244, 244);"&gt;Pydantic&lt;/font&gt;</code><font style="color:rgb(51, 51, 51);"> ä¸»è¦ç”¨æ¥åšç±»å‹å¼ºåˆ¶æ£€æŸ¥ï¼ˆæ ¡éªŒæ•°æ®ï¼‰ã€‚ä¸ç¬¦åˆç±»å‹è¦æ±‚å°±ä¼šæŠ›å‡ºå¼‚å¸¸ã€‚</font></p>
<p><font style="color:rgb(51, 51, 51);">å¯¹äº API æœåŠ¡ï¼Œæ”¯æŒç±»å‹æ£€æŸ¥éå¸¸æœ‰ç”¨ï¼Œä¼šè®©æœåŠ¡æ›´åŠ å¥å£®ï¼Œä¹Ÿä¼šåŠ å¿«å¼€å‘é€Ÿåº¦ï¼Œå› ä¸ºå¼€å‘è€…å†ä¹Ÿä¸ç”¨è‡ªå·±å†™ä¸€è¡Œä¸€è¡Œçš„åšç±»å‹æ£€æŸ¥ã€‚</font></p>
<p><font style="color:rgb(51, 51, 51);">å®‰è£…ä¸Šæ‰‹</font><code>&lt;font style="color:rgb(51, 51, 51);background-color:rgb(243, 244, 244);"&gt;pip install pydantic&lt;/font&gt;</code></p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Python</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-16-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-16-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-16-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-16-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-16-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-16-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-16-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-16-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-16-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-16-10">10</a></span>
<span class="normal"><a href="#__codelineno-16-11">11</a></span>
<span class="normal"><a href="#__codelineno-16-12">12</a></span>
<span class="normal"><a href="#__codelineno-16-13">13</a></span>
<span class="normal"><a href="#__codelineno-16-14">14</a></span>
<span class="normal"><a href="#__codelineno-16-15">15</a></span>
<span class="normal"><a href="#__codelineno-16-16">16</a></span>
<span class="normal"><a href="#__codelineno-16-17">17</a></span>
<span class="normal"><a href="#__codelineno-16-18">18</a></span>
<span class="normal"><a href="#__codelineno-16-19">19</a></span>
<span class="normal"><a href="#__codelineno-16-20">20</a></span>
<span class="normal"><a href="#__codelineno-16-21">21</a></span>
<span class="normal"><a href="#__codelineno-16-22">22</a></span>
<span class="normal"><a href="#__codelineno-16-23">23</a></span>
<span class="normal"><a href="#__codelineno-16-24">24</a></span>
<span class="normal"><a href="#__codelineno-16-25">25</a></span>
<span class="normal"><a href="#__codelineno-16-26">26</a></span>
<span class="normal"><a href="#__codelineno-16-27">27</a></span>
<span class="normal"><a href="#__codelineno-16-28">28</a></span>
<span class="normal"><a href="#__codelineno-16-29">29</a></span>
<span class="normal"><a href="#__codelineno-16-30">30</a></span>
<span class="normal"><a href="#__codelineno-16-31">31</a></span>
<span class="normal"><a href="#__codelineno-16-32">32</a></span>
<span class="normal"><a href="#__codelineno-16-33">33</a></span>
<span class="normal"><a href="#__codelineno-16-34">34</a></span>
<span class="normal"><a href="#__codelineno-16-35">35</a></span>
<span class="normal"><a href="#__codelineno-16-36">36</a></span>
<span class="normal"><a href="#__codelineno-16-37">37</a></span>
<span class="normal"><a href="#__codelineno-16-38">38</a></span>
<span class="normal"><a href="#__codelineno-16-39">39</a></span>
<span class="normal"><a href="#__codelineno-16-40">40</a></span>
<span class="normal"><a href="#__codelineno-16-41">41</a></span>
<span class="normal"><a href="#__codelineno-16-42">42</a></span>
<span class="normal"><a href="#__codelineno-16-43">43</a></span>
<span class="normal"><a href="#__codelineno-16-44">44</a></span>
<span class="normal"><a href="#__codelineno-16-45">45</a></span>
<span class="normal"><a href="#__codelineno-16-46">46</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-16-1" name="__codelineno-16-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Union</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span>
<a id="__codelineno-16-2" name="__codelineno-16-2"></a>
<a id="__codelineno-16-3" name="__codelineno-16-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">fastapi</span><span class="w"> </span><span class="kn">import</span> <span class="n">FastAPI</span>
<a id="__codelineno-16-4" name="__codelineno-16-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">pydantic</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseModel</span><span class="p">,</span> <span class="n">Field</span><span class="p">,</span> <span class="n">ValidationError</span><span class="p">,</span> <span class="n">validator</span>
<a id="__codelineno-16-5" name="__codelineno-16-5"></a><span class="kn">import</span><span class="w"> </span><span class="nn">uvicorn</span>
<a id="__codelineno-16-6" name="__codelineno-16-6"></a><span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">date</span>
<a id="__codelineno-16-7" name="__codelineno-16-7"></a>
<a id="__codelineno-16-8" name="__codelineno-16-8"></a>
<a id="__codelineno-16-9" name="__codelineno-16-9"></a><span class="k">class</span><span class="w"> </span><span class="nc">Addr</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
<a id="__codelineno-16-10" name="__codelineno-16-10"></a>    <span class="n">province</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-16-11" name="__codelineno-16-11"></a>    <span class="n">city</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-16-12" name="__codelineno-16-12"></a>
<a id="__codelineno-16-13" name="__codelineno-16-13"></a>
<a id="__codelineno-16-14" name="__codelineno-16-14"></a><span class="k">class</span><span class="w"> </span><span class="nc">User</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
<a id="__codelineno-16-15" name="__codelineno-16-15"></a>    <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;root&#39;</span>
<a id="__codelineno-16-16" name="__codelineno-16-16"></a>    <span class="n">age</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">lt</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">gt</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-16-17" name="__codelineno-16-17"></a>    <span class="n">birth</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">date</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-16-18" name="__codelineno-16-18"></a>    <span class="n">friends</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-16-19" name="__codelineno-16-19"></a>    <span class="n">description</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-16-20" name="__codelineno-16-20"></a>
<a id="__codelineno-16-21" name="__codelineno-16-21"></a>    <span class="c1"># addr: Union[Addr, None] = None  # ç±»å‹åµŒå¥—</span>
<a id="__codelineno-16-22" name="__codelineno-16-22"></a>
<a id="__codelineno-16-23" name="__codelineno-16-23"></a>    <span class="nd">@validator</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">)</span>
<a id="__codelineno-16-24" name="__codelineno-16-24"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">name_must_alpha</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
<a id="__codelineno-16-25" name="__codelineno-16-25"></a>        <span class="k">assert</span> <span class="n">v</span><span class="o">.</span><span class="n">isalpha</span><span class="p">(),</span> <span class="s1">&#39;name must be alpha&#39;</span>
<a id="__codelineno-16-26" name="__codelineno-16-26"></a>        <span class="k">return</span> <span class="n">v</span>
<a id="__codelineno-16-27" name="__codelineno-16-27"></a>
<a id="__codelineno-16-28" name="__codelineno-16-28"></a>
<a id="__codelineno-16-29" name="__codelineno-16-29"></a><span class="k">class</span><span class="w"> </span><span class="nc">Data</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>  <span class="c1"># ç±»å‹åµŒå¥—</span>
<a id="__codelineno-16-30" name="__codelineno-16-30"></a>    <span class="n">users</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">User</span><span class="p">]</span>
<a id="__codelineno-16-31" name="__codelineno-16-31"></a>
<a id="__codelineno-16-32" name="__codelineno-16-32"></a>
<a id="__codelineno-16-33" name="__codelineno-16-33"></a><span class="n">app</span> <span class="o">=</span> <span class="n">FastAPI</span><span class="p">()</span>
<a id="__codelineno-16-34" name="__codelineno-16-34"></a>
<a id="__codelineno-16-35" name="__codelineno-16-35"></a>
<a id="__codelineno-16-36" name="__codelineno-16-36"></a><span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/data/&quot;</span><span class="p">)</span>
<a id="__codelineno-16-37" name="__codelineno-16-37"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">create_data</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="n">Data</span><span class="p">):</span>
<a id="__codelineno-16-38" name="__codelineno-16-38"></a>    <span class="c1"># æ·»åŠ æ•°æ®åº“</span>
<a id="__codelineno-16-39" name="__codelineno-16-39"></a>    <span class="k">return</span> <span class="n">data</span>
<a id="__codelineno-16-40" name="__codelineno-16-40"></a>
<a id="__codelineno-16-41" name="__codelineno-16-41"></a>
<a id="__codelineno-16-42" name="__codelineno-16-42"></a><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
<a id="__codelineno-16-43" name="__codelineno-16-43"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-16-44" name="__codelineno-16-44"></a>        <span class="n">User</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span><span class="o">...</span><span class="p">)</span>
<a id="__codelineno-16-45" name="__codelineno-16-45"></a>    <span class="k">except</span> <span class="n">ValidationError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-16-46" name="__codelineno-16-46"></a>        <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">json</span><span class="p">())</span>
</code></pre></div></td></tr></table></div>
<p><font style="color:rgb(51, 51, 51);">æµ‹è¯•ï¼š</font></p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Python</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-17-1">1</a></span>
<span class="normal"><a href="#__codelineno-17-2">2</a></span>
<span class="normal"><a href="#__codelineno-17-3">3</a></span>
<span class="normal"><a href="#__codelineno-17-4">4</a></span>
<span class="normal"><a href="#__codelineno-17-5">5</a></span>
<span class="normal"><a href="#__codelineno-17-6">6</a></span>
<span class="normal"><a href="#__codelineno-17-7">7</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-17-1" name="__codelineno-17-1"></a><span class="p">{</span>
<a id="__codelineno-17-2" name="__codelineno-17-2"></a>  <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;rain&quot;</span><span class="p">,</span>
<a id="__codelineno-17-3" name="__codelineno-17-3"></a>  <span class="s2">&quot;age&quot;</span><span class="p">:</span> <span class="mi">32</span><span class="p">,</span>
<a id="__codelineno-17-4" name="__codelineno-17-4"></a>  <span class="s2">&quot;birth&quot;</span><span class="p">:</span> <span class="s2">&quot;2022-09-29&quot;</span><span class="p">,</span>
<a id="__codelineno-17-5" name="__codelineno-17-5"></a>  <span class="s2">&quot;friends&quot;</span><span class="p">:</span> <span class="p">[],</span>
<a id="__codelineno-17-6" name="__codelineno-17-6"></a>  <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;æœ€å¸…çš„è®²fastapiçš„è€å¸ˆ&quot;</span>
<a id="__codelineno-17-7" name="__codelineno-17-7"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p><font style="color:rgb(51, 51, 51);">å’Œå£°æ˜æŸ¥è¯¢å‚æ•°æ—¶ä¸€æ ·ï¼Œå½“ä¸€ä¸ªæ¨¡å‹å±æ€§å…·æœ‰é»˜è®¤å€¼æ—¶ï¼Œå®ƒä¸æ˜¯å¿…éœ€çš„ã€‚å¦åˆ™å®ƒæ˜¯ä¸€ä¸ªå¿…éœ€å±æ€§ã€‚å°†é»˜è®¤å€¼è®¾ä¸º </font><code>&lt;font style="color:rgb(51, 51, 51);background-color:rgb(243, 244, 244);"&gt;None&lt;/font&gt;</code><font style="color:rgb(51, 51, 51);"> å¯ä½¿å…¶æˆä¸ºå¯é€‰å±æ€§ã€‚</font></p>
<p><font style="color:rgb(51, 51, 51);">FastAPI ä¼šè‡ªåŠ¨å°†å®šä¹‰çš„æ¨¡å‹ç±»è½¬åŒ–ä¸º</font><code>&lt;font style="color:rgb(51, 51, 51);background-color:rgb(243, 244, 244);"&gt;JSON Schema&lt;/font&gt;</code><font style="color:rgb(51, 51, 51);">ï¼ŒSchema æˆä¸º OpenAPI ç”Ÿæˆæ¨¡å¼çš„ä¸€éƒ¨åˆ†ï¼Œå¹¶æ˜¾ç¤ºåœ¨ API äº¤äº’æ–‡æ¡£ä¸­ï¼ŒæŸ¥çœ‹ API äº¤äº’æ–‡æ¡£å¦‚ä¸‹ï¼Œè¯¥æ¥å£å°†æ¥æ”¶</font><code>&lt;font style="color:rgb(51, 51, 51);background-color:rgb(243, 244, 244);"&gt;application/json&lt;/font&gt;</code><font style="color:rgb(51, 51, 51);">ç±»å‹çš„å‚æ•°ã€‚</font></p>
<p><font style="color:rgb(51, 51, 51);">FastAPI æ”¯æŒåŒæ—¶å®šä¹‰ Path å‚æ•°ã€Query å‚æ•°å’Œè¯·æ±‚ä½“å‚æ•°ï¼ŒFastAPI å°†ä¼šæ­£ç¡®è¯†åˆ«å¹¶è·å–æ•°æ®ã€‚</font></p>
<p><font style="color:rgb(119, 119, 119);">å‚æ•°åœ¨ url ä¸­ä¹Ÿå£°æ˜äº†ï¼Œå®ƒå°†è¢«è§£é‡Šä¸º path å‚æ•°</font></p>
<p><font style="color:rgb(119, 119, 119);">å‚æ•°æ˜¯å•ä¸€ç±»å‹ï¼ˆä¾‹å¦‚intã€floatã€strã€boolç­‰ï¼‰ï¼Œå®ƒå°†è¢«è§£é‡Šä¸º query å‚æ•°</font></p>
<p><font style="color:rgb(119, 119, 119);">å‚æ•°ç±»å‹ä¸ºç»§æ‰¿ Pydantic æ¨¡å—çš„</font><code>&lt;font style="color:rgb(119, 119, 119);background-color:rgb(243, 244, 244);"&gt;BaseModel&lt;/font&gt;</code><font style="color:rgb(119, 119, 119);">ç±»çš„æ•°æ®æ¨¡å‹ç±»ï¼Œåˆ™å®ƒå°†è¢«è§£é‡Šä¸ºè¯·æ±‚ä½“å‚æ•°</font></p>
<h3 id="44formè¡¨å•æ•°æ®"><font style="color:rgb(51, 51, 51);">4.4ã€formè¡¨å•æ•°æ®</font><a class="headerlink" href="#44formè¡¨å•æ•°æ®" title="Permanent link">&para;</a></h3>
<p><font style="color:rgb(51, 51, 51);">åœ¨ OAuth2 è§„èŒƒçš„ä¸€ç§ä½¿ç”¨æ–¹å¼ï¼ˆå¯†ç æµï¼‰ä¸­ï¼Œéœ€è¦å°†ç”¨æˆ·åã€å¯†ç ä½œä¸ºè¡¨å•å­—æ®µå‘é€ï¼Œè€Œä¸æ˜¯ JSONã€‚</font></p>
<p><font style="color:rgb(51, 51, 51);">FastAPI å¯ä»¥ä½¿ç”¨</font><strong><font style="color:rgb(51, 51, 51);">Form</font></strong><font style="color:rgb(51, 51, 51);">ç»„ä»¶æ¥æ¥æ”¶è¡¨å•æ•°æ®ï¼Œéœ€è¦å…ˆä½¿ç”¨</font><code>&lt;font style="color:rgb(51, 51, 51);background-color:rgb(243, 244, 244);"&gt;pip install python-multipart&lt;/font&gt;</code><font style="color:rgb(51, 51, 51);">å‘½ä»¤è¿›è¡Œå®‰è£…ã€‚</font></p>
<p><font style="color:rgb(119, 119, 119);">pip install python-multipart</font></p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Python</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-18-1">1</a></span>
<span class="normal"><a href="#__codelineno-18-2">2</a></span>
<span class="normal"><a href="#__codelineno-18-3">3</a></span>
<span class="normal"><a href="#__codelineno-18-4">4</a></span>
<span class="normal"><a href="#__codelineno-18-5">5</a></span>
<span class="normal"><a href="#__codelineno-18-6">6</a></span>
<span class="normal"><a href="#__codelineno-18-7">7</a></span>
<span class="normal"><a href="#__codelineno-18-8">8</a></span>
<span class="normal"><a href="#__codelineno-18-9">9</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-18-1" name="__codelineno-18-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">fastapi</span><span class="w"> </span><span class="kn">import</span> <span class="n">FastAPI</span><span class="p">,</span> <span class="n">Form</span>
<a id="__codelineno-18-2" name="__codelineno-18-2"></a>
<a id="__codelineno-18-3" name="__codelineno-18-3"></a><span class="n">app</span> <span class="o">=</span> <span class="n">FastAPI</span><span class="p">()</span>
<a id="__codelineno-18-4" name="__codelineno-18-4"></a>
<a id="__codelineno-18-5" name="__codelineno-18-5"></a><span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/regin&quot;</span><span class="p">)</span>
<a id="__codelineno-18-6" name="__codelineno-18-6"></a><span class="k">def</span><span class="w"> </span><span class="nf">regin</span><span class="p">(</span><span class="n">username</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Form</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">max_length</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">min_length</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">regex</span><span class="o">=</span><span class="s1">&#39;[a-zA-Z]&#39;</span><span class="p">),</span>
<a id="__codelineno-18-7" name="__codelineno-18-7"></a>          <span class="n">password</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Form</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">max_length</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">min_length</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">regex</span><span class="o">=</span><span class="s1">&#39;[0-9]&#39;</span><span class="p">)):</span>
<a id="__codelineno-18-8" name="__codelineno-18-8"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;username:</span><span class="si">{</span><span class="n">username</span><span class="si">}</span><span class="s2">,password:</span><span class="si">{</span><span class="n">password</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-18-9" name="__codelineno-18-9"></a>    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;username&quot;</span><span class="p">:</span> <span class="n">username</span><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p><font style="color:rgb(51, 51, 51);"><br />
</font><font style="color:rgb(51, 51, 51);"> </font><img alt="" src="../../../../images/1721480613252-14282974-544b-454d-865d-88634b609122.png" /></p>
<h3 id="45æ–‡ä»¶ä¸Šä¼ "><font style="color:rgb(51, 51, 51);">4.5ã€æ–‡ä»¶ä¸Šä¼ </font><a class="headerlink" href="#45æ–‡ä»¶ä¸Šä¼ " title="Permanent link">&para;</a></h3>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Python</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-19-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-19-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-19-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-19-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-19-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-19-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-19-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-19-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-19-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-19-10">10</a></span>
<span class="normal"><a href="#__codelineno-19-11">11</a></span>
<span class="normal"><a href="#__codelineno-19-12">12</a></span>
<span class="normal"><a href="#__codelineno-19-13">13</a></span>
<span class="normal"><a href="#__codelineno-19-14">14</a></span>
<span class="normal"><a href="#__codelineno-19-15">15</a></span>
<span class="normal"><a href="#__codelineno-19-16">16</a></span>
<span class="normal"><a href="#__codelineno-19-17">17</a></span>
<span class="normal"><a href="#__codelineno-19-18">18</a></span>
<span class="normal"><a href="#__codelineno-19-19">19</a></span>
<span class="normal"><a href="#__codelineno-19-20">20</a></span>
<span class="normal"><a href="#__codelineno-19-21">21</a></span>
<span class="normal"><a href="#__codelineno-19-22">22</a></span>
<span class="normal"><a href="#__codelineno-19-23">23</a></span>
<span class="normal"><a href="#__codelineno-19-24">24</a></span>
<span class="normal"><a href="#__codelineno-19-25">25</a></span>
<span class="normal"><a href="#__codelineno-19-26">26</a></span>
<span class="normal"><a href="#__codelineno-19-27">27</a></span>
<span class="normal"><a href="#__codelineno-19-28">28</a></span>
<span class="normal"><a href="#__codelineno-19-29">29</a></span>
<span class="normal"><a href="#__codelineno-19-30">30</a></span>
<span class="normal"><a href="#__codelineno-19-31">31</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-19-1" name="__codelineno-19-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">fastapi</span><span class="w"> </span><span class="kn">import</span> <span class="n">FastAPI</span><span class="p">,</span> <span class="n">File</span><span class="p">,</span> <span class="n">UploadFile</span>
<a id="__codelineno-19-2" name="__codelineno-19-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">List</span>
<a id="__codelineno-19-3" name="__codelineno-19-3"></a>
<a id="__codelineno-19-4" name="__codelineno-19-4"></a><span class="n">app</span> <span class="o">=</span> <span class="n">FastAPI</span><span class="p">()</span>
<a id="__codelineno-19-5" name="__codelineno-19-5"></a>
<a id="__codelineno-19-6" name="__codelineno-19-6"></a><span class="c1"># file: bytes = File()ï¼šé€‚åˆå°æ–‡ä»¶ä¸Šä¼ </span>
<a id="__codelineno-19-7" name="__codelineno-19-7"></a><span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/files/&quot;</span><span class="p">)</span>
<a id="__codelineno-19-8" name="__codelineno-19-8"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">create_file</span><span class="p">(</span><span class="n">file</span><span class="p">:</span> <span class="nb">bytes</span> <span class="o">=</span> <span class="n">File</span><span class="p">()):</span>
<a id="__codelineno-19-9" name="__codelineno-19-9"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;file:&quot;</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span>
<a id="__codelineno-19-10" name="__codelineno-19-10"></a>    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;file_size&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">file</span><span class="p">)}</span>
<a id="__codelineno-19-11" name="__codelineno-19-11"></a>
<a id="__codelineno-19-12" name="__codelineno-19-12"></a>
<a id="__codelineno-19-13" name="__codelineno-19-13"></a><span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/multiFiles/&quot;</span><span class="p">)</span>
<a id="__codelineno-19-14" name="__codelineno-19-14"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">create_files</span><span class="p">(</span><span class="n">files</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">bytes</span><span class="p">]</span> <span class="o">=</span> <span class="n">File</span><span class="p">()):</span>
<a id="__codelineno-19-15" name="__codelineno-19-15"></a>    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;file_sizes&quot;</span><span class="p">:</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">file</span><span class="p">)</span> <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">files</span><span class="p">]}</span>
<a id="__codelineno-19-16" name="__codelineno-19-16"></a>
<a id="__codelineno-19-17" name="__codelineno-19-17"></a>
<a id="__codelineno-19-18" name="__codelineno-19-18"></a><span class="c1"># file: UploadFileï¼šé€‚åˆå¤§æ–‡ä»¶ä¸Šä¼ </span>
<a id="__codelineno-19-19" name="__codelineno-19-19"></a>
<a id="__codelineno-19-20" name="__codelineno-19-20"></a><span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/uploadFile/&quot;</span><span class="p">)</span>
<a id="__codelineno-19-21" name="__codelineno-19-21"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">create_upload_file</span><span class="p">(</span><span class="n">file</span><span class="p">:</span> <span class="n">UploadFile</span><span class="p">):</span>
<a id="__codelineno-19-22" name="__codelineno-19-22"></a>    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">file</span><span class="o">.</span><span class="n">filename</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
<a id="__codelineno-19-23" name="__codelineno-19-23"></a>        <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="nb">iter</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">file</span><span class="o">.</span><span class="n">file</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">1024</span><span class="p">),</span> <span class="sa">b</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
<a id="__codelineno-19-24" name="__codelineno-19-24"></a>            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>
<a id="__codelineno-19-25" name="__codelineno-19-25"></a>
<a id="__codelineno-19-26" name="__codelineno-19-26"></a>    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;filename&quot;</span><span class="p">:</span> <span class="n">file</span><span class="o">.</span><span class="n">filename</span><span class="p">}</span>
<a id="__codelineno-19-27" name="__codelineno-19-27"></a>
<a id="__codelineno-19-28" name="__codelineno-19-28"></a>
<a id="__codelineno-19-29" name="__codelineno-19-29"></a><span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/multiUploadFiles/&quot;</span><span class="p">)</span>
<a id="__codelineno-19-30" name="__codelineno-19-30"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">create_upload_files</span><span class="p">(</span><span class="n">files</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">UploadFile</span><span class="p">]):</span>
<a id="__codelineno-19-31" name="__codelineno-19-31"></a>    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;filenames&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">file</span><span class="o">.</span><span class="n">filename</span> <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">files</span><span class="p">]}</span>
</code></pre></div></td></tr></table></div>
<h3 id="46reqeustå¯¹è±¡"><font style="color:rgb(51, 51, 51);">4.6ã€Reqeustå¯¹è±¡</font><a class="headerlink" href="#46reqeustå¯¹è±¡" title="Permanent link">&para;</a></h3>
<p><font style="color:rgb(51, 51, 51);">æœ‰äº›æƒ…å†µä¸‹æˆ‘ä»¬å¸Œæœ›èƒ½ç›´æ¥è®¿é—®</font><em><font style="color:rgb(51, 51, 51);">Request</font></em><font style="color:rgb(51, 51, 51);">å¯¹è±¡ã€‚ä¾‹å¦‚æˆ‘ä»¬åœ¨è·¯å¾„æ“ä½œå‡½æ•°ä¸­æƒ³è·å–å®¢æˆ·ç«¯çš„IPåœ°å€ï¼Œéœ€è¦åœ¨å‡½æ•°ä¸­å£°æ˜</font><strong><font style="color:rgb(51, 51, 51);">Request</font></strong><font style="color:rgb(51, 51, 51);">ç±»å‹çš„å‚æ•°ï¼ŒFastAPI å°±ä¼šè‡ªåŠ¨ä¼ é€’ Request å¯¹è±¡ç»™è¿™ä¸ªå‚æ•°ï¼Œæˆ‘ä»¬å°±å¯ä»¥è·å–åˆ° Request å¯¹è±¡åŠå…¶å±æ€§ä¿¡æ¯ï¼Œä¾‹å¦‚ headerã€urlã€cookieã€session ç­‰ã€‚</font></p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Python</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-20-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-20-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-20-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-20-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-20-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-20-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-20-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-20-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-20-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-20-10">10</a></span>
<span class="normal"><a href="#__codelineno-20-11">11</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-20-1" name="__codelineno-20-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">fastapi</span><span class="w"> </span><span class="kn">import</span> <span class="n">Request</span>
<a id="__codelineno-20-2" name="__codelineno-20-2"></a>
<a id="__codelineno-20-3" name="__codelineno-20-3"></a>
<a id="__codelineno-20-4" name="__codelineno-20-4"></a><span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/items&quot;</span><span class="p">)</span>
<a id="__codelineno-20-5" name="__codelineno-20-5"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">items</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">):</span>
<a id="__codelineno-20-6" name="__codelineno-20-6"></a>    <span class="k">return</span> <span class="p">{</span>
<a id="__codelineno-20-7" name="__codelineno-20-7"></a>        <span class="s2">&quot;è¯·æ±‚URLï¼š&quot;</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">url</span><span class="p">,</span>
<a id="__codelineno-20-8" name="__codelineno-20-8"></a>        <span class="s2">&quot;è¯·æ±‚ipï¼š&quot;</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">host</span><span class="p">,</span>
<a id="__codelineno-20-9" name="__codelineno-20-9"></a>        <span class="s2">&quot;è¯·æ±‚å®¿ä¸»ï¼š&quot;</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;user-agent&quot;</span><span class="p">),</span>
<a id="__codelineno-20-10" name="__codelineno-20-10"></a>        <span class="s2">&quot;cookies&quot;</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">cookies</span><span class="p">,</span>
<a id="__codelineno-20-11" name="__codelineno-20-11"></a>    <span class="p">}</span>
</code></pre></div></td></tr></table></div>
<h3 id="47è¯·æ±‚é™æ€æ–‡ä»¶"><font style="color:rgb(51, 51, 51);">4.7ã€è¯·æ±‚é™æ€æ–‡ä»¶</font><a class="headerlink" href="#47è¯·æ±‚é™æ€æ–‡ä»¶" title="Permanent link">&para;</a></h3>
<p><font style="color:rgb(51, 51, 51);">åœ¨ Web å¼€å‘ä¸­ï¼Œéœ€è¦è¯·æ±‚å¾ˆå¤šé™æ€èµ„æºæ–‡ä»¶ï¼ˆä¸æ˜¯ç”±æœåŠ¡å™¨ç”Ÿæˆçš„æ–‡ä»¶ï¼‰ï¼Œå¦‚ css/js å’Œå›¾ç‰‡æ–‡ä»¶ç­‰ã€‚</font></p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Python</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-21-1">1</a></span>
<span class="normal"><a href="#__codelineno-21-2">2</a></span>
<span class="normal"><a href="#__codelineno-21-3">3</a></span>
<span class="normal"><a href="#__codelineno-21-4">4</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-21-1" name="__codelineno-21-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">fastapi.staticfiles</span><span class="w"> </span><span class="kn">import</span> <span class="n">StaticFiles</span>
<a id="__codelineno-21-2" name="__codelineno-21-2"></a>
<a id="__codelineno-21-3" name="__codelineno-21-3"></a><span class="n">app</span> <span class="o">=</span> <span class="n">FastAPI</span><span class="p">()</span>
<a id="__codelineno-21-4" name="__codelineno-21-4"></a><span class="n">app</span><span class="o">.</span><span class="n">mount</span><span class="p">(</span><span class="s2">&quot;/static&quot;</span><span class="p">,</span><span class="n">StaticFiles</span><span class="p">(</span><span class="n">directory</span><span class="o">=</span><span class="s2">&quot;static&quot;</span><span class="p">))</span>
</code></pre></div></td></tr></table></div>
<h3 id="48å“åº”æ¨¡å‹ç›¸å…³å‚æ•°"><font style="color:rgb(51, 51, 51);">4.8ã€å“åº”æ¨¡å‹ç›¸å…³å‚æ•°</font><a class="headerlink" href="#48å“åº”æ¨¡å‹ç›¸å…³å‚æ•°" title="Permanent link">&para;</a></h3>
<h4 id="1response_model"><font style="color:rgb(51, 51, 51);">ï¼ˆ1ï¼‰response_model</font><a class="headerlink" href="#1response_model" title="Permanent link">&para;</a></h4>
<p><font style="color:rgb(51, 51, 51);">å‰é¢å†™çš„è¿™ä¹ˆå¤šè·¯å¾„å‡½æ•°æœ€ç»ˆ return çš„éƒ½æ˜¯è‡ªå®šä¹‰ç»“æ„çš„å­—å…¸ï¼ŒFastAPI æä¾›äº† response_model å‚æ•°ï¼Œå£°æ˜ return å“åº”ä½“çš„æ¨¡å‹</font></p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Python</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-22-1">1</a></span>
<span class="normal"><a href="#__codelineno-22-2">2</a></span>
<span class="normal"><a href="#__codelineno-22-3">3</a></span>
<span class="normal"><a href="#__codelineno-22-4">4</a></span>
<span class="normal"><a href="#__codelineno-22-5">5</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-22-1" name="__codelineno-22-1"></a><span class="c1"># è·¯å¾„æ“ä½œ</span>
<a id="__codelineno-22-2" name="__codelineno-22-2"></a><span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/items/&quot;</span><span class="p">,</span> <span class="n">response_model</span><span class="o">=</span><span class="n">Item</span><span class="p">)</span>
<a id="__codelineno-22-3" name="__codelineno-22-3"></a><span class="c1"># è·¯å¾„å‡½æ•°</span>
<a id="__codelineno-22-4" name="__codelineno-22-4"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">create_item</span><span class="p">(</span><span class="n">item</span><span class="p">:</span> <span class="n">Item</span><span class="p">):</span>
<a id="__codelineno-22-5" name="__codelineno-22-5"></a>    <span class="o">...</span>
</code></pre></div></td></tr></table></div>
<p><font style="color:rgb(119, 119, 119);">response_model æ˜¯è·¯å¾„æ“ä½œçš„å‚æ•°ï¼Œå¹¶ä¸æ˜¯è·¯å¾„å‡½æ•°çš„å‚æ•°å“¦</font></p>
<p><font style="color:rgb(51, 51, 51);">FastAPIå°†ä½¿ç”¨</font><code>&lt;font style="color:rgb(51, 51, 51);background-color:rgb(243, 244, 244);"&gt;response_model&lt;/font&gt;</code><font style="color:rgb(51, 51, 51);">è¿›è¡Œä»¥ä¸‹æ“ä½œï¼š</font></p>
<ul>
<li><font style="color:rgb(51, 51, 51);">å°†è¾“å‡ºæ•°æ®è½¬æ¢ä¸ºresponse_modelä¸­å£°æ˜çš„æ•°æ®ç±»å‹ã€‚</font></li>
<li><font style="color:rgb(51, 51, 51);">éªŒè¯æ•°æ®ç»“æ„å’Œç±»å‹</font></li>
<li><font style="color:rgb(51, 51, 51);">å°†è¾“å‡ºæ•°æ®é™åˆ¶ä¸ºè¯¥modelå®šä¹‰çš„</font></li>
<li><font style="color:rgb(51, 51, 51);">æ·»åŠ åˆ°OpenAPIä¸­</font></li>
<li><font style="color:rgb(51, 51, 51);">åœ¨è‡ªåŠ¨æ–‡æ¡£ç³»ç»Ÿä¸­ä½¿ç”¨ã€‚</font></li>
</ul>
<p><font style="color:rgb(51, 51, 51);">ä½ å¯ä»¥åœ¨ä»»æ„çš„è·¯å¾„æ“ä½œä¸­ä½¿ç”¨ </font><code>&lt;font style="color:rgb(51, 51, 51);background-color:rgb(243, 244, 244);"&gt;response_model&lt;/font&gt;</code><font style="color:rgb(51, 51, 51);"> å‚æ•°æ¥å£°æ˜ç”¨äºå“åº”çš„æ¨¡å‹</font></p>
<p><font style="color:rgb(51, 51, 51);">æ¡ˆä¾‹ï¼š</font></p>
<ul>
<li><font style="color:rgb(51, 51, 51);">æ³¨å†ŒåŠŸèƒ½</font></li>
<li><font style="color:rgb(51, 51, 51);">è¾“å…¥è´¦å·ã€å¯†ç ã€æ˜µç§°ã€é‚®ç®±ï¼Œæ³¨å†ŒæˆåŠŸåè¿”å›ä¸ªäººä¿¡æ¯</font></li>
</ul>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Python</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-23-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-23-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-23-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-23-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-23-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-23-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-23-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-23-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-23-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-23-10">10</a></span>
<span class="normal"><a href="#__codelineno-23-11">11</a></span>
<span class="normal"><a href="#__codelineno-23-12">12</a></span>
<span class="normal"><a href="#__codelineno-23-13">13</a></span>
<span class="normal"><a href="#__codelineno-23-14">14</a></span>
<span class="normal"><a href="#__codelineno-23-15">15</a></span>
<span class="normal"><a href="#__codelineno-23-16">16</a></span>
<span class="normal"><a href="#__codelineno-23-17">17</a></span>
<span class="normal"><a href="#__codelineno-23-18">18</a></span>
<span class="normal"><a href="#__codelineno-23-19">19</a></span>
<span class="normal"><a href="#__codelineno-23-20">20</a></span>
<span class="normal"><a href="#__codelineno-23-21">21</a></span>
<span class="normal"><a href="#__codelineno-23-22">22</a></span>
<span class="normal"><a href="#__codelineno-23-23">23</a></span>
<span class="normal"><a href="#__codelineno-23-24">24</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-23-1" name="__codelineno-23-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Union</span>
<a id="__codelineno-23-2" name="__codelineno-23-2"></a>
<a id="__codelineno-23-3" name="__codelineno-23-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">fastapi</span><span class="w"> </span><span class="kn">import</span> <span class="n">FastAPI</span>
<a id="__codelineno-23-4" name="__codelineno-23-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">pydantic</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseModel</span><span class="p">,</span> <span class="n">EmailStr</span>
<a id="__codelineno-23-5" name="__codelineno-23-5"></a>
<a id="__codelineno-23-6" name="__codelineno-23-6"></a><span class="n">app</span> <span class="o">=</span> <span class="n">FastAPI</span><span class="p">()</span>
<a id="__codelineno-23-7" name="__codelineno-23-7"></a>
<a id="__codelineno-23-8" name="__codelineno-23-8"></a>
<a id="__codelineno-23-9" name="__codelineno-23-9"></a><span class="k">class</span><span class="w"> </span><span class="nc">UserIn</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
<a id="__codelineno-23-10" name="__codelineno-23-10"></a>    <span class="n">username</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-23-11" name="__codelineno-23-11"></a>    <span class="n">password</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-23-12" name="__codelineno-23-12"></a>    <span class="n">email</span><span class="p">:</span> <span class="n">EmailStr</span>
<a id="__codelineno-23-13" name="__codelineno-23-13"></a>    <span class="n">full_name</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-23-14" name="__codelineno-23-14"></a>
<a id="__codelineno-23-15" name="__codelineno-23-15"></a>
<a id="__codelineno-23-16" name="__codelineno-23-16"></a><span class="k">class</span><span class="w"> </span><span class="nc">UserOut</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
<a id="__codelineno-23-17" name="__codelineno-23-17"></a>    <span class="n">username</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-23-18" name="__codelineno-23-18"></a>    <span class="n">email</span><span class="p">:</span> <span class="n">EmailStr</span>
<a id="__codelineno-23-19" name="__codelineno-23-19"></a>    <span class="n">full_name</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-23-20" name="__codelineno-23-20"></a>
<a id="__codelineno-23-21" name="__codelineno-23-21"></a>
<a id="__codelineno-23-22" name="__codelineno-23-22"></a><span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/user/&quot;</span><span class="p">,</span> <span class="n">response_model</span><span class="o">=</span><span class="n">UserOut</span><span class="p">)</span>
<a id="__codelineno-23-23" name="__codelineno-23-23"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">create_user</span><span class="p">(</span><span class="n">user</span><span class="p">:</span> <span class="n">UserIn</span><span class="p">):</span>
<a id="__codelineno-23-24" name="__codelineno-23-24"></a>    <span class="k">return</span> <span class="n">user</span>
</code></pre></div></td></tr></table></div>
<p><img alt="" src="../../../../images/1721480653624-0d6afe24-4dcc-41b3-8f3d-f20b34c9b713.png" /></p>
<h4 id="2response_model_exclude_unset"><font style="color:rgb(51, 51, 51);">ï¼ˆ2ï¼‰response_model_exclude_unset</font><a class="headerlink" href="#2response_model_exclude_unset" title="Permanent link">&para;</a></h4>
<p><font style="color:rgb(51, 51, 51);">é€šè¿‡ä¸Šé¢çš„ä¾‹å­ï¼Œæˆ‘ä»¬å­¦åˆ°äº†å¦‚ä½•ç”¨response_modelæ§åˆ¶å“åº”ä½“ç»“æ„ï¼Œä½†æ˜¯å¦‚æœå®ƒä»¬å®é™…ä¸Šæ²¡æœ‰å­˜å‚¨ï¼Œåˆ™å¯èƒ½è¦ä»ç»“æœä¸­å¿½ç•¥å®ƒä»¬ã€‚ä¾‹å¦‚ï¼Œå¦‚æœmodelåœ¨NoSQLæ•°æ®åº“ä¸­å…·æœ‰å¾ˆå¤šå¯é€‰å±æ€§ï¼Œä½†æ˜¯ä¸æƒ³å‘é€å¾ˆé•¿çš„JSONå“åº”ï¼Œå…¶ä¸­åŒ…å«é»˜è®¤å€¼ã€‚</font></p>
<p><font style="color:rgb(51, 51, 51);">æ¡ˆä¾‹ï¼š</font></p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Python</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-24-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-24-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-24-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-24-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-24-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-24-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-24-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-24-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-24-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-24-10">10</a></span>
<span class="normal"><a href="#__codelineno-24-11">11</a></span>
<span class="normal"><a href="#__codelineno-24-12">12</a></span>
<span class="normal"><a href="#__codelineno-24-13">13</a></span>
<span class="normal"><a href="#__codelineno-24-14">14</a></span>
<span class="normal"><a href="#__codelineno-24-15">15</a></span>
<span class="normal"><a href="#__codelineno-24-16">16</a></span>
<span class="normal"><a href="#__codelineno-24-17">17</a></span>
<span class="normal"><a href="#__codelineno-24-18">18</a></span>
<span class="normal"><a href="#__codelineno-24-19">19</a></span>
<span class="normal"><a href="#__codelineno-24-20">20</a></span>
<span class="normal"><a href="#__codelineno-24-21">21</a></span>
<span class="normal"><a href="#__codelineno-24-22">22</a></span>
<span class="normal"><a href="#__codelineno-24-23">23</a></span>
<span class="normal"><a href="#__codelineno-24-24">24</a></span>
<span class="normal"><a href="#__codelineno-24-25">25</a></span>
<span class="normal"><a href="#__codelineno-24-26">26</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-24-1" name="__codelineno-24-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Union</span>
<a id="__codelineno-24-2" name="__codelineno-24-2"></a>
<a id="__codelineno-24-3" name="__codelineno-24-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">fastapi</span><span class="w"> </span><span class="kn">import</span> <span class="n">FastAPI</span>
<a id="__codelineno-24-4" name="__codelineno-24-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">pydantic</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseModel</span>
<a id="__codelineno-24-5" name="__codelineno-24-5"></a>
<a id="__codelineno-24-6" name="__codelineno-24-6"></a><span class="n">app</span> <span class="o">=</span> <span class="n">FastAPI</span><span class="p">()</span>
<a id="__codelineno-24-7" name="__codelineno-24-7"></a>
<a id="__codelineno-24-8" name="__codelineno-24-8"></a>
<a id="__codelineno-24-9" name="__codelineno-24-9"></a><span class="k">class</span><span class="w"> </span><span class="nc">Item</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
<a id="__codelineno-24-10" name="__codelineno-24-10"></a>    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-24-11" name="__codelineno-24-11"></a>    <span class="n">description</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-24-12" name="__codelineno-24-12"></a>    <span class="n">price</span><span class="p">:</span> <span class="nb">float</span>
<a id="__codelineno-24-13" name="__codelineno-24-13"></a>    <span class="n">tax</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">10.5</span>
<a id="__codelineno-24-14" name="__codelineno-24-14"></a>    <span class="n">tags</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-24-15" name="__codelineno-24-15"></a>
<a id="__codelineno-24-16" name="__codelineno-24-16"></a>
<a id="__codelineno-24-17" name="__codelineno-24-17"></a><span class="n">items</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-24-18" name="__codelineno-24-18"></a>    <span class="s2">&quot;foo&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Foo&quot;</span><span class="p">,</span> <span class="s2">&quot;price&quot;</span><span class="p">:</span> <span class="mf">50.2</span><span class="p">},</span>
<a id="__codelineno-24-19" name="__codelineno-24-19"></a>    <span class="s2">&quot;bar&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Bar&quot;</span><span class="p">,</span> <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;The bartenders&quot;</span><span class="p">,</span> <span class="s2">&quot;price&quot;</span><span class="p">:</span> <span class="mi">62</span><span class="p">,</span> <span class="s2">&quot;tax&quot;</span><span class="p">:</span> <span class="mf">20.2</span><span class="p">},</span>
<a id="__codelineno-24-20" name="__codelineno-24-20"></a>    <span class="s2">&quot;baz&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Baz&quot;</span><span class="p">,</span> <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;price&quot;</span><span class="p">:</span> <span class="mf">50.2</span><span class="p">,</span> <span class="s2">&quot;tax&quot;</span><span class="p">:</span> <span class="mf">10.5</span><span class="p">,</span> <span class="s2">&quot;tags&quot;</span><span class="p">:</span> <span class="p">[]},</span>
<a id="__codelineno-24-21" name="__codelineno-24-21"></a><span class="p">}</span>
<a id="__codelineno-24-22" name="__codelineno-24-22"></a>
<a id="__codelineno-24-23" name="__codelineno-24-23"></a>
<a id="__codelineno-24-24" name="__codelineno-24-24"></a><span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/items/</span><span class="si">{item_id}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">response_model</span><span class="o">=</span><span class="n">Item</span><span class="p">,</span> <span class="n">response_model_exclude_unset</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-24-25" name="__codelineno-24-25"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">read_item</span><span class="p">(</span><span class="n">item_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<a id="__codelineno-24-26" name="__codelineno-24-26"></a>    <span class="k">return</span> <span class="n">items</span><span class="p">[</span><span class="n">item_id</span><span class="p">]</span>
</code></pre></div></td></tr></table></div>
<p><font style="color:rgb(51, 51, 51);">è¯·æ±‚ï¼š</font><a href="http://127.0.0.1:8080/items/foo"><font style="color:rgb(51, 51, 51);">http://127.0.0.1:8080/items/foo</font></a></p>
<p><font style="color:rgb(51, 51, 51);">ä¸è®¾ç½®unsetå‚æ•°ï¼š</font></p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Python</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-25-1">1</a></span>
<span class="normal"><a href="#__codelineno-25-2">2</a></span>
<span class="normal"><a href="#__codelineno-25-3">3</a></span>
<span class="normal"><a href="#__codelineno-25-4">4</a></span>
<span class="normal"><a href="#__codelineno-25-5">5</a></span>
<span class="normal"><a href="#__codelineno-25-6">6</a></span>
<span class="normal"><a href="#__codelineno-25-7">7</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-25-1" name="__codelineno-25-1"></a><span class="p">{</span>
<a id="__codelineno-25-2" name="__codelineno-25-2"></a>    <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Foo&quot;</span><span class="p">,</span>
<a id="__codelineno-25-3" name="__codelineno-25-3"></a>    <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="n">null</span><span class="p">,</span>
<a id="__codelineno-25-4" name="__codelineno-25-4"></a>    <span class="s2">&quot;price&quot;</span><span class="p">:</span> <span class="mf">50.2</span><span class="p">,</span>
<a id="__codelineno-25-5" name="__codelineno-25-5"></a>    <span class="s2">&quot;tax&quot;</span><span class="p">:</span> <span class="mf">10.5</span><span class="p">,</span>
<a id="__codelineno-25-6" name="__codelineno-25-6"></a>    <span class="s2">&quot;tags&quot;</span><span class="p">:</span> <span class="p">[]</span>
<a id="__codelineno-25-7" name="__codelineno-25-7"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p><font style="color:rgb(51, 51, 51);">è®¾ç½®unsetå‚æ•°ï¼š</font></p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Python</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-26-1">1</a></span>
<span class="normal"><a href="#__codelineno-26-2">2</a></span>
<span class="normal"><a href="#__codelineno-26-3">3</a></span>
<span class="normal"><a href="#__codelineno-26-4">4</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-26-1" name="__codelineno-26-1"></a><span class="p">{</span>
<a id="__codelineno-26-2" name="__codelineno-26-2"></a>    <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Foo&quot;</span><span class="p">,</span>
<a id="__codelineno-26-3" name="__codelineno-26-3"></a>    <span class="s2">&quot;price&quot;</span><span class="p">:</span> <span class="mf">50.2</span>
<a id="__codelineno-26-4" name="__codelineno-26-4"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p><font style="color:rgb(51, 51, 51);">ä½¿ç”¨è·¯å¾„æ“ä½œè£…é¥°å™¨çš„ </font><code>&lt;font style="color:rgb(51, 51, 51);background-color:rgb(243, 244, 244);"&gt;response_model&lt;/font&gt;</code><font style="color:rgb(51, 51, 51);"> å‚æ•°æ¥å®šä¹‰å“åº”æ¨¡å‹ï¼Œç‰¹åˆ«æ˜¯ç¡®ä¿ç§æœ‰æ•°æ®è¢«è¿‡æ»¤æ‰ã€‚ä½¿ç”¨ </font><code>&lt;font style="color:rgb(51, 51, 51);background-color:rgb(243, 244, 244);"&gt;response_model_exclude_unset&lt;/font&gt;</code><font style="color:rgb(51, 51, 51);"> æ¥ä»…è¿”å›æ˜¾å¼è®¾å®šçš„å€¼ã€‚</font><font style="color:rgb(51, 51, 51);">é™¤äº†</font><code>&lt;font style="color:rgb(51, 51, 51);background-color:rgb(243, 244, 244);"&gt;response_model_exclude_unset&lt;/font&gt;</code><font style="color:rgb(51, 51, 51);">ä»¥å¤–ï¼Œè¿˜æœ‰</font><code>&lt;font style="color:rgb(51, 51, 51);background-color:rgb(243, 244, 244);"&gt;response_model_exclude_defaults&lt;/font&gt;</code><font style="color:rgb(51, 51, 51);">å’Œ</font><code>&lt;font style="color:rgb(51, 51, 51);background-color:rgb(243, 244, 244);"&gt;response_model_exclude_none&lt;/font&gt;</code><font style="color:rgb(51, 51, 51);">ï¼Œæˆ‘ä»¬å¯ä»¥å¾ˆç›´è§‚çš„äº†è§£åˆ°ä»–ä»¬çš„æ„æ€ï¼Œä¸è¿”å›æ˜¯é»˜è®¤å€¼çš„å­—æ®µå’Œä¸è¿”å›æ˜¯Noneçš„å­—æ®µã€‚</font></p>
<h4 id="3includeå’Œexclude"><font style="color:rgb(51, 51, 51);">ï¼ˆ3ï¼‰INCLUDEå’ŒEXCLUDE</font><a class="headerlink" href="#3includeå’Œexclude" title="Permanent link">&para;</a></h4>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Python</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-27-1">1</a></span>
<span class="normal"><a href="#__codelineno-27-2">2</a></span>
<span class="normal"><a href="#__codelineno-27-3">3</a></span>
<span class="normal"><a href="#__codelineno-27-4">4</a></span>
<span class="normal"><a href="#__codelineno-27-5">5</a></span>
<span class="normal"><a href="#__codelineno-27-6">6</a></span>
<span class="normal"><a href="#__codelineno-27-7">7</a></span>
<span class="normal"><a href="#__codelineno-27-8">8</a></span>
<span class="normal"><a href="#__codelineno-27-9">9</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-27-1" name="__codelineno-27-1"></a><span class="c1"># response_model_exclude</span>
<a id="__codelineno-27-2" name="__codelineno-27-2"></a><span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/items/</span><span class="si">{item_id}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">response_model</span><span class="o">=</span><span class="n">Item</span><span class="p">,</span> <span class="n">response_model_exclude</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;description&quot;</span><span class="p">},</span> <span class="p">)</span>
<a id="__codelineno-27-3" name="__codelineno-27-3"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">read_item</span><span class="p">(</span><span class="n">item_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<a id="__codelineno-27-4" name="__codelineno-27-4"></a>    <span class="k">return</span> <span class="n">items</span><span class="p">[</span><span class="n">item_id</span><span class="p">]</span>
<a id="__codelineno-27-5" name="__codelineno-27-5"></a>
<a id="__codelineno-27-6" name="__codelineno-27-6"></a><span class="c1"># response_model_include  </span>
<a id="__codelineno-27-7" name="__codelineno-27-7"></a><span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/items/</span><span class="si">{item_id}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">response_model</span><span class="o">=</span><span class="n">Item</span><span class="p">,</span> <span class="n">response_model_include</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;price&quot;</span><span class="p">},</span> <span class="p">)</span>
<a id="__codelineno-27-8" name="__codelineno-27-8"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">read_item</span><span class="p">(</span><span class="n">item_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<a id="__codelineno-27-9" name="__codelineno-27-9"></a>    <span class="k">return</span> <span class="n">items</span><span class="p">[</span><span class="n">item_id</span><span class="p">]</span>
</code></pre></div></td></tr></table></div>
<h2 id="jinja2æ¨¡æ¿"><font style="color:rgb(51, 51, 51);">jinja2æ¨¡æ¿</font><a class="headerlink" href="#jinja2æ¨¡æ¿" title="Permanent link">&para;</a></h2>
<p><font style="color:rgb(51, 51, 51);">è¦äº†è§£jinja2ï¼Œé‚£ä¹ˆéœ€è¦å…ˆç†è§£æ¨¡æ¿çš„æ¦‚å¿µã€‚æ¨¡æ¿åœ¨Pythonçš„webå¼€å‘ä¸­â¼´æ³›ä½¿â½¤ï¼Œå®ƒèƒ½å¤Ÿæœ‰æ•ˆçš„å°†ä¸šåŠ¡é€»è¾‘å’Œé¡µâ¾¯é€»è¾‘åˆ†å¼€ï¼Œä½¿ä»£ç å¯è¯»æ€§å¢å¼ºã€å¹¶ä¸”æ›´åŠ å®¹æ˜“ç†è§£å’Œç»´æŠ¤ã€‚</font><font style="color:rgb(51, 51, 51);">æ¨¡æ¿ç®€å•æ¥è¯´å°±æ˜¯â¼€ä¸ªå…¶ä¸­åŒ…æ¶µå ä½å˜é‡è¡¨â½°åŠ¨æ€çš„éƒ¨åˆ†çš„â½‚ä»¶ï¼Œæ¨¡æ¿â½‚ä»¶åœ¨ç»è¿‡åŠ¨æ€èµ‹å€¼åï¼Œè¿”å›ç»™â½¤æˆ·ã€‚</font></p>
<p><font style="color:rgb(51, 51, 51);">jinja2æ˜¯Flaskä½œè€…å¼€å‘çš„â¼€ä¸ªæ¨¡æ¿ç³»ç»Ÿï¼Œèµ·åˆæ˜¯ä»¿djangoæ¨¡æ¿çš„â¼€ä¸ªæ¨¡æ¿å¼•æ“ï¼Œä¸ºFlaskæä¾›æ¨¡æ¿â½€æŒï¼Œç”±äºå…¶çµæ´»ï¼Œå¿«é€Ÿå’Œå®‰å…¨ç­‰ä¼˜ç‚¹è¢«â¼´æ³›ä½¿â½¤ã€‚</font></p>
<p><font style="color:rgb(51, 51, 51);">åœ¨jinja2ä¸­ï¼Œå­˜åœ¨ä¸‰ç§è¯­æ³•ï¼š</font></p>
<ol>
<li><font style="color:rgb(119, 119, 119);">å˜é‡å–å€¼ {{ }}</font></li>
<li><font style="color:rgb(119, 119, 119);">æ§åˆ¶ç»“æ„ {% %}</font></li>
</ol>
<h3 id="51jinja2-çš„å˜é‡"><font style="color:rgb(51, 51, 51);">5.1ã€jinja2 çš„å˜é‡</font><a class="headerlink" href="#51jinja2-çš„å˜é‡" title="Permanent link">&para;</a></h3>
<p><code>&lt;font style="color:rgb(51, 51, 51);background-color:rgb(243, 244, 244);"&gt;Main.py&lt;/font&gt;</code></p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Python</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-28-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-28-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-28-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-28-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-28-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-28-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-28-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-28-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-28-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-28-10">10</a></span>
<span class="normal"><a href="#__codelineno-28-11">11</a></span>
<span class="normal"><a href="#__codelineno-28-12">12</a></span>
<span class="normal"><a href="#__codelineno-28-13">13</a></span>
<span class="normal"><a href="#__codelineno-28-14">14</a></span>
<span class="normal"><a href="#__codelineno-28-15">15</a></span>
<span class="normal"><a href="#__codelineno-28-16">16</a></span>
<span class="normal"><a href="#__codelineno-28-17">17</a></span>
<span class="normal"><a href="#__codelineno-28-18">18</a></span>
<span class="normal"><a href="#__codelineno-28-19">19</a></span>
<span class="normal"><a href="#__codelineno-28-20">20</a></span>
<span class="normal"><a href="#__codelineno-28-21">21</a></span>
<span class="normal"><a href="#__codelineno-28-22">22</a></span>
<span class="normal"><a href="#__codelineno-28-23">23</a></span>
<span class="normal"><a href="#__codelineno-28-24">24</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-28-1" name="__codelineno-28-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">fastapi</span><span class="w"> </span><span class="kn">import</span> <span class="n">FastAPI</span><span class="p">,</span> <span class="n">Request</span>
<a id="__codelineno-28-2" name="__codelineno-28-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">fastapi.templating</span><span class="w"> </span><span class="kn">import</span> <span class="n">Jinja2Templates</span>
<a id="__codelineno-28-3" name="__codelineno-28-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">uvicorn</span>
<a id="__codelineno-28-4" name="__codelineno-28-4"></a>
<a id="__codelineno-28-5" name="__codelineno-28-5"></a><span class="n">app</span> <span class="o">=</span> <span class="n">FastAPI</span><span class="p">()</span>  <span class="c1"># å®ä¾‹åŒ– FastAPIå¯¹è±¡</span>
<a id="__codelineno-28-6" name="__codelineno-28-6"></a><span class="n">templates</span> <span class="o">=</span> <span class="n">Jinja2Templates</span><span class="p">(</span><span class="n">directory</span><span class="o">=</span><span class="s2">&quot;templates&quot;</span><span class="p">)</span>  <span class="c1"># å®ä¾‹åŒ–Jinja2å¯¹è±¡ï¼Œå¹¶å°†æ–‡ä»¶å¤¹è·¯å¾„è®¾ç½®ä¸ºä»¥templateså‘½ä»¤çš„æ–‡ä»¶å¤¹</span>
<a id="__codelineno-28-7" name="__codelineno-28-7"></a>
<a id="__codelineno-28-8" name="__codelineno-28-8"></a>
<a id="__codelineno-28-9" name="__codelineno-28-9"></a><span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
<a id="__codelineno-28-10" name="__codelineno-28-10"></a><span class="k">def</span><span class="w"> </span><span class="nf">hello</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">):</span>
<a id="__codelineno-28-11" name="__codelineno-28-11"></a>    <span class="k">return</span> <span class="n">templates</span><span class="o">.</span><span class="n">TemplateResponse</span><span class="p">(</span>
<a id="__codelineno-28-12" name="__codelineno-28-12"></a>        <span class="s1">&#39;index.html&#39;</span><span class="p">,</span>
<a id="__codelineno-28-13" name="__codelineno-28-13"></a>        <span class="p">{</span>
<a id="__codelineno-28-14" name="__codelineno-28-14"></a>            <span class="s1">&#39;request&#39;</span><span class="p">:</span> <span class="n">request</span><span class="p">,</span>  <span class="c1"># æ³¨æ„ï¼Œè¿”å›æ¨¡æ¿å“åº”æ—¶ï¼Œå¿…é¡»æœ‰requesté”®å€¼å¯¹ï¼Œä¸”å€¼ä¸ºRequestè¯·æ±‚å¯¹è±¡</span>
<a id="__codelineno-28-15" name="__codelineno-28-15"></a>            <span class="s1">&#39;user&#39;</span><span class="p">:</span> <span class="s1">&#39;yuan&#39;</span><span class="p">,</span>
<a id="__codelineno-28-16" name="__codelineno-28-16"></a>            <span class="s2">&quot;books&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;é‡‘ç“¶æ¢…&quot;</span><span class="p">,</span> <span class="s2">&quot;èŠæ–‹&quot;</span><span class="p">,</span> <span class="s2">&quot;å‰ªç¯æ–°è¯&quot;</span><span class="p">,</span> <span class="s2">&quot;å›½è‰²å¤©é¦™&quot;</span><span class="p">],</span>
<a id="__codelineno-28-17" name="__codelineno-28-17"></a>            <span class="s2">&quot;booksDict&quot;</span><span class="p">:</span> <span class="p">{</span>
<a id="__codelineno-28-18" name="__codelineno-28-18"></a>                <span class="s2">&quot;é‡‘ç“¶æ¢…&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;price&quot;</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span> <span class="s2">&quot;publish&quot;</span><span class="p">:</span> <span class="s2">&quot;è‹¹æœå‡ºç‰ˆç¤¾&quot;</span><span class="p">},</span>
<a id="__codelineno-28-19" name="__codelineno-28-19"></a>                <span class="s2">&quot;èŠæ–‹&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;price&quot;</span><span class="p">:</span> <span class="mi">200</span><span class="p">,</span> <span class="s2">&quot;publish&quot;</span><span class="p">:</span> <span class="s2">&quot;æ©˜å­å‡ºç‰ˆç¤¾&quot;</span><span class="p">},</span>
<a id="__codelineno-28-20" name="__codelineno-28-20"></a>            <span class="p">}</span>
<a id="__codelineno-28-21" name="__codelineno-28-21"></a>        <span class="p">}</span>
<a id="__codelineno-28-22" name="__codelineno-28-22"></a>    <span class="p">)</span>
<a id="__codelineno-28-23" name="__codelineno-28-23"></a><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
<a id="__codelineno-28-24" name="__codelineno-28-24"></a>    <span class="n">uvicorn</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s2">&quot;main:app&quot;</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">8080</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">reload</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Python</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-29-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-29-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-29-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-29-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-29-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-29-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-29-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-29-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-29-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-29-10">10</a></span>
<span class="normal"><a href="#__codelineno-29-11">11</a></span>
<span class="normal"><a href="#__codelineno-29-12">12</a></span>
<span class="normal"><a href="#__codelineno-29-13">13</a></span>
<span class="normal"><a href="#__codelineno-29-14">14</a></span>
<span class="normal"><a href="#__codelineno-29-15">15</a></span>
<span class="normal"><a href="#__codelineno-29-16">16</a></span>
<span class="normal"><a href="#__codelineno-29-17">17</a></span>
<span class="normal"><a href="#__codelineno-29-18">18</a></span>
<span class="normal"><a href="#__codelineno-29-19">19</a></span>
<span class="normal"><a href="#__codelineno-29-20">20</a></span>
<span class="normal"><a href="#__codelineno-29-21">21</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-29-1" name="__codelineno-29-1"></a><span class="o">&lt;</span><span class="err">!</span><span class="n">DOCTYPE</span> <span class="n">html</span><span class="o">&gt;</span>
<a id="__codelineno-29-2" name="__codelineno-29-2"></a><span class="o">&lt;</span><span class="n">html</span> <span class="n">lang</span><span class="o">=</span><span class="s2">&quot;en&quot;</span><span class="o">&gt;</span>
<a id="__codelineno-29-3" name="__codelineno-29-3"></a> <span class="o">&lt;</span><span class="n">head</span><span class="o">&gt;</span>
<a id="__codelineno-29-4" name="__codelineno-29-4"></a>  <span class="o">&lt;</span><span class="n">meta</span> <span class="n">charset</span><span class="o">=</span><span class="s2">&quot;UTF-8&quot;</span><span class="o">&gt;</span>
<a id="__codelineno-29-5" name="__codelineno-29-5"></a><span class="o">&lt;</span><span class="n">title</span><span class="o">&gt;</span><span class="n">Title</span><span class="o">&lt;/</span><span class="n">title</span><span class="o">&gt;</span>
<a id="__codelineno-29-6" name="__codelineno-29-6"></a><span class="o">&lt;/</span><span class="n">head</span><span class="o">&gt;</span>
<a id="__codelineno-29-7" name="__codelineno-29-7"></a><span class="o">&lt;</span><span class="n">body</span><span class="o">&gt;</span>
<a id="__codelineno-29-8" name="__codelineno-29-8"></a>
<a id="__codelineno-29-9" name="__codelineno-29-9"></a>
<a id="__codelineno-29-10" name="__codelineno-29-10"></a><span class="o">&lt;</span><span class="n">h1</span><span class="o">&gt;</span><span class="p">{{</span> <span class="n">user</span><span class="p">}}</span><span class="o">&lt;/</span><span class="n">h1</span><span class="o">&gt;</span>
<a id="__codelineno-29-11" name="__codelineno-29-11"></a>
<a id="__codelineno-29-12" name="__codelineno-29-12"></a><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="p">{{</span> <span class="n">books</span><span class="mf">.0</span> <span class="p">}}</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
<a id="__codelineno-29-13" name="__codelineno-29-13"></a><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="p">{{</span> <span class="n">books</span><span class="mf">.1</span> <span class="p">}}</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
<a id="__codelineno-29-14" name="__codelineno-29-14"></a><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="p">{{</span> <span class="n">books</span><span class="mf">.2</span> <span class="p">}}</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
<a id="__codelineno-29-15" name="__codelineno-29-15"></a><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="p">{{</span> <span class="n">books</span><span class="mf">.3</span> <span class="p">}}</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
<a id="__codelineno-29-16" name="__codelineno-29-16"></a>
<a id="__codelineno-29-17" name="__codelineno-29-17"></a><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="p">{{</span> <span class="n">booksDict</span><span class="o">.</span><span class="n">é‡‘ç“¶æ¢…</span><span class="o">.</span><span class="n">price</span> <span class="p">}}</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
<a id="__codelineno-29-18" name="__codelineno-29-18"></a>
<a id="__codelineno-29-19" name="__codelineno-29-19"></a>
<a id="__codelineno-29-20" name="__codelineno-29-20"></a><span class="o">&lt;/</span><span class="n">body</span><span class="o">&gt;</span>
<a id="__codelineno-29-21" name="__codelineno-29-21"></a><span class="o">&lt;/</span><span class="n">html</span><span class="o">&gt;</span>
</code></pre></div></td></tr></table></div>
<h3 id="52jinja2-çš„è¿‡æ»¤å™¨"><font style="color:rgb(51, 51, 51);">5.2ã€jinja2 çš„è¿‡æ»¤å™¨</font><a class="headerlink" href="#52jinja2-çš„è¿‡æ»¤å™¨" title="Permanent link">&para;</a></h3>
<p><font style="color:rgb(51, 51, 51);">å˜é‡å¯ä»¥é€šè¿‡â€œè¿‡æ»¤å™¨â€è¿›â¾ä¿®æ”¹ï¼Œè¿‡æ»¤å™¨å¯ä»¥ç†è§£ä¸ºæ˜¯jinja2â¾¥â¾¯çš„å†…ç½®å‡½æ•°å’Œå­—ç¬¦ä¸²å¤„ç†å‡½æ•°ã€‚å¸¸â½¤çš„è¿‡æ»¤å™¨æœ‰ï¼š</font></p>
<table>
<thead>
<tr>
<th style="text-align: left;"><strong><font style="color:rgb(51, 51, 51);">è¿‡æ»¤å™¨åç§°</font></strong></th>
<th style="text-align: left;"><strong><font style="color:rgb(51, 51, 51);">è¯´æ˜</font></strong></th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><font style="color:rgb(51, 51, 51);">capitialize</font></td>
<td style="text-align: left;"><font style="color:rgb(51, 51, 51);">æŠŠå€¼çš„â¾¸å­—æ¯è½¬æ¢æˆâ¼¤å†™ï¼Œå…¶ä»–â¼¦æ¯è½¬æ¢ä¸ºâ¼©å†™</font></td>
</tr>
<tr>
<td style="text-align: left;"><font style="color:rgb(51, 51, 51);">lower</font></td>
<td style="text-align: left;"><font style="color:rgb(51, 51, 51);">æŠŠå€¼è½¬æ¢æˆâ¼©å†™å½¢å¼</font></td>
</tr>
<tr>
<td style="text-align: left;"><font style="color:rgb(51, 51, 51);">title</font></td>
<td style="text-align: left;"><font style="color:rgb(51, 51, 51);">æŠŠå€¼ä¸­æ¯ä¸ªå•è¯çš„â¾¸å­—æ¯éƒ½è½¬æ¢æˆâ¼¤å†™</font></td>
</tr>
<tr>
<td style="text-align: left;"><font style="color:rgb(51, 51, 51);">trim</font></td>
<td style="text-align: left;"><font style="color:rgb(51, 51, 51);">æŠŠå€¼çš„â¾¸å°¾ç©ºæ ¼å»æ‰</font></td>
</tr>
<tr>
<td style="text-align: left;"><font style="color:rgb(51, 51, 51);">striptags</font></td>
<td style="text-align: left;"><font style="color:rgb(51, 51, 51);">æ¸²æŸ“ä¹‹å‰æŠŠå€¼ä¸­æ‰€æœ‰çš„HTMLæ ‡ç­¾éƒ½åˆ æ‰</font></td>
</tr>
<tr>
<td style="text-align: left;"><font style="color:rgb(51, 51, 51);">join</font></td>
<td style="text-align: left;"><font style="color:rgb(51, 51, 51);">æ‹¼æ¥å¤šä¸ªå€¼ä¸ºå­—ç¬¦ä¸²</font></td>
</tr>
<tr>
<td style="text-align: left;"><font style="color:rgb(51, 51, 51);">round</font></td>
<td style="text-align: left;"><font style="color:rgb(51, 51, 51);">é»˜è®¤å¯¹æ•°å­—è¿›â¾å››èˆäº”â¼Šï¼Œä¹Ÿå¯ä»¥â½¤å‚æ•°è¿›â¾æ§åˆ¶</font></td>
</tr>
<tr>
<td style="text-align: left;"><font style="color:rgb(51, 51, 51);">safe</font></td>
<td style="text-align: left;"><font style="color:rgb(51, 51, 51);">æ¸²æŸ“æ—¶å€¼ä¸è½¬ä¹‰</font></td>
</tr>
</tbody>
</table>
<p><font style="color:rgb(51, 51, 51);">é‚£ä¹ˆå¦‚ä½•ä½¿â½¤è¿™äº›è¿‡æ»¤å™¨å‘¢ï¼Ÿåªéœ€è¦åœ¨å˜é‡åâ¾¯ä½¿â½¤ç®¡é“(|)åˆ†å‰²ï¼Œå¤šä¸ªè¿‡æ»¤å™¨å¯ä»¥é“¾å¼è°ƒâ½¤ï¼Œå‰â¼€ä¸ªè¿‡æ»¤å™¨çš„è¾“å‡ºä¼šä½œä¸ºåâ¼€ä¸ªè¿‡æ»¤</font><font style="color:rgb(51, 51, 51);">å™¨çš„è¾“â¼Šã€‚</font></p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Python</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-30-1">1</a></span>
<span class="normal"><a href="#__codelineno-30-2">2</a></span>
<span class="normal"><a href="#__codelineno-30-3">3</a></span>
<span class="normal"><a href="#__codelineno-30-4">4</a></span>
<span class="normal"><a href="#__codelineno-30-5">5</a></span>
<span class="normal"><a href="#__codelineno-30-6">6</a></span>
<span class="normal"><a href="#__codelineno-30-7">7</a></span>
<span class="normal"><a href="#__codelineno-30-8">8</a></span>
<span class="normal"><a href="#__codelineno-30-9">9</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-30-1" name="__codelineno-30-1"></a><span class="p">{{</span> <span class="s1">&#39;abc&#39;</span><span class="o">|</span> <span class="n">captialize</span>  <span class="p">}}</span>  <span class="c1"># Abc</span>
<a id="__codelineno-30-2" name="__codelineno-30-2"></a>
<a id="__codelineno-30-3" name="__codelineno-30-3"></a><span class="p">{{</span> <span class="s1">&#39;abc&#39;</span><span class="o">|</span> <span class="n">upper</span>  <span class="p">}}</span> <span class="c1"># ABC</span>
<a id="__codelineno-30-4" name="__codelineno-30-4"></a>
<a id="__codelineno-30-5" name="__codelineno-30-5"></a><span class="p">{{</span> <span class="s1">&#39;hello world&#39;</span><span class="o">|</span> <span class="n">title</span>  <span class="p">}}</span> <span class="c1"># Hello World</span>
<a id="__codelineno-30-6" name="__codelineno-30-6"></a>
<a id="__codelineno-30-7" name="__codelineno-30-7"></a><span class="p">{{</span> <span class="s2">&quot;hello world&quot;</span><span class="o">|</span> <span class="n">replace</span><span class="p">(</span><span class="s1">&#39;world&#39;</span><span class="p">,</span><span class="s1">&#39;yuan&#39;</span><span class="p">)</span> <span class="o">|</span> <span class="n">upper</span> <span class="p">}}</span> <span class="c1"># HELLO YUAN</span>
<a id="__codelineno-30-8" name="__codelineno-30-8"></a>
<a id="__codelineno-30-9" name="__codelineno-30-9"></a><span class="p">{{</span> <span class="mf">18.18</span> <span class="o">|</span> <span class="nb">round</span> <span class="o">|</span> <span class="nb">int</span> <span class="p">}}</span> <span class="c1"># 18</span>
</code></pre></div></td></tr></table></div>
<h3 id="53jinja2-çš„æ§åˆ¶ç»“æ„"><font style="color:rgb(51, 51, 51);">5.3ã€jinja2 çš„æ§åˆ¶ç»“æ„</font><a class="headerlink" href="#53jinja2-çš„æ§åˆ¶ç»“æ„" title="Permanent link">&para;</a></h3>
<h4 id="531åˆ†æ”¯æ§åˆ¶"><font style="color:rgb(51, 51, 51);">5.3.1ã€åˆ†æ”¯æ§åˆ¶</font><a class="headerlink" href="#531åˆ†æ”¯æ§åˆ¶" title="Permanent link">&para;</a></h4>
<p><font style="color:rgb(51, 51, 51);">jinja2ä¸­çš„ifè¯­å¥ç±»ä¼¼ä¸Pythonçš„ifè¯­å¥ï¼Œå®ƒä¹Ÿå…·æœ‰å•åˆ†â½€ï¼Œå¤šåˆ†â½€ç­‰å¤šç§ç»“æ„ï¼Œä¸åŒçš„æ˜¯ï¼Œæ¡ä»¶è¯­å¥ä¸éœ€è¦ä½¿â½¤å†’å·ç»“å°¾ï¼Œâ½½ç»“æŸæ§åˆ¶è¯­å¥ï¼Œéœ€è¦ä½¿â½¤endifå…³é”®å­—</font></p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Python</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-31-1">1</a></span>
<span class="normal"><a href="#__codelineno-31-2">2</a></span>
<span class="normal"><a href="#__codelineno-31-3">3</a></span>
<span class="normal"><a href="#__codelineno-31-4">4</a></span>
<span class="normal"><a href="#__codelineno-31-5">5</a></span>
<span class="normal"><a href="#__codelineno-31-6">6</a></span>
<span class="normal"><a href="#__codelineno-31-7">7</a></span>
<span class="normal"><a href="#__codelineno-31-8">8</a></span>
<span class="normal"><a href="#__codelineno-31-9">9</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-31-1" name="__codelineno-31-1"></a><span class="p">{</span><span class="o">%</span> <span class="k">if</span> <span class="n">age</span> <span class="o">&gt;</span> <span class="mi">18</span> <span class="o">%</span><span class="p">}</span>
<a id="__codelineno-31-2" name="__codelineno-31-2"></a>
<a id="__codelineno-31-3" name="__codelineno-31-3"></a><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="n">æˆå¹´åŒº</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
<a id="__codelineno-31-4" name="__codelineno-31-4"></a>
<a id="__codelineno-31-5" name="__codelineno-31-5"></a><span class="p">{</span><span class="o">%</span> <span class="k">else</span> <span class="o">%</span><span class="p">}</span>
<a id="__codelineno-31-6" name="__codelineno-31-6"></a>
<a id="__codelineno-31-7" name="__codelineno-31-7"></a><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="n">æœªæˆå¹´åŒº</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
<a id="__codelineno-31-8" name="__codelineno-31-8"></a>
<a id="__codelineno-31-9" name="__codelineno-31-9"></a><span class="p">{</span><span class="o">%</span> <span class="n">endif</span> <span class="o">%</span><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<h4 id="532å¾ªç¯æ§åˆ¶"><font style="color:rgb(51, 51, 51);">5.3.2ã€å¾ªç¯æ§åˆ¶</font><a class="headerlink" href="#532å¾ªç¯æ§åˆ¶" title="Permanent link">&para;</a></h4>
<p><font style="color:rgb(51, 51, 51);">jinja2ä¸­çš„forå¾ªç¯â½¤äºè¿­ä»£Pythonçš„æ•°æ®ç±»å‹ï¼ŒåŒ…æ‹¬åˆ—è¡¨ï¼Œå…ƒç»„å’Œå­—å…¸ã€‚åœ¨jinja2ä¸­ä¸å­˜åœ¨whileå¾ªç¯ã€‚</font></p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Python</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-32-1">1</a></span>
<span class="normal"><a href="#__codelineno-32-2">2</a></span>
<span class="normal"><a href="#__codelineno-32-3">3</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-32-1" name="__codelineno-32-1"></a><span class="p">{</span><span class="o">%</span> <span class="k">for</span> <span class="n">book</span> <span class="ow">in</span> <span class="n">books</span> <span class="o">%</span><span class="p">}</span>
<a id="__codelineno-32-2" name="__codelineno-32-2"></a><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="p">{{</span> <span class="n">book</span> <span class="p">}}</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
<a id="__codelineno-32-3" name="__codelineno-32-3"></a><span class="p">{</span><span class="o">%</span> <span class="n">endfor</span> <span class="o">%</span><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<h2 id="ormæ“ä½œ"><font style="color:rgb(51, 51, 51);">ORMæ“ä½œ</font><a class="headerlink" href="#ormæ“ä½œ" title="Permanent link">&para;</a></h2>
<p><font style="color:rgb(51, 51, 51);">åœ¨å¤§å‹çš„webå¼€å‘ä¸­ï¼Œæˆ‘ä»¬è‚¯å®šä¼šç”¨åˆ°æ•°æ®åº“æ“ä½œï¼Œé‚£ä¹ˆFastAPIä¹Ÿæ”¯æŒæ•°æ®åº“çš„å¼€å‘ï¼Œä½ å¯ä»¥ç”¨ PostgreSQLã€MySQLã€ SQLite Oracle ç­‰ã€‚æœ¬æ–‡ç”¨SQLiteä¸ºä¾‹ã€‚æˆ‘ä»¬çœ‹ä¸‹åœ¨fastapiæ˜¯å¦‚ä½•æ“ä½œè®¾è®¡æ•°æ®åº“çš„ã€‚</font></p>
<p><font style="color:rgb(51, 51, 51);">fastapiæ˜¯ä¸€ä¸ªå¾ˆä¼˜ç§€çš„æ¡†æ¶ï¼Œä½†æ˜¯ç¼ºå°‘ä¸€ä¸ªåˆé€‚çš„ormï¼Œå®˜æ–¹ä»£ç é‡Œé¢ä½¿ç”¨çš„æ˜¯sqlalchemyï¼ŒTortoise ORM æ˜¯å— Django å¯å‘çš„æ˜“äºä½¿ç”¨çš„å¼‚æ­¥ ORM ï¼ˆå¯¹è±¡å…³ç³»æ˜ å°„å™¨ï¼‰ã€‚</font><img alt="" src="../../../../images/1721480672618-57d98553-6b41-40c4-a1de-815998d4b291.png" /></p>
<p><a href="https://tortoise-orm.readthedocs.io/en/latest/index.html"><font style="color:rgb(51, 51, 51);">Tortoise ORMæ–‡æ¡£</font></a></p>
<p><font style="color:rgb(119, 119, 119);">Tortoise ORM ç›®å‰æ”¯æŒä»¥ä¸‹</font><a href="https://tortoise-orm.readthedocs.io/en/latest/databases.html#databases"><font style="color:rgb(119, 119, 119);">æ•°æ®åº“</font></a><font style="color:rgb(119, 119, 119);">ï¼š</font></p>
<ul>
<li><font style="color:rgb(119, 119, 119);">PostgreSQL &gt;= 9.4ï¼ˆä½¿ç”¨</font><code>&lt;font style="color:rgb(119, 119, 119);background-color:rgb(243, 244, 244);"&gt;asyncpg&lt;/font&gt;</code><font style="color:rgb(119, 119, 119);">ï¼‰</font></li>
<li><font style="color:rgb(119, 119, 119);">SQLiteï¼ˆä½¿ç”¨</font><code>&lt;font style="color:rgb(119, 119, 119);background-color:rgb(243, 244, 244);"&gt;aiosqlite&lt;/font&gt;</code><font style="color:rgb(119, 119, 119);">ï¼‰</font></li>
<li><font style="color:rgb(119, 119, 119);">MySQL/MariaDBï¼ˆä½¿ç”¨</font><code>&lt;font style="color:rgb(119, 119, 119);background-color:rgb(243, 244, 244);"&gt;aiomysql&lt;/font&gt;</code><font style="color:rgb(119, 119, 119);">æˆ–ä½¿ç”¨</font><a href="https://github.com/long2ice/asyncmy"><font style="color:rgb(119, 119, 119);">asyncmy</font></a><font style="color:rgb(119, 119, 119);">ï¼‰</font></li>
</ul>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Python</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-33-1">1</a></span>
<span class="normal"><a href="#__codelineno-33-2">2</a></span>
<span class="normal"><a href="#__codelineno-33-3">3</a></span>
<span class="normal"><a href="#__codelineno-33-4">4</a></span>
<span class="normal"><a href="#__codelineno-33-5">5</a></span>
<span class="normal"><a href="#__codelineno-33-6">6</a></span>
<span class="normal"><a href="#__codelineno-33-7">7</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-33-1" name="__codelineno-33-1"></a><span class="n">å®‰è£…</span>
<a id="__codelineno-33-2" name="__codelineno-33-2"></a><span class="n">é¦–å…ˆä½ å¿…é¡»åƒè¿™æ ·å®‰è£…Tortoise</span> <span class="n">ORM</span><span class="err">ï¼š</span>
<a id="__codelineno-33-3" name="__codelineno-33-3"></a><span class="n">pip</span> <span class="n">install</span> <span class="n">tortoise</span><span class="o">-</span><span class="n">orm</span>
<a id="__codelineno-33-4" name="__codelineno-33-4"></a><span class="n">ä½ ä¹Ÿå¯ä»¥ä½¿ç”¨ä½ çš„dbé©±åŠ¨ç¨‹åºæ¥å®‰è£…</span><span class="err">ï¼ˆ</span><span class="n">aiosqliteæ˜¯å†…ç½®çš„</span><span class="err">ï¼‰ï¼š</span>
<a id="__codelineno-33-5" name="__codelineno-33-5"></a><span class="n">pip</span> <span class="n">install</span> <span class="n">tortoise</span><span class="o">-</span><span class="n">orm</span><span class="p">[</span><span class="n">asyncpg</span><span class="p">]</span>
<a id="__codelineno-33-6" name="__codelineno-33-6"></a><span class="n">For</span> <span class="n">MySQL</span><span class="p">:</span><span class="n">å¯¹äºMySQL</span><span class="err">ï¼š</span>
<a id="__codelineno-33-7" name="__codelineno-33-7"></a><span class="n">pip</span> <span class="n">install</span> <span class="n">tortoise</span><span class="o">-</span><span class="n">orm</span><span class="p">[</span><span class="n">asyncmy</span><span class="p">]</span>
</code></pre></div></td></tr></table></div>
<h3 id="61åˆ›å»ºæ¨¡å‹"><font style="color:rgb(51, 51, 51);">6.1ã€åˆ›å»ºæ¨¡å‹</font><a class="headerlink" href="#61åˆ›å»ºæ¨¡å‹" title="Permanent link">&para;</a></h3>
<p><font style="color:rgb(51, 51, 51);">ä»¥é€‰è¯¾ç³»ç»Ÿä¸ºä¾‹ï¼š</font></p>
<p><code>&lt;font style="color:rgb(51, 51, 51);background-color:rgb(243, 244, 244);"&gt;models.py&lt;/font&gt;</code></p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Python</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-34-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-34-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-34-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-34-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-34-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-34-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-34-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-34-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-34-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-34-10">10</a></span>
<span class="normal"><a href="#__codelineno-34-11">11</a></span>
<span class="normal"><a href="#__codelineno-34-12">12</a></span>
<span class="normal"><a href="#__codelineno-34-13">13</a></span>
<span class="normal"><a href="#__codelineno-34-14">14</a></span>
<span class="normal"><a href="#__codelineno-34-15">15</a></span>
<span class="normal"><a href="#__codelineno-34-16">16</a></span>
<span class="normal"><a href="#__codelineno-34-17">17</a></span>
<span class="normal"><a href="#__codelineno-34-18">18</a></span>
<span class="normal"><a href="#__codelineno-34-19">19</a></span>
<span class="normal"><a href="#__codelineno-34-20">20</a></span>
<span class="normal"><a href="#__codelineno-34-21">21</a></span>
<span class="normal"><a href="#__codelineno-34-22">22</a></span>
<span class="normal"><a href="#__codelineno-34-23">23</a></span>
<span class="normal"><a href="#__codelineno-34-24">24</a></span>
<span class="normal"><a href="#__codelineno-34-25">25</a></span>
<span class="normal"><a href="#__codelineno-34-26">26</a></span>
<span class="normal"><a href="#__codelineno-34-27">27</a></span>
<span class="normal"><a href="#__codelineno-34-28">28</a></span>
<span class="normal"><a href="#__codelineno-34-29">29</a></span>
<span class="normal"><a href="#__codelineno-34-30">30</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-34-1" name="__codelineno-34-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">tortoise.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">Model</span>
<a id="__codelineno-34-2" name="__codelineno-34-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">tortoise</span><span class="w"> </span><span class="kn">import</span> <span class="n">fields</span>
<a id="__codelineno-34-3" name="__codelineno-34-3"></a>
<a id="__codelineno-34-4" name="__codelineno-34-4"></a>
<a id="__codelineno-34-5" name="__codelineno-34-5"></a><span class="k">class</span><span class="w"> </span><span class="nc">Clas</span><span class="p">(</span><span class="n">Model</span><span class="p">):</span>
<a id="__codelineno-34-6" name="__codelineno-34-6"></a>    <span class="n">name</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">255</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s1">&#39;ç­çº§åç§°&#39;</span><span class="p">)</span>
<a id="__codelineno-34-7" name="__codelineno-34-7"></a>
<a id="__codelineno-34-8" name="__codelineno-34-8"></a>
<a id="__codelineno-34-9" name="__codelineno-34-9"></a><span class="k">class</span><span class="w"> </span><span class="nc">Teacher</span><span class="p">(</span><span class="n">Model</span><span class="p">):</span>
<a id="__codelineno-34-10" name="__codelineno-34-10"></a>    <span class="nb">id</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">IntField</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-34-11" name="__codelineno-34-11"></a>    <span class="n">name</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">255</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s1">&#39;å§“å&#39;</span><span class="p">)</span>
<a id="__codelineno-34-12" name="__codelineno-34-12"></a>    <span class="n">tno</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">IntField</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s1">&#39;è´¦å·&#39;</span><span class="p">)</span>
<a id="__codelineno-34-13" name="__codelineno-34-13"></a>    <span class="n">pwd</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">255</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s1">&#39;å¯†ç &#39;</span><span class="p">)</span>
<a id="__codelineno-34-14" name="__codelineno-34-14"></a>
<a id="__codelineno-34-15" name="__codelineno-34-15"></a>
<a id="__codelineno-34-16" name="__codelineno-34-16"></a><span class="k">class</span><span class="w"> </span><span class="nc">Student</span><span class="p">(</span><span class="n">Model</span><span class="p">):</span>
<a id="__codelineno-34-17" name="__codelineno-34-17"></a>    <span class="nb">id</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">IntField</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-34-18" name="__codelineno-34-18"></a>    <span class="n">sno</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">IntField</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s1">&#39;å­¦å·&#39;</span><span class="p">)</span>
<a id="__codelineno-34-19" name="__codelineno-34-19"></a>    <span class="n">pwd</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">255</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s1">&#39;å¯†ç &#39;</span><span class="p">)</span>
<a id="__codelineno-34-20" name="__codelineno-34-20"></a>    <span class="n">name</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">255</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s1">&#39;å§“å&#39;</span><span class="p">)</span>
<a id="__codelineno-34-21" name="__codelineno-34-21"></a>    <span class="c1"># ä¸€å¯¹å¤š</span>
<a id="__codelineno-34-22" name="__codelineno-34-22"></a>    <span class="n">clas</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">ForeignKeyField</span><span class="p">(</span><span class="s1">&#39;models.Clas&#39;</span><span class="p">,</span> <span class="n">related_name</span><span class="o">=</span><span class="s1">&#39;students&#39;</span><span class="p">)</span>
<a id="__codelineno-34-23" name="__codelineno-34-23"></a>    <span class="c1"># å¤šå¯¹å¤š</span>
<a id="__codelineno-34-24" name="__codelineno-34-24"></a>    <span class="n">courses</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">ManyToManyField</span><span class="p">(</span><span class="s1">&#39;models.Course&#39;</span><span class="p">,</span> <span class="n">related_name</span><span class="o">=</span><span class="s1">&#39;students&#39;</span><span class="p">,</span><span class="n">description</span><span class="o">=</span><span class="s1">&#39;å­¦ç”Ÿé€‰è¯¾è¡¨&#39;</span><span class="p">)</span>
<a id="__codelineno-34-25" name="__codelineno-34-25"></a>
<a id="__codelineno-34-26" name="__codelineno-34-26"></a>
<a id="__codelineno-34-27" name="__codelineno-34-27"></a><span class="k">class</span><span class="w"> </span><span class="nc">Course</span><span class="p">(</span><span class="n">Model</span><span class="p">):</span>
<a id="__codelineno-34-28" name="__codelineno-34-28"></a>    <span class="nb">id</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">IntField</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-34-29" name="__codelineno-34-29"></a>    <span class="n">name</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">255</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s1">&#39;è¯¾ç¨‹å&#39;</span><span class="p">)</span>
<a id="__codelineno-34-30" name="__codelineno-34-30"></a>    <span class="n">teacher</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">ForeignKeyField</span><span class="p">(</span><span class="s1">&#39;models.Teacher&#39;</span><span class="p">,</span> <span class="n">related_name</span><span class="o">=</span><span class="s1">&#39;courses&#39;</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s1">&#39;è¯¾ç¨‹è®²å¸ˆ&#39;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
<h3 id="62aerichè¿ç§»å·¥å…·"><font style="color:rgb(51, 51, 51);">6.2ã€aerichè¿ç§»å·¥å…·</font><a class="headerlink" href="#62aerichè¿ç§»å·¥å…·" title="Permanent link">&para;</a></h3>
<p><code>&lt;font style="color:rgb(51, 51, 51);background-color:rgb(243, 244, 244);"&gt;main.py&lt;/font&gt;</code></p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Python</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-35-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-35-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-35-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-35-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-35-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-35-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-35-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-35-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-35-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-35-10">10</a></span>
<span class="normal"><a href="#__codelineno-35-11">11</a></span>
<span class="normal"><a href="#__codelineno-35-12">12</a></span>
<span class="normal"><a href="#__codelineno-35-13">13</a></span>
<span class="normal"><a href="#__codelineno-35-14">14</a></span>
<span class="normal"><a href="#__codelineno-35-15">15</a></span>
<span class="normal"><a href="#__codelineno-35-16">16</a></span>
<span class="normal"><a href="#__codelineno-35-17">17</a></span>
<span class="normal"><a href="#__codelineno-35-18">18</a></span>
<span class="normal"><a href="#__codelineno-35-19">19</a></span>
<span class="normal"><a href="#__codelineno-35-20">20</a></span>
<span class="normal"><a href="#__codelineno-35-21">21</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-35-1" name="__codelineno-35-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">uvicorn</span>
<a id="__codelineno-35-2" name="__codelineno-35-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">fastapi</span><span class="w"> </span><span class="kn">import</span> <span class="n">FastAPI</span>
<a id="__codelineno-35-3" name="__codelineno-35-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">tortoise.contrib.fastapi</span><span class="w"> </span><span class="kn">import</span> <span class="n">register_tortoise</span>
<a id="__codelineno-35-4" name="__codelineno-35-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">settings</span><span class="w"> </span><span class="kn">import</span> <span class="n">TORTOISE_ORM</span>
<a id="__codelineno-35-5" name="__codelineno-35-5"></a>
<a id="__codelineno-35-6" name="__codelineno-35-6"></a>
<a id="__codelineno-35-7" name="__codelineno-35-7"></a><span class="n">app</span> <span class="o">=</span> <span class="n">FastAPI</span><span class="p">()</span>
<a id="__codelineno-35-8" name="__codelineno-35-8"></a>
<a id="__codelineno-35-9" name="__codelineno-35-9"></a><span class="c1"># è¯¥æ–¹æ³•ä¼šåœ¨fastapiå¯åŠ¨æ—¶è§¦å‘ï¼Œå†…éƒ¨é€šè¿‡ä¼ é€’è¿›å»çš„appå¯¹è±¡ï¼Œç›‘å¬æœåŠ¡å¯åŠ¨å’Œç»ˆæ­¢äº‹ä»¶</span>
<a id="__codelineno-35-10" name="__codelineno-35-10"></a><span class="c1"># å½“æ£€æµ‹åˆ°å¯åŠ¨äº‹ä»¶æ—¶ï¼Œä¼šåˆå§‹åŒ–Tortoiseå¯¹è±¡ï¼Œå¦‚æœgenerate_schemasä¸ºTrueåˆ™è¿˜ä¼šè¿›è¡Œæ•°æ®åº“è¿ç§»</span>
<a id="__codelineno-35-11" name="__codelineno-35-11"></a><span class="c1"># å½“æ£€æµ‹åˆ°ç»ˆæ­¢äº‹ä»¶æ—¶ï¼Œä¼šå…³é—­è¿æ¥</span>
<a id="__codelineno-35-12" name="__codelineno-35-12"></a><span class="n">register_tortoise</span><span class="p">(</span>
<a id="__codelineno-35-13" name="__codelineno-35-13"></a>    <span class="n">app</span><span class="p">,</span>
<a id="__codelineno-35-14" name="__codelineno-35-14"></a>    <span class="n">config</span><span class="o">=</span><span class="n">TORTOISE_ORM</span><span class="p">,</span>
<a id="__codelineno-35-15" name="__codelineno-35-15"></a>    <span class="c1"># generate_schemas=True,  # å¦‚æœæ•°æ®åº“ä¸ºç©ºï¼Œåˆ™è‡ªåŠ¨ç”Ÿæˆå¯¹åº”è¡¨å•ï¼Œç”Ÿäº§ç¯å¢ƒä¸è¦å¼€</span>
<a id="__codelineno-35-16" name="__codelineno-35-16"></a>    <span class="c1"># add_exception_handlers=True,  # ç”Ÿäº§ç¯å¢ƒä¸è¦å¼€ï¼Œä¼šæ³„éœ²è°ƒè¯•ä¿¡æ¯</span>
<a id="__codelineno-35-17" name="__codelineno-35-17"></a><span class="p">)</span>
<a id="__codelineno-35-18" name="__codelineno-35-18"></a>
<a id="__codelineno-35-19" name="__codelineno-35-19"></a><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
<a id="__codelineno-35-20" name="__codelineno-35-20"></a>    <span class="n">uvicorn</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s1">&#39;main:app&#39;</span><span class="p">,</span> <span class="n">host</span><span class="o">=</span><span class="s1">&#39;127.0.0.1&#39;</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">8000</span><span class="p">,</span> <span class="n">reload</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-35-21" name="__codelineno-35-21"></a>                <span class="n">debug</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">workers</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
<p><code>&lt;font style="color:rgb(51, 51, 51);background-color:rgb(243, 244, 244);"&gt;settings.py&lt;/font&gt;</code></p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Python</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-36-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-36-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-36-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-36-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-36-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-36-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-36-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-36-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-36-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-36-10">10</a></span>
<span class="normal"><a href="#__codelineno-36-11">11</a></span>
<span class="normal"><a href="#__codelineno-36-12">12</a></span>
<span class="normal"><a href="#__codelineno-36-13">13</a></span>
<span class="normal"><a href="#__codelineno-36-14">14</a></span>
<span class="normal"><a href="#__codelineno-36-15">15</a></span>
<span class="normal"><a href="#__codelineno-36-16">16</a></span>
<span class="normal"><a href="#__codelineno-36-17">17</a></span>
<span class="normal"><a href="#__codelineno-36-18">18</a></span>
<span class="normal"><a href="#__codelineno-36-19">19</a></span>
<span class="normal"><a href="#__codelineno-36-20">20</a></span>
<span class="normal"><a href="#__codelineno-36-21">21</a></span>
<span class="normal"><a href="#__codelineno-36-22">22</a></span>
<span class="normal"><a href="#__codelineno-36-23">23</a></span>
<span class="normal"><a href="#__codelineno-36-24">24</a></span>
<span class="normal"><a href="#__codelineno-36-25">25</a></span>
<span class="normal"><a href="#__codelineno-36-26">26</a></span>
<span class="normal"><a href="#__codelineno-36-27">27</a></span>
<span class="normal"><a href="#__codelineno-36-28">28</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-36-1" name="__codelineno-36-1"></a><span class="n">TORTOISE_ORM</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-36-2" name="__codelineno-36-2"></a>    <span class="s1">&#39;connections&#39;</span><span class="p">:</span> <span class="p">{</span>
<a id="__codelineno-36-3" name="__codelineno-36-3"></a>        <span class="s1">&#39;default&#39;</span><span class="p">:</span> <span class="p">{</span>
<a id="__codelineno-36-4" name="__codelineno-36-4"></a>            <span class="c1"># &#39;engine&#39;: &#39;tortoise.backends.asyncpg&#39;,  PostgreSQL</span>
<a id="__codelineno-36-5" name="__codelineno-36-5"></a>            <span class="s1">&#39;engine&#39;</span><span class="p">:</span> <span class="s1">&#39;tortoise.backends.mysql&#39;</span><span class="p">,</span>  <span class="c1"># MySQL or Mariadb</span>
<a id="__codelineno-36-6" name="__codelineno-36-6"></a>            <span class="s1">&#39;credentials&#39;</span><span class="p">:</span> <span class="p">{</span>
<a id="__codelineno-36-7" name="__codelineno-36-7"></a>                <span class="s1">&#39;host&#39;</span><span class="p">:</span> <span class="s1">&#39;127.0.0.1&#39;</span><span class="p">,</span>
<a id="__codelineno-36-8" name="__codelineno-36-8"></a>                <span class="s1">&#39;port&#39;</span><span class="p">:</span> <span class="s1">&#39;3306&#39;</span><span class="p">,</span>
<a id="__codelineno-36-9" name="__codelineno-36-9"></a>                <span class="s1">&#39;user&#39;</span><span class="p">:</span> <span class="s1">&#39;root&#39;</span><span class="p">,</span>
<a id="__codelineno-36-10" name="__codelineno-36-10"></a>                <span class="s1">&#39;password&#39;</span><span class="p">:</span> <span class="s1">&#39;yuan0316&#39;</span><span class="p">,</span>
<a id="__codelineno-36-11" name="__codelineno-36-11"></a>                <span class="s1">&#39;database&#39;</span><span class="p">:</span> <span class="s1">&#39;fastapi&#39;</span><span class="p">,</span>
<a id="__codelineno-36-12" name="__codelineno-36-12"></a>                <span class="s1">&#39;minsize&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
<a id="__codelineno-36-13" name="__codelineno-36-13"></a>                <span class="s1">&#39;maxsize&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
<a id="__codelineno-36-14" name="__codelineno-36-14"></a>                <span class="s1">&#39;charset&#39;</span><span class="p">:</span> <span class="s1">&#39;utf8mb4&#39;</span><span class="p">,</span>
<a id="__codelineno-36-15" name="__codelineno-36-15"></a>                <span class="s2">&quot;echo&quot;</span><span class="p">:</span> <span class="kc">True</span>
<a id="__codelineno-36-16" name="__codelineno-36-16"></a>            <span class="p">}</span>
<a id="__codelineno-36-17" name="__codelineno-36-17"></a>        <span class="p">},</span>
<a id="__codelineno-36-18" name="__codelineno-36-18"></a>    <span class="p">},</span>
<a id="__codelineno-36-19" name="__codelineno-36-19"></a>    <span class="s1">&#39;apps&#39;</span><span class="p">:</span> <span class="p">{</span>
<a id="__codelineno-36-20" name="__codelineno-36-20"></a>        <span class="s1">&#39;models&#39;</span><span class="p">:</span> <span class="p">{</span>
<a id="__codelineno-36-21" name="__codelineno-36-21"></a>            <span class="s1">&#39;models&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;models&#39;</span><span class="p">,</span> <span class="s2">&quot;aerich.models&quot;</span><span class="p">],</span>
<a id="__codelineno-36-22" name="__codelineno-36-22"></a>            <span class="s1">&#39;default_connection&#39;</span><span class="p">:</span> <span class="s1">&#39;default&#39;</span><span class="p">,</span>
<a id="__codelineno-36-23" name="__codelineno-36-23"></a>
<a id="__codelineno-36-24" name="__codelineno-36-24"></a>        <span class="p">}</span>
<a id="__codelineno-36-25" name="__codelineno-36-25"></a>    <span class="p">},</span>
<a id="__codelineno-36-26" name="__codelineno-36-26"></a>    <span class="s1">&#39;use_tz&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-36-27" name="__codelineno-36-27"></a>    <span class="s1">&#39;timezone&#39;</span><span class="p">:</span> <span class="s1">&#39;Asia/Shanghai&#39;</span>
<a id="__codelineno-36-28" name="__codelineno-36-28"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p><code>&lt;font style="color:rgb(51, 51, 51);background-color:rgb(243, 244, 244);"&gt;aerich&lt;/font&gt;</code><font style="color:rgb(51, 51, 51);">æ˜¯ä¸€ç§</font><a href="https://so.csdn.net/so/search?q=ORM&amp;spm=1001.2101.3001.7020"><font style="color:rgb(51, 51, 51);">ORM</font></a><font style="color:rgb(51, 51, 51);">è¿ç§»å·¥å…·ï¼Œéœ€è¦ç»“åˆ</font><code>&lt;font style="color:rgb(51, 51, 51);background-color:rgb(243, 244, 244);"&gt;tortoise&lt;/font&gt;</code><font style="color:rgb(51, 51, 51);">å¼‚æ­¥ormæ¡†æ¶ä½¿ç”¨ã€‚å®‰è£…</font><code>&lt;font style="color:rgb(51, 51, 51);background-color:rgb(243, 244, 244);"&gt;aerich&lt;/font&gt;</code></p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Python</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-37-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-37-1" name="__codelineno-37-1"></a><span class="n">pip</span> <span class="n">install</span> <span class="n">aerich</span>
</code></pre></div></td></tr></table></div>
<h4 id="1-åˆå§‹åŒ–é…ç½®åªéœ€è¦ä½¿ç”¨ä¸€æ¬¡"><font style="color:rgb(51, 51, 51);">1. åˆå§‹åŒ–é…ç½®ï¼Œåªéœ€è¦ä½¿ç”¨ä¸€æ¬¡</font><a class="headerlink" href="#1-åˆå§‹åŒ–é…ç½®åªéœ€è¦ä½¿ç”¨ä¸€æ¬¡" title="Permanent link">&para;</a></h4>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Python</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-38-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-38-1" name="__codelineno-38-1"></a><span class="n">aerich</span> <span class="n">init</span> <span class="o">-</span><span class="n">t</span> <span class="n">settings</span><span class="o">.</span><span class="n">TORTOISE_ORM</span>  <span class="c1"># TORTOISE_ORMé…ç½®çš„ä½ç½®)</span>
</code></pre></div></td></tr></table></div>
<p><font style="color:rgb(119, 119, 119);">åˆå§‹åŒ–å®Œä¼šåœ¨å½“å‰ç›®å½•ç”Ÿæˆä¸€ä¸ªæ–‡ä»¶ï¼špyproject.tomlå’Œä¸€ä¸ªæ–‡ä»¶å¤¹ï¼šmigrations</font></p>
<ul>
<li><code>&lt;font style="color:rgb(119, 119, 119);background-color:rgb(243, 244, 244);"&gt;pyproject.toml&lt;/font&gt;</code><font style="color:rgb(119, 119, 119);">ï¼šä¿å­˜é…ç½®æ–‡ä»¶è·¯å¾„ï¼Œä½ç‰ˆæœ¬å¯èƒ½æ˜¯</font><code>&lt;font style="color:rgb(119, 119, 119);background-color:rgb(243, 244, 244);"&gt;aerich.ini&lt;/font&gt;</code></li>
<li><code>&lt;font style="color:rgb(119, 119, 119);background-color:rgb(243, 244, 244);"&gt;migrations&lt;/font&gt;</code><font style="color:rgb(119, 119, 119);">ï¼šå­˜æ”¾è¿ç§»æ–‡ä»¶</font></li>
<li><img alt="" src="../../../../images/1721480694981-4a90beb0-9650-4086-9e8f-3037a49f10e8.png" /></li>
</ul>
<h4 id="2-åˆå§‹åŒ–æ•°æ®åº“ä¸€èˆ¬æƒ…å†µä¸‹åªç”¨ä¸€æ¬¡"><font style="color:rgb(51, 51, 51);">2. åˆå§‹åŒ–æ•°æ®åº“ï¼Œä¸€èˆ¬æƒ…å†µä¸‹åªç”¨ä¸€æ¬¡</font><a class="headerlink" href="#2-åˆå§‹åŒ–æ•°æ®åº“ä¸€èˆ¬æƒ…å†µä¸‹åªç”¨ä¸€æ¬¡" title="Permanent link">&para;</a></h4>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Python</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-39-1">1</a></span>
<span class="normal"><a href="#__codelineno-39-2">2</a></span>
<span class="normal"><a href="#__codelineno-39-3">3</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-39-1" name="__codelineno-39-1"></a><span class="o">&gt;</span> <span class="n">aerich</span> <span class="n">init</span><span class="o">-</span><span class="n">db</span>
<a id="__codelineno-39-2" name="__codelineno-39-2"></a><span class="n">Success</span> <span class="n">create</span> <span class="n">app</span> <span class="n">migrate</span> <span class="n">location</span> <span class="n">migrations</span>\<span class="n">models</span>
<a id="__codelineno-39-3" name="__codelineno-39-3"></a><span class="n">Success</span> <span class="n">generate</span> <span class="n">schema</span> <span class="k">for</span> <span class="n">app</span> <span class="s2">&quot;models&quot;</span>
</code></pre></div></td></tr></table></div>
<ol>
<li><font style="color:rgb(119, 119, 119);">æ­¤æ—¶æ•°æ®åº“ä¸­å°±æœ‰ç›¸åº”çš„è¡¨æ ¼</font></li>
<li><font style="color:rgb(119, 119, 119);">å¦‚æœ</font><code>&lt;font style="color:rgb(119, 119, 119);background-color:rgb(243, 244, 244);"&gt;TORTOISE_ORM&lt;/font&gt;</code><font style="color:rgb(119, 119, 119);">é…ç½®æ–‡ä»¶ä¸­çš„</font><code>&lt;font style="color:rgb(119, 119, 119);background-color:rgb(243, 244, 244);"&gt;models&lt;/font&gt;</code><font style="color:rgb(119, 119, 119);">æ”¹äº†åï¼Œåˆ™æ‰§è¡Œè¿™æ¡å‘½ä»¤æ—¶éœ€è¦å¢åŠ </font><code>&lt;font style="color:rgb(119, 119, 119);background-color:rgb(243, 244, 244);"&gt;--app&lt;/font&gt;</code><font style="color:rgb(119, 119, 119);">å‚æ•°ï¼Œæ¥æŒ‡å®šä½ ä¿®æ”¹çš„åå­—</font></li>
</ol>
<p><img alt="" src="../../../../images/1721480735145-9bfe9eaf-38e1-4090-94f7-f824ac70869a.png" /></p>
<h4 id="3-æ›´æ–°æ¨¡å‹å¹¶è¿›è¡Œè¿ç§»"><font style="color:rgb(51, 51, 51);">3. æ›´æ–°æ¨¡å‹å¹¶è¿›è¡Œè¿ç§»</font><a class="headerlink" href="#3-æ›´æ–°æ¨¡å‹å¹¶è¿›è¡Œè¿ç§»" title="Permanent link">&para;</a></h4>
<p><font style="color:rgb(51, 51, 51);">ä¿®æ”¹modelç±»ï¼Œé‡æ–°ç”Ÿæˆè¿ç§»æ–‡ä»¶,æ¯”å¦‚æ·»åŠ ä¸€ä¸ªå­—æ®µ</font></p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Python</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-40-1">1</a></span>
<span class="normal"><a href="#__codelineno-40-2">2</a></span>
<span class="normal"><a href="#__codelineno-40-3">3</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-40-1" name="__codelineno-40-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">Admin</span><span class="p">(</span><span class="n">Model</span><span class="p">):</span>
<a id="__codelineno-40-2" name="__codelineno-40-2"></a>    <span class="o">...</span>
<a id="__codelineno-40-3" name="__codelineno-40-3"></a>    <span class="n">xxx</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">255</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Python</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-41-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-41-1" name="__codelineno-41-1"></a><span class="n">aerich</span> <span class="n">migrate</span> <span class="p">[</span><span class="o">--</span><span class="n">name</span><span class="p">]</span> <span class="p">(</span><span class="n">æ ‡è®°ä¿®æ”¹æ“ä½œ</span><span class="p">)</span> <span class="c1">#  aerich migrate --name add_column</span>
</code></pre></div></td></tr></table></div>
<p><font style="color:rgb(119, 119, 119);">è¿ç§»æ–‡ä»¶åçš„æ ¼å¼ä¸º {version_num}</font><em><font style="color:rgb(119, 119, 119);">{datetime}</font></em><font style="color:rgb(119, 119, 119);">{name|update}.jsonã€‚</font><img alt="" src="../../../../images/1721480751687-0e378d0c-b8ee-4818-b722-0d07a1c83816.png" /><font style="color:rgb(51, 51, 51);">æ³¨æ„ï¼Œæ­¤æ—¶sqlå¹¶æ²¡æœ‰æ‰§è¡Œï¼Œæ•°æ®åº“ä¸­adminè¡¨ä¸­æ²¡æœ‰xxxå­—æ®µ</font><img alt="" src="../../../../images/1721480762908-ef361211-a140-4a02-8cba-58b43a3fa421.png" /></p>
<h4 id="4-é‡æ–°æ‰§è¡Œè¿ç§»å†™å…¥æ•°æ®åº“"><font style="color:rgb(51, 51, 51);">4. é‡æ–°æ‰§è¡Œè¿ç§»ï¼Œå†™å…¥æ•°æ®åº“</font><a class="headerlink" href="#4-é‡æ–°æ‰§è¡Œè¿ç§»å†™å…¥æ•°æ®åº“" title="Permanent link">&para;</a></h4>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Python</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-42-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-42-1" name="__codelineno-42-1"></a><span class="n">aerich</span> <span class="n">upgrade</span>
</code></pre></div></td></tr></table></div>
<p><img alt="" src="../../../../images/1721480782388-2c2ff148-b2e1-4c66-8495-761908678a93.png" /></p>
<h4 id="5-å›åˆ°ä¸Šä¸€ä¸ªç‰ˆæœ¬"><font style="color:rgb(51, 51, 51);">5. å›åˆ°ä¸Šä¸€ä¸ªç‰ˆæœ¬</font><a class="headerlink" href="#5-å›åˆ°ä¸Šä¸€ä¸ªç‰ˆæœ¬" title="Permanent link">&para;</a></h4>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Python</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-43-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-43-1" name="__codelineno-43-1"></a><span class="n">aerich</span> <span class="n">downgrade</span>
</code></pre></div></td></tr></table></div>
<h4 id="6-æŸ¥çœ‹å†å²è¿ç§»è®°å½•"><font style="color:rgb(51, 51, 51);">6. æŸ¥çœ‹å†å²è¿ç§»è®°å½•</font><a class="headerlink" href="#6-æŸ¥çœ‹å†å²è¿ç§»è®°å½•" title="Permanent link">&para;</a></h4>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Python</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-44-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-44-1" name="__codelineno-44-1"></a><span class="n">aerich</span> <span class="n">history</span>
</code></pre></div></td></tr></table></div>
<p><img alt="" src="../../../../images/1721480813944-f4f537bf-28e4-4588-9c67-e969a8e538c3.png" /></p>
<h3 id="63apiæ¥å£ä¸restfulè§„èŒƒ"><font style="color:rgb(51, 51, 51);">6.3ã€apiæ¥å£ä¸restfulè§„èŒƒ</font><a class="headerlink" href="#63apiæ¥å£ä¸restfulè§„èŒƒ" title="Permanent link">&para;</a></h3>
<h4 id="apiæ¥å£"><font style="color:rgb(51, 51, 51);">apiæ¥å£</font><a class="headerlink" href="#apiæ¥å£" title="Permanent link">&para;</a></h4>
<p><font style="color:rgb(51, 51, 51);">åº”ç”¨ç¨‹åºç¼–ç¨‹æ¥å£ï¼ˆApplication Programming Interfaceï¼ŒAPIæ¥å£ï¼‰ï¼Œå°±æ˜¯åº”ç”¨ç¨‹åºå¯¹å¤–æä¾›äº†ä¸€ä¸ªæ“ä½œæ•°æ®çš„å…¥å£ï¼Œè¿™ä¸ªå…¥å£å¯ä»¥æ˜¯ä¸€ä¸ªå‡½æ•°æˆ–ç±»æ–¹æ³•ï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªurlåœ°å€æˆ–è€…ä¸€ä¸ªç½‘ç»œåœ°å€ã€‚å½“å®¢æˆ·ç«¯è°ƒç”¨è¿™ä¸ªå…¥å£ï¼Œåº”ç”¨ç¨‹åºåˆ™ä¼šæ‰§è¡Œå¯¹åº”ä»£ç æ“ä½œï¼Œç»™å®¢æˆ·ç«¯å®Œæˆç›¸å¯¹åº”çš„åŠŸèƒ½ã€‚</font></p>
<p><img alt="" src="../../../../images/1721480825093-1a52f0b5-29b6-450b-adb2-41ea56e2d64b.png" /></p>
<p><font style="color:rgb(51, 51, 51);">å½“ç„¶ï¼Œapiæ¥å£åœ¨å·¥ä½œä¸­æ˜¯æ¯”è¾ƒå¸¸è§çš„å¼€å‘å†…å®¹ï¼Œæœ‰æ—¶å€™ï¼Œæˆ‘ä»¬ä¼šè°ƒç”¨å…¶ä»–äººç¼–å†™çš„apiæ¥å£ï¼Œæœ‰æ—¶å€™ï¼Œæˆ‘ä»¬ä¹Ÿéœ€è¦æä¾›apiæ¥å£ç»™å…¶ä»–äººæ“ä½œã€‚ç”±æ­¤å°±ä¼šå¸¦æ¥ä¸€ä¸ªé—®é¢˜ï¼Œapiæ¥å£å¾€å¾€éƒ½æ˜¯ä¸€ä¸ªå‡½æ•°ã€ç±»æ–¹æ³•ã€æˆ–è€…urlæˆ–å…¶ä»–ç½‘ç»œåœ°å€ï¼Œä¸æ–­æ˜¯å“ªä¸€ç§ï¼Œå½“apiæ¥å£ç¼–å†™è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬éƒ½è¦è€ƒè™‘ä¸€ä¸ªé—®é¢˜å°±æ˜¯è¿™ä¸ªæ¥å£åº”è¯¥æ€ä¹ˆç¼–å†™ï¼Ÿæ¥å£æ€ä¹ˆå†™çš„æ›´åŠ å®¹æ˜“ç»´æŠ¤å’Œæ¸…æ™°ï¼Œè¿™å°±éœ€è¦å¤§å®¶åœ¨è°ƒç”¨æˆ–è€…ç¼–å†™apiæ¥å£çš„æ—¶å€™è¦æœ‰ä¸€ä¸ªæ˜ç¡®çš„ç¼–å†™è§„èŒƒï¼ï¼ï¼</font></p>
<h4 id="restfulè§„èŒƒ"><font style="color:rgb(51, 51, 51);">restfulè§„èŒƒ</font><a class="headerlink" href="#restfulè§„èŒƒ" title="Permanent link">&para;</a></h4>
<p><font style="color:rgb(51, 51, 51);">ä¸ºäº†åœ¨å›¢é˜Ÿå†…éƒ¨å½¢æˆå…±è¯†ã€é˜²æ­¢ä¸ªäººä¹ æƒ¯å·®å¼‚å¼•èµ·çš„æ··ä¹±ï¼Œæˆ‘ä»¬éƒ½éœ€è¦æ‰¾åˆ°ä¸€ç§å¤§å®¶éƒ½è§‰å¾—å¾ˆå¥½çš„æ¥å£å®ç°è§„èŒƒï¼Œè€Œä¸”è¿™ç§è§„èŒƒèƒ½å¤Ÿè®©åç«¯å†™çš„æ¥å£ï¼Œç”¨é€”ä¸€ç›®äº†ç„¶ï¼Œå‡å°‘å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯åŒæ–¹ä¹‹é—´çš„åˆä½œæˆæœ¬ã€‚</font></p>
<p><font style="color:rgb(51, 51, 51);">ç›®å‰å¸‚é¢ä¸Šå¤§éƒ¨åˆ†å…¬å¸å¼€å‘äººå‘˜ä½¿ç”¨çš„æ¥å£å®ç°è§„èŒƒä¸»è¦æœ‰ï¼šrestfulã€RPCã€‚</font></p>
<p><font style="color:rgb(51, 51, 51);">RESTä¸æŠ€æœ¯æ— å…³ï¼Œä»£è¡¨çš„æ˜¯ä¸€ç§è½¯ä»¶æ¶æ„é£æ ¼ï¼ŒRESTæ˜¯Representational State Transferçš„ç®€ç§°ï¼Œä¸­æ–‡ç¿»è¯‘ä¸ºâ€œè¡¨å¾çŠ¶æ€è½¬ç§»â€æˆ–â€œè¡¨ç°å±‚çŠ¶æ€è½¬åŒ–â€ã€‚</font></p>
<p><font style="color:rgb(51, 51, 51);">ç®€å•æ¥è¯´ï¼ŒRESTçš„å«ä¹‰å°±æ˜¯å®¢æˆ·ç«¯ä¸WebæœåŠ¡å™¨ä¹‹é—´è¿›è¡Œäº¤äº’çš„æ—¶å€™ï¼Œä½¿ç”¨HTTPåè®®ä¸­çš„4ä¸ªè¯·æ±‚æ–¹æ³•ä»£è¡¨ä¸åŒçš„åŠ¨ä½œã€‚</font></p>
<p><font style="color:rgb(119, 119, 119);">GETç”¨æ¥è·å–èµ„æº</font></p>
<p><font style="color:rgb(119, 119, 119);">POSTç”¨æ¥æ–°å»ºèµ„æº </font></p>
<p><font style="color:rgb(119, 119, 119);">PUTç”¨æ¥æ›´æ–°èµ„æº</font></p>
<p><font style="color:rgb(119, 119, 119);">DELETEç”¨æ¥åˆ é™¤èµ„æºã€‚</font></p>
<p><font style="color:rgb(51, 51, 51);">åªè¦APIç¨‹åºéµå¾ªäº†RESTé£æ ¼ï¼Œé‚£å°±å¯ä»¥ç§°å…¶ä¸ºRESTful APIã€‚ç›®å‰åœ¨å‰åç«¯åˆ†ç¦»çš„æ¶æ„ä¸­ï¼Œå‰åç«¯åŸºæœ¬éƒ½æ˜¯é€šè¿‡RESTful APIæ¥è¿›è¡Œäº¤äº’ã€‚</font></p>
<p><font style="color:rgb(51, 51, 51);">ä¾‹å¦‚ï¼Œæˆ‘ä»¬ç°åœ¨è¦ç¼–å†™ä¸€ä¸ªé€‰è¯¾ç³»ç»Ÿçš„æ¥å£ï¼Œæˆ‘ä»¬å¯ä»¥æŸ¥è¯¢å¯¹ä¸€ä¸ªå­¦ç”Ÿè¿›è¡ŒæŸ¥è¯¢ã€åˆ›å»ºã€æ›´æ–°å’Œåˆ é™¤ç­‰æ“ä½œï¼Œæˆ‘ä»¬åœ¨ç¼–å†™ç¨‹åºçš„æ—¶å€™å°±è¦è®¾è®¡å®¢æˆ·ç«¯æµè§ˆå™¨ä¸æˆ‘ä»¬WebæœåŠ¡ç«¯äº¤äº’çš„æ–¹å¼å’Œè·¯å¾„ã€‚</font></p>
<p><font style="color:rgb(51, 51, 51);">è€Œå¯¹äºæ•°æ®èµ„æºåˆ†åˆ«ä½¿ç”¨POSTã€DELETEã€GETã€UPDATEç­‰è¯·æ±‚åŠ¨ä½œæ¥è¡¨è¾¾å¯¹æ•°æ®çš„å¢åˆ æŸ¥æ”¹ã€‚</font></p>
<table>
<thead>
<tr>
<th style="text-align: left;"><strong><font style="color:rgb(51, 51, 51);">GET</font></strong></th>
<th style="text-align: left;"><strong><font style="color:rgb(51, 51, 51);">/students</font></strong></th>
<th style="text-align: left;"><strong><font style="color:rgb(51, 51, 51);">è·å–æ‰€æœ‰å­¦ç”Ÿ</font></strong></th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><font style="color:rgb(51, 51, 51);">è¯·æ±‚æ–¹æ³•</font></td>
<td style="text-align: left;"><font style="color:rgb(51, 51, 51);">è¯·æ±‚åœ°å€</font></td>
<td style="text-align: left;"><font style="color:rgb(51, 51, 51);">åç«¯æ“ä½œ</font></td>
</tr>
<tr>
<td style="text-align: left;"><font style="color:rgb(51, 51, 51);">GET</font></td>
<td style="text-align: left;"><font style="color:rgb(51, 51, 51);">/students</font></td>
<td style="text-align: left;"><font style="color:rgb(51, 51, 51);">è·å–æ‰€æœ‰å­¦ç”Ÿ</font></td>
</tr>
<tr>
<td style="text-align: left;"><font style="color:rgb(51, 51, 51);">POST</font></td>
<td style="text-align: left;"><font style="color:rgb(51, 51, 51);">/students</font></td>
<td style="text-align: left;"><font style="color:rgb(51, 51, 51);">å¢åŠ å­¦ç”Ÿ</font></td>
</tr>
<tr>
<td style="text-align: left;"><font style="color:rgb(51, 51, 51);">GET</font></td>
<td style="text-align: left;"><font style="color:rgb(51, 51, 51);">/students/1</font></td>
<td style="text-align: left;"><font style="color:rgb(51, 51, 51);">è·å–ç¼–å·ä¸º1çš„å­¦ç”Ÿ</font></td>
</tr>
<tr>
<td style="text-align: left;"><font style="color:rgb(51, 51, 51);">PUT</font></td>
<td style="text-align: left;"><font style="color:rgb(51, 51, 51);">/students/1</font></td>
<td style="text-align: left;"><font style="color:rgb(51, 51, 51);">ä¿®æ”¹ç¼–å·ä¸º1çš„å­¦ç”Ÿ</font></td>
</tr>
<tr>
<td style="text-align: left;"><font style="color:rgb(51, 51, 51);">DELETE</font></td>
<td style="text-align: left;"><font style="color:rgb(51, 51, 51);">/students/1</font></td>
<td style="text-align: left;"><font style="color:rgb(51, 51, 51);">åˆ é™¤ç¼–å·ä¸º1çš„å­¦ç”Ÿ</font></td>
</tr>
</tbody>
</table>
<h3 id="64é€‰è¯¾ç³»ç»Ÿæ¥å£å¼€å‘"><font style="color:rgb(51, 51, 51);">6.4ã€é€‰è¯¾ç³»ç»Ÿæ¥å£å¼€å‘</font><a class="headerlink" href="#64é€‰è¯¾ç³»ç»Ÿæ¥å£å¼€å‘" title="Permanent link">&para;</a></h3>
<p><code>&lt;font style="color:rgb(51, 51, 51);background-color:rgb(243, 244, 244);"&gt;api/student.py&lt;/font&gt;</code></p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Python</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-45-1">  1</a></span>
<span class="normal"><a href="#__codelineno-45-2">  2</a></span>
<span class="normal"><a href="#__codelineno-45-3">  3</a></span>
<span class="normal"><a href="#__codelineno-45-4">  4</a></span>
<span class="normal"><a href="#__codelineno-45-5">  5</a></span>
<span class="normal"><a href="#__codelineno-45-6">  6</a></span>
<span class="normal"><a href="#__codelineno-45-7">  7</a></span>
<span class="normal"><a href="#__codelineno-45-8">  8</a></span>
<span class="normal"><a href="#__codelineno-45-9">  9</a></span>
<span class="normal"><a href="#__codelineno-45-10"> 10</a></span>
<span class="normal"><a href="#__codelineno-45-11"> 11</a></span>
<span class="normal"><a href="#__codelineno-45-12"> 12</a></span>
<span class="normal"><a href="#__codelineno-45-13"> 13</a></span>
<span class="normal"><a href="#__codelineno-45-14"> 14</a></span>
<span class="normal"><a href="#__codelineno-45-15"> 15</a></span>
<span class="normal"><a href="#__codelineno-45-16"> 16</a></span>
<span class="normal"><a href="#__codelineno-45-17"> 17</a></span>
<span class="normal"><a href="#__codelineno-45-18"> 18</a></span>
<span class="normal"><a href="#__codelineno-45-19"> 19</a></span>
<span class="normal"><a href="#__codelineno-45-20"> 20</a></span>
<span class="normal"><a href="#__codelineno-45-21"> 21</a></span>
<span class="normal"><a href="#__codelineno-45-22"> 22</a></span>
<span class="normal"><a href="#__codelineno-45-23"> 23</a></span>
<span class="normal"><a href="#__codelineno-45-24"> 24</a></span>
<span class="normal"><a href="#__codelineno-45-25"> 25</a></span>
<span class="normal"><a href="#__codelineno-45-26"> 26</a></span>
<span class="normal"><a href="#__codelineno-45-27"> 27</a></span>
<span class="normal"><a href="#__codelineno-45-28"> 28</a></span>
<span class="normal"><a href="#__codelineno-45-29"> 29</a></span>
<span class="normal"><a href="#__codelineno-45-30"> 30</a></span>
<span class="normal"><a href="#__codelineno-45-31"> 31</a></span>
<span class="normal"><a href="#__codelineno-45-32"> 32</a></span>
<span class="normal"><a href="#__codelineno-45-33"> 33</a></span>
<span class="normal"><a href="#__codelineno-45-34"> 34</a></span>
<span class="normal"><a href="#__codelineno-45-35"> 35</a></span>
<span class="normal"><a href="#__codelineno-45-36"> 36</a></span>
<span class="normal"><a href="#__codelineno-45-37"> 37</a></span>
<span class="normal"><a href="#__codelineno-45-38"> 38</a></span>
<span class="normal"><a href="#__codelineno-45-39"> 39</a></span>
<span class="normal"><a href="#__codelineno-45-40"> 40</a></span>
<span class="normal"><a href="#__codelineno-45-41"> 41</a></span>
<span class="normal"><a href="#__codelineno-45-42"> 42</a></span>
<span class="normal"><a href="#__codelineno-45-43"> 43</a></span>
<span class="normal"><a href="#__codelineno-45-44"> 44</a></span>
<span class="normal"><a href="#__codelineno-45-45"> 45</a></span>
<span class="normal"><a href="#__codelineno-45-46"> 46</a></span>
<span class="normal"><a href="#__codelineno-45-47"> 47</a></span>
<span class="normal"><a href="#__codelineno-45-48"> 48</a></span>
<span class="normal"><a href="#__codelineno-45-49"> 49</a></span>
<span class="normal"><a href="#__codelineno-45-50"> 50</a></span>
<span class="normal"><a href="#__codelineno-45-51"> 51</a></span>
<span class="normal"><a href="#__codelineno-45-52"> 52</a></span>
<span class="normal"><a href="#__codelineno-45-53"> 53</a></span>
<span class="normal"><a href="#__codelineno-45-54"> 54</a></span>
<span class="normal"><a href="#__codelineno-45-55"> 55</a></span>
<span class="normal"><a href="#__codelineno-45-56"> 56</a></span>
<span class="normal"><a href="#__codelineno-45-57"> 57</a></span>
<span class="normal"><a href="#__codelineno-45-58"> 58</a></span>
<span class="normal"><a href="#__codelineno-45-59"> 59</a></span>
<span class="normal"><a href="#__codelineno-45-60"> 60</a></span>
<span class="normal"><a href="#__codelineno-45-61"> 61</a></span>
<span class="normal"><a href="#__codelineno-45-62"> 62</a></span>
<span class="normal"><a href="#__codelineno-45-63"> 63</a></span>
<span class="normal"><a href="#__codelineno-45-64"> 64</a></span>
<span class="normal"><a href="#__codelineno-45-65"> 65</a></span>
<span class="normal"><a href="#__codelineno-45-66"> 66</a></span>
<span class="normal"><a href="#__codelineno-45-67"> 67</a></span>
<span class="normal"><a href="#__codelineno-45-68"> 68</a></span>
<span class="normal"><a href="#__codelineno-45-69"> 69</a></span>
<span class="normal"><a href="#__codelineno-45-70"> 70</a></span>
<span class="normal"><a href="#__codelineno-45-71"> 71</a></span>
<span class="normal"><a href="#__codelineno-45-72"> 72</a></span>
<span class="normal"><a href="#__codelineno-45-73"> 73</a></span>
<span class="normal"><a href="#__codelineno-45-74"> 74</a></span>
<span class="normal"><a href="#__codelineno-45-75"> 75</a></span>
<span class="normal"><a href="#__codelineno-45-76"> 76</a></span>
<span class="normal"><a href="#__codelineno-45-77"> 77</a></span>
<span class="normal"><a href="#__codelineno-45-78"> 78</a></span>
<span class="normal"><a href="#__codelineno-45-79"> 79</a></span>
<span class="normal"><a href="#__codelineno-45-80"> 80</a></span>
<span class="normal"><a href="#__codelineno-45-81"> 81</a></span>
<span class="normal"><a href="#__codelineno-45-82"> 82</a></span>
<span class="normal"><a href="#__codelineno-45-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-45-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-45-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-45-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-45-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-45-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-45-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-45-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-45-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-45-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-45-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-45-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-45-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-45-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-45-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-45-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-45-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-45-100">100</a></span>
<span class="normal"><a href="#__codelineno-45-101">101</a></span>
<span class="normal"><a href="#__codelineno-45-102">102</a></span>
<span class="normal"><a href="#__codelineno-45-103">103</a></span>
<span class="normal"><a href="#__codelineno-45-104">104</a></span>
<span class="normal"><a href="#__codelineno-45-105">105</a></span>
<span class="normal"><a href="#__codelineno-45-106">106</a></span>
<span class="normal"><a href="#__codelineno-45-107">107</a></span>
<span class="normal"><a href="#__codelineno-45-108">108</a></span>
<span class="normal"><a href="#__codelineno-45-109">109</a></span>
<span class="normal"><a href="#__codelineno-45-110">110</a></span>
<span class="normal"><a href="#__codelineno-45-111">111</a></span>
<span class="normal"><a href="#__codelineno-45-112">112</a></span>
<span class="normal"><a href="#__codelineno-45-113">113</a></span>
<span class="normal"><a href="#__codelineno-45-114">114</a></span>
<span class="normal"><a href="#__codelineno-45-115">115</a></span>
<span class="normal"><a href="#__codelineno-45-116">116</a></span>
<span class="normal"><a href="#__codelineno-45-117">117</a></span>
<span class="normal"><a href="#__codelineno-45-118">118</a></span>
<span class="normal"><a href="#__codelineno-45-119">119</a></span>
<span class="normal"><a href="#__codelineno-45-120">120</a></span>
<span class="normal"><a href="#__codelineno-45-121">121</a></span>
<span class="normal"><a href="#__codelineno-45-122">122</a></span>
<span class="normal"><a href="#__codelineno-45-123">123</a></span>
<span class="normal"><a href="#__codelineno-45-124">124</a></span>
<span class="normal"><a href="#__codelineno-45-125">125</a></span>
<span class="normal"><a href="#__codelineno-45-126">126</a></span>
<span class="normal"><a href="#__codelineno-45-127">127</a></span>
<span class="normal"><a href="#__codelineno-45-128">128</a></span>
<span class="normal"><a href="#__codelineno-45-129">129</a></span>
<span class="normal"><a href="#__codelineno-45-130">130</a></span>
<span class="normal"><a href="#__codelineno-45-131">131</a></span>
<span class="normal"><a href="#__codelineno-45-132">132</a></span>
<span class="normal"><a href="#__codelineno-45-133">133</a></span>
<span class="normal"><a href="#__codelineno-45-134">134</a></span>
<span class="normal"><a href="#__codelineno-45-135">135</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-45-1" name="__codelineno-45-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">fastapi</span><span class="w"> </span><span class="kn">import</span> <span class="n">APIRouter</span>
<a id="__codelineno-45-2" name="__codelineno-45-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">models</span><span class="w"> </span><span class="kn">import</span> <span class="o">*</span>
<a id="__codelineno-45-3" name="__codelineno-45-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">pydantic</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseModel</span><span class="p">,</span> <span class="n">validator</span>
<a id="__codelineno-45-4" name="__codelineno-45-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Union</span>
<a id="__codelineno-45-5" name="__codelineno-45-5"></a><span class="kn">from</span><span class="w"> </span><span class="nn">fastapi.templating</span><span class="w"> </span><span class="kn">import</span> <span class="n">Jinja2Templates</span>
<a id="__codelineno-45-6" name="__codelineno-45-6"></a><span class="kn">from</span><span class="w"> </span><span class="nn">fastapi</span><span class="w"> </span><span class="kn">import</span> <span class="n">Request</span>
<a id="__codelineno-45-7" name="__codelineno-45-7"></a>
<a id="__codelineno-45-8" name="__codelineno-45-8"></a><span class="kn">from</span><span class="w"> </span><span class="nn">fastapi.exceptions</span><span class="w"> </span><span class="kn">import</span> <span class="n">HTTPException</span>
<a id="__codelineno-45-9" name="__codelineno-45-9"></a>
<a id="__codelineno-45-10" name="__codelineno-45-10"></a><span class="n">student_api</span> <span class="o">=</span> <span class="n">APIRouter</span><span class="p">()</span>
<a id="__codelineno-45-11" name="__codelineno-45-11"></a>
<a id="__codelineno-45-12" name="__codelineno-45-12"></a>
<a id="__codelineno-45-13" name="__codelineno-45-13"></a><span class="nd">@student_api</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
<a id="__codelineno-45-14" name="__codelineno-45-14"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">getAllStudent</span><span class="p">():</span>
<a id="__codelineno-45-15" name="__codelineno-45-15"></a>    <span class="c1"># (1) æŸ¥è¯¢æ‰€æœ‰ allæ–¹æ³•</span>
<a id="__codelineno-45-16" name="__codelineno-45-16"></a>    <span class="n">students</span> <span class="o">=</span> <span class="k">await</span> <span class="n">Student</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>  <span class="c1"># Queryset: [Student(),Student(),Student()]</span>
<a id="__codelineno-45-17" name="__codelineno-45-17"></a>    <span class="c1"># print(&quot;students&quot;, students)</span>
<a id="__codelineno-45-18" name="__codelineno-45-18"></a>    <span class="c1">#</span>
<a id="__codelineno-45-19" name="__codelineno-45-19"></a>    <span class="c1"># for stu in students:</span>
<a id="__codelineno-45-20" name="__codelineno-45-20"></a>    <span class="c1">#     print(stu.name, stu.sno)</span>
<a id="__codelineno-45-21" name="__codelineno-45-21"></a>    <span class="c1"># print(students[0].name)</span>
<a id="__codelineno-45-22" name="__codelineno-45-22"></a>    <span class="c1"># (2) è¿‡æ»¤æŸ¥è¯¢ filter</span>
<a id="__codelineno-45-23" name="__codelineno-45-23"></a>    <span class="c1"># students = await Student.filter(name=&quot;rain&quot;)  # Queryset: [Student(),Student(),Student()]</span>
<a id="__codelineno-45-24" name="__codelineno-45-24"></a>    <span class="c1"># students = await Student.filter(clas_id=14)  # Queryset: [Student(),Student(),Student()]</span>
<a id="__codelineno-45-25" name="__codelineno-45-25"></a>    <span class="c1"># print(&quot;students&quot;, students)</span>
<a id="__codelineno-45-26" name="__codelineno-45-26"></a>
<a id="__codelineno-45-27" name="__codelineno-45-27"></a>    <span class="c1"># (3) è¿‡æ»¤æŸ¥è¯¢ getæ–¹æ³•ï¼šè¿”å›æ¨¡å‹ç±»å‹å¯¹è±¡</span>
<a id="__codelineno-45-28" name="__codelineno-45-28"></a>
<a id="__codelineno-45-29" name="__codelineno-45-29"></a>    <span class="c1"># stu = await Student.filter(id=6)  # [Student(),]</span>
<a id="__codelineno-45-30" name="__codelineno-45-30"></a>    <span class="c1"># print(stu[0].name)</span>
<a id="__codelineno-45-31" name="__codelineno-45-31"></a>    <span class="c1"># stu = await Student.get(id=6)  # Student()</span>
<a id="__codelineno-45-32" name="__codelineno-45-32"></a>    <span class="c1"># print(stu.name)</span>
<a id="__codelineno-45-33" name="__codelineno-45-33"></a>
<a id="__codelineno-45-34" name="__codelineno-45-34"></a>    <span class="c1"># (4) æ¨¡ç³ŠæŸ¥è¯¢</span>
<a id="__codelineno-45-35" name="__codelineno-45-35"></a>    <span class="c1"># stus = await Student.filter(sno__gt=2001)</span>
<a id="__codelineno-45-36" name="__codelineno-45-36"></a>    <span class="c1"># stus = await Student.filter(sno__range=[1, 10000])</span>
<a id="__codelineno-45-37" name="__codelineno-45-37"></a>    <span class="c1"># stus = await Student.filter(sno__in=[2001, 2002])</span>
<a id="__codelineno-45-38" name="__codelineno-45-38"></a>    <span class="c1"># print(stus)  # [&lt;Student: 7&gt;, &lt;Student: 8&gt;]</span>
<a id="__codelineno-45-39" name="__codelineno-45-39"></a>
<a id="__codelineno-45-40" name="__codelineno-45-40"></a>    <span class="c1"># (5) valuesæŸ¥è¯¢</span>
<a id="__codelineno-45-41" name="__codelineno-45-41"></a>    <span class="c1"># stus = await Student.filter(sno__range=[1, 10000])  # [Student(),Student(),Student(),...]</span>
<a id="__codelineno-45-42" name="__codelineno-45-42"></a>    <span class="c1"># stus = await Student.all().values(&quot;name&quot;, &quot;sno&quot;)  # [{},{},{},...]</span>
<a id="__codelineno-45-43" name="__codelineno-45-43"></a>    <span class="c1"># print(stus)</span>
<a id="__codelineno-45-44" name="__codelineno-45-44"></a>
<a id="__codelineno-45-45" name="__codelineno-45-45"></a>    <span class="c1"># (6) ä¸€å¯¹å¤šæŸ¥è¯¢ å¤šå¯¹å¤šæŸ¥è¯¢</span>
<a id="__codelineno-45-46" name="__codelineno-45-46"></a>    <span class="n">alvin</span> <span class="o">=</span> <span class="k">await</span> <span class="n">Student</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;alvin&quot;</span><span class="p">)</span>
<a id="__codelineno-45-47" name="__codelineno-45-47"></a>    <span class="nb">print</span><span class="p">(</span><span class="n">alvin</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
<a id="__codelineno-45-48" name="__codelineno-45-48"></a>    <span class="nb">print</span><span class="p">(</span><span class="n">alvin</span><span class="o">.</span><span class="n">sno</span><span class="p">)</span>
<a id="__codelineno-45-49" name="__codelineno-45-49"></a>    <span class="nb">print</span><span class="p">(</span><span class="k">await</span> <span class="n">alvin</span><span class="o">.</span><span class="n">clas</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">))</span>  <span class="c1"># {&#39;name&#39;: &#39;è®¡ç®—æœºç§‘å­¦ä¸æŠ€æœ¯2ç­&#39;}</span>
<a id="__codelineno-45-50" name="__codelineno-45-50"></a>    <span class="n">students</span> <span class="o">=</span> <span class="k">await</span> <span class="n">Student</span><span class="o">.</span><span class="n">all</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;clas__name&quot;</span><span class="p">)</span>
<a id="__codelineno-45-51" name="__codelineno-45-51"></a>    <span class="nb">print</span><span class="p">(</span><span class="k">await</span> <span class="n">alvin</span><span class="o">.</span><span class="n">courses</span><span class="o">.</span><span class="n">all</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;teacher__name&quot;</span><span class="p">))</span>
<a id="__codelineno-45-52" name="__codelineno-45-52"></a>    <span class="n">students</span> <span class="o">=</span> <span class="k">await</span> <span class="n">Student</span><span class="o">.</span><span class="n">all</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;clas__name&quot;</span><span class="p">,</span> <span class="s2">&quot;courses__name&quot;</span><span class="p">)</span>
<a id="__codelineno-45-53" name="__codelineno-45-53"></a>
<a id="__codelineno-45-54" name="__codelineno-45-54"></a>    <span class="k">return</span> <span class="n">students</span>
<a id="__codelineno-45-55" name="__codelineno-45-55"></a>
<a id="__codelineno-45-56" name="__codelineno-45-56"></a>
<a id="__codelineno-45-57" name="__codelineno-45-57"></a><span class="nd">@student_api</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/index.html&quot;</span><span class="p">)</span>
<a id="__codelineno-45-58" name="__codelineno-45-58"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">getAllStudent</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">):</span>
<a id="__codelineno-45-59" name="__codelineno-45-59"></a>    <span class="n">templates</span> <span class="o">=</span> <span class="n">Jinja2Templates</span><span class="p">(</span><span class="n">directory</span><span class="o">=</span><span class="s2">&quot;templates&quot;</span><span class="p">)</span>
<a id="__codelineno-45-60" name="__codelineno-45-60"></a>    <span class="n">students</span> <span class="o">=</span> <span class="k">await</span> <span class="n">Student</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>  <span class="c1"># [Student(),Student(),...]</span>
<a id="__codelineno-45-61" name="__codelineno-45-61"></a>
<a id="__codelineno-45-62" name="__codelineno-45-62"></a>    <span class="k">return</span> <span class="n">templates</span><span class="o">.</span><span class="n">TemplateResponse</span><span class="p">(</span>
<a id="__codelineno-45-63" name="__codelineno-45-63"></a>        <span class="s2">&quot;index.html&quot;</span><span class="p">,</span> <span class="p">{</span>
<a id="__codelineno-45-64" name="__codelineno-45-64"></a>            <span class="s2">&quot;request&quot;</span><span class="p">:</span> <span class="n">request</span><span class="p">,</span>
<a id="__codelineno-45-65" name="__codelineno-45-65"></a>            <span class="s2">&quot;students&quot;</span><span class="p">:</span> <span class="n">students</span>
<a id="__codelineno-45-66" name="__codelineno-45-66"></a>        <span class="p">}</span>
<a id="__codelineno-45-67" name="__codelineno-45-67"></a>    <span class="p">)</span>
<a id="__codelineno-45-68" name="__codelineno-45-68"></a>
<a id="__codelineno-45-69" name="__codelineno-45-69"></a>
<a id="__codelineno-45-70" name="__codelineno-45-70"></a><span class="k">class</span><span class="w"> </span><span class="nc">StudentIn</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
<a id="__codelineno-45-71" name="__codelineno-45-71"></a>    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-45-72" name="__codelineno-45-72"></a>    <span class="n">pwd</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-45-73" name="__codelineno-45-73"></a>    <span class="n">sno</span><span class="p">:</span> <span class="nb">int</span>
<a id="__codelineno-45-74" name="__codelineno-45-74"></a>    <span class="n">clas_id</span><span class="p">:</span> <span class="nb">int</span>
<a id="__codelineno-45-75" name="__codelineno-45-75"></a>    <span class="n">courses</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-45-76" name="__codelineno-45-76"></a>
<a id="__codelineno-45-77" name="__codelineno-45-77"></a>    <span class="nd">@validator</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">)</span>
<a id="__codelineno-45-78" name="__codelineno-45-78"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">name_must_alpha</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<a id="__codelineno-45-79" name="__codelineno-45-79"></a>        <span class="k">assert</span> <span class="n">value</span><span class="o">.</span><span class="n">isalpha</span><span class="p">(),</span> <span class="s1">&#39;name must be alpha&#39;</span>
<a id="__codelineno-45-80" name="__codelineno-45-80"></a>        <span class="k">return</span> <span class="n">value</span>
<a id="__codelineno-45-81" name="__codelineno-45-81"></a>
<a id="__codelineno-45-82" name="__codelineno-45-82"></a>    <span class="nd">@validator</span><span class="p">(</span><span class="s2">&quot;sno&quot;</span><span class="p">)</span>
<a id="__codelineno-45-83" name="__codelineno-45-83"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">sno_validate</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<a id="__codelineno-45-84" name="__codelineno-45-84"></a>        <span class="k">assert</span> <span class="mi">1000</span> <span class="o">&lt;</span> <span class="n">value</span> <span class="o">&lt;</span> <span class="mi">10000</span><span class="p">,</span> <span class="s1">&#39;å­¦å·è¦åœ¨2000-10000çš„èŒƒå›´å†…&#39;</span>
<a id="__codelineno-45-85" name="__codelineno-45-85"></a>        <span class="k">return</span> <span class="n">value</span>
<a id="__codelineno-45-86" name="__codelineno-45-86"></a>
<a id="__codelineno-45-87" name="__codelineno-45-87"></a>
<a id="__codelineno-45-88" name="__codelineno-45-88"></a><span class="nd">@student_api</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
<a id="__codelineno-45-89" name="__codelineno-45-89"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">addStudent</span><span class="p">(</span><span class="n">student_in</span><span class="p">:</span> <span class="n">StudentIn</span><span class="p">):</span>
<a id="__codelineno-45-90" name="__codelineno-45-90"></a>    <span class="c1"># æ’å…¥åˆ°æ•°æ®åº“</span>
<a id="__codelineno-45-91" name="__codelineno-45-91"></a>    <span class="c1"># æ–¹å¼1</span>
<a id="__codelineno-45-92" name="__codelineno-45-92"></a>    <span class="c1"># student = Student(name=student_in.name, pwd=student_in.pwd, sno=student_in.sno, clas_id=student_in.clas_id)</span>
<a id="__codelineno-45-93" name="__codelineno-45-93"></a>    <span class="c1"># await student.save() # æ’å…¥åˆ°æ•°æ®åº“studentè¡¨</span>
<a id="__codelineno-45-94" name="__codelineno-45-94"></a>    <span class="c1"># æ–¹å¼2</span>
<a id="__codelineno-45-95" name="__codelineno-45-95"></a>    <span class="n">student</span> <span class="o">=</span> <span class="k">await</span> <span class="n">Student</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">student_in</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">pwd</span><span class="o">=</span><span class="n">student_in</span><span class="o">.</span><span class="n">pwd</span><span class="p">,</span> <span class="n">sno</span><span class="o">=</span><span class="n">student_in</span><span class="o">.</span><span class="n">sno</span><span class="p">,</span>
<a id="__codelineno-45-96" name="__codelineno-45-96"></a>                                   <span class="n">clas_id</span><span class="o">=</span><span class="n">student_in</span><span class="o">.</span><span class="n">clas_id</span><span class="p">)</span>
<a id="__codelineno-45-97" name="__codelineno-45-97"></a>
<a id="__codelineno-45-98" name="__codelineno-45-98"></a>    <span class="c1"># å¤šå¯¹å¤šçš„å…³ç³»ç»‘å®š</span>
<a id="__codelineno-45-99" name="__codelineno-45-99"></a>    <span class="n">choose_courses</span> <span class="o">=</span> <span class="k">await</span> <span class="n">Course</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">id__in</span><span class="o">=</span><span class="n">student_in</span><span class="o">.</span><span class="n">courses</span><span class="p">)</span>
<a id="__codelineno-45-100" name="__codelineno-45-100"></a>    <span class="k">await</span> <span class="n">student</span><span class="o">.</span><span class="n">courses</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="o">*</span><span class="n">choose_courses</span><span class="p">)</span>
<a id="__codelineno-45-101" name="__codelineno-45-101"></a>
<a id="__codelineno-45-102" name="__codelineno-45-102"></a>    <span class="k">return</span> <span class="n">student</span>
<a id="__codelineno-45-103" name="__codelineno-45-103"></a>
<a id="__codelineno-45-104" name="__codelineno-45-104"></a>
<a id="__codelineno-45-105" name="__codelineno-45-105"></a><span class="nd">@student_api</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/</span><span class="si">{student_id}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-45-106" name="__codelineno-45-106"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">getOneStudent</span><span class="p">(</span><span class="n">student_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
<a id="__codelineno-45-107" name="__codelineno-45-107"></a>    <span class="n">student</span> <span class="o">=</span> <span class="k">await</span> <span class="n">Student</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">student_id</span><span class="p">)</span>
<a id="__codelineno-45-108" name="__codelineno-45-108"></a>
<a id="__codelineno-45-109" name="__codelineno-45-109"></a>    <span class="k">return</span> <span class="n">student</span>
<a id="__codelineno-45-110" name="__codelineno-45-110"></a>
<a id="__codelineno-45-111" name="__codelineno-45-111"></a>
<a id="__codelineno-45-112" name="__codelineno-45-112"></a><span class="nd">@student_api</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s2">&quot;/</span><span class="si">{student_id}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-45-113" name="__codelineno-45-113"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">updateStudent</span><span class="p">(</span><span class="n">student_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">student_in</span><span class="p">:</span> <span class="n">StudentIn</span><span class="p">):</span>
<a id="__codelineno-45-114" name="__codelineno-45-114"></a>    <span class="n">data</span> <span class="o">=</span> <span class="n">student_in</span><span class="o">.</span><span class="n">dict</span><span class="p">()</span>
<a id="__codelineno-45-115" name="__codelineno-45-115"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;data&quot;</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
<a id="__codelineno-45-116" name="__codelineno-45-116"></a>    <span class="n">courses</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;courses&quot;</span><span class="p">)</span>
<a id="__codelineno-45-117" name="__codelineno-45-117"></a>
<a id="__codelineno-45-118" name="__codelineno-45-118"></a>    <span class="k">await</span> <span class="n">Student</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">student_id</span><span class="p">)</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">**</span><span class="n">data</span><span class="p">)</span>
<a id="__codelineno-45-119" name="__codelineno-45-119"></a>
<a id="__codelineno-45-120" name="__codelineno-45-120"></a>    <span class="c1">#  è®¾ç½®å¤šå¯¹å¤šçš„é€‰ä¿®è¯¾</span>
<a id="__codelineno-45-121" name="__codelineno-45-121"></a>    <span class="n">edit_stu</span> <span class="o">=</span> <span class="k">await</span> <span class="n">Student</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">student_id</span><span class="p">)</span>
<a id="__codelineno-45-122" name="__codelineno-45-122"></a>    <span class="n">choose_courses</span> <span class="o">=</span> <span class="k">await</span> <span class="n">Course</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">id__in</span><span class="o">=</span><span class="n">courses</span><span class="p">)</span>
<a id="__codelineno-45-123" name="__codelineno-45-123"></a>    <span class="k">await</span> <span class="n">edit_stu</span><span class="o">.</span><span class="n">courses</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
<a id="__codelineno-45-124" name="__codelineno-45-124"></a>    <span class="k">await</span> <span class="n">edit_stu</span><span class="o">.</span><span class="n">courses</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="o">*</span><span class="n">choose_courses</span><span class="p">)</span>
<a id="__codelineno-45-125" name="__codelineno-45-125"></a>
<a id="__codelineno-45-126" name="__codelineno-45-126"></a>    <span class="k">return</span> <span class="n">edit_stu</span>
<a id="__codelineno-45-127" name="__codelineno-45-127"></a>
<a id="__codelineno-45-128" name="__codelineno-45-128"></a>
<a id="__codelineno-45-129" name="__codelineno-45-129"></a><span class="nd">@student_api</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="s2">&quot;/</span><span class="si">{student_id}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-45-130" name="__codelineno-45-130"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">deleteStudent</span><span class="p">(</span><span class="n">student_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
<a id="__codelineno-45-131" name="__codelineno-45-131"></a>    <span class="n">deleteCount</span> <span class="o">=</span> <span class="k">await</span> <span class="n">Student</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">student_id</span><span class="p">)</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
<a id="__codelineno-45-132" name="__codelineno-45-132"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">deleteCount</span><span class="p">:</span>
<a id="__codelineno-45-133" name="__codelineno-45-133"></a>        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">404</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;ä¸»é”®ä¸º</span><span class="si">{</span><span class="n">student_id</span><span class="si">}</span><span class="s2">çš„å­¦ç”Ÿä¸å­˜åœ¨&quot;</span><span class="p">)</span>
<a id="__codelineno-45-134" name="__codelineno-45-134"></a>
<a id="__codelineno-45-135" name="__codelineno-45-135"></a>    <span class="k">return</span> <span class="p">{}</span>
</code></pre></div></td></tr></table></div>
<h2 id="ä¸­é—´ä»¶ä¸corsè·¨åŸŸ"><font style="color:rgb(51, 51, 51);">ä¸­é—´ä»¶ä¸CORSè·¨åŸŸ</font><a class="headerlink" href="#ä¸­é—´ä»¶ä¸corsè·¨åŸŸ" title="Permanent link">&para;</a></h2>
<h3 id="ä¸­é—´ä»¶"><font style="color:rgb(51, 51, 51);">ä¸­é—´ä»¶</font><a class="headerlink" href="#ä¸­é—´ä»¶" title="Permanent link">&para;</a></h3>
<p><font style="color:rgb(51, 51, 51);">ä½ å¯ä»¥å‘ </font><strong><font style="color:rgb(51, 51, 51);">FastAPI</font></strong><font style="color:rgb(51, 51, 51);"> åº”ç”¨æ·»åŠ ä¸­é—´ä»¶.</font></p>
<p><font style="color:rgb(51, 51, 51);">"ä¸­é—´ä»¶"æ˜¯ä¸€ä¸ªå‡½æ•°,å®ƒåœ¨æ¯ä¸ª</font><strong><font style="color:rgb(51, 51, 51);">è¯·æ±‚</font></strong><font style="color:rgb(51, 51, 51);">è¢«ç‰¹å®šçš„è·¯å¾„æ“ä½œå¤„ç†ä¹‹å‰,ä»¥åŠåœ¨æ¯ä¸ª</font><strong><font style="color:rgb(51, 51, 51);">å“åº”</font></strong><font style="color:rgb(51, 51, 51);">ä¹‹åå·¥ä½œ.</font></p>
<p><img alt="" src="../../../../images/1721480837774-70eb043b-b1a6-494e-acb8-9408f979e7a2.png" /></p>
<blockquote>
<p>å¦‚æœä½ ä½¿ç”¨äº† <code>yield</code> å…³é”®å­—ä¾èµ–, ä¾èµ–ä¸­çš„é€€å‡ºä»£ç å°†åœ¨æ‰§è¡Œä¸­é—´ä»¶_å_æ‰§è¡Œ.</p>
<p>å¦‚æœæœ‰ä»»ä½•åå°ä»»åŠ¡(ç¨åè®°å½•), å®ƒä»¬å°†åœ¨æ‰§è¡Œä¸­é—´ä»¶_å_è¿è¡Œ.
</p>
</blockquote>
<p>è¦åˆ›å»ºä¸­é—´ä»¶ä½ å¯ä»¥åœ¨å‡½æ•°çš„é¡¶éƒ¨ä½¿ç”¨è£…é¥°å™¨ <code>@app.middleware("http")</code>.</p>
<p>ä¸­é—´ä»¶å‚æ•°æ¥æ”¶å¦‚ä¸‹å‚æ•°ï¼š</p>
<blockquote>
<ul>
<li><code>request</code>.</li>
<li>ä¸€ä¸ªå‡½æ•°<code>call_next</code>ï¼Œå®ƒå°†æ¥æ”¶requestï¼Œä½œä¸ºå‚æ•°.<ul>
<li>è¿™ä¸ªå‡½æ•°å°† <code>request</code> ä¼ é€’ç»™ç›¸åº”çš„ <em>è·¯å¾„æ“ä½œ</em>.</li>
<li>ç„¶åå®ƒå°†è¿”å›ç”±ç›¸åº”çš„_è·¯å¾„æ“ä½œ_ç”Ÿæˆçš„ <code>response</code>.</li>
</ul>
</li>
<li>ç„¶åä½ å¯ä»¥åœ¨è¿”å› <code>response</code> å‰è¿›ä¸€æ­¥ä¿®æ”¹å®ƒ.
</li>
</ul>
</blockquote>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Python</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-46-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-46-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-46-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-46-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-46-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-46-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-46-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-46-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-46-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-46-10">10</a></span>
<span class="normal"><a href="#__codelineno-46-11">11</a></span>
<span class="normal"><a href="#__codelineno-46-12">12</a></span>
<span class="normal"><a href="#__codelineno-46-13">13</a></span>
<span class="normal"><a href="#__codelineno-46-14">14</a></span>
<span class="normal"><a href="#__codelineno-46-15">15</a></span>
<span class="normal"><a href="#__codelineno-46-16">16</a></span>
<span class="normal"><a href="#__codelineno-46-17">17</a></span>
<span class="normal"><a href="#__codelineno-46-18">18</a></span>
<span class="normal"><a href="#__codelineno-46-19">19</a></span>
<span class="normal"><a href="#__codelineno-46-20">20</a></span>
<span class="normal"><a href="#__codelineno-46-21">21</a></span>
<span class="normal"><a href="#__codelineno-46-22">22</a></span>
<span class="normal"><a href="#__codelineno-46-23">23</a></span>
<span class="normal"><a href="#__codelineno-46-24">24</a></span>
<span class="normal"><a href="#__codelineno-46-25">25</a></span>
<span class="normal"><a href="#__codelineno-46-26">26</a></span>
<span class="normal"><a href="#__codelineno-46-27">27</a></span>
<span class="normal"><a href="#__codelineno-46-28">28</a></span>
<span class="normal"><a href="#__codelineno-46-29">29</a></span>
<span class="normal"><a href="#__codelineno-46-30">30</a></span>
<span class="normal"><a href="#__codelineno-46-31">31</a></span>
<span class="normal"><a href="#__codelineno-46-32">32</a></span>
<span class="normal"><a href="#__codelineno-46-33">33</a></span>
<span class="normal"><a href="#__codelineno-46-34">34</a></span>
<span class="normal"><a href="#__codelineno-46-35">35</a></span>
<span class="normal"><a href="#__codelineno-46-36">36</a></span>
<span class="normal"><a href="#__codelineno-46-37">37</a></span>
<span class="normal"><a href="#__codelineno-46-38">38</a></span>
<span class="normal"><a href="#__codelineno-46-39">39</a></span>
<span class="normal"><a href="#__codelineno-46-40">40</a></span>
<span class="normal"><a href="#__codelineno-46-41">41</a></span>
<span class="normal"><a href="#__codelineno-46-42">42</a></span>
<span class="normal"><a href="#__codelineno-46-43">43</a></span>
<span class="normal"><a href="#__codelineno-46-44">44</a></span>
<span class="normal"><a href="#__codelineno-46-45">45</a></span>
<span class="normal"><a href="#__codelineno-46-46">46</a></span>
<span class="normal"><a href="#__codelineno-46-47">47</a></span>
<span class="normal"><a href="#__codelineno-46-48">48</a></span>
<span class="normal"><a href="#__codelineno-46-49">49</a></span>
<span class="normal"><a href="#__codelineno-46-50">50</a></span>
<span class="normal"><a href="#__codelineno-46-51">51</a></span>
<span class="normal"><a href="#__codelineno-46-52">52</a></span>
<span class="normal"><a href="#__codelineno-46-53">53</a></span>
<span class="normal"><a href="#__codelineno-46-54">54</a></span>
<span class="normal"><a href="#__codelineno-46-55">55</a></span>
<span class="normal"><a href="#__codelineno-46-56">56</a></span>
<span class="normal"><a href="#__codelineno-46-57">57</a></span>
<span class="normal"><a href="#__codelineno-46-58">58</a></span>
<span class="normal"><a href="#__codelineno-46-59">59</a></span>
<span class="normal"><a href="#__codelineno-46-60">60</a></span>
<span class="normal"><a href="#__codelineno-46-61">61</a></span>
<span class="normal"><a href="#__codelineno-46-62">62</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-46-1" name="__codelineno-46-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">uvicorn</span>
<a id="__codelineno-46-2" name="__codelineno-46-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">fastapi</span><span class="w"> </span><span class="kn">import</span> <span class="n">FastAPI</span>
<a id="__codelineno-46-3" name="__codelineno-46-3"></a>
<a id="__codelineno-46-4" name="__codelineno-46-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">fastapi</span><span class="w"> </span><span class="kn">import</span> <span class="n">Request</span>
<a id="__codelineno-46-5" name="__codelineno-46-5"></a><span class="kn">from</span><span class="w"> </span><span class="nn">fastapi.responses</span><span class="w"> </span><span class="kn">import</span> <span class="n">Response</span>
<a id="__codelineno-46-6" name="__codelineno-46-6"></a><span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<a id="__codelineno-46-7" name="__codelineno-46-7"></a>
<a id="__codelineno-46-8" name="__codelineno-46-8"></a><span class="n">app</span> <span class="o">=</span> <span class="n">FastAPI</span><span class="p">()</span>
<a id="__codelineno-46-9" name="__codelineno-46-9"></a>
<a id="__codelineno-46-10" name="__codelineno-46-10"></a>
<a id="__codelineno-46-11" name="__codelineno-46-11"></a><span class="nd">@app</span><span class="o">.</span><span class="n">middleware</span><span class="p">(</span><span class="s2">&quot;http&quot;</span><span class="p">)</span>
<a id="__codelineno-46-12" name="__codelineno-46-12"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">m2</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">,</span> <span class="n">call_next</span><span class="p">):</span>
<a id="__codelineno-46-13" name="__codelineno-46-13"></a>    <span class="c1"># è¯·æ±‚ä»£ç å—</span>
<a id="__codelineno-46-14" name="__codelineno-46-14"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;m2 request&quot;</span><span class="p">)</span>
<a id="__codelineno-46-15" name="__codelineno-46-15"></a>    <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="n">call_next</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
<a id="__codelineno-46-16" name="__codelineno-46-16"></a>    <span class="c1"># å“åº”ä»£ç å—</span>
<a id="__codelineno-46-17" name="__codelineno-46-17"></a>    <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s2">&quot;author&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;yuan&quot;</span>
<a id="__codelineno-46-18" name="__codelineno-46-18"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;m2 response&quot;</span><span class="p">)</span>
<a id="__codelineno-46-19" name="__codelineno-46-19"></a>    <span class="k">return</span> <span class="n">response</span>
<a id="__codelineno-46-20" name="__codelineno-46-20"></a>
<a id="__codelineno-46-21" name="__codelineno-46-21"></a>
<a id="__codelineno-46-22" name="__codelineno-46-22"></a><span class="nd">@app</span><span class="o">.</span><span class="n">middleware</span><span class="p">(</span><span class="s2">&quot;http&quot;</span><span class="p">)</span>
<a id="__codelineno-46-23" name="__codelineno-46-23"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">m1</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">,</span> <span class="n">call_next</span><span class="p">):</span>
<a id="__codelineno-46-24" name="__codelineno-46-24"></a>    <span class="c1"># è¯·æ±‚ä»£ç å—</span>
<a id="__codelineno-46-25" name="__codelineno-46-25"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;m1 request&quot;</span><span class="p">)</span>
<a id="__codelineno-46-26" name="__codelineno-46-26"></a>    <span class="c1"># if request.client.host in [&quot;127.0.0.1&quot;, ]:  # é»‘åå•</span>
<a id="__codelineno-46-27" name="__codelineno-46-27"></a>    <span class="c1">#     return Response(content=&quot;visit forbidden&quot;)</span>
<a id="__codelineno-46-28" name="__codelineno-46-28"></a>
<a id="__codelineno-46-29" name="__codelineno-46-29"></a>    <span class="c1"># if request.url.path in [&quot;/user&quot;]:</span>
<a id="__codelineno-46-30" name="__codelineno-46-30"></a>    <span class="c1">#     return Response(content=&quot;visit forbidden&quot;)</span>
<a id="__codelineno-46-31" name="__codelineno-46-31"></a>
<a id="__codelineno-46-32" name="__codelineno-46-32"></a>    <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<a id="__codelineno-46-33" name="__codelineno-46-33"></a>
<a id="__codelineno-46-34" name="__codelineno-46-34"></a>    <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="n">call_next</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
<a id="__codelineno-46-35" name="__codelineno-46-35"></a>    <span class="c1"># å“åº”ä»£ç å—</span>
<a id="__codelineno-46-36" name="__codelineno-46-36"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;m1 response&quot;</span><span class="p">)</span>
<a id="__codelineno-46-37" name="__codelineno-46-37"></a>    <span class="n">end</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<a id="__codelineno-46-38" name="__codelineno-46-38"></a>    <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s2">&quot;ProcessTimer&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">end</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span>
<a id="__codelineno-46-39" name="__codelineno-46-39"></a>    <span class="k">return</span> <span class="n">response</span>
<a id="__codelineno-46-40" name="__codelineno-46-40"></a>
<a id="__codelineno-46-41" name="__codelineno-46-41"></a>
<a id="__codelineno-46-42" name="__codelineno-46-42"></a><span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/user&quot;</span><span class="p">)</span>
<a id="__codelineno-46-43" name="__codelineno-46-43"></a><span class="k">def</span><span class="w"> </span><span class="nf">get_user</span><span class="p">():</span>
<a id="__codelineno-46-44" name="__codelineno-46-44"></a>    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<a id="__codelineno-46-45" name="__codelineno-46-45"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;get_userå‡½æ•°æ‰§è¡Œ&quot;</span><span class="p">)</span>
<a id="__codelineno-46-46" name="__codelineno-46-46"></a>    <span class="k">return</span> <span class="p">{</span>
<a id="__codelineno-46-47" name="__codelineno-46-47"></a>        <span class="s2">&quot;user&quot;</span><span class="p">:</span> <span class="s2">&quot;current user&quot;</span>
<a id="__codelineno-46-48" name="__codelineno-46-48"></a>    <span class="p">}</span>
<a id="__codelineno-46-49" name="__codelineno-46-49"></a>
<a id="__codelineno-46-50" name="__codelineno-46-50"></a>
<a id="__codelineno-46-51" name="__codelineno-46-51"></a><span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/item/</span><span class="si">{item_id}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-46-52" name="__codelineno-46-52"></a><span class="k">def</span><span class="w"> </span><span class="nf">get_item</span><span class="p">(</span><span class="n">item_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
<a id="__codelineno-46-53" name="__codelineno-46-53"></a>    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<a id="__codelineno-46-54" name="__codelineno-46-54"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;get_itemå‡½æ•°æ‰§è¡Œ&quot;</span><span class="p">)</span>
<a id="__codelineno-46-55" name="__codelineno-46-55"></a>    <span class="k">return</span> <span class="p">{</span>
<a id="__codelineno-46-56" name="__codelineno-46-56"></a>        <span class="s2">&quot;item_id&quot;</span><span class="p">:</span> <span class="n">item_id</span>
<a id="__codelineno-46-57" name="__codelineno-46-57"></a>    <span class="p">}</span>
<a id="__codelineno-46-58" name="__codelineno-46-58"></a>
<a id="__codelineno-46-59" name="__codelineno-46-59"></a>
<a id="__codelineno-46-60" name="__codelineno-46-60"></a><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
<a id="__codelineno-46-61" name="__codelineno-46-61"></a>    <span class="n">uvicorn</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s1">&#39;main:app&#39;</span><span class="p">,</span> <span class="n">host</span><span class="o">=</span><span class="s1">&#39;127.0.0.1&#39;</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">8030</span><span class="p">,</span> <span class="n">reload</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-46-62" name="__codelineno-46-62"></a>                <span class="n">debug</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">workers</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
<h3 id="corsè·¨åŸŸ"><font style="color:rgb(51, 51, 51);">CORSè·¨åŸŸ</font><a class="headerlink" href="#corsè·¨åŸŸ" title="Permanent link">&para;</a></h3>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Python</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-47-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-47-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-47-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-47-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-47-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-47-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-47-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-47-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-47-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-47-10">10</a></span>
<span class="normal"><a href="#__codelineno-47-11">11</a></span>
<span class="normal"><a href="#__codelineno-47-12">12</a></span>
<span class="normal"><a href="#__codelineno-47-13">13</a></span>
<span class="normal"><a href="#__codelineno-47-14">14</a></span>
<span class="normal"><a href="#__codelineno-47-15">15</a></span>
<span class="normal"><a href="#__codelineno-47-16">16</a></span>
<span class="normal"><a href="#__codelineno-47-17">17</a></span>
<span class="normal"><a href="#__codelineno-47-18">18</a></span>
<span class="normal"><a href="#__codelineno-47-19">19</a></span>
<span class="normal"><a href="#__codelineno-47-20">20</a></span>
<span class="normal"><a href="#__codelineno-47-21">21</a></span>
<span class="normal"><a href="#__codelineno-47-22">22</a></span>
<span class="normal"><a href="#__codelineno-47-23">23</a></span>
<span class="normal"><a href="#__codelineno-47-24">24</a></span>
<span class="normal"><a href="#__codelineno-47-25">25</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-47-1" name="__codelineno-47-1"></a><span class="o">&lt;</span><span class="err">!</span><span class="n">DOCTYPE</span> <span class="n">html</span><span class="o">&gt;</span>
<a id="__codelineno-47-2" name="__codelineno-47-2"></a><span class="o">&lt;</span><span class="n">html</span> <span class="n">lang</span><span class="o">=</span><span class="s2">&quot;en&quot;</span><span class="o">&gt;</span>
<a id="__codelineno-47-3" name="__codelineno-47-3"></a><span class="o">&lt;</span><span class="n">head</span><span class="o">&gt;</span>
<a id="__codelineno-47-4" name="__codelineno-47-4"></a>    <span class="o">&lt;</span><span class="n">meta</span> <span class="n">charset</span><span class="o">=</span><span class="s2">&quot;UTF-8&quot;</span><span class="o">&gt;</span>
<a id="__codelineno-47-5" name="__codelineno-47-5"></a>    <span class="o">&lt;</span><span class="n">title</span><span class="o">&gt;</span><span class="n">Title</span><span class="o">&lt;/</span><span class="n">title</span><span class="o">&gt;</span>
<a id="__codelineno-47-6" name="__codelineno-47-6"></a>    <span class="o">&lt;</span><span class="n">script</span> <span class="n">src</span><span class="o">=</span><span class="s2">&quot;https://cdn.bootcdn.net/ajax/libs/jquery/3.6.0/jquery.js&quot;</span><span class="o">&gt;&lt;/</span><span class="n">script</span><span class="o">&gt;</span>
<a id="__codelineno-47-7" name="__codelineno-47-7"></a><span class="o">&lt;/</span><span class="n">head</span><span class="o">&gt;</span>
<a id="__codelineno-47-8" name="__codelineno-47-8"></a><span class="o">&lt;</span><span class="n">body</span><span class="o">&gt;</span>
<a id="__codelineno-47-9" name="__codelineno-47-9"></a>
<a id="__codelineno-47-10" name="__codelineno-47-10"></a><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="n">click</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
<a id="__codelineno-47-11" name="__codelineno-47-11"></a>
<a id="__codelineno-47-12" name="__codelineno-47-12"></a><span class="o">&lt;</span><span class="n">script</span><span class="o">&gt;</span>
<a id="__codelineno-47-13" name="__codelineno-47-13"></a>
<a id="__codelineno-47-14" name="__codelineno-47-14"></a>    <span class="err">$</span><span class="p">(</span><span class="s2">&quot;p&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">click</span><span class="p">(</span><span class="n">function</span> <span class="p">()</span> <span class="p">{</span>
<a id="__codelineno-47-15" name="__codelineno-47-15"></a>        <span class="err">$</span><span class="o">.</span><span class="n">ajax</span><span class="p">({</span>
<a id="__codelineno-47-16" name="__codelineno-47-16"></a>            <span class="n">url</span><span class="p">:</span> <span class="s2">&quot;http://127.0.0.1:8080/&quot;</span><span class="p">,</span>
<a id="__codelineno-47-17" name="__codelineno-47-17"></a>            <span class="n">success</span><span class="p">:</span> <span class="n">function</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="p">{</span>
<a id="__codelineno-47-18" name="__codelineno-47-18"></a>                <span class="err">$</span><span class="p">(</span><span class="s2">&quot;p&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">html</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">message</span><span class="p">)</span>
<a id="__codelineno-47-19" name="__codelineno-47-19"></a>            <span class="p">},</span>
<a id="__codelineno-47-20" name="__codelineno-47-20"></a>        <span class="p">})</span>
<a id="__codelineno-47-21" name="__codelineno-47-21"></a>    <span class="p">})</span>
<a id="__codelineno-47-22" name="__codelineno-47-22"></a>
<a id="__codelineno-47-23" name="__codelineno-47-23"></a><span class="o">&lt;/</span><span class="n">script</span><span class="o">&gt;</span>
<a id="__codelineno-47-24" name="__codelineno-47-24"></a><span class="o">&lt;/</span><span class="n">body</span><span class="o">&gt;</span>
<a id="__codelineno-47-25" name="__codelineno-47-25"></a><span class="o">&lt;/</span><span class="n">html</span><span class="o">&gt;</span>
</code></pre></div></td></tr></table></div>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Python</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-48-1">1</a></span>
<span class="normal"><a href="#__codelineno-48-2">2</a></span>
<span class="normal"><a href="#__codelineno-48-3">3</a></span>
<span class="normal"><a href="#__codelineno-48-4">4</a></span>
<span class="normal"><a href="#__codelineno-48-5">5</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-48-1" name="__codelineno-48-1"></a><span class="nd">@app</span><span class="o">.</span><span class="n">middleware</span><span class="p">(</span><span class="s2">&quot;http&quot;</span><span class="p">)</span>
<a id="__codelineno-48-2" name="__codelineno-48-2"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">CORSMiddleware</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">,</span> <span class="n">call_next</span><span class="p">):</span>
<a id="__codelineno-48-3" name="__codelineno-48-3"></a>    <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="n">call_next</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
<a id="__codelineno-48-4" name="__codelineno-48-4"></a>    <span class="nb">print</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">)</span>
<a id="__codelineno-48-5" name="__codelineno-48-5"></a>    <span class="k">return</span> <span class="n">response</span>
</code></pre></div></td></tr></table></div>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Python</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-49-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-49-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-49-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-49-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-49-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-49-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-49-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-49-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-49-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-49-10">10</a></span>
<span class="normal"><a href="#__codelineno-49-11">11</a></span>
<span class="normal"><a href="#__codelineno-49-12">12</a></span>
<span class="normal"><a href="#__codelineno-49-13">13</a></span>
<span class="normal"><a href="#__codelineno-49-14">14</a></span>
<span class="normal"><a href="#__codelineno-49-15">15</a></span>
<span class="normal"><a href="#__codelineno-49-16">16</a></span>
<span class="normal"><a href="#__codelineno-49-17">17</a></span>
<span class="normal"><a href="#__codelineno-49-18">18</a></span>
<span class="normal"><a href="#__codelineno-49-19">19</a></span>
<span class="normal"><a href="#__codelineno-49-20">20</a></span>
<span class="normal"><a href="#__codelineno-49-21">21</a></span>
<span class="normal"><a href="#__codelineno-49-22">22</a></span>
<span class="normal"><a href="#__codelineno-49-23">23</a></span>
<span class="normal"><a href="#__codelineno-49-24">24</a></span>
<span class="normal"><a href="#__codelineno-49-25">25</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-49-1" name="__codelineno-49-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">fastapi</span><span class="w"> </span><span class="kn">import</span> <span class="n">FastAPI</span>
<a id="__codelineno-49-2" name="__codelineno-49-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">fastapi.middleware.cors</span><span class="w"> </span><span class="kn">import</span> <span class="n">CORSMiddleware</span>
<a id="__codelineno-49-3" name="__codelineno-49-3"></a>
<a id="__codelineno-49-4" name="__codelineno-49-4"></a><span class="n">app</span> <span class="o">=</span> <span class="n">FastAPI</span><span class="p">()</span>
<a id="__codelineno-49-5" name="__codelineno-49-5"></a><span class="n">origins</span> <span class="o">=</span> <span class="p">[</span>
<a id="__codelineno-49-6" name="__codelineno-49-6"></a>    <span class="s2">&quot;http://localhost:63342&quot;</span>
<a id="__codelineno-49-7" name="__codelineno-49-7"></a><span class="p">]</span>
<a id="__codelineno-49-8" name="__codelineno-49-8"></a>
<a id="__codelineno-49-9" name="__codelineno-49-9"></a><span class="n">app</span><span class="o">.</span><span class="n">add_middleware</span><span class="p">(</span>
<a id="__codelineno-49-10" name="__codelineno-49-10"></a>    <span class="n">CORSMiddleware</span><span class="p">,</span>
<a id="__codelineno-49-11" name="__codelineno-49-11"></a>    <span class="n">allow_origins</span><span class="o">=</span><span class="n">origins</span><span class="p">,</span>  <span class="c1"># *ï¼šä»£è¡¨æ‰€æœ‰å®¢æˆ·ç«¯</span>
<a id="__codelineno-49-12" name="__codelineno-49-12"></a>    <span class="n">allow_credentials</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-49-13" name="__codelineno-49-13"></a>    <span class="n">allow_methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;GET&quot;</span><span class="p">],</span>
<a id="__codelineno-49-14" name="__codelineno-49-14"></a>    <span class="n">allow_headers</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;*&quot;</span><span class="p">],</span>
<a id="__codelineno-49-15" name="__codelineno-49-15"></a><span class="p">)</span>
<a id="__codelineno-49-16" name="__codelineno-49-16"></a>
<a id="__codelineno-49-17" name="__codelineno-49-17"></a><span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
<a id="__codelineno-49-18" name="__codelineno-49-18"></a><span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">():</span>
<a id="__codelineno-49-19" name="__codelineno-49-19"></a>    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;Hello World&quot;</span><span class="p">}</span>
<a id="__codelineno-49-20" name="__codelineno-49-20"></a>
<a id="__codelineno-49-21" name="__codelineno-49-21"></a>
<a id="__codelineno-49-22" name="__codelineno-49-22"></a><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
<a id="__codelineno-49-23" name="__codelineno-49-23"></a>    <span class="kn">import</span><span class="w"> </span><span class="nn">uvicorn</span>
<a id="__codelineno-49-24" name="__codelineno-49-24"></a>
<a id="__codelineno-49-25" name="__codelineno-49-25"></a>    <span class="n">uvicorn</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s2">&quot;main:app&quot;</span><span class="p">,</span> <span class="n">host</span><span class="o">=</span><span class="s2">&quot;127.0.0.1&quot;</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">8080</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">reload</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
<h2 id="å…¨å±€å¼‚å¸¸å¤„ç†">å…¨å±€å¼‚å¸¸å¤„ç†<a class="headerlink" href="#å…¨å±€å¼‚å¸¸å¤„ç†" title="Permanent link">&para;</a></h2>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Python</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-50-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-50-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-50-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-50-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-50-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-50-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-50-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-50-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-50-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-50-10">10</a></span>
<span class="normal"><a href="#__codelineno-50-11">11</a></span>
<span class="normal"><a href="#__codelineno-50-12">12</a></span>
<span class="normal"><a href="#__codelineno-50-13">13</a></span>
<span class="normal"><a href="#__codelineno-50-14">14</a></span>
<span class="normal"><a href="#__codelineno-50-15">15</a></span>
<span class="normal"><a href="#__codelineno-50-16">16</a></span>
<span class="normal"><a href="#__codelineno-50-17">17</a></span>
<span class="normal"><a href="#__codelineno-50-18">18</a></span>
<span class="normal"><a href="#__codelineno-50-19">19</a></span>
<span class="normal"><a href="#__codelineno-50-20">20</a></span>
<span class="normal"><a href="#__codelineno-50-21">21</a></span>
<span class="normal"><a href="#__codelineno-50-22">22</a></span>
<span class="normal"><a href="#__codelineno-50-23">23</a></span>
<span class="normal"><a href="#__codelineno-50-24">24</a></span>
<span class="normal"><a href="#__codelineno-50-25">25</a></span>
<span class="normal"><a href="#__codelineno-50-26">26</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-50-1" name="__codelineno-50-1"></a><span class="ch">#!/usr/bin/evn python</span>
<a id="__codelineno-50-2" name="__codelineno-50-2"></a><span class="c1"># -*- coding: utf-8 -*-</span>
<a id="__codelineno-50-3" name="__codelineno-50-3"></a>
<a id="__codelineno-50-4" name="__codelineno-50-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">fastapi</span><span class="w"> </span><span class="kn">import</span> <span class="n">FastAPI</span>
<a id="__codelineno-50-5" name="__codelineno-50-5"></a><span class="kn">from</span><span class="w"> </span><span class="nn">starlette.responses</span><span class="w"> </span><span class="kn">import</span> <span class="n">JSONResponse</span>
<a id="__codelineno-50-6" name="__codelineno-50-6"></a>
<a id="__codelineno-50-7" name="__codelineno-50-7"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">exception_not_found</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">exc</span><span class="p">):</span>
<a id="__codelineno-50-8" name="__codelineno-50-8"></a>    <span class="k">return</span> <span class="n">JSONResponse</span><span class="p">({</span>
<a id="__codelineno-50-9" name="__codelineno-50-9"></a>        <span class="s2">&quot;code&quot;</span><span class="p">:</span> <span class="n">exc</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span>
<a id="__codelineno-50-10" name="__codelineno-50-10"></a>        <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;æ²¡æœ‰å®šä¹‰è¿™ä¸ªè¯·æ±‚åœ°å€&quot;</span><span class="p">},</span>
<a id="__codelineno-50-11" name="__codelineno-50-11"></a>                        <span class="n">status_code</span><span class="o">=</span><span class="n">exc</span><span class="o">.</span><span class="n">status_code</span><span class="p">)</span>
<a id="__codelineno-50-12" name="__codelineno-50-12"></a>
<a id="__codelineno-50-13" name="__codelineno-50-13"></a><span class="n">exception_handlers</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-50-14" name="__codelineno-50-14"></a>    <span class="mi">404</span><span class="p">:</span> <span class="n">exception_not_found</span><span class="p">,</span>
<a id="__codelineno-50-15" name="__codelineno-50-15"></a><span class="p">}</span>
<a id="__codelineno-50-16" name="__codelineno-50-16"></a>
<a id="__codelineno-50-17" name="__codelineno-50-17"></a><span class="n">app</span> <span class="o">=</span> <span class="n">FastAPI</span><span class="p">(</span><span class="n">exception_handlers</span><span class="o">=</span><span class="n">exception_handlers</span><span class="p">)</span>
<a id="__codelineno-50-18" name="__codelineno-50-18"></a>
<a id="__codelineno-50-19" name="__codelineno-50-19"></a>
<a id="__codelineno-50-20" name="__codelineno-50-20"></a><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
<a id="__codelineno-50-21" name="__codelineno-50-21"></a>    <span class="kn">import</span><span class="w"> </span><span class="nn">uvicorn</span>
<a id="__codelineno-50-22" name="__codelineno-50-22"></a>    <span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<a id="__codelineno-50-23" name="__codelineno-50-23"></a>
<a id="__codelineno-50-24" name="__codelineno-50-24"></a>    <span class="n">app_modeel_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.py&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
<a id="__codelineno-50-25" name="__codelineno-50-25"></a>    <span class="nb">print</span><span class="p">(</span><span class="n">app_modeel_name</span><span class="p">)</span>
<a id="__codelineno-50-26" name="__codelineno-50-26"></a>    <span class="n">uvicorn</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">app_modeel_name</span><span class="si">}</span><span class="s2">:app&quot;</span><span class="p">,</span> <span class="n">host</span><span class="o">=</span><span class="s1">&#39;127.0.0.1&#39;</span><span class="p">,</span> <span class="n">reload</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
<h2 id="å­—å…¸jsonå’Œå¯¹è±¡çš„è½¬æ¢">å­—å…¸jsonå’Œå¯¹è±¡çš„è½¬æ¢<a class="headerlink" href="#å­—å…¸jsonå’Œå¯¹è±¡çš„è½¬æ¢" title="Permanent link">&para;</a></h2>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Python</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-51-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-51-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-51-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-51-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-51-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-51-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-51-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-51-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-51-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-51-10">10</a></span>
<span class="normal"><a href="#__codelineno-51-11">11</a></span>
<span class="normal"><a href="#__codelineno-51-12">12</a></span>
<span class="normal"><a href="#__codelineno-51-13">13</a></span>
<span class="normal"><a href="#__codelineno-51-14">14</a></span>
<span class="normal"><a href="#__codelineno-51-15">15</a></span>
<span class="normal"><a href="#__codelineno-51-16">16</a></span>
<span class="normal"><a href="#__codelineno-51-17">17</a></span>
<span class="normal"><a href="#__codelineno-51-18">18</a></span>
<span class="normal"><a href="#__codelineno-51-19">19</a></span>
<span class="normal"><a href="#__codelineno-51-20">20</a></span>
<span class="normal"><a href="#__codelineno-51-21">21</a></span>
<span class="normal"><a href="#__codelineno-51-22">22</a></span>
<span class="normal"><a href="#__codelineno-51-23">23</a></span>
<span class="normal"><a href="#__codelineno-51-24">24</a></span>
<span class="normal"><a href="#__codelineno-51-25">25</a></span>
<span class="normal"><a href="#__codelineno-51-26">26</a></span>
<span class="normal"><a href="#__codelineno-51-27">27</a></span>
<span class="normal"><a href="#__codelineno-51-28">28</a></span>
<span class="normal"><a href="#__codelineno-51-29">29</a></span>
<span class="normal"><a href="#__codelineno-51-30">30</a></span>
<span class="normal"><a href="#__codelineno-51-31">31</a></span>
<span class="normal"><a href="#__codelineno-51-32">32</a></span>
<span class="normal"><a href="#__codelineno-51-33">33</a></span>
<span class="normal"><a href="#__codelineno-51-34">34</a></span>
<span class="normal"><a href="#__codelineno-51-35">35</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-51-1" name="__codelineno-51-1"></a><span class="ch">#!/usr/bin/evn python</span>
<a id="__codelineno-51-2" name="__codelineno-51-2"></a><span class="c1"># -*- coding: utf-8 -*-</span>
<a id="__codelineno-51-3" name="__codelineno-51-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Union</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">List</span>
<a id="__codelineno-51-4" name="__codelineno-51-4"></a>
<a id="__codelineno-51-5" name="__codelineno-51-5"></a><span class="kn">from</span><span class="w"> </span><span class="nn">pydantic</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseModel</span><span class="p">,</span> <span class="n">ValidationError</span>
<a id="__codelineno-51-6" name="__codelineno-51-6"></a>
<a id="__codelineno-51-7" name="__codelineno-51-7"></a>
<a id="__codelineno-51-8" name="__codelineno-51-8"></a><span class="k">class</span><span class="w"> </span><span class="nc">Person</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
<a id="__codelineno-51-9" name="__codelineno-51-9"></a>    <span class="c1"># åŸºç¡€ç±»å‹</span>
<a id="__codelineno-51-10" name="__codelineno-51-10"></a>    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>  <span class="c1"># å­—ç¬¦ä¸²ç±»å‹</span>
<a id="__codelineno-51-11" name="__codelineno-51-11"></a>    <span class="n">password</span><span class="p">:</span> <span class="nb">str</span>  <span class="c1"># å­—ç¬¦ä¸²ç±»å‹</span>
<a id="__codelineno-51-12" name="__codelineno-51-12"></a>    <span class="n">age</span><span class="p">:</span> <span class="nb">int</span>  <span class="c1"># æ•´å½¢ç±»å‹</span>
<a id="__codelineno-51-13" name="__codelineno-51-13"></a>    <span class="n">enable</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># å¸ƒå°”ç±»å‹</span>
<a id="__codelineno-51-14" name="__codelineno-51-14"></a>
<a id="__codelineno-51-15" name="__codelineno-51-15"></a>
<a id="__codelineno-51-16" name="__codelineno-51-16"></a>
<a id="__codelineno-51-17" name="__codelineno-51-17"></a><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
<a id="__codelineno-51-18" name="__codelineno-51-18"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-51-19" name="__codelineno-51-19"></a>        <span class="n">user</span> <span class="o">=</span> <span class="n">Person</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;xiaozhong&#39;</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="s1">&#39;123456&#39;</span><span class="p">,</span> <span class="n">age</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<a id="__codelineno-51-20" name="__codelineno-51-20"></a>    <span class="k">except</span> <span class="n">ValidationError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-51-21" name="__codelineno-51-21"></a>        <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">errors</span><span class="p">())</span>
<a id="__codelineno-51-22" name="__codelineno-51-22"></a>        <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">json</span><span class="p">())</span>
<a id="__codelineno-51-23" name="__codelineno-51-23"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-51-24" name="__codelineno-51-24"></a>        <span class="c1"># print(user.dict())</span>
<a id="__codelineno-51-25" name="__codelineno-51-25"></a>        <span class="nb">print</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">dict</span><span class="p">(</span><span class="n">exclude_unset</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
<a id="__codelineno-51-26" name="__codelineno-51-26"></a>        <span class="c1"># print(user.dict(exclude={&#39;password&#39;}))</span>
<a id="__codelineno-51-27" name="__codelineno-51-27"></a>        <span class="nb">print</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">json</span><span class="p">(</span><span class="n">exclude</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;password&#39;</span><span class="p">},</span><span class="n">models_as_dict</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
<a id="__codelineno-51-28" name="__codelineno-51-28"></a>        <span class="c1"># # è¿›è¡Œæ‹·è´==================</span>
<a id="__codelineno-51-29" name="__codelineno-51-29"></a>        <span class="c1"># new_user = user.copy()</span>
<a id="__codelineno-51-30" name="__codelineno-51-30"></a>        <span class="c1"># print(&quot;userID&quot;, user, id(user))</span>
<a id="__codelineno-51-31" name="__codelineno-51-31"></a>        <span class="c1"># print(&quot;new_userID&quot;, new_user, id(new_user))</span>
<a id="__codelineno-51-32" name="__codelineno-51-32"></a>        <span class="c1"># # ä»…ä»…åŒ…å«å¯†ç è¾“å‡º===========</span>
<a id="__codelineno-51-33" name="__codelineno-51-33"></a>        <span class="n">new_user</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">include</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;password&#39;</span><span class="p">})</span>
<a id="__codelineno-51-34" name="__codelineno-51-34"></a>        <span class="c1"># print(&quot;new_user&quot;, new_user)</span>
<a id="__codelineno-51-35" name="__codelineno-51-35"></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;new_userID&quot;</span><span class="p">,</span> <span class="n">new_user</span><span class="p">,</span> <span class="nb">id</span><span class="p">(</span><span class="n">new_user</span><span class="p">))</span>
</code></pre></div></td></tr></table></div>
<h2 id="ç”Ÿå‘½å‘¨æœŸç®¡ç†">ç”Ÿå‘½å‘¨æœŸç®¡ç†<a class="headerlink" href="#ç”Ÿå‘½å‘¨æœŸç®¡ç†" title="Permanent link">&para;</a></h2>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Python</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-52-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-52-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-52-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-52-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-52-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-52-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-52-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-52-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-52-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-52-10">10</a></span>
<span class="normal"><a href="#__codelineno-52-11">11</a></span>
<span class="normal"><a href="#__codelineno-52-12">12</a></span>
<span class="normal"><a href="#__codelineno-52-13">13</a></span>
<span class="normal"><a href="#__codelineno-52-14">14</a></span>
<span class="normal"><a href="#__codelineno-52-15">15</a></span>
<span class="normal"><a href="#__codelineno-52-16">16</a></span>
<span class="normal"><a href="#__codelineno-52-17">17</a></span>
<span class="normal"><a href="#__codelineno-52-18">18</a></span>
<span class="normal"><a href="#__codelineno-52-19">19</a></span>
<span class="normal"><a href="#__codelineno-52-20">20</a></span>
<span class="normal"><a href="#__codelineno-52-21">21</a></span>
<span class="normal"><a href="#__codelineno-52-22">22</a></span>
<span class="normal"><a href="#__codelineno-52-23">23</a></span>
<span class="normal"><a href="#__codelineno-52-24">24</a></span>
<span class="normal"><a href="#__codelineno-52-25">25</a></span>
<span class="normal"><a href="#__codelineno-52-26">26</a></span>
<span class="normal"><a href="#__codelineno-52-27">27</a></span>
<span class="normal"><a href="#__codelineno-52-28">28</a></span>
<span class="normal"><a href="#__codelineno-52-29">29</a></span>
<span class="normal"><a href="#__codelineno-52-30">30</a></span>
<span class="normal"><a href="#__codelineno-52-31">31</a></span>
<span class="normal"><a href="#__codelineno-52-32">32</a></span>
<span class="normal"><a href="#__codelineno-52-33">33</a></span>
<span class="normal"><a href="#__codelineno-52-34">34</a></span>
<span class="normal"><a href="#__codelineno-52-35">35</a></span>
<span class="normal"><a href="#__codelineno-52-36">36</a></span>
<span class="normal"><a href="#__codelineno-52-37">37</a></span>
<span class="normal"><a href="#__codelineno-52-38">38</a></span>
<span class="normal"><a href="#__codelineno-52-39">39</a></span>
<span class="normal"><a href="#__codelineno-52-40">40</a></span>
<span class="normal"><a href="#__codelineno-52-41">41</a></span>
<span class="normal"><a href="#__codelineno-52-42">42</a></span>
<span class="normal"><a href="#__codelineno-52-43">43</a></span>
<span class="normal"><a href="#__codelineno-52-44">44</a></span>
<span class="normal"><a href="#__codelineno-52-45">45</a></span>
<span class="normal"><a href="#__codelineno-52-46">46</a></span>
<span class="normal"><a href="#__codelineno-52-47">47</a></span>
<span class="normal"><a href="#__codelineno-52-48">48</a></span>
<span class="normal"><a href="#__codelineno-52-49">49</a></span>
<span class="normal"><a href="#__codelineno-52-50">50</a></span>
<span class="normal"><a href="#__codelineno-52-51">51</a></span>
<span class="normal"><a href="#__codelineno-52-52">52</a></span>
<span class="normal"><a href="#__codelineno-52-53">53</a></span>
<span class="normal"><a href="#__codelineno-52-54">54</a></span>
<span class="normal"><a href="#__codelineno-52-55">55</a></span>
<span class="normal"><a href="#__codelineno-52-56">56</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-52-1" name="__codelineno-52-1"></a><span class="ch">#!/usr/bin/evn python</span>
<a id="__codelineno-52-2" name="__codelineno-52-2"></a><span class="c1"># -*- coding: utf-8 -*-</span>
<a id="__codelineno-52-3" name="__codelineno-52-3"></a><span class="c1"># å¼ƒç”¨</span>
<a id="__codelineno-52-4" name="__codelineno-52-4"></a><span class="c1"># from fastapi import FastAPI</span>
<a id="__codelineno-52-5" name="__codelineno-52-5"></a><span class="c1"># from starlette.background import BackgroundTasks</span>
<a id="__codelineno-52-6" name="__codelineno-52-6"></a><span class="c1"># import time</span>
<a id="__codelineno-52-7" name="__codelineno-52-7"></a><span class="c1">#</span>
<a id="__codelineno-52-8" name="__codelineno-52-8"></a><span class="c1"># app = FastAPI()</span>
<a id="__codelineno-52-9" name="__codelineno-52-9"></a><span class="c1">#</span>
<a id="__codelineno-52-10" name="__codelineno-52-10"></a><span class="c1"># # ç”Ÿå‘½å‘¨æœŸå¼‚æ­¥ä¸Šä¸‹æ–‡ç®¡ç†å™¨å¤„ç†ç¨‹åºä»£æ›¿å•ç‹¬çš„å¯åŠ¨å’Œå…³é—­å¤„ç†ç¨‹åº</span>
<a id="__codelineno-52-11" name="__codelineno-52-11"></a><span class="c1"># @app.on_event(&quot;startup&quot;)</span>
<a id="__codelineno-52-12" name="__codelineno-52-12"></a><span class="c1"># async def startup_event_async():</span>
<a id="__codelineno-52-13" name="__codelineno-52-13"></a><span class="c1">#     print(&quot;æœåŠ¡è¿›ç¨‹å¯åŠ¨æˆåŠŸ-asyncå‡½æ•°&quot;)</span>
<a id="__codelineno-52-14" name="__codelineno-52-14"></a><span class="c1">#</span>
<a id="__codelineno-52-15" name="__codelineno-52-15"></a><span class="c1"># @app.on_event(&quot;startup&quot;)</span>
<a id="__codelineno-52-16" name="__codelineno-52-16"></a><span class="c1"># def startup_event_sync():</span>
<a id="__codelineno-52-17" name="__codelineno-52-17"></a><span class="c1">#     print(&quot;æœåŠ¡è¿›ç¨‹å¯åŠ¨æˆåŠŸ-syncå‡½æ•°&quot;)</span>
<a id="__codelineno-52-18" name="__codelineno-52-18"></a><span class="c1">#</span>
<a id="__codelineno-52-19" name="__codelineno-52-19"></a><span class="c1"># @app.on_event(&quot;shutdown&quot;)</span>
<a id="__codelineno-52-20" name="__codelineno-52-20"></a><span class="c1"># async def shutdown_event_async():</span>
<a id="__codelineno-52-21" name="__codelineno-52-21"></a><span class="c1">#     print(&quot;æœåŠ¡è¿›ç¨‹å·²å…³é—­-asyncå‡½æ•°&quot;)</span>
<a id="__codelineno-52-22" name="__codelineno-52-22"></a><span class="c1">#</span>
<a id="__codelineno-52-23" name="__codelineno-52-23"></a><span class="c1">#</span>
<a id="__codelineno-52-24" name="__codelineno-52-24"></a><span class="c1"># @app.on_event(&quot;shutdown&quot;)</span>
<a id="__codelineno-52-25" name="__codelineno-52-25"></a><span class="c1"># def shutdown_event_sync():</span>
<a id="__codelineno-52-26" name="__codelineno-52-26"></a><span class="c1">#     print(&quot;æœåŠ¡è¿›ç¨‹å·²å…³é—­-syncå‡½æ•°&quot;)</span>
<a id="__codelineno-52-27" name="__codelineno-52-27"></a><span class="c1">#</span>
<a id="__codelineno-52-28" name="__codelineno-52-28"></a>
<a id="__codelineno-52-29" name="__codelineno-52-29"></a>
<a id="__codelineno-52-30" name="__codelineno-52-30"></a>
<a id="__codelineno-52-31" name="__codelineno-52-31"></a>
<a id="__codelineno-52-32" name="__codelineno-52-32"></a>
<a id="__codelineno-52-33" name="__codelineno-52-33"></a><span class="kn">from</span><span class="w"> </span><span class="nn">fastapi</span><span class="w"> </span><span class="kn">import</span> <span class="n">FastAPI</span>
<a id="__codelineno-52-34" name="__codelineno-52-34"></a><span class="kn">from</span><span class="w"> </span><span class="nn">contextlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">asynccontextmanager</span>
<a id="__codelineno-52-35" name="__codelineno-52-35"></a><span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<a id="__codelineno-52-36" name="__codelineno-52-36"></a>
<a id="__codelineno-52-37" name="__codelineno-52-37"></a><span class="nd">@asynccontextmanager</span>
<a id="__codelineno-52-38" name="__codelineno-52-38"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">lifespan</span><span class="p">(</span><span class="n">app</span><span class="p">:</span> <span class="n">FastAPI</span><span class="p">):</span>
<a id="__codelineno-52-39" name="__codelineno-52-39"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;æœåŠ¡è¿›ç¨‹å¯åŠ¨æˆåŠŸ-async lifespan&quot;</span><span class="p">)</span>
<a id="__codelineno-52-40" name="__codelineno-52-40"></a>    <span class="k">yield</span>
<a id="__codelineno-52-41" name="__codelineno-52-41"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;æœåŠ¡è¿›ç¨‹å·²å…³é—­-async lifespan&quot;</span><span class="p">)</span>
<a id="__codelineno-52-42" name="__codelineno-52-42"></a>
<a id="__codelineno-52-43" name="__codelineno-52-43"></a><span class="n">app</span> <span class="o">=</span> <span class="n">FastAPI</span><span class="p">(</span><span class="n">lifespan</span><span class="o">=</span><span class="n">lifespan</span><span class="p">)</span>
<a id="__codelineno-52-44" name="__codelineno-52-44"></a>
<a id="__codelineno-52-45" name="__codelineno-52-45"></a><span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
<a id="__codelineno-52-46" name="__codelineno-52-46"></a><span class="k">def</span><span class="w"> </span><span class="nf">read_root</span><span class="p">():</span>
<a id="__codelineno-52-47" name="__codelineno-52-47"></a>    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;msg&quot;</span><span class="p">:</span> <span class="s2">&quot;Hello&quot;</span><span class="p">}</span>
<a id="__codelineno-52-48" name="__codelineno-52-48"></a>
<a id="__codelineno-52-49" name="__codelineno-52-49"></a>
<a id="__codelineno-52-50" name="__codelineno-52-50"></a><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
<a id="__codelineno-52-51" name="__codelineno-52-51"></a>    <span class="kn">import</span><span class="w"> </span><span class="nn">uvicorn</span>
<a id="__codelineno-52-52" name="__codelineno-52-52"></a>    <span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<a id="__codelineno-52-53" name="__codelineno-52-53"></a>
<a id="__codelineno-52-54" name="__codelineno-52-54"></a>    <span class="n">app_modeel_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.py&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
<a id="__codelineno-52-55" name="__codelineno-52-55"></a>    <span class="nb">print</span><span class="p">(</span><span class="n">app_modeel_name</span><span class="p">)</span>
<a id="__codelineno-52-56" name="__codelineno-52-56"></a>    <span class="n">uvicorn</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">app_modeel_name</span><span class="si">}</span><span class="s2">:app&quot;</span><span class="p">,</span> <span class="n">host</span><span class="o">=</span><span class="s1">&#39;127.0.0.1&#39;</span><span class="p">,</span> <span class="n">reload</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">port</span><span class="o">=</span><span class="mi">10000</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
<h2 id="swaggeræ–‡æ¡£">swaggeræ–‡æ¡£<a class="headerlink" href="#swaggeræ–‡æ¡£" title="Permanent link">&para;</a></h2>
<h3 id="é…ç½®">é…ç½®<a class="headerlink" href="#é…ç½®" title="Permanent link">&para;</a></h3>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Python</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-53-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-53-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-53-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-53-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-53-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-53-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-53-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-53-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-53-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-53-10">10</a></span>
<span class="normal"><a href="#__codelineno-53-11">11</a></span>
<span class="normal"><a href="#__codelineno-53-12">12</a></span>
<span class="normal"><a href="#__codelineno-53-13">13</a></span>
<span class="normal"><a href="#__codelineno-53-14">14</a></span>
<span class="normal"><a href="#__codelineno-53-15">15</a></span>
<span class="normal"><a href="#__codelineno-53-16">16</a></span>
<span class="normal"><a href="#__codelineno-53-17">17</a></span>
<span class="normal"><a href="#__codelineno-53-18">18</a></span>
<span class="normal"><a href="#__codelineno-53-19">19</a></span>
<span class="normal"><a href="#__codelineno-53-20">20</a></span>
<span class="normal"><a href="#__codelineno-53-21">21</a></span>
<span class="normal"><a href="#__codelineno-53-22">22</a></span>
<span class="normal"><a href="#__codelineno-53-23">23</a></span>
<span class="normal"><a href="#__codelineno-53-24">24</a></span>
<span class="normal"><a href="#__codelineno-53-25">25</a></span>
<span class="normal"><a href="#__codelineno-53-26">26</a></span>
<span class="normal"><a href="#__codelineno-53-27">27</a></span>
<span class="normal"><a href="#__codelineno-53-28">28</a></span>
<span class="normal"><a href="#__codelineno-53-29">29</a></span>
<span class="normal"><a href="#__codelineno-53-30">30</a></span>
<span class="normal"><a href="#__codelineno-53-31">31</a></span>
<span class="normal"><a href="#__codelineno-53-32">32</a></span>
<span class="normal"><a href="#__codelineno-53-33">33</a></span>
<span class="normal"><a href="#__codelineno-53-34">34</a></span>
<span class="normal"><a href="#__codelineno-53-35">35</a></span>
<span class="normal"><a href="#__codelineno-53-36">36</a></span>
<span class="normal"><a href="#__codelineno-53-37">37</a></span>
<span class="normal"><a href="#__codelineno-53-38">38</a></span>
<span class="normal"><a href="#__codelineno-53-39">39</a></span>
<span class="normal"><a href="#__codelineno-53-40">40</a></span>
<span class="normal"><a href="#__codelineno-53-41">41</a></span>
<span class="normal"><a href="#__codelineno-53-42">42</a></span>
<span class="normal"><a href="#__codelineno-53-43">43</a></span>
<span class="normal"><a href="#__codelineno-53-44">44</a></span>
<span class="normal"><a href="#__codelineno-53-45">45</a></span>
<span class="normal"><a href="#__codelineno-53-46">46</a></span>
<span class="normal"><a href="#__codelineno-53-47">47</a></span>
<span class="normal"><a href="#__codelineno-53-48">48</a></span>
<span class="normal"><a href="#__codelineno-53-49">49</a></span>
<span class="normal"><a href="#__codelineno-53-50">50</a></span>
<span class="normal"><a href="#__codelineno-53-51">51</a></span>
<span class="normal"><a href="#__codelineno-53-52">52</a></span>
<span class="normal"><a href="#__codelineno-53-53">53</a></span>
<span class="normal"><a href="#__codelineno-53-54">54</a></span>
<span class="normal"><a href="#__codelineno-53-55">55</a></span>
<span class="normal"><a href="#__codelineno-53-56">56</a></span>
<span class="normal"><a href="#__codelineno-53-57">57</a></span>
<span class="normal"><a href="#__codelineno-53-58">58</a></span>
<span class="normal"><a href="#__codelineno-53-59">59</a></span>
<span class="normal"><a href="#__codelineno-53-60">60</a></span>
<span class="normal"><a href="#__codelineno-53-61">61</a></span>
<span class="normal"><a href="#__codelineno-53-62">62</a></span>
<span class="normal"><a href="#__codelineno-53-63">63</a></span>
<span class="normal"><a href="#__codelineno-53-64">64</a></span>
<span class="normal"><a href="#__codelineno-53-65">65</a></span>
<span class="normal"><a href="#__codelineno-53-66">66</a></span>
<span class="normal"><a href="#__codelineno-53-67">67</a></span>
<span class="normal"><a href="#__codelineno-53-68">68</a></span>
<span class="normal"><a href="#__codelineno-53-69">69</a></span>
<span class="normal"><a href="#__codelineno-53-70">70</a></span>
<span class="normal"><a href="#__codelineno-53-71">71</a></span>
<span class="normal"><a href="#__codelineno-53-72">72</a></span>
<span class="normal"><a href="#__codelineno-53-73">73</a></span>
<span class="normal"><a href="#__codelineno-53-74">74</a></span>
<span class="normal"><a href="#__codelineno-53-75">75</a></span>
<span class="normal"><a href="#__codelineno-53-76">76</a></span>
<span class="normal"><a href="#__codelineno-53-77">77</a></span>
<span class="normal"><a href="#__codelineno-53-78">78</a></span>
<span class="normal"><a href="#__codelineno-53-79">79</a></span>
<span class="normal"><a href="#__codelineno-53-80">80</a></span>
<span class="normal"><a href="#__codelineno-53-81">81</a></span>
<span class="normal"><a href="#__codelineno-53-82">82</a></span>
<span class="normal"><a href="#__codelineno-53-83">83</a></span>
<span class="normal"><a href="#__codelineno-53-84">84</a></span>
<span class="normal"><a href="#__codelineno-53-85">85</a></span>
<span class="normal"><a href="#__codelineno-53-86">86</a></span>
<span class="normal"><a href="#__codelineno-53-87">87</a></span>
<span class="normal"><a href="#__codelineno-53-88">88</a></span>
<span class="normal"><a href="#__codelineno-53-89">89</a></span>
<span class="normal"><a href="#__codelineno-53-90">90</a></span>
<span class="normal"><a href="#__codelineno-53-91">91</a></span>
<span class="normal"><a href="#__codelineno-53-92">92</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-53-1" name="__codelineno-53-1"></a><span class="ch">#!/usr/bin/env python</span>
<a id="__codelineno-53-2" name="__codelineno-53-2"></a><span class="c1"># -*- coding: utf-8 -*-</span>
<a id="__codelineno-53-3" name="__codelineno-53-3"></a>
<a id="__codelineno-53-4" name="__codelineno-53-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">fastapi</span><span class="w"> </span><span class="kn">import</span> <span class="n">FastAPI</span>
<a id="__codelineno-53-5" name="__codelineno-53-5"></a><span class="kn">from</span><span class="w"> </span><span class="nn">contextlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">asynccontextmanager</span>
<a id="__codelineno-53-6" name="__codelineno-53-6"></a><span class="kn">import</span><span class="w"> </span><span class="nn">socket</span>
<a id="__codelineno-53-7" name="__codelineno-53-7"></a>
<a id="__codelineno-53-8" name="__codelineno-53-8"></a><span class="n">HOST</span> <span class="o">=</span> <span class="s2">&quot;127.0.0.1&quot;</span>
<a id="__codelineno-53-9" name="__codelineno-53-9"></a><span class="n">PORT</span> <span class="o">=</span> <span class="mi">10000</span>
<a id="__codelineno-53-10" name="__codelineno-53-10"></a>
<a id="__codelineno-53-11" name="__codelineno-53-11"></a><span class="nd">@asynccontextmanager</span>
<a id="__codelineno-53-12" name="__codelineno-53-12"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">lifespan</span><span class="p">(</span><span class="n">app</span><span class="p">:</span> <span class="n">FastAPI</span><span class="p">):</span>
<a id="__codelineno-53-13" name="__codelineno-53-13"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;âœ… æœåŠ¡å¯åŠ¨ä¸­...&quot;</span><span class="p">)</span>
<a id="__codelineno-53-14" name="__codelineno-53-14"></a>
<a id="__codelineno-53-15" name="__codelineno-53-15"></a>    <span class="c1"># æ‰“å° Swagger æ–‡æ¡£åœ°å€</span>
<a id="__codelineno-53-16" name="__codelineno-53-16"></a>    <span class="n">print_docs_urls</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="n">host</span><span class="o">=</span><span class="n">HOST</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="n">PORT</span><span class="p">)</span>
<a id="__codelineno-53-17" name="__codelineno-53-17"></a>
<a id="__codelineno-53-18" name="__codelineno-53-18"></a>    <span class="k">yield</span>
<a id="__codelineno-53-19" name="__codelineno-53-19"></a>
<a id="__codelineno-53-20" name="__codelineno-53-20"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;ğŸ›‘ æœåŠ¡æ­£åœ¨å…³é—­...&quot;</span><span class="p">)</span>
<a id="__codelineno-53-21" name="__codelineno-53-21"></a>
<a id="__codelineno-53-22" name="__codelineno-53-22"></a><span class="k">def</span><span class="w"> </span><span class="nf">print_docs_urls</span><span class="p">(</span><span class="n">app</span><span class="p">:</span> <span class="n">FastAPI</span><span class="p">,</span> <span class="n">host</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">port</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
<a id="__codelineno-53-23" name="__codelineno-53-23"></a>    <span class="n">ip</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">gethostbyname</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">gethostname</span><span class="p">())</span>
<a id="__codelineno-53-24" name="__codelineno-53-24"></a>    <span class="n">base_url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;http://</span><span class="si">{</span><span class="n">host</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">port</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-53-25" name="__codelineno-53-25"></a>
<a id="__codelineno-53-26" name="__codelineno-53-26"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ğŸ”— Swagger Docs: </span><span class="si">{</span><span class="n">base_url</span><span class="si">}{</span><span class="n">app</span><span class="o">.</span><span class="n">docs_url</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-53-27" name="__codelineno-53-27"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ğŸ“˜ ReDoc Docs  : </span><span class="si">{</span><span class="n">base_url</span><span class="si">}{</span><span class="n">app</span><span class="o">.</span><span class="n">redoc_url</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-53-28" name="__codelineno-53-28"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ğŸ“„ OpenAPI JSON: </span><span class="si">{</span><span class="n">base_url</span><span class="si">}{</span><span class="n">app</span><span class="o">.</span><span class="n">openapi_url</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-53-29" name="__codelineno-53-29"></a>
<a id="__codelineno-53-30" name="__codelineno-53-30"></a><span class="n">app</span> <span class="o">=</span> <span class="n">FastAPI</span><span class="p">(</span>
<a id="__codelineno-53-31" name="__codelineno-53-31"></a>    <span class="n">title</span><span class="o">=</span><span class="s2">&quot;æ–‡æ¡£çš„æ ‡é¢˜&quot;</span><span class="p">,</span>
<a id="__codelineno-53-32" name="__codelineno-53-32"></a>    <span class="n">description</span><span class="o">=</span><span class="s2">&quot;å…³äºè¯¥APIæ–‡æ¡£çš„ä¸€äº›æè¿°ä¿¡æ¯è¡¥å……è¯´æ˜&quot;</span><span class="p">,</span>
<a id="__codelineno-53-33" name="__codelineno-53-33"></a>    <span class="n">version</span><span class="o">=</span><span class="s2">&quot;v1.0.0&quot;</span><span class="p">,</span>
<a id="__codelineno-53-34" name="__codelineno-53-34"></a>
<a id="__codelineno-53-35" name="__codelineno-53-35"></a>    <span class="n">docs_url</span><span class="o">=</span><span class="s2">&quot;/docs&quot;</span><span class="p">,</span>
<a id="__codelineno-53-36" name="__codelineno-53-36"></a>    <span class="n">redoc_url</span><span class="o">=</span><span class="s2">&quot;/redoc&quot;</span><span class="p">,</span>
<a id="__codelineno-53-37" name="__codelineno-53-37"></a>    <span class="n">openapi_url</span><span class="o">=</span><span class="s2">&quot;/openapi/openapi_json.json&quot;</span><span class="p">,</span>
<a id="__codelineno-53-38" name="__codelineno-53-38"></a>
<a id="__codelineno-53-39" name="__codelineno-53-39"></a>    <span class="n">swagger_ui_oauth2_redirect_url</span><span class="o">=</span><span class="s2">&quot;/docs/oauth2-redirect&quot;</span><span class="p">,</span>
<a id="__codelineno-53-40" name="__codelineno-53-40"></a>    <span class="n">swagger_ui_init_oauth</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-53-41" name="__codelineno-53-41"></a>
<a id="__codelineno-53-42" name="__codelineno-53-42"></a>    <span class="n">swagger_ui_parameters</span><span class="o">=</span><span class="p">{</span>
<a id="__codelineno-53-43" name="__codelineno-53-43"></a>        <span class="s2">&quot;defaultModelsExpandDepth&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>  <span class="c1"># é»˜è®¤ä¸å±•å¼€ Models</span>
<a id="__codelineno-53-44" name="__codelineno-53-44"></a>        <span class="s2">&quot;docExpansion&quot;</span><span class="p">:</span> <span class="s2">&quot;none&quot;</span><span class="p">,</span>          <span class="c1"># é»˜è®¤æŠ˜å æ¥å£åˆ—è¡¨</span>
<a id="__codelineno-53-45" name="__codelineno-53-45"></a>        <span class="s2">&quot;displayRequestDuration&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>  <span class="c1"># æ˜¾ç¤ºè¯·æ±‚æ—¶é•¿</span>
<a id="__codelineno-53-46" name="__codelineno-53-46"></a>    <span class="p">},</span>
<a id="__codelineno-53-47" name="__codelineno-53-47"></a>
<a id="__codelineno-53-48" name="__codelineno-53-48"></a>    <span class="n">terms_of_service</span><span class="o">=</span><span class="s2">&quot;https://terms/å›¢é˜Ÿçš„å®˜ç½‘ç½‘ç«™/&quot;</span><span class="p">,</span>
<a id="__codelineno-53-49" name="__codelineno-53-49"></a>    <span class="n">deprecated</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-53-50" name="__codelineno-53-50"></a>
<a id="__codelineno-53-51" name="__codelineno-53-51"></a>    <span class="n">contact</span><span class="o">=</span><span class="p">{</span>
<a id="__codelineno-53-52" name="__codelineno-53-52"></a>        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;API è´Ÿè´£äºº&quot;</span><span class="p">,</span>
<a id="__codelineno-53-53" name="__codelineno-53-53"></a>        <span class="s2">&quot;url&quot;</span><span class="p">:</span> <span class="s2">&quot;https://xxx.cc&quot;</span><span class="p">,</span>
<a id="__codelineno-53-54" name="__codelineno-53-54"></a>        <span class="s2">&quot;email&quot;</span><span class="p">:</span> <span class="s2">&quot;308711822@qq.com&quot;</span><span class="p">,</span>
<a id="__codelineno-53-55" name="__codelineno-53-55"></a>    <span class="p">},</span>
<a id="__codelineno-53-56" name="__codelineno-53-56"></a>    <span class="n">license_info</span><span class="o">=</span><span class="p">{</span>
<a id="__codelineno-53-57" name="__codelineno-53-57"></a>        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;ç‰ˆæƒä¿¡æ¯è¯´æ˜ License v3.0&quot;</span><span class="p">,</span>
<a id="__codelineno-53-58" name="__codelineno-53-58"></a>        <span class="s2">&quot;url&quot;</span><span class="p">:</span> <span class="s2">&quot;https://xxxxxxx.com&quot;</span><span class="p">,</span>
<a id="__codelineno-53-59" name="__codelineno-53-59"></a>    <span class="p">},</span>
<a id="__codelineno-53-60" name="__codelineno-53-60"></a>    <span class="n">openapi_tags</span><span class="o">=</span><span class="p">[</span>
<a id="__codelineno-53-61" name="__codelineno-53-61"></a>        <span class="p">{</span>
<a id="__codelineno-53-62" name="__codelineno-53-62"></a>            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;é€šç”¨æ¥å£&quot;</span><span class="p">,</span>
<a id="__codelineno-53-63" name="__codelineno-53-63"></a>            <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;å¯¹å¤–é€šç”¨åŸºç¡€æ¥å£&quot;</span><span class="p">,</span>
<a id="__codelineno-53-64" name="__codelineno-53-64"></a>        <span class="p">},</span>
<a id="__codelineno-53-65" name="__codelineno-53-65"></a>        <span class="p">{</span>
<a id="__codelineno-53-66" name="__codelineno-53-66"></a>            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;æµ‹è¯•åˆ†ç»„&quot;</span><span class="p">,</span>
<a id="__codelineno-53-67" name="__codelineno-53-67"></a>            <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;ç”¨äºæ¼”ç¤ºå’Œæµ‹è¯•åŠŸèƒ½æ¥å£&quot;</span><span class="p">,</span>
<a id="__codelineno-53-68" name="__codelineno-53-68"></a>        <span class="p">}</span>
<a id="__codelineno-53-69" name="__codelineno-53-69"></a>    <span class="p">],</span>
<a id="__codelineno-53-70" name="__codelineno-53-70"></a>    <span class="n">servers</span><span class="o">=</span><span class="p">[</span>
<a id="__codelineno-53-71" name="__codelineno-53-71"></a>        <span class="p">{</span><span class="s2">&quot;url&quot;</span><span class="p">:</span> <span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;æœ¬åœ°è°ƒè¯•ç¯å¢ƒ&quot;</span><span class="p">},</span>
<a id="__codelineno-53-72" name="__codelineno-53-72"></a>        <span class="p">{</span><span class="s2">&quot;url&quot;</span><span class="p">:</span> <span class="s2">&quot;https://xx.xx.com&quot;</span><span class="p">,</span> <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;çº¿ä¸Šæµ‹è¯•ç¯å¢ƒ&quot;</span><span class="p">},</span>
<a id="__codelineno-53-73" name="__codelineno-53-73"></a>        <span class="p">{</span><span class="s2">&quot;url&quot;</span><span class="p">:</span> <span class="s2">&quot;https://xx2.xx2.com&quot;</span><span class="p">,</span> <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;çº¿ä¸Šç”Ÿäº§ç¯å¢ƒ&quot;</span><span class="p">},</span>
<a id="__codelineno-53-74" name="__codelineno-53-74"></a>    <span class="p">],</span>
<a id="__codelineno-53-75" name="__codelineno-53-75"></a>    <span class="n">lifespan</span><span class="o">=</span><span class="n">lifespan</span>
<a id="__codelineno-53-76" name="__codelineno-53-76"></a><span class="p">)</span>
<a id="__codelineno-53-77" name="__codelineno-53-77"></a>
<a id="__codelineno-53-78" name="__codelineno-53-78"></a><span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="s2">&quot;/index&quot;</span><span class="p">,</span> <span class="n">tags</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;é€šç”¨æ¥å£&quot;</span><span class="p">])</span>
<a id="__codelineno-53-79" name="__codelineno-53-79"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">index</span><span class="p">():</span>
<a id="__codelineno-53-80" name="__codelineno-53-80"></a>    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;Hello from /index&quot;</span><span class="p">}</span>
<a id="__codelineno-53-81" name="__codelineno-53-81"></a>
<a id="__codelineno-53-82" name="__codelineno-53-82"></a><span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/echo&quot;</span><span class="p">,</span> <span class="n">tags</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;æµ‹è¯•åˆ†ç»„&quot;</span><span class="p">])</span>
<a id="__codelineno-53-83" name="__codelineno-53-83"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">echo_data</span><span class="p">(</span><span class="n">payload</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
<a id="__codelineno-53-84" name="__codelineno-53-84"></a>    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;you_sent&quot;</span><span class="p">:</span> <span class="n">payload</span><span class="p">}</span>
<a id="__codelineno-53-85" name="__codelineno-53-85"></a>
<a id="__codelineno-53-86" name="__codelineno-53-86"></a><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
<a id="__codelineno-53-87" name="__codelineno-53-87"></a>    <span class="kn">import</span><span class="w"> </span><span class="nn">uvicorn</span>
<a id="__codelineno-53-88" name="__codelineno-53-88"></a>    <span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<a id="__codelineno-53-89" name="__codelineno-53-89"></a>
<a id="__codelineno-53-90" name="__codelineno-53-90"></a>    <span class="n">module_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.py&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
<a id="__codelineno-53-91" name="__codelineno-53-91"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ğŸš€ å¯åŠ¨æ¨¡å—ï¼š</span><span class="si">{</span><span class="n">module_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-53-92" name="__codelineno-53-92"></a>    <span class="n">uvicorn</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">module_name</span><span class="si">}</span><span class="s2">:app&quot;</span><span class="p">,</span> <span class="n">host</span><span class="o">=</span><span class="n">HOST</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="n">PORT</span><span class="p">,</span> <span class="n">reload</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
<h3 id="å…³é—­">å…³é—­<a class="headerlink" href="#å…³é—­" title="Permanent link">&para;</a></h3>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Python</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-54-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-54-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-54-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-54-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-54-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-54-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-54-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-54-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-54-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-54-10">10</a></span>
<span class="normal"><a href="#__codelineno-54-11">11</a></span>
<span class="normal"><a href="#__codelineno-54-12">12</a></span>
<span class="normal"><a href="#__codelineno-54-13">13</a></span>
<span class="normal"><a href="#__codelineno-54-14">14</a></span>
<span class="normal"><a href="#__codelineno-54-15">15</a></span>
<span class="normal"><a href="#__codelineno-54-16">16</a></span>
<span class="normal"><a href="#__codelineno-54-17">17</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-54-1" name="__codelineno-54-1"></a><span class="ch">#!/usr/bin/evn python</span>
<a id="__codelineno-54-2" name="__codelineno-54-2"></a><span class="c1"># -*- coding: utf-8 -*-</span>
<a id="__codelineno-54-3" name="__codelineno-54-3"></a>
<a id="__codelineno-54-4" name="__codelineno-54-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">fastapi</span><span class="w"> </span><span class="kn">import</span> <span class="n">FastAPI</span>
<a id="__codelineno-54-5" name="__codelineno-54-5"></a><span class="n">app</span> <span class="o">=</span> <span class="n">FastAPI</span><span class="p">(</span>
<a id="__codelineno-54-6" name="__codelineno-54-6"></a>    <span class="n">docs_url</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-54-7" name="__codelineno-54-7"></a>    <span class="n">redoc_url</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-54-8" name="__codelineno-54-8"></a>    <span class="c1"># æˆ–è€…ç›´æ¥è®¾ç½®openapi_url=None</span>
<a id="__codelineno-54-9" name="__codelineno-54-9"></a>    <span class="n">openapi_url</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-54-10" name="__codelineno-54-10"></a><span class="p">)</span>
<a id="__codelineno-54-11" name="__codelineno-54-11"></a><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
<a id="__codelineno-54-12" name="__codelineno-54-12"></a>    <span class="kn">import</span><span class="w"> </span><span class="nn">uvicorn</span>
<a id="__codelineno-54-13" name="__codelineno-54-13"></a>    <span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<a id="__codelineno-54-14" name="__codelineno-54-14"></a>
<a id="__codelineno-54-15" name="__codelineno-54-15"></a>    <span class="n">app_modeel_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.py&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
<a id="__codelineno-54-16" name="__codelineno-54-16"></a>    <span class="nb">print</span><span class="p">(</span><span class="n">app_modeel_name</span><span class="p">)</span>
<a id="__codelineno-54-17" name="__codelineno-54-17"></a>    <span class="n">uvicorn</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">app_modeel_name</span><span class="si">}</span><span class="s2">:app&quot;</span><span class="p">,</span> <span class="n">host</span><span class="o">=</span><span class="s1">&#39;127.0.0.1&#39;</span><span class="p">,</span> <span class="n">reload</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
<h2 id="envé…ç½®è¯¦è§£">.envé…ç½®è¯¦è§£<a class="headerlink" href="#envé…ç½®è¯¦è§£" title="Permanent link">&para;</a></h2>
<p>.env</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Python</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-55-1">1</a></span>
<span class="normal"><a href="#__codelineno-55-2">2</a></span>
<span class="normal"><a href="#__codelineno-55-3">3</a></span>
<span class="normal"><a href="#__codelineno-55-4">4</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-55-1" name="__codelineno-55-1"></a><span class="n">DEBUG</span><span class="o">=</span><span class="n">true</span>
<a id="__codelineno-55-2" name="__codelineno-55-2"></a><span class="n">TITLE</span><span class="o">=</span><span class="s2">&quot;FastAPI&quot;</span>
<a id="__codelineno-55-3" name="__codelineno-55-3"></a><span class="n">DESCRIPTION</span><span class="o">=</span><span class="s2">&quot;FastAPIæ–‡æ¡£æ˜ç»†æè¿°&quot;</span>
<a id="__codelineno-55-4" name="__codelineno-55-4"></a><span class="n">vERSION</span><span class="o">=</span><span class="s2">&quot;v1.0.0&quot;</span>
</code></pre></div></td></tr></table></div>
<p>main.py</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Python</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-56-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-56-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-56-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-56-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-56-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-56-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-56-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-56-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-56-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-56-10">10</a></span>
<span class="normal"><a href="#__codelineno-56-11">11</a></span>
<span class="normal"><a href="#__codelineno-56-12">12</a></span>
<span class="normal"><a href="#__codelineno-56-13">13</a></span>
<span class="normal"><a href="#__codelineno-56-14">14</a></span>
<span class="normal"><a href="#__codelineno-56-15">15</a></span>
<span class="normal"><a href="#__codelineno-56-16">16</a></span>
<span class="normal"><a href="#__codelineno-56-17">17</a></span>
<span class="normal"><a href="#__codelineno-56-18">18</a></span>
<span class="normal"><a href="#__codelineno-56-19">19</a></span>
<span class="normal"><a href="#__codelineno-56-20">20</a></span>
<span class="normal"><a href="#__codelineno-56-21">21</a></span>
<span class="normal"><a href="#__codelineno-56-22">22</a></span>
<span class="normal"><a href="#__codelineno-56-23">23</a></span>
<span class="normal"><a href="#__codelineno-56-24">24</a></span>
<span class="normal"><a href="#__codelineno-56-25">25</a></span>
<span class="normal"><a href="#__codelineno-56-26">26</a></span>
<span class="normal"><a href="#__codelineno-56-27">27</a></span>
<span class="normal"><a href="#__codelineno-56-28">28</a></span>
<span class="normal"><a href="#__codelineno-56-29">29</a></span>
<span class="normal"><a href="#__codelineno-56-30">30</a></span>
<span class="normal"><a href="#__codelineno-56-31">31</a></span>
<span class="normal"><a href="#__codelineno-56-32">32</a></span>
<span class="normal"><a href="#__codelineno-56-33">33</a></span>
<span class="normal"><a href="#__codelineno-56-34">34</a></span>
<span class="normal"><a href="#__codelineno-56-35">35</a></span>
<span class="normal"><a href="#__codelineno-56-36">36</a></span>
<span class="normal"><a href="#__codelineno-56-37">37</a></span>
<span class="normal"><a href="#__codelineno-56-38">38</a></span>
<span class="normal"><a href="#__codelineno-56-39">39</a></span>
<span class="normal"><a href="#__codelineno-56-40">40</a></span>
<span class="normal"><a href="#__codelineno-56-41">41</a></span>
<span class="normal"><a href="#__codelineno-56-42">42</a></span>
<span class="normal"><a href="#__codelineno-56-43">43</a></span>
<span class="normal"><a href="#__codelineno-56-44">44</a></span>
<span class="normal"><a href="#__codelineno-56-45">45</a></span>
<span class="normal"><a href="#__codelineno-56-46">46</a></span>
<span class="normal"><a href="#__codelineno-56-47">47</a></span>
<span class="normal"><a href="#__codelineno-56-48">48</a></span>
<span class="normal"><a href="#__codelineno-56-49">49</a></span>
<span class="normal"><a href="#__codelineno-56-50">50</a></span>
<span class="normal"><a href="#__codelineno-56-51">51</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-56-1" name="__codelineno-56-1"></a><span class="ch">#!/usr/bin/evn python</span>
<a id="__codelineno-56-2" name="__codelineno-56-2"></a><span class="c1"># -*- coding: utf-8 -*-</span>
<a id="__codelineno-56-3" name="__codelineno-56-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">functools</span><span class="w"> </span><span class="kn">import</span> <span class="n">lru_cache</span>
<a id="__codelineno-56-4" name="__codelineno-56-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Optional</span>
<a id="__codelineno-56-5" name="__codelineno-56-5"></a><span class="kn">from</span><span class="w"> </span><span class="nn">fastapi</span><span class="w"> </span><span class="kn">import</span> <span class="n">FastAPI</span>
<a id="__codelineno-56-6" name="__codelineno-56-6"></a><span class="kn">from</span><span class="w"> </span><span class="nn">pydantic</span><span class="w"> </span><span class="kn">import</span> <span class="n">validator</span><span class="p">,</span> <span class="n">field_validator</span>
<a id="__codelineno-56-7" name="__codelineno-56-7"></a>
<a id="__codelineno-56-8" name="__codelineno-56-8"></a><span class="kn">from</span><span class="w"> </span><span class="nn">pydantic_settings</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseSettings</span>
<a id="__codelineno-56-9" name="__codelineno-56-9"></a>
<a id="__codelineno-56-10" name="__codelineno-56-10"></a><span class="k">class</span><span class="w"> </span><span class="nc">Settings</span><span class="p">(</span><span class="n">BaseSettings</span><span class="p">):</span>
<a id="__codelineno-56-11" name="__codelineno-56-11"></a>    <span class="n">debug</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
<a id="__codelineno-56-12" name="__codelineno-56-12"></a>    <span class="n">title</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-56-13" name="__codelineno-56-13"></a>    <span class="n">description</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-56-14" name="__codelineno-56-14"></a>    <span class="n">version</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-56-15" name="__codelineno-56-15"></a>
<a id="__codelineno-56-16" name="__codelineno-56-16"></a>    <span class="k">class</span><span class="w"> </span><span class="nc">Config</span><span class="p">:</span>
<a id="__codelineno-56-17" name="__codelineno-56-17"></a>        <span class="n">env_file</span> <span class="o">=</span> <span class="s2">&quot;.env&quot;</span>
<a id="__codelineno-56-18" name="__codelineno-56-18"></a>        <span class="n">env_file_encoding</span> <span class="o">=</span> <span class="s1">&#39;utf-8&#39;</span>
<a id="__codelineno-56-19" name="__codelineno-56-19"></a>
<a id="__codelineno-56-20" name="__codelineno-56-20"></a>    <span class="c1">#@validator(&quot;version&quot;, pre=True)  v1å¼ƒç”¨</span>
<a id="__codelineno-56-21" name="__codelineno-56-21"></a>    <span class="nd">@field_validator</span><span class="p">(</span><span class="s2">&quot;version&quot;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;before&quot;</span><span class="p">)</span>
<a id="__codelineno-56-22" name="__codelineno-56-22"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">version_len_check</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">v</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<a id="__codelineno-56-23" name="__codelineno-56-23"></a>        <span class="k">if</span> <span class="n">v</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-56-24" name="__codelineno-56-24"></a>            <span class="k">return</span> <span class="kc">None</span>
<a id="__codelineno-56-25" name="__codelineno-56-25"></a>        <span class="k">return</span> <span class="n">v</span>
<a id="__codelineno-56-26" name="__codelineno-56-26"></a>
<a id="__codelineno-56-27" name="__codelineno-56-27"></a><span class="nd">@lru_cache</span><span class="p">()</span>
<a id="__codelineno-56-28" name="__codelineno-56-28"></a><span class="k">def</span><span class="w"> </span><span class="nf">get_settings</span><span class="p">():</span>
<a id="__codelineno-56-29" name="__codelineno-56-29"></a>    <span class="k">return</span> <span class="n">Settings</span><span class="p">()</span>
<a id="__codelineno-56-30" name="__codelineno-56-30"></a>
<a id="__codelineno-56-31" name="__codelineno-56-31"></a><span class="n">settings</span> <span class="o">=</span> <span class="n">Settings</span><span class="p">()</span>
<a id="__codelineno-56-32" name="__codelineno-56-32"></a><span class="nb">print</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">debug</span><span class="p">)</span>
<a id="__codelineno-56-33" name="__codelineno-56-33"></a><span class="nb">print</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">title</span><span class="p">)</span>
<a id="__codelineno-56-34" name="__codelineno-56-34"></a><span class="nb">print</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">description</span><span class="p">)</span>
<a id="__codelineno-56-35" name="__codelineno-56-35"></a><span class="nb">print</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">version</span><span class="p">)</span>
<a id="__codelineno-56-36" name="__codelineno-56-36"></a>
<a id="__codelineno-56-37" name="__codelineno-56-37"></a><span class="n">settings</span> <span class="o">=</span> <span class="n">Settings</span><span class="p">(</span><span class="n">_env_file</span><span class="o">=</span><span class="s1">&#39;.env&#39;</span><span class="p">,</span> <span class="n">_env_file_encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
<a id="__codelineno-56-38" name="__codelineno-56-38"></a><span class="n">app</span> <span class="o">=</span> <span class="n">FastAPI</span><span class="p">(</span>
<a id="__codelineno-56-39" name="__codelineno-56-39"></a>    <span class="n">debug</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">debug</span><span class="p">,</span>
<a id="__codelineno-56-40" name="__codelineno-56-40"></a>    <span class="n">title</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">title</span><span class="p">,</span>
<a id="__codelineno-56-41" name="__codelineno-56-41"></a>    <span class="n">description</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">description</span><span class="p">,</span>
<a id="__codelineno-56-42" name="__codelineno-56-42"></a>    <span class="n">version</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">version</span><span class="p">,</span>
<a id="__codelineno-56-43" name="__codelineno-56-43"></a><span class="p">)</span>
<a id="__codelineno-56-44" name="__codelineno-56-44"></a>
<a id="__codelineno-56-45" name="__codelineno-56-45"></a>
<a id="__codelineno-56-46" name="__codelineno-56-46"></a><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
<a id="__codelineno-56-47" name="__codelineno-56-47"></a>    <span class="kn">import</span><span class="w"> </span><span class="nn">uvicorn</span>
<a id="__codelineno-56-48" name="__codelineno-56-48"></a>    <span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<a id="__codelineno-56-49" name="__codelineno-56-49"></a>    <span class="n">app_modeel_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.py&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
<a id="__codelineno-56-50" name="__codelineno-56-50"></a>    <span class="nb">print</span><span class="p">(</span><span class="n">app_modeel_name</span><span class="p">)</span>
<a id="__codelineno-56-51" name="__codelineno-56-51"></a>    <span class="n">uvicorn</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">app_modeel_name</span><span class="si">}</span><span class="s2">:app&quot;</span><span class="p">,</span> <span class="n">host</span><span class="o">=</span><span class="s1">&#39;127.0.0.1&#39;</span><span class="p">,</span> <span class="n">reload</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">port</span><span class="o">=</span><span class="mi">12345</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
<h2 id="åå°ä»»åŠ¡tasks">åå°ä»»åŠ¡tasks<a class="headerlink" href="#åå°ä»»åŠ¡tasks" title="Permanent link">&para;</a></h2>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Python</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-57-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-57-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-57-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-57-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-57-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-57-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-57-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-57-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-57-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-57-10">10</a></span>
<span class="normal"><a href="#__codelineno-57-11">11</a></span>
<span class="normal"><a href="#__codelineno-57-12">12</a></span>
<span class="normal"><a href="#__codelineno-57-13">13</a></span>
<span class="normal"><a href="#__codelineno-57-14">14</a></span>
<span class="normal"><a href="#__codelineno-57-15">15</a></span>
<span class="normal"><a href="#__codelineno-57-16">16</a></span>
<span class="normal"><a href="#__codelineno-57-17">17</a></span>
<span class="normal"><a href="#__codelineno-57-18">18</a></span>
<span class="normal"><a href="#__codelineno-57-19">19</a></span>
<span class="normal"><a href="#__codelineno-57-20">20</a></span>
<span class="normal"><a href="#__codelineno-57-21">21</a></span>
<span class="normal"><a href="#__codelineno-57-22">22</a></span>
<span class="normal"><a href="#__codelineno-57-23">23</a></span>
<span class="normal"><a href="#__codelineno-57-24">24</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-57-1" name="__codelineno-57-1"></a><span class="ch">#!/usr/bin/evn python</span>
<a id="__codelineno-57-2" name="__codelineno-57-2"></a><span class="c1"># -*- coding: utf-8 -*-</span>
<a id="__codelineno-57-3" name="__codelineno-57-3"></a>
<a id="__codelineno-57-4" name="__codelineno-57-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">fastapi</span><span class="w"> </span><span class="kn">import</span> <span class="n">FastAPI</span>
<a id="__codelineno-57-5" name="__codelineno-57-5"></a><span class="kn">from</span><span class="w"> </span><span class="nn">starlette.background</span><span class="w"> </span><span class="kn">import</span> <span class="n">BackgroundTasks</span>
<a id="__codelineno-57-6" name="__codelineno-57-6"></a><span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<a id="__codelineno-57-7" name="__codelineno-57-7"></a><span class="n">app</span> <span class="o">=</span> <span class="n">FastAPI</span><span class="p">(</span><span class="n">routes</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
<a id="__codelineno-57-8" name="__codelineno-57-8"></a><span class="kn">import</span><span class="w"> </span><span class="nn">asyncio</span>
<a id="__codelineno-57-9" name="__codelineno-57-9"></a><span class="k">def</span><span class="w"> </span><span class="nf">send_mail</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
<a id="__codelineno-57-10" name="__codelineno-57-10"></a>    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
<a id="__codelineno-57-11" name="__codelineno-57-11"></a>
<a id="__codelineno-57-12" name="__codelineno-57-12"></a><span class="nd">@app</span><span class="o">.</span><span class="n">api_route</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="s2">&quot;/index&quot;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;GET&quot;</span><span class="p">,</span> <span class="s2">&quot;POST&quot;</span><span class="p">])</span>
<a id="__codelineno-57-13" name="__codelineno-57-13"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">index</span><span class="p">(</span><span class="n">tasks</span><span class="p">:</span> <span class="n">BackgroundTasks</span><span class="p">):</span>
<a id="__codelineno-57-14" name="__codelineno-57-14"></a>    <span class="n">tasks</span><span class="o">.</span><span class="n">add_task</span><span class="p">(</span><span class="n">send_mail</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
<a id="__codelineno-57-15" name="__codelineno-57-15"></a>    <span class="nb">print</span><span class="p">(</span><span class="nb">id</span><span class="p">(</span><span class="n">asyncio</span><span class="o">.</span><span class="n">get_event_loop</span><span class="p">()))</span>
<a id="__codelineno-57-16" name="__codelineno-57-16"></a>    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;index&quot;</span><span class="p">:</span> <span class="s2">&quot;index&quot;</span><span class="p">}</span>
<a id="__codelineno-57-17" name="__codelineno-57-17"></a>
<a id="__codelineno-57-18" name="__codelineno-57-18"></a><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
<a id="__codelineno-57-19" name="__codelineno-57-19"></a>    <span class="kn">import</span><span class="w"> </span><span class="nn">uvicorn</span>
<a id="__codelineno-57-20" name="__codelineno-57-20"></a>    <span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<a id="__codelineno-57-21" name="__codelineno-57-21"></a>
<a id="__codelineno-57-22" name="__codelineno-57-22"></a>    <span class="n">app_modeel_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.py&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
<a id="__codelineno-57-23" name="__codelineno-57-23"></a>    <span class="nb">print</span><span class="p">(</span><span class="n">app_modeel_name</span><span class="p">)</span>
<a id="__codelineno-57-24" name="__codelineno-57-24"></a>    <span class="n">uvicorn</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">app_modeel_name</span><span class="si">}</span><span class="s2">:app&quot;</span><span class="p">,</span> <span class="n">host</span><span class="o">=</span><span class="s1">&#39;127.0.0.1&#39;</span><span class="p">,</span> <span class="n">reload</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
<h2 id="è¯·æ±‚å‚æ•°æ ¡éªŒè§„åˆ™å®šä¹‰">è¯·æ±‚å‚æ•°æ ¡éªŒè§„åˆ™å®šä¹‰<a class="headerlink" href="#è¯·æ±‚å‚æ•°æ ¡éªŒè§„åˆ™å®šä¹‰" title="Permanent link">&para;</a></h2>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Python</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-58-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-58-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-58-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-58-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-58-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-58-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-58-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-58-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-58-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-58-10">10</a></span>
<span class="normal"><a href="#__codelineno-58-11">11</a></span>
<span class="normal"><a href="#__codelineno-58-12">12</a></span>
<span class="normal"><a href="#__codelineno-58-13">13</a></span>
<span class="normal"><a href="#__codelineno-58-14">14</a></span>
<span class="normal"><a href="#__codelineno-58-15">15</a></span>
<span class="normal"><a href="#__codelineno-58-16">16</a></span>
<span class="normal"><a href="#__codelineno-58-17">17</a></span>
<span class="normal"><a href="#__codelineno-58-18">18</a></span>
<span class="normal"><a href="#__codelineno-58-19">19</a></span>
<span class="normal"><a href="#__codelineno-58-20">20</a></span>
<span class="normal"><a href="#__codelineno-58-21">21</a></span>
<span class="normal"><a href="#__codelineno-58-22">22</a></span>
<span class="normal"><a href="#__codelineno-58-23">23</a></span>
<span class="normal"><a href="#__codelineno-58-24">24</a></span>
<span class="normal"><a href="#__codelineno-58-25">25</a></span>
<span class="normal"><a href="#__codelineno-58-26">26</a></span>
<span class="normal"><a href="#__codelineno-58-27">27</a></span>
<span class="normal"><a href="#__codelineno-58-28">28</a></span>
<span class="normal"><a href="#__codelineno-58-29">29</a></span>
<span class="normal"><a href="#__codelineno-58-30">30</a></span>
<span class="normal"><a href="#__codelineno-58-31">31</a></span>
<span class="normal"><a href="#__codelineno-58-32">32</a></span>
<span class="normal"><a href="#__codelineno-58-33">33</a></span>
<span class="normal"><a href="#__codelineno-58-34">34</a></span>
<span class="normal"><a href="#__codelineno-58-35">35</a></span>
<span class="normal"><a href="#__codelineno-58-36">36</a></span>
<span class="normal"><a href="#__codelineno-58-37">37</a></span>
<span class="normal"><a href="#__codelineno-58-38">38</a></span>
<span class="normal"><a href="#__codelineno-58-39">39</a></span>
<span class="normal"><a href="#__codelineno-58-40">40</a></span>
<span class="normal"><a href="#__codelineno-58-41">41</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-58-1" name="__codelineno-58-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">fastapi</span><span class="w"> </span><span class="kn">import</span> <span class="n">FastAPI</span>
<a id="__codelineno-58-2" name="__codelineno-58-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">pydantic</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseModel</span><span class="p">,</span> <span class="n">root_validator</span><span class="p">,</span> <span class="n">Field</span><span class="p">,</span> <span class="n">model_validator</span>
<a id="__codelineno-58-3" name="__codelineno-58-3"></a>
<a id="__codelineno-58-4" name="__codelineno-58-4"></a><span class="n">app</span> <span class="o">=</span> <span class="n">FastAPI</span><span class="p">()</span>
<a id="__codelineno-58-5" name="__codelineno-58-5"></a>
<a id="__codelineno-58-6" name="__codelineno-58-6"></a>
<a id="__codelineno-58-7" name="__codelineno-58-7"></a><span class="k">class</span><span class="w"> </span><span class="nc">User</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
<a id="__codelineno-58-8" name="__codelineno-58-8"></a>    <span class="n">username</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;å§“å&#39;</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s1">&#39;å§“åå­—æ®µéœ€è¦é•¿åº¦å¤§äº6ä¸”å°äºç­‰äº12&#39;</span><span class="p">,</span> <span class="n">max_length</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">min_length</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="n">example</span><span class="o">=</span><span class="s2">&quot;Foo&quot;</span><span class="p">)</span>
<a id="__codelineno-58-9" name="__codelineno-58-9"></a>    <span class="n">age</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;å¹´é¾„&#39;</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s1">&#39;å¹´é¾„éœ€è¦å¤§äº18å²&#39;</span><span class="p">,</span> <span class="n">ge</span><span class="o">=</span><span class="mi">18</span><span class="p">,</span> <span class="n">example</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<a id="__codelineno-58-10" name="__codelineno-58-10"></a>    <span class="n">password_old</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;æ—§å¯†ç &#39;</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s1">&#39;å¯†ç éœ€è¦é•¿åº¦å¤§äº6&#39;</span><span class="p">,</span> <span class="n">gl</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="n">example</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
<a id="__codelineno-58-11" name="__codelineno-58-11"></a>    <span class="n">password_new</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;æ–°å¯†ç &#39;</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s1">&#39;å¯†ç éœ€è¦é•¿åº¦å¤§äº6&#39;</span><span class="p">,</span> <span class="n">gl</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="n">example</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
<a id="__codelineno-58-12" name="__codelineno-58-12"></a>
<a id="__codelineno-58-13" name="__codelineno-58-13"></a>    <span class="c1"># @root_validator  å¼ƒç”¨</span>
<a id="__codelineno-58-14" name="__codelineno-58-14"></a>    <span class="c1"># def check_passwords(cls, values):</span>
<a id="__codelineno-58-15" name="__codelineno-58-15"></a>    <span class="c1">#     password_old, password_new = values.get(&#39;password_old&#39;), values.get(&#39;password_new&#39;)</span>
<a id="__codelineno-58-16" name="__codelineno-58-16"></a>    <span class="c1">#     # æ–°æ—§å·ç çš„ç¡®è®¤åŒ¹é…å¤„ç†</span>
<a id="__codelineno-58-17" name="__codelineno-58-17"></a>    <span class="c1">#     if password_old and password_new and password_old != password_new:</span>
<a id="__codelineno-58-18" name="__codelineno-58-18"></a>    <span class="c1">#         raise ValueError(&#39;passwords do not match&#39;)</span>
<a id="__codelineno-58-19" name="__codelineno-58-19"></a>    <span class="c1">#     return values</span>
<a id="__codelineno-58-20" name="__codelineno-58-20"></a>    <span class="nd">@model_validator</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s2">&quot;after&quot;</span><span class="p">)</span>
<a id="__codelineno-58-21" name="__codelineno-58-21"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">check_passwords</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-58-22" name="__codelineno-58-22"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">password_old</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">password_new</span><span class="p">:</span>
<a id="__codelineno-58-23" name="__codelineno-58-23"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;passwords do not match&quot;</span><span class="p">)</span>
<a id="__codelineno-58-24" name="__codelineno-58-24"></a>        <span class="k">return</span> <span class="bp">self</span>
<a id="__codelineno-58-25" name="__codelineno-58-25"></a>
<a id="__codelineno-58-26" name="__codelineno-58-26"></a><span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/user&quot;</span><span class="p">)</span>
<a id="__codelineno-58-27" name="__codelineno-58-27"></a><span class="k">def</span><span class="w"> </span><span class="nf">read_user</span><span class="p">(</span><span class="n">user</span><span class="p">:</span> <span class="n">User</span><span class="p">):</span>
<a id="__codelineno-58-28" name="__codelineno-58-28"></a>    <span class="k">return</span> <span class="p">{</span>
<a id="__codelineno-58-29" name="__codelineno-58-29"></a>        <span class="s1">&#39;username&#39;</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">username</span><span class="p">,</span>
<a id="__codelineno-58-30" name="__codelineno-58-30"></a>        <span class="s1">&#39;password_old&#39;</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">password_old</span><span class="p">,</span>
<a id="__codelineno-58-31" name="__codelineno-58-31"></a>        <span class="s1">&#39;password_new&#39;</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">password_new</span><span class="p">,</span>
<a id="__codelineno-58-32" name="__codelineno-58-32"></a>    <span class="p">}</span>
<a id="__codelineno-58-33" name="__codelineno-58-33"></a>
<a id="__codelineno-58-34" name="__codelineno-58-34"></a>
<a id="__codelineno-58-35" name="__codelineno-58-35"></a><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
<a id="__codelineno-58-36" name="__codelineno-58-36"></a>    <span class="kn">import</span><span class="w"> </span><span class="nn">uvicorn</span>
<a id="__codelineno-58-37" name="__codelineno-58-37"></a>    <span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<a id="__codelineno-58-38" name="__codelineno-58-38"></a>
<a id="__codelineno-58-39" name="__codelineno-58-39"></a>    <span class="n">app_modeel_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.py&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
<a id="__codelineno-58-40" name="__codelineno-58-40"></a>    <span class="nb">print</span><span class="p">(</span><span class="n">app_modeel_name</span><span class="p">)</span>
<a id="__codelineno-58-41" name="__codelineno-58-41"></a>    <span class="n">uvicorn</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">app_modeel_name</span><span class="si">}</span><span class="s2">:app&quot;</span><span class="p">,</span> <span class="n">host</span><span class="o">=</span><span class="s1">&#39;127.0.0.1&#39;</span><span class="p">,</span> <span class="n">reload</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
<h2 id="ä¾èµ–æ³¨å…¥depends">ä¾èµ–æ³¨å…¥<code>Depends</code><a class="headerlink" href="#ä¾èµ–æ³¨å…¥depends" title="Permanent link">&para;</a></h2>
<h3 id="å®ç°ä¸€ä¸ªç®€å•çš„ç”¨æˆ·éªŒè¯æœºåˆ¶">å®ç°ä¸€ä¸ªç®€å•çš„ç”¨æˆ·éªŒè¯æœºåˆ¶<a class="headerlink" href="#å®ç°ä¸€ä¸ªç®€å•çš„ç”¨æˆ·éªŒè¯æœºåˆ¶" title="Permanent link">&para;</a></h3>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Python</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-59-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-59-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-59-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-59-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-59-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-59-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-59-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-59-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-59-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-59-10">10</a></span>
<span class="normal"><a href="#__codelineno-59-11">11</a></span>
<span class="normal"><a href="#__codelineno-59-12">12</a></span>
<span class="normal"><a href="#__codelineno-59-13">13</a></span>
<span class="normal"><a href="#__codelineno-59-14">14</a></span>
<span class="normal"><a href="#__codelineno-59-15">15</a></span>
<span class="normal"><a href="#__codelineno-59-16">16</a></span>
<span class="normal"><a href="#__codelineno-59-17">17</a></span>
<span class="normal"><a href="#__codelineno-59-18">18</a></span>
<span class="normal"><a href="#__codelineno-59-19">19</a></span>
<span class="normal"><a href="#__codelineno-59-20">20</a></span>
<span class="normal"><a href="#__codelineno-59-21">21</a></span>
<span class="normal"><a href="#__codelineno-59-22">22</a></span>
<span class="normal"><a href="#__codelineno-59-23">23</a></span>
<span class="normal"><a href="#__codelineno-59-24">24</a></span>
<span class="normal"><a href="#__codelineno-59-25">25</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-59-1" name="__codelineno-59-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">fastapi</span><span class="w"> </span><span class="kn">import</span> <span class="n">FastAPI</span><span class="p">,</span> <span class="n">Depends</span><span class="p">,</span> <span class="n">HTTPException</span><span class="p">,</span> <span class="n">status</span>
<a id="__codelineno-59-2" name="__codelineno-59-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Optional</span>
<a id="__codelineno-59-3" name="__codelineno-59-3"></a>
<a id="__codelineno-59-4" name="__codelineno-59-4"></a><span class="n">app</span> <span class="o">=</span> <span class="n">FastAPI</span><span class="p">()</span>
<a id="__codelineno-59-5" name="__codelineno-59-5"></a>
<a id="__codelineno-59-6" name="__codelineno-59-6"></a><span class="c1"># æ¨¡æ‹Ÿæ•°æ®åº“ä¸­çš„ token å¯¹åº”çš„ç”¨æˆ·</span>
<a id="__codelineno-59-7" name="__codelineno-59-7"></a><span class="n">fake_users_db</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-59-8" name="__codelineno-59-8"></a>    <span class="s2">&quot;token123&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;username&quot;</span><span class="p">:</span> <span class="s2">&quot;alice&quot;</span><span class="p">},</span>
<a id="__codelineno-59-9" name="__codelineno-59-9"></a>    <span class="s2">&quot;token456&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;username&quot;</span><span class="p">:</span> <span class="s2">&quot;bob&quot;</span><span class="p">},</span>
<a id="__codelineno-59-10" name="__codelineno-59-10"></a><span class="p">}</span>
<a id="__codelineno-59-11" name="__codelineno-59-11"></a>
<a id="__codelineno-59-12" name="__codelineno-59-12"></a><span class="c1"># ä¾èµ–å‡½æ•°ï¼šç”¨äºä»è¯·æ±‚ä¸­è·å– token å¹¶éªŒè¯ç”¨æˆ·èº«ä»½</span>
<a id="__codelineno-59-13" name="__codelineno-59-13"></a><span class="k">def</span><span class="w"> </span><span class="nf">get_current_user</span><span class="p">(</span><span class="n">token</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<a id="__codelineno-59-14" name="__codelineno-59-14"></a>    <span class="k">if</span> <span class="n">token</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">fake_users_db</span><span class="p">:</span>
<a id="__codelineno-59-15" name="__codelineno-59-15"></a>        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span>
<a id="__codelineno-59-16" name="__codelineno-59-16"></a>            <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_401_UNAUTHORIZED</span><span class="p">,</span>
<a id="__codelineno-59-17" name="__codelineno-59-17"></a>            <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;æ— æ•ˆçš„ä»¤ç‰Œ&quot;</span><span class="p">,</span>
<a id="__codelineno-59-18" name="__codelineno-59-18"></a>        <span class="p">)</span>
<a id="__codelineno-59-19" name="__codelineno-59-19"></a>    <span class="k">return</span> <span class="n">fake_users_db</span><span class="p">[</span><span class="n">token</span><span class="p">]</span>  <span class="c1"># è¿”å›ç”¨æˆ·ä¿¡æ¯</span>
<a id="__codelineno-59-20" name="__codelineno-59-20"></a>
<a id="__codelineno-59-21" name="__codelineno-59-21"></a><span class="c1"># ä½¿ç”¨ Depends æ³¨å…¥ get_current_user å‡½æ•°</span>
<a id="__codelineno-59-22" name="__codelineno-59-22"></a><span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/profile&quot;</span><span class="p">)</span>
<a id="__codelineno-59-23" name="__codelineno-59-23"></a><span class="k">def</span><span class="w"> </span><span class="nf">read_profile</span><span class="p">(</span><span class="n">user</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_current_user</span><span class="p">)):</span>
<a id="__codelineno-59-24" name="__codelineno-59-24"></a>    <span class="c1"># user æ˜¯ get_current_user è¿”å›çš„å­—å…¸</span>
<a id="__codelineno-59-25" name="__codelineno-59-25"></a>    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;ä½ å¥½ï¼Œ</span><span class="si">{</span><span class="n">user</span><span class="p">[</span><span class="s1">&#39;username&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">ï¼&quot;</span><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<h3 id="æ•°æ®åº“è¿æ¥ä¾èµ–ä»¥-sqlalchemy-ä¸ºä¾‹">æ•°æ®åº“è¿æ¥ä¾èµ–ï¼ˆä»¥ SQLAlchemy ä¸ºä¾‹ï¼‰<a class="headerlink" href="#æ•°æ®åº“è¿æ¥ä¾èµ–ä»¥-sqlalchemy-ä¸ºä¾‹" title="Permanent link">&para;</a></h3>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Python</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-60-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-60-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-60-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-60-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-60-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-60-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-60-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-60-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-60-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-60-10">10</a></span>
<span class="normal"><a href="#__codelineno-60-11">11</a></span>
<span class="normal"><a href="#__codelineno-60-12">12</a></span>
<span class="normal"><a href="#__codelineno-60-13">13</a></span>
<span class="normal"><a href="#__codelineno-60-14">14</a></span>
<span class="normal"><a href="#__codelineno-60-15">15</a></span>
<span class="normal"><a href="#__codelineno-60-16">16</a></span>
<span class="normal"><a href="#__codelineno-60-17">17</a></span>
<span class="normal"><a href="#__codelineno-60-18">18</a></span>
<span class="normal"><a href="#__codelineno-60-19">19</a></span>
<span class="normal"><a href="#__codelineno-60-20">20</a></span>
<span class="normal"><a href="#__codelineno-60-21">21</a></span>
<span class="normal"><a href="#__codelineno-60-22">22</a></span>
<span class="normal"><a href="#__codelineno-60-23">23</a></span>
<span class="normal"><a href="#__codelineno-60-24">24</a></span>
<span class="normal"><a href="#__codelineno-60-25">25</a></span>
<span class="normal"><a href="#__codelineno-60-26">26</a></span>
<span class="normal"><a href="#__codelineno-60-27">27</a></span>
<span class="normal"><a href="#__codelineno-60-28">28</a></span>
<span class="normal"><a href="#__codelineno-60-29">29</a></span>
<span class="normal"><a href="#__codelineno-60-30">30</a></span>
<span class="normal"><a href="#__codelineno-60-31">31</a></span>
<span class="normal"><a href="#__codelineno-60-32">32</a></span>
<span class="normal"><a href="#__codelineno-60-33">33</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-60-1" name="__codelineno-60-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">fastapi</span><span class="w"> </span><span class="kn">import</span> <span class="n">FastAPI</span><span class="p">,</span> <span class="n">Depends</span>
<a id="__codelineno-60-2" name="__codelineno-60-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy</span><span class="w"> </span><span class="kn">import</span> <span class="n">create_engine</span><span class="p">,</span> <span class="n">Column</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">String</span>
<a id="__codelineno-60-3" name="__codelineno-60-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.orm</span><span class="w"> </span><span class="kn">import</span> <span class="n">sessionmaker</span><span class="p">,</span> <span class="n">declarative_base</span><span class="p">,</span> <span class="n">Session</span>
<a id="__codelineno-60-4" name="__codelineno-60-4"></a>
<a id="__codelineno-60-5" name="__codelineno-60-5"></a><span class="n">DATABASE_URL</span> <span class="o">=</span> <span class="s2">&quot;sqlite:///./test.db&quot;</span>
<a id="__codelineno-60-6" name="__codelineno-60-6"></a>
<a id="__codelineno-60-7" name="__codelineno-60-7"></a><span class="n">engine</span> <span class="o">=</span> <span class="n">create_engine</span><span class="p">(</span><span class="n">DATABASE_URL</span><span class="p">,</span> <span class="n">connect_args</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;check_same_thread&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">})</span>
<a id="__codelineno-60-8" name="__codelineno-60-8"></a><span class="n">SessionLocal</span> <span class="o">=</span> <span class="n">sessionmaker</span><span class="p">(</span><span class="n">autocommit</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">autoflush</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">bind</span><span class="o">=</span><span class="n">engine</span><span class="p">)</span>
<a id="__codelineno-60-9" name="__codelineno-60-9"></a><span class="n">Base</span> <span class="o">=</span> <span class="n">declarative_base</span><span class="p">()</span>
<a id="__codelineno-60-10" name="__codelineno-60-10"></a>
<a id="__codelineno-60-11" name="__codelineno-60-11"></a><span class="c1"># æ¨¡æ‹Ÿä¸€ä¸ªç”¨æˆ·è¡¨</span>
<a id="__codelineno-60-12" name="__codelineno-60-12"></a><span class="k">class</span><span class="w"> </span><span class="nc">User</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
<a id="__codelineno-60-13" name="__codelineno-60-13"></a>    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;users&quot;</span>
<a id="__codelineno-60-14" name="__codelineno-60-14"></a>    <span class="nb">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-60-15" name="__codelineno-60-15"></a>    <span class="n">name</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-60-16" name="__codelineno-60-16"></a>
<a id="__codelineno-60-17" name="__codelineno-60-17"></a><span class="c1"># åˆ›å»ºè¡¨</span>
<a id="__codelineno-60-18" name="__codelineno-60-18"></a><span class="n">Base</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">create_all</span><span class="p">(</span><span class="n">bind</span><span class="o">=</span><span class="n">engine</span><span class="p">)</span>
<a id="__codelineno-60-19" name="__codelineno-60-19"></a>
<a id="__codelineno-60-20" name="__codelineno-60-20"></a><span class="c1"># ä¾èµ–ï¼šè·å–æ•°æ®åº“ session</span>
<a id="__codelineno-60-21" name="__codelineno-60-21"></a><span class="k">def</span><span class="w"> </span><span class="nf">get_db</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Session</span><span class="p">:</span>
<a id="__codelineno-60-22" name="__codelineno-60-22"></a>    <span class="n">db</span> <span class="o">=</span> <span class="n">SessionLocal</span><span class="p">()</span>
<a id="__codelineno-60-23" name="__codelineno-60-23"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-60-24" name="__codelineno-60-24"></a>        <span class="k">yield</span> <span class="n">db</span>  <span class="c1"># ä½¿ç”¨ yield æ˜¯ä¸ºäº†æ”¯æŒ with è‡ªåŠ¨å…³é—­</span>
<a id="__codelineno-60-25" name="__codelineno-60-25"></a>    <span class="k">finally</span><span class="p">:</span>
<a id="__codelineno-60-26" name="__codelineno-60-26"></a>        <span class="n">db</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<a id="__codelineno-60-27" name="__codelineno-60-27"></a>
<a id="__codelineno-60-28" name="__codelineno-60-28"></a><span class="n">app</span> <span class="o">=</span> <span class="n">FastAPI</span><span class="p">()</span>
<a id="__codelineno-60-29" name="__codelineno-60-29"></a>
<a id="__codelineno-60-30" name="__codelineno-60-30"></a><span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/users/</span><span class="si">{user_id}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-60-31" name="__codelineno-60-31"></a><span class="k">def</span><span class="w"> </span><span class="nf">read_user</span><span class="p">(</span><span class="n">user_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">db</span><span class="p">:</span> <span class="n">Session</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_db</span><span class="p">)):</span>
<a id="__codelineno-60-32" name="__codelineno-60-32"></a>    <span class="n">user</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">User</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">user_id</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
<a id="__codelineno-60-33" name="__codelineno-60-33"></a>    <span class="k">return</span> <span class="n">user</span> <span class="ow">or</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;ç”¨æˆ·ä¸å­˜åœ¨&quot;</span><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<h3 id="æƒé™æ§åˆ¶è§’è‰²æƒé™ä¾èµ–">æƒé™æ§åˆ¶ï¼ˆè§’è‰²æƒé™ä¾èµ–ï¼‰<a class="headerlink" href="#æƒé™æ§åˆ¶è§’è‰²æƒé™ä¾èµ–" title="Permanent link">&para;</a></h3>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Python</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-61-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-61-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-61-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-61-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-61-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-61-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-61-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-61-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-61-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-61-10">10</a></span>
<span class="normal"><a href="#__codelineno-61-11">11</a></span>
<span class="normal"><a href="#__codelineno-61-12">12</a></span>
<span class="normal"><a href="#__codelineno-61-13">13</a></span>
<span class="normal"><a href="#__codelineno-61-14">14</a></span>
<span class="normal"><a href="#__codelineno-61-15">15</a></span>
<span class="normal"><a href="#__codelineno-61-16">16</a></span>
<span class="normal"><a href="#__codelineno-61-17">17</a></span>
<span class="normal"><a href="#__codelineno-61-18">18</a></span>
<span class="normal"><a href="#__codelineno-61-19">19</a></span>
<span class="normal"><a href="#__codelineno-61-20">20</a></span>
<span class="normal"><a href="#__codelineno-61-21">21</a></span>
<span class="normal"><a href="#__codelineno-61-22">22</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-61-1" name="__codelineno-61-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">fastapi</span><span class="w"> </span><span class="kn">import</span> <span class="n">Depends</span><span class="p">,</span> <span class="n">HTTPException</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">Request</span>
<a id="__codelineno-61-2" name="__codelineno-61-2"></a>
<a id="__codelineno-61-3" name="__codelineno-61-3"></a><span class="c1"># æ¨¡æ‹Ÿç”¨æˆ·èº«ä»½</span>
<a id="__codelineno-61-4" name="__codelineno-61-4"></a><span class="k">def</span><span class="w"> </span><span class="nf">get_current_user</span><span class="p">(</span><span class="n">token</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">):</span>
<a id="__codelineno-61-5" name="__codelineno-61-5"></a>    <span class="n">users</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-61-6" name="__codelineno-61-6"></a>        <span class="s2">&quot;admin-token&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;username&quot;</span><span class="p">:</span> <span class="s2">&quot;admin&quot;</span><span class="p">,</span> <span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;admin&quot;</span><span class="p">},</span>
<a id="__codelineno-61-7" name="__codelineno-61-7"></a>        <span class="s2">&quot;user-token&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;username&quot;</span><span class="p">:</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;user&quot;</span><span class="p">},</span>
<a id="__codelineno-61-8" name="__codelineno-61-8"></a>    <span class="p">}</span>
<a id="__codelineno-61-9" name="__codelineno-61-9"></a>    <span class="n">user</span> <span class="o">=</span> <span class="n">users</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
<a id="__codelineno-61-10" name="__codelineno-61-10"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="p">:</span>
<a id="__codelineno-61-11" name="__codelineno-61-11"></a>        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">401</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;æœªè®¤è¯&quot;</span><span class="p">)</span>
<a id="__codelineno-61-12" name="__codelineno-61-12"></a>    <span class="k">return</span> <span class="n">user</span>
<a id="__codelineno-61-13" name="__codelineno-61-13"></a>
<a id="__codelineno-61-14" name="__codelineno-61-14"></a><span class="c1"># æƒé™æ§åˆ¶ä¾èµ–ï¼ˆåªå…è®¸ç®¡ç†å‘˜è®¿é—®ï¼‰</span>
<a id="__codelineno-61-15" name="__codelineno-61-15"></a><span class="k">def</span><span class="w"> </span><span class="nf">admin_required</span><span class="p">(</span><span class="n">user</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_current_user</span><span class="p">)):</span>
<a id="__codelineno-61-16" name="__codelineno-61-16"></a>    <span class="k">if</span> <span class="n">user</span><span class="p">[</span><span class="s2">&quot;role&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;admin&quot;</span><span class="p">:</span>
<a id="__codelineno-61-17" name="__codelineno-61-17"></a>        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">403</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;æƒé™ä¸è¶³&quot;</span><span class="p">)</span>
<a id="__codelineno-61-18" name="__codelineno-61-18"></a>    <span class="k">return</span> <span class="n">user</span>
<a id="__codelineno-61-19" name="__codelineno-61-19"></a>
<a id="__codelineno-61-20" name="__codelineno-61-20"></a><span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/admin&quot;</span><span class="p">)</span>
<a id="__codelineno-61-21" name="__codelineno-61-21"></a><span class="k">def</span><span class="w"> </span><span class="nf">admin_panel</span><span class="p">(</span><span class="n">current_user</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">admin_required</span><span class="p">)):</span>
<a id="__codelineno-61-22" name="__codelineno-61-22"></a>    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;æ¬¢è¿ç®¡ç†å‘˜ </span><span class="si">{</span><span class="n">current_user</span><span class="p">[</span><span class="s1">&#39;username&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">ï¼&quot;</span><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<h3 id="ä½¿ç”¨ä¾èµ–">ä½¿ç”¨ä¾èµ–<a class="headerlink" href="#ä½¿ç”¨ä¾èµ–" title="Permanent link">&para;</a></h3>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Python</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-62-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-62-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-62-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-62-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-62-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-62-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-62-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-62-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-62-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-62-10">10</a></span>
<span class="normal"><a href="#__codelineno-62-11">11</a></span>
<span class="normal"><a href="#__codelineno-62-12">12</a></span>
<span class="normal"><a href="#__codelineno-62-13">13</a></span>
<span class="normal"><a href="#__codelineno-62-14">14</a></span>
<span class="normal"><a href="#__codelineno-62-15">15</a></span>
<span class="normal"><a href="#__codelineno-62-16">16</a></span>
<span class="normal"><a href="#__codelineno-62-17">17</a></span>
<span class="normal"><a href="#__codelineno-62-18">18</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-62-1" name="__codelineno-62-1"></a><span class="c1"># urlæ³¨å…¥</span>
<a id="__codelineno-62-2" name="__codelineno-62-2"></a><span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/secure-data&quot;</span><span class="p">,</span> <span class="n">dependencies</span><span class="o">=</span><span class="p">[</span><span class="n">Depends</span><span class="p">(</span><span class="n">verify_token</span><span class="p">),</span> <span class="n">Depends</span><span class="p">(</span><span class="n">verify_key</span><span class="p">)])</span>
<a id="__codelineno-62-3" name="__codelineno-62-3"></a><span class="k">def</span><span class="w"> </span><span class="nf">secure_data</span><span class="p">(</span>
<a id="__codelineno-62-4" name="__codelineno-62-4"></a>    <span class="n">user</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">admin_required</span><span class="p">),</span>  <span class="c1">#è¦æ±‚æ‰§è¡Œadmin_requiredçš„ä¾èµ–</span>
<a id="__codelineno-62-5" name="__codelineno-62-5"></a>    <span class="n">db</span><span class="p">:</span> <span class="n">Session</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_db</span><span class="p">)</span>     <span class="c1">#è¦æ±‚æ³¨å…¥admin_requiredçš„ä¾èµ–</span>
<a id="__codelineno-62-6" name="__codelineno-62-6"></a><span class="p">):</span>
<a id="__codelineno-62-7" name="__codelineno-62-7"></a>
<a id="__codelineno-62-8" name="__codelineno-62-8"></a><span class="c1"># globalæ³¨å…¥</span>
<a id="__codelineno-62-9" name="__codelineno-62-9"></a><span class="n">app</span> <span class="o">=</span> <span class="n">FastAPI</span><span class="p">(</span><span class="n">dependencies</span><span class="o">=</span><span class="p">[</span><span class="n">Depends</span><span class="p">(</span><span class="n">verify_token</span><span class="p">),</span> <span class="n">Depends</span><span class="p">(</span><span class="n">verify_key</span><span class="p">)])</span>
<a id="__codelineno-62-10" name="__codelineno-62-10"></a>
<a id="__codelineno-62-11" name="__codelineno-62-11"></a>
<a id="__codelineno-62-12" name="__codelineno-62-12"></a><span class="c1"># yieldæ³¨å…¥</span>
<a id="__codelineno-62-13" name="__codelineno-62-13"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_db</span><span class="p">():</span>
<a id="__codelineno-62-14" name="__codelineno-62-14"></a>    <span class="n">db</span> <span class="o">=</span> <span class="n">DBSession</span><span class="p">()</span>
<a id="__codelineno-62-15" name="__codelineno-62-15"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-62-16" name="__codelineno-62-16"></a>        <span class="k">yield</span> <span class="n">db</span>
<a id="__codelineno-62-17" name="__codelineno-62-17"></a>    <span class="k">finally</span><span class="p">:</span>
<a id="__codelineno-62-18" name="__codelineno-62-18"></a>        <span class="n">db</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
<h2 id="è¿”å›è‡ªå®šä¹‰-response"><font style="color:rgba(0, 0, 0, 0.87);">è¿”å›è‡ªå®šä¹‰ </font><code>Response</code><a class="headerlink" href="#è¿”å›è‡ªå®šä¹‰-response" title="Permanent link">&para;</a></h2>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Python</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-63-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-63-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-63-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-63-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-63-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-63-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-63-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-63-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-63-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-63-10">10</a></span>
<span class="normal"><a href="#__codelineno-63-11">11</a></span>
<span class="normal"><a href="#__codelineno-63-12">12</a></span>
<span class="normal"><a href="#__codelineno-63-13">13</a></span>
<span class="normal"><a href="#__codelineno-63-14">14</a></span>
<span class="normal"><a href="#__codelineno-63-15">15</a></span>
<span class="normal"><a href="#__codelineno-63-16">16</a></span>
<span class="normal"><a href="#__codelineno-63-17">17</a></span>
<span class="normal"><a href="#__codelineno-63-18">18</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-63-1" name="__codelineno-63-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">fastapi</span><span class="w"> </span><span class="kn">import</span> <span class="n">FastAPI</span><span class="p">,</span> <span class="n">Response</span>
<a id="__codelineno-63-2" name="__codelineno-63-2"></a>
<a id="__codelineno-63-3" name="__codelineno-63-3"></a><span class="n">app</span> <span class="o">=</span> <span class="n">FastAPI</span><span class="p">()</span>
<a id="__codelineno-63-4" name="__codelineno-63-4"></a>
<a id="__codelineno-63-5" name="__codelineno-63-5"></a>
<a id="__codelineno-63-6" name="__codelineno-63-6"></a><span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/legacy/&quot;</span><span class="p">)</span>
<a id="__codelineno-63-7" name="__codelineno-63-7"></a><span class="k">def</span><span class="w"> </span><span class="nf">get_legacy_data</span><span class="p">():</span>
<a id="__codelineno-63-8" name="__codelineno-63-8"></a>    <span class="n">data</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;&lt;?xml version=&quot;1.0&quot;?&gt;</span>
<a id="__codelineno-63-9" name="__codelineno-63-9"></a><span class="s2">    &lt;shampoo&gt;</span>
<a id="__codelineno-63-10" name="__codelineno-63-10"></a><span class="s2">    &lt;Header&gt;</span>
<a id="__codelineno-63-11" name="__codelineno-63-11"></a><span class="s2">        Apply shampoo here.</span>
<a id="__codelineno-63-12" name="__codelineno-63-12"></a><span class="s2">    &lt;/Header&gt;</span>
<a id="__codelineno-63-13" name="__codelineno-63-13"></a><span class="s2">    &lt;Body&gt;</span>
<a id="__codelineno-63-14" name="__codelineno-63-14"></a><span class="s2">        You&#39;ll have to use soap here.</span>
<a id="__codelineno-63-15" name="__codelineno-63-15"></a><span class="s2">    &lt;/Body&gt;</span>
<a id="__codelineno-63-16" name="__codelineno-63-16"></a><span class="s2">    &lt;/shampoo&gt;</span>
<a id="__codelineno-63-17" name="__codelineno-63-17"></a><span class="s2">    &quot;&quot;&quot;</span>
<a id="__codelineno-63-18" name="__codelineno-63-18"></a>    <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">media_type</span><span class="o">=</span><span class="s2">&quot;application/xml&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
<h2 id="æ—¥å¿—é…ç½®">æ—¥å¿—é…ç½®<a class="headerlink" href="#æ—¥å¿—é…ç½®" title="Permanent link">&para;</a></h2>
<p>ä½¿ç”¨pythonåº“çš„loggingï¼Œ log_config.py  </p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Python</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-64-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-64-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-64-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-64-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-64-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-64-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-64-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-64-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-64-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-64-10">10</a></span>
<span class="normal"><a href="#__codelineno-64-11">11</a></span>
<span class="normal"><a href="#__codelineno-64-12">12</a></span>
<span class="normal"><a href="#__codelineno-64-13">13</a></span>
<span class="normal"><a href="#__codelineno-64-14">14</a></span>
<span class="normal"><a href="#__codelineno-64-15">15</a></span>
<span class="normal"><a href="#__codelineno-64-16">16</a></span>
<span class="normal"><a href="#__codelineno-64-17">17</a></span>
<span class="normal"><a href="#__codelineno-64-18">18</a></span>
<span class="normal"><a href="#__codelineno-64-19">19</a></span>
<span class="normal"><a href="#__codelineno-64-20">20</a></span>
<span class="normal"><a href="#__codelineno-64-21">21</a></span>
<span class="normal"><a href="#__codelineno-64-22">22</a></span>
<span class="normal"><a href="#__codelineno-64-23">23</a></span>
<span class="normal"><a href="#__codelineno-64-24">24</a></span>
<span class="normal"><a href="#__codelineno-64-25">25</a></span>
<span class="normal"><a href="#__codelineno-64-26">26</a></span>
<span class="normal"><a href="#__codelineno-64-27">27</a></span>
<span class="normal"><a href="#__codelineno-64-28">28</a></span>
<span class="normal"><a href="#__codelineno-64-29">29</a></span>
<span class="normal"><a href="#__codelineno-64-30">30</a></span>
<span class="normal"><a href="#__codelineno-64-31">31</a></span>
<span class="normal"><a href="#__codelineno-64-32">32</a></span>
<span class="normal"><a href="#__codelineno-64-33">33</a></span>
<span class="normal"><a href="#__codelineno-64-34">34</a></span>
<span class="normal"><a href="#__codelineno-64-35">35</a></span>
<span class="normal"><a href="#__codelineno-64-36">36</a></span>
<span class="normal"><a href="#__codelineno-64-37">37</a></span>
<span class="normal"><a href="#__codelineno-64-38">38</a></span>
<span class="normal"><a href="#__codelineno-64-39">39</a></span>
<span class="normal"><a href="#__codelineno-64-40">40</a></span>
<span class="normal"><a href="#__codelineno-64-41">41</a></span>
<span class="normal"><a href="#__codelineno-64-42">42</a></span>
<span class="normal"><a href="#__codelineno-64-43">43</a></span>
<span class="normal"><a href="#__codelineno-64-44">44</a></span>
<span class="normal"><a href="#__codelineno-64-45">45</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-64-1" name="__codelineno-64-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<a id="__codelineno-64-2" name="__codelineno-64-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">logging.handlers</span><span class="w"> </span><span class="kn">import</span> <span class="n">TimedRotatingFileHandler</span>
<a id="__codelineno-64-3" name="__codelineno-64-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<a id="__codelineno-64-4" name="__codelineno-64-4"></a>
<a id="__codelineno-64-5" name="__codelineno-64-5"></a><span class="c1"># æ—¥å¿—ç›®å½•å’Œæ–‡ä»¶</span>
<a id="__codelineno-64-6" name="__codelineno-64-6"></a><span class="n">LOG_DIR</span> <span class="o">=</span> <span class="s2">&quot;logs&quot;</span>
<a id="__codelineno-64-7" name="__codelineno-64-7"></a><span class="n">LOG_FILE</span> <span class="o">=</span> <span class="s2">&quot;app.log&quot;</span>
<a id="__codelineno-64-8" name="__codelineno-64-8"></a><span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">LOG_DIR</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-64-9" name="__codelineno-64-9"></a>
<a id="__codelineno-64-10" name="__codelineno-64-10"></a><span class="c1"># åˆ›å»º logger å®ä¾‹</span>
<a id="__codelineno-64-11" name="__codelineno-64-11"></a><span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;myapp&quot;</span><span class="p">)</span>
<a id="__codelineno-64-12" name="__codelineno-64-12"></a><span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>  <span class="c1"># å¯è®¾ä¸º DEBUGã€WARNINGã€ERROR ç­‰</span>
<a id="__codelineno-64-13" name="__codelineno-64-13"></a>
<a id="__codelineno-64-14" name="__codelineno-64-14"></a><span class="c1"># è®¾ç½®æ—¥å¿—æ ¼å¼</span>
<a id="__codelineno-64-15" name="__codelineno-64-15"></a><span class="n">log_format</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">Formatter</span><span class="p">(</span>
<a id="__codelineno-64-16" name="__codelineno-64-16"></a>    <span class="s2">&quot;[</span><span class="si">%(asctime)s</span><span class="s2">] [</span><span class="si">%(levelname)s</span><span class="s2">] </span><span class="si">%(name)s</span><span class="s2">: </span><span class="si">%(message)s</span><span class="s2">&quot;</span><span class="p">,</span>
<a id="__codelineno-64-17" name="__codelineno-64-17"></a>    <span class="n">datefmt</span><span class="o">=</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M:%S&quot;</span>
<a id="__codelineno-64-18" name="__codelineno-64-18"></a><span class="p">)</span>
<a id="__codelineno-64-19" name="__codelineno-64-19"></a>
<a id="__codelineno-64-20" name="__codelineno-64-20"></a><span class="c1"># æ§åˆ¶å°æ—¥å¿— handler</span>
<a id="__codelineno-64-21" name="__codelineno-64-21"></a><span class="n">console_handler</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">StreamHandler</span><span class="p">()</span>
<a id="__codelineno-64-22" name="__codelineno-64-22"></a><span class="n">console_handler</span><span class="o">.</span><span class="n">setFormatter</span><span class="p">(</span><span class="n">log_format</span><span class="p">)</span>
<a id="__codelineno-64-23" name="__codelineno-64-23"></a>
<a id="__codelineno-64-24" name="__codelineno-64-24"></a><span class="c1"># æ–‡ä»¶æ—¥å¿— handlerï¼ˆæŒ‰å¤©è½®è½¬ï¼Œä¿ç•™7å¤©ï¼‰</span>
<a id="__codelineno-64-25" name="__codelineno-64-25"></a><span class="n">file_handler</span> <span class="o">=</span> <span class="n">TimedRotatingFileHandler</span><span class="p">(</span>
<a id="__codelineno-64-26" name="__codelineno-64-26"></a>    <span class="n">filename</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">LOG_DIR</span><span class="p">,</span> <span class="n">LOG_FILE</span><span class="p">),</span>
<a id="__codelineno-64-27" name="__codelineno-64-27"></a>    <span class="n">when</span><span class="o">=</span><span class="s2">&quot;midnight&quot;</span><span class="p">,</span>       <span class="c1"># æ¯å¤©è½®è½¬ä¸€æ¬¡</span>
<a id="__codelineno-64-28" name="__codelineno-64-28"></a>    <span class="n">backupCount</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span>         <span class="c1"># æœ€å¤šä¿ç•™7ä¸ªæ—§æ—¥å¿—æ–‡ä»¶</span>
<a id="__codelineno-64-29" name="__codelineno-64-29"></a>    <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span>
<a id="__codelineno-64-30" name="__codelineno-64-30"></a><span class="p">)</span>
<a id="__codelineno-64-31" name="__codelineno-64-31"></a><span class="c1">#æˆ–è€…ä½¿ç”¨æ–‡ä»¶å¤§å°è½®è½¬</span>
<a id="__codelineno-64-32" name="__codelineno-64-32"></a><span class="c1"># from logging.handlers import RotatingFileHandler</span>
<a id="__codelineno-64-33" name="__codelineno-64-33"></a>
<a id="__codelineno-64-34" name="__codelineno-64-34"></a><span class="c1"># file_handler = RotatingFileHandler(</span>
<a id="__codelineno-64-35" name="__codelineno-64-35"></a><span class="c1">#     filename=os.path.join(LOG_DIR, LOG_FILE),</span>
<a id="__codelineno-64-36" name="__codelineno-64-36"></a><span class="c1">#     maxBytes=5 * 1024 * 1024,  # æ¯ä¸ªæ–‡ä»¶æœ€å¤§5MB</span>
<a id="__codelineno-64-37" name="__codelineno-64-37"></a><span class="c1">#     backupCount=5,             # æœ€å¤šä¿ç•™5ä¸ªæ—§æ–‡ä»¶</span>
<a id="__codelineno-64-38" name="__codelineno-64-38"></a><span class="c1">#     encoding=&quot;utf-8&quot;</span>
<a id="__codelineno-64-39" name="__codelineno-64-39"></a><span class="c1"># )</span>
<a id="__codelineno-64-40" name="__codelineno-64-40"></a>
<a id="__codelineno-64-41" name="__codelineno-64-41"></a><span class="n">file_handler</span><span class="o">.</span><span class="n">setFormatter</span><span class="p">(</span><span class="n">log_format</span><span class="p">)</span>
<a id="__codelineno-64-42" name="__codelineno-64-42"></a>
<a id="__codelineno-64-43" name="__codelineno-64-43"></a><span class="c1"># æ·»åŠ  handler</span>
<a id="__codelineno-64-44" name="__codelineno-64-44"></a><span class="n">logger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">console_handler</span><span class="p">)</span>
<a id="__codelineno-64-45" name="__codelineno-64-45"></a><span class="n">logger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">file_handler</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
<p>main.pyï¼Œè‡ªå®šä¹‰ä¸­é—´ä»¶</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Python</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-65-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-65-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-65-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-65-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-65-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-65-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-65-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-65-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-65-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-65-10">10</a></span>
<span class="normal"><a href="#__codelineno-65-11">11</a></span>
<span class="normal"><a href="#__codelineno-65-12">12</a></span>
<span class="normal"><a href="#__codelineno-65-13">13</a></span>
<span class="normal"><a href="#__codelineno-65-14">14</a></span>
<span class="normal"><a href="#__codelineno-65-15">15</a></span>
<span class="normal"><a href="#__codelineno-65-16">16</a></span>
<span class="normal"><a href="#__codelineno-65-17">17</a></span>
<span class="normal"><a href="#__codelineno-65-18">18</a></span>
<span class="normal"><a href="#__codelineno-65-19">19</a></span>
<span class="normal"><a href="#__codelineno-65-20">20</a></span>
<span class="normal"><a href="#__codelineno-65-21">21</a></span>
<span class="normal"><a href="#__codelineno-65-22">22</a></span>
<span class="normal"><a href="#__codelineno-65-23">23</a></span>
<span class="normal"><a href="#__codelineno-65-24">24</a></span>
<span class="normal"><a href="#__codelineno-65-25">25</a></span>
<span class="normal"><a href="#__codelineno-65-26">26</a></span>
<span class="normal"><a href="#__codelineno-65-27">27</a></span>
<span class="normal"><a href="#__codelineno-65-28">28</a></span>
<span class="normal"><a href="#__codelineno-65-29">29</a></span>
<span class="normal"><a href="#__codelineno-65-30">30</a></span>
<span class="normal"><a href="#__codelineno-65-31">31</a></span>
<span class="normal"><a href="#__codelineno-65-32">32</a></span>
<span class="normal"><a href="#__codelineno-65-33">33</a></span>
<span class="normal"><a href="#__codelineno-65-34">34</a></span>
<span class="normal"><a href="#__codelineno-65-35">35</a></span>
<span class="normal"><a href="#__codelineno-65-36">36</a></span>
<span class="normal"><a href="#__codelineno-65-37">37</a></span>
<span class="normal"><a href="#__codelineno-65-38">38</a></span>
<span class="normal"><a href="#__codelineno-65-39">39</a></span>
<span class="normal"><a href="#__codelineno-65-40">40</a></span>
<span class="normal"><a href="#__codelineno-65-41">41</a></span>
<span class="normal"><a href="#__codelineno-65-42">42</a></span>
<span class="normal"><a href="#__codelineno-65-43">43</a></span>
<span class="normal"><a href="#__codelineno-65-44">44</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-65-1" name="__codelineno-65-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<a id="__codelineno-65-2" name="__codelineno-65-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<a id="__codelineno-65-3" name="__codelineno-65-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">fastapi</span><span class="w"> </span><span class="kn">import</span> <span class="n">FastAPI</span><span class="p">,</span> <span class="n">Request</span>
<a id="__codelineno-65-4" name="__codelineno-65-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">starlette.responses</span><span class="w"> </span><span class="kn">import</span> <span class="n">Response</span>
<a id="__codelineno-65-5" name="__codelineno-65-5"></a><span class="kn">from</span><span class="w"> </span><span class="nn">starlette.middleware.base</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseHTTPMiddleware</span>
<a id="__codelineno-65-6" name="__codelineno-65-6"></a><span class="kn">from</span><span class="w"> </span><span class="nn">log_config</span><span class="w"> </span><span class="kn">import</span> <span class="n">logger</span>
<a id="__codelineno-65-7" name="__codelineno-65-7"></a>
<a id="__codelineno-65-8" name="__codelineno-65-8"></a><span class="n">app</span> <span class="o">=</span> <span class="n">FastAPI</span><span class="p">()</span>
<a id="__codelineno-65-9" name="__codelineno-65-9"></a>
<a id="__codelineno-65-10" name="__codelineno-65-10"></a><span class="k">class</span><span class="w"> </span><span class="nc">LoggingMiddleware</span><span class="p">(</span><span class="n">BaseHTTPMiddleware</span><span class="p">):</span>
<a id="__codelineno-65-11" name="__codelineno-65-11"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">dispatch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">,</span> <span class="n">call_next</span><span class="p">):</span>
<a id="__codelineno-65-12" name="__codelineno-65-12"></a>        <span class="c1"># è®°å½•è¯·æ±‚ä¿¡æ¯</span>
<a id="__codelineno-65-13" name="__codelineno-65-13"></a>        <span class="n">request_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<a id="__codelineno-65-14" name="__codelineno-65-14"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-65-15" name="__codelineno-65-15"></a>            <span class="n">request_body</span> <span class="o">=</span> <span class="k">await</span> <span class="n">request</span><span class="o">.</span><span class="n">body</span><span class="p">()</span>
<a id="__codelineno-65-16" name="__codelineno-65-16"></a>            <span class="n">request_body</span> <span class="o">=</span> <span class="n">request_body</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
<a id="__codelineno-65-17" name="__codelineno-65-17"></a>        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
<a id="__codelineno-65-18" name="__codelineno-65-18"></a>            <span class="n">request_body</span> <span class="o">=</span> <span class="s2">&quot;&lt;æ— æ³•è§£æçš„è¯·æ±‚ä½“&gt;&quot;</span>
<a id="__codelineno-65-19" name="__codelineno-65-19"></a>
<a id="__codelineno-65-20" name="__codelineno-65-20"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;è¯·æ±‚å¼€å§‹: </span><span class="si">{</span><span class="n">request</span><span class="o">.</span><span class="n">method</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">request</span><span class="o">.</span><span class="n">url</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-65-21" name="__codelineno-65-21"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;è¯·æ±‚å¤´: </span><span class="si">{</span><span class="nb">dict</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-65-22" name="__codelineno-65-22"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;è¯·æ±‚ä½“: </span><span class="si">{</span><span class="n">request_body</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-65-23" name="__codelineno-65-23"></a>
<a id="__codelineno-65-24" name="__codelineno-65-24"></a>        <span class="c1"># å¤„ç†è¯·æ±‚</span>
<a id="__codelineno-65-25" name="__codelineno-65-25"></a>        <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="n">call_next</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
<a id="__codelineno-65-26" name="__codelineno-65-26"></a>
<a id="__codelineno-65-27" name="__codelineno-65-27"></a>        <span class="c1"># è®°å½•å“åº”ä¿¡æ¯</span>
<a id="__codelineno-65-28" name="__codelineno-65-28"></a>        <span class="n">response_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<a id="__codelineno-65-29" name="__codelineno-65-29"></a>        <span class="n">duration</span> <span class="o">=</span> <span class="n">response_time</span> <span class="o">-</span> <span class="n">request_time</span>
<a id="__codelineno-65-30" name="__codelineno-65-30"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;å“åº”çŠ¶æ€: </span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-65-31" name="__codelineno-65-31"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;å¤„ç†è€—æ—¶: </span><span class="si">{</span><span class="n">duration</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2"> ç§’&quot;</span><span class="p">)</span>
<a id="__codelineno-65-32" name="__codelineno-65-32"></a>
<a id="__codelineno-65-33" name="__codelineno-65-33"></a>        <span class="k">return</span> <span class="n">response</span>
<a id="__codelineno-65-34" name="__codelineno-65-34"></a>
<a id="__codelineno-65-35" name="__codelineno-65-35"></a><span class="c1"># æ·»åŠ ä¸­é—´ä»¶</span>
<a id="__codelineno-65-36" name="__codelineno-65-36"></a><span class="n">app</span><span class="o">.</span><span class="n">add_middleware</span><span class="p">(</span><span class="n">LoggingMiddleware</span><span class="p">)</span>
<a id="__codelineno-65-37" name="__codelineno-65-37"></a>
<a id="__codelineno-65-38" name="__codelineno-65-38"></a><span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
<a id="__codelineno-65-39" name="__codelineno-65-39"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">read_root</span><span class="p">():</span>
<a id="__codelineno-65-40" name="__codelineno-65-40"></a>    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;Hello, FastAPI!&quot;</span><span class="p">}</span>
<a id="__codelineno-65-41" name="__codelineno-65-41"></a>
<a id="__codelineno-65-42" name="__codelineno-65-42"></a><span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/items/&quot;</span><span class="p">)</span>
<a id="__codelineno-65-43" name="__codelineno-65-43"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">create_item</span><span class="p">(</span><span class="n">item</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
<a id="__codelineno-65-44" name="__codelineno-65-44"></a>    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;item&quot;</span><span class="p">:</span> <span class="n">item</span><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<h2 id="rediså¼‚æ­¥æ“ä½œé›†æˆ"><font style="color:#080808;background-color:#ffffff;">rediså¼‚æ­¥æ“ä½œé›†æˆ</font><a class="headerlink" href="#rediså¼‚æ­¥æ“ä½œé›†æˆ" title="Permanent link">&para;</a></h2>
<p><a href="https://github.com/redis-developer/fastapi-redis-tutorial">https://github.com/redis-developer/fastapi-redis-tutorial</a></p>
<h3 id="-å®‰è£…ä¾èµ–">ğŸ“¦ å®‰è£…ä¾èµ–<a class="headerlink" href="#-å®‰è£…ä¾èµ–" title="Permanent link">&para;</a></h3>
<p>é¦–å…ˆï¼Œç¡®ä¿å®‰è£…äº†å¿…è¦çš„ä¾èµ–é¡¹ï¼š</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-66-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-66-1" name="__codelineno-66-1"></a>pip<span class="w"> </span>install<span class="w"> </span>redis<span class="w"> </span>fastapi<span class="w"> </span>uvicorn<span class="w"> </span>pydantic<span class="w"> </span>async-timeout
</code></pre></div></td></tr></table></div>
<h3 id="-mainpy">ğŸ”§ <code>main.py</code>ï¼š<a class="headerlink" href="#-mainpy" title="Permanent link">&para;</a></h3>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Python</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-67-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-67-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-67-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-67-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-67-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-67-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-67-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-67-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-67-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-67-10">10</a></span>
<span class="normal"><a href="#__codelineno-67-11">11</a></span>
<span class="normal"><a href="#__codelineno-67-12">12</a></span>
<span class="normal"><a href="#__codelineno-67-13">13</a></span>
<span class="normal"><a href="#__codelineno-67-14">14</a></span>
<span class="normal"><a href="#__codelineno-67-15">15</a></span>
<span class="normal"><a href="#__codelineno-67-16">16</a></span>
<span class="normal"><a href="#__codelineno-67-17">17</a></span>
<span class="normal"><a href="#__codelineno-67-18">18</a></span>
<span class="normal"><a href="#__codelineno-67-19">19</a></span>
<span class="normal"><a href="#__codelineno-67-20">20</a></span>
<span class="normal"><a href="#__codelineno-67-21">21</a></span>
<span class="normal"><a href="#__codelineno-67-22">22</a></span>
<span class="normal"><a href="#__codelineno-67-23">23</a></span>
<span class="normal"><a href="#__codelineno-67-24">24</a></span>
<span class="normal"><a href="#__codelineno-67-25">25</a></span>
<span class="normal"><a href="#__codelineno-67-26">26</a></span>
<span class="normal"><a href="#__codelineno-67-27">27</a></span>
<span class="normal"><a href="#__codelineno-67-28">28</a></span>
<span class="normal"><a href="#__codelineno-67-29">29</a></span>
<span class="normal"><a href="#__codelineno-67-30">30</a></span>
<span class="normal"><a href="#__codelineno-67-31">31</a></span>
<span class="normal"><a href="#__codelineno-67-32">32</a></span>
<span class="normal"><a href="#__codelineno-67-33">33</a></span>
<span class="normal"><a href="#__codelineno-67-34">34</a></span>
<span class="normal"><a href="#__codelineno-67-35">35</a></span>
<span class="normal"><a href="#__codelineno-67-36">36</a></span>
<span class="normal"><a href="#__codelineno-67-37">37</a></span>
<span class="normal"><a href="#__codelineno-67-38">38</a></span>
<span class="normal"><a href="#__codelineno-67-39">39</a></span>
<span class="normal"><a href="#__codelineno-67-40">40</a></span>
<span class="normal"><a href="#__codelineno-67-41">41</a></span>
<span class="normal"><a href="#__codelineno-67-42">42</a></span>
<span class="normal"><a href="#__codelineno-67-43">43</a></span>
<span class="normal"><a href="#__codelineno-67-44">44</a></span>
<span class="normal"><a href="#__codelineno-67-45">45</a></span>
<span class="normal"><a href="#__codelineno-67-46">46</a></span>
<span class="normal"><a href="#__codelineno-67-47">47</a></span>
<span class="normal"><a href="#__codelineno-67-48">48</a></span>
<span class="normal"><a href="#__codelineno-67-49">49</a></span>
<span class="normal"><a href="#__codelineno-67-50">50</a></span>
<span class="normal"><a href="#__codelineno-67-51">51</a></span>
<span class="normal"><a href="#__codelineno-67-52">52</a></span>
<span class="normal"><a href="#__codelineno-67-53">53</a></span>
<span class="normal"><a href="#__codelineno-67-54">54</a></span>
<span class="normal"><a href="#__codelineno-67-55">55</a></span>
<span class="normal"><a href="#__codelineno-67-56">56</a></span>
<span class="normal"><a href="#__codelineno-67-57">57</a></span>
<span class="normal"><a href="#__codelineno-67-58">58</a></span>
<span class="normal"><a href="#__codelineno-67-59">59</a></span>
<span class="normal"><a href="#__codelineno-67-60">60</a></span>
<span class="normal"><a href="#__codelineno-67-61">61</a></span>
<span class="normal"><a href="#__codelineno-67-62">62</a></span>
<span class="normal"><a href="#__codelineno-67-63">63</a></span>
<span class="normal"><a href="#__codelineno-67-64">64</a></span>
<span class="normal"><a href="#__codelineno-67-65">65</a></span>
<span class="normal"><a href="#__codelineno-67-66">66</a></span>
<span class="normal"><a href="#__codelineno-67-67">67</a></span>
<span class="normal"><a href="#__codelineno-67-68">68</a></span>
<span class="normal"><a href="#__codelineno-67-69">69</a></span>
<span class="normal"><a href="#__codelineno-67-70">70</a></span>
<span class="normal"><a href="#__codelineno-67-71">71</a></span>
<span class="normal"><a href="#__codelineno-67-72">72</a></span>
<span class="normal"><a href="#__codelineno-67-73">73</a></span>
<span class="normal"><a href="#__codelineno-67-74">74</a></span>
<span class="normal"><a href="#__codelineno-67-75">75</a></span>
<span class="normal"><a href="#__codelineno-67-76">76</a></span>
<span class="normal"><a href="#__codelineno-67-77">77</a></span>
<span class="normal"><a href="#__codelineno-67-78">78</a></span>
<span class="normal"><a href="#__codelineno-67-79">79</a></span>
<span class="normal"><a href="#__codelineno-67-80">80</a></span>
<span class="normal"><a href="#__codelineno-67-81">81</a></span>
<span class="normal"><a href="#__codelineno-67-82">82</a></span>
<span class="normal"><a href="#__codelineno-67-83">83</a></span>
<span class="normal"><a href="#__codelineno-67-84">84</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-67-1" name="__codelineno-67-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">fastapi</span><span class="w"> </span><span class="kn">import</span> <span class="n">FastAPI</span><span class="p">,</span> <span class="n">Request</span>
<a id="__codelineno-67-2" name="__codelineno-67-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">contextlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">asynccontextmanager</span>
<a id="__codelineno-67-3" name="__codelineno-67-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">redis.asyncio</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">redis</span>
<a id="__codelineno-67-4" name="__codelineno-67-4"></a><span class="kn">import</span><span class="w"> </span><span class="nn">asyncio</span>
<a id="__codelineno-67-5" name="__codelineno-67-5"></a><span class="kn">import</span><span class="w"> </span><span class="nn">async_timeout</span>
<a id="__codelineno-67-6" name="__codelineno-67-6"></a><span class="kn">from</span><span class="w"> </span><span class="nn">pydantic</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseModel</span>
<a id="__codelineno-67-7" name="__codelineno-67-7"></a>
<a id="__codelineno-67-8" name="__codelineno-67-8"></a><span class="k">class</span><span class="w"> </span><span class="nc">MessageEvent</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
<a id="__codelineno-67-9" name="__codelineno-67-9"></a>    <span class="n">username</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-67-10" name="__codelineno-67-10"></a>    <span class="n">message</span><span class="p">:</span> <span class="nb">dict</span>
<a id="__codelineno-67-11" name="__codelineno-67-11"></a>
<a id="__codelineno-67-12" name="__codelineno-67-12"></a><span class="nd">@asynccontextmanager</span>
<a id="__codelineno-67-13" name="__codelineno-67-13"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">lifespan</span><span class="p">(</span><span class="n">app</span><span class="p">:</span> <span class="n">FastAPI</span><span class="p">):</span>
<a id="__codelineno-67-14" name="__codelineno-67-14"></a>    <span class="c1"># åˆ›å»º Redis å¼‚æ­¥å®¢æˆ·ç«¯ï¼Œè¿æ¥åˆ°æœ¬åœ° Redis å®ä¾‹</span>
<a id="__codelineno-67-15" name="__codelineno-67-15"></a>    <span class="c1"># decode_responses=True è¡¨ç¤ºè¿”å›çš„æ•°æ®ä¼šè‡ªåŠ¨è§£ç ä¸ºå­—ç¬¦ä¸²ï¼Œè€Œä¸æ˜¯å­—èŠ‚</span>
<a id="__codelineno-67-16" name="__codelineno-67-16"></a>    <span class="n">redis_client</span> <span class="o">=</span> <span class="n">redis</span><span class="o">.</span><span class="n">Redis</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="s2">&quot;localhost&quot;</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">6379</span><span class="p">,</span> <span class="n">decode_responses</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-67-17" name="__codelineno-67-17"></a>
<a id="__codelineno-67-18" name="__codelineno-67-18"></a>    <span class="c1"># åˆ›å»º PubSub å¯¹è±¡ï¼Œç”¨äºå‘å¸ƒè®¢é˜…åŠŸèƒ½</span>
<a id="__codelineno-67-19" name="__codelineno-67-19"></a>    <span class="n">pubsub</span> <span class="o">=</span> <span class="n">redis_client</span><span class="o">.</span><span class="n">pubsub</span><span class="p">()</span>
<a id="__codelineno-67-20" name="__codelineno-67-20"></a>
<a id="__codelineno-67-21" name="__codelineno-67-21"></a>    <span class="c1"># è®¢é˜… Redis ä¸­çš„ä¸¤ä¸ªé¢‘é“ï¼š&quot;channel:1&quot; å’Œ &quot;channel:2&quot;</span>
<a id="__codelineno-67-22" name="__codelineno-67-22"></a>    <span class="k">await</span> <span class="n">pubsub</span><span class="o">.</span><span class="n">subscribe</span><span class="p">(</span><span class="s2">&quot;channel:1&quot;</span><span class="p">,</span> <span class="s2">&quot;channel:2&quot;</span><span class="p">)</span>
<a id="__codelineno-67-23" name="__codelineno-67-23"></a>
<a id="__codelineno-67-24" name="__codelineno-67-24"></a>    <span class="c1"># å°† Redis å®¢æˆ·ç«¯å’Œ pubsub å¯¹è±¡æŒ‚è½½åˆ° FastAPI çš„åº”ç”¨çŠ¶æ€ä¸­</span>
<a id="__codelineno-67-25" name="__codelineno-67-25"></a>    <span class="c1"># è¿™æ ·å¯ä»¥åœ¨å…¶ä»–åœ°æ–¹é€šè¿‡ request.app.state.redis è·å–</span>
<a id="__codelineno-67-26" name="__codelineno-67-26"></a>    <span class="n">app</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">redis</span> <span class="o">=</span> <span class="n">redis_client</span>
<a id="__codelineno-67-27" name="__codelineno-67-27"></a>    <span class="n">app</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">pubsub</span> <span class="o">=</span> <span class="n">pubsub</span>
<a id="__codelineno-67-28" name="__codelineno-67-28"></a>
<a id="__codelineno-67-29" name="__codelineno-67-29"></a>    <span class="c1"># å¯åŠ¨è®¢é˜…ä»»åŠ¡      </span>
<a id="__codelineno-67-30" name="__codelineno-67-30"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">reader</span><span class="p">(</span><span class="n">channel</span><span class="p">):</span>
<a id="__codelineno-67-31" name="__codelineno-67-31"></a>        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
<a id="__codelineno-67-32" name="__codelineno-67-32"></a>            <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-67-33" name="__codelineno-67-33"></a>                <span class="k">async</span> <span class="k">with</span> <span class="n">async_timeout</span><span class="o">.</span><span class="n">timeout</span><span class="p">(</span><span class="mi">1</span><span class="p">):</span>
<a id="__codelineno-67-34" name="__codelineno-67-34"></a>                    <span class="n">msg</span> <span class="o">=</span> <span class="k">await</span> <span class="n">channel</span><span class="o">.</span><span class="n">get_message</span><span class="p">(</span><span class="n">ignore_subscribe_messages</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-67-35" name="__codelineno-67-35"></a>                    <span class="k">if</span> <span class="n">msg</span><span class="p">:</span>
<a id="__codelineno-67-36" name="__codelineno-67-36"></a>                        <span class="n">event</span> <span class="o">=</span> <span class="n">MessageEvent</span><span class="o">.</span><span class="n">parse_raw</span><span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">])</span>
<a id="__codelineno-67-37" name="__codelineno-67-37"></a>                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;æ”¶åˆ°æ¶ˆæ¯ï¼š&quot;</span><span class="p">,</span> <span class="n">event</span><span class="p">)</span>
<a id="__codelineno-67-38" name="__codelineno-67-38"></a>                    <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)</span>
<a id="__codelineno-67-39" name="__codelineno-67-39"></a>            <span class="k">except</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">TimeoutError</span><span class="p">:</span>
<a id="__codelineno-67-40" name="__codelineno-67-40"></a>                <span class="k">pass</span>
<a id="__codelineno-67-41" name="__codelineno-67-41"></a>
<a id="__codelineno-67-42" name="__codelineno-67-42"></a>    <span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="n">reader</span><span class="p">(</span><span class="n">pubsub</span><span class="p">))</span>
<a id="__codelineno-67-43" name="__codelineno-67-43"></a>
<a id="__codelineno-67-44" name="__codelineno-67-44"></a>    <span class="c1"># å‘å¸ƒä¸€æ¡æµ‹è¯•æ¶ˆæ¯ </span>
<a id="__codelineno-67-45" name="__codelineno-67-45"></a>    <span class="k">await</span> <span class="n">redis_client</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span><span class="s2">&quot;channel:1&quot;</span><span class="p">,</span> <span class="n">MessageEvent</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="s2">&quot;start&quot;</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;info&quot;</span><span class="p">:</span> <span class="s2">&quot;åº”ç”¨å¯åŠ¨&quot;</span><span class="p">})</span><span class="o">.</span><span class="n">json</span><span class="p">())</span>
<a id="__codelineno-67-46" name="__codelineno-67-46"></a>
<a id="__codelineno-67-47" name="__codelineno-67-47"></a>    <span class="k">yield</span>  <span class="c1"># åº”ç”¨è¿è¡ŒæœŸé—´</span>
<a id="__codelineno-67-48" name="__codelineno-67-48"></a>    <span class="c1"># ========== åº”ç”¨å…³é—­æ—¶æ¸…ç†èµ„æº ==========</span>
<a id="__codelineno-67-49" name="__codelineno-67-49"></a>
<a id="__codelineno-67-50" name="__codelineno-67-50"></a>    <span class="c1"># å–æ¶ˆè®¢é˜…é¢‘é“ï¼Œé¿å…èµ„æºæ³„æ¼</span>
<a id="__codelineno-67-51" name="__codelineno-67-51"></a>    <span class="k">await</span> <span class="n">pubsub</span><span class="o">.</span><span class="n">unsubscribe</span><span class="p">(</span><span class="s2">&quot;channel:1&quot;</span><span class="p">,</span> <span class="s2">&quot;channel:2&quot;</span><span class="p">)</span>
<a id="__codelineno-67-52" name="__codelineno-67-52"></a>
<a id="__codelineno-67-53" name="__codelineno-67-53"></a>    <span class="c1"># å…³é—­ pubsub å¯¹è±¡ï¼ˆåœæ­¢ç›‘å¬ï¼‰</span>
<a id="__codelineno-67-54" name="__codelineno-67-54"></a>    <span class="k">await</span> <span class="n">pubsub</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<a id="__codelineno-67-55" name="__codelineno-67-55"></a>
<a id="__codelineno-67-56" name="__codelineno-67-56"></a>    <span class="c1"># å…³é—­ Redis å®¢æˆ·ç«¯è¿æ¥</span>
<a id="__codelineno-67-57" name="__codelineno-67-57"></a>    <span class="k">await</span> <span class="n">redis_client</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<a id="__codelineno-67-58" name="__codelineno-67-58"></a>
<a id="__codelineno-67-59" name="__codelineno-67-59"></a><span class="n">app</span> <span class="o">=</span> <span class="n">FastAPI</span><span class="p">(</span><span class="n">lifespan</span><span class="o">=</span><span class="n">lifespan</span><span class="p">)</span>
<a id="__codelineno-67-60" name="__codelineno-67-60"></a>
<a id="__codelineno-67-61" name="__codelineno-67-61"></a><span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/index&quot;</span><span class="p">)</span>
<a id="__codelineno-67-62" name="__codelineno-67-62"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">index</span><span class="p">(</span><span class="n">req</span><span class="p">:</span> <span class="n">Request</span><span class="p">):</span>
<a id="__codelineno-67-63" name="__codelineno-67-63"></a>    <span class="n">event</span> <span class="o">=</span> <span class="n">MessageEvent</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="s2">&quot;api&quot;</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;info&quot;</span><span class="p">:</span> <span class="s2">&quot;æ¥è‡ªæ¥å£çš„æ¶ˆæ¯&quot;</span><span class="p">})</span>
<a id="__codelineno-67-64" name="__codelineno-67-64"></a>    <span class="k">await</span> <span class="n">req</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">redis</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span><span class="s2">&quot;channel:1&quot;</span><span class="p">,</span> <span class="n">event</span><span class="o">.</span><span class="n">json</span><span class="p">())</span>
<a id="__codelineno-67-65" name="__codelineno-67-65"></a>    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;msg&quot;</span><span class="p">:</span> <span class="s2">&quot;æ¶ˆæ¯å·²å‘å¸ƒ&quot;</span><span class="p">}</span>
<a id="__codelineno-67-66" name="__codelineno-67-66"></a>
<a id="__codelineno-67-67" name="__codelineno-67-67"></a>
<a id="__codelineno-67-68" name="__codelineno-67-68"></a><span class="kn">from</span><span class="w"> </span><span class="nn">redis.asyncio.lock</span><span class="w"> </span><span class="kn">import</span> <span class="n">Lock</span>
<a id="__codelineno-67-69" name="__codelineno-67-69"></a>
<a id="__codelineno-67-70" name="__codelineno-67-70"></a><span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/lock-test&quot;</span><span class="p">)</span>
<a id="__codelineno-67-71" name="__codelineno-67-71"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">lock_test</span><span class="p">(</span><span class="n">req</span><span class="p">:</span> <span class="n">Request</span><span class="p">):</span>
<a id="__codelineno-67-72" name="__codelineno-67-72"></a>    <span class="n">redis_client</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">redis</span>
<a id="__codelineno-67-73" name="__codelineno-67-73"></a>    <span class="n">lock</span><span class="p">:</span> <span class="n">Lock</span> <span class="o">=</span> <span class="n">redis_client</span><span class="o">.</span><span class="n">lock</span><span class="p">(</span><span class="s2">&quot;test:lock&quot;</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>  <span class="c1"># è¶…æ—¶10ç§’</span>
<a id="__codelineno-67-74" name="__codelineno-67-74"></a>
<a id="__codelineno-67-75" name="__codelineno-67-75"></a>    <span class="c1"># éé˜»å¡å°è¯•è·å–é”</span>
<a id="__codelineno-67-76" name="__codelineno-67-76"></a>    <span class="k">if</span> <span class="k">await</span> <span class="n">lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">(</span><span class="n">blocking</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<a id="__codelineno-67-77" name="__codelineno-67-77"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-67-78" name="__codelineno-67-78"></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;æˆåŠŸè·å–é”ï¼Œæ­£åœ¨æ‰§è¡Œä¸šåŠ¡é€»è¾‘...&quot;</span><span class="p">)</span>
<a id="__codelineno-67-79" name="__codelineno-67-79"></a>            <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>  <span class="c1"># æ¨¡æ‹Ÿè€—æ—¶ä»»åŠ¡</span>
<a id="__codelineno-67-80" name="__codelineno-67-80"></a>            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;msg&quot;</span><span class="p">:</span> <span class="s2">&quot;ä»»åŠ¡æ‰§è¡Œå®Œæˆï¼Œé”é‡Šæ”¾&quot;</span><span class="p">}</span>
<a id="__codelineno-67-81" name="__codelineno-67-81"></a>        <span class="k">finally</span><span class="p">:</span>
<a id="__codelineno-67-82" name="__codelineno-67-82"></a>            <span class="k">await</span> <span class="n">lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
<a id="__codelineno-67-83" name="__codelineno-67-83"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-67-84" name="__codelineno-67-84"></a>        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;msg&quot;</span><span class="p">:</span> <span class="s2">&quot;èµ„æºç¹å¿™ï¼Œè¯·ç¨åé‡è¯•&quot;</span><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<h2 id="é›†æˆcelery">é›†æˆcelery<a class="headerlink" href="#é›†æˆcelery" title="Permanent link">&para;</a></h2>
<h3 id="é…ç½®tasks">ğŸ’ é…ç½®tasks<a class="headerlink" href="#é…ç½®tasks" title="Permanent link">&para;</a></h3>
<hr />
<h4 id="-å®‰è£…ä¾èµ–_1">ğŸ§° å®‰è£…ä¾èµ–<a class="headerlink" href="#-å®‰è£…ä¾èµ–_1" title="Permanent link">&para;</a></h4>
<p>é¦–å…ˆå®‰è£…å¿…è¦ä¾èµ–ï¼š</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-68-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-68-1" name="__codelineno-68-1"></a>pip<span class="w"> </span>install<span class="w"> </span>fastapi<span class="w"> </span>celery<span class="w"> </span>redis<span class="w"> </span>uvicorn
</code></pre></div></td></tr></table></div>
<hr />
<h4 id="-é¡¹ç›®ç»“æ„">ğŸ“¦ é¡¹ç›®ç»“æ„<a class="headerlink" href="#-é¡¹ç›®ç»“æ„" title="Permanent link">&para;</a></h4>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Text Only</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-69-1">1</a></span>
<span class="normal"><a href="#__codelineno-69-2">2</a></span>
<span class="normal"><a href="#__codelineno-69-3">3</a></span>
<span class="normal"><a href="#__codelineno-69-4">4</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-69-1" name="__codelineno-69-1"></a>project/
<a id="__codelineno-69-2" name="__codelineno-69-2"></a>â”œâ”€â”€ main.py          # FastAPI åº”ç”¨
<a id="__codelineno-69-3" name="__codelineno-69-3"></a>â”œâ”€â”€ celery_worker.py # Celery worker å¯åŠ¨å…¥å£
<a id="__codelineno-69-4" name="__codelineno-69-4"></a>â””â”€â”€ tasks.py         # å¼‚æ­¥ä»»åŠ¡å®šä¹‰
</code></pre></div></td></tr></table></div>
<hr />
<h4 id="-taskspyå®šä¹‰å¼‚æ­¥ä»»åŠ¡">ğŸ”§ tasks.pyï¼šå®šä¹‰å¼‚æ­¥ä»»åŠ¡<a class="headerlink" href="#-taskspyå®šä¹‰å¼‚æ­¥ä»»åŠ¡" title="Permanent link">&para;</a></h4>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Python</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-70-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-70-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-70-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-70-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-70-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-70-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-70-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-70-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-70-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-70-10">10</a></span>
<span class="normal"><a href="#__codelineno-70-11">11</a></span>
<span class="normal"><a href="#__codelineno-70-12">12</a></span>
<span class="normal"><a href="#__codelineno-70-13">13</a></span>
<span class="normal"><a href="#__codelineno-70-14">14</a></span>
<span class="normal"><a href="#__codelineno-70-15">15</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-70-1" name="__codelineno-70-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">celery</span><span class="w"> </span><span class="kn">import</span> <span class="n">Celery</span>
<a id="__codelineno-70-2" name="__codelineno-70-2"></a>
<a id="__codelineno-70-3" name="__codelineno-70-3"></a><span class="c1"># åˆ›å»º Celery å®ä¾‹ï¼ŒæŒ‡å®š Broker ä½¿ç”¨ Redis</span>
<a id="__codelineno-70-4" name="__codelineno-70-4"></a><span class="n">celery_app</span> <span class="o">=</span> <span class="n">Celery</span><span class="p">(</span><span class="s2">&quot;worker&quot;</span><span class="p">,</span> <span class="n">broker</span><span class="o">=</span><span class="s2">&quot;redis://localhost:6379/0&quot;</span><span class="p">)</span>
<a id="__codelineno-70-5" name="__codelineno-70-5"></a>
<a id="__codelineno-70-6" name="__codelineno-70-6"></a><span class="c1"># å®šä¹‰ä¸€ä¸ªç®€å•çš„å¼‚æ­¥ä»»åŠ¡</span>
<a id="__codelineno-70-7" name="__codelineno-70-7"></a><span class="nd">@celery_app</span><span class="o">.</span><span class="n">task</span>
<a id="__codelineno-70-8" name="__codelineno-70-8"></a><span class="k">def</span><span class="w"> </span><span class="nf">add</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
<a id="__codelineno-70-9" name="__codelineno-70-9"></a>    <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span>
<a id="__codelineno-70-10" name="__codelineno-70-10"></a>
<a id="__codelineno-70-11" name="__codelineno-70-11"></a><span class="nd">@celery_app</span><span class="o">.</span><span class="n">task</span>
<a id="__codelineno-70-12" name="__codelineno-70-12"></a><span class="k">def</span><span class="w"> </span><span class="nf">slow_task</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
<a id="__codelineno-70-13" name="__codelineno-70-13"></a>    <span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<a id="__codelineno-70-14" name="__codelineno-70-14"></a>    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
<a id="__codelineno-70-15" name="__codelineno-70-15"></a>    <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;ä»»åŠ¡è€—æ—¶ </span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s2"> ç§’æ‰§è¡Œå®Œæ¯•&quot;</span>
</code></pre></div></td></tr></table></div>
<h4 id="-mainpyfastapi-æ¥å£è§¦å‘ä»»åŠ¡">ğŸš€ main.pyï¼šFastAPI æ¥å£è§¦å‘ä»»åŠ¡<a class="headerlink" href="#-mainpyfastapi-æ¥å£è§¦å‘ä»»åŠ¡" title="Permanent link">&para;</a></h4>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Python</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-71-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-71-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-71-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-71-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-71-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-71-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-71-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-71-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-71-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-71-10">10</a></span>
<span class="normal"><a href="#__codelineno-71-11">11</a></span>
<span class="normal"><a href="#__codelineno-71-12">12</a></span>
<span class="normal"><a href="#__codelineno-71-13">13</a></span>
<span class="normal"><a href="#__codelineno-71-14">14</a></span>
<span class="normal"><a href="#__codelineno-71-15">15</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-71-1" name="__codelineno-71-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">fastapi</span><span class="w"> </span><span class="kn">import</span> <span class="n">FastAPI</span>
<a id="__codelineno-71-2" name="__codelineno-71-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">tasks</span><span class="w"> </span><span class="kn">import</span> <span class="n">add</span><span class="p">,</span> <span class="n">slow_task</span>
<a id="__codelineno-71-3" name="__codelineno-71-3"></a>
<a id="__codelineno-71-4" name="__codelineno-71-4"></a><span class="n">app</span> <span class="o">=</span> <span class="n">FastAPI</span><span class="p">()</span>
<a id="__codelineno-71-5" name="__codelineno-71-5"></a>
<a id="__codelineno-71-6" name="__codelineno-71-6"></a><span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/add&quot;</span><span class="p">)</span>
<a id="__codelineno-71-7" name="__codelineno-71-7"></a><span class="k">def</span><span class="w"> </span><span class="nf">trigger_add</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
<a id="__codelineno-71-8" name="__codelineno-71-8"></a>    <span class="c1"># å‘é€å¼‚æ­¥ä»»åŠ¡ç»™ celery worker</span>
<a id="__codelineno-71-9" name="__codelineno-71-9"></a>    <span class="n">result</span> <span class="o">=</span> <span class="n">add</span><span class="o">.</span><span class="n">delay</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
<a id="__codelineno-71-10" name="__codelineno-71-10"></a>    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;task_id&quot;</span><span class="p">:</span> <span class="n">result</span><span class="o">.</span><span class="n">id</span><span class="p">}</span>
<a id="__codelineno-71-11" name="__codelineno-71-11"></a>
<a id="__codelineno-71-12" name="__codelineno-71-12"></a><span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/slow&quot;</span><span class="p">)</span>
<a id="__codelineno-71-13" name="__codelineno-71-13"></a><span class="k">def</span><span class="w"> </span><span class="nf">trigger_slow</span><span class="p">(</span><span class="n">n</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
<a id="__codelineno-71-14" name="__codelineno-71-14"></a>    <span class="n">result</span> <span class="o">=</span> <span class="n">slow_task</span><span class="o">.</span><span class="n">delay</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
<a id="__codelineno-71-15" name="__codelineno-71-15"></a>    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;task_id&quot;</span><span class="p">:</span> <span class="n">result</span><span class="o">.</span><span class="n">id</span><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<hr />
<h4 id="-celery_workerpyå¯åŠ¨-worker-ä½¿ç”¨çš„è„šæœ¬">ğŸ›  celery_worker.pyï¼šå¯åŠ¨ worker ä½¿ç”¨çš„è„šæœ¬<a class="headerlink" href="#-celery_workerpyå¯åŠ¨-worker-ä½¿ç”¨çš„è„šæœ¬" title="Permanent link">&para;</a></h4>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Python</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-72-1">1</a></span>
<span class="normal"><a href="#__codelineno-72-2">2</a></span>
<span class="normal"><a href="#__codelineno-72-3">3</a></span>
<span class="normal"><a href="#__codelineno-72-4">4</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-72-1" name="__codelineno-72-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">tasks</span><span class="w"> </span><span class="kn">import</span> <span class="n">celery_app</span>
<a id="__codelineno-72-2" name="__codelineno-72-2"></a>
<a id="__codelineno-72-3" name="__codelineno-72-3"></a><span class="c1"># ä½¿ç”¨ celery -A celery_worker worker å¯åŠ¨å³å¯</span>
<a id="__codelineno-72-4" name="__codelineno-72-4"></a><span class="c1"># è¿™ä¸ªæ–‡ä»¶åªä¸ºäº†æš´éœ² celery_app å®ä¾‹</span>
</code></pre></div></td></tr></table></div>
<hr />
<h4 id="-å¯åŠ¨æœåŠ¡">â–¶ å¯åŠ¨æœåŠ¡<a class="headerlink" href="#-å¯åŠ¨æœåŠ¡" title="Permanent link">&para;</a></h4>
<h5 id="1-å¯åŠ¨-redis"><strong>1ï¸âƒ£</strong><strong> å¯åŠ¨ Redis</strong><a class="headerlink" href="#1-å¯åŠ¨-redis" title="Permanent link">&para;</a></h5>
<p>ç¡®ä¿ Redis å·²ç»è¿è¡Œåœ¨ <code>localhost:6379</code></p>
<h5 id="2-å¯åŠ¨-celery-worker"><strong>2ï¸âƒ£</strong><strong> å¯åŠ¨ Celery worker</strong><a class="headerlink" href="#2-å¯åŠ¨-celery-worker" title="Permanent link">&para;</a></h5>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-73-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-73-1" name="__codelineno-73-1"></a>celery<span class="w"> </span>-A<span class="w"> </span>celery_worker<span class="w"> </span>worker<span class="w"> </span>--loglevel<span class="o">=</span>info
</code></pre></div></td></tr></table></div>
<h5 id="3-å¯åŠ¨-fastapi-åº”ç”¨"><strong>3ï¸âƒ£</strong><strong> å¯åŠ¨ FastAPI åº”ç”¨</strong><a class="headerlink" href="#3-å¯åŠ¨-fastapi-åº”ç”¨" title="Permanent link">&para;</a></h5>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-74-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-74-1" name="__codelineno-74-1"></a>uvicorn<span class="w"> </span>main:app<span class="w"> </span>--reload
</code></pre></div></td></tr></table></div>
<hr />
<p>å¥½çš„ï¼Œæˆ‘ä»¬ç»§ç»­ä¸º FastAPI + Celery é›†æˆæ·»åŠ ä»¥ä¸‹é«˜çº§åŠŸèƒ½ï¼š</p>
<hr />
<h3 id="-é›†æˆ-flower-å¯è§†åŒ–ç›‘æ§">ğŸŒ¸ é›†æˆ Flower å¯è§†åŒ–ç›‘æ§<a class="headerlink" href="#-é›†æˆ-flower-å¯è§†åŒ–ç›‘æ§" title="Permanent link">&para;</a></h3>
<h4 id="-å®‰è£…-flower">ğŸ”§ å®‰è£… Flower<a class="headerlink" href="#-å®‰è£…-flower" title="Permanent link">&para;</a></h4>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-75-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-75-1" name="__codelineno-75-1"></a>pip<span class="w"> </span>install<span class="w"> </span>flower
</code></pre></div></td></tr></table></div>
<h4 id="-å¯åŠ¨-flower-ç›‘æ§">ğŸš€ å¯åŠ¨ Flower ç›‘æ§<a class="headerlink" href="#-å¯åŠ¨-flower-ç›‘æ§" title="Permanent link">&para;</a></h4>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-76-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-76-1" name="__codelineno-76-1"></a>celery<span class="w"> </span>-A<span class="w"> </span>celery_worker<span class="w"> </span>flower<span class="w"> </span>--port<span class="o">=</span><span class="m">5555</span>
</code></pre></div></td></tr></table></div>
<h4 id="-è®¿é—®ç›‘æ§é¡µé¢">ğŸ“Œ è®¿é—®ç›‘æ§é¡µé¢<a class="headerlink" href="#-è®¿é—®ç›‘æ§é¡µé¢" title="Permanent link">&para;</a></h4>
<p>æµè§ˆå™¨è®¿é—® <a href="http://localhost:5555/">http://localhost:5555</a>ï¼Œå¯ä»¥å®æ—¶æŸ¥çœ‹ï¼š</p>
<ul>
<li>ä»»åŠ¡åˆ—è¡¨</li>
<li>çŠ¶æ€ç»Ÿè®¡</li>
<li>æ‰§è¡Œæ—¥å¿—</li>
<li>æ¯ä¸ª worker çš„èµ„æºä¿¡æ¯ç­‰</li>
</ul>
<hr />
<h3 id="-é…ç½®ä»»åŠ¡ç»“æœå­˜å‚¨result_backend">âœ… é…ç½®ä»»åŠ¡ç»“æœå­˜å‚¨ï¼ˆ<code>result_backend</code>ï¼‰<a class="headerlink" href="#-é…ç½®ä»»åŠ¡ç»“æœå­˜å‚¨result_backend" title="Permanent link">&para;</a></h3>
<p>ç¼–è¾‘ <code>tasks.py</code>ï¼Œæ·»åŠ  Redis ä½œä¸ºä»»åŠ¡ç»“æœåç«¯ï¼š</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Python</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-77-1">1</a></span>
<span class="normal"><a href="#__codelineno-77-2">2</a></span>
<span class="normal"><a href="#__codelineno-77-3">3</a></span>
<span class="normal"><a href="#__codelineno-77-4">4</a></span>
<span class="normal"><a href="#__codelineno-77-5">5</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-77-1" name="__codelineno-77-1"></a><span class="n">celery_app</span> <span class="o">=</span> <span class="n">Celery</span><span class="p">(</span>
<a id="__codelineno-77-2" name="__codelineno-77-2"></a>    <span class="s2">&quot;worker&quot;</span><span class="p">,</span>
<a id="__codelineno-77-3" name="__codelineno-77-3"></a>    <span class="n">broker</span><span class="o">=</span><span class="s2">&quot;redis://localhost:6379/0&quot;</span><span class="p">,</span>
<a id="__codelineno-77-4" name="__codelineno-77-4"></a>    <span class="n">backend</span><span class="o">=</span><span class="s2">&quot;redis://localhost:6379/1&quot;</span><span class="p">,</span>  <span class="c1"># ä½¿ç”¨å¦ä¸€ä¸ª Redis DB å­˜ç»“æœ</span>
<a id="__codelineno-77-5" name="__codelineno-77-5"></a><span class="p">)</span>
</code></pre></div></td></tr></table></div>
<h4 id="-åœ¨-fastapi-ä¸­è·å–ä»»åŠ¡ç»“æœå¯é€‰">ğŸ¯ åœ¨ FastAPI ä¸­è·å–ä»»åŠ¡ç»“æœï¼ˆå¯é€‰ï¼‰<a class="headerlink" href="#-åœ¨-fastapi-ä¸­è·å–ä»»åŠ¡ç»“æœå¯é€‰" title="Permanent link">&para;</a></h4>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Python</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-78-1">1</a></span>
<span class="normal"><a href="#__codelineno-78-2">2</a></span>
<span class="normal"><a href="#__codelineno-78-3">3</a></span>
<span class="normal"><a href="#__codelineno-78-4">4</a></span>
<span class="normal"><a href="#__codelineno-78-5">5</a></span>
<span class="normal"><a href="#__codelineno-78-6">6</a></span>
<span class="normal"><a href="#__codelineno-78-7">7</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-78-1" name="__codelineno-78-1"></a><span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/result/</span><span class="si">{task_id}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-78-2" name="__codelineno-78-2"></a><span class="k">def</span><span class="w"> </span><span class="nf">get_result</span><span class="p">(</span><span class="n">task_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<a id="__codelineno-78-3" name="__codelineno-78-3"></a>    <span class="n">result</span> <span class="o">=</span> <span class="n">add</span><span class="o">.</span><span class="n">AsyncResult</span><span class="p">(</span><span class="n">task_id</span><span class="p">)</span>
<a id="__codelineno-78-4" name="__codelineno-78-4"></a>    <span class="k">return</span> <span class="p">{</span>
<a id="__codelineno-78-5" name="__codelineno-78-5"></a>        <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="n">result</span><span class="o">.</span><span class="n">status</span><span class="p">,</span>
<a id="__codelineno-78-6" name="__codelineno-78-6"></a>        <span class="s2">&quot;result&quot;</span><span class="p">:</span> <span class="n">result</span><span class="o">.</span><span class="n">result</span> <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">ready</span><span class="p">()</span> <span class="k">else</span> <span class="kc">None</span>
<a id="__codelineno-78-7" name="__codelineno-78-7"></a>    <span class="p">}</span>
</code></pre></div></td></tr></table></div>
<hr />
<h3 id="-docker-åŒ–éƒ¨ç½²ç¤ºä¾‹">ğŸ³ Docker åŒ–éƒ¨ç½²ï¼ˆç¤ºä¾‹ï¼‰<a class="headerlink" href="#-docker-åŒ–éƒ¨ç½²ç¤ºä¾‹" title="Permanent link">&para;</a></h3>
<h4 id="-åˆ›å»º-dockerfile">ğŸ“ åˆ›å»º Dockerfile<a class="headerlink" href="#-åˆ›å»º-dockerfile" title="Permanent link">&para;</a></h4>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Docker</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-79-1">1</a></span>
<span class="normal"><a href="#__codelineno-79-2">2</a></span>
<span class="normal"><a href="#__codelineno-79-3">3</a></span>
<span class="normal"><a href="#__codelineno-79-4">4</a></span>
<span class="normal"><a href="#__codelineno-79-5">5</a></span>
<span class="normal"><a href="#__codelineno-79-6">6</a></span>
<span class="normal"><a href="#__codelineno-79-7">7</a></span>
<span class="normal"><a href="#__codelineno-79-8">8</a></span>
<span class="normal"><a href="#__codelineno-79-9">9</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-79-1" name="__codelineno-79-1"></a><span class="k">FROM</span><span class="w"> </span><span class="s">python:3.11-slim</span>
<a id="__codelineno-79-2" name="__codelineno-79-2"></a>
<a id="__codelineno-79-3" name="__codelineno-79-3"></a><span class="k">WORKDIR</span><span class="w"> </span><span class="s">/app</span>
<a id="__codelineno-79-4" name="__codelineno-79-4"></a>
<a id="__codelineno-79-5" name="__codelineno-79-5"></a><span class="k">COPY</span><span class="w"> </span>.<span class="w"> </span>.
<a id="__codelineno-79-6" name="__codelineno-79-6"></a>
<a id="__codelineno-79-7" name="__codelineno-79-7"></a><span class="k">RUN</span><span class="w"> </span>pip<span class="w"> </span>install<span class="w"> </span>--no-cache-dir<span class="w"> </span>fastapi<span class="w"> </span>celery<span class="w"> </span>redis<span class="w"> </span>uvicorn<span class="w"> </span>flower
<a id="__codelineno-79-8" name="__codelineno-79-8"></a>
<a id="__codelineno-79-9" name="__codelineno-79-9"></a><span class="k">CMD</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;uvicorn&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;main:app&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;--host&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;0.0.0.0&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;--port&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;8000&quot;</span><span class="p">]</span>
</code></pre></div></td></tr></table></div>
<h4 id="-docker-composeyml-ç¤ºä¾‹">ğŸ“ docker-compose.yml ç¤ºä¾‹<a class="headerlink" href="#-docker-composeyml-ç¤ºä¾‹" title="Permanent link">&para;</a></h4>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">YAML</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-80-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-80-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-80-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-80-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-80-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-80-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-80-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-80-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-80-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-80-10">10</a></span>
<span class="normal"><a href="#__codelineno-80-11">11</a></span>
<span class="normal"><a href="#__codelineno-80-12">12</a></span>
<span class="normal"><a href="#__codelineno-80-13">13</a></span>
<span class="normal"><a href="#__codelineno-80-14">14</a></span>
<span class="normal"><a href="#__codelineno-80-15">15</a></span>
<span class="normal"><a href="#__codelineno-80-16">16</a></span>
<span class="normal"><a href="#__codelineno-80-17">17</a></span>
<span class="normal"><a href="#__codelineno-80-18">18</a></span>
<span class="normal"><a href="#__codelineno-80-19">19</a></span>
<span class="normal"><a href="#__codelineno-80-20">20</a></span>
<span class="normal"><a href="#__codelineno-80-21">21</a></span>
<span class="normal"><a href="#__codelineno-80-22">22</a></span>
<span class="normal"><a href="#__codelineno-80-23">23</a></span>
<span class="normal"><a href="#__codelineno-80-24">24</a></span>
<span class="normal"><a href="#__codelineno-80-25">25</a></span>
<span class="normal"><a href="#__codelineno-80-26">26</a></span>
<span class="normal"><a href="#__codelineno-80-27">27</a></span>
<span class="normal"><a href="#__codelineno-80-28">28</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-80-1" name="__codelineno-80-1"></a><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;3.9&#39;</span>
<a id="__codelineno-80-2" name="__codelineno-80-2"></a>
<a id="__codelineno-80-3" name="__codelineno-80-3"></a><span class="nt">services</span><span class="p">:</span>
<a id="__codelineno-80-4" name="__codelineno-80-4"></a><span class="w">  </span><span class="nt">redis</span><span class="p">:</span>
<a id="__codelineno-80-5" name="__codelineno-80-5"></a><span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">redis:6.2</span>
<a id="__codelineno-80-6" name="__codelineno-80-6"></a><span class="w">    </span><span class="nt">ports</span><span class="p">:</span>
<a id="__codelineno-80-7" name="__codelineno-80-7"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;6379:6379&quot;</span>
<a id="__codelineno-80-8" name="__codelineno-80-8"></a>
<a id="__codelineno-80-9" name="__codelineno-80-9"></a><span class="w">  </span><span class="nt">backend</span><span class="p">:</span>
<a id="__codelineno-80-10" name="__codelineno-80-10"></a><span class="w">    </span><span class="nt">build</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">.</span>
<a id="__codelineno-80-11" name="__codelineno-80-11"></a><span class="w">    </span><span class="nt">ports</span><span class="p">:</span>
<a id="__codelineno-80-12" name="__codelineno-80-12"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;8000:8000&quot;</span>
<a id="__codelineno-80-13" name="__codelineno-80-13"></a><span class="w">    </span><span class="nt">depends_on</span><span class="p">:</span>
<a id="__codelineno-80-14" name="__codelineno-80-14"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">redis</span>
<a id="__codelineno-80-15" name="__codelineno-80-15"></a>
<a id="__codelineno-80-16" name="__codelineno-80-16"></a><span class="w">  </span><span class="nt">celery_worker</span><span class="p">:</span>
<a id="__codelineno-80-17" name="__codelineno-80-17"></a><span class="w">    </span><span class="nt">build</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">.</span>
<a id="__codelineno-80-18" name="__codelineno-80-18"></a><span class="w">    </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">celery -A celery_worker worker --loglevel=info</span>
<a id="__codelineno-80-19" name="__codelineno-80-19"></a><span class="w">    </span><span class="nt">depends_on</span><span class="p">:</span>
<a id="__codelineno-80-20" name="__codelineno-80-20"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">redis</span>
<a id="__codelineno-80-21" name="__codelineno-80-21"></a>
<a id="__codelineno-80-22" name="__codelineno-80-22"></a><span class="w">  </span><span class="nt">flower</span><span class="p">:</span>
<a id="__codelineno-80-23" name="__codelineno-80-23"></a><span class="w">    </span><span class="nt">build</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">.</span>
<a id="__codelineno-80-24" name="__codelineno-80-24"></a><span class="w">    </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">celery -A celery_worker flower --port=5555</span>
<a id="__codelineno-80-25" name="__codelineno-80-25"></a><span class="w">    </span><span class="nt">ports</span><span class="p">:</span>
<a id="__codelineno-80-26" name="__codelineno-80-26"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;5555:5555&quot;</span>
<a id="__codelineno-80-27" name="__codelineno-80-27"></a><span class="w">    </span><span class="nt">depends_on</span><span class="p">:</span>
<a id="__codelineno-80-28" name="__codelineno-80-28"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">redis</span>
</code></pre></div></td></tr></table></div>
<hr />
<h3 id="-ä»»åŠ¡é‡è¯•æœºåˆ¶ä¸è¶…æ—¶è®¾ç½®">ğŸ” ä»»åŠ¡é‡è¯•æœºåˆ¶ä¸è¶…æ—¶è®¾ç½®<a class="headerlink" href="#-ä»»åŠ¡é‡è¯•æœºåˆ¶ä¸è¶…æ—¶è®¾ç½®" title="Permanent link">&para;</a></h3>
<p>åœ¨ <code>tasks.py</code> ä¸­é…ç½®ä»»åŠ¡å‚æ•°ï¼š</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Python</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-81-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-81-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-81-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-81-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-81-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-81-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-81-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-81-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-81-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-81-10">10</a></span>
<span class="normal"><a href="#__codelineno-81-11">11</a></span>
<span class="normal"><a href="#__codelineno-81-12">12</a></span>
<span class="normal"><a href="#__codelineno-81-13">13</a></span>
<span class="normal"><a href="#__codelineno-81-14">14</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-81-1" name="__codelineno-81-1"></a><span class="nd">@celery_app</span><span class="o">.</span><span class="n">task</span><span class="p">(</span>
<a id="__codelineno-81-2" name="__codelineno-81-2"></a>    <span class="n">bind</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-81-3" name="__codelineno-81-3"></a>    <span class="n">max_retries</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>            <span class="c1"># æœ€å¤šé‡è¯•3æ¬¡</span>
<a id="__codelineno-81-4" name="__codelineno-81-4"></a>    <span class="n">default_retry_delay</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>    <span class="c1"># æ¯æ¬¡é‡è¯•é—´éš”5ç§’</span>
<a id="__codelineno-81-5" name="__codelineno-81-5"></a>    <span class="n">time_limit</span><span class="o">=</span><span class="mi">10</span>             <span class="c1"># æœ€é•¿æ‰§è¡Œæ—¶é—´10ç§’ï¼Œè¶…æ—¶å°†è¢«æ€æ­»</span>
<a id="__codelineno-81-6" name="__codelineno-81-6"></a><span class="p">)</span>
<a id="__codelineno-81-7" name="__codelineno-81-7"></a><span class="k">def</span><span class="w"> </span><span class="nf">fragile_task</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
<a id="__codelineno-81-8" name="__codelineno-81-8"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-81-9" name="__codelineno-81-9"></a>        <span class="c1"># å‡è®¾æŸäº›ä¸šåŠ¡å¯èƒ½æŠ›å¼‚å¸¸</span>
<a id="__codelineno-81-10" name="__codelineno-81-10"></a>        <span class="k">if</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-81-11" name="__codelineno-81-11"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;ä¸èƒ½ä¸ºè´Ÿæ•°&quot;</span><span class="p">)</span>
<a id="__codelineno-81-12" name="__codelineno-81-12"></a>        <span class="k">return</span> <span class="n">x</span> <span class="o">*</span> <span class="mi">10</span>
<a id="__codelineno-81-13" name="__codelineno-81-13"></a>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-81-14" name="__codelineno-81-14"></a>        <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">retry</span><span class="p">(</span><span class="n">exc</span><span class="o">=</span><span class="n">e</span><span class="p">)</span>  <span class="c1"># è°ƒç”¨ retry() è‡ªåŠ¨è¿›å…¥é‡è¯•æœºåˆ¶</span>
</code></pre></div></td></tr></table></div>
<h2 id="é›†æˆmongodb">é›†æˆMongodb<a class="headerlink" href="#é›†æˆmongodb" title="Permanent link">&para;</a></h2>
<h3 id="é›†æˆmotorå¼‚æ­¥client">é›†æˆmotorå¼‚æ­¥client<a class="headerlink" href="#é›†æˆmotorå¼‚æ­¥client" title="Permanent link">&para;</a></h3>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Python</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-82-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-82-1" name="__codelineno-82-1"></a><span class="n">pip</span> <span class="n">install</span> <span class="n">motor</span>
</code></pre></div></td></tr></table></div>
<p>database.py  </p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Python</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-83-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-83-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-83-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-83-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-83-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-83-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-83-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-83-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-83-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-83-10">10</a></span>
<span class="normal"><a href="#__codelineno-83-11">11</a></span>
<span class="normal"><a href="#__codelineno-83-12">12</a></span>
<span class="normal"><a href="#__codelineno-83-13">13</a></span>
<span class="normal"><a href="#__codelineno-83-14">14</a></span>
<span class="normal"><a href="#__codelineno-83-15">15</a></span>
<span class="normal"><a href="#__codelineno-83-16">16</a></span>
<span class="normal"><a href="#__codelineno-83-17">17</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-83-1" name="__codelineno-83-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">motor.motor_asyncio</span><span class="w"> </span><span class="kn">import</span> <span class="n">AsyncIOMotorClient</span>
<a id="__codelineno-83-2" name="__codelineno-83-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">fastapi</span><span class="w"> </span><span class="kn">import</span> <span class="n">FastAPI</span>
<a id="__codelineno-83-3" name="__codelineno-83-3"></a>
<a id="__codelineno-83-4" name="__codelineno-83-4"></a><span class="n">MONGO_URL</span> <span class="o">=</span> <span class="s2">&quot;mongodb://localhost:27017&quot;</span>
<a id="__codelineno-83-5" name="__codelineno-83-5"></a><span class="n">DB_NAME</span> <span class="o">=</span> <span class="s2">&quot;mydb&quot;</span>
<a id="__codelineno-83-6" name="__codelineno-83-6"></a>
<a id="__codelineno-83-7" name="__codelineno-83-7"></a><span class="n">client</span><span class="p">:</span> <span class="n">AsyncIOMotorClient</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-83-8" name="__codelineno-83-8"></a><span class="n">db</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-83-9" name="__codelineno-83-9"></a>
<a id="__codelineno-83-10" name="__codelineno-83-10"></a><span class="c1"># æ¨èä½¿ç”¨ lifespan ç”Ÿå‘½å‘¨æœŸç®¡ç†è¿æ¥</span>
<a id="__codelineno-83-11" name="__codelineno-83-11"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">connect_to_mongo</span><span class="p">():</span>
<a id="__codelineno-83-12" name="__codelineno-83-12"></a>    <span class="k">global</span> <span class="n">client</span><span class="p">,</span> <span class="n">db</span>
<a id="__codelineno-83-13" name="__codelineno-83-13"></a>    <span class="n">client</span> <span class="o">=</span> <span class="n">AsyncIOMotorClient</span><span class="p">(</span><span class="n">MONGO_URL</span><span class="p">)</span>
<a id="__codelineno-83-14" name="__codelineno-83-14"></a>    <span class="n">db</span> <span class="o">=</span> <span class="n">client</span><span class="p">[</span><span class="n">DB_NAME</span><span class="p">]</span>
<a id="__codelineno-83-15" name="__codelineno-83-15"></a>
<a id="__codelineno-83-16" name="__codelineno-83-16"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">close_mongo_connection</span><span class="p">():</span>
<a id="__codelineno-83-17" name="__codelineno-83-17"></a>    <span class="n">client</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
<p>models.py  </p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Python</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-84-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-84-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-84-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-84-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-84-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-84-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-84-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-84-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-84-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-84-10">10</a></span>
<span class="normal"><a href="#__codelineno-84-11">11</a></span>
<span class="normal"><a href="#__codelineno-84-12">12</a></span>
<span class="normal"><a href="#__codelineno-84-13">13</a></span>
<span class="normal"><a href="#__codelineno-84-14">14</a></span>
<span class="normal"><a href="#__codelineno-84-15">15</a></span>
<span class="normal"><a href="#__codelineno-84-16">16</a></span>
<span class="normal"><a href="#__codelineno-84-17">17</a></span>
<span class="normal"><a href="#__codelineno-84-18">18</a></span>
<span class="normal"><a href="#__codelineno-84-19">19</a></span>
<span class="normal"><a href="#__codelineno-84-20">20</a></span>
<span class="normal"><a href="#__codelineno-84-21">21</a></span>
<span class="normal"><a href="#__codelineno-84-22">22</a></span>
<span class="normal"><a href="#__codelineno-84-23">23</a></span>
<span class="normal"><a href="#__codelineno-84-24">24</a></span>
<span class="normal"><a href="#__codelineno-84-25">25</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-84-1" name="__codelineno-84-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">pydantic</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseModel</span><span class="p">,</span> <span class="n">Field</span>
<a id="__codelineno-84-2" name="__codelineno-84-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Optional</span>
<a id="__codelineno-84-3" name="__codelineno-84-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">bson</span><span class="w"> </span><span class="kn">import</span> <span class="n">ObjectId</span>
<a id="__codelineno-84-4" name="__codelineno-84-4"></a>
<a id="__codelineno-84-5" name="__codelineno-84-5"></a><span class="c1"># è‡ªå®šä¹‰ ObjectId çš„å­—æ®µè½¬æ¢</span>
<a id="__codelineno-84-6" name="__codelineno-84-6"></a><span class="k">class</span><span class="w"> </span><span class="nc">PyObjectId</span><span class="p">(</span><span class="n">ObjectId</span><span class="p">):</span>
<a id="__codelineno-84-7" name="__codelineno-84-7"></a>
<a id="__codelineno-84-8" name="__codelineno-84-8"></a>    <span class="nd">@classmethod</span>
<a id="__codelineno-84-9" name="__codelineno-84-9"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">__get_validators__</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
<a id="__codelineno-84-10" name="__codelineno-84-10"></a>        <span class="k">yield</span> <span class="bp">cls</span><span class="o">.</span><span class="n">validate</span>
<a id="__codelineno-84-11" name="__codelineno-84-11"></a>
<a id="__codelineno-84-12" name="__codelineno-84-12"></a>    <span class="nd">@classmethod</span>
<a id="__codelineno-84-13" name="__codelineno-84-13"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">validate</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
<a id="__codelineno-84-14" name="__codelineno-84-14"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">ObjectId</span><span class="o">.</span><span class="n">is_valid</span><span class="p">(</span><span class="n">v</span><span class="p">):</span>
<a id="__codelineno-84-15" name="__codelineno-84-15"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;æ— æ•ˆçš„ ObjectId&quot;</span><span class="p">)</span>
<a id="__codelineno-84-16" name="__codelineno-84-16"></a>        <span class="k">return</span> <span class="n">ObjectId</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
<a id="__codelineno-84-17" name="__codelineno-84-17"></a>
<a id="__codelineno-84-18" name="__codelineno-84-18"></a><span class="k">class</span><span class="w"> </span><span class="nc">User</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
<a id="__codelineno-84-19" name="__codelineno-84-19"></a>    <span class="nb">id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">PyObjectId</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">alias</span><span class="o">=</span><span class="s2">&quot;_id&quot;</span><span class="p">)</span>
<a id="__codelineno-84-20" name="__codelineno-84-20"></a>    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-84-21" name="__codelineno-84-21"></a>    <span class="n">email</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-84-22" name="__codelineno-84-22"></a>
<a id="__codelineno-84-23" name="__codelineno-84-23"></a>    <span class="k">class</span><span class="w"> </span><span class="nc">Config</span><span class="p">:</span>
<a id="__codelineno-84-24" name="__codelineno-84-24"></a>        <span class="n">arbitrary_types_allowed</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-84-25" name="__codelineno-84-25"></a>        <span class="n">json_encoders</span> <span class="o">=</span> <span class="p">{</span><span class="n">ObjectId</span><span class="p">:</span> <span class="nb">str</span><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>main.py  </p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Python</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-85-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-85-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-85-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-85-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-85-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-85-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-85-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-85-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-85-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-85-10">10</a></span>
<span class="normal"><a href="#__codelineno-85-11">11</a></span>
<span class="normal"><a href="#__codelineno-85-12">12</a></span>
<span class="normal"><a href="#__codelineno-85-13">13</a></span>
<span class="normal"><a href="#__codelineno-85-14">14</a></span>
<span class="normal"><a href="#__codelineno-85-15">15</a></span>
<span class="normal"><a href="#__codelineno-85-16">16</a></span>
<span class="normal"><a href="#__codelineno-85-17">17</a></span>
<span class="normal"><a href="#__codelineno-85-18">18</a></span>
<span class="normal"><a href="#__codelineno-85-19">19</a></span>
<span class="normal"><a href="#__codelineno-85-20">20</a></span>
<span class="normal"><a href="#__codelineno-85-21">21</a></span>
<span class="normal"><a href="#__codelineno-85-22">22</a></span>
<span class="normal"><a href="#__codelineno-85-23">23</a></span>
<span class="normal"><a href="#__codelineno-85-24">24</a></span>
<span class="normal"><a href="#__codelineno-85-25">25</a></span>
<span class="normal"><a href="#__codelineno-85-26">26</a></span>
<span class="normal"><a href="#__codelineno-85-27">27</a></span>
<span class="normal"><a href="#__codelineno-85-28">28</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-85-1" name="__codelineno-85-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">fastapi</span><span class="w"> </span><span class="kn">import</span> <span class="n">FastAPI</span><span class="p">,</span> <span class="n">HTTPException</span>
<a id="__codelineno-85-2" name="__codelineno-85-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">database</span><span class="w"> </span><span class="kn">import</span> <span class="n">connect_to_mongo</span><span class="p">,</span> <span class="n">close_mongo_connection</span><span class="p">,</span> <span class="n">db</span>
<a id="__codelineno-85-3" name="__codelineno-85-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">models</span><span class="w"> </span><span class="kn">import</span> <span class="n">User</span>
<a id="__codelineno-85-4" name="__codelineno-85-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">bson</span><span class="w"> </span><span class="kn">import</span> <span class="n">ObjectId</span>
<a id="__codelineno-85-5" name="__codelineno-85-5"></a>
<a id="__codelineno-85-6" name="__codelineno-85-6"></a><span class="n">app</span> <span class="o">=</span> <span class="n">FastAPI</span><span class="p">(</span><span class="n">lifespan</span><span class="o">=</span><span class="k">lambda</span> <span class="n">app</span><span class="p">:</span> <span class="n">_lifespan</span><span class="p">(</span><span class="n">app</span><span class="p">))</span>
<a id="__codelineno-85-7" name="__codelineno-85-7"></a>
<a id="__codelineno-85-8" name="__codelineno-85-8"></a><span class="c1"># å¼‚æ­¥ lifespan ç®¡ç†è¿æ¥</span>
<a id="__codelineno-85-9" name="__codelineno-85-9"></a><span class="kn">from</span><span class="w"> </span><span class="nn">contextlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">asynccontextmanager</span>
<a id="__codelineno-85-10" name="__codelineno-85-10"></a><span class="nd">@asynccontextmanager</span>
<a id="__codelineno-85-11" name="__codelineno-85-11"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_lifespan</span><span class="p">(</span><span class="n">app</span><span class="p">:</span> <span class="n">FastAPI</span><span class="p">):</span>
<a id="__codelineno-85-12" name="__codelineno-85-12"></a>    <span class="k">await</span> <span class="n">connect_to_mongo</span><span class="p">()</span>
<a id="__codelineno-85-13" name="__codelineno-85-13"></a>    <span class="k">yield</span>
<a id="__codelineno-85-14" name="__codelineno-85-14"></a>    <span class="k">await</span> <span class="n">close_mongo_connection</span><span class="p">()</span>
<a id="__codelineno-85-15" name="__codelineno-85-15"></a>
<a id="__codelineno-85-16" name="__codelineno-85-16"></a><span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/users&quot;</span><span class="p">)</span>
<a id="__codelineno-85-17" name="__codelineno-85-17"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">create_user</span><span class="p">(</span><span class="n">user</span><span class="p">:</span> <span class="n">User</span><span class="p">):</span>
<a id="__codelineno-85-18" name="__codelineno-85-18"></a>    <span class="n">user_dict</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">dict</span><span class="p">(</span><span class="n">by_alias</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exclude_unset</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-85-19" name="__codelineno-85-19"></a>    <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">db</span><span class="p">[</span><span class="s2">&quot;users&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">insert_one</span><span class="p">(</span><span class="n">user_dict</span><span class="p">)</span>
<a id="__codelineno-85-20" name="__codelineno-85-20"></a>    <span class="n">user_dict</span><span class="p">[</span><span class="s2">&quot;_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">inserted_id</span>
<a id="__codelineno-85-21" name="__codelineno-85-21"></a>    <span class="k">return</span> <span class="n">user_dict</span>
<a id="__codelineno-85-22" name="__codelineno-85-22"></a>
<a id="__codelineno-85-23" name="__codelineno-85-23"></a><span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/users/</span><span class="si">{user_id}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-85-24" name="__codelineno-85-24"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_user</span><span class="p">(</span><span class="n">user_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<a id="__codelineno-85-25" name="__codelineno-85-25"></a>    <span class="n">user</span> <span class="o">=</span> <span class="k">await</span> <span class="n">db</span><span class="p">[</span><span class="s2">&quot;users&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">find_one</span><span class="p">({</span><span class="s2">&quot;_id&quot;</span><span class="p">:</span> <span class="n">ObjectId</span><span class="p">(</span><span class="n">user_id</span><span class="p">)})</span>
<a id="__codelineno-85-26" name="__codelineno-85-26"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="p">:</span>
<a id="__codelineno-85-27" name="__codelineno-85-27"></a>        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">404</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;ç”¨æˆ·æœªæ‰¾åˆ°&quot;</span><span class="p">)</span>
<a id="__codelineno-85-28" name="__codelineno-85-28"></a>    <span class="k">return</span> <span class="n">user</span>
</code></pre></div></td></tr></table></div>
<h3 id="é›†æˆbeanie-odmæ¡†æ¶">é›†æˆBeanie odmæ¡†æ¶<a class="headerlink" href="#é›†æˆbeanie-odmæ¡†æ¶" title="Permanent link">&para;</a></h3>
<p>ä»¥ä¸‹æ˜¯ä¸€ä¸ªå®Œæ•´çš„ FastAPI é›†æˆ MongoDB çš„æœ€ä½³å®è·µæ–¹æ¡ˆï¼Œæ¶µç›– âœ… ä½¿ç”¨ ODM æ¡†æ¶ã€âœ… è‡ªåŠ¨å»ºç´¢å¼•ã€âœ… è®¤è¯é…ç½®ã€âœ… Docker Compose é›†æˆï¼š</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-86-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-86-1" name="__codelineno-86-1"></a>pip<span class="w"> </span>install<span class="w"> </span>beanie<span class="w"> </span>motor<span class="w"> </span>pydantic<span class="o">[</span>dotenv<span class="o">]</span>
</code></pre></div></td></tr></table></div>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Text Only</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-87-1">1</a></span>
<span class="normal"><a href="#__codelineno-87-2">2</a></span>
<span class="normal"><a href="#__codelineno-87-3">3</a></span>
<span class="normal"><a href="#__codelineno-87-4">4</a></span>
<span class="normal"><a href="#__codelineno-87-5">5</a></span>
<span class="normal"><a href="#__codelineno-87-6">6</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-87-1" name="__codelineno-87-1"></a>project/
<a id="__codelineno-87-2" name="__codelineno-87-2"></a>â”œâ”€â”€ main.py             # FastAPI åº”ç”¨å…¥å£
<a id="__codelineno-87-3" name="__codelineno-87-3"></a>â”œâ”€â”€ database.py         # MongoDB åˆå§‹åŒ–
<a id="__codelineno-87-4" name="__codelineno-87-4"></a>â”œâ”€â”€ models/user.py      # ç”¨æˆ·æ¨¡å‹ï¼ŒBeanie æ–‡æ¡£ç±»
<a id="__codelineno-87-5" name="__codelineno-87-5"></a>â”œâ”€â”€ .env                # Mongo é…ç½®
<a id="__codelineno-87-6" name="__codelineno-87-6"></a>â”œâ”€â”€ docker-compose.yml  # ä¸€é”®éƒ¨ç½² Mongo
</code></pre></div></td></tr></table></div>
<p><code>.env</code>ï¼ˆç¯å¢ƒå˜é‡ï¼‰</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Text Only</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-88-1">1</a></span>
<span class="normal"><a href="#__codelineno-88-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-88-1" name="__codelineno-88-1"></a>MONGO_URI=mongodb://root:example@mongo:27017/mydb?authSource=admin
<a id="__codelineno-88-2" name="__codelineno-88-2"></a>DB_NAME=mydb
</code></pre></div></td></tr></table></div>
<p><code>models/user.py</code></p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Python</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-89-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-89-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-89-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-89-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-89-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-89-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-89-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-89-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-89-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-89-10">10</a></span>
<span class="normal"><a href="#__codelineno-89-11">11</a></span>
<span class="normal"><a href="#__codelineno-89-12">12</a></span>
<span class="normal"><a href="#__codelineno-89-13">13</a></span>
<span class="normal"><a href="#__codelineno-89-14">14</a></span>
<span class="normal"><a href="#__codelineno-89-15">15</a></span>
<span class="normal"><a href="#__codelineno-89-16">16</a></span>
<span class="normal"><a href="#__codelineno-89-17">17</a></span>
<span class="normal"><a href="#__codelineno-89-18">18</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-89-1" name="__codelineno-89-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">beanie</span><span class="w"> </span><span class="kn">import</span> <span class="n">Document</span><span class="p">,</span> <span class="n">Indexed</span>
<a id="__codelineno-89-2" name="__codelineno-89-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">pydantic</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseModel</span><span class="p">,</span> <span class="n">EmailStr</span>
<a id="__codelineno-89-3" name="__codelineno-89-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Optional</span>
<a id="__codelineno-89-4" name="__codelineno-89-4"></a>
<a id="__codelineno-89-5" name="__codelineno-89-5"></a><span class="k">class</span><span class="w"> </span><span class="nc">User</span><span class="p">(</span><span class="n">Document</span><span class="p">):</span>
<a id="__codelineno-89-6" name="__codelineno-89-6"></a>    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-89-7" name="__codelineno-89-7"></a>    <span class="n">email</span><span class="p">:</span> <span class="n">Indexed</span><span class="p">(</span><span class="n">EmailStr</span><span class="p">,</span> <span class="n">unique</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># âœ… è‡ªåŠ¨å»ºå”¯ä¸€ç´¢å¼•</span>
<a id="__codelineno-89-8" name="__codelineno-89-8"></a>
<a id="__codelineno-89-9" name="__codelineno-89-9"></a>    <span class="k">class</span><span class="w"> </span><span class="nc">Settings</span><span class="p">:</span>
<a id="__codelineno-89-10" name="__codelineno-89-10"></a>        <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;users&quot;</span>  <span class="c1"># Mongo é›†åˆå</span>
<a id="__codelineno-89-11" name="__codelineno-89-11"></a>
<a id="__codelineno-89-12" name="__codelineno-89-12"></a>    <span class="k">class</span><span class="w"> </span><span class="nc">Config</span><span class="p">:</span>
<a id="__codelineno-89-13" name="__codelineno-89-13"></a>        <span class="n">schema_extra</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-89-14" name="__codelineno-89-14"></a>            <span class="s2">&quot;example&quot;</span><span class="p">:</span> <span class="p">{</span>
<a id="__codelineno-89-15" name="__codelineno-89-15"></a>                <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Tom&quot;</span><span class="p">,</span>
<a id="__codelineno-89-16" name="__codelineno-89-16"></a>                <span class="s2">&quot;email&quot;</span><span class="p">:</span> <span class="s2">&quot;tom@example.com&quot;</span>
<a id="__codelineno-89-17" name="__codelineno-89-17"></a>            <span class="p">}</span>
<a id="__codelineno-89-18" name="__codelineno-89-18"></a>        <span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p><code>database.py</code></p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Python</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-90-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-90-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-90-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-90-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-90-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-90-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-90-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-90-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-90-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-90-10">10</a></span>
<span class="normal"><a href="#__codelineno-90-11">11</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-90-1" name="__codelineno-90-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">motor.motor_asyncio</span>
<a id="__codelineno-90-2" name="__codelineno-90-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">beanie</span><span class="w"> </span><span class="kn">import</span> <span class="n">init_beanie</span>
<a id="__codelineno-90-3" name="__codelineno-90-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">models.user</span><span class="w"> </span><span class="kn">import</span> <span class="n">User</span>
<a id="__codelineno-90-4" name="__codelineno-90-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">os</span><span class="w"> </span><span class="kn">import</span> <span class="n">getenv</span>
<a id="__codelineno-90-5" name="__codelineno-90-5"></a><span class="kn">from</span><span class="w"> </span><span class="nn">dotenv</span><span class="w"> </span><span class="kn">import</span> <span class="n">load_dotenv</span>
<a id="__codelineno-90-6" name="__codelineno-90-6"></a>
<a id="__codelineno-90-7" name="__codelineno-90-7"></a><span class="n">load_dotenv</span><span class="p">()</span>
<a id="__codelineno-90-8" name="__codelineno-90-8"></a>
<a id="__codelineno-90-9" name="__codelineno-90-9"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">init_db</span><span class="p">():</span>
<a id="__codelineno-90-10" name="__codelineno-90-10"></a>    <span class="n">client</span> <span class="o">=</span> <span class="n">motor</span><span class="o">.</span><span class="n">motor_asyncio</span><span class="o">.</span><span class="n">AsyncIOMotorClient</span><span class="p">(</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;MONGO_URI&quot;</span><span class="p">))</span>
<a id="__codelineno-90-11" name="__codelineno-90-11"></a>    <span class="k">await</span> <span class="n">init_beanie</span><span class="p">(</span><span class="n">database</span><span class="o">=</span><span class="n">client</span><span class="p">[</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;DB_NAME&quot;</span><span class="p">)],</span> <span class="n">document_models</span><span class="o">=</span><span class="p">[</span><span class="n">User</span><span class="p">])</span>
</code></pre></div></td></tr></table></div>
<p><code>main.py</code></p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Python</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-91-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-91-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-91-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-91-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-91-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-91-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-91-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-91-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-91-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-91-10">10</a></span>
<span class="normal"><a href="#__codelineno-91-11">11</a></span>
<span class="normal"><a href="#__codelineno-91-12">12</a></span>
<span class="normal"><a href="#__codelineno-91-13">13</a></span>
<span class="normal"><a href="#__codelineno-91-14">14</a></span>
<span class="normal"><a href="#__codelineno-91-15">15</a></span>
<span class="normal"><a href="#__codelineno-91-16">16</a></span>
<span class="normal"><a href="#__codelineno-91-17">17</a></span>
<span class="normal"><a href="#__codelineno-91-18">18</a></span>
<span class="normal"><a href="#__codelineno-91-19">19</a></span>
<span class="normal"><a href="#__codelineno-91-20">20</a></span>
<span class="normal"><a href="#__codelineno-91-21">21</a></span>
<span class="normal"><a href="#__codelineno-91-22">22</a></span>
<span class="normal"><a href="#__codelineno-91-23">23</a></span>
<span class="normal"><a href="#__codelineno-91-24">24</a></span>
<span class="normal"><a href="#__codelineno-91-25">25</a></span>
<span class="normal"><a href="#__codelineno-91-26">26</a></span>
<span class="normal"><a href="#__codelineno-91-27">27</a></span>
<span class="normal"><a href="#__codelineno-91-28">28</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-91-1" name="__codelineno-91-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">fastapi</span><span class="w"> </span><span class="kn">import</span> <span class="n">FastAPI</span><span class="p">,</span> <span class="n">HTTPException</span>
<a id="__codelineno-91-2" name="__codelineno-91-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">models.user</span><span class="w"> </span><span class="kn">import</span> <span class="n">User</span>
<a id="__codelineno-91-3" name="__codelineno-91-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">database</span><span class="w"> </span><span class="kn">import</span> <span class="n">init_db</span>
<a id="__codelineno-91-4" name="__codelineno-91-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">pydantic</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseModel</span><span class="p">,</span> <span class="n">EmailStr</span>
<a id="__codelineno-91-5" name="__codelineno-91-5"></a><span class="kn">from</span><span class="w"> </span><span class="nn">contextlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">asynccontextmanager</span>
<a id="__codelineno-91-6" name="__codelineno-91-6"></a>
<a id="__codelineno-91-7" name="__codelineno-91-7"></a><span class="k">class</span><span class="w"> </span><span class="nc">UserIn</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
<a id="__codelineno-91-8" name="__codelineno-91-8"></a>    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-91-9" name="__codelineno-91-9"></a>    <span class="n">email</span><span class="p">:</span> <span class="n">EmailStr</span>
<a id="__codelineno-91-10" name="__codelineno-91-10"></a>
<a id="__codelineno-91-11" name="__codelineno-91-11"></a><span class="nd">@asynccontextmanager</span>
<a id="__codelineno-91-12" name="__codelineno-91-12"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">lifespan</span><span class="p">(</span><span class="n">app</span><span class="p">:</span> <span class="n">FastAPI</span><span class="p">):</span>
<a id="__codelineno-91-13" name="__codelineno-91-13"></a>    <span class="k">await</span> <span class="n">init_db</span><span class="p">()</span>
<a id="__codelineno-91-14" name="__codelineno-91-14"></a>    <span class="k">yield</span>
<a id="__codelineno-91-15" name="__codelineno-91-15"></a>
<a id="__codelineno-91-16" name="__codelineno-91-16"></a><span class="n">app</span> <span class="o">=</span> <span class="n">FastAPI</span><span class="p">(</span><span class="n">lifespan</span><span class="o">=</span><span class="n">lifespan</span><span class="p">)</span>
<a id="__codelineno-91-17" name="__codelineno-91-17"></a>
<a id="__codelineno-91-18" name="__codelineno-91-18"></a><span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/users&quot;</span><span class="p">)</span>
<a id="__codelineno-91-19" name="__codelineno-91-19"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">create_user</span><span class="p">(</span><span class="n">user_in</span><span class="p">:</span> <span class="n">UserIn</span><span class="p">):</span>
<a id="__codelineno-91-20" name="__codelineno-91-20"></a>    <span class="k">if</span> <span class="k">await</span> <span class="n">User</span><span class="o">.</span><span class="n">find_one</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">email</span> <span class="o">==</span> <span class="n">user_in</span><span class="o">.</span><span class="n">email</span><span class="p">):</span>
<a id="__codelineno-91-21" name="__codelineno-91-21"></a>        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">409</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;é‚®ç®±å·²å­˜åœ¨&quot;</span><span class="p">)</span>
<a id="__codelineno-91-22" name="__codelineno-91-22"></a>    <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="p">(</span><span class="o">**</span><span class="n">user_in</span><span class="o">.</span><span class="n">dict</span><span class="p">())</span>
<a id="__codelineno-91-23" name="__codelineno-91-23"></a>    <span class="k">await</span> <span class="n">user</span><span class="o">.</span><span class="n">insert</span><span class="p">()</span>
<a id="__codelineno-91-24" name="__codelineno-91-24"></a>    <span class="k">return</span> <span class="n">user</span>
<a id="__codelineno-91-25" name="__codelineno-91-25"></a>
<a id="__codelineno-91-26" name="__codelineno-91-26"></a><span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/users&quot;</span><span class="p">)</span>
<a id="__codelineno-91-27" name="__codelineno-91-27"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">list_users</span><span class="p">():</span>
<a id="__codelineno-91-28" name="__codelineno-91-28"></a>    <span class="k">return</span> <span class="k">await</span> <span class="n">User</span><span class="o">.</span><span class="n">find_all</span><span class="p">()</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
<hr />
<p><code>docker-compose.yml</code></p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">YAML</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-92-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-92-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-92-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-92-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-92-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-92-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-92-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-92-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-92-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-92-10">10</a></span>
<span class="normal"><a href="#__codelineno-92-11">11</a></span>
<span class="normal"><a href="#__codelineno-92-12">12</a></span>
<span class="normal"><a href="#__codelineno-92-13">13</a></span>
<span class="normal"><a href="#__codelineno-92-14">14</a></span>
<span class="normal"><a href="#__codelineno-92-15">15</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-92-1" name="__codelineno-92-1"></a><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;3.8&quot;</span>
<a id="__codelineno-92-2" name="__codelineno-92-2"></a><span class="nt">services</span><span class="p">:</span>
<a id="__codelineno-92-3" name="__codelineno-92-3"></a><span class="w">  </span><span class="nt">mongo</span><span class="p">:</span>
<a id="__codelineno-92-4" name="__codelineno-92-4"></a><span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mongo:6.0</span>
<a id="__codelineno-92-5" name="__codelineno-92-5"></a><span class="w">    </span><span class="nt">container_name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mongo</span>
<a id="__codelineno-92-6" name="__codelineno-92-6"></a><span class="w">    </span><span class="nt">ports</span><span class="p">:</span>
<a id="__codelineno-92-7" name="__codelineno-92-7"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;27017:27017&quot;</span>
<a id="__codelineno-92-8" name="__codelineno-92-8"></a><span class="w">    </span><span class="nt">environment</span><span class="p">:</span>
<a id="__codelineno-92-9" name="__codelineno-92-9"></a><span class="w">      </span><span class="nt">MONGO_INITDB_ROOT_USERNAME</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">root</span>
<a id="__codelineno-92-10" name="__codelineno-92-10"></a><span class="w">      </span><span class="nt">MONGO_INITDB_ROOT_PASSWORD</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">example</span>
<a id="__codelineno-92-11" name="__codelineno-92-11"></a><span class="w">    </span><span class="nt">volumes</span><span class="p">:</span>
<a id="__codelineno-92-12" name="__codelineno-92-12"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mongo-data:/data/db</span>
<a id="__codelineno-92-13" name="__codelineno-92-13"></a>
<a id="__codelineno-92-14" name="__codelineno-92-14"></a><span class="nt">volumes</span><span class="p">:</span>
<a id="__codelineno-92-15" name="__codelineno-92-15"></a><span class="w">  </span><span class="nt">mongo-data</span><span class="p">:</span>
</code></pre></div></td></tr></table></div>
<hr />
<h3 id="odmå¤æ‚åµŒå¥—æ¨¡å‹å¦‚ç”¨æˆ·æ¡£æ¡ˆåœ°å€ä¿¡æ¯">ODMå¤æ‚åµŒå¥—æ¨¡å‹ï¼ˆå¦‚ç”¨æˆ·æ¡£æ¡ˆã€åœ°å€ä¿¡æ¯ï¼‰<a class="headerlink" href="#odmå¤æ‚åµŒå¥—æ¨¡å‹å¦‚ç”¨æˆ·æ¡£æ¡ˆåœ°å€ä¿¡æ¯" title="Permanent link">&para;</a></h3>
<p>ğŸ—‚ï¸ ç¤ºä¾‹æ¨¡å‹ç»“æ„ï¼š<code>models/user.py</code></p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Python</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-93-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-93-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-93-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-93-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-93-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-93-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-93-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-93-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-93-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-93-10">10</a></span>
<span class="normal"><a href="#__codelineno-93-11">11</a></span>
<span class="normal"><a href="#__codelineno-93-12">12</a></span>
<span class="normal"><a href="#__codelineno-93-13">13</a></span>
<span class="normal"><a href="#__codelineno-93-14">14</a></span>
<span class="normal"><a href="#__codelineno-93-15">15</a></span>
<span class="normal"><a href="#__codelineno-93-16">16</a></span>
<span class="normal"><a href="#__codelineno-93-17">17</a></span>
<span class="normal"><a href="#__codelineno-93-18">18</a></span>
<span class="normal"><a href="#__codelineno-93-19">19</a></span>
<span class="normal"><a href="#__codelineno-93-20">20</a></span>
<span class="normal"><a href="#__codelineno-93-21">21</a></span>
<span class="normal"><a href="#__codelineno-93-22">22</a></span>
<span class="normal"><a href="#__codelineno-93-23">23</a></span>
<span class="normal"><a href="#__codelineno-93-24">24</a></span>
<span class="normal"><a href="#__codelineno-93-25">25</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-93-1" name="__codelineno-93-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">beanie</span><span class="w"> </span><span class="kn">import</span> <span class="n">Document</span><span class="p">,</span> <span class="n">Indexed</span>
<a id="__codelineno-93-2" name="__codelineno-93-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">pydantic</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseModel</span><span class="p">,</span> <span class="n">EmailStr</span>
<a id="__codelineno-93-3" name="__codelineno-93-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">List</span>
<a id="__codelineno-93-4" name="__codelineno-93-4"></a>
<a id="__codelineno-93-5" name="__codelineno-93-5"></a><span class="c1"># åµŒå¥—åœ°å€ä¿¡æ¯</span>
<a id="__codelineno-93-6" name="__codelineno-93-6"></a><span class="k">class</span><span class="w"> </span><span class="nc">Address</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
<a id="__codelineno-93-7" name="__codelineno-93-7"></a>    <span class="n">street</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-93-8" name="__codelineno-93-8"></a>    <span class="n">city</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-93-9" name="__codelineno-93-9"></a>    <span class="n">zipcode</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-93-10" name="__codelineno-93-10"></a>    <span class="n">country</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-93-11" name="__codelineno-93-11"></a>
<a id="__codelineno-93-12" name="__codelineno-93-12"></a><span class="c1"># ç”¨æˆ·æ¡£æ¡ˆ</span>
<a id="__codelineno-93-13" name="__codelineno-93-13"></a><span class="k">class</span><span class="w"> </span><span class="nc">Profile</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
<a id="__codelineno-93-14" name="__codelineno-93-14"></a>    <span class="n">bio</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-93-15" name="__codelineno-93-15"></a>    <span class="n">age</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-93-16" name="__codelineno-93-16"></a>    <span class="n">addresses</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Address</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-93-17" name="__codelineno-93-17"></a>
<a id="__codelineno-93-18" name="__codelineno-93-18"></a><span class="c1"># ç”¨æˆ·ä¸»æ¨¡å‹</span>
<a id="__codelineno-93-19" name="__codelineno-93-19"></a><span class="k">class</span><span class="w"> </span><span class="nc">User</span><span class="p">(</span><span class="n">Document</span><span class="p">):</span>
<a id="__codelineno-93-20" name="__codelineno-93-20"></a>    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-93-21" name="__codelineno-93-21"></a>    <span class="n">email</span><span class="p">:</span> <span class="n">Indexed</span><span class="p">(</span><span class="n">EmailStr</span><span class="p">,</span> <span class="n">unique</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-93-22" name="__codelineno-93-22"></a>    <span class="n">profile</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Profile</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-93-23" name="__codelineno-93-23"></a>
<a id="__codelineno-93-24" name="__codelineno-93-24"></a>    <span class="k">class</span><span class="w"> </span><span class="nc">Settings</span><span class="p">:</span>
<a id="__codelineno-93-25" name="__codelineno-93-25"></a>        <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;users&quot;</span>
</code></pre></div></td></tr></table></div>
<p>ğŸ§ª ç¤ºä¾‹æ•°æ®æäº¤ JSONï¼š</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">JSON</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-94-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-94-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-94-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-94-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-94-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-94-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-94-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-94-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-94-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-94-10">10</a></span>
<span class="normal"><a href="#__codelineno-94-11">11</a></span>
<span class="normal"><a href="#__codelineno-94-12">12</a></span>
<span class="normal"><a href="#__codelineno-94-13">13</a></span>
<span class="normal"><a href="#__codelineno-94-14">14</a></span>
<span class="normal"><a href="#__codelineno-94-15">15</a></span>
<span class="normal"><a href="#__codelineno-94-16">16</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-94-1" name="__codelineno-94-1"></a><span class="p">{</span>
<a id="__codelineno-94-2" name="__codelineno-94-2"></a><span class="w">  </span><span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;å°ä¸­åŒå­¦&quot;</span><span class="p">,</span>
<a id="__codelineno-94-3" name="__codelineno-94-3"></a><span class="w">  </span><span class="nt">&quot;email&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;xiaozhong@example.com&quot;</span><span class="p">,</span>
<a id="__codelineno-94-4" name="__codelineno-94-4"></a><span class="w">  </span><span class="nt">&quot;profile&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-94-5" name="__codelineno-94-5"></a><span class="w">    </span><span class="nt">&quot;bio&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;å…¨æ ˆå¼€å‘è€…&quot;</span><span class="p">,</span>
<a id="__codelineno-94-6" name="__codelineno-94-6"></a><span class="w">    </span><span class="nt">&quot;age&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">30</span><span class="p">,</span>
<a id="__codelineno-94-7" name="__codelineno-94-7"></a><span class="w">    </span><span class="nt">&quot;addresses&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<a id="__codelineno-94-8" name="__codelineno-94-8"></a><span class="w">      </span><span class="p">{</span>
<a id="__codelineno-94-9" name="__codelineno-94-9"></a><span class="w">        </span><span class="nt">&quot;street&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;å¤©å®‰é—¨å¤§è¡— 1 å·&quot;</span><span class="p">,</span>
<a id="__codelineno-94-10" name="__codelineno-94-10"></a><span class="w">        </span><span class="nt">&quot;city&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;åŒ—äº¬&quot;</span><span class="p">,</span>
<a id="__codelineno-94-11" name="__codelineno-94-11"></a><span class="w">        </span><span class="nt">&quot;zipcode&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;100000&quot;</span><span class="p">,</span>
<a id="__codelineno-94-12" name="__codelineno-94-12"></a><span class="w">        </span><span class="nt">&quot;country&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;ä¸­å›½&quot;</span>
<a id="__codelineno-94-13" name="__codelineno-94-13"></a><span class="w">      </span><span class="p">}</span>
<a id="__codelineno-94-14" name="__codelineno-94-14"></a><span class="w">    </span><span class="p">]</span>
<a id="__codelineno-94-15" name="__codelineno-94-15"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-94-16" name="__codelineno-94-16"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<h3 id="mongodb-å‰¯æœ¬é›†--é›†ç¾¤è®¤è¯é…ç½®">MongoDB å‰¯æœ¬é›† / é›†ç¾¤è®¤è¯é…ç½®<a class="headerlink" href="#mongodb-å‰¯æœ¬é›†--é›†ç¾¤è®¤è¯é…ç½®" title="Permanent link">&para;</a></h3>
<p>ğŸ” ä¿®æ”¹ <code>.env</code> ä¸­è¿æ¥ URI</p>
<p>Mongo URI è¯­æ³•æ”¯æŒé›†ç¾¤æˆ–å‰¯æœ¬é›†ï¼Œä¾‹å¦‚ï¼š</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Python</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-95-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-95-1" name="__codelineno-95-1"></a><span class="n">MONGO_URI</span><span class="o">=</span><span class="n">mongodb</span><span class="p">:</span><span class="o">//</span><span class="n">root</span><span class="p">:</span><span class="n">example</span><span class="nd">@mongo1</span><span class="p">:</span><span class="mi">27017</span><span class="p">,</span><span class="n">mongo2</span><span class="p">:</span><span class="mi">27017</span><span class="p">,</span><span class="n">mongo3</span><span class="p">:</span><span class="mi">27017</span><span class="o">/</span><span class="n">mydb</span><span class="err">?</span><span class="n">replicaSet</span><span class="o">=</span><span class="n">rs0</span><span class="o">&amp;</span><span class="n">authSource</span><span class="o">=</span><span class="n">admin</span>
</code></pre></div></td></tr></table></div>
<ul>
<li><code>mongo1,mongo2,mongo3</code>: æŒ‡å®šå¤šä¸ª Mongo èŠ‚ç‚¹ã€‚</li>
<li><code>replicaSet=rs0</code>: å‰¯æœ¬é›†åç§°ï¼Œéœ€ä¸é›†ç¾¤è®¾ç½®ä¸€è‡´ã€‚</li>
<li><code>authSource=admin</code>: è®¤è¯æ•°æ®åº“ã€‚</li>
</ul>
<p>ğŸ³ Docker Compose æ”¯æŒå‰¯æœ¬é›†ï¼ˆç¤ºæ„ï¼‰</p>
<p>å‰¯æœ¬é›†éœ€è¦å®¹å™¨äº’é€šã€æ—¶é—´åŒæ­¥ï¼Œä»¥ä¸‹æ˜¯æœ€å°å¯è¿è¡Œé…ç½®ä¹‹ä¸€ï¼ˆç®€åŒ–ç‰ˆï¼‰ï¼š</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">YAML</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-96-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-96-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-96-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-96-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-96-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-96-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-96-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-96-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-96-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-96-10">10</a></span>
<span class="normal"><a href="#__codelineno-96-11">11</a></span>
<span class="normal"><a href="#__codelineno-96-12">12</a></span>
<span class="normal"><a href="#__codelineno-96-13">13</a></span>
<span class="normal"><a href="#__codelineno-96-14">14</a></span>
<span class="normal"><a href="#__codelineno-96-15">15</a></span>
<span class="normal"><a href="#__codelineno-96-16">16</a></span>
<span class="normal"><a href="#__codelineno-96-17">17</a></span>
<span class="normal"><a href="#__codelineno-96-18">18</a></span>
<span class="normal"><a href="#__codelineno-96-19">19</a></span>
<span class="normal"><a href="#__codelineno-96-20">20</a></span>
<span class="normal"><a href="#__codelineno-96-21">21</a></span>
<span class="normal"><a href="#__codelineno-96-22">22</a></span>
<span class="normal"><a href="#__codelineno-96-23">23</a></span>
<span class="normal"><a href="#__codelineno-96-24">24</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-96-1" name="__codelineno-96-1"></a><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;3.8&#39;</span>
<a id="__codelineno-96-2" name="__codelineno-96-2"></a><span class="nt">services</span><span class="p">:</span>
<a id="__codelineno-96-3" name="__codelineno-96-3"></a><span class="w">  </span><span class="nt">mongo1</span><span class="p">:</span>
<a id="__codelineno-96-4" name="__codelineno-96-4"></a><span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mongo:6.0</span>
<a id="__codelineno-96-5" name="__codelineno-96-5"></a><span class="w">    </span><span class="nt">container_name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mongo1</span>
<a id="__codelineno-96-6" name="__codelineno-96-6"></a><span class="w">    </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;mongod&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;--replSet&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;rs0&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;--bind_ip_all&quot;</span><span class="p p-Indicator">]</span>
<a id="__codelineno-96-7" name="__codelineno-96-7"></a><span class="w">    </span><span class="nt">ports</span><span class="p">:</span>
<a id="__codelineno-96-8" name="__codelineno-96-8"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;27017:27017&quot;</span>
<a id="__codelineno-96-9" name="__codelineno-96-9"></a><span class="w">    </span><span class="nt">environment</span><span class="p">:</span>
<a id="__codelineno-96-10" name="__codelineno-96-10"></a><span class="w">      </span><span class="nt">MONGO_INITDB_ROOT_USERNAME</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">root</span>
<a id="__codelineno-96-11" name="__codelineno-96-11"></a><span class="w">      </span><span class="nt">MONGO_INITDB_ROOT_PASSWORD</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">example</span>
<a id="__codelineno-96-12" name="__codelineno-96-12"></a>
<a id="__codelineno-96-13" name="__codelineno-96-13"></a><span class="w">  </span><span class="nt">mongo2</span><span class="p">:</span>
<a id="__codelineno-96-14" name="__codelineno-96-14"></a><span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mongo:6.0</span>
<a id="__codelineno-96-15" name="__codelineno-96-15"></a><span class="w">    </span><span class="nt">container_name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mongo2</span>
<a id="__codelineno-96-16" name="__codelineno-96-16"></a><span class="w">    </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;mongod&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;--replSet&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;rs0&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;--bind_ip_all&quot;</span><span class="p p-Indicator">]</span>
<a id="__codelineno-96-17" name="__codelineno-96-17"></a>
<a id="__codelineno-96-18" name="__codelineno-96-18"></a><span class="w">  </span><span class="nt">mongo3</span><span class="p">:</span>
<a id="__codelineno-96-19" name="__codelineno-96-19"></a><span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mongo:6.0</span>
<a id="__codelineno-96-20" name="__codelineno-96-20"></a><span class="w">    </span><span class="nt">container_name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mongo3</span>
<a id="__codelineno-96-21" name="__codelineno-96-21"></a><span class="w">    </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;mongod&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;--replSet&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;rs0&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;--bind_ip_all&quot;</span><span class="p p-Indicator">]</span>
<a id="__codelineno-96-22" name="__codelineno-96-22"></a>
<a id="__codelineno-96-23" name="__codelineno-96-23"></a><span class="nt">volumes</span><span class="p">:</span>
<a id="__codelineno-96-24" name="__codelineno-96-24"></a><span class="w">  </span><span class="nt">mongo-data</span><span class="p">:</span>
</code></pre></div></td></tr></table></div>
<p>åˆå§‹åŒ–å‰¯æœ¬é›†ï¼š</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-97-1">1</a></span>
<span class="normal"><a href="#__codelineno-97-2">2</a></span>
<span class="normal"><a href="#__codelineno-97-3">3</a></span>
<span class="normal"><a href="#__codelineno-97-4">4</a></span>
<span class="normal"><a href="#__codelineno-97-5">5</a></span>
<span class="normal"><a href="#__codelineno-97-6">6</a></span>
<span class="normal"><a href="#__codelineno-97-7">7</a></span>
<span class="normal"><a href="#__codelineno-97-8">8</a></span>
<span class="normal"><a href="#__codelineno-97-9">9</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-97-1" name="__codelineno-97-1"></a>docker<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>-it<span class="w"> </span>mongo1<span class="w"> </span>mongosh
<a id="__codelineno-97-2" name="__codelineno-97-2"></a>rs.initiate<span class="o">({</span>
<a id="__codelineno-97-3" name="__codelineno-97-3"></a><span class="w">  </span>_id:<span class="w"> </span><span class="s2">&quot;rs0&quot;</span>,
<a id="__codelineno-97-4" name="__codelineno-97-4"></a><span class="w">  </span>members:<span class="w"> </span><span class="o">[</span>
<a id="__codelineno-97-5" name="__codelineno-97-5"></a><span class="w">    </span><span class="o">{</span><span class="w"> </span>_id:<span class="w"> </span><span class="m">0</span>,<span class="w"> </span>host:<span class="w"> </span><span class="s2">&quot;mongo1:27017&quot;</span><span class="w"> </span><span class="o">}</span>,
<a id="__codelineno-97-6" name="__codelineno-97-6"></a><span class="w">    </span><span class="o">{</span><span class="w"> </span>_id:<span class="w"> </span><span class="m">1</span>,<span class="w"> </span>host:<span class="w"> </span><span class="s2">&quot;mongo2:27017&quot;</span><span class="w"> </span><span class="o">}</span>,
<a id="__codelineno-97-7" name="__codelineno-97-7"></a><span class="w">    </span><span class="o">{</span><span class="w"> </span>_id:<span class="w"> </span><span class="m">2</span>,<span class="w"> </span>host:<span class="w"> </span><span class="s2">&quot;mongo3:27017&quot;</span><span class="w"> </span><span class="o">}</span>
<a id="__codelineno-97-8" name="__codelineno-97-8"></a><span class="w">  </span><span class="o">]</span>
<a id="__codelineno-97-9" name="__codelineno-97-9"></a><span class="o">})</span>
</code></pre></div></td></tr></table></div>
<h3 id="curdå’Œåˆ†é¡µæ¨¡ç³Šæœç´¢">curdå’Œåˆ†é¡µ+æ¨¡ç³Šæœç´¢<a class="headerlink" href="#curdå’Œåˆ†é¡µæ¨¡ç³Šæœç´¢" title="Permanent link">&para;</a></h3>
<p>âœ… 1. ç”¨æˆ·æ¨¡å‹ï¼ˆæ”¯æŒåˆ†é¡µ + æ¨¡ç³Šæœç´¢ï¼‰</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Python</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-98-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-98-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-98-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-98-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-98-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-98-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-98-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-98-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-98-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-98-10">10</a></span>
<span class="normal"><a href="#__codelineno-98-11">11</a></span>
<span class="normal"><a href="#__codelineno-98-12">12</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-98-1" name="__codelineno-98-1"></a><span class="c1"># models/user.py</span>
<a id="__codelineno-98-2" name="__codelineno-98-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">beanie</span><span class="w"> </span><span class="kn">import</span> <span class="n">Document</span><span class="p">,</span> <span class="n">Indexed</span>
<a id="__codelineno-98-3" name="__codelineno-98-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">pydantic</span><span class="w"> </span><span class="kn">import</span> <span class="n">EmailStr</span>
<a id="__codelineno-98-4" name="__codelineno-98-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Optional</span>
<a id="__codelineno-98-5" name="__codelineno-98-5"></a>
<a id="__codelineno-98-6" name="__codelineno-98-6"></a><span class="k">class</span><span class="w"> </span><span class="nc">User</span><span class="p">(</span><span class="n">Document</span><span class="p">):</span>
<a id="__codelineno-98-7" name="__codelineno-98-7"></a>    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-98-8" name="__codelineno-98-8"></a>    <span class="n">email</span><span class="p">:</span> <span class="n">Indexed</span><span class="p">(</span><span class="n">EmailStr</span><span class="p">,</span> <span class="n">unique</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-98-9" name="__codelineno-98-9"></a>    <span class="n">age</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span>
<a id="__codelineno-98-10" name="__codelineno-98-10"></a>
<a id="__codelineno-98-11" name="__codelineno-98-11"></a>    <span class="k">class</span><span class="w"> </span><span class="nc">Settings</span><span class="p">:</span>
<a id="__codelineno-98-12" name="__codelineno-98-12"></a>        <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;users&quot;</span>
</code></pre></div></td></tr></table></div>
<hr />
<p>âœ… 2. åˆ›å»ºç”¨æˆ·ã€æŸ¥è¯¢ã€åˆ†é¡µã€æ¨¡ç³Šæœç´¢ã€å¯¼å‡ºæ¥å£</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Python</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-99-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-99-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-99-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-99-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-99-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-99-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-99-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-99-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-99-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-99-10">10</a></span>
<span class="normal"><a href="#__codelineno-99-11">11</a></span>
<span class="normal"><a href="#__codelineno-99-12">12</a></span>
<span class="normal"><a href="#__codelineno-99-13">13</a></span>
<span class="normal"><a href="#__codelineno-99-14">14</a></span>
<span class="normal"><a href="#__codelineno-99-15">15</a></span>
<span class="normal"><a href="#__codelineno-99-16">16</a></span>
<span class="normal"><a href="#__codelineno-99-17">17</a></span>
<span class="normal"><a href="#__codelineno-99-18">18</a></span>
<span class="normal"><a href="#__codelineno-99-19">19</a></span>
<span class="normal"><a href="#__codelineno-99-20">20</a></span>
<span class="normal"><a href="#__codelineno-99-21">21</a></span>
<span class="normal"><a href="#__codelineno-99-22">22</a></span>
<span class="normal"><a href="#__codelineno-99-23">23</a></span>
<span class="normal"><a href="#__codelineno-99-24">24</a></span>
<span class="normal"><a href="#__codelineno-99-25">25</a></span>
<span class="normal"><a href="#__codelineno-99-26">26</a></span>
<span class="normal"><a href="#__codelineno-99-27">27</a></span>
<span class="normal"><a href="#__codelineno-99-28">28</a></span>
<span class="normal"><a href="#__codelineno-99-29">29</a></span>
<span class="normal"><a href="#__codelineno-99-30">30</a></span>
<span class="normal"><a href="#__codelineno-99-31">31</a></span>
<span class="normal"><a href="#__codelineno-99-32">32</a></span>
<span class="normal"><a href="#__codelineno-99-33">33</a></span>
<span class="normal"><a href="#__codelineno-99-34">34</a></span>
<span class="normal"><a href="#__codelineno-99-35">35</a></span>
<span class="normal"><a href="#__codelineno-99-36">36</a></span>
<span class="normal"><a href="#__codelineno-99-37">37</a></span>
<span class="normal"><a href="#__codelineno-99-38">38</a></span>
<span class="normal"><a href="#__codelineno-99-39">39</a></span>
<span class="normal"><a href="#__codelineno-99-40">40</a></span>
<span class="normal"><a href="#__codelineno-99-41">41</a></span>
<span class="normal"><a href="#__codelineno-99-42">42</a></span>
<span class="normal"><a href="#__codelineno-99-43">43</a></span>
<span class="normal"><a href="#__codelineno-99-44">44</a></span>
<span class="normal"><a href="#__codelineno-99-45">45</a></span>
<span class="normal"><a href="#__codelineno-99-46">46</a></span>
<span class="normal"><a href="#__codelineno-99-47">47</a></span>
<span class="normal"><a href="#__codelineno-99-48">48</a></span>
<span class="normal"><a href="#__codelineno-99-49">49</a></span>
<span class="normal"><a href="#__codelineno-99-50">50</a></span>
<span class="normal"><a href="#__codelineno-99-51">51</a></span>
<span class="normal"><a href="#__codelineno-99-52">52</a></span>
<span class="normal"><a href="#__codelineno-99-53">53</a></span>
<span class="normal"><a href="#__codelineno-99-54">54</a></span>
<span class="normal"><a href="#__codelineno-99-55">55</a></span>
<span class="normal"><a href="#__codelineno-99-56">56</a></span>
<span class="normal"><a href="#__codelineno-99-57">57</a></span>
<span class="normal"><a href="#__codelineno-99-58">58</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-99-1" name="__codelineno-99-1"></a><span class="c1"># main.py</span>
<a id="__codelineno-99-2" name="__codelineno-99-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">fastapi</span><span class="w"> </span><span class="kn">import</span> <span class="n">FastAPI</span><span class="p">,</span> <span class="n">Query</span><span class="p">,</span> <span class="n">HTTPException</span>
<a id="__codelineno-99-3" name="__codelineno-99-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span>
<a id="__codelineno-99-4" name="__codelineno-99-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">models.user</span><span class="w"> </span><span class="kn">import</span> <span class="n">User</span>
<a id="__codelineno-99-5" name="__codelineno-99-5"></a><span class="kn">from</span><span class="w"> </span><span class="nn">pydantic</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseModel</span>
<a id="__codelineno-99-6" name="__codelineno-99-6"></a><span class="kn">import</span><span class="w"> </span><span class="nn">beanie</span><span class="o">,</span><span class="w"> </span><span class="nn">motor.motor_asyncio</span>
<a id="__codelineno-99-7" name="__codelineno-99-7"></a><span class="kn">import</span><span class="w"> </span><span class="nn">csv</span><span class="o">,</span><span class="w"> </span><span class="nn">io</span>
<a id="__codelineno-99-8" name="__codelineno-99-8"></a><span class="kn">from</span><span class="w"> </span><span class="nn">fastapi.responses</span><span class="w"> </span><span class="kn">import</span> <span class="n">StreamingResponse</span>
<a id="__codelineno-99-9" name="__codelineno-99-9"></a>
<a id="__codelineno-99-10" name="__codelineno-99-10"></a><span class="n">app</span> <span class="o">=</span> <span class="n">FastAPI</span><span class="p">()</span>
<a id="__codelineno-99-11" name="__codelineno-99-11"></a>
<a id="__codelineno-99-12" name="__codelineno-99-12"></a><span class="c1"># åˆå§‹åŒ–æ•°æ®åº“è¿æ¥</span>
<a id="__codelineno-99-13" name="__codelineno-99-13"></a><span class="nd">@app</span><span class="o">.</span><span class="n">on_event</span><span class="p">(</span><span class="s2">&quot;startup&quot;</span><span class="p">)</span>
<a id="__codelineno-99-14" name="__codelineno-99-14"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">init_db</span><span class="p">():</span>
<a id="__codelineno-99-15" name="__codelineno-99-15"></a>    <span class="n">client</span> <span class="o">=</span> <span class="n">motor</span><span class="o">.</span><span class="n">motor_asyncio</span><span class="o">.</span><span class="n">AsyncIOMotorClient</span><span class="p">(</span><span class="s2">&quot;mongodb://localhost:27017&quot;</span><span class="p">)</span>
<a id="__codelineno-99-16" name="__codelineno-99-16"></a>    <span class="k">await</span> <span class="n">beanie</span><span class="o">.</span><span class="n">init_beanie</span><span class="p">(</span><span class="n">database</span><span class="o">=</span><span class="n">client</span><span class="o">.</span><span class="n">mydb</span><span class="p">,</span> <span class="n">document_models</span><span class="o">=</span><span class="p">[</span><span class="n">User</span><span class="p">])</span>
<a id="__codelineno-99-17" name="__codelineno-99-17"></a>
<a id="__codelineno-99-18" name="__codelineno-99-18"></a>
<a id="__codelineno-99-19" name="__codelineno-99-19"></a><span class="c1"># åˆ›å»ºç”¨æˆ·</span>
<a id="__codelineno-99-20" name="__codelineno-99-20"></a><span class="k">class</span><span class="w"> </span><span class="nc">UserIn</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
<a id="__codelineno-99-21" name="__codelineno-99-21"></a>    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-99-22" name="__codelineno-99-22"></a>    <span class="n">email</span><span class="p">:</span> <span class="n">EmailStr</span>
<a id="__codelineno-99-23" name="__codelineno-99-23"></a>    <span class="n">age</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-99-24" name="__codelineno-99-24"></a>
<a id="__codelineno-99-25" name="__codelineno-99-25"></a><span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/users/&quot;</span><span class="p">,</span> <span class="n">response_model</span><span class="o">=</span><span class="n">User</span><span class="p">)</span>
<a id="__codelineno-99-26" name="__codelineno-99-26"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">create_user</span><span class="p">(</span><span class="n">user</span><span class="p">:</span> <span class="n">UserIn</span><span class="p">):</span>
<a id="__codelineno-99-27" name="__codelineno-99-27"></a>    <span class="n">user_doc</span> <span class="o">=</span> <span class="n">User</span><span class="p">(</span><span class="o">**</span><span class="n">user</span><span class="o">.</span><span class="n">dict</span><span class="p">())</span>
<a id="__codelineno-99-28" name="__codelineno-99-28"></a>    <span class="k">await</span> <span class="n">user_doc</span><span class="o">.</span><span class="n">insert</span><span class="p">()</span>
<a id="__codelineno-99-29" name="__codelineno-99-29"></a>    <span class="k">return</span> <span class="n">user_doc</span>
<a id="__codelineno-99-30" name="__codelineno-99-30"></a>
<a id="__codelineno-99-31" name="__codelineno-99-31"></a>
<a id="__codelineno-99-32" name="__codelineno-99-32"></a><span class="c1"># æŸ¥è¯¢ + åˆ†é¡µ + æ¨¡ç³ŠåŒ¹é…</span>
<a id="__codelineno-99-33" name="__codelineno-99-33"></a><span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/users/&quot;</span><span class="p">,</span> <span class="n">response_model</span><span class="o">=</span><span class="n">List</span><span class="p">[</span><span class="n">User</span><span class="p">])</span>
<a id="__codelineno-99-34" name="__codelineno-99-34"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">list_users</span><span class="p">(</span>
<a id="__codelineno-99-35" name="__codelineno-99-35"></a>    <span class="n">keyword</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">Query</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;æŒ‰å§“åæ¨¡ç³ŠåŒ¹é…&quot;</span><span class="p">),</span>
<a id="__codelineno-99-36" name="__codelineno-99-36"></a>    <span class="n">skip</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
<a id="__codelineno-99-37" name="__codelineno-99-37"></a>    <span class="n">limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span>
<a id="__codelineno-99-38" name="__codelineno-99-38"></a><span class="p">):</span>
<a id="__codelineno-99-39" name="__codelineno-99-39"></a>    <span class="n">query</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-99-40" name="__codelineno-99-40"></a>    <span class="k">if</span> <span class="n">keyword</span><span class="p">:</span>
<a id="__codelineno-99-41" name="__codelineno-99-41"></a>        <span class="n">query</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;$regex&quot;</span><span class="p">:</span> <span class="n">keyword</span><span class="p">,</span> <span class="s2">&quot;$options&quot;</span><span class="p">:</span> <span class="s2">&quot;i&quot;</span><span class="p">}</span>
<a id="__codelineno-99-42" name="__codelineno-99-42"></a>    <span class="n">users</span> <span class="o">=</span> <span class="k">await</span> <span class="n">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">query</span><span class="p">)</span><span class="o">.</span><span class="n">skip</span><span class="p">(</span><span class="n">skip</span><span class="p">)</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="n">limit</span><span class="p">)</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>
<a id="__codelineno-99-43" name="__codelineno-99-43"></a>    <span class="k">return</span> <span class="n">users</span>
<a id="__codelineno-99-44" name="__codelineno-99-44"></a>
<a id="__codelineno-99-45" name="__codelineno-99-45"></a>
<a id="__codelineno-99-46" name="__codelineno-99-46"></a><span class="c1"># å¯¼å‡ºä¸º CSV</span>
<a id="__codelineno-99-47" name="__codelineno-99-47"></a><span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/users/export/csv&quot;</span><span class="p">)</span>
<a id="__codelineno-99-48" name="__codelineno-99-48"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">export_users_csv</span><span class="p">():</span>
<a id="__codelineno-99-49" name="__codelineno-99-49"></a>    <span class="n">users</span> <span class="o">=</span> <span class="k">await</span> <span class="n">User</span><span class="o">.</span><span class="n">find_all</span><span class="p">()</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>
<a id="__codelineno-99-50" name="__codelineno-99-50"></a>    <span class="n">output</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">StringIO</span><span class="p">()</span>
<a id="__codelineno-99-51" name="__codelineno-99-51"></a>    <span class="n">writer</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">writer</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
<a id="__codelineno-99-52" name="__codelineno-99-52"></a>    <span class="n">writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">([</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;email&quot;</span><span class="p">,</span> <span class="s2">&quot;age&quot;</span><span class="p">])</span>
<a id="__codelineno-99-53" name="__codelineno-99-53"></a>    <span class="k">for</span> <span class="n">u</span> <span class="ow">in</span> <span class="n">users</span><span class="p">:</span>
<a id="__codelineno-99-54" name="__codelineno-99-54"></a>        <span class="n">writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">([</span><span class="n">u</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">u</span><span class="o">.</span><span class="n">email</span><span class="p">,</span> <span class="n">u</span><span class="o">.</span><span class="n">age</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">])</span>
<a id="__codelineno-99-55" name="__codelineno-99-55"></a>    <span class="n">output</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-99-56" name="__codelineno-99-56"></a>    <span class="k">return</span> <span class="n">StreamingResponse</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">media_type</span><span class="o">=</span><span class="s2">&quot;text/csv&quot;</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="p">{</span>
<a id="__codelineno-99-57" name="__codelineno-99-57"></a>        <span class="s2">&quot;Content-Disposition&quot;</span><span class="p">:</span> <span class="s2">&quot;attachment; filename=users.csv&quot;</span>
<a id="__codelineno-99-58" name="__codelineno-99-58"></a>    <span class="p">})</span>
</code></pre></div></td></tr></table></div>
<hr />
<p>âœ… 3. å¯¼å‡ºä¸º Excelï¼ˆå¯é€‰ï¼‰</p>
<p>å¦‚æœéœ€è¦æ”¯æŒå¯¼å‡ºä¸º <code>.xlsx</code>ï¼Œå¯ç”¨ <code>openpyxl</code>ï¼š</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-100-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-100-1" name="__codelineno-100-1"></a>pip<span class="w"> </span>install<span class="w"> </span>openpyxl
</code></pre></div></td></tr></table></div>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Python</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-101-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-101-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-101-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-101-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-101-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-101-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-101-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-101-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-101-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-101-10">10</a></span>
<span class="normal"><a href="#__codelineno-101-11">11</a></span>
<span class="normal"><a href="#__codelineno-101-12">12</a></span>
<span class="normal"><a href="#__codelineno-101-13">13</a></span>
<span class="normal"><a href="#__codelineno-101-14">14</a></span>
<span class="normal"><a href="#__codelineno-101-15">15</a></span>
<span class="normal"><a href="#__codelineno-101-16">16</a></span>
<span class="normal"><a href="#__codelineno-101-17">17</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-101-1" name="__codelineno-101-1"></a><span class="c1"># å¯¼å‡º Excel</span>
<a id="__codelineno-101-2" name="__codelineno-101-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">openpyxl</span><span class="w"> </span><span class="kn">import</span> <span class="n">Workbook</span>
<a id="__codelineno-101-3" name="__codelineno-101-3"></a>
<a id="__codelineno-101-4" name="__codelineno-101-4"></a><span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/users/export/excel&quot;</span><span class="p">)</span>
<a id="__codelineno-101-5" name="__codelineno-101-5"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">export_users_excel</span><span class="p">():</span>
<a id="__codelineno-101-6" name="__codelineno-101-6"></a>    <span class="n">users</span> <span class="o">=</span> <span class="k">await</span> <span class="n">User</span><span class="o">.</span><span class="n">find_all</span><span class="p">()</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>
<a id="__codelineno-101-7" name="__codelineno-101-7"></a>    <span class="n">wb</span> <span class="o">=</span> <span class="n">Workbook</span><span class="p">()</span>
<a id="__codelineno-101-8" name="__codelineno-101-8"></a>    <span class="n">ws</span> <span class="o">=</span> <span class="n">wb</span><span class="o">.</span><span class="n">active</span>
<a id="__codelineno-101-9" name="__codelineno-101-9"></a>    <span class="n">ws</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;email&quot;</span><span class="p">,</span> <span class="s2">&quot;age&quot;</span><span class="p">])</span>
<a id="__codelineno-101-10" name="__codelineno-101-10"></a>    <span class="k">for</span> <span class="n">u</span> <span class="ow">in</span> <span class="n">users</span><span class="p">:</span> 
<a id="__codelineno-101-11" name="__codelineno-101-11"></a>        <span class="n">ws</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">u</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">u</span><span class="o">.</span><span class="n">email</span><span class="p">,</span> <span class="n">u</span><span class="o">.</span><span class="n">age</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">])</span>
<a id="__codelineno-101-12" name="__codelineno-101-12"></a>    <span class="n">output</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">()</span>
<a id="__codelineno-101-13" name="__codelineno-101-13"></a>    <span class="n">wb</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
<a id="__codelineno-101-14" name="__codelineno-101-14"></a>    <span class="n">output</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-101-15" name="__codelineno-101-15"></a>    <span class="k">return</span> <span class="n">StreamingResponse</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">media_type</span><span class="o">=</span><span class="s2">&quot;application/vnd.openxmlformats-officedocument.spreadsheetml.sheet&quot;</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="p">{</span>
<a id="__codelineno-101-16" name="__codelineno-101-16"></a>        <span class="s2">&quot;Content-Disposition&quot;</span><span class="p">:</span> <span class="s2">&quot;attachment; filename=users.xlsx&quot;</span>
<a id="__codelineno-101-17" name="__codelineno-101-17"></a>    <span class="p">})</span>
</code></pre></div></td></tr></table></div>
<hr />
<h2 id="é›†æˆoauth2å®‰å…¨é‰´æƒ">é›†æˆOAuth2å®‰å…¨é‰´æƒ<a class="headerlink" href="#é›†æˆoauth2å®‰å…¨é‰´æƒ" title="Permanent link">&para;</a></h2>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Python</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-102-1">1</a></span>
<span class="normal"><a href="#__codelineno-102-2">2</a></span>
<span class="normal"><a href="#__codelineno-102-3">3</a></span>
<span class="normal"><a href="#__codelineno-102-4">4</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-102-1" name="__codelineno-102-1"></a><span class="n">pip</span> <span class="n">install</span> <span class="n">python</span><span class="o">-</span><span class="n">multipart</span> <span class="n">pyjwt</span> <span class="n">passlib</span><span class="p">[</span><span class="n">bcrypt</span><span class="p">]</span> <span class="n">fastapi</span> <span class="n">uvicorn</span>
<a id="__codelineno-102-2" name="__codelineno-102-2"></a><span class="c1"># å¦‚æœæ‚¨æ‰“ç®—ä½¿ç”¨ç±»ä¼¼ RSA æˆ– ECDSA çš„æ•°å­—ç­¾åç®—æ³•ï¼Œæ‚¨åº”è¯¥å®‰è£…åŠ å¯†åº“ä¾èµ–é¡¹ pyjwt[crypto]</span>
<a id="__codelineno-102-3" name="__codelineno-102-3"></a><span class="c1"># è¿™æ˜¯å› ä¸º OAuth2 ä½¿ç”¨è¡¨å•æ•°æ®å‘é€ username ä¸ passwordã€‚</span>
<a id="__codelineno-102-4" name="__codelineno-102-4"></a><span class="c1"># Passlib æ˜¯å¤„ç†å¯†ç å“ˆå¸Œçš„ Python åŒ…</span>
</code></pre></div></td></tr></table></div>
<p><font style="color:rgba(0, 0, 0, 0.87);">OAuth2çš„</font>ä½œç”¨åŸŸå’Œjwtä½¿ç”¨</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Python</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-103-1">  1</a></span>
<span class="normal"><a href="#__codelineno-103-2">  2</a></span>
<span class="normal"><a href="#__codelineno-103-3">  3</a></span>
<span class="normal"><a href="#__codelineno-103-4">  4</a></span>
<span class="normal"><a href="#__codelineno-103-5">  5</a></span>
<span class="normal"><a href="#__codelineno-103-6">  6</a></span>
<span class="normal"><a href="#__codelineno-103-7">  7</a></span>
<span class="normal"><a href="#__codelineno-103-8">  8</a></span>
<span class="normal"><a href="#__codelineno-103-9">  9</a></span>
<span class="normal"><a href="#__codelineno-103-10"> 10</a></span>
<span class="normal"><a href="#__codelineno-103-11"> 11</a></span>
<span class="normal"><a href="#__codelineno-103-12"> 12</a></span>
<span class="normal"><a href="#__codelineno-103-13"> 13</a></span>
<span class="normal"><a href="#__codelineno-103-14"> 14</a></span>
<span class="normal"><a href="#__codelineno-103-15"> 15</a></span>
<span class="normal"><a href="#__codelineno-103-16"> 16</a></span>
<span class="normal"><a href="#__codelineno-103-17"> 17</a></span>
<span class="normal"><a href="#__codelineno-103-18"> 18</a></span>
<span class="normal"><a href="#__codelineno-103-19"> 19</a></span>
<span class="normal"><a href="#__codelineno-103-20"> 20</a></span>
<span class="normal"><a href="#__codelineno-103-21"> 21</a></span>
<span class="normal"><a href="#__codelineno-103-22"> 22</a></span>
<span class="normal"><a href="#__codelineno-103-23"> 23</a></span>
<span class="normal"><a href="#__codelineno-103-24"> 24</a></span>
<span class="normal"><a href="#__codelineno-103-25"> 25</a></span>
<span class="normal"><a href="#__codelineno-103-26"> 26</a></span>
<span class="normal"><a href="#__codelineno-103-27"> 27</a></span>
<span class="normal"><a href="#__codelineno-103-28"> 28</a></span>
<span class="normal"><a href="#__codelineno-103-29"> 29</a></span>
<span class="normal"><a href="#__codelineno-103-30"> 30</a></span>
<span class="normal"><a href="#__codelineno-103-31"> 31</a></span>
<span class="normal"><a href="#__codelineno-103-32"> 32</a></span>
<span class="normal"><a href="#__codelineno-103-33"> 33</a></span>
<span class="normal"><a href="#__codelineno-103-34"> 34</a></span>
<span class="normal"><a href="#__codelineno-103-35"> 35</a></span>
<span class="normal"><a href="#__codelineno-103-36"> 36</a></span>
<span class="normal"><a href="#__codelineno-103-37"> 37</a></span>
<span class="normal"><a href="#__codelineno-103-38"> 38</a></span>
<span class="normal"><a href="#__codelineno-103-39"> 39</a></span>
<span class="normal"><a href="#__codelineno-103-40"> 40</a></span>
<span class="normal"><a href="#__codelineno-103-41"> 41</a></span>
<span class="normal"><a href="#__codelineno-103-42"> 42</a></span>
<span class="normal"><a href="#__codelineno-103-43"> 43</a></span>
<span class="normal"><a href="#__codelineno-103-44"> 44</a></span>
<span class="normal"><a href="#__codelineno-103-45"> 45</a></span>
<span class="normal"><a href="#__codelineno-103-46"> 46</a></span>
<span class="normal"><a href="#__codelineno-103-47"> 47</a></span>
<span class="normal"><a href="#__codelineno-103-48"> 48</a></span>
<span class="normal"><a href="#__codelineno-103-49"> 49</a></span>
<span class="normal"><a href="#__codelineno-103-50"> 50</a></span>
<span class="normal"><a href="#__codelineno-103-51"> 51</a></span>
<span class="normal"><a href="#__codelineno-103-52"> 52</a></span>
<span class="normal"><a href="#__codelineno-103-53"> 53</a></span>
<span class="normal"><a href="#__codelineno-103-54"> 54</a></span>
<span class="normal"><a href="#__codelineno-103-55"> 55</a></span>
<span class="normal"><a href="#__codelineno-103-56"> 56</a></span>
<span class="normal"><a href="#__codelineno-103-57"> 57</a></span>
<span class="normal"><a href="#__codelineno-103-58"> 58</a></span>
<span class="normal"><a href="#__codelineno-103-59"> 59</a></span>
<span class="normal"><a href="#__codelineno-103-60"> 60</a></span>
<span class="normal"><a href="#__codelineno-103-61"> 61</a></span>
<span class="normal"><a href="#__codelineno-103-62"> 62</a></span>
<span class="normal"><a href="#__codelineno-103-63"> 63</a></span>
<span class="normal"><a href="#__codelineno-103-64"> 64</a></span>
<span class="normal"><a href="#__codelineno-103-65"> 65</a></span>
<span class="normal"><a href="#__codelineno-103-66"> 66</a></span>
<span class="normal"><a href="#__codelineno-103-67"> 67</a></span>
<span class="normal"><a href="#__codelineno-103-68"> 68</a></span>
<span class="normal"><a href="#__codelineno-103-69"> 69</a></span>
<span class="normal"><a href="#__codelineno-103-70"> 70</a></span>
<span class="normal"><a href="#__codelineno-103-71"> 71</a></span>
<span class="normal"><a href="#__codelineno-103-72"> 72</a></span>
<span class="normal"><a href="#__codelineno-103-73"> 73</a></span>
<span class="normal"><a href="#__codelineno-103-74"> 74</a></span>
<span class="normal"><a href="#__codelineno-103-75"> 75</a></span>
<span class="normal"><a href="#__codelineno-103-76"> 76</a></span>
<span class="normal"><a href="#__codelineno-103-77"> 77</a></span>
<span class="normal"><a href="#__codelineno-103-78"> 78</a></span>
<span class="normal"><a href="#__codelineno-103-79"> 79</a></span>
<span class="normal"><a href="#__codelineno-103-80"> 80</a></span>
<span class="normal"><a href="#__codelineno-103-81"> 81</a></span>
<span class="normal"><a href="#__codelineno-103-82"> 82</a></span>
<span class="normal"><a href="#__codelineno-103-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-103-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-103-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-103-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-103-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-103-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-103-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-103-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-103-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-103-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-103-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-103-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-103-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-103-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-103-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-103-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-103-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-103-100">100</a></span>
<span class="normal"><a href="#__codelineno-103-101">101</a></span>
<span class="normal"><a href="#__codelineno-103-102">102</a></span>
<span class="normal"><a href="#__codelineno-103-103">103</a></span>
<span class="normal"><a href="#__codelineno-103-104">104</a></span>
<span class="normal"><a href="#__codelineno-103-105">105</a></span>
<span class="normal"><a href="#__codelineno-103-106">106</a></span>
<span class="normal"><a href="#__codelineno-103-107">107</a></span>
<span class="normal"><a href="#__codelineno-103-108">108</a></span>
<span class="normal"><a href="#__codelineno-103-109">109</a></span>
<span class="normal"><a href="#__codelineno-103-110">110</a></span>
<span class="normal"><a href="#__codelineno-103-111">111</a></span>
<span class="normal"><a href="#__codelineno-103-112">112</a></span>
<span class="normal"><a href="#__codelineno-103-113">113</a></span>
<span class="normal"><a href="#__codelineno-103-114">114</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-103-1" name="__codelineno-103-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">fastapi</span><span class="w"> </span><span class="kn">import</span> <span class="n">FastAPI</span><span class="p">,</span> <span class="n">Depends</span><span class="p">,</span> <span class="n">HTTPException</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">Security</span>
<a id="__codelineno-103-2" name="__codelineno-103-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">fastapi.security</span><span class="w"> </span><span class="kn">import</span> <span class="n">OAuth2PasswordBearer</span><span class="p">,</span> <span class="n">OAuth2PasswordRequestForm</span><span class="p">,</span> <span class="n">SecurityScopes</span>
<a id="__codelineno-103-3" name="__codelineno-103-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">jose</span><span class="w"> </span><span class="kn">import</span> <span class="n">JWTError</span><span class="p">,</span> <span class="n">jwt</span>
<a id="__codelineno-103-4" name="__codelineno-103-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">pydantic</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseModel</span>
<a id="__codelineno-103-5" name="__codelineno-103-5"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">List</span>
<a id="__codelineno-103-6" name="__codelineno-103-6"></a><span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>
<a id="__codelineno-103-7" name="__codelineno-103-7"></a>
<a id="__codelineno-103-8" name="__codelineno-103-8"></a><span class="c1"># å¯†é’¥é…ç½®</span>
<a id="__codelineno-103-9" name="__codelineno-103-9"></a><span class="n">SECRET_KEY</span> <span class="o">=</span> <span class="s2">&quot;super-secret&quot;</span>  <span class="c1"># ç”¨äºå¯¹ JWT ä»¤ç‰Œè¿›è¡ŒåŠ å¯†å’Œè§£å¯†çš„å¯†é’¥ï¼Œå¿…é¡»ä¿å¯†ï¼Œå»ºè®®è®¾ç½®ä¸ºç¯å¢ƒå˜é‡</span>
<a id="__codelineno-103-10" name="__codelineno-103-10"></a><span class="n">ALGORITHM</span> <span class="o">=</span> <span class="s2">&quot;HS256&quot;</span>          <span class="c1"># ä½¿ç”¨çš„åŠ å¯†ç®—æ³•ï¼Œè¿™é‡Œä½¿ç”¨ HMAC-SHA256ï¼ŒFastAPI + JWT é»˜è®¤æ¨èè¯¥ç®—æ³•</span>
<a id="__codelineno-103-11" name="__codelineno-103-11"></a><span class="n">ACCESS_TOKEN_EXPIRE_MINUTES</span> <span class="o">=</span> <span class="mi">30</span>  <span class="c1"># è®¾ç½®è®¿é—®ä»¤ç‰Œï¼ˆaccess tokenï¼‰çš„æœ‰æ•ˆæœŸä¸º 30 åˆ†é’Ÿï¼Œè¿‡æœŸåéœ€é‡æ–°ç™»å½•</span>
<a id="__codelineno-103-12" name="__codelineno-103-12"></a>
<a id="__codelineno-103-13" name="__codelineno-103-13"></a><span class="c1"># OAuth2 å®šä¹‰å¤šä¸ª scopes</span>
<a id="__codelineno-103-14" name="__codelineno-103-14"></a><span class="n">oauth2_scheme</span> <span class="o">=</span> <span class="n">OAuth2PasswordBearer</span><span class="p">(</span>
<a id="__codelineno-103-15" name="__codelineno-103-15"></a>    <span class="n">tokenUrl</span><span class="o">=</span><span class="s2">&quot;token&quot;</span><span class="p">,</span>
<a id="__codelineno-103-16" name="__codelineno-103-16"></a>    <span class="n">scopes</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;read&quot;</span><span class="p">:</span> <span class="s2">&quot;è¯»å–æƒé™&quot;</span><span class="p">,</span> <span class="s2">&quot;write&quot;</span><span class="p">:</span> <span class="s2">&quot;å†™å…¥æƒé™&quot;</span><span class="p">,</span> <span class="s2">&quot;admin&quot;</span><span class="p">:</span> <span class="s2">&quot;ç®¡ç†å‘˜æƒé™&quot;</span><span class="p">},</span>
<a id="__codelineno-103-17" name="__codelineno-103-17"></a><span class="p">)</span>
<a id="__codelineno-103-18" name="__codelineno-103-18"></a>
<a id="__codelineno-103-19" name="__codelineno-103-19"></a><span class="c1"># æ¨¡æ‹Ÿç”¨æˆ·æ•°æ®</span>
<a id="__codelineno-103-20" name="__codelineno-103-20"></a><span class="n">fake_users_db</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-103-21" name="__codelineno-103-21"></a>    <span class="s2">&quot;alice&quot;</span><span class="p">:</span> <span class="p">{</span>
<a id="__codelineno-103-22" name="__codelineno-103-22"></a>        <span class="s2">&quot;username&quot;</span><span class="p">:</span> <span class="s2">&quot;alice&quot;</span><span class="p">,</span>
<a id="__codelineno-103-23" name="__codelineno-103-23"></a>        <span class="s2">&quot;hashed_password&quot;</span><span class="p">:</span> <span class="s2">&quot;$2b$12$7qA1xbsMTLtH3W6rsH33QOnfpxn1qP1B9xuJzW2GH77j3tZddLaZu&quot;</span><span class="p">,</span>  <span class="c1"># password</span>
<a id="__codelineno-103-24" name="__codelineno-103-24"></a>        <span class="s2">&quot;scopes&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;read&quot;</span><span class="p">],</span>
<a id="__codelineno-103-25" name="__codelineno-103-25"></a>    <span class="p">},</span>
<a id="__codelineno-103-26" name="__codelineno-103-26"></a>    <span class="s2">&quot;bob&quot;</span><span class="p">:</span> <span class="p">{</span>
<a id="__codelineno-103-27" name="__codelineno-103-27"></a>        <span class="s2">&quot;username&quot;</span><span class="p">:</span> <span class="s2">&quot;bob&quot;</span><span class="p">,</span>
<a id="__codelineno-103-28" name="__codelineno-103-28"></a>        <span class="s2">&quot;hashed_password&quot;</span><span class="p">:</span> <span class="s2">&quot;$2b$12$7qA1xbsMTLtH3W6rsH33QOnfpxn1qP1B9xuJzW2GH77j3tZddLaZu&quot;</span><span class="p">,</span>  <span class="c1"># password</span>
<a id="__codelineno-103-29" name="__codelineno-103-29"></a>        <span class="s2">&quot;scopes&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;read&quot;</span><span class="p">,</span> <span class="s2">&quot;write&quot;</span><span class="p">,</span> <span class="s2">&quot;admin&quot;</span><span class="p">],</span>
<a id="__codelineno-103-30" name="__codelineno-103-30"></a>    <span class="p">}</span>
<a id="__codelineno-103-31" name="__codelineno-103-31"></a><span class="p">}</span>
<a id="__codelineno-103-32" name="__codelineno-103-32"></a>
<a id="__codelineno-103-33" name="__codelineno-103-33"></a><span class="k">class</span><span class="w"> </span><span class="nc">TokenData</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
<a id="__codelineno-103-34" name="__codelineno-103-34"></a>    <span class="n">username</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-103-35" name="__codelineno-103-35"></a>    <span class="n">scopes</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-103-36" name="__codelineno-103-36"></a>
<a id="__codelineno-103-37" name="__codelineno-103-37"></a><span class="k">class</span><span class="w"> </span><span class="nc">User</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
<a id="__codelineno-103-38" name="__codelineno-103-38"></a>    <span class="n">username</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-103-39" name="__codelineno-103-39"></a>    <span class="n">scopes</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-103-40" name="__codelineno-103-40"></a>
<a id="__codelineno-103-41" name="__codelineno-103-41"></a><span class="c1"># åˆ›å»º token</span>
<a id="__codelineno-103-42" name="__codelineno-103-42"></a><span class="k">def</span><span class="w"> </span><span class="nf">create_access_token</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">expires_delta</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">timedelta</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<a id="__codelineno-103-43" name="__codelineno-103-43"></a>    <span class="n">to_encode</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<a id="__codelineno-103-44" name="__codelineno-103-44"></a>    <span class="n">expire</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span> <span class="o">+</span> <span class="p">(</span><span class="n">expires_delta</span> <span class="ow">or</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="mi">15</span><span class="p">))</span>
<a id="__codelineno-103-45" name="__codelineno-103-45"></a>    <span class="n">to_encode</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;exp&quot;</span><span class="p">:</span> <span class="n">expire</span><span class="p">})</span>
<a id="__codelineno-103-46" name="__codelineno-103-46"></a>    <span class="n">encoded_jwt</span> <span class="o">=</span> <span class="n">jwt</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">to_encode</span><span class="p">,</span> <span class="n">SECRET_KEY</span><span class="p">,</span> <span class="n">algorithm</span><span class="o">=</span><span class="n">ALGORITHM</span><span class="p">)</span>
<a id="__codelineno-103-47" name="__codelineno-103-47"></a>    <span class="k">return</span> <span class="n">encoded_jwt</span>
<a id="__codelineno-103-48" name="__codelineno-103-48"></a>
<a id="__codelineno-103-49" name="__codelineno-103-49"></a><span class="c1"># è·å–ç”¨æˆ·</span>
<a id="__codelineno-103-50" name="__codelineno-103-50"></a><span class="k">def</span><span class="w"> </span><span class="nf">get_user</span><span class="p">(</span><span class="n">username</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">User</span><span class="p">]:</span>
<a id="__codelineno-103-51" name="__codelineno-103-51"></a>    <span class="n">user</span> <span class="o">=</span> <span class="n">fake_users_db</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">username</span><span class="p">)</span>
<a id="__codelineno-103-52" name="__codelineno-103-52"></a>    <span class="k">if</span> <span class="n">user</span><span class="p">:</span>
<a id="__codelineno-103-53" name="__codelineno-103-53"></a>        <span class="k">return</span> <span class="n">User</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="n">user</span><span class="p">[</span><span class="s2">&quot;username&quot;</span><span class="p">],</span> <span class="n">scopes</span><span class="o">=</span><span class="n">user</span><span class="p">[</span><span class="s2">&quot;scopes&quot;</span><span class="p">])</span>
<a id="__codelineno-103-54" name="__codelineno-103-54"></a>
<a id="__codelineno-103-55" name="__codelineno-103-55"></a><span class="c1"># è·å–å½“å‰ç”¨æˆ·å¹¶éªŒè¯ scope</span>
<a id="__codelineno-103-56" name="__codelineno-103-56"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_current_user</span><span class="p">(</span>
<a id="__codelineno-103-57" name="__codelineno-103-57"></a>    <span class="n">security_scopes</span><span class="p">:</span> <span class="n">SecurityScopes</span><span class="p">,</span>
<a id="__codelineno-103-58" name="__codelineno-103-58"></a>    <span class="n">token</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">oauth2_scheme</span><span class="p">),</span>
<a id="__codelineno-103-59" name="__codelineno-103-59"></a><span class="p">):</span>
<a id="__codelineno-103-60" name="__codelineno-103-60"></a>    <span class="n">credentials_exception</span> <span class="o">=</span> <span class="n">HTTPException</span><span class="p">(</span>
<a id="__codelineno-103-61" name="__codelineno-103-61"></a>        <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_401_UNAUTHORIZED</span><span class="p">,</span>
<a id="__codelineno-103-62" name="__codelineno-103-62"></a>        <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;æƒé™ä¸è¶³æˆ–è®¤è¯å¤±è´¥&quot;</span><span class="p">,</span>
<a id="__codelineno-103-63" name="__codelineno-103-63"></a>        <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;WWW-Authenticate&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;Bearer scope=&quot;</span><span class="si">{</span><span class="n">security_scopes</span><span class="o">.</span><span class="n">scope_str</span><span class="si">}</span><span class="s1">&quot;&#39;</span><span class="p">},</span>
<a id="__codelineno-103-64" name="__codelineno-103-64"></a>    <span class="p">)</span>
<a id="__codelineno-103-65" name="__codelineno-103-65"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-103-66" name="__codelineno-103-66"></a>        <span class="n">payload</span> <span class="o">=</span> <span class="n">jwt</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">SECRET_KEY</span><span class="p">,</span> <span class="n">algorithms</span><span class="o">=</span><span class="p">[</span><span class="n">ALGORITHM</span><span class="p">])</span>
<a id="__codelineno-103-67" name="__codelineno-103-67"></a>        <span class="n">username</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">payload</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;sub&quot;</span><span class="p">)</span>
<a id="__codelineno-103-68" name="__codelineno-103-68"></a>        <span class="n">token_scopes</span> <span class="o">=</span> <span class="n">payload</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;scopes&quot;</span><span class="p">,</span> <span class="p">[])</span>
<a id="__codelineno-103-69" name="__codelineno-103-69"></a>        <span class="k">if</span> <span class="n">username</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-103-70" name="__codelineno-103-70"></a>            <span class="k">raise</span> <span class="n">credentials_exception</span>
<a id="__codelineno-103-71" name="__codelineno-103-71"></a>        <span class="n">token_data</span> <span class="o">=</span> <span class="n">TokenData</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="n">username</span><span class="p">,</span> <span class="n">scopes</span><span class="o">=</span><span class="n">token_scopes</span><span class="p">)</span>
<a id="__codelineno-103-72" name="__codelineno-103-72"></a>    <span class="k">except</span> <span class="n">JWTError</span><span class="p">:</span>
<a id="__codelineno-103-73" name="__codelineno-103-73"></a>        <span class="k">raise</span> <span class="n">credentials_exception</span>
<a id="__codelineno-103-74" name="__codelineno-103-74"></a>
<a id="__codelineno-103-75" name="__codelineno-103-75"></a>    <span class="n">user</span> <span class="o">=</span> <span class="n">get_user</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="n">token_data</span><span class="o">.</span><span class="n">username</span><span class="p">)</span>
<a id="__codelineno-103-76" name="__codelineno-103-76"></a>    <span class="k">if</span> <span class="n">user</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-103-77" name="__codelineno-103-77"></a>        <span class="k">raise</span> <span class="n">credentials_exception</span>
<a id="__codelineno-103-78" name="__codelineno-103-78"></a>
<a id="__codelineno-103-79" name="__codelineno-103-79"></a>    <span class="k">for</span> <span class="n">scope</span> <span class="ow">in</span> <span class="n">security_scopes</span><span class="o">.</span><span class="n">scopes</span><span class="p">:</span>
<a id="__codelineno-103-80" name="__codelineno-103-80"></a>        <span class="k">if</span> <span class="n">scope</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">token_data</span><span class="o">.</span><span class="n">scopes</span><span class="p">:</span>
<a id="__codelineno-103-81" name="__codelineno-103-81"></a>            <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span>
<a id="__codelineno-103-82" name="__codelineno-103-82"></a>                <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_403_FORBIDDEN</span><span class="p">,</span>
<a id="__codelineno-103-83" name="__codelineno-103-83"></a>                <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;æƒé™ä¸è¶³&quot;</span><span class="p">,</span>
<a id="__codelineno-103-84" name="__codelineno-103-84"></a>                <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;WWW-Authenticate&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;Bearer scope=&quot;</span><span class="si">{</span><span class="n">security_scopes</span><span class="o">.</span><span class="n">scope_str</span><span class="si">}</span><span class="s1">&quot;&#39;</span><span class="p">},</span>
<a id="__codelineno-103-85" name="__codelineno-103-85"></a>            <span class="p">)</span>
<a id="__codelineno-103-86" name="__codelineno-103-86"></a>
<a id="__codelineno-103-87" name="__codelineno-103-87"></a>    <span class="k">return</span> <span class="n">user</span>
<a id="__codelineno-103-88" name="__codelineno-103-88"></a>
<a id="__codelineno-103-89" name="__codelineno-103-89"></a>
<a id="__codelineno-103-90" name="__codelineno-103-90"></a><span class="n">app</span> <span class="o">=</span> <span class="n">FastAPI</span><span class="p">()</span>
<a id="__codelineno-103-91" name="__codelineno-103-91"></a>
<a id="__codelineno-103-92" name="__codelineno-103-92"></a>
<a id="__codelineno-103-93" name="__codelineno-103-93"></a><span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/token&quot;</span><span class="p">)</span>
<a id="__codelineno-103-94" name="__codelineno-103-94"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">login</span><span class="p">(</span><span class="n">form_data</span><span class="p">:</span> <span class="n">OAuth2PasswordRequestForm</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">()):</span>
<a id="__codelineno-103-95" name="__codelineno-103-95"></a>    <span class="n">user_dict</span> <span class="o">=</span> <span class="n">fake_users_db</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">form_data</span><span class="o">.</span><span class="n">username</span><span class="p">)</span>
<a id="__codelineno-103-96" name="__codelineno-103-96"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">user_dict</span> <span class="ow">or</span> <span class="n">form_data</span><span class="o">.</span><span class="n">password</span> <span class="o">!=</span> <span class="s2">&quot;password&quot;</span><span class="p">:</span>
<a id="__codelineno-103-97" name="__codelineno-103-97"></a>        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;ç™»å½•å¤±è´¥&quot;</span><span class="p">)</span>
<a id="__codelineno-103-98" name="__codelineno-103-98"></a>    <span class="n">token</span> <span class="o">=</span> <span class="n">create_access_token</span><span class="p">(</span>
<a id="__codelineno-103-99" name="__codelineno-103-99"></a>        <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;sub&quot;</span><span class="p">:</span> <span class="n">form_data</span><span class="o">.</span><span class="n">username</span><span class="p">,</span> <span class="s2">&quot;scopes&quot;</span><span class="p">:</span> <span class="n">user_dict</span><span class="p">[</span><span class="s2">&quot;scopes&quot;</span><span class="p">]}</span>
<a id="__codelineno-103-100" name="__codelineno-103-100"></a>    <span class="p">)</span>
<a id="__codelineno-103-101" name="__codelineno-103-101"></a>    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;access_token&quot;</span><span class="p">:</span> <span class="n">token</span><span class="p">,</span> <span class="s2">&quot;token_type&quot;</span><span class="p">:</span> <span class="s2">&quot;bearer&quot;</span><span class="p">}</span>
<a id="__codelineno-103-102" name="__codelineno-103-102"></a>
<a id="__codelineno-103-103" name="__codelineno-103-103"></a>
<a id="__codelineno-103-104" name="__codelineno-103-104"></a><span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/read&quot;</span><span class="p">,</span> <span class="n">dependencies</span><span class="o">=</span><span class="p">[</span><span class="n">Security</span><span class="p">(</span><span class="n">get_current_user</span><span class="p">,</span> <span class="n">scopes</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;read&quot;</span><span class="p">])])</span>
<a id="__codelineno-103-105" name="__codelineno-103-105"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">read_data</span><span class="p">():</span>
<a id="__codelineno-103-106" name="__codelineno-103-106"></a>    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="s2">&quot;è¿™æ˜¯åªè¯»æ•°æ®&quot;</span><span class="p">}</span>
<a id="__codelineno-103-107" name="__codelineno-103-107"></a>
<a id="__codelineno-103-108" name="__codelineno-103-108"></a><span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/write&quot;</span><span class="p">,</span> <span class="n">dependencies</span><span class="o">=</span><span class="p">[</span><span class="n">Security</span><span class="p">(</span><span class="n">get_current_user</span><span class="p">,</span> <span class="n">scopes</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;write&quot;</span><span class="p">])])</span>
<a id="__codelineno-103-109" name="__codelineno-103-109"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">write_data</span><span class="p">():</span>
<a id="__codelineno-103-110" name="__codelineno-103-110"></a>    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;å†™å…¥æˆåŠŸ&quot;</span><span class="p">}</span>
<a id="__codelineno-103-111" name="__codelineno-103-111"></a>
<a id="__codelineno-103-112" name="__codelineno-103-112"></a><span class="nd">@app</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="s2">&quot;/admin&quot;</span><span class="p">,</span> <span class="n">dependencies</span><span class="o">=</span><span class="p">[</span><span class="n">Security</span><span class="p">(</span><span class="n">get_current_user</span><span class="p">,</span> <span class="n">scopes</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;admin&quot;</span><span class="p">])])</span>
<a id="__codelineno-103-113" name="__codelineno-103-113"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">admin_delete</span><span class="p">():</span>
<a id="__codelineno-103-114" name="__codelineno-103-114"></a>    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;ç®¡ç†å‘˜åˆ é™¤æˆåŠŸ&quot;</span><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<h2 id="http-basic-è®¤è¯ç¤ºä¾‹">HTTP Basic è®¤è¯ç¤ºä¾‹<a class="headerlink" href="#http-basic-è®¤è¯ç¤ºä¾‹" title="Permanent link">&para;</a></h2>
<p>FastAPI æä¾›äº†å¯¹ HTTP åŸºæœ¬è®¤è¯ï¼ˆHTTP Basic Authï¼‰çš„å†…ç½®æ”¯æŒï¼Œé€‚ç”¨äºç®€å•çš„èº«ä»½éªŒè¯åœºæ™¯ã€‚ä»¥ä¸‹æ˜¯ä¸€ä¸ªå®Œæ•´çš„ç¤ºä¾‹ï¼Œå±•ç¤ºå¦‚ä½•ä½¿ç”¨ FastAPI å®ç° HTTP Basic è®¤è¯ï¼Œå¹¶éªŒè¯ç”¨æˆ·åå’Œå¯†ç   </p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Python</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-104-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-104-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-104-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-104-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-104-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-104-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-104-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-104-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-104-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-104-10">10</a></span>
<span class="normal"><a href="#__codelineno-104-11">11</a></span>
<span class="normal"><a href="#__codelineno-104-12">12</a></span>
<span class="normal"><a href="#__codelineno-104-13">13</a></span>
<span class="normal"><a href="#__codelineno-104-14">14</a></span>
<span class="normal"><a href="#__codelineno-104-15">15</a></span>
<span class="normal"><a href="#__codelineno-104-16">16</a></span>
<span class="normal"><a href="#__codelineno-104-17">17</a></span>
<span class="normal"><a href="#__codelineno-104-18">18</a></span>
<span class="normal"><a href="#__codelineno-104-19">19</a></span>
<span class="normal"><a href="#__codelineno-104-20">20</a></span>
<span class="normal"><a href="#__codelineno-104-21">21</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-104-1" name="__codelineno-104-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">fastapi</span><span class="w"> </span><span class="kn">import</span> <span class="n">FastAPI</span><span class="p">,</span> <span class="n">Depends</span><span class="p">,</span> <span class="n">HTTPException</span><span class="p">,</span> <span class="n">status</span>
<a id="__codelineno-104-2" name="__codelineno-104-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">fastapi.security</span><span class="w"> </span><span class="kn">import</span> <span class="n">HTTPBasic</span><span class="p">,</span> <span class="n">HTTPBasicCredentials</span>
<a id="__codelineno-104-3" name="__codelineno-104-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">secrets</span>
<a id="__codelineno-104-4" name="__codelineno-104-4"></a>
<a id="__codelineno-104-5" name="__codelineno-104-5"></a><span class="n">app</span> <span class="o">=</span> <span class="n">FastAPI</span><span class="p">()</span>
<a id="__codelineno-104-6" name="__codelineno-104-6"></a><span class="n">security</span> <span class="o">=</span> <span class="n">HTTPBasic</span><span class="p">()</span>
<a id="__codelineno-104-7" name="__codelineno-104-7"></a>
<a id="__codelineno-104-8" name="__codelineno-104-8"></a><span class="k">def</span><span class="w"> </span><span class="nf">get_current_username</span><span class="p">(</span><span class="n">credentials</span><span class="p">:</span> <span class="n">HTTPBasicCredentials</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">security</span><span class="p">)):</span>
<a id="__codelineno-104-9" name="__codelineno-104-9"></a>    <span class="n">correct_username</span> <span class="o">=</span> <span class="n">secrets</span><span class="o">.</span><span class="n">compare_digest</span><span class="p">(</span><span class="n">credentials</span><span class="o">.</span><span class="n">username</span><span class="p">,</span> <span class="s2">&quot;alice&quot;</span><span class="p">)</span>
<a id="__codelineno-104-10" name="__codelineno-104-10"></a>    <span class="n">correct_password</span> <span class="o">=</span> <span class="n">secrets</span><span class="o">.</span><span class="n">compare_digest</span><span class="p">(</span><span class="n">credentials</span><span class="o">.</span><span class="n">password</span><span class="p">,</span> <span class="s2">&quot;wonderland&quot;</span><span class="p">)</span>
<a id="__codelineno-104-11" name="__codelineno-104-11"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">correct_username</span> <span class="ow">and</span> <span class="n">correct_password</span><span class="p">):</span>
<a id="__codelineno-104-12" name="__codelineno-104-12"></a>        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span>
<a id="__codelineno-104-13" name="__codelineno-104-13"></a>            <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_401_UNAUTHORIZED</span><span class="p">,</span>
<a id="__codelineno-104-14" name="__codelineno-104-14"></a>            <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯&quot;</span><span class="p">,</span>
<a id="__codelineno-104-15" name="__codelineno-104-15"></a>            <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;WWW-Authenticate&quot;</span><span class="p">:</span> <span class="s2">&quot;Basic&quot;</span><span class="p">},</span>
<a id="__codelineno-104-16" name="__codelineno-104-16"></a>        <span class="p">)</span>
<a id="__codelineno-104-17" name="__codelineno-104-17"></a>    <span class="k">return</span> <span class="n">credentials</span><span class="o">.</span><span class="n">username</span>
<a id="__codelineno-104-18" name="__codelineno-104-18"></a>
<a id="__codelineno-104-19" name="__codelineno-104-19"></a><span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/users/me&quot;</span><span class="p">)</span>
<a id="__codelineno-104-20" name="__codelineno-104-20"></a><span class="k">def</span><span class="w"> </span><span class="nf">read_current_user</span><span class="p">(</span><span class="n">username</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_current_username</span><span class="p">)):</span>
<a id="__codelineno-104-21" name="__codelineno-104-21"></a>    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;username&quot;</span><span class="p">:</span> <span class="n">username</span><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>æµ‹è¯•</p>
<ul>
<li>å½“æ‚¨åœ¨æµè§ˆå™¨ä¸­è®¿é—®å—ä¿æŠ¤çš„ç«¯ç‚¹ï¼ˆä¾‹å¦‚ <code>/users/me</code>ï¼‰æ—¶ï¼Œæµè§ˆå™¨ä¼šå¼¹å‡ºä¸€ä¸ªå¯¹è¯æ¡†ï¼Œæç¤ºæ‚¨è¾“å…¥ç”¨æˆ·åå’Œå¯†ç ã€‚</li>
<li>è¾“å…¥æ­£ç¡®çš„å‡­æ®åï¼Œæµè§ˆå™¨ä¼šè‡ªåŠ¨å°†å…¶ç¼–ç ä¸º Base64ï¼Œå¹¶æ·»åŠ åˆ°è¯·æ±‚çš„ <code>Authorization</code> å¤´éƒ¨ä¸­ã€‚</li>
</ul>
<p>ä½¿ç”¨curlå·¥å…·è¿›è¡Œæµ‹è¯•</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-105-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-105-1" name="__codelineno-105-1"></a>curl<span class="w"> </span>-u<span class="w"> </span>alice:wonderland<span class="w"> </span>http://localhost:8000/users/me
</code></pre></div></td></tr></table></div>
<p>ä½¿ç”¨ FastAPI çš„ <code>TestClient</code> è¿›è¡Œè‡ªåŠ¨åŒ–æµ‹è¯•  </p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-106-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-106-1" name="__codelineno-106-1"></a>pip<span class="w"> </span>install<span class="w"> </span>httpx
</code></pre></div></td></tr></table></div>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Python</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-107-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-107-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-107-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-107-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-107-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-107-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-107-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-107-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-107-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-107-10">10</a></span>
<span class="normal"><a href="#__codelineno-107-11">11</a></span>
<span class="normal"><a href="#__codelineno-107-12">12</a></span>
<span class="normal"><a href="#__codelineno-107-13">13</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-107-1" name="__codelineno-107-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">fastapi.testclient</span><span class="w"> </span><span class="kn">import</span> <span class="n">TestClient</span>
<a id="__codelineno-107-2" name="__codelineno-107-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">myapp</span><span class="w"> </span><span class="kn">import</span> <span class="n">app</span>  <span class="c1"># æ›¿æ¢ä¸ºæ‚¨çš„ FastAPI åº”ç”¨å®ä¾‹</span>
<a id="__codelineno-107-3" name="__codelineno-107-3"></a>
<a id="__codelineno-107-4" name="__codelineno-107-4"></a><span class="n">client</span> <span class="o">=</span> <span class="n">TestClient</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
<a id="__codelineno-107-5" name="__codelineno-107-5"></a>
<a id="__codelineno-107-6" name="__codelineno-107-6"></a><span class="k">def</span><span class="w"> </span><span class="nf">test_read_current_user</span><span class="p">():</span>
<a id="__codelineno-107-7" name="__codelineno-107-7"></a>    <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/users/me&quot;</span><span class="p">,</span> <span class="n">auth</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;alice&quot;</span><span class="p">,</span> <span class="s2">&quot;wonderland&quot;</span><span class="p">))</span>
<a id="__codelineno-107-8" name="__codelineno-107-8"></a>    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span>
<a id="__codelineno-107-9" name="__codelineno-107-9"></a>    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span> <span class="o">==</span> <span class="p">{</span><span class="s2">&quot;username&quot;</span><span class="p">:</span> <span class="s2">&quot;alice&quot;</span><span class="p">}</span>
<a id="__codelineno-107-10" name="__codelineno-107-10"></a>
<a id="__codelineno-107-11" name="__codelineno-107-11"></a><span class="k">def</span><span class="w"> </span><span class="nf">test_read_current_user_invalid_credentials</span><span class="p">():</span>
<a id="__codelineno-107-12" name="__codelineno-107-12"></a>    <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/users/me&quot;</span><span class="p">,</span> <span class="n">auth</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;alice&quot;</span><span class="p">,</span> <span class="s2">&quot;wrongpassword&quot;</span><span class="p">))</span>
<a id="__codelineno-107-13" name="__codelineno-107-13"></a>    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">401</span>
</code></pre></div></td></tr></table></div>
<h2 id="websocketèŠå¤©å®¤">WebSocketèŠå¤©å®¤<a class="headerlink" href="#websocketèŠå¤©å®¤" title="Permanent link">&para;</a></h2>
<p>é¡ºä¾¿å­¦ä¹ ä¸‹uvç®¡ç†</p>
<p><font style="color:#080808;background-color:#ffffff;">pyproject.toml</font></p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">TOML</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-108-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-108-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-108-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-108-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-108-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-108-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-108-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-108-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-108-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-108-10">10</a></span>
<span class="normal"><a href="#__codelineno-108-11">11</a></span>
<span class="normal"><a href="#__codelineno-108-12">12</a></span>
<span class="normal"><a href="#__codelineno-108-13">13</a></span>
<span class="normal"><a href="#__codelineno-108-14">14</a></span>
<span class="normal"><a href="#__codelineno-108-15">15</a></span>
<span class="normal"><a href="#__codelineno-108-16">16</a></span>
<span class="normal"><a href="#__codelineno-108-17">17</a></span>
<span class="normal"><a href="#__codelineno-108-18">18</a></span>
<span class="normal"><a href="#__codelineno-108-19">19</a></span>
<span class="normal"><a href="#__codelineno-108-20">20</a></span>
<span class="normal"><a href="#__codelineno-108-21">21</a></span>
<span class="normal"><a href="#__codelineno-108-22">22</a></span>
<span class="normal"><a href="#__codelineno-108-23">23</a></span>
<span class="normal"><a href="#__codelineno-108-24">24</a></span>
<span class="normal"><a href="#__codelineno-108-25">25</a></span>
<span class="normal"><a href="#__codelineno-108-26">26</a></span>
<span class="normal"><a href="#__codelineno-108-27">27</a></span>
<span class="normal"><a href="#__codelineno-108-28">28</a></span>
<span class="normal"><a href="#__codelineno-108-29">29</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-108-1" name="__codelineno-108-1"></a><span class="c1"># pyproject.toml</span>
<a id="__codelineno-108-2" name="__codelineno-108-2"></a><span class="k">[project]</span>
<a id="__codelineno-108-3" name="__codelineno-108-3"></a><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;fastapi_websockets&quot;</span>
<a id="__codelineno-108-4" name="__codelineno-108-4"></a><span class="n">version</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;0.1.0&quot;</span>
<a id="__codelineno-108-5" name="__codelineno-108-5"></a><span class="n">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Project description&quot;</span>
<a id="__codelineno-108-6" name="__codelineno-108-6"></a><span class="n">requires-python</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;&gt;=3.11&quot;</span>
<a id="__codelineno-108-7" name="__codelineno-108-7"></a><span class="n">dependencies</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span>
<a id="__codelineno-108-8" name="__codelineno-108-8"></a><span class="w">    </span><span class="s2">&quot;anyio&gt;=4.9.0&quot;</span><span class="p">,</span>
<a id="__codelineno-108-9" name="__codelineno-108-9"></a><span class="w">    </span><span class="s2">&quot;fastapi&gt;=0.115.12&quot;</span><span class="p">,</span>
<a id="__codelineno-108-10" name="__codelineno-108-10"></a><span class="w">    </span><span class="s2">&quot;httpx&gt;=0.28.1&quot;</span><span class="p">,</span>
<a id="__codelineno-108-11" name="__codelineno-108-11"></a><span class="w">    </span><span class="s2">&quot;pytest&gt;=8.3.5&quot;</span><span class="p">,</span>
<a id="__codelineno-108-12" name="__codelineno-108-12"></a><span class="w">    </span><span class="s2">&quot;trio&gt;=0.30.0&quot;</span><span class="p">,</span>
<a id="__codelineno-108-13" name="__codelineno-108-13"></a><span class="w">    </span><span class="s2">&quot;uvicorn&gt;=0.34.2&quot;</span><span class="p">,</span>
<a id="__codelineno-108-14" name="__codelineno-108-14"></a><span class="w">    </span><span class="s2">&quot;websockets&gt;=15.0.1&quot;</span><span class="p">,</span>
<a id="__codelineno-108-15" name="__codelineno-108-15"></a><span class="p">]</span>
<a id="__codelineno-108-16" name="__codelineno-108-16"></a>
<a id="__codelineno-108-17" name="__codelineno-108-17"></a><span class="k">[project.optional-dependencies]</span>
<a id="__codelineno-108-18" name="__codelineno-108-18"></a><span class="n">dev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span>
<a id="__codelineno-108-19" name="__codelineno-108-19"></a>
<a id="__codelineno-108-20" name="__codelineno-108-20"></a><span class="p">]</span>
<a id="__codelineno-108-21" name="__codelineno-108-21"></a><span class="c1"># ä¸‹è½½æºé…ç½® uv sync</span>
<a id="__codelineno-108-22" name="__codelineno-108-22"></a><span class="k">[[tool.uv.index]]</span>
<a id="__codelineno-108-23" name="__codelineno-108-23"></a><span class="c1">#[[index]]è¿™ä¸ªä¹Ÿå¯ä»¥</span>
<a id="__codelineno-108-24" name="__codelineno-108-24"></a><span class="c1"># é»˜è®¤æº</span>
<a id="__codelineno-108-25" name="__codelineno-108-25"></a><span class="n">url</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;https://pypi.tuna.tsinghua.edu.cn/simple&quot;</span>
<a id="__codelineno-108-26" name="__codelineno-108-26"></a><span class="n">default</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span>
<a id="__codelineno-108-27" name="__codelineno-108-27"></a><span class="c1">#ä½¿ç”¨uv pipæ—¶é…ç½®</span>
<a id="__codelineno-108-28" name="__codelineno-108-28"></a><span class="k">[tool.uv.pip]</span>
<a id="__codelineno-108-29" name="__codelineno-108-29"></a><span class="n">index-url</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;https://mirrors.aliyun.com/pypi/simple/&quot;</span>
</code></pre></div></td></tr></table></div>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">TOML</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-109-1">1</a></span>
<span class="normal"><a href="#__codelineno-109-2">2</a></span>
<span class="normal"><a href="#__codelineno-109-3">3</a></span>
<span class="normal"><a href="#__codelineno-109-4">4</a></span>
<span class="normal"><a href="#__codelineno-109-5">5</a></span>
<span class="normal"><a href="#__codelineno-109-6">6</a></span>
<span class="normal"><a href="#__codelineno-109-7">7</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-109-1" name="__codelineno-109-1"></a><span class="n">uv</span><span class="w"> </span><span class="n">init</span><span class="w"> </span><span class="c1">#åˆ›å»ºé…ç½®æ–‡ä»¶åˆå§‹åŒ–</span>
<a id="__codelineno-109-2" name="__codelineno-109-2"></a><span class="n">uv</span><span class="w"> </span><span class="n">venv</span><span class="w"> </span><span class="n">--python</span><span class="w"> </span><span class="n">3</span><span class="p">.</span><span class="n">11</span>
<a id="__codelineno-109-3" name="__codelineno-109-3"></a><span class="p">.</span><span class="err">/</span><span class="n">venv</span><span class="err">/</span><span class="n">scripts</span><span class="err">/</span><span class="n">activate</span>
<a id="__codelineno-109-4" name="__codelineno-109-4"></a><span class="n">uv</span><span class="w"> </span><span class="n">add</span><span class="w"> </span><span class="n">xxx</span>
<a id="__codelineno-109-5" name="__codelineno-109-5"></a><span class="n">uv</span><span class="w"> </span><span class="n">remove</span><span class="w"> </span><span class="n">xxx</span>
<a id="__codelineno-109-6" name="__codelineno-109-6"></a><span class="n">uv</span><span class="w"> </span><span class="n">sync</span><span class="w"> </span><span class="c1">#ç±»ä¼¼npm installï¼Œå®‰è£…æ‰€æœ‰ä¾èµ–ï¼Œå¹¶ä¸”ç”Ÿæˆuv.lock</span>
<a id="__codelineno-109-7" name="__codelineno-109-7"></a><span class="n">uv</span><span class="w"> </span><span class="n">sync</span><span class="w"> </span><span class="n">--upgrade</span><span class="w"> </span><span class="c1">#æ›´æ–°è½¯ä»¶åŒ…</span>
</code></pre></div></td></tr></table></div>
<p>main.py</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Python</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-110-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-110-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-110-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-110-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-110-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-110-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-110-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-110-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-110-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-110-10">10</a></span>
<span class="normal"><a href="#__codelineno-110-11">11</a></span>
<span class="normal"><a href="#__codelineno-110-12">12</a></span>
<span class="normal"><a href="#__codelineno-110-13">13</a></span>
<span class="normal"><a href="#__codelineno-110-14">14</a></span>
<span class="normal"><a href="#__codelineno-110-15">15</a></span>
<span class="normal"><a href="#__codelineno-110-16">16</a></span>
<span class="normal"><a href="#__codelineno-110-17">17</a></span>
<span class="normal"><a href="#__codelineno-110-18">18</a></span>
<span class="normal"><a href="#__codelineno-110-19">19</a></span>
<span class="normal"><a href="#__codelineno-110-20">20</a></span>
<span class="normal"><a href="#__codelineno-110-21">21</a></span>
<span class="normal"><a href="#__codelineno-110-22">22</a></span>
<span class="normal"><a href="#__codelineno-110-23">23</a></span>
<span class="normal"><a href="#__codelineno-110-24">24</a></span>
<span class="normal"><a href="#__codelineno-110-25">25</a></span>
<span class="normal"><a href="#__codelineno-110-26">26</a></span>
<span class="normal"><a href="#__codelineno-110-27">27</a></span>
<span class="normal"><a href="#__codelineno-110-28">28</a></span>
<span class="normal"><a href="#__codelineno-110-29">29</a></span>
<span class="normal"><a href="#__codelineno-110-30">30</a></span>
<span class="normal"><a href="#__codelineno-110-31">31</a></span>
<span class="normal"><a href="#__codelineno-110-32">32</a></span>
<span class="normal"><a href="#__codelineno-110-33">33</a></span>
<span class="normal"><a href="#__codelineno-110-34">34</a></span>
<span class="normal"><a href="#__codelineno-110-35">35</a></span>
<span class="normal"><a href="#__codelineno-110-36">36</a></span>
<span class="normal"><a href="#__codelineno-110-37">37</a></span>
<span class="normal"><a href="#__codelineno-110-38">38</a></span>
<span class="normal"><a href="#__codelineno-110-39">39</a></span>
<span class="normal"><a href="#__codelineno-110-40">40</a></span>
<span class="normal"><a href="#__codelineno-110-41">41</a></span>
<span class="normal"><a href="#__codelineno-110-42">42</a></span>
<span class="normal"><a href="#__codelineno-110-43">43</a></span>
<span class="normal"><a href="#__codelineno-110-44">44</a></span>
<span class="normal"><a href="#__codelineno-110-45">45</a></span>
<span class="normal"><a href="#__codelineno-110-46">46</a></span>
<span class="normal"><a href="#__codelineno-110-47">47</a></span>
<span class="normal"><a href="#__codelineno-110-48">48</a></span>
<span class="normal"><a href="#__codelineno-110-49">49</a></span>
<span class="normal"><a href="#__codelineno-110-50">50</a></span>
<span class="normal"><a href="#__codelineno-110-51">51</a></span>
<span class="normal"><a href="#__codelineno-110-52">52</a></span>
<span class="normal"><a href="#__codelineno-110-53">53</a></span>
<span class="normal"><a href="#__codelineno-110-54">54</a></span>
<span class="normal"><a href="#__codelineno-110-55">55</a></span>
<span class="normal"><a href="#__codelineno-110-56">56</a></span>
<span class="normal"><a href="#__codelineno-110-57">57</a></span>
<span class="normal"><a href="#__codelineno-110-58">58</a></span>
<span class="normal"><a href="#__codelineno-110-59">59</a></span>
<span class="normal"><a href="#__codelineno-110-60">60</a></span>
<span class="normal"><a href="#__codelineno-110-61">61</a></span>
<span class="normal"><a href="#__codelineno-110-62">62</a></span>
<span class="normal"><a href="#__codelineno-110-63">63</a></span>
<span class="normal"><a href="#__codelineno-110-64">64</a></span>
<span class="normal"><a href="#__codelineno-110-65">65</a></span>
<span class="normal"><a href="#__codelineno-110-66">66</a></span>
<span class="normal"><a href="#__codelineno-110-67">67</a></span>
<span class="normal"><a href="#__codelineno-110-68">68</a></span>
<span class="normal"><a href="#__codelineno-110-69">69</a></span>
<span class="normal"><a href="#__codelineno-110-70">70</a></span>
<span class="normal"><a href="#__codelineno-110-71">71</a></span>
<span class="normal"><a href="#__codelineno-110-72">72</a></span>
<span class="normal"><a href="#__codelineno-110-73">73</a></span>
<span class="normal"><a href="#__codelineno-110-74">74</a></span>
<span class="normal"><a href="#__codelineno-110-75">75</a></span>
<span class="normal"><a href="#__codelineno-110-76">76</a></span>
<span class="normal"><a href="#__codelineno-110-77">77</a></span>
<span class="normal"><a href="#__codelineno-110-78">78</a></span>
<span class="normal"><a href="#__codelineno-110-79">79</a></span>
<span class="normal"><a href="#__codelineno-110-80">80</a></span>
<span class="normal"><a href="#__codelineno-110-81">81</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-110-1" name="__codelineno-110-1"></a><span class="c1"># backend/main.py</span>
<a id="__codelineno-110-2" name="__codelineno-110-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<a id="__codelineno-110-3" name="__codelineno-110-3"></a>
<a id="__codelineno-110-4" name="__codelineno-110-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">fastapi</span><span class="w"> </span><span class="kn">import</span> <span class="n">FastAPI</span><span class="p">,</span> <span class="n">WebSocket</span>
<a id="__codelineno-110-5" name="__codelineno-110-5"></a><span class="kn">from</span><span class="w"> </span><span class="nn">starlette.websockets</span><span class="w"> </span><span class="kn">import</span> <span class="n">WebSocketDisconnect</span>  <span class="c1"># âœ… æ­£ç¡®å¯¼å…¥æ–¹å¼</span>
<a id="__codelineno-110-6" name="__codelineno-110-6"></a>
<a id="__codelineno-110-7" name="__codelineno-110-7"></a><span class="kn">from</span><span class="w"> </span><span class="nn">fastapi.middleware.cors</span><span class="w"> </span><span class="kn">import</span> <span class="n">CORSMiddleware</span>
<a id="__codelineno-110-8" name="__codelineno-110-8"></a>
<a id="__codelineno-110-9" name="__codelineno-110-9"></a><span class="n">app</span> <span class="o">=</span> <span class="n">FastAPI</span><span class="p">()</span>
<a id="__codelineno-110-10" name="__codelineno-110-10"></a>
<a id="__codelineno-110-11" name="__codelineno-110-11"></a><span class="c1"># æ·»åŠ  CORS ä¸­é—´ä»¶ï¼Œå…è®¸å‰ç«¯åœ°å€è®¿é—®ï¼ˆå¼€å‘é˜¶æ®µä½¿ç”¨ *ï¼‰</span>
<a id="__codelineno-110-12" name="__codelineno-110-12"></a><span class="n">app</span><span class="o">.</span><span class="n">add_middleware</span><span class="p">(</span>
<a id="__codelineno-110-13" name="__codelineno-110-13"></a>    <span class="n">CORSMiddleware</span><span class="p">,</span>
<a id="__codelineno-110-14" name="__codelineno-110-14"></a>    <span class="n">allow_origins</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;*&quot;</span><span class="p">],</span>  <span class="c1"># ç”Ÿäº§ç¯å¢ƒå»ºè®®æ›¿æ¢ä¸ºå…·ä½“åœ°å€</span>
<a id="__codelineno-110-15" name="__codelineno-110-15"></a>    <span class="n">allow_credentials</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-110-16" name="__codelineno-110-16"></a>    <span class="n">allow_methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;*&quot;</span><span class="p">],</span>
<a id="__codelineno-110-17" name="__codelineno-110-17"></a>    <span class="n">allow_headers</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;*&quot;</span><span class="p">],</span>
<a id="__codelineno-110-18" name="__codelineno-110-18"></a><span class="p">)</span>
<a id="__codelineno-110-19" name="__codelineno-110-19"></a>
<a id="__codelineno-110-20" name="__codelineno-110-20"></a><span class="n">app</span> <span class="o">=</span> <span class="n">FastAPI</span><span class="p">()</span>
<a id="__codelineno-110-21" name="__codelineno-110-21"></a>
<a id="__codelineno-110-22" name="__codelineno-110-22"></a><span class="c1"># å­˜å‚¨ WebSocket è¿æ¥çš„åˆ—è¡¨</span>
<a id="__codelineno-110-23" name="__codelineno-110-23"></a><span class="n">active_connections</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-110-24" name="__codelineno-110-24"></a><span class="n">online_users</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-110-25" name="__codelineno-110-25"></a>
<a id="__codelineno-110-26" name="__codelineno-110-26"></a>
<a id="__codelineno-110-27" name="__codelineno-110-27"></a><span class="nd">@app</span><span class="o">.</span><span class="n">websocket</span><span class="p">(</span><span class="s2">&quot;/ws/chat&quot;</span><span class="p">)</span>
<a id="__codelineno-110-28" name="__codelineno-110-28"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">websocket_endpoint</span><span class="p">(</span><span class="n">websocket</span><span class="p">:</span> <span class="n">WebSocket</span><span class="p">):</span>
<a id="__codelineno-110-29" name="__codelineno-110-29"></a>    <span class="k">await</span> <span class="n">websocket</span><span class="o">.</span><span class="n">accept</span><span class="p">()</span>
<a id="__codelineno-110-30" name="__codelineno-110-30"></a>    <span class="c1"># é€šè¿‡ WebSocket è¿æ¥çš„å®¢æˆ·ç«¯ä¿æŒä¸€ä¸ªå­—å…¸æ˜ å°„: ç”¨æˆ·å -&gt; WebSocket</span>
<a id="__codelineno-110-31" name="__codelineno-110-31"></a>    <span class="n">username</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-110-32" name="__codelineno-110-32"></a>
<a id="__codelineno-110-33" name="__codelineno-110-33"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-110-34" name="__codelineno-110-34"></a>        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
<a id="__codelineno-110-35" name="__codelineno-110-35"></a>            <span class="c1"># æ¥å—å®¢æˆ·ç«¯å‘é€çš„æ¶ˆæ¯</span>
<a id="__codelineno-110-36" name="__codelineno-110-36"></a>            <span class="n">data</span> <span class="o">=</span> <span class="k">await</span> <span class="n">websocket</span><span class="o">.</span><span class="n">receive_text</span><span class="p">()</span>
<a id="__codelineno-110-37" name="__codelineno-110-37"></a>            <span class="n">message_data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>  <span class="c1"># è§£ææ”¶åˆ°çš„ JSON æ•°æ®</span>
<a id="__codelineno-110-38" name="__codelineno-110-38"></a>            <span class="n">username</span> <span class="o">=</span> <span class="n">message_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;uAsername&quot;</span><span class="p">)</span>
<a id="__codelineno-110-39" name="__codelineno-110-39"></a>            <span class="n">text</span> <span class="o">=</span> <span class="n">message_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;text&quot;</span><span class="p">)</span>
<a id="__codelineno-110-40" name="__codelineno-110-40"></a>
<a id="__codelineno-110-41" name="__codelineno-110-41"></a>            <span class="c1"># å¦‚æœç”¨æˆ·åå°šæœªæ³¨å†Œï¼Œåˆ™æ³¨å†Œè¯¥ç”¨æˆ·</span>
<a id="__codelineno-110-42" name="__codelineno-110-42"></a>            <span class="k">if</span> <span class="n">username</span> <span class="ow">and</span> <span class="n">username</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">online_users</span><span class="p">:</span>
<a id="__codelineno-110-43" name="__codelineno-110-43"></a>                <span class="n">online_users</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">username</span><span class="p">)</span>
<a id="__codelineno-110-44" name="__codelineno-110-44"></a>
<a id="__codelineno-110-45" name="__codelineno-110-45"></a>            <span class="c1"># è®°å½•è¯¥è¿æ¥</span>
<a id="__codelineno-110-46" name="__codelineno-110-46"></a>            <span class="n">active_connections</span><span class="p">[</span><span class="n">username</span><span class="p">]</span> <span class="o">=</span> <span class="n">websocket</span>
<a id="__codelineno-110-47" name="__codelineno-110-47"></a>
<a id="__codelineno-110-48" name="__codelineno-110-48"></a>            <span class="c1"># å¹¿æ’­æ¶ˆæ¯ç»™å…¶ä»–ç”¨æˆ·</span>
<a id="__codelineno-110-49" name="__codelineno-110-49"></a>            <span class="k">for</span> <span class="n">connection</span> <span class="ow">in</span> <span class="n">active_connections</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
<a id="__codelineno-110-50" name="__codelineno-110-50"></a>                <span class="k">await</span> <span class="n">connection</span><span class="o">.</span><span class="n">send_text</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span>
<a id="__codelineno-110-51" name="__codelineno-110-51"></a>                    <span class="s2">&quot;username&quot;</span><span class="p">:</span> <span class="n">username</span><span class="p">,</span>
<a id="__codelineno-110-52" name="__codelineno-110-52"></a>                    <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="n">text</span><span class="p">,</span>
<a id="__codelineno-110-53" name="__codelineno-110-53"></a>                <span class="p">}))</span>
<a id="__codelineno-110-54" name="__codelineno-110-54"></a>
<a id="__codelineno-110-55" name="__codelineno-110-55"></a>            <span class="c1"># å¹¿æ’­æ›´æ–°åœ¨çº¿ç”¨æˆ·åˆ—è¡¨</span>
<a id="__codelineno-110-56" name="__codelineno-110-56"></a>            <span class="k">for</span> <span class="n">connection</span> <span class="ow">in</span> <span class="n">active_connections</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
<a id="__codelineno-110-57" name="__codelineno-110-57"></a>                <span class="k">await</span> <span class="n">connection</span><span class="o">.</span><span class="n">send_text</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span>
<a id="__codelineno-110-58" name="__codelineno-110-58"></a>                    <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;user_list&quot;</span><span class="p">,</span>
<a id="__codelineno-110-59" name="__codelineno-110-59"></a>                    <span class="s2">&quot;users&quot;</span><span class="p">:</span> <span class="n">online_users</span><span class="p">,</span>
<a id="__codelineno-110-60" name="__codelineno-110-60"></a>                <span class="p">}))</span>
<a id="__codelineno-110-61" name="__codelineno-110-61"></a>
<a id="__codelineno-110-62" name="__codelineno-110-62"></a>    <span class="k">except</span> <span class="n">WebSocketDisconnect</span><span class="p">:</span>
<a id="__codelineno-110-63" name="__codelineno-110-63"></a>        <span class="c1"># ç”¨æˆ·æ–­å¼€è¿æ¥æ—¶ç§»é™¤è¯¥ç”¨æˆ·</span>
<a id="__codelineno-110-64" name="__codelineno-110-64"></a>        <span class="k">if</span> <span class="n">username</span> <span class="ow">in</span> <span class="n">online_users</span><span class="p">:</span>
<a id="__codelineno-110-65" name="__codelineno-110-65"></a>            <span class="n">online_users</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">username</span><span class="p">)</span>
<a id="__codelineno-110-66" name="__codelineno-110-66"></a>        <span class="n">active_connections</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<a id="__codelineno-110-67" name="__codelineno-110-67"></a>
<a id="__codelineno-110-68" name="__codelineno-110-68"></a>        <span class="c1"># å¹¿æ’­æ›´æ–°åœ¨çº¿ç”¨æˆ·åˆ—è¡¨</span>
<a id="__codelineno-110-69" name="__codelineno-110-69"></a>        <span class="k">for</span> <span class="n">connection</span> <span class="ow">in</span> <span class="n">active_connections</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
<a id="__codelineno-110-70" name="__codelineno-110-70"></a>            <span class="k">await</span> <span class="n">connection</span><span class="o">.</span><span class="n">send_text</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span>
<a id="__codelineno-110-71" name="__codelineno-110-71"></a>                <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;user_list&quot;</span><span class="p">,</span>
<a id="__codelineno-110-72" name="__codelineno-110-72"></a>                <span class="s2">&quot;users&quot;</span><span class="p">:</span> <span class="n">online_users</span><span class="p">,</span>
<a id="__codelineno-110-73" name="__codelineno-110-73"></a>            <span class="p">}))</span>
<a id="__codelineno-110-74" name="__codelineno-110-74"></a>
<a id="__codelineno-110-75" name="__codelineno-110-75"></a><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
<a id="__codelineno-110-76" name="__codelineno-110-76"></a>    <span class="kn">import</span><span class="w"> </span><span class="nn">uvicorn</span>
<a id="__codelineno-110-77" name="__codelineno-110-77"></a>    <span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<a id="__codelineno-110-78" name="__codelineno-110-78"></a>
<a id="__codelineno-110-79" name="__codelineno-110-79"></a>    <span class="n">app_model_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.py&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
<a id="__codelineno-110-80" name="__codelineno-110-80"></a>    <span class="nb">print</span><span class="p">(</span><span class="n">app_model_name</span><span class="p">)</span>
<a id="__codelineno-110-81" name="__codelineno-110-81"></a>    <span class="n">uvicorn</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">app_model_name</span><span class="si">}</span><span class="s2">:app&quot;</span><span class="p">,</span> <span class="n">host</span><span class="o">=</span><span class="s1">&#39;127.0.0.1&#39;</span><span class="p">,</span> <span class="n">reload</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
<p>å•å…ƒæµ‹è¯•test_ws.py</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Python</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-111-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-111-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-111-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-111-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-111-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-111-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-111-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-111-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-111-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-111-10">10</a></span>
<span class="normal"><a href="#__codelineno-111-11">11</a></span>
<span class="normal"><a href="#__codelineno-111-12">12</a></span>
<span class="normal"><a href="#__codelineno-111-13">13</a></span>
<span class="normal"><a href="#__codelineno-111-14">14</a></span>
<span class="normal"><a href="#__codelineno-111-15">15</a></span>
<span class="normal"><a href="#__codelineno-111-16">16</a></span>
<span class="normal"><a href="#__codelineno-111-17">17</a></span>
<span class="normal"><a href="#__codelineno-111-18">18</a></span>
<span class="normal"><a href="#__codelineno-111-19">19</a></span>
<span class="normal"><a href="#__codelineno-111-20">20</a></span>
<span class="normal"><a href="#__codelineno-111-21">21</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-111-1" name="__codelineno-111-1"></a><span class="c1"># backend/test_ws.py</span>
<a id="__codelineno-111-2" name="__codelineno-111-2"></a>
<a id="__codelineno-111-3" name="__codelineno-111-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<a id="__codelineno-111-4" name="__codelineno-111-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">httpx</span><span class="w"> </span><span class="kn">import</span> <span class="n">AsyncClient</span>
<a id="__codelineno-111-5" name="__codelineno-111-5"></a><span class="kn">from</span><span class="w"> </span><span class="nn">fastapi</span><span class="w"> </span><span class="kn">import</span> <span class="n">FastAPI</span>
<a id="__codelineno-111-6" name="__codelineno-111-6"></a><span class="kn">from</span><span class="w"> </span><span class="nn">fastapi.testclient</span><span class="w"> </span><span class="kn">import</span> <span class="n">TestClient</span>
<a id="__codelineno-111-7" name="__codelineno-111-7"></a><span class="kn">from</span><span class="w"> </span><span class="nn">starlette.websockets</span><span class="w"> </span><span class="kn">import</span> <span class="n">WebSocketDisconnect</span>
<a id="__codelineno-111-8" name="__codelineno-111-8"></a><span class="kn">from</span><span class="w"> </span><span class="nn">main</span><span class="w"> </span><span class="kn">import</span> <span class="n">app</span>  <span class="c1"># å¯¼å…¥ä½ é¡¹ç›®çš„ FastAPI å®ä¾‹</span>
<a id="__codelineno-111-9" name="__codelineno-111-9"></a>
<a id="__codelineno-111-10" name="__codelineno-111-10"></a>
<a id="__codelineno-111-11" name="__codelineno-111-11"></a><span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">anyio</span>
<a id="__codelineno-111-12" name="__codelineno-111-12"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">test_websocket_chat</span><span class="p">():</span>
<a id="__codelineno-111-13" name="__codelineno-111-13"></a>    <span class="n">client</span> <span class="o">=</span> <span class="n">TestClient</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
<a id="__codelineno-111-14" name="__codelineno-111-14"></a>
<a id="__codelineno-111-15" name="__codelineno-111-15"></a>    <span class="k">with</span> <span class="n">client</span><span class="o">.</span><span class="n">websocket_connect</span><span class="p">(</span><span class="s2">&quot;/ws/chat&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">websocket1</span><span class="p">:</span>
<a id="__codelineno-111-16" name="__codelineno-111-16"></a>        <span class="k">with</span> <span class="n">client</span><span class="o">.</span><span class="n">websocket_connect</span><span class="p">(</span><span class="s2">&quot;/ws/chat&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">websocket2</span><span class="p">:</span>
<a id="__codelineno-111-17" name="__codelineno-111-17"></a>            <span class="c1"># å®¢æˆ·ç«¯1å‘é€æ¶ˆæ¯</span>
<a id="__codelineno-111-18" name="__codelineno-111-18"></a>            <span class="n">websocket1</span><span class="o">.</span><span class="n">send_text</span><span class="p">(</span><span class="s2">&quot;ä½ å¥½ï¼Œå®¢æˆ·ç«¯2&quot;</span><span class="p">)</span>
<a id="__codelineno-111-19" name="__codelineno-111-19"></a>            <span class="c1"># å®¢æˆ·ç«¯2æ¥æ”¶æ¶ˆæ¯</span>
<a id="__codelineno-111-20" name="__codelineno-111-20"></a>            <span class="n">data</span> <span class="o">=</span> <span class="n">websocket2</span><span class="o">.</span><span class="n">receive_text</span><span class="p">()</span>
<a id="__codelineno-111-21" name="__codelineno-111-21"></a>            <span class="k">assert</span> <span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;ä½ å¥½ï¼Œå®¢æˆ·ç«¯2&quot;</span>
</code></pre></div></td></tr></table></div>
<p>åˆå§‹åŒ–å‰ç«¯é¡¹ç›®react</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Python</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-112-1">1</a></span>
<span class="normal"><a href="#__codelineno-112-2">2</a></span>
<span class="normal"><a href="#__codelineno-112-3">3</a></span>
<span class="normal"><a href="#__codelineno-112-4">4</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-112-1" name="__codelineno-112-1"></a><span class="n">npm</span> <span class="n">create</span> <span class="n">vite</span><span class="nd">@latest</span> <span class="n">frontend</span> <span class="o">--</span> <span class="o">--</span><span class="n">template</span> <span class="n">react</span>
<a id="__codelineno-112-2" name="__codelineno-112-2"></a><span class="n">cd</span> <span class="n">frontend</span>
<a id="__codelineno-112-3" name="__codelineno-112-3"></a><span class="n">pnpm</span> <span class="n">install</span>
<a id="__codelineno-112-4" name="__codelineno-112-4"></a><span class="n">pnpm</span> <span class="n">run</span> <span class="n">dev</span>
</code></pre></div></td></tr></table></div>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">JavaScript</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-113-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-113-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-113-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-113-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-113-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-113-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-113-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-113-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-113-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-113-10">10</a></span>
<span class="normal"><a href="#__codelineno-113-11">11</a></span>
<span class="normal"><a href="#__codelineno-113-12">12</a></span>
<span class="normal"><a href="#__codelineno-113-13">13</a></span>
<span class="normal"><a href="#__codelineno-113-14">14</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-113-1" name="__codelineno-113-1"></a><span class="c1">// frontend/src/App.js</span>
<a id="__codelineno-113-2" name="__codelineno-113-2"></a>
<a id="__codelineno-113-3" name="__codelineno-113-3"></a><span class="k">import</span><span class="w"> </span><span class="nx">React</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s2">&quot;react&quot;</span><span class="p">;</span>
<a id="__codelineno-113-4" name="__codelineno-113-4"></a><span class="k">import</span><span class="w"> </span><span class="nx">Chat</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s2">&quot;./Chat&quot;</span><span class="p">;</span>
<a id="__codelineno-113-5" name="__codelineno-113-5"></a>
<a id="__codelineno-113-6" name="__codelineno-113-6"></a><span class="kd">function</span><span class="w"> </span><span class="nx">App</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-113-7" name="__codelineno-113-7"></a><span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">(</span>
<a id="__codelineno-113-8" name="__codelineno-113-8"></a><span class="w">    </span><span class="o">&lt;</span><span class="nx">div</span><span class="w"> </span><span class="nx">className</span><span class="o">=</span><span class="s2">&quot;App&quot;</span><span class="o">&gt;</span>
<a id="__codelineno-113-9" name="__codelineno-113-9"></a><span class="w">    </span><span class="o">&lt;</span><span class="nx">Chat</span><span class="w"> </span><span class="o">/&gt;</span>
<a id="__codelineno-113-10" name="__codelineno-113-10"></a><span class="w">    </span><span class="o">&lt;</span><span class="err">/div&gt;</span>
<a id="__codelineno-113-11" name="__codelineno-113-11"></a><span class="w">  </span><span class="p">);</span>
<a id="__codelineno-113-12" name="__codelineno-113-12"></a><span class="p">}</span>
<a id="__codelineno-113-13" name="__codelineno-113-13"></a>
<a id="__codelineno-113-14" name="__codelineno-113-14"></a><span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="nx">App</span><span class="p">;</span>
</code></pre></div></td></tr></table></div>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">JavaScript</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-114-1">  1</a></span>
<span class="normal"><a href="#__codelineno-114-2">  2</a></span>
<span class="normal"><a href="#__codelineno-114-3">  3</a></span>
<span class="normal"><a href="#__codelineno-114-4">  4</a></span>
<span class="normal"><a href="#__codelineno-114-5">  5</a></span>
<span class="normal"><a href="#__codelineno-114-6">  6</a></span>
<span class="normal"><a href="#__codelineno-114-7">  7</a></span>
<span class="normal"><a href="#__codelineno-114-8">  8</a></span>
<span class="normal"><a href="#__codelineno-114-9">  9</a></span>
<span class="normal"><a href="#__codelineno-114-10"> 10</a></span>
<span class="normal"><a href="#__codelineno-114-11"> 11</a></span>
<span class="normal"><a href="#__codelineno-114-12"> 12</a></span>
<span class="normal"><a href="#__codelineno-114-13"> 13</a></span>
<span class="normal"><a href="#__codelineno-114-14"> 14</a></span>
<span class="normal"><a href="#__codelineno-114-15"> 15</a></span>
<span class="normal"><a href="#__codelineno-114-16"> 16</a></span>
<span class="normal"><a href="#__codelineno-114-17"> 17</a></span>
<span class="normal"><a href="#__codelineno-114-18"> 18</a></span>
<span class="normal"><a href="#__codelineno-114-19"> 19</a></span>
<span class="normal"><a href="#__codelineno-114-20"> 20</a></span>
<span class="normal"><a href="#__codelineno-114-21"> 21</a></span>
<span class="normal"><a href="#__codelineno-114-22"> 22</a></span>
<span class="normal"><a href="#__codelineno-114-23"> 23</a></span>
<span class="normal"><a href="#__codelineno-114-24"> 24</a></span>
<span class="normal"><a href="#__codelineno-114-25"> 25</a></span>
<span class="normal"><a href="#__codelineno-114-26"> 26</a></span>
<span class="normal"><a href="#__codelineno-114-27"> 27</a></span>
<span class="normal"><a href="#__codelineno-114-28"> 28</a></span>
<span class="normal"><a href="#__codelineno-114-29"> 29</a></span>
<span class="normal"><a href="#__codelineno-114-30"> 30</a></span>
<span class="normal"><a href="#__codelineno-114-31"> 31</a></span>
<span class="normal"><a href="#__codelineno-114-32"> 32</a></span>
<span class="normal"><a href="#__codelineno-114-33"> 33</a></span>
<span class="normal"><a href="#__codelineno-114-34"> 34</a></span>
<span class="normal"><a href="#__codelineno-114-35"> 35</a></span>
<span class="normal"><a href="#__codelineno-114-36"> 36</a></span>
<span class="normal"><a href="#__codelineno-114-37"> 37</a></span>
<span class="normal"><a href="#__codelineno-114-38"> 38</a></span>
<span class="normal"><a href="#__codelineno-114-39"> 39</a></span>
<span class="normal"><a href="#__codelineno-114-40"> 40</a></span>
<span class="normal"><a href="#__codelineno-114-41"> 41</a></span>
<span class="normal"><a href="#__codelineno-114-42"> 42</a></span>
<span class="normal"><a href="#__codelineno-114-43"> 43</a></span>
<span class="normal"><a href="#__codelineno-114-44"> 44</a></span>
<span class="normal"><a href="#__codelineno-114-45"> 45</a></span>
<span class="normal"><a href="#__codelineno-114-46"> 46</a></span>
<span class="normal"><a href="#__codelineno-114-47"> 47</a></span>
<span class="normal"><a href="#__codelineno-114-48"> 48</a></span>
<span class="normal"><a href="#__codelineno-114-49"> 49</a></span>
<span class="normal"><a href="#__codelineno-114-50"> 50</a></span>
<span class="normal"><a href="#__codelineno-114-51"> 51</a></span>
<span class="normal"><a href="#__codelineno-114-52"> 52</a></span>
<span class="normal"><a href="#__codelineno-114-53"> 53</a></span>
<span class="normal"><a href="#__codelineno-114-54"> 54</a></span>
<span class="normal"><a href="#__codelineno-114-55"> 55</a></span>
<span class="normal"><a href="#__codelineno-114-56"> 56</a></span>
<span class="normal"><a href="#__codelineno-114-57"> 57</a></span>
<span class="normal"><a href="#__codelineno-114-58"> 58</a></span>
<span class="normal"><a href="#__codelineno-114-59"> 59</a></span>
<span class="normal"><a href="#__codelineno-114-60"> 60</a></span>
<span class="normal"><a href="#__codelineno-114-61"> 61</a></span>
<span class="normal"><a href="#__codelineno-114-62"> 62</a></span>
<span class="normal"><a href="#__codelineno-114-63"> 63</a></span>
<span class="normal"><a href="#__codelineno-114-64"> 64</a></span>
<span class="normal"><a href="#__codelineno-114-65"> 65</a></span>
<span class="normal"><a href="#__codelineno-114-66"> 66</a></span>
<span class="normal"><a href="#__codelineno-114-67"> 67</a></span>
<span class="normal"><a href="#__codelineno-114-68"> 68</a></span>
<span class="normal"><a href="#__codelineno-114-69"> 69</a></span>
<span class="normal"><a href="#__codelineno-114-70"> 70</a></span>
<span class="normal"><a href="#__codelineno-114-71"> 71</a></span>
<span class="normal"><a href="#__codelineno-114-72"> 72</a></span>
<span class="normal"><a href="#__codelineno-114-73"> 73</a></span>
<span class="normal"><a href="#__codelineno-114-74"> 74</a></span>
<span class="normal"><a href="#__codelineno-114-75"> 75</a></span>
<span class="normal"><a href="#__codelineno-114-76"> 76</a></span>
<span class="normal"><a href="#__codelineno-114-77"> 77</a></span>
<span class="normal"><a href="#__codelineno-114-78"> 78</a></span>
<span class="normal"><a href="#__codelineno-114-79"> 79</a></span>
<span class="normal"><a href="#__codelineno-114-80"> 80</a></span>
<span class="normal"><a href="#__codelineno-114-81"> 81</a></span>
<span class="normal"><a href="#__codelineno-114-82"> 82</a></span>
<span class="normal"><a href="#__codelineno-114-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-114-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-114-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-114-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-114-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-114-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-114-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-114-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-114-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-114-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-114-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-114-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-114-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-114-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-114-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-114-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-114-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-114-100">100</a></span>
<span class="normal"><a href="#__codelineno-114-101">101</a></span>
<span class="normal"><a href="#__codelineno-114-102">102</a></span>
<span class="normal"><a href="#__codelineno-114-103">103</a></span>
<span class="normal"><a href="#__codelineno-114-104">104</a></span>
<span class="normal"><a href="#__codelineno-114-105">105</a></span>
<span class="normal"><a href="#__codelineno-114-106">106</a></span>
<span class="normal"><a href="#__codelineno-114-107">107</a></span>
<span class="normal"><a href="#__codelineno-114-108">108</a></span>
<span class="normal"><a href="#__codelineno-114-109">109</a></span>
<span class="normal"><a href="#__codelineno-114-110">110</a></span>
<span class="normal"><a href="#__codelineno-114-111">111</a></span>
<span class="normal"><a href="#__codelineno-114-112">112</a></span>
<span class="normal"><a href="#__codelineno-114-113">113</a></span>
<span class="normal"><a href="#__codelineno-114-114">114</a></span>
<span class="normal"><a href="#__codelineno-114-115">115</a></span>
<span class="normal"><a href="#__codelineno-114-116">116</a></span>
<span class="normal"><a href="#__codelineno-114-117">117</a></span>
<span class="normal"><a href="#__codelineno-114-118">118</a></span>
<span class="normal"><a href="#__codelineno-114-119">119</a></span>
<span class="normal"><a href="#__codelineno-114-120">120</a></span>
<span class="normal"><a href="#__codelineno-114-121">121</a></span>
<span class="normal"><a href="#__codelineno-114-122">122</a></span>
<span class="normal"><a href="#__codelineno-114-123">123</a></span>
<span class="normal"><a href="#__codelineno-114-124">124</a></span>
<span class="normal"><a href="#__codelineno-114-125">125</a></span>
<span class="normal"><a href="#__codelineno-114-126">126</a></span>
<span class="normal"><a href="#__codelineno-114-127">127</a></span>
<span class="normal"><a href="#__codelineno-114-128">128</a></span>
<span class="normal"><a href="#__codelineno-114-129">129</a></span>
<span class="normal"><a href="#__codelineno-114-130">130</a></span>
<span class="normal"><a href="#__codelineno-114-131">131</a></span>
<span class="normal"><a href="#__codelineno-114-132">132</a></span>
<span class="normal"><a href="#__codelineno-114-133">133</a></span>
<span class="normal"><a href="#__codelineno-114-134">134</a></span>
<span class="normal"><a href="#__codelineno-114-135">135</a></span>
<span class="normal"><a href="#__codelineno-114-136">136</a></span>
<span class="normal"><a href="#__codelineno-114-137">137</a></span>
<span class="normal"><a href="#__codelineno-114-138">138</a></span>
<span class="normal"><a href="#__codelineno-114-139">139</a></span>
<span class="normal"><a href="#__codelineno-114-140">140</a></span>
<span class="normal"><a href="#__codelineno-114-141">141</a></span>
<span class="normal"><a href="#__codelineno-114-142">142</a></span>
<span class="normal"><a href="#__codelineno-114-143">143</a></span>
<span class="normal"><a href="#__codelineno-114-144">144</a></span>
<span class="normal"><a href="#__codelineno-114-145">145</a></span>
<span class="normal"><a href="#__codelineno-114-146">146</a></span>
<span class="normal"><a href="#__codelineno-114-147">147</a></span>
<span class="normal"><a href="#__codelineno-114-148">148</a></span>
<span class="normal"><a href="#__codelineno-114-149">149</a></span>
<span class="normal"><a href="#__codelineno-114-150">150</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-114-1" name="__codelineno-114-1"></a><span class="c1">// frontend/src/Chat.js</span>
<a id="__codelineno-114-2" name="__codelineno-114-2"></a>
<a id="__codelineno-114-3" name="__codelineno-114-3"></a><span class="k">import</span><span class="w"> </span><span class="nx">React</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">useState</span><span class="p">,</span><span class="w"> </span><span class="nx">useEffect</span><span class="p">,</span><span class="w"> </span><span class="nx">useRef</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s2">&quot;react&quot;</span><span class="p">;</span>
<a id="__codelineno-114-4" name="__codelineno-114-4"></a>
<a id="__codelineno-114-5" name="__codelineno-114-5"></a><span class="kd">const</span><span class="w"> </span><span class="nx">Chat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-114-6" name="__codelineno-114-6"></a><span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="p">[</span><span class="nx">message</span><span class="p">,</span><span class="w"> </span><span class="nx">setMessage</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useState</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">);</span><span class="w">  </span><span class="c1">// è¾“å…¥æ¡†ä¸­çš„æ¶ˆæ¯</span>
<a id="__codelineno-114-7" name="__codelineno-114-7"></a><span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="p">[</span><span class="nx">messages</span><span class="p">,</span><span class="w"> </span><span class="nx">setMessages</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useState</span><span class="p">([]);</span><span class="w">  </span><span class="c1">// å­˜å‚¨èŠå¤©è®°å½•</span>
<a id="__codelineno-114-8" name="__codelineno-114-8"></a><span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="p">[</span><span class="nx">username</span><span class="p">,</span><span class="w"> </span><span class="nx">setUsername</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useState</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">);</span><span class="w">  </span><span class="c1">// ç”¨æˆ·å</span>
<a id="__codelineno-114-9" name="__codelineno-114-9"></a><span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="p">[</span><span class="nx">onlineUsers</span><span class="p">,</span><span class="w"> </span><span class="nx">setOnlineUsers</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useState</span><span class="p">([]);</span><span class="w">  </span><span class="c1">// åœ¨çº¿ç”¨æˆ·åˆ—è¡¨</span>
<a id="__codelineno-114-10" name="__codelineno-114-10"></a><span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">ws</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useRef</span><span class="p">(</span><span class="kc">null</span><span class="p">);</span><span class="w">  </span><span class="c1">// WebSocket å®ä¾‹</span>
<a id="__codelineno-114-11" name="__codelineno-114-11"></a>
<a id="__codelineno-114-12" name="__codelineno-114-12"></a><span class="w">  </span><span class="c1">// ç»„ä»¶æŒ‚è½½æ—¶åˆ›å»º WebSocket è¿æ¥</span>
<a id="__codelineno-114-13" name="__codelineno-114-13"></a><span class="w">  </span><span class="nx">useEffect</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-114-14" name="__codelineno-114-14"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">username</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-114-15" name="__codelineno-114-15"></a><span class="w">      </span><span class="nx">alert</span><span class="p">(</span><span class="s2">&quot;è¯·å…ˆè®¾ç½®ç”¨æˆ·åï¼&quot;</span><span class="p">);</span>
<a id="__codelineno-114-16" name="__codelineno-114-16"></a><span class="w">      </span><span class="k">return</span><span class="p">;</span>
<a id="__codelineno-114-17" name="__codelineno-114-17"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-114-18" name="__codelineno-114-18"></a>
<a id="__codelineno-114-19" name="__codelineno-114-19"></a><span class="w">    </span><span class="c1">// è¿æ¥åˆ°åç«¯çš„ WebSocket</span>
<a id="__codelineno-114-20" name="__codelineno-114-20"></a><span class="w">    </span><span class="nx">ws</span><span class="p">.</span><span class="nx">current</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">WebSocket</span><span class="p">(</span><span class="s2">&quot;ws://localhost:8000/ws/chat&quot;</span><span class="p">);</span>
<a id="__codelineno-114-21" name="__codelineno-114-21"></a>
<a id="__codelineno-114-22" name="__codelineno-114-22"></a><span class="w">    </span><span class="c1">// è¿æ¥æˆåŠŸæ—¥å¿—</span>
<a id="__codelineno-114-23" name="__codelineno-114-23"></a><span class="w">    </span><span class="nx">ws</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">onopen</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-114-24" name="__codelineno-114-24"></a><span class="w">      </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;WebSocketè¿æ¥å·²å»ºç«‹&quot;</span><span class="p">);</span>
<a id="__codelineno-114-25" name="__codelineno-114-25"></a><span class="w">    </span><span class="p">};</span>
<a id="__codelineno-114-26" name="__codelineno-114-26"></a>
<a id="__codelineno-114-27" name="__codelineno-114-27"></a><span class="w">    </span><span class="c1">// ç›‘å¬æ”¶åˆ°çš„æ¶ˆæ¯</span>
<a id="__codelineno-114-28" name="__codelineno-114-28"></a><span class="w">    </span><span class="nx">ws</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">onmessage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">event</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-114-29" name="__codelineno-114-29"></a><span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">receivedMessage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">data</span><span class="p">);</span><span class="w">  </span><span class="c1">// å‡è®¾åç«¯è¿”å›JSONæ ¼å¼</span>
<a id="__codelineno-114-30" name="__codelineno-114-30"></a><span class="w">      </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;æ”¶åˆ°æ¶ˆæ¯:&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">receivedMessage</span><span class="p">);</span>
<a id="__codelineno-114-31" name="__codelineno-114-31"></a>
<a id="__codelineno-114-32" name="__codelineno-114-32"></a><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">receivedMessage</span><span class="p">.</span><span class="nx">type</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s2">&quot;user_list&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-114-33" name="__codelineno-114-33"></a><span class="w">        </span><span class="nx">setOnlineUsers</span><span class="p">(</span><span class="nx">receivedMessage</span><span class="p">.</span><span class="nx">users</span><span class="p">);</span><span class="w">  </span><span class="c1">// æ›´æ–°åœ¨çº¿ç”¨æˆ·åˆ—è¡¨</span>
<a id="__codelineno-114-34" name="__codelineno-114-34"></a><span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-114-35" name="__codelineno-114-35"></a><span class="w">        </span><span class="nx">setMessages</span><span class="p">((</span><span class="nx">prevMessages</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">[</span>
<a id="__codelineno-114-36" name="__codelineno-114-36"></a><span class="w">          </span><span class="p">...</span><span class="nx">prevMessages</span><span class="p">,</span>
<a id="__codelineno-114-37" name="__codelineno-114-37"></a><span class="w">          </span><span class="nx">receivedMessage</span><span class="p">,</span>
<a id="__codelineno-114-38" name="__codelineno-114-38"></a><span class="w">        </span><span class="p">]);</span>
<a id="__codelineno-114-39" name="__codelineno-114-39"></a><span class="w">      </span><span class="p">}</span>
<a id="__codelineno-114-40" name="__codelineno-114-40"></a><span class="w">    </span><span class="p">};</span>
<a id="__codelineno-114-41" name="__codelineno-114-41"></a>
<a id="__codelineno-114-42" name="__codelineno-114-42"></a><span class="w">    </span><span class="c1">// ç›‘å¬ WebSocket é”™è¯¯</span>
<a id="__codelineno-114-43" name="__codelineno-114-43"></a><span class="w">    </span><span class="nx">ws</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">onerror</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-114-44" name="__codelineno-114-44"></a><span class="w">      </span><span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s2">&quot;WebSocket å‘ç”Ÿé”™è¯¯:&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">error</span><span class="p">);</span>
<a id="__codelineno-114-45" name="__codelineno-114-45"></a><span class="w">    </span><span class="p">};</span>
<a id="__codelineno-114-46" name="__codelineno-114-46"></a>
<a id="__codelineno-114-47" name="__codelineno-114-47"></a><span class="w">    </span><span class="c1">// æ¸…ç†å‡½æ•°ï¼Œåœ¨ç»„ä»¶å¸è½½æ—¶å…³é—­ WebSocket è¿æ¥</span>
<a id="__codelineno-114-48" name="__codelineno-114-48"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-114-49" name="__codelineno-114-49"></a><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">ws</span><span class="p">.</span><span class="nx">current</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-114-50" name="__codelineno-114-50"></a><span class="w">        </span><span class="nx">ws</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
<a id="__codelineno-114-51" name="__codelineno-114-51"></a><span class="w">      </span><span class="p">}</span>
<a id="__codelineno-114-52" name="__codelineno-114-52"></a><span class="w">    </span><span class="p">};</span>
<a id="__codelineno-114-53" name="__codelineno-114-53"></a><span class="w">  </span><span class="p">},</span><span class="w"> </span><span class="p">[</span><span class="nx">username</span><span class="p">]);</span>
<a id="__codelineno-114-54" name="__codelineno-114-54"></a>
<a id="__codelineno-114-55" name="__codelineno-114-55"></a><span class="w">  </span><span class="c1">// å‘é€æ¶ˆæ¯</span>
<a id="__codelineno-114-56" name="__codelineno-114-56"></a><span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">sendMessage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-114-57" name="__codelineno-114-57"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">message</span><span class="p">.</span><span class="nx">trim</span><span class="p">()</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-114-58" name="__codelineno-114-58"></a><span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">messageData</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-114-59" name="__codelineno-114-59"></a><span class="w">        </span><span class="nx">username</span><span class="o">:</span><span class="w"> </span><span class="nx">username</span><span class="p">,</span>
<a id="__codelineno-114-60" name="__codelineno-114-60"></a><span class="w">        </span><span class="nx">text</span><span class="o">:</span><span class="w"> </span><span class="nx">message</span><span class="p">,</span>
<a id="__codelineno-114-61" name="__codelineno-114-61"></a><span class="w">      </span><span class="p">};</span>
<a id="__codelineno-114-62" name="__codelineno-114-62"></a><span class="w">      </span><span class="nx">ws</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nb">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">messageData</span><span class="p">));</span><span class="w">  </span><span class="c1">// å‘é€æ¶ˆæ¯æ—¶å¸¦ä¸Šç”¨æˆ·å</span>
<a id="__codelineno-114-63" name="__codelineno-114-63"></a><span class="w">      </span><span class="nx">setMessage</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">);</span><span class="w">  </span><span class="c1">// æ¸…ç©ºè¾“å…¥æ¡†</span>
<a id="__codelineno-114-64" name="__codelineno-114-64"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-114-65" name="__codelineno-114-65"></a><span class="w">  </span><span class="p">};</span>
<a id="__codelineno-114-66" name="__codelineno-114-66"></a>
<a id="__codelineno-114-67" name="__codelineno-114-67"></a><span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">(</span>
<a id="__codelineno-114-68" name="__codelineno-114-68"></a><span class="w">    </span><span class="o">&lt;</span><span class="nx">div</span><span class="o">&gt;</span>
<a id="__codelineno-114-69" name="__codelineno-114-69"></a><span class="w">    </span><span class="o">&lt;</span><span class="nx">h1</span><span class="o">&gt;</span><span class="nx">èŠå¤©å®¤</span><span class="o">&lt;</span><span class="err">/h1&gt;</span>
<a id="__codelineno-114-70" name="__codelineno-114-70"></a><span class="w">    </span><span class="o">&lt;</span><span class="nx">div</span><span class="o">&gt;</span>
<a id="__codelineno-114-71" name="__codelineno-114-71"></a><span class="w">    </span><span class="p">{</span><span class="o">!</span><span class="nx">username</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span>
<a id="__codelineno-114-72" name="__codelineno-114-72"></a><span class="w">      </span><span class="o">&lt;</span><span class="nx">div</span><span class="o">&gt;</span>
<a id="__codelineno-114-73" name="__codelineno-114-73"></a><span class="w">      </span><span class="o">&lt;</span><span class="nx">input</span>
<a id="__codelineno-114-74" name="__codelineno-114-74"></a><span class="w">      </span><span class="nx">type</span><span class="o">=</span><span class="s2">&quot;text&quot;</span>
<a id="__codelineno-114-75" name="__codelineno-114-75"></a><span class="w">  </span><span class="nx">placeholder</span><span class="o">=</span><span class="s2">&quot;è¯·è¾“å…¥ç”¨æˆ·å&quot;</span>
<a id="__codelineno-114-76" name="__codelineno-114-76"></a><span class="w">  </span><span class="nx">value</span><span class="o">=</span><span class="p">{</span><span class="nx">username</span><span class="p">}</span>
<a id="__codelineno-114-77" name="__codelineno-114-77"></a><span class="w">  </span><span class="nx">onChange</span><span class="o">=</span><span class="p">{(</span><span class="nx">e</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">setUsername</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">value</span><span class="p">)}</span>
<a id="__codelineno-114-78" name="__codelineno-114-78"></a><span class="w">    </span><span class="o">/&gt;</span>
<a id="__codelineno-114-79" name="__codelineno-114-79"></a><span class="w">    </span><span class="o">&lt;</span><span class="err">/div&gt;</span>
<a id="__codelineno-114-80" name="__codelineno-114-80"></a><span class="w">  </span><span class="p">)}</span>
<a id="__codelineno-114-81" name="__codelineno-114-81"></a><span class="w">  </span><span class="o">&lt;</span><span class="nx">div</span><span class="w"> </span><span class="nx">style</span><span class="o">=</span><span class="p">{{</span><span class="w"> </span><span class="nx">display</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;flex&quot;</span><span class="w"> </span><span class="p">}}</span><span class="o">&gt;</span>
<a id="__codelineno-114-82" name="__codelineno-114-82"></a><span class="w">  </span><span class="o">&lt;</span><span class="nx">div</span><span class="w"> </span><span class="nx">style</span><span class="o">=</span><span class="p">{{</span><span class="w"> </span><span class="nx">width</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;300px&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">marginRight</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;20px&quot;</span><span class="w"> </span><span class="p">}}</span><span class="o">&gt;</span>
<a id="__codelineno-114-83" name="__codelineno-114-83"></a><span class="w">  </span><span class="o">&lt;</span><span class="nx">h2</span><span class="o">&gt;</span><span class="nx">åœ¨çº¿ç”¨æˆ·</span><span class="o">&lt;</span><span class="err">/h2&gt;</span>
<a id="__codelineno-114-84" name="__codelineno-114-84"></a><span class="w">  </span><span class="o">&lt;</span><span class="nx">ul</span><span class="o">&gt;</span>
<a id="__codelineno-114-85" name="__codelineno-114-85"></a><span class="w">  </span><span class="p">{</span><span class="nx">onlineUsers</span><span class="p">.</span><span class="nx">map</span><span class="p">((</span><span class="nx">user</span><span class="p">,</span><span class="w"> </span><span class="nx">index</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">(</span>
<a id="__codelineno-114-86" name="__codelineno-114-86"></a><span class="w">    </span><span class="o">&lt;</span><span class="nx">li</span><span class="w"> </span><span class="nx">key</span><span class="o">=</span><span class="p">{</span><span class="nx">index</span><span class="p">}</span><span class="o">&gt;</span><span class="p">{</span><span class="nx">user</span><span class="p">}</span><span class="o">&lt;</span><span class="err">/li&gt;</span>
<a id="__codelineno-114-87" name="__codelineno-114-87"></a><span class="w">                  </span><span class="p">))}</span>
<a id="__codelineno-114-88" name="__codelineno-114-88"></a><span class="o">&lt;</span><span class="err">/ul&gt;</span>
<a id="__codelineno-114-89" name="__codelineno-114-89"></a><span class="w">  </span><span class="o">&lt;</span><span class="err">/div&gt;</span>
<a id="__codelineno-114-90" name="__codelineno-114-90"></a><span class="w">  </span><span class="o">&lt;</span><span class="nx">div</span><span class="w"> </span><span class="nx">style</span><span class="o">=</span><span class="p">{{</span><span class="w"> </span><span class="nx">flex</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="w"> </span><span class="p">}}</span><span class="o">&gt;</span>
<a id="__codelineno-114-91" name="__codelineno-114-91"></a><span class="w">  </span><span class="o">&lt;</span><span class="nx">div</span>
<a id="__codelineno-114-92" name="__codelineno-114-92"></a><span class="nx">style</span><span class="o">=</span><span class="p">{{</span>
<a id="__codelineno-114-93" name="__codelineno-114-93"></a><span class="w">  </span><span class="nx">height</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;300px&quot;</span><span class="p">,</span>
<a id="__codelineno-114-94" name="__codelineno-114-94"></a><span class="w">  </span><span class="nx">overflowY</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;scroll&quot;</span><span class="p">,</span>
<a id="__codelineno-114-95" name="__codelineno-114-95"></a><span class="w">  </span><span class="nx">border</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;1px solid #ccc&quot;</span><span class="p">,</span>
<a id="__codelineno-114-96" name="__codelineno-114-96"></a><span class="w">  </span><span class="nx">marginBottom</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;10px&quot;</span><span class="p">,</span>
<a id="__codelineno-114-97" name="__codelineno-114-97"></a><span class="w">  </span><span class="nx">padding</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;10px&quot;</span><span class="p">,</span>
<a id="__codelineno-114-98" name="__codelineno-114-98"></a><span class="p">}}</span>
<a id="__codelineno-114-99" name="__codelineno-114-99"></a><span class="o">&gt;</span>
<a id="__codelineno-114-100" name="__codelineno-114-100"></a><span class="p">{</span><span class="nx">messages</span><span class="p">.</span><span class="nx">map</span><span class="p">((</span><span class="nx">msg</span><span class="p">,</span><span class="w"> </span><span class="nx">index</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">(</span>
<a id="__codelineno-114-101" name="__codelineno-114-101"></a><span class="w">  </span><span class="o">&lt;</span><span class="nx">div</span>
<a id="__codelineno-114-102" name="__codelineno-114-102"></a><span class="w">              </span><span class="nx">key</span><span class="o">=</span><span class="p">{</span><span class="nx">index</span><span class="p">}</span>
<a id="__codelineno-114-103" name="__codelineno-114-103"></a><span class="w"> </span><span class="nx">style</span><span class="o">=</span><span class="p">{{</span>
<a id="__codelineno-114-104" name="__codelineno-114-104"></a><span class="w">   </span><span class="nx">display</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;flex&quot;</span><span class="p">,</span>
<a id="__codelineno-114-105" name="__codelineno-114-105"></a><span class="w">   </span><span class="nx">alignItems</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;center&quot;</span><span class="p">,</span>
<a id="__codelineno-114-106" name="__codelineno-114-106"></a><span class="w">   </span><span class="nx">marginBottom</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;10px&quot;</span><span class="p">,</span>
<a id="__codelineno-114-107" name="__codelineno-114-107"></a><span class="w"> </span><span class="p">}}</span>
<a id="__codelineno-114-108" name="__codelineno-114-108"></a><span class="o">&gt;</span>
<a id="__codelineno-114-109" name="__codelineno-114-109"></a><span class="w">  </span><span class="o">&lt;</span><span class="nx">img</span>
<a id="__codelineno-114-110" name="__codelineno-114-110"></a><span class="nx">src</span><span class="o">=</span><span class="p">{</span><span class="sb">`https://avatars.dicebear.com/api/initials/</span><span class="si">${</span><span class="nx">msg</span><span class="p">.</span><span class="nx">username</span><span class="si">}</span><span class="sb">.svg`</span><span class="p">}</span>
<a id="__codelineno-114-111" name="__codelineno-114-111"></a><span class="nx">alt</span><span class="o">=</span><span class="p">{</span><span class="nx">msg</span><span class="p">.</span><span class="nx">username</span><span class="p">}</span>
<a id="__codelineno-114-112" name="__codelineno-114-112"></a><span class="nx">style</span><span class="o">=</span><span class="p">{{</span>
<a id="__codelineno-114-113" name="__codelineno-114-113"></a><span class="w">  </span><span class="nx">width</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;30px&quot;</span><span class="p">,</span>
<a id="__codelineno-114-114" name="__codelineno-114-114"></a><span class="w">  </span><span class="nx">height</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;30px&quot;</span><span class="p">,</span>
<a id="__codelineno-114-115" name="__codelineno-114-115"></a><span class="w">  </span><span class="nx">borderRadius</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;50%&quot;</span><span class="p">,</span>
<a id="__codelineno-114-116" name="__codelineno-114-116"></a><span class="w">                      </span><span class="nx">marginRight</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;10px&quot;</span><span class="p">,</span>
<a id="__codelineno-114-117" name="__codelineno-114-117"></a><span class="w">                    </span><span class="p">}}</span>
<a id="__codelineno-114-118" name="__codelineno-114-118"></a><span class="w">                  </span><span class="o">/&gt;</span>
<a id="__codelineno-114-119" name="__codelineno-114-119"></a><span class="w">                  </span><span class="o">&lt;</span><span class="nx">div</span>
<a id="__codelineno-114-120" name="__codelineno-114-120"></a><span class="w">                    </span><span class="nx">style</span><span class="o">=</span><span class="p">{{</span>
<a id="__codelineno-114-121" name="__codelineno-114-121"></a><span class="w">                      </span><span class="nx">padding</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;10px&quot;</span><span class="p">,</span>
<a id="__codelineno-114-122" name="__codelineno-114-122"></a><span class="w">                      </span><span class="nx">borderRadius</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;8px&quot;</span><span class="p">,</span>
<a id="__codelineno-114-123" name="__codelineno-114-123"></a><span class="w">                      </span><span class="nx">backgroundColor</span><span class="o">:</span><span class="w"> </span><span class="nx">msg</span><span class="p">.</span><span class="nx">username</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="nx">username</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="s2">&quot;#cce5ff&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;#f1f1f1&quot;</span><span class="p">,</span>
<a id="__codelineno-114-124" name="__codelineno-114-124"></a><span class="w">                      </span><span class="nx">color</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;#333&quot;</span><span class="p">,</span>
<a id="__codelineno-114-125" name="__codelineno-114-125"></a><span class="w">                      </span><span class="nx">maxWidth</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;60%&quot;</span><span class="p">,</span>
<a id="__codelineno-114-126" name="__codelineno-114-126"></a><span class="w">                    </span><span class="p">}}</span>
<a id="__codelineno-114-127" name="__codelineno-114-127"></a><span class="w">                  </span><span class="o">&gt;</span>
<a id="__codelineno-114-128" name="__codelineno-114-128"></a><span class="w">                    </span><span class="o">&lt;</span><span class="nx">strong</span><span class="o">&gt;</span><span class="p">{</span><span class="nx">msg</span><span class="p">.</span><span class="nx">username</span><span class="p">}</span><span class="o">&lt;</span><span class="err">/strong&gt;: {msg.text}</span>
<a id="__codelineno-114-129" name="__codelineno-114-129"></a><span class="w">                  </span><span class="o">&lt;</span><span class="err">/div&gt;</span>
<a id="__codelineno-114-130" name="__codelineno-114-130"></a><span class="w">                </span><span class="o">&lt;</span><span class="err">/div&gt;</span>
<a id="__codelineno-114-131" name="__codelineno-114-131"></a><span class="w">              </span><span class="p">))}</span>
<a id="__codelineno-114-132" name="__codelineno-114-132"></a><span class="w">            </span><span class="o">&lt;</span><span class="err">/div&gt;</span>
<a id="__codelineno-114-133" name="__codelineno-114-133"></a><span class="w">            </span><span class="o">&lt;</span><span class="nx">div</span><span class="o">&gt;</span>
<a id="__codelineno-114-134" name="__codelineno-114-134"></a><span class="w">              </span><span class="o">&lt;</span><span class="nx">input</span>
<a id="__codelineno-114-135" name="__codelineno-114-135"></a><span class="w">                </span><span class="nx">type</span><span class="o">=</span><span class="s2">&quot;text&quot;</span>
<a id="__codelineno-114-136" name="__codelineno-114-136"></a><span class="w">                </span><span class="nx">value</span><span class="o">=</span><span class="p">{</span><span class="nx">message</span><span class="p">}</span>
<a id="__codelineno-114-137" name="__codelineno-114-137"></a><span class="w">                </span><span class="nx">onChange</span><span class="o">=</span><span class="p">{(</span><span class="nx">e</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">setMessage</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">value</span><span class="p">)}</span>
<a id="__codelineno-114-138" name="__codelineno-114-138"></a><span class="w">                </span><span class="nx">placeholder</span><span class="o">=</span><span class="s2">&quot;è¯·è¾“å…¥æ¶ˆæ¯&quot;</span>
<a id="__codelineno-114-139" name="__codelineno-114-139"></a><span class="w">                </span><span class="nx">style</span><span class="o">=</span><span class="p">{{</span><span class="w"> </span><span class="nx">width</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;300px&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">marginRight</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;10px&quot;</span><span class="w"> </span><span class="p">}}</span>
<a id="__codelineno-114-140" name="__codelineno-114-140"></a><span class="w">              </span><span class="o">/&gt;</span>
<a id="__codelineno-114-141" name="__codelineno-114-141"></a><span class="w">              </span><span class="o">&lt;</span><span class="nx">button</span><span class="w"> </span><span class="nx">onClick</span><span class="o">=</span><span class="p">{</span><span class="nx">sendMessage</span><span class="p">}</span><span class="o">&gt;</span><span class="nx">å‘é€</span><span class="o">&lt;</span><span class="err">/button&gt;</span>
<a id="__codelineno-114-142" name="__codelineno-114-142"></a><span class="w">            </span><span class="o">&lt;</span><span class="err">/div&gt;</span>
<a id="__codelineno-114-143" name="__codelineno-114-143"></a><span class="w">          </span><span class="o">&lt;</span><span class="err">/div&gt;</span>
<a id="__codelineno-114-144" name="__codelineno-114-144"></a><span class="w">        </span><span class="o">&lt;</span><span class="err">/div&gt;</span>
<a id="__codelineno-114-145" name="__codelineno-114-145"></a><span class="w">      </span><span class="o">&lt;</span><span class="err">/div&gt;</span>
<a id="__codelineno-114-146" name="__codelineno-114-146"></a><span class="w">    </span><span class="o">&lt;</span><span class="err">/div&gt;</span>
<a id="__codelineno-114-147" name="__codelineno-114-147"></a><span class="w">  </span><span class="p">);</span>
<a id="__codelineno-114-148" name="__codelineno-114-148"></a><span class="p">};</span>
<a id="__codelineno-114-149" name="__codelineno-114-149"></a>
<a id="__codelineno-114-150" name="__codelineno-114-150"></a><span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="nx">Chat</span><span class="p">;</span>
</code></pre></div></td></tr></table></div>
<p>åˆå§‹åŒ–vueé¡¹ç›®</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">JavaScript</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-115-1">1</a></span>
<span class="normal"><a href="#__codelineno-115-2">2</a></span>
<span class="normal"><a href="#__codelineno-115-3">3</a></span>
<span class="normal"><a href="#__codelineno-115-4">4</a></span>
<span class="normal"><a href="#__codelineno-115-5">5</a></span>
<span class="normal"><a href="#__codelineno-115-6">6</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-115-1" name="__codelineno-115-1"></a><span class="nx">pnpm</span><span class="w"> </span><span class="nx">create</span><span class="w"> </span><span class="nx">vite</span><span class="err">@</span><span class="nx">latest</span><span class="w"> </span><span class="nx">vite</span><span class="o">-</span><span class="nx">vue</span><span class="o">-</span><span class="nx">chat</span><span class="w"> </span><span class="o">--</span><span class="nx">template</span><span class="w"> </span><span class="nx">vue</span>
<a id="__codelineno-115-2" name="__codelineno-115-2"></a><span class="nx">cd</span><span class="w"> </span><span class="nx">vite</span><span class="o">-</span><span class="nx">vue</span><span class="o">-</span><span class="nx">chat</span>
<a id="__codelineno-115-3" name="__codelineno-115-3"></a><span class="nx">pnpm</span><span class="w"> </span><span class="nx">install</span>
<a id="__codelineno-115-4" name="__codelineno-115-4"></a><span class="nx">pnpm</span><span class="w"> </span><span class="nx">dev</span>
<a id="__codelineno-115-5" name="__codelineno-115-5"></a><span class="nx">pnpm</span><span class="w"> </span><span class="nx">install</span><span class="w"> </span><span class="nx">pinia</span><span class="w"> </span><span class="err">#</span><span class="w"> </span><span class="nx">çŠ¶æ€ç®¡ç†</span><span class="err">ï¼ˆ</span><span class="nx">æ¨è</span><span class="err">ï¼‰</span>
<a id="__codelineno-115-6" name="__codelineno-115-6"></a><span class="nx">pnpm</span><span class="w"> </span><span class="nx">install</span><span class="w"> </span><span class="nx">uuid</span><span class="w">  </span><span class="err">#</span><span class="w"> </span><span class="nx">ç”Ÿæˆä¸´æ—¶ç”¨æˆ·</span><span class="w"> </span><span class="nx">ID</span><span class="err">ï¼ˆ</span><span class="nx">å¯é€‰</span><span class="err">ï¼‰</span>
</code></pre></div></td></tr></table></div>
<p><code>src/main.js</code></p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">JavaScript</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-116-1">1</a></span>
<span class="normal"><a href="#__codelineno-116-2">2</a></span>
<span class="normal"><a href="#__codelineno-116-3">3</a></span>
<span class="normal"><a href="#__codelineno-116-4">4</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-116-1" name="__codelineno-116-1"></a><span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">createApp</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;vue&#39;</span>
<a id="__codelineno-116-2" name="__codelineno-116-2"></a><span class="k">import</span><span class="w"> </span><span class="nx">App</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;./App.vue&#39;</span>
<a id="__codelineno-116-3" name="__codelineno-116-3"></a>
<a id="__codelineno-116-4" name="__codelineno-116-4"></a><span class="nx">createApp</span><span class="p">(</span><span class="nx">App</span><span class="p">).</span><span class="nx">mount</span><span class="p">(</span><span class="s1">&#39;#app&#39;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
<p>src/App.vue  </p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">JavaScript</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-117-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-117-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-117-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-117-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-117-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-117-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-117-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-117-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-117-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-117-10">10</a></span>
<span class="normal"><a href="#__codelineno-117-11">11</a></span>
<span class="normal"><a href="#__codelineno-117-12">12</a></span>
<span class="normal"><a href="#__codelineno-117-13">13</a></span>
<span class="normal"><a href="#__codelineno-117-14">14</a></span>
<span class="normal"><a href="#__codelineno-117-15">15</a></span>
<span class="normal"><a href="#__codelineno-117-16">16</a></span>
<span class="normal"><a href="#__codelineno-117-17">17</a></span>
<span class="normal"><a href="#__codelineno-117-18">18</a></span>
<span class="normal"><a href="#__codelineno-117-19">19</a></span>
<span class="normal"><a href="#__codelineno-117-20">20</a></span>
<span class="normal"><a href="#__codelineno-117-21">21</a></span>
<span class="normal"><a href="#__codelineno-117-22">22</a></span>
<span class="normal"><a href="#__codelineno-117-23">23</a></span>
<span class="normal"><a href="#__codelineno-117-24">24</a></span>
<span class="normal"><a href="#__codelineno-117-25">25</a></span>
<span class="normal"><a href="#__codelineno-117-26">26</a></span>
<span class="normal"><a href="#__codelineno-117-27">27</a></span>
<span class="normal"><a href="#__codelineno-117-28">28</a></span>
<span class="normal"><a href="#__codelineno-117-29">29</a></span>
<span class="normal"><a href="#__codelineno-117-30">30</a></span>
<span class="normal"><a href="#__codelineno-117-31">31</a></span>
<span class="normal"><a href="#__codelineno-117-32">32</a></span>
<span class="normal"><a href="#__codelineno-117-33">33</a></span>
<span class="normal"><a href="#__codelineno-117-34">34</a></span>
<span class="normal"><a href="#__codelineno-117-35">35</a></span>
<span class="normal"><a href="#__codelineno-117-36">36</a></span>
<span class="normal"><a href="#__codelineno-117-37">37</a></span>
<span class="normal"><a href="#__codelineno-117-38">38</a></span>
<span class="normal"><a href="#__codelineno-117-39">39</a></span>
<span class="normal"><a href="#__codelineno-117-40">40</a></span>
<span class="normal"><a href="#__codelineno-117-41">41</a></span>
<span class="normal"><a href="#__codelineno-117-42">42</a></span>
<span class="normal"><a href="#__codelineno-117-43">43</a></span>
<span class="normal"><a href="#__codelineno-117-44">44</a></span>
<span class="normal"><a href="#__codelineno-117-45">45</a></span>
<span class="normal"><a href="#__codelineno-117-46">46</a></span>
<span class="normal"><a href="#__codelineno-117-47">47</a></span>
<span class="normal"><a href="#__codelineno-117-48">48</a></span>
<span class="normal"><a href="#__codelineno-117-49">49</a></span>
<span class="normal"><a href="#__codelineno-117-50">50</a></span>
<span class="normal"><a href="#__codelineno-117-51">51</a></span>
<span class="normal"><a href="#__codelineno-117-52">52</a></span>
<span class="normal"><a href="#__codelineno-117-53">53</a></span>
<span class="normal"><a href="#__codelineno-117-54">54</a></span>
<span class="normal"><a href="#__codelineno-117-55">55</a></span>
<span class="normal"><a href="#__codelineno-117-56">56</a></span>
<span class="normal"><a href="#__codelineno-117-57">57</a></span>
<span class="normal"><a href="#__codelineno-117-58">58</a></span>
<span class="normal"><a href="#__codelineno-117-59">59</a></span>
<span class="normal"><a href="#__codelineno-117-60">60</a></span>
<span class="normal"><a href="#__codelineno-117-61">61</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-117-1" name="__codelineno-117-1"></a><span class="o">&lt;</span><span class="nx">template</span><span class="o">&gt;</span>
<a id="__codelineno-117-2" name="__codelineno-117-2"></a><span class="w">  </span><span class="o">&lt;</span><span class="nx">div</span><span class="w"> </span><span class="kd">class</span><span class="o">=</span><span class="s2">&quot;app&quot;</span><span class="o">&gt;</span>
<a id="__codelineno-117-3" name="__codelineno-117-3"></a><span class="w">  </span><span class="o">&lt;</span><span class="nx">h1</span><span class="o">&gt;</span><span class="nx">Vue</span><span class="w"> </span><span class="nx">èŠå¤©å®¤</span><span class="o">&lt;</span><span class="err">/h1&gt;</span>
<a id="__codelineno-117-4" name="__codelineno-117-4"></a><span class="w">  </span><span class="o">&lt;</span><span class="nx">div</span><span class="w"> </span><span class="nx">v</span><span class="o">-</span><span class="k">if</span><span class="o">=</span><span class="s2">&quot;!username&quot;</span><span class="o">&gt;</span>
<a id="__codelineno-117-5" name="__codelineno-117-5"></a><span class="w">  </span><span class="o">&lt;</span><span class="nx">input</span><span class="w"> </span><span class="nx">v</span><span class="o">-</span><span class="nx">model</span><span class="o">=</span><span class="s2">&quot;tempName&quot;</span><span class="w"> </span><span class="nx">placeholder</span><span class="o">=</span><span class="s2">&quot;è¾“å…¥ç”¨æˆ·å&quot;</span><span class="w"> </span><span class="err">@</span><span class="nx">keyup</span><span class="p">.</span><span class="nx">enter</span><span class="o">=</span><span class="s2">&quot;setUsername&quot;</span><span class="w"> </span><span class="o">/&gt;</span>
<a id="__codelineno-117-6" name="__codelineno-117-6"></a><span class="w">  </span><span class="o">&lt;</span><span class="nx">button</span><span class="w"> </span><span class="err">@</span><span class="nx">click</span><span class="o">=</span><span class="s2">&quot;setUsername&quot;</span><span class="o">&gt;</span><span class="nx">è¿›å…¥èŠå¤©å®¤</span><span class="o">&lt;</span><span class="err">/button&gt;</span>
<a id="__codelineno-117-7" name="__codelineno-117-7"></a><span class="w">  </span><span class="o">&lt;</span><span class="err">/div&gt;</span>
<a id="__codelineno-117-8" name="__codelineno-117-8"></a><span class="w">  </span><span class="o">&lt;</span><span class="nx">div</span><span class="w"> </span><span class="nx">v</span><span class="o">-</span><span class="k">else</span><span class="o">&gt;</span>
<a id="__codelineno-117-9" name="__codelineno-117-9"></a><span class="w">  </span><span class="o">&lt;</span><span class="nx">p</span><span class="o">&gt;</span><span class="nx">ä½ å¥½</span><span class="err">ï¼Œ</span><span class="p">{{</span><span class="w"> </span><span class="nx">username</span><span class="w"> </span><span class="p">}}</span><span class="err">ï¼</span><span class="o">&lt;</span><span class="err">/p&gt;</span>
<a id="__codelineno-117-10" name="__codelineno-117-10"></a><span class="w">  </span><span class="o">&lt;</span><span class="nx">UserList</span><span class="w"> </span><span class="o">:</span><span class="nx">users</span><span class="o">=</span><span class="s2">&quot;users&quot;</span><span class="w"> </span><span class="o">/&gt;</span>
<a id="__codelineno-117-11" name="__codelineno-117-11"></a><span class="w">  </span><span class="o">&lt;</span><span class="nx">ChatWindow</span><span class="w"> </span><span class="o">:</span><span class="nx">username</span><span class="o">=</span><span class="s2">&quot;username&quot;</span><span class="w"> </span><span class="o">:</span><span class="nx">socket</span><span class="o">=</span><span class="s2">&quot;socket&quot;</span><span class="w"> </span><span class="o">:</span><span class="nx">messages</span><span class="o">=</span><span class="s2">&quot;messages&quot;</span><span class="w"> </span><span class="o">/&gt;</span>
<a id="__codelineno-117-12" name="__codelineno-117-12"></a><span class="w">  </span><span class="o">&lt;</span><span class="err">/div&gt;</span>
<a id="__codelineno-117-13" name="__codelineno-117-13"></a><span class="w">  </span><span class="o">&lt;</span><span class="err">/div&gt;</span>
<a id="__codelineno-117-14" name="__codelineno-117-14"></a><span class="w">  </span><span class="o">&lt;</span><span class="err">/template&gt;</span>
<a id="__codelineno-117-15" name="__codelineno-117-15"></a>
<a id="__codelineno-117-16" name="__codelineno-117-16"></a><span class="w">  </span><span class="o">&lt;</span><span class="nx">script</span><span class="w"> </span><span class="nx">setup</span><span class="o">&gt;</span>
<a id="__codelineno-117-17" name="__codelineno-117-17"></a><span class="w">  </span><span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">ref</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;vue&#39;</span>
<a id="__codelineno-117-18" name="__codelineno-117-18"></a><span class="k">import</span><span class="w"> </span><span class="nx">ChatWindow</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;./components/ChatWindow.vue&#39;</span>
<a id="__codelineno-117-19" name="__codelineno-117-19"></a><span class="k">import</span><span class="w"> </span><span class="nx">UserList</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;./components/UserList.vue&#39;</span>
<a id="__codelineno-117-20" name="__codelineno-117-20"></a>
<a id="__codelineno-117-21" name="__codelineno-117-21"></a><span class="kd">const</span><span class="w"> </span><span class="nx">username</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">ref</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
<a id="__codelineno-117-22" name="__codelineno-117-22"></a><span class="kd">const</span><span class="w"> </span><span class="nx">tempName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">ref</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
<a id="__codelineno-117-23" name="__codelineno-117-23"></a><span class="kd">const</span><span class="w"> </span><span class="nx">messages</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">ref</span><span class="p">([])</span>
<a id="__codelineno-117-24" name="__codelineno-117-24"></a><span class="kd">const</span><span class="w"> </span><span class="nx">users</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">ref</span><span class="p">([])</span>
<a id="__codelineno-117-25" name="__codelineno-117-25"></a><span class="kd">const</span><span class="w"> </span><span class="nx">socket</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">ref</span><span class="p">(</span><span class="kc">null</span><span class="p">)</span>
<a id="__codelineno-117-26" name="__codelineno-117-26"></a>
<a id="__codelineno-117-27" name="__codelineno-117-27"></a><span class="kd">function</span><span class="w"> </span><span class="nx">setUsername</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-117-28" name="__codelineno-117-28"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">tempName</span><span class="p">.</span><span class="nx">value</span><span class="p">.</span><span class="nx">trim</span><span class="p">())</span><span class="w"> </span><span class="k">return</span>
<a id="__codelineno-117-29" name="__codelineno-117-29"></a><span class="w">  </span><span class="nx">username</span><span class="p">.</span><span class="nx">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">tempName</span><span class="p">.</span><span class="nx">value</span>
<a id="__codelineno-117-30" name="__codelineno-117-30"></a><span class="w">  </span><span class="nx">socket</span><span class="p">.</span><span class="nx">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">WebSocket</span><span class="p">(</span><span class="s1">&#39;ws://localhost:8000/ws/chat&#39;</span><span class="p">)</span>
<a id="__codelineno-117-31" name="__codelineno-117-31"></a>
<a id="__codelineno-117-32" name="__codelineno-117-32"></a><span class="w">  </span><span class="nx">socket</span><span class="p">.</span><span class="nx">value</span><span class="p">.</span><span class="nx">onopen</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-117-33" name="__codelineno-117-33"></a><span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;è¿æ¥æˆåŠŸ&#39;</span><span class="p">)</span>
<a id="__codelineno-117-34" name="__codelineno-117-34"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-117-35" name="__codelineno-117-35"></a>
<a id="__codelineno-117-36" name="__codelineno-117-36"></a><span class="w">  </span><span class="nx">socket</span><span class="p">.</span><span class="nx">value</span><span class="p">.</span><span class="nx">onmessage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">event</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-117-37" name="__codelineno-117-37"></a><span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">data</span><span class="p">)</span>
<a id="__codelineno-117-38" name="__codelineno-117-38"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">type</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;user_list&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-117-39" name="__codelineno-117-39"></a><span class="w">      </span><span class="nx">users</span><span class="p">.</span><span class="nx">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">data</span><span class="p">.</span><span class="nx">users</span>
<a id="__codelineno-117-40" name="__codelineno-117-40"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-117-41" name="__codelineno-117-41"></a><span class="w">      </span><span class="nx">messages</span><span class="p">.</span><span class="nx">value</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span>
<a id="__codelineno-117-42" name="__codelineno-117-42"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-117-43" name="__codelineno-117-43"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-117-44" name="__codelineno-117-44"></a>
<a id="__codelineno-117-45" name="__codelineno-117-45"></a><span class="w">  </span><span class="nx">socket</span><span class="p">.</span><span class="nx">value</span><span class="p">.</span><span class="nx">onerror</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">e</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-117-46" name="__codelineno-117-46"></a><span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s1">&#39;WebSocket é”™è¯¯&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">e</span><span class="p">)</span>
<a id="__codelineno-117-47" name="__codelineno-117-47"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-117-48" name="__codelineno-117-48"></a>
<a id="__codelineno-117-49" name="__codelineno-117-49"></a><span class="w">  </span><span class="nx">socket</span><span class="p">.</span><span class="nx">value</span><span class="p">.</span><span class="nx">onclose</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-117-50" name="__codelineno-117-50"></a><span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">warn</span><span class="p">(</span><span class="s1">&#39;è¿æ¥å·²å…³é—­&#39;</span><span class="p">)</span>
<a id="__codelineno-117-51" name="__codelineno-117-51"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-117-52" name="__codelineno-117-52"></a><span class="p">}</span>
<a id="__codelineno-117-53" name="__codelineno-117-53"></a><span class="o">&lt;</span><span class="err">/script&gt;</span>
<a id="__codelineno-117-54" name="__codelineno-117-54"></a>
<a id="__codelineno-117-55" name="__codelineno-117-55"></a><span class="w">  </span><span class="o">&lt;</span><span class="nx">style</span><span class="o">&gt;</span>
<a id="__codelineno-117-56" name="__codelineno-117-56"></a><span class="w">  </span><span class="p">.</span><span class="nx">app</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-117-57" name="__codelineno-117-57"></a><span class="w">  </span><span class="nx">max</span><span class="o">-</span><span class="nx">width</span><span class="o">:</span><span class="w"> </span><span class="mf">600</span><span class="nx">px</span><span class="p">;</span>
<a id="__codelineno-117-58" name="__codelineno-117-58"></a><span class="w">  </span><span class="nx">margin</span><span class="o">:</span><span class="w"> </span><span class="mf">0</span><span class="w"> </span><span class="nx">auto</span><span class="p">;</span>
<a id="__codelineno-117-59" name="__codelineno-117-59"></a><span class="w">  </span><span class="nx">font</span><span class="o">-</span><span class="nx">family</span><span class="o">:</span><span class="w"> </span><span class="nx">sans</span><span class="o">-</span><span class="nx">serif</span><span class="p">;</span>
<a id="__codelineno-117-60" name="__codelineno-117-60"></a><span class="p">}</span>
<a id="__codelineno-117-61" name="__codelineno-117-61"></a><span class="o">&lt;</span><span class="err">/style&gt;</span>
</code></pre></div></td></tr></table></div>
<p>src/components/ChatWindow.vue  </p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">JavaScript</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-118-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-118-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-118-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-118-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-118-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-118-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-118-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-118-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-118-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-118-10">10</a></span>
<span class="normal"><a href="#__codelineno-118-11">11</a></span>
<span class="normal"><a href="#__codelineno-118-12">12</a></span>
<span class="normal"><a href="#__codelineno-118-13">13</a></span>
<span class="normal"><a href="#__codelineno-118-14">14</a></span>
<span class="normal"><a href="#__codelineno-118-15">15</a></span>
<span class="normal"><a href="#__codelineno-118-16">16</a></span>
<span class="normal"><a href="#__codelineno-118-17">17</a></span>
<span class="normal"><a href="#__codelineno-118-18">18</a></span>
<span class="normal"><a href="#__codelineno-118-19">19</a></span>
<span class="normal"><a href="#__codelineno-118-20">20</a></span>
<span class="normal"><a href="#__codelineno-118-21">21</a></span>
<span class="normal"><a href="#__codelineno-118-22">22</a></span>
<span class="normal"><a href="#__codelineno-118-23">23</a></span>
<span class="normal"><a href="#__codelineno-118-24">24</a></span>
<span class="normal"><a href="#__codelineno-118-25">25</a></span>
<span class="normal"><a href="#__codelineno-118-26">26</a></span>
<span class="normal"><a href="#__codelineno-118-27">27</a></span>
<span class="normal"><a href="#__codelineno-118-28">28</a></span>
<span class="normal"><a href="#__codelineno-118-29">29</a></span>
<span class="normal"><a href="#__codelineno-118-30">30</a></span>
<span class="normal"><a href="#__codelineno-118-31">31</a></span>
<span class="normal"><a href="#__codelineno-118-32">32</a></span>
<span class="normal"><a href="#__codelineno-118-33">33</a></span>
<span class="normal"><a href="#__codelineno-118-34">34</a></span>
<span class="normal"><a href="#__codelineno-118-35">35</a></span>
<span class="normal"><a href="#__codelineno-118-36">36</a></span>
<span class="normal"><a href="#__codelineno-118-37">37</a></span>
<span class="normal"><a href="#__codelineno-118-38">38</a></span>
<span class="normal"><a href="#__codelineno-118-39">39</a></span>
<span class="normal"><a href="#__codelineno-118-40">40</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-118-1" name="__codelineno-118-1"></a><span class="o">&lt;</span><span class="nx">template</span><span class="o">&gt;</span>
<a id="__codelineno-118-2" name="__codelineno-118-2"></a><span class="w">  </span><span class="o">&lt;</span><span class="nx">div</span><span class="w"> </span><span class="kd">class</span><span class="o">=</span><span class="s2">&quot;chat&quot;</span><span class="o">&gt;</span>
<a id="__codelineno-118-3" name="__codelineno-118-3"></a><span class="w">    </span><span class="o">&lt;</span><span class="nx">div</span><span class="w"> </span><span class="kd">class</span><span class="o">=</span><span class="s2">&quot;messages&quot;</span><span class="o">&gt;</span>
<a id="__codelineno-118-4" name="__codelineno-118-4"></a><span class="w">      </span><span class="o">&lt;</span><span class="nx">div</span><span class="w"> </span><span class="nx">v</span><span class="o">-</span><span class="k">for</span><span class="o">=</span><span class="s2">&quot;(msg, i) in messages&quot;</span><span class="w"> </span><span class="o">:</span><span class="nx">key</span><span class="o">=</span><span class="s2">&quot;i&quot;</span><span class="o">&gt;</span>
<a id="__codelineno-118-5" name="__codelineno-118-5"></a><span class="w">        </span><span class="o">&lt;</span><span class="nx">strong</span><span class="o">&gt;</span><span class="p">{{</span><span class="w"> </span><span class="nx">msg</span><span class="p">.</span><span class="nx">username</span><span class="w"> </span><span class="p">}}</span><span class="o">:&lt;</span><span class="err">/strong&gt; {{ msg.text }}</span>
<a id="__codelineno-118-6" name="__codelineno-118-6"></a><span class="w">      </span><span class="o">&lt;</span><span class="err">/div&gt;</span>
<a id="__codelineno-118-7" name="__codelineno-118-7"></a><span class="w">    </span><span class="o">&lt;</span><span class="err">/div&gt;</span>
<a id="__codelineno-118-8" name="__codelineno-118-8"></a><span class="w">    </span><span class="o">&lt;</span><span class="nx">input</span><span class="w"> </span><span class="nx">v</span><span class="o">-</span><span class="nx">model</span><span class="o">=</span><span class="s2">&quot;input&quot;</span><span class="w"> </span><span class="err">@</span><span class="nx">keyup</span><span class="p">.</span><span class="nx">enter</span><span class="o">=</span><span class="s2">&quot;sendMessage&quot;</span><span class="w"> </span><span class="nx">placeholder</span><span class="o">=</span><span class="s2">&quot;è¾“å…¥æ¶ˆæ¯...&quot;</span><span class="w"> </span><span class="o">/&gt;</span>
<a id="__codelineno-118-9" name="__codelineno-118-9"></a><span class="w">  </span><span class="o">&lt;</span><span class="err">/div&gt;</span>
<a id="__codelineno-118-10" name="__codelineno-118-10"></a><span class="o">&lt;</span><span class="err">/template&gt;</span>
<a id="__codelineno-118-11" name="__codelineno-118-11"></a>
<a id="__codelineno-118-12" name="__codelineno-118-12"></a><span class="o">&lt;</span><span class="nx">script</span><span class="w"> </span><span class="nx">setup</span><span class="o">&gt;</span>
<a id="__codelineno-118-13" name="__codelineno-118-13"></a><span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">ref</span><span class="p">,</span><span class="w"> </span><span class="nx">watch</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;vue&#39;</span>
<a id="__codelineno-118-14" name="__codelineno-118-14"></a><span class="kd">const</span><span class="w"> </span><span class="nx">props</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">defineProps</span><span class="p">([</span><span class="s1">&#39;username&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;socket&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;messages&#39;</span><span class="p">])</span>
<a id="__codelineno-118-15" name="__codelineno-118-15"></a>
<a id="__codelineno-118-16" name="__codelineno-118-16"></a><span class="kd">const</span><span class="w"> </span><span class="nx">input</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">ref</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
<a id="__codelineno-118-17" name="__codelineno-118-17"></a>
<a id="__codelineno-118-18" name="__codelineno-118-18"></a><span class="kd">function</span><span class="w"> </span><span class="nx">sendMessage</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-118-19" name="__codelineno-118-19"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">input</span><span class="p">.</span><span class="nx">value</span><span class="p">.</span><span class="nx">trim</span><span class="p">())</span><span class="w"> </span><span class="k">return</span>
<a id="__codelineno-118-20" name="__codelineno-118-20"></a><span class="w">  </span><span class="nx">props</span><span class="p">.</span><span class="nx">socket</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span>
<a id="__codelineno-118-21" name="__codelineno-118-21"></a><span class="w">    </span><span class="nb">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">({</span>
<a id="__codelineno-118-22" name="__codelineno-118-22"></a><span class="w">      </span><span class="nx">username</span><span class="o">:</span><span class="w"> </span><span class="nx">props</span><span class="p">.</span><span class="nx">username</span><span class="p">,</span>
<a id="__codelineno-118-23" name="__codelineno-118-23"></a><span class="w">      </span><span class="nx">text</span><span class="o">:</span><span class="w"> </span><span class="nx">input</span><span class="p">.</span><span class="nx">value</span><span class="p">,</span>
<a id="__codelineno-118-24" name="__codelineno-118-24"></a><span class="w">    </span><span class="p">})</span>
<a id="__codelineno-118-25" name="__codelineno-118-25"></a><span class="w">  </span><span class="p">)</span>
<a id="__codelineno-118-26" name="__codelineno-118-26"></a><span class="w">  </span><span class="nx">input</span><span class="p">.</span><span class="nx">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;&#39;</span>
<a id="__codelineno-118-27" name="__codelineno-118-27"></a><span class="p">}</span>
<a id="__codelineno-118-28" name="__codelineno-118-28"></a><span class="o">&lt;</span><span class="err">/script&gt;</span>
<a id="__codelineno-118-29" name="__codelineno-118-29"></a>
<a id="__codelineno-118-30" name="__codelineno-118-30"></a><span class="o">&lt;</span><span class="nx">style</span><span class="o">&gt;</span>
<a id="__codelineno-118-31" name="__codelineno-118-31"></a><span class="p">.</span><span class="nx">chat</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-118-32" name="__codelineno-118-32"></a><span class="w">  </span><span class="nx">border</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="nx">px</span><span class="w"> </span><span class="nx">solid</span><span class="w"> </span><span class="n">#ccc</span><span class="p">;</span>
<a id="__codelineno-118-33" name="__codelineno-118-33"></a><span class="w">  </span><span class="nx">padding</span><span class="o">:</span><span class="w"> </span><span class="mf">10</span><span class="nx">px</span><span class="p">;</span>
<a id="__codelineno-118-34" name="__codelineno-118-34"></a><span class="p">}</span>
<a id="__codelineno-118-35" name="__codelineno-118-35"></a><span class="p">.</span><span class="nx">messages</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-118-36" name="__codelineno-118-36"></a><span class="w">  </span><span class="nx">height</span><span class="o">:</span><span class="w"> </span><span class="mf">200</span><span class="nx">px</span><span class="p">;</span>
<a id="__codelineno-118-37" name="__codelineno-118-37"></a><span class="w">  </span><span class="nx">overflow</span><span class="o">-</span><span class="nx">y</span><span class="o">:</span><span class="w"> </span><span class="nx">auto</span><span class="p">;</span>
<a id="__codelineno-118-38" name="__codelineno-118-38"></a><span class="w">  </span><span class="nx">margin</span><span class="o">-</span><span class="nx">bottom</span><span class="o">:</span><span class="w"> </span><span class="mf">10</span><span class="nx">px</span><span class="p">;</span>
<a id="__codelineno-118-39" name="__codelineno-118-39"></a><span class="p">}</span>
<a id="__codelineno-118-40" name="__codelineno-118-40"></a><span class="o">&lt;</span><span class="err">/style&gt;</span>
</code></pre></div></td></tr></table></div>
<p><code>src/components/UserList.vue</code></p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">JavaScript</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-119-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-119-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-119-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-119-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-119-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-119-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-119-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-119-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-119-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-119-10">10</a></span>
<span class="normal"><a href="#__codelineno-119-11">11</a></span>
<span class="normal"><a href="#__codelineno-119-12">12</a></span>
<span class="normal"><a href="#__codelineno-119-13">13</a></span>
<span class="normal"><a href="#__codelineno-119-14">14</a></span>
<span class="normal"><a href="#__codelineno-119-15">15</a></span>
<span class="normal"><a href="#__codelineno-119-16">16</a></span>
<span class="normal"><a href="#__codelineno-119-17">17</a></span>
<span class="normal"><a href="#__codelineno-119-18">18</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-119-1" name="__codelineno-119-1"></a><span class="o">&lt;</span><span class="nx">template</span><span class="o">&gt;</span>
<a id="__codelineno-119-2" name="__codelineno-119-2"></a><span class="w">  </span><span class="o">&lt;</span><span class="nx">div</span><span class="w"> </span><span class="kd">class</span><span class="o">=</span><span class="s2">&quot;users&quot;</span><span class="o">&gt;</span>
<a id="__codelineno-119-3" name="__codelineno-119-3"></a><span class="w">  </span><span class="o">&lt;</span><span class="nx">h3</span><span class="o">&gt;</span><span class="nx">åœ¨çº¿ç”¨æˆ·</span><span class="o">&lt;</span><span class="err">/h3&gt;</span>
<a id="__codelineno-119-4" name="__codelineno-119-4"></a><span class="w">  </span><span class="o">&lt;</span><span class="nx">ul</span><span class="o">&gt;</span>
<a id="__codelineno-119-5" name="__codelineno-119-5"></a><span class="w">  </span><span class="o">&lt;</span><span class="nx">li</span><span class="w"> </span><span class="nx">v</span><span class="o">-</span><span class="k">for</span><span class="o">=</span><span class="s2">&quot;user in users&quot;</span><span class="w"> </span><span class="o">:</span><span class="nx">key</span><span class="o">=</span><span class="s2">&quot;user&quot;</span><span class="o">&gt;</span><span class="p">{{</span><span class="w"> </span><span class="nx">user</span><span class="w"> </span><span class="p">}}</span><span class="o">&lt;</span><span class="err">/li&gt;</span>
<a id="__codelineno-119-6" name="__codelineno-119-6"></a><span class="w">  </span><span class="o">&lt;</span><span class="err">/ul&gt;</span>
<a id="__codelineno-119-7" name="__codelineno-119-7"></a><span class="w">  </span><span class="o">&lt;</span><span class="err">/div&gt;</span>
<a id="__codelineno-119-8" name="__codelineno-119-8"></a><span class="w">  </span><span class="o">&lt;</span><span class="err">/template&gt;</span>
<a id="__codelineno-119-9" name="__codelineno-119-9"></a>
<a id="__codelineno-119-10" name="__codelineno-119-10"></a><span class="w">  </span><span class="o">&lt;</span><span class="nx">script</span><span class="w"> </span><span class="nx">setup</span><span class="o">&gt;</span>
<a id="__codelineno-119-11" name="__codelineno-119-11"></a><span class="w">  </span><span class="nx">defineProps</span><span class="p">([</span><span class="s1">&#39;users&#39;</span><span class="p">])</span>
<a id="__codelineno-119-12" name="__codelineno-119-12"></a><span class="w">  </span><span class="o">&lt;</span><span class="err">/script&gt;</span>
<a id="__codelineno-119-13" name="__codelineno-119-13"></a>
<a id="__codelineno-119-14" name="__codelineno-119-14"></a><span class="w">  </span><span class="o">&lt;</span><span class="nx">style</span><span class="o">&gt;</span>
<a id="__codelineno-119-15" name="__codelineno-119-15"></a><span class="w">  </span><span class="p">.</span><span class="nx">users</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-119-16" name="__codelineno-119-16"></a><span class="w">  </span><span class="nx">margin</span><span class="o">-</span><span class="nx">top</span><span class="o">:</span><span class="w"> </span><span class="mf">10</span><span class="nx">px</span><span class="p">;</span>
<a id="__codelineno-119-17" name="__codelineno-119-17"></a><span class="p">}</span>
<a id="__codelineno-119-18" name="__codelineno-119-18"></a><span class="o">&lt;</span><span class="err">/style&gt;</span>
</code></pre></div></td></tr></table></div>
<h2 id="openapi-å›è°ƒ">OpenAPI å›è°ƒ<a class="headerlink" href="#openapi-å›è°ƒ" title="Permanent link">&para;</a></h2>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">TOML</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-120-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-120-1" name="__codelineno-120-1"></a><span class="n">uv</span><span class="w"> </span><span class="n">add</span><span class="w"> </span><span class="n">fastapi</span><span class="err">&gt;</span><span class="o">=</span><span class="mf">0.115</span><span class="p">.</span><span class="n">12</span><span class="w">  </span><span class="c1">#äº²æµ‹ç‰ˆæœ¬éœ€è¦æ˜¯è¿™ä¸ªï¼Œå¦åˆ™å›è°ƒå‡½æ•°æ— æ³•é€‚é…æ–‡æ¡£è‡ªåŠ¨ç”Ÿæˆ</span>
</code></pre></div></td></tr></table></div>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">JavaScript</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-121-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-121-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-121-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-121-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-121-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-121-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-121-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-121-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-121-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-121-10">10</a></span>
<span class="normal"><a href="#__codelineno-121-11">11</a></span>
<span class="normal"><a href="#__codelineno-121-12">12</a></span>
<span class="normal"><a href="#__codelineno-121-13">13</a></span>
<span class="normal"><a href="#__codelineno-121-14">14</a></span>
<span class="normal"><a href="#__codelineno-121-15">15</a></span>
<span class="normal"><a href="#__codelineno-121-16">16</a></span>
<span class="normal"><a href="#__codelineno-121-17">17</a></span>
<span class="normal"><a href="#__codelineno-121-18">18</a></span>
<span class="normal"><a href="#__codelineno-121-19">19</a></span>
<span class="normal"><a href="#__codelineno-121-20">20</a></span>
<span class="normal"><a href="#__codelineno-121-21">21</a></span>
<span class="normal"><a href="#__codelineno-121-22">22</a></span>
<span class="normal"><a href="#__codelineno-121-23">23</a></span>
<span class="normal"><a href="#__codelineno-121-24">24</a></span>
<span class="normal"><a href="#__codelineno-121-25">25</a></span>
<span class="normal"><a href="#__codelineno-121-26">26</a></span>
<span class="normal"><a href="#__codelineno-121-27">27</a></span>
<span class="normal"><a href="#__codelineno-121-28">28</a></span>
<span class="normal"><a href="#__codelineno-121-29">29</a></span>
<span class="normal"><a href="#__codelineno-121-30">30</a></span>
<span class="normal"><a href="#__codelineno-121-31">31</a></span>
<span class="normal"><a href="#__codelineno-121-32">32</a></span>
<span class="normal"><a href="#__codelineno-121-33">33</a></span>
<span class="normal"><a href="#__codelineno-121-34">34</a></span>
<span class="normal"><a href="#__codelineno-121-35">35</a></span>
<span class="normal"><a href="#__codelineno-121-36">36</a></span>
<span class="normal"><a href="#__codelineno-121-37">37</a></span>
<span class="normal"><a href="#__codelineno-121-38">38</a></span>
<span class="normal"><a href="#__codelineno-121-39">39</a></span>
<span class="normal"><a href="#__codelineno-121-40">40</a></span>
<span class="normal"><a href="#__codelineno-121-41">41</a></span>
<span class="normal"><a href="#__codelineno-121-42">42</a></span>
<span class="normal"><a href="#__codelineno-121-43">43</a></span>
<span class="normal"><a href="#__codelineno-121-44">44</a></span>
<span class="normal"><a href="#__codelineno-121-45">45</a></span>
<span class="normal"><a href="#__codelineno-121-46">46</a></span>
<span class="normal"><a href="#__codelineno-121-47">47</a></span>
<span class="normal"><a href="#__codelineno-121-48">48</a></span>
<span class="normal"><a href="#__codelineno-121-49">49</a></span>
<span class="normal"><a href="#__codelineno-121-50">50</a></span>
<span class="normal"><a href="#__codelineno-121-51">51</a></span>
<span class="normal"><a href="#__codelineno-121-52">52</a></span>
<span class="normal"><a href="#__codelineno-121-53">53</a></span>
<span class="normal"><a href="#__codelineno-121-54">54</a></span>
<span class="normal"><a href="#__codelineno-121-55">55</a></span>
<span class="normal"><a href="#__codelineno-121-56">56</a></span>
<span class="normal"><a href="#__codelineno-121-57">57</a></span>
<span class="normal"><a href="#__codelineno-121-58">58</a></span>
<span class="normal"><a href="#__codelineno-121-59">59</a></span>
<span class="normal"><a href="#__codelineno-121-60">60</a></span>
<span class="normal"><a href="#__codelineno-121-61">61</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-121-1" name="__codelineno-121-1"></a><span class="kr">from</span><span class="w"> </span><span class="nx">typing</span><span class="w"> </span><span class="k">import</span><span class="w"> </span><span class="nx">Union</span>
<a id="__codelineno-121-2" name="__codelineno-121-2"></a><span class="kr">from</span><span class="w"> </span><span class="nx">fastapi</span><span class="w"> </span><span class="k">import</span><span class="w"> </span><span class="nx">FastAPI</span><span class="p">,</span><span class="w"> </span><span class="nx">APIRouter</span>
<a id="__codelineno-121-3" name="__codelineno-121-3"></a><span class="kr">from</span><span class="w"> </span><span class="nx">pydantic</span><span class="w"> </span><span class="k">import</span><span class="w"> </span><span class="nx">BaseModel</span><span class="p">,</span><span class="w"> </span><span class="nx">HttpUrl</span>
<a id="__codelineno-121-4" name="__codelineno-121-4"></a>
<a id="__codelineno-121-5" name="__codelineno-121-5"></a><span class="nx">app</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">FastAPI</span><span class="p">()</span>
<a id="__codelineno-121-6" name="__codelineno-121-6"></a><span class="nx">invoices_callback_router</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">APIRouter</span><span class="p">()</span>
<a id="__codelineno-121-7" name="__codelineno-121-7"></a>
<a id="__codelineno-121-8" name="__codelineno-121-8"></a><span class="err">#</span><span class="w"> </span><span class="nx">å®šä¹‰å‘ç¥¨æ¨¡å‹</span>
<a id="__codelineno-121-9" name="__codelineno-121-9"></a><span class="kd">class</span><span class="w"> </span><span class="nx">Invoice</span><span class="p">(</span><span class="nx">BaseModel</span><span class="p">)</span><span class="o">:</span>
<a id="__codelineno-121-10" name="__codelineno-121-10"></a><span class="w">    </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="nx">str</span>
<a id="__codelineno-121-11" name="__codelineno-121-11"></a><span class="w">    </span><span class="nx">customer</span><span class="o">:</span><span class="w"> </span><span class="nx">str</span>
<a id="__codelineno-121-12" name="__codelineno-121-12"></a><span class="w">    </span><span class="nx">total</span><span class="o">:</span><span class="w"> </span><span class="kr">float</span>
<a id="__codelineno-121-13" name="__codelineno-121-13"></a>
<a id="__codelineno-121-14" name="__codelineno-121-14"></a><span class="err">#</span><span class="w"> </span><span class="nx">å®šä¹‰å›è°ƒé€šçŸ¥çš„è¯·æ±‚ä½“æ¨¡å‹</span>
<a id="__codelineno-121-15" name="__codelineno-121-15"></a><span class="kd">class</span><span class="w"> </span><span class="nx">InvoiceEvent</span><span class="p">(</span><span class="nx">BaseModel</span><span class="p">)</span><span class="o">:</span>
<a id="__codelineno-121-16" name="__codelineno-121-16"></a><span class="w">    </span><span class="nx">description</span><span class="o">:</span><span class="w"> </span><span class="nx">str</span>
<a id="__codelineno-121-17" name="__codelineno-121-17"></a><span class="w">    </span><span class="nx">paid</span><span class="o">:</span><span class="w"> </span><span class="nx">bool</span>
<a id="__codelineno-121-18" name="__codelineno-121-18"></a>
<a id="__codelineno-121-19" name="__codelineno-121-19"></a><span class="err">#</span><span class="w"> </span><span class="nx">å®šä¹‰å›è°ƒé€šçŸ¥çš„å“åº”ä½“æ¨¡å‹</span>
<a id="__codelineno-121-20" name="__codelineno-121-20"></a><span class="kd">class</span><span class="w"> </span><span class="nx">InvoiceEventReceived</span><span class="p">(</span><span class="nx">BaseModel</span><span class="p">)</span><span class="o">:</span>
<a id="__codelineno-121-21" name="__codelineno-121-21"></a><span class="w">    </span><span class="nx">received</span><span class="o">:</span><span class="w"> </span><span class="nx">bool</span>
<a id="__codelineno-121-22" name="__codelineno-121-22"></a>
<a id="__codelineno-121-23" name="__codelineno-121-23"></a><span class="err">#</span><span class="w"> </span><span class="nx">å®šä¹‰å›è°ƒè·¯å¾„å’Œè¯·æ±‚ä½“</span>
<a id="__codelineno-121-24" name="__codelineno-121-24"></a><span class="err">@</span><span class="nx">invoices_callback_router</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span>
<a id="__codelineno-121-25" name="__codelineno-121-25"></a><span class="w">    </span><span class="s2">&quot;{$callback_url}/invoices/{$request.body.id}&quot;</span><span class="p">,</span>
<a id="__codelineno-121-26" name="__codelineno-121-26"></a><span class="w">    </span><span class="nx">response_model</span><span class="o">=</span><span class="nx">InvoiceEventReceived</span><span class="p">,</span>
<a id="__codelineno-121-27" name="__codelineno-121-27"></a><span class="p">)</span>
<a id="__codelineno-121-28" name="__codelineno-121-28"></a><span class="nx">def</span><span class="w"> </span><span class="nx">invoice_notification</span><span class="p">(</span><span class="nx">body</span><span class="o">:</span><span class="w"> </span><span class="nx">InvoiceEvent</span><span class="p">)</span><span class="o">:</span>
<a id="__codelineno-121-29" name="__codelineno-121-29"></a><span class="w">    </span><span class="s2">&quot;&quot;&quot;</span>
<a id="__codelineno-121-30" name="__codelineno-121-30"></a><span class="s2">    å›è°ƒé€šçŸ¥æ¥å£çš„å®šä¹‰ï¼Œç”¨äºæ–‡æ¡£å±•ç¤ºã€‚</span>
<a id="__codelineno-121-31" name="__codelineno-121-31"></a><span class="s2">    å®é™…ä¸ä¼šè¢«æœ¬æœåŠ¡è°ƒç”¨ï¼Œç”±å¤–éƒ¨æœåŠ¡å®ç°ã€‚</span>
<a id="__codelineno-121-32" name="__codelineno-121-32"></a><span class="s2">    &quot;&quot;&quot;</span>
<a id="__codelineno-121-33" name="__codelineno-121-33"></a><span class="w">    </span><span class="nx">pass</span>
<a id="__codelineno-121-34" name="__codelineno-121-34"></a>
<a id="__codelineno-121-35" name="__codelineno-121-35"></a><span class="err">#</span><span class="w"> </span><span class="nx">åˆ›å»ºå‘ç¥¨çš„ä¸»æ¥å£</span><span class="err">ï¼Œ</span><span class="nx">åŒ…å«å›è°ƒå®šä¹‰</span>
<a id="__codelineno-121-36" name="__codelineno-121-36"></a><span class="err">@</span><span class="nx">app</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s2">&quot;/invoices/&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">callbacks</span><span class="o">=</span><span class="nx">invoices_callback_router</span><span class="p">.</span><span class="nx">routes</span><span class="p">)</span>
<a id="__codelineno-121-37" name="__codelineno-121-37"></a><span class="nx">def</span><span class="w"> </span><span class="nx">create_invoice</span><span class="p">(</span><span class="nx">invoice</span><span class="o">:</span><span class="w"> </span><span class="nx">Invoice</span><span class="p">,</span><span class="w"> </span><span class="nx">callback_url</span><span class="o">:</span><span class="w"> </span><span class="nx">Union</span><span class="p">[</span><span class="nx">HttpUrl</span><span class="p">,</span><span class="w"> </span><span class="nx">None</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">None</span><span class="p">)</span><span class="o">:</span>
<a id="__codelineno-121-38" name="__codelineno-121-38"></a><span class="w">    </span><span class="s2">&quot;&quot;&quot;</span>
<a id="__codelineno-121-39" name="__codelineno-121-39"></a><span class="s2">    åˆ›å»ºå‘ç¥¨çš„æ¥å£ã€‚</span>
<a id="__codelineno-121-40" name="__codelineno-121-40"></a>
<a id="__codelineno-121-41" name="__codelineno-121-41"></a><span class="s2">    å‚æ•°:</span>
<a id="__codelineno-121-42" name="__codelineno-121-42"></a><span class="s2">    - invoice: å‘ç¥¨ä¿¡æ¯</span>
<a id="__codelineno-121-43" name="__codelineno-121-43"></a><span class="s2">    - callback_url: ç”¨æˆ·æä¾›çš„å›è°ƒåœ°å€</span>
<a id="__codelineno-121-44" name="__codelineno-121-44"></a>
<a id="__codelineno-121-45" name="__codelineno-121-45"></a><span class="s2">    æµç¨‹:</span>
<a id="__codelineno-121-46" name="__codelineno-121-46"></a><span class="s2">    1. æ¥æ”¶å‘ç¥¨ä¿¡æ¯</span>
<a id="__codelineno-121-47" name="__codelineno-121-47"></a><span class="s2">    2. å¤„ç†å‘ç¥¨ï¼ˆä¾‹å¦‚ï¼Œå‘é€ç»™å®¢æˆ·ã€æ”¶æ¬¾ç­‰ï¼‰</span>
<a id="__codelineno-121-48" name="__codelineno-121-48"></a><span class="s2">    3. å‘ç”¨æˆ·æä¾›çš„å›è°ƒåœ°å€å‘é€é€šçŸ¥</span>
<a id="__codelineno-121-49" name="__codelineno-121-49"></a><span class="s2">    &quot;&quot;&quot;</span>
<a id="__codelineno-121-50" name="__codelineno-121-50"></a><span class="w">    </span><span class="err">#</span><span class="w"> </span><span class="nx">å®é™…å¤„ç†é€»è¾‘çœç•¥</span>
<a id="__codelineno-121-51" name="__codelineno-121-51"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">{</span><span class="s2">&quot;message&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Invoice created successfully&quot;</span><span class="p">}</span>
<a id="__codelineno-121-52" name="__codelineno-121-52"></a>
<a id="__codelineno-121-53" name="__codelineno-121-53"></a>
<a id="__codelineno-121-54" name="__codelineno-121-54"></a>
<a id="__codelineno-121-55" name="__codelineno-121-55"></a><span class="k">if</span><span class="w"> </span><span class="nx">__name__</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;__main__&#39;</span><span class="o">:</span>
<a id="__codelineno-121-56" name="__codelineno-121-56"></a><span class="w">    </span><span class="k">import</span><span class="w"> </span><span class="nx">uvicorn</span>
<a id="__codelineno-121-57" name="__codelineno-121-57"></a><span class="w">    </span><span class="k">import</span><span class="w"> </span><span class="nx">os</span>
<a id="__codelineno-121-58" name="__codelineno-121-58"></a>
<a id="__codelineno-121-59" name="__codelineno-121-59"></a><span class="w">    </span><span class="nx">app_model_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">os</span><span class="p">.</span><span class="nx">path</span><span class="p">.</span><span class="nx">basename</span><span class="p">(</span><span class="nx">__file__</span><span class="p">).</span><span class="nx">replace</span><span class="p">(</span><span class="s2">&quot;.py&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="p">)</span>
<a id="__codelineno-121-60" name="__codelineno-121-60"></a><span class="w">    </span><span class="nx">print</span><span class="p">(</span><span class="nx">app_model_name</span><span class="p">)</span>
<a id="__codelineno-121-61" name="__codelineno-121-61"></a><span class="w">    </span><span class="nx">uvicorn</span><span class="p">.</span><span class="nx">run</span><span class="p">(</span><span class="nx">f</span><span class="s2">&quot;{app_model_name}:app&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">host</span><span class="o">=</span><span class="s1">&#39;127.0.0.1&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">reload</span><span class="o">=</span><span class="nx">True</span><span class="p">,</span><span class="nx">port</span><span class="o">=</span><span class="mf">12345</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
<h2 id="webhook"><font style="color:rgba(0, 0, 0, 0.87);">Webhook</font><a class="headerlink" href="#webhook" title="Permanent link">&para;</a></h2>
<h3 id="webhookæ˜¯ä»€ä¹ˆ"><font style="color:rgba(0, 0, 0, 0.87);">Webhook</font>æ˜¯ä»€ä¹ˆ<a class="headerlink" href="#webhookæ˜¯ä»€ä¹ˆ" title="Permanent link">&para;</a></h3>
<ul>
<li><strong>ç›´è§‚æ¯”å–»</strong><br />
æŠŠ Webhook æƒ³è±¡æˆâ€œäº‹ä»¶çš„é‚®é€’å‘˜â€ï¼šå½“ A ç³»ç»Ÿå‘ç”ŸæŸä»¶äº‹ï¼ˆæ¯”å¦‚ç”¨æˆ·ä¸‹å•ã€æ–‡ä»¶ä¸Šä¼ ã€æ”¯ä»˜æˆåŠŸï¼‰æ—¶ï¼Œå°±ä¼šæŠŠç›¸å…³ä¿¡æ¯ã€Œä¸»åŠ¨ã€æ¨é€ï¼ˆPOSTï¼‰ç»™ä½ é¢„å…ˆç•™å¥½çš„ç½‘å€ï¼ˆcallback URLï¼‰ã€‚</li>
<li><strong>ä¸è½®è¯¢çš„åŒºåˆ«</strong><ul>
<li>è½®è¯¢ï¼ˆPollingï¼‰ï¼šä½ ä¸åœåœ°å»é—® A ç³»ç»Ÿ â€œç°åœ¨æœ‰æ–°äº‹ä»¶æ²¡ï¼Ÿâ€ã€‚</li>
<li>Webhookï¼šA ç³»ç»Ÿè‡ªå·±ä¼šâ€œæ•²é—¨â€é€šçŸ¥ä½ ï¼Œä¸éœ€è¦ä½ å»æ‰“å¬ï¼Œçœæ—¶çœèµ„æºã€‚</li>
</ul>
</li>
</ul>
<h3 id="ä½¿ç”¨åœºæ™¯">ä½¿ç”¨åœºæ™¯<a class="headerlink" href="#ä½¿ç”¨åœºæ™¯" title="Permanent link">&para;</a></h3>
<ol>
<li><strong>æ”¯ä»˜é€šçŸ¥</strong><ul>
<li>æ”¯ä»˜å¹³å°ï¼ˆå¦‚ Stripeã€PayPalï¼‰åœ¨ç”¨æˆ·å®Œæˆä»˜æ¬¾åï¼Œå‘å•†æˆ·ç³»ç»Ÿçš„ Webhook URL å‘é€šçŸ¥ï¼Œå‘ŠçŸ¥æ”¯ä»˜ç»“æœã€‚</li>
</ul>
</li>
<li><strong>æŒç»­é›†æˆ/éƒ¨ç½²ï¼ˆCI/CDï¼‰</strong><ul>
<li>GitHubã€GitLab åœ¨æœ‰æ–°æäº¤æˆ–åˆå¹¶è¯·æ±‚æ—¶ï¼Œé€šè¿‡ Webhook é€šçŸ¥ Jenkinsã€GitHub Actions ç­‰è‡ªåŠ¨è·‘æµ‹è¯•ã€éƒ¨ç½²ã€‚</li>
</ul>
</li>
<li><strong>èŠå¤©æœºå™¨äºº</strong><ul>
<li>å½“ Slackã€é’‰é’‰ä¸­æœ‰äºº@æœºå™¨äººæ—¶ï¼Œå®ƒä¼šæŠŠæ¶ˆæ¯å‘åˆ°ä½ çš„ Webhookï¼Œä½ å†æ ¹æ®å†…å®¹åšæ™ºèƒ½å›å¤ã€‚</li>
</ul>
</li>
<li><strong>ç¬¬ä¸‰æ–¹æœåŠ¡é€šçŸ¥</strong><ul>
<li>å¦‚è®¢å•ç³»ç»Ÿã€æ–°ç”¨æˆ·æ³¨å†Œã€ç›‘æ§å‘Šè­¦ç­‰ï¼ŒæŠŠäº‹ä»¶ç¬¬ä¸€æ—¶é—´æ¨é€ç»™ä½ çš„åå°æˆ–æ¶ˆæ¯ä¸­å¿ƒï¼Œè§¦å‘åç»­å¤„ç†ã€‚</li>
</ul>
</li>
</ol>
<h3 id="å‚è€ƒä»£ç ">å‚è€ƒä»£ç <a class="headerlink" href="#å‚è€ƒä»£ç " title="Permanent link">&para;</a></h3>
<p>æ¯”å¦‚æ”¯ä»˜æ—¶ï¼Œéœ€è¦æä¾›ç»™åœ¨å¾®ä¿¡æˆ–è€…æ”¯ä»˜å®é…ç½®çš„webhookï¼Œæ ¹æ®è¿”å›æ‰çŸ¥é“æ”¯ä»˜çš„æˆåŠŸå’Œå¤±è´¥ï¼Œå¹¶ä¸”éœ€è¦æ£€éªŒç­¾åï¼Œä»¥æ­¤æ¥åˆ¤æ–­webhookçš„å›è°ƒæ˜¯å¦åˆæ³•ã€‚</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Python</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-122-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-122-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-122-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-122-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-122-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-122-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-122-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-122-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-122-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-122-10">10</a></span>
<span class="normal"><a href="#__codelineno-122-11">11</a></span>
<span class="normal"><a href="#__codelineno-122-12">12</a></span>
<span class="normal"><a href="#__codelineno-122-13">13</a></span>
<span class="normal"><a href="#__codelineno-122-14">14</a></span>
<span class="normal"><a href="#__codelineno-122-15">15</a></span>
<span class="normal"><a href="#__codelineno-122-16">16</a></span>
<span class="normal"><a href="#__codelineno-122-17">17</a></span>
<span class="normal"><a href="#__codelineno-122-18">18</a></span>
<span class="normal"><a href="#__codelineno-122-19">19</a></span>
<span class="normal"><a href="#__codelineno-122-20">20</a></span>
<span class="normal"><a href="#__codelineno-122-21">21</a></span>
<span class="normal"><a href="#__codelineno-122-22">22</a></span>
<span class="normal"><a href="#__codelineno-122-23">23</a></span>
<span class="normal"><a href="#__codelineno-122-24">24</a></span>
<span class="normal"><a href="#__codelineno-122-25">25</a></span>
<span class="normal"><a href="#__codelineno-122-26">26</a></span>
<span class="normal"><a href="#__codelineno-122-27">27</a></span>
<span class="normal"><a href="#__codelineno-122-28">28</a></span>
<span class="normal"><a href="#__codelineno-122-29">29</a></span>
<span class="normal"><a href="#__codelineno-122-30">30</a></span>
<span class="normal"><a href="#__codelineno-122-31">31</a></span>
<span class="normal"><a href="#__codelineno-122-32">32</a></span>
<span class="normal"><a href="#__codelineno-122-33">33</a></span>
<span class="normal"><a href="#__codelineno-122-34">34</a></span>
<span class="normal"><a href="#__codelineno-122-35">35</a></span>
<span class="normal"><a href="#__codelineno-122-36">36</a></span>
<span class="normal"><a href="#__codelineno-122-37">37</a></span>
<span class="normal"><a href="#__codelineno-122-38">38</a></span>
<span class="normal"><a href="#__codelineno-122-39">39</a></span>
<span class="normal"><a href="#__codelineno-122-40">40</a></span>
<span class="normal"><a href="#__codelineno-122-41">41</a></span>
<span class="normal"><a href="#__codelineno-122-42">42</a></span>
<span class="normal"><a href="#__codelineno-122-43">43</a></span>
<span class="normal"><a href="#__codelineno-122-44">44</a></span>
<span class="normal"><a href="#__codelineno-122-45">45</a></span>
<span class="normal"><a href="#__codelineno-122-46">46</a></span>
<span class="normal"><a href="#__codelineno-122-47">47</a></span>
<span class="normal"><a href="#__codelineno-122-48">48</a></span>
<span class="normal"><a href="#__codelineno-122-49">49</a></span>
<span class="normal"><a href="#__codelineno-122-50">50</a></span>
<span class="normal"><a href="#__codelineno-122-51">51</a></span>
<span class="normal"><a href="#__codelineno-122-52">52</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-122-1" name="__codelineno-122-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">fastapi</span><span class="w"> </span><span class="kn">import</span> <span class="n">FastAPI</span><span class="p">,</span> <span class="n">Request</span><span class="p">,</span> <span class="n">HTTPException</span>
<a id="__codelineno-122-2" name="__codelineno-122-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">pydantic</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseModel</span>
<a id="__codelineno-122-3" name="__codelineno-122-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">hmac</span>
<a id="__codelineno-122-4" name="__codelineno-122-4"></a><span class="kn">import</span><span class="w"> </span><span class="nn">hashlib</span>
<a id="__codelineno-122-5" name="__codelineno-122-5"></a>
<a id="__codelineno-122-6" name="__codelineno-122-6"></a><span class="n">app</span> <span class="o">=</span> <span class="n">FastAPI</span><span class="p">()</span>
<a id="__codelineno-122-7" name="__codelineno-122-7"></a>
<a id="__codelineno-122-8" name="__codelineno-122-8"></a><span class="c1"># ç”¨äºéªŒè¯Webhookç­¾åçš„å¯†é’¥</span>
<a id="__codelineno-122-9" name="__codelineno-122-9"></a><span class="n">WEBHOOK_SECRET</span> <span class="o">=</span> <span class="s2">&quot;your-webhook-secret&quot;</span>
<a id="__codelineno-122-10" name="__codelineno-122-10"></a>
<a id="__codelineno-122-11" name="__codelineno-122-11"></a><span class="c1"># å®šä¹‰æ”¯ä»˜äº‹ä»¶çš„æ•°æ®æ¨¡å‹</span>
<a id="__codelineno-122-12" name="__codelineno-122-12"></a><span class="k">class</span><span class="w"> </span><span class="nc">PaymentEvent</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
<a id="__codelineno-122-13" name="__codelineno-122-13"></a>    <span class="n">payment_id</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-122-14" name="__codelineno-122-14"></a>    <span class="n">status</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-122-15" name="__codelineno-122-15"></a>    <span class="n">amount</span><span class="p">:</span> <span class="nb">float</span>
<a id="__codelineno-122-16" name="__codelineno-122-16"></a>    <span class="n">currency</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-122-17" name="__codelineno-122-17"></a>
<a id="__codelineno-122-18" name="__codelineno-122-18"></a><span class="c1"># Webhookç«¯ç‚¹ï¼Œæ¥æ”¶æ”¯ä»˜é€šçŸ¥</span>
<a id="__codelineno-122-19" name="__codelineno-122-19"></a><span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/webhooks/payment&quot;</span><span class="p">)</span>
<a id="__codelineno-122-20" name="__codelineno-122-20"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">payment_webhook</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">,</span> <span class="n">event</span><span class="p">:</span> <span class="n">PaymentEvent</span><span class="p">):</span>
<a id="__codelineno-122-21" name="__codelineno-122-21"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-122-22" name="__codelineno-122-22"></a><span class="sd">    æ¥æ”¶å¹¶å¤„ç†æ¥è‡ªæ”¯ä»˜å¹³å°çš„æ”¯ä»˜é€šçŸ¥ã€‚</span>
<a id="__codelineno-122-23" name="__codelineno-122-23"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-122-24" name="__codelineno-122-24"></a>    <span class="c1"># ä»è¯·æ±‚å¤´ä¸­æå–ç­¾å</span>
<a id="__codelineno-122-25" name="__codelineno-122-25"></a>    <span class="n">signature</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;X-Signature&quot;</span><span class="p">)</span>
<a id="__codelineno-122-26" name="__codelineno-122-26"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">signature</span><span class="p">:</span>
<a id="__codelineno-122-27" name="__codelineno-122-27"></a>        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;ç¼ºå°‘ç­¾å&quot;</span><span class="p">)</span>
<a id="__codelineno-122-28" name="__codelineno-122-28"></a>
<a id="__codelineno-122-29" name="__codelineno-122-29"></a>    <span class="c1"># ä½¿ç”¨HMAC-SHA256éªŒè¯ç­¾å</span>
<a id="__codelineno-122-30" name="__codelineno-122-30"></a>    <span class="n">body</span> <span class="o">=</span> <span class="k">await</span> <span class="n">request</span><span class="o">.</span><span class="n">body</span><span class="p">()</span>
<a id="__codelineno-122-31" name="__codelineno-122-31"></a>    <span class="n">expected_signature</span> <span class="o">=</span> <span class="n">hmac</span><span class="o">.</span><span class="n">new</span><span class="p">(</span>
<a id="__codelineno-122-32" name="__codelineno-122-32"></a>        <span class="n">WEBHOOK_SECRET</span><span class="o">.</span><span class="n">encode</span><span class="p">(),</span>
<a id="__codelineno-122-33" name="__codelineno-122-33"></a>        <span class="n">body</span><span class="p">,</span>
<a id="__codelineno-122-34" name="__codelineno-122-34"></a>        <span class="n">hashlib</span><span class="o">.</span><span class="n">sha256</span>
<a id="__codelineno-122-35" name="__codelineno-122-35"></a>    <span class="p">)</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>
<a id="__codelineno-122-36" name="__codelineno-122-36"></a>
<a id="__codelineno-122-37" name="__codelineno-122-37"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">hmac</span><span class="o">.</span><span class="n">compare_digest</span><span class="p">(</span><span class="n">signature</span><span class="p">,</span> <span class="n">expected_signature</span><span class="p">):</span>
<a id="__codelineno-122-38" name="__codelineno-122-38"></a>        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">403</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;ç­¾åæ— æ•ˆ&quot;</span><span class="p">)</span>
<a id="__codelineno-122-39" name="__codelineno-122-39"></a>
<a id="__codelineno-122-40" name="__codelineno-122-40"></a>    <span class="c1"># å¤„ç†æ”¯ä»˜äº‹ä»¶</span>
<a id="__codelineno-122-41" name="__codelineno-122-41"></a>    <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="s2">&quot;completed&quot;</span><span class="p">:</span>
<a id="__codelineno-122-42" name="__codelineno-122-42"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;æ”¯ä»˜ </span><span class="si">{</span><span class="n">event</span><span class="o">.</span><span class="n">payment_id</span><span class="si">}</span><span class="s2"> å®Œæˆ: </span><span class="si">{</span><span class="n">event</span><span class="o">.</span><span class="n">amount</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">event</span><span class="o">.</span><span class="n">currency</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-122-43" name="__codelineno-122-43"></a>    <span class="k">elif</span> <span class="n">event</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="s2">&quot;failed&quot;</span><span class="p">:</span>
<a id="__codelineno-122-44" name="__codelineno-122-44"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;æ”¯ä»˜ </span><span class="si">{</span><span class="n">event</span><span class="o">.</span><span class="n">payment_id</span><span class="si">}</span><span class="s2"> å¤±è´¥&quot;</span><span class="p">)</span>
<a id="__codelineno-122-45" name="__codelineno-122-45"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-122-46" name="__codelineno-122-46"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;æœªçŸ¥çš„æ”¯ä»˜çŠ¶æ€: </span><span class="si">{</span><span class="n">event</span><span class="o">.</span><span class="n">status</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-122-47" name="__codelineno-122-47"></a>
<a id="__codelineno-122-48" name="__codelineno-122-48"></a>    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;received&quot;</span><span class="p">}</span>
<a id="__codelineno-122-49" name="__codelineno-122-49"></a>
<a id="__codelineno-122-50" name="__codelineno-122-50"></a><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
<a id="__codelineno-122-51" name="__codelineno-122-51"></a>    <span class="kn">import</span><span class="w"> </span><span class="nn">uvicorn</span>
<a id="__codelineno-122-52" name="__codelineno-122-52"></a>    <span class="n">uvicorn</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="n">host</span><span class="o">=</span><span class="s2">&quot;127.0.0.1&quot;</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">8000</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  å›åˆ°é¡µé¢é¡¶éƒ¨
</button>
        
      </main>
      
        <footer class="md-footer">
  
    
      
      <nav class="md-footer__inner md-grid" aria-label="é¡µè„š" >
        
          
          <a href="../FastAPI%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5/" class="md-footer__link md-footer__link--prev" aria-label="ä¸Šä¸€é¡µ: FastAPIæœ€ä½³å®è·µ">
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
            </div>
            <div class="md-footer__title">
              <span class="md-footer__direction">
                ä¸Šä¸€é¡µ
              </span>
              <div class="md-ellipsis">
                FastAPIæœ€ä½³å®è·µ
              </div>
            </div>
          </a>
        
        
          
          <a href="../Fastapi%E6%89%93%E5%8C%85exe%E5%92%8Cvue%E6%89%93%E5%8C%85/" class="md-footer__link md-footer__link--next" aria-label="ä¸‹ä¸€é¡µ: Fastapiæ‰“åŒ…exeå’Œvueæ‰“åŒ…">
            <div class="md-footer__title">
              <span class="md-footer__direction">
                ä¸‹ä¸€é¡µ
              </span>
              <div class="md-ellipsis">
                Fastapiæ‰“åŒ…exeå’Œvueæ‰“åŒ…
              </div>
            </div>
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11z"/></svg>
            </div>
          </a>
        
      </nav>
    
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy; 2025 æçƒ¨æ ‹
    </div>
  
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../../../..", "features": ["header.autohide", "announce.dismiss", "navigation.instant", "navigation.tracking", "content.code.annotate", "toc.integrate", "toc.follow", "navigation.path", "navigation.top", "navigation.tabs", "navigation.prune", "navigation.footer", "navigation.tabs.sticky", "navigation.sections", "navigation.expand", "content.code.copy", "navigation.indexes", "search.share", "search.suggest", "search.highlight"], "search": "../../../../assets/javascripts/workers/search.f8cc74c7.min.js", "translations": {"clipboard.copied": "\u5df2\u590d\u5236", "clipboard.copy": "\u590d\u5236", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.term.missing": "\u7f3a\u5c11", "select.version": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}}</script>
    
    
      <script src="../../../../assets/javascripts/bundle.c8b220af.min.js"></script>
      
    
  </body>
</html>