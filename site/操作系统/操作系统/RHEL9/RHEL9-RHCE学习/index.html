
<!doctype html>
<html lang="zh" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="美少男">
      
      
        <meta name="author" content="李烨栋">
      
      
        <link rel="canonical" href="https://li-ye-dong.github.io/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/RHEL9/RHEL9-RHCE%E5%AD%A6%E4%B9%A0/">
      
      
        <link rel="prev" href="../../%E7%BD%91%E7%BB%9C%E7%AE%A1%E7%90%86/">
      
      
        <link rel="next" href="../RHEL9-RHCSA%E5%AD%A6%E4%B9%A0/">
      
      
      <link rel="icon" href="../../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.7">
    
    
      
        <title>部署ansible - 李烨栋的博客</title>
      
    
    
      <link rel="stylesheet" href="../../../../assets/stylesheets/main.8608ea7d.min.css">
      
        
        <link rel="stylesheet" href="../../../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
    
    
      <link rel="stylesheet" href="../../../../static/stylesheets/google_font.css">
    
    <script>__md_scope=new URL("../../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="green" data-md-color-accent="green">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#部署ansible" class="md-skip">
          跳转至
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow md-header--lifted" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="页眉">
    <a href="../../../.." title="李烨栋的博客" class="md-header__button md-logo" aria-label="李烨栋的博客" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            李烨栋的博客
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              部署ansible
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="green" data-md-color-accent="green"  aria-label="日间模式"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="日间模式" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="blue" data-md-color-accent="blue"  aria-label="夜间模式"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="夜间模式" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="搜索" placeholder="搜索" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="查找">
        
          <a href="javascript:void(0)" class="md-search__icon md-icon" title="分享" aria-label="分享" data-clipboard data-clipboard-text="" data-md-component="search-share" tabindex="-1">
            
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91s2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08"/></svg>
          </a>
        
        <button type="reset" class="md-search__icon md-icon" title="清空当前内容" aria-label="清空当前内容" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            正在初始化搜索引擎
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/li-ye-dong/liyedong.github.io.git" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    li-ye-dong.github.io
  </div>
</a>
      </div>
    
  </nav>
  
    
      
<nav class="md-tabs" aria-label="标签" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../../.." class="md-tabs__link">
        
  
    
  
  知识库索引

      </a>
    </li>
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../../PDF%E7%AC%94%E8%AE%B0/" class="md-tabs__link">
          
  
    
  
  PDF笔记

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../../k8s%E5%92%8C%E5%AE%B9%E5%99%A8/KubeSphere%E4%BD%93%E9%AA%8C/" class="md-tabs__link">
          
  
    
  
  K8s和容器

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../../%E4%B8%AD%E9%97%B4%E4%BB%B6/Nginx/Nginx%E5%AD%A6%E4%B9%A0/" class="md-tabs__link">
          
  
    
  
  中间件

        </a>
      </li>
    
  

    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../../%E5%88%86%E4%BA%AB/1.ai%E6%95%B0%E5%AD%97%E4%BA%BA/" class="md-tabs__link">
          
  
    
  
  分享

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../../%E5%AE%89%E5%85%A8/Burp%20Suite%E6%8A%93%E5%8C%85%E5%B7%A5%E5%85%B7/" class="md-tabs__link">
          
  
    
  
  安全

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../../%E5%B7%A5%E5%85%B7%E4%BD%BF%E7%94%A8/2024%E5%B9%B46%E6%9C%88%E6%80%BB%E7%BB%93/" class="md-tabs__link">
          
  
    
  
  工具使用

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../../%E5%BC%80%E5%8F%91/FastApi%E5%AD%A6%E4%B9%A0/" class="md-tabs__link">
          
  
    
  
  开发

        </a>
      </li>
    
  

      
        
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../../../windows%E6%96%87%E4%BB%B6%E5%A4%8D%E5%88%B6%E5%B8%A6%E6%9D%83%E9%99%90/" class="md-tabs__link">
          
  
    
  
  操作系统

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../../%E6%95%B0%E6%8D%AE%E5%BA%93%E7%AC%94%E8%AE%B0/MongoDB/MongoDB%20%E6%95%B0%E6%8D%AE%E4%B8%80%E8%87%B4%E6%80%A7%E5%92%8C%E9%9A%94%E7%A6%BB/" class="md-tabs__link">
          
  
    
  
  数据库笔记

        </a>
      </li>
    
  

    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../../%E6%B5%8F%E8%A7%88%E5%99%A8%E4%B9%A6%E7%AD%BE%E6%94%B6%E8%97%8F/%E5%AE%89%E5%A8%9C%E6%A1%A3%E6%A1%88%E5%AF%86%E9%92%A5/" class="md-tabs__link">
          
  
    
  
  浏览器书签收藏

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../../%E7%9B%91%E6%8E%A7/%E7%9B%91%E6%8E%A7/zabbix%E7%9B%91%E6%8E%A7vsphere%E5%91%8A%E8%AD%A6/" class="md-tabs__link">
          
  
    
  
  监控

        </a>
      </li>
    
  

    
  

      
        
  
  
  
    
    
      
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../../%E8%99%9A%E6%8B%9F%E5%8C%96/%E8%99%9A%E6%8B%9F%E5%8C%96/RVtools%E4%BD%BF%E7%94%A8/" class="md-tabs__link">
          
  
    
  
  虚拟化

        </a>
      </li>
    
  

    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../../%E8%AE%A4%E8%AF%81%E7%9B%B8%E5%85%B3/credly%E6%9F%A5%E7%9C%8B%E5%8B%8B%E7%AB%A0/" class="md-tabs__link">
          
  
    
  
  认证相关

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
    
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


  

<nav class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" aria-label="导航栏" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../../.." title="李烨栋的博客" class="md-nav__button md-logo" aria-label="李烨栋的博客" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    李烨栋的博客
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/li-ye-dong/liyedong.github.io.git" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    li-ye-dong.github.io
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    知识库索引
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
    
    
      
      
        
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../../../PDF%E7%AC%94%E8%AE%B0/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    PDF笔记
    
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
        
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../../../k8s%E5%92%8C%E5%AE%B9%E5%99%A8/KubeSphere%E4%BD%93%E9%AA%8C/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    K8s和容器
    
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
    
    
      
      
        
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    
  
  
    <a href="../../../../%E4%B8%AD%E9%97%B4%E4%BB%B6/Nginx/Nginx%E5%AD%A6%E4%B9%A0/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    中间件
    
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

  

      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
        
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../../../%E5%88%86%E4%BA%AB/1.ai%E6%95%B0%E5%AD%97%E4%BA%BA/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    分享
    
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
    
    
      
      
        
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../../../%E5%AE%89%E5%85%A8/Burp%20Suite%E6%8A%93%E5%8C%85%E5%B7%A5%E5%85%B7/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    安全
    
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
        
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../../../%E5%B7%A5%E5%85%B7%E4%BD%BF%E7%94%A8/2024%E5%B9%B46%E6%9C%88%E6%80%BB%E7%BB%93/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    工具使用
    
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
        
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../../../%E5%BC%80%E5%8F%91/FastApi%E5%AD%A6%E4%B9%A0/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    开发
    
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
      
        
      
        
      
        
      
    
    
      
        
        
      
      
        
      
    
    
      
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_9" checked>
        
          
          <label class="md-nav__link" for="__nav_9" id="__nav_9_label" tabindex="">
            
  
  <span class="md-ellipsis">
    操作系统
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_9_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_9">
            <span class="md-nav__icon md-icon"></span>
            操作系统
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../windows%E6%96%87%E4%BB%B6%E5%A4%8D%E5%88%B6%E5%B8%A6%E6%9D%83%E9%99%90/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Windows文件复制带权限
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
        
          
          
        
      
    
    
      
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_9_2" checked>
        
          
          <label class="md-nav__link" for="__nav_9_2" id="__nav_9_2_label" tabindex="">
            
  
  <span class="md-ellipsis">
    操作系统
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_9_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_9_2">
            <span class="md-nav__icon md-icon"></span>
            操作系统
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../AD%E5%9F%9F%E6%8E%A7%E6%9E%B6%E6%9E%84%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    AD域控架构最佳实践
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Centos8%E5%AD%A6%E4%B9%A0/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Centos8学习
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Centos%E5%AE%89%E8%A3%85docker%E5%92%8Cpodman/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Centos安装docker和podman
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Linux%E6%A8%A1%E6%9D%BF%E4%BC%98%E5%8C%96/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    系统安装
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../RHEL8%E6%90%AD%E5%BB%BAdns%E6%9C%8D%E5%8A%A1/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    架构设计
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Ubuntu%E5%AE%89%E8%A3%85/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Ubuntu安装
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Ubuntu%E5%AE%89%E8%A3%85docker%E5%92%8Cpodman/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Ubuntu安装docker和podman
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Windows%20AD%E5%9F%9F%E7%8E%AF%E5%A2%83%E4%B8%AD%E4%BA%94%E5%A4%A7%E4%B8%BB%E6%9C%BA%E8%A7%92%E8%89%B2/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Windows AD域环境中五大主机角色
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../docker%E5%AE%89%E8%A3%85MongoDB/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    docker安装MongoDB
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../docker%E5%AE%89%E8%A3%85chemex/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Docker安装chemex
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../docker%E5%AE%89%E8%A3%85mysql/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Docker安装mysql
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../docker%E5%AE%89%E8%A3%85snipe-IT/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    docker安装snipe IT
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../lshell%E5%91%BD%E4%BB%A4%E7%AE%A1%E6%8E%A7/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    lshell（管理用户只能使用某些命令）
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../windows%E6%97%A0%E6%95%88%E5%9F%9F%E6%8E%A7%E6%B8%85%E9%99%A4/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Windows无效域控清除
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../windows%E6%A8%A1%E6%9D%BF/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    1.关闭防火墙和设置远程桌面的服务端口和关闭windows自动更新和设置ntp
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../%E5%AE%89%E8%A3%85lnmp%E7%8E%AF%E5%A2%83/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    安装lnmp环境
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../%E7%BD%91%E7%BB%9C%E7%AE%A1%E7%90%86/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    网络管理
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    
    
      
        
      
        
      
    
    
      
      
        
      
    
    
      
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_9_2_18" checked>
        
          
          <label class="md-nav__link" for="__nav_9_2_18" id="__nav_9_2_18_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    RHEL9
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_9_2_18_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_9_2_18">
            <span class="md-nav__icon md-icon"></span>
            RHEL9
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    部署ansible
    
  </span>
  

      </a>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../RHEL9-RHCSA%E5%AD%A6%E4%B9%A0/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    文件目录
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
    
    
      
      
        
          
          
        
      
    
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_9_3" >
        
          
          <label class="md-nav__link" for="__nav_9_3" id="__nav_9_3_label" tabindex="">
            
  
  <span class="md-ellipsis">
    计算机维护
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_9_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_9_3">
            <span class="md-nav__icon md-icon"></span>
            计算机维护
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%B4%E6%8A%A4/ventoy%E5%90%AF%E5%8A%A8%E5%A4%B1%E8%B4%A5%E3%80%82/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Ventoy启动失败。
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%B4%E6%8A%A4/ventoy%E5%90%AF%E5%8A%A8%E7%9B%98%E5%88%B6%E4%BD%9C/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Ventoy启动盘制作
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%B4%E6%8A%A4/%E5%90%84%E5%93%81%E7%89%8C%E4%B8%BB%E6%9D%BFbios%E6%8C%89%E9%94%AE/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    各品牌主板bios按键
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
    
    
      
      
        
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    
  
  
    <a href="../../../../%E6%95%B0%E6%8D%AE%E5%BA%93%E7%AC%94%E8%AE%B0/MongoDB/MongoDB%20%E6%95%B0%E6%8D%AE%E4%B8%80%E8%87%B4%E6%80%A7%E5%92%8C%E9%9A%94%E7%A6%BB/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    数据库笔记
    
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

  

      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
    
    
      
      
        
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../../../%E6%B5%8F%E8%A7%88%E5%99%A8%E4%B9%A6%E7%AD%BE%E6%94%B6%E8%97%8F/%E5%AE%89%E5%A8%9C%E6%A1%A3%E6%A1%88%E5%AF%86%E9%92%A5/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    浏览器书签收藏
    
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
    
    
      
      
        
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    
  
  
    <a href="../../../../%E7%9B%91%E6%8E%A7/%E7%9B%91%E6%8E%A7/zabbix%E7%9B%91%E6%8E%A7vsphere%E5%91%8A%E8%AD%A6/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    监控
    
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

  

      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
    
    
      
      
        
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    
  
  
    <a href="../../../../%E8%99%9A%E6%8B%9F%E5%8C%96/%E8%99%9A%E6%8B%9F%E5%8C%96/RVtools%E4%BD%BF%E7%94%A8/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    虚拟化
    
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

  

      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
    
    
      
      
        
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../../../%E8%AE%A4%E8%AF%81%E7%9B%B8%E5%85%B3/credly%E6%9F%A5%E7%9C%8B%E5%8B%8B%E7%AB%A0/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    认证相关
    
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="部署ansible">部署ansible<a class="headerlink" href="#部署ansible" title="Permanent link">&para;</a></h1>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-1">1</a></span>
<span class="normal"><a href="#__codelineno-0-2">2</a></span>
<span class="normal"><a href="#__codelineno-0-3">3</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a>yum<span class="w"> </span>install<span class="w"> </span>-y<span class="w"> </span>ansible-core
<a id="__codelineno-0-2" name="__codelineno-0-2"></a>yum<span class="w"> </span>install<span class="w"> </span>-y<span class="w"> </span>ansible-navigator
<a id="__codelineno-0-3" name="__codelineno-0-3"></a>ansible-navigator<span class="w"> </span>images
</code></pre></div></td></tr></table></div>
<h1 id="配置文件">配置文件<a class="headerlink" href="#配置文件" title="Permanent link">&para;</a></h1>
<p><strong><font style="color:rgb(0,0,0);">管理配置文件 </font></strong></p>
<p><font style="color:rgb(0,0,0);">ansible</font><font style="color:rgb(0,0,0);">的配置文件名为</font><strong><font style="color:rgb(0,0,0);">ansible.cfg</font></strong><font style="color:rgb(0,0,0);">,RHEL8</font><font style="color:rgb(0,0,0);">版本默认位于</font><strong><font style="color:rgb(0,0,0);">/etc/ansible/ansible.cfg </font></strong><font style="color:rgb(0,0,0);">。此 </font></p>
<p><font style="color:rgb(0,0,0);">文件定义了连接受管主机的方法、权限以及受管主机清单文件等信息。 </font></p>
<p><font style="color:rgb(0,0,0);">在RHEL9中，需要使用命令来初始化一个配置文件 </font></p>
<p><font style="color:rgb(0,0,0);">ansible-config init &gt; ansible.cfg</font></p>
<p><strong><font style="color:rgb(0,0,0);">1.ansible.cfg</font></strong><strong><font style="color:rgb(0,0,0);">的读取顺序 </font></strong></p>
<p><strong><font style="color:rgb(0,0,0);">ansible.cfg</font></strong><font style="color:rgb(0,0,0);">可能会位于多个地方，</font><font style="color:rgb(0,0,0);">ansible</font><font style="color:rgb(0,0,0);">会在以下位置按顺序读取</font><strong><font style="color:rgb(0,0,0);">ansible.cfg</font></strong><font style="color:rgb(0,0,0);">文件： </font></p>
<p><font style="color:rgb(0,0,0);">1. </font><font style="color:rgb(0,0,0);">使用</font><strong><font style="color:rgb(0,0,0);">-c </font></strong><font style="color:rgb(0,0,0);">或</font><strong><font style="color:rgb(0,0,0);">--config </font></strong><font style="color:rgb(0,0,0);">指定配置文件的路径 </font></p>
<p><font style="color:rgb(0,0,0);">2. </font><font style="color:rgb(0,0,0);">使用环境变量</font><strong><font style="color:rgb(0,0,0);">ANSIBLE_CONFIG </font></strong></p>
<p><font style="color:rgb(0,0,0);">3. </font><font style="color:rgb(0,0,0);">当前目录下的</font><font style="color:rgb(0,0,0);">ansible.cfg</font><font style="color:rgb(0,0,0);">文件 </font></p>
<p><font style="color:rgb(0,0,0);">4. </font><font style="color:rgb(0,0,0);">当前用户家目录下的</font><font style="color:rgb(0,0,0);">ansible.cfg</font><font style="color:rgb(0,0,0);">文件 </font></p>
<p><font style="color:rgb(0,0,0);">5. </font><font style="color:rgb(0,0,0);">默认配置文件</font><strong><font style="color:rgb(0,0,0);">/etc/ansible/ansible.cfg </font></strong></p>
<p><font style="color:rgb(0,0,0);">可以使用 ansible --version 查看当前所使用的配置文件</font></p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-1-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1"></a><span class="w"> </span><span class="o">[</span>devops@workstation<span class="w"> </span>~<span class="o">]</span>$<span class="w"> </span>ansible<span class="w"> </span>--version
</code></pre></div></td></tr></table></div>
<p><strong><font style="color:rgb(0,0,0);">2.ansible.cfg参数配置</font></strong></p>
<p><strong><font style="color:rgb(0,0,0);">ansible.cfg</font></strong><font style="color:rgb(0,0,0);">使用分段式配置，每个段使用</font><font style="color:rgb(0,0,0);">"[]"</font><font style="color:rgb(0,0,0);">包含，每个段下方使用</font><font style="color:rgb(0,0,0);">key=value</font><font style="color:rgb(0,0,0);">方式定义 </font></p>
<p><font style="color:rgb(0,0,0);">ansible</font><font style="color:rgb(0,0,0);">工作方式。 </font></p>
<p><font style="color:rgb(0,0,0);">主要的配置段有</font><strong><font style="color:rgb(0,0,0);">[defaults]</font></strong><font style="color:rgb(0,0,0);">和</font><strong><font style="color:rgb(0,0,0);">[privilege_escalation] </font></strong></p>
<p><strong><font style="color:rgb(0,0,0);">[defaults] </font></strong><font style="color:rgb(0,0,0);">用来定义通用默认配置 </font></p>
<p><strong><font style="color:rgb(0,0,0);">[privilege_escalation] </font></strong><font style="color:rgb(0,0,0);">用于定义在受管主机上的提权配置 </font></p>
<p><strong><font style="color:rgb(0,0,0);">[defaults]</font></strong><strong><font style="color:rgb(0,0,0);">中的配置参数 </font></strong></p>
<p><font style="color:rgb(0,0,0);">1</font><strong><font style="color:rgb(223,64,42);">.inventory = /etc/ansible/hosts </font></strong></p>
<p><font style="color:rgb(0,0,0);">定义</font><font style="color:rgb(0,0,0);">inventory</font><font style="color:rgb(0,0,0);">主机清单文件的位置，默认清单文件是</font><font style="color:rgb(0,0,0);">/etc/ansible/hosts </font></p>
<p><font style="color:rgb(0,0,0);">2.</font><strong><font style="color:rgb(223,64,42);">forks = 5 </font></strong></p>
<p><font style="color:rgb(0,0,0);">与受管主机通信时的并行的进程数，默认是</font><font style="color:rgb(0,0,0);">5 </font></p>
<p><font style="color:rgb(0,0,0);">3.</font><strong><font style="color:rgb(223,64,42);">remote_user = root </font></strong></p>
<p><font style="color:rgb(0,0,0);">设置受管主机的用户，默认是</font><font style="color:rgb(0,0,0);">root,</font><font style="color:rgb(0,0,0);">如果未设置则是以控制节点当前用户身份 </font></p>
<p><font style="color:rgb(0,0,0);">4.</font><strong><font style="color:rgb(223,64,42);">ask_pass = True </font></strong></p>
<p><font style="color:rgb(0,0,0);">在连接受管主机是是否要输入密码</font><font style="color:rgb(0,0,0);">,</font><font style="color:rgb(0,0,0);">默认是需要的。配置好</font><font style="color:rgb(0,0,0);">SSH</font><font style="color:rgb(0,0,0);">公钥认证则可以自动连接，无需密码。 </font></p>
<p><strong><font style="color:rgb(223,64,42);">[privilege_escalation]</font></strong><strong><font style="color:rgb(0,0,0);">中的配置参数 </font></strong></p>
<p><strong><font style="color:rgb(223,64,42);">become=True </font></strong><font style="color:rgb(0,0,0);">在受管主机是否进行提权 </font></p>
<p><strong><font style="color:rgb(223,64,42);">become_method=sudo </font></strong><font style="color:rgb(0,0,0);">提权方式为</font><font style="color:rgb(0,0,0);">sudo </font><font style="color:rgb(0,0,0);">，默认是</font><font style="color:rgb(0,0,0);">su </font></p>
<p><strong><font style="color:rgb(223,64,42);">become_user=root </font></strong><font style="color:rgb(0,0,0);">提权后的用户 </font></p>
<p><strong><font style="color:rgb(223,64,42);">become_ask_pass=False </font></strong><font style="color:rgb(0,0,0);">提权时是否需要密码 </font></p>
<p><strong><font style="color:rgb(0,0,0);">ansible.cfg 配置文件示例</font></strong></p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-2-1">1</a></span>
<span class="normal"><a href="#__codelineno-2-2">2</a></span>
<span class="normal"><a href="#__codelineno-2-3">3</a></span>
<span class="normal"><a href="#__codelineno-2-4">4</a></span>
<span class="normal"><a href="#__codelineno-2-5">5</a></span>
<span class="normal"><a href="#__codelineno-2-6">6</a></span>
<span class="normal"><a href="#__codelineno-2-7">7</a></span>
<span class="normal"><a href="#__codelineno-2-8">8</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1"></a><span class="o">[</span>defaults<span class="o">]</span>
<a id="__codelineno-2-2" name="__codelineno-2-2"></a><span class="nv">inventory</span><span class="o">=</span>~/ansible/inventory
<a id="__codelineno-2-3" name="__codelineno-2-3"></a><span class="nv">remote_user</span><span class="o">=</span>alice
<a id="__codelineno-2-4" name="__codelineno-2-4"></a><span class="o">[</span>privilege_escalation<span class="o">]</span>
<a id="__codelineno-2-5" name="__codelineno-2-5"></a><span class="nv">become</span><span class="o">=</span>True
<a id="__codelineno-2-6" name="__codelineno-2-6"></a><span class="nv">become_method</span><span class="o">=</span>sudo
<a id="__codelineno-2-7" name="__codelineno-2-7"></a><span class="nv">become_user</span><span class="o">=</span>root
<a id="__codelineno-2-8" name="__codelineno-2-8"></a><span class="nv">become_ask_pass</span><span class="o">=</span>False
</code></pre></div></td></tr></table></div>
<p><strong><font style="color:rgb(0,0,0);">inventory主机清单文件 </font></strong></p>
<p><font style="color:rgb(0,0,0);">inventory</font><font style="color:rgb(0,0,0);">文件位置是在</font><font style="color:rgb(0,0,0);">ansible.cfg</font><font style="color:rgb(0,0,0);">中定义的 </font></p>
<p><font style="color:rgb(0,0,0);">inventory</font><font style="color:rgb(0,0,0);">文件就是受管主机的清单，定义了哪些主机将被</font><font style="color:rgb(0,0,0);">ansible</font><font style="color:rgb(0,0,0);">管理。 </font></p>
<p><font style="color:rgb(0,0,0);">这些主机列表可以进行分组，也可以使用变量来定义主机和主机组。 </font></p>
<p><strong><font style="color:rgb(0,0,0);">inventory </font></strong><strong><font style="color:rgb(0,0,0);">文件的内置变量 </font></strong></p>
<p><font style="color:rgb(0,0,0);">ansible_ssh_host # </font><font style="color:rgb(0,0,0);">要连接的主机名 </font><font style="color:rgb(0,0,0);">ansible_ssh_port # </font><font style="color:rgb(0,0,0);">端口号，默认</font><font style="color:rgb(0,0,0);">22 </font></p>
<p><font style="color:rgb(0,0,0);">ansible_ssh_user # ssh</font><font style="color:rgb(0,0,0);">连接时默认使用的用户名 </font><font style="color:rgb(0,0,0);">ansible_ssh_pass # ssh</font><font style="color:rgb(0,0,0);">连接时的密码 </font></p>
<p><font style="color:rgb(0,0,0);">ansible_sudo_pass # </font><font style="color:rgb(0,0,0);">使用</font><font style="color:rgb(0,0,0);">sudo</font><font style="color:rgb(0,0,0);">连接用户时的密码 </font><font style="color:rgb(0,0,0);">ansible_ssh_private_key_file # </font><font style="color:rgb(0,0,0);">秘 </font></p>
<p><font style="color:rgb(0,0,0);">钥文件如果不想使用</font><font style="color:rgb(0,0,0);">sshagent</font><font style="color:rgb(0,0,0);">管理时可以使用此选项 </font><font style="color:rgb(0,0,0);">ansible_shell_type # shell</font><font style="color:rgb(0,0,0);">类型，默 </font></p>
<p><font style="color:rgb(0,0,0);">认</font><font style="color:rgb(0,0,0);">sh ansible_connection # SSH</font><font style="color:rgb(0,0,0);">连接类型：</font><font style="color:rgb(0,0,0);">local</font><font style="color:rgb(0,0,0);">、</font><font style="color:rgb(0,0,0);">ssh</font><font style="color:rgb(0,0,0);">、</font><font style="color:rgb(0,0,0);">paramiko</font><font style="color:rgb(0,0,0);">在</font><font style="color:rgb(0,0,0);">ansible 1.2</font><font style="color:rgb(0,0,0);">之前默 </font></p>
<p><font style="color:rgb(0,0,0);">认</font><font style="color:rgb(0,0,0);">paramiko ansible_python_interpreter # </font><font style="color:rgb(0,0,0);">用来指定</font><font style="color:rgb(0,0,0);">Python</font><font style="color:rgb(0,0,0);">解释器的路径，同样可以指定 </font></p>
<p><font style="color:rgb(0,0,0);">ruby</font><font style="color:rgb(0,0,0);">、</font><font style="color:rgb(0,0,0);">Perl</font><font style="color:rgb(0,0,0);">的路径 </font></p>
<p><strong><font style="color:rgb(0,0,0);">inventory </font></strong><strong><font style="color:rgb(0,0,0);">文件的写法 </font></strong></p>
<p><strong><font style="color:rgb(0,0,0);">可以写主机名或</font></strong><strong><font style="color:rgb(0,0,0);">ip</font></strong><strong><font style="color:rgb(0,0,0);">地址： </font></strong></p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-3-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1"></a>$<span class="w"> </span>vim<span class="w"> </span>inventory<span class="w"> </span>
</code></pre></div></td></tr></table></div>
<p><font style="color:rgb(0,0,0);">192.168.10.12 </font></p>
<p><font style="color:rgb(0,0,0);">node1.example.com </font></p>
<p><font style="color:rgb(0,0,0);">node2.example.com </font></p>
<p><strong><font style="color:rgb(0,0,0);">指定主机范围：</font></strong></p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-4-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1"></a>$<span class="w"> </span>vim<span class="w"> </span>inventory<span class="w"> </span>
</code></pre></div></td></tr></table></div>
<p><font style="color:rgb(0,0,0);">192.168.10.[11:20] </font><strong><font style="color:rgb(0,0,0);">表示</font></strong><strong><font style="color:rgb(0,0,0);">192.168.10.11-192.168.10.20 </font></strong><strong><font style="color:rgb(0,0,0);">的主机 </font></strong></p>
<p><font style="color:rgb(0,0,0);">192.168.[0:3].[1:254] </font><strong><font style="color:rgb(0,0,0);">表示</font></strong><strong><font style="color:rgb(0,0,0);">192.168.0.1-192.168.3.254</font></strong><strong><font style="color:rgb(0,0,0);">网络内的主机 </font></strong></p>
<p><font style="color:rgb(0,0,0);">node[1:30].example.com </font><strong><font style="color:rgb(0,0,0);">表示node1.example.com-node30.example.com网络内的主机</font></strong></p>
<p><strong><font style="color:rgb(0,0,0);">定义主机组： </font></strong></p>
<p><font style="color:rgb(0,0,0);">可以使用分组的方法来指定受管主机，这样就可以针对具体的组来执行</font><font style="color:rgb(0,0,0);">ansible</font><font style="color:rgb(0,0,0);">指令。 </font></p>
<p><font style="color:rgb(0,0,0);">1. </font><font style="color:rgb(0,0,0);">一个主机可以属于多个组 </font></p>
<p><font style="color:rgb(0,0,0);">2. </font><font style="color:rgb(0,0,0);">组可以嵌套 </font></p>
<p><font style="color:rgb(0,0,0);">3. 组使用[]来定义</font></p>
<p><font style="color:rgb(0,0,0);">4.嵌套组使用:children来标识</font></p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-5-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-5-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-5-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-5-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-5-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-5-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-5-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-5-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-5-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-5-10">10</a></span>
<span class="normal"><a href="#__codelineno-5-11">11</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1"></a><span class="o">[</span>dev<span class="o">]</span>
<a id="__codelineno-5-2" name="__codelineno-5-2"></a>node1
<a id="__codelineno-5-3" name="__codelineno-5-3"></a><span class="o">[</span>test<span class="o">]</span>
<a id="__codelineno-5-4" name="__codelineno-5-4"></a>node2
<a id="__codelineno-5-5" name="__codelineno-5-5"></a><span class="o">[</span>prod<span class="o">]</span>
<a id="__codelineno-5-6" name="__codelineno-5-6"></a>node3
<a id="__codelineno-5-7" name="__codelineno-5-7"></a>node4
<a id="__codelineno-5-8" name="__codelineno-5-8"></a><span class="o">[</span>balancers:children<span class="o">]</span>
<a id="__codelineno-5-9" name="__codelineno-5-9"></a>dev
<a id="__codelineno-5-10" name="__codelineno-5-10"></a><span class="nb">test</span>
<a id="__codelineno-5-11" name="__codelineno-5-11"></a>prod
</code></pre></div></td></tr></table></div>
<p><strong><font style="color:rgb(0,0,0);">默认组： </font></strong></p>
<p><strong><font style="color:rgb(0,0,0);">在</font></strong><strong><font style="color:rgb(0,0,0);">inventory</font></strong><strong><font style="color:rgb(0,0,0);">中默认就存在两个组，分别是</font></strong><strong><font style="color:rgb(0,0,0);">all</font></strong><strong><font style="color:rgb(0,0,0);">和</font></strong><strong><font style="color:rgb(0,0,0);">ungrouped </font></strong></p>
<p><strong><font style="color:rgb(0,0,0);">all: </font></strong><font style="color:rgb(0,0,0);">表示</font><font style="color:rgb(0,0,0);">inventory</font><font style="color:rgb(0,0,0);">中的所有主机</font><strong><font style="color:rgb(0,0,0);">ungrouped: </font></strong><font style="color:rgb(0,0,0);">表示不在任何组中的主机 </font></p>
<p><strong><font style="color:rgb(0,0,0);">列出</font></strong><strong><font style="color:rgb(0,0,0);">inventory</font></strong><strong><font style="color:rgb(0,0,0);">中的主机 </font></strong></p>
<p><font style="color:rgb(0,0,0);">1.</font><font style="color:rgb(0,0,0);">列出所有的主机 </font></p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-6-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1"></a>$<span class="w"> </span>ansible<span class="w"> </span>all<span class="w"> </span>--list-hosts
</code></pre></div></td></tr></table></div>
<p><font style="color:rgb(0,0,0);">2.</font><font style="color:rgb(0,0,0);">列出</font><font style="color:rgb(0,0,0);">dbserver</font><font style="color:rgb(0,0,0);">组中的主机 </font></p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-7-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1"></a>$<span class="w"> </span>ansible<span class="w"> </span>prod<span class="w"> </span>--list-hosts
</code></pre></div></td></tr></table></div>
<p><font style="color:rgb(0,0,0);">3.</font><font style="color:rgb(0,0,0);">列出</font><font style="color:rgb(0,0,0);">dev</font><font style="color:rgb(0,0,0);">组中的主机 </font></p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-8-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1"></a>$<span class="w"> </span>ansible<span class="w"> </span>dev<span class="w"> </span>--list-hosts
</code></pre></div></td></tr></table></div>
<p><strong><font style="color:rgb(0,0,0);">测试所有受管主机的连通性 </font></strong></p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-9-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-9-1" name="__codelineno-9-1"></a><span class="o">[</span>devops@workstation<span class="w"> </span>ansible<span class="o">]</span>$<span class="w"> </span>ansible<span class="w"> </span>all<span class="w"> </span>-m<span class="w"> </span>ping
</code></pre></div></td></tr></table></div>
<h1 id="即时命令和文档查看">即时命令和文档查看<a class="headerlink" href="#即时命令和文档查看" title="Permanent link">&para;</a></h1>
<h2 id="运行ad-hoc命令"><strong><font style="color:rgb(0,0,0);">运行Ad-hoc命令</font></strong><a class="headerlink" href="#运行ad-hoc命令" title="Permanent link">&para;</a></h2>
<p><strong><font style="color:rgb(0,0,0);">ansible</font></strong><strong><font style="color:rgb(0,0,0);">执行有两种方式，一种是</font></strong><strong><font style="color:rgb(0,0,0);">ad-hoc</font></strong><strong><font style="color:rgb(0,0,0);">，另一种是</font></strong><strong><font style="color:rgb(0,0,0);">playbooks </font></strong></p>
<p><strong><font style="color:rgb(0,0,0);">什么是ad-hoc命令 </font></strong></p>
<p><font style="color:rgb(0,0,0);">ad-hoc</font><font style="color:rgb(0,0,0);">表示即时的意思 </font></p>
<p><font style="color:rgb(0,0,0);">如果我们敲入一些命令去比较快的完成一些事情</font><font style="color:rgb(0,0,0);">,</font><font style="color:rgb(0,0,0);">而不需要将这些执行的命令特别保存下来</font><font style="color:rgb(0,0,0);">, </font><font style="color:rgb(0,0,0);">这样的命 </font></p>
<p><font style="color:rgb(0,0,0);">令就叫做</font><font style="color:rgb(0,0,0);"> ad-hoc </font><font style="color:rgb(0,0,0);">命令。 </font></p>
<p><strong><font style="color:rgb(0,0,0);">ansible运行ad-hoc 命令 </font></strong></p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-10-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-10-1" name="__codelineno-10-1"></a><span class="c1">#ansible webservers -m ping </span>
</code></pre></div></td></tr></table></div>
<p><strong><font style="color:rgb(0,0,0);">ansible</font></strong><strong><font style="color:rgb(0,0,0);">语法格式 </font></strong></p>
<p><font style="color:rgb(0,0,0);">#ansible </font><font style="color:rgb(0,0,0);">受管主机 </font><font style="color:rgb(0,0,0);">-m </font><font style="color:rgb(0,0,0);">模块名称 </font><font style="color:rgb(0,0,0);">-a '</font><font style="color:rgb(0,0,0);">模块参数</font><font style="color:rgb(0,0,0);">' </font></p>
<p><font style="color:rgb(0,0,0);">-i </font><font style="color:rgb(0,0,0);">指定</font><font style="color:rgb(0,0,0);">inventory</font><font style="color:rgb(0,0,0);">文件，默认是读取</font><font style="color:rgb(0,0,0);">ansible.cfg</font><font style="color:rgb(0,0,0);">中定义的</font><font style="color:rgb(0,0,0);">inventory</font><font style="color:rgb(0,0,0);">文件 </font></p>
<p><font style="color:rgb(0,0,0);">-m </font><font style="color:rgb(0,0,0);">指定模块名称，默认是</font><font style="color:rgb(0,0,0);">command</font><font style="color:rgb(0,0,0);">模块 </font></p>
<p><font style="color:rgb(0,0,0);">-a </font><font style="color:rgb(0,0,0);">传递参数给模块 </font></p>
<p><font style="color:rgb(0,0,0);">受管主机必须是已经在inventory文件中定义的主机，可以写主机名也可以写主机组名。</font></p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-11-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-11-1" name="__codelineno-11-1"></a><span class="o">[</span>devops@workstation<span class="w"> </span>ansible<span class="o">]</span><span class="c1"># ansible all -a &#39;hostname&#39;</span>
</code></pre></div></td></tr></table></div>
<p><strong><font style="color:rgb(0,0,0);">ansible </font></strong><strong><font style="color:rgb(0,0,0);">命令其他选项 </font></strong></p>
<p><font style="color:rgb(0,0,0);">-u </font><font style="color:rgb(0,0,0);">指定</font><font style="color:rgb(0,0,0);">remote_user </font></p>
<p><font style="color:rgb(0,0,0);">-b </font><font style="color:rgb(0,0,0);">提权 </font></p>
<p><font style="color:rgb(0,0,0);">--become-user=USER </font><font style="color:rgb(0,0,0);">提权的用户 </font></p>
<p><font style="color:rgb(0,0,0);">--become-method=sudo 提权的方法（可以是su,sudo）</font></p>
<p><strong><font style="color:rgb(0,0,0);">ansible模块 </font></strong></p>
<p><font style="color:rgb(0,0,0);">ansible</font><font style="color:rgb(0,0,0);">是基于模块工作的，所有批量操作的操作都是有各个模块完成。在</font><font style="color:rgb(0,0,0);">ansible</font><font style="color:rgb(0,0,0);">中有大量的模块 </font></p>
<p><font style="color:rgb(0,0,0);">可有使用，官方模块列表： </font></p>
<p><font style="color:rgb(3,102,214);">https://docs.ansible.com/ansible/latest/modules/modules_by_category.html</font></p>
<p><strong><font style="color:rgb(0,0,0);">ansible模块的幂等性 </font></strong></p>
<p><font style="color:rgb(0,0,0);">ansible</font><font style="color:rgb(0,0,0);">绝大多数模块都天然具有</font><strong><font style="color:rgb(0,0,0);">幂等性</font></strong><font style="color:rgb(0,0,0);">，只有极少数模块模块不具备</font><strong><font style="color:rgb(0,0,0);">幂等性</font></strong><font style="color:rgb(0,0,0);">。所谓的</font><strong><font style="color:rgb(0,0,0);">幂等性</font></strong><font style="color:rgb(0,0,0);">是指多 </font></p>
<p><font style="color:rgb(0,0,0);">次执行同一个操作不会影响最终结果。例如，</font><font style="color:rgb(0,0,0);">ansible</font><font style="color:rgb(0,0,0);">的</font><font style="color:rgb(0,0,0);">ansible.builtin.yum</font><font style="color:rgb(0,0,0);">模块安装</font><font style="color:rgb(0,0,0);">rpm</font><font style="color:rgb(0,0,0);">包 </font></p>
<p><font style="color:rgb(0,0,0);">时，如果待安装的包已经安装过了，则再次或多次执行安装操作都不会真正的执行下去。再例如， </font></p>
<p><font style="color:rgb(0,0,0);">ansible.builtin.copy</font><font style="color:rgb(0,0,0);">模块拷贝文件时，如果目标主机上已经有了完全相同的文件，则多次执行 </font></p>
<p><font style="color:rgb(0,0,0);">ansible.builtin.copy</font><font style="color:rgb(0,0,0);">模块不会真正的拷贝。</font><font style="color:rgb(0,0,0);">ansible</font><font style="color:rgb(0,0,0);">具有幂等性的模块在执行时，都会自动判 </font></p>
<p><font style="color:rgb(0,0,0);">断是否要执行。 </font></p>
<h2 id="获取模块帮助"><strong><font style="color:rgb(0,0,0);">获取模块帮助 </font></strong><a class="headerlink" href="#获取模块帮助" title="Permanent link">&para;</a></h2>
<p><font style="color:rgb(0,0,0);">可以使用</font><font style="color:rgb(0,0,0);">ansible-doc</font><font style="color:rgb(0,0,0);">获取模块名称和模块的使用帮助。 </font></p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-12-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-12-1" name="__codelineno-12-1"></a><span class="o">[</span>devops@workstation<span class="w"> </span>~<span class="o">]</span>$<span class="w"> </span>ansible-doc<span class="w"> </span>-l<span class="w"> </span>
</code></pre></div></td></tr></table></div>
<p><font style="color:rgb(0,0,0);">获取相应模块的使用帮助信息 </font></p>
<p><font style="color:rgb(0,0,0);"># ansible-doc Module_Name </font></p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-13-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-13-1" name="__codelineno-13-1"></a><span class="o">[</span>difu@control<span class="w"> </span>~<span class="o">]</span>$<span class="w"> </span>ansible-doc<span class="w"> </span>yum
</code></pre></div></td></tr></table></div>
<h2 id="常用模块"><strong><font style="color:rgb(0,0,0);">常用模块 </font></strong><a class="headerlink" href="#常用模块" title="Permanent link">&para;</a></h2>
<p><font style="color:rgb(0,0,0);">1.</font><strong><font style="color:rgb(0,0,0);">ansible.builtin.</font></strong><strong><font style="color:rgb(0,0,0);">command </font></strong><font style="color:rgb(0,0,0);">模块 </font></p>
<p><font style="color:rgb(0,0,0);">ansible.builtin.command </font><font style="color:rgb(0,0,0);">模块是</font><font style="color:rgb(0,0,0);">ansible </font><font style="color:rgb(0,0,0);">的默认模块，</font><font style="color:rgb(0,0,0);">ansible.builtin.command </font><font style="color:rgb(0,0,0);">模块 </font></p>
<p><font style="color:rgb(0,0,0);">可以在受管主机上执行</font><font style="color:rgb(0,0,0);">Linux</font><font style="color:rgb(0,0,0);">命令，但是</font><font style="color:rgb(0,0,0);">ansible.builtin.command</font><font style="color:rgb(0,0,0);">模块</font><font style="color:rgb(223,64,42);">不能使用重定向、管道和 </font></p>
<p><font style="color:rgb(223,64,42);">变量 </font></p>
<p><strong><font style="color:rgb(0,0,0);">command</font></strong><strong><font style="color:rgb(0,0,0);">模块使用 </font></strong></p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-14-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-14-1" name="__codelineno-14-1"></a><span class="o">[</span>devops@workstation<span class="w"> </span>ansible<span class="o">]</span>$<span class="w"> </span>ansible<span class="w"> </span>all<span class="w"> </span>-m<span class="w"> </span><span class="nb">command</span><span class="w"> </span>-a<span class="w"> </span><span class="s1">&#39;cat /etc/redhat-release&#39;</span>
</code></pre></div></td></tr></table></div>
<p><font style="color:rgb(0,0,0);">2.</font><strong><font style="color:rgb(0,0,0);">ansible.builtin.</font></strong><strong><font style="color:rgb(0,0,0);">shell </font></strong><font style="color:rgb(0,0,0);">模块 </font></p>
<p><font style="color:rgb(0,0,0);">ansible.builtin.shell</font><font style="color:rgb(0,0,0);">模块作用就是在受管主机上执行</font><font style="color:rgb(0,0,0);">shell</font><font style="color:rgb(0,0,0);">命令，其用法和 </font></p>
<p><font style="color:rgb(0,0,0);">ansible.builtin.command</font><font style="color:rgb(0,0,0);">模块一样， </font></p>
<p><font style="color:rgb(0,0,0);">但是</font><font style="color:rgb(0,0,0);">ansible.builtin.shell</font><font style="color:rgb(0,0,0);">模块支持管道符、重定向等操作。</font><font style="color:rgb(223,64,42);">(</font><font style="color:rgb(223,64,42);">不支持受管主机上的别名命令</font><font style="color:rgb(223,64,42);">) </font></p>
<p><strong><font style="color:rgb(0,0,0);">shell</font></strong><strong><font style="color:rgb(0,0,0);">模块使用 </font></strong></p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-15-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-15-1" name="__codelineno-15-1"></a><span class="o">[</span>devops@workstation<span class="w"> </span>ansible<span class="o">]</span>$<span class="w"> </span>ansible<span class="w"> </span>all<span class="w"> </span>-m<span class="w"> </span>shell<span class="w"> </span>-a<span class="w"> </span><span class="s1">&#39;echo Hello &gt;&gt; test&#39;</span>
</code></pre></div></td></tr></table></div>
<p><font style="color:rgb(0,0,0);">command和shell 模块不支持幂等性，即这两个模块每次都会重复执行</font></p>
<p><font style="color:rgb(0,0,0);">3.</font><strong><font style="color:rgb(243,50,50);">ansible.builtin.file </font></strong><font style="color:rgb(0,0,0);">模块 </font></p>
<p><font style="color:rgb(0,0,0);">ansible.builtin.file</font><font style="color:rgb(0,0,0);">模块是一个常用的模块，用于管理目录或文件的属性，也可以创建文件和 </font></p>
<p><font style="color:rgb(0,0,0);">目录 </font></p>
<p><font style="color:rgb(0,0,0);">ansible.builtin.file</font><font style="color:rgb(0,0,0);">模块支持很多的参数，主要有： </font></p>
<p><font style="color:rgb(0,0,0);">path: </font><font style="color:rgb(0,0,0);">执行需要操作的文件或目录，也可以使用</font><font style="color:rgb(0,0,0);">dest</font><font style="color:rgb(0,0,0);">来代替</font><font style="color:rgb(0,0,0);">path </font></p>
<p><font style="color:rgb(0,0,0);">group: </font><font style="color:rgb(0,0,0);">设置文件或目录的属组 </font></p>
<p><font style="color:rgb(0,0,0);">owner: </font><font style="color:rgb(0,0,0);">设置文件或目录的属主 </font></p>
<p><font style="color:rgb(0,0,0);">mode: </font><font style="color:rgb(0,0,0);">设置文件或目录的权限，可以使用</font><font style="color:rgb(0,0,0);">0744</font><font style="color:rgb(0,0,0);">这种格式，也可以使用</font><font style="color:rgb(0,0,0);">'u=rwx,g=r,o=r' </font></p>
<p><font style="color:rgb(0,0,0);">或</font><font style="color:rgb(0,0,0);">'u+wx,g+x' </font></p>
<p><font style="color:rgb(0,0,0);">recurse: </font><font style="color:rgb(0,0,0);">是否递归修改文件的属性，默认为</font><font style="color:rgb(0,0,0);">"no" </font></p>
<p><font style="color:rgb(0,0,0);">src: </font><font style="color:rgb(0,0,0);">创建链接文件时，指明源文件的路径 </font></p>
<p><font style="color:rgb(0,0,0);">setype: </font><font style="color:rgb(0,0,0);">设置</font><font style="color:rgb(0,0,0);">selinux</font><font style="color:rgb(0,0,0);">的类型 </font></p>
<p><font style="color:rgb(0,0,0);">state: </font><font style="color:rgb(0,0,0);">设定文件或目录的状态，其值有： </font></p>
<p><font style="color:rgb(0,0,0);">directory: </font><font style="color:rgb(0,0,0);">如果</font><font style="color:rgb(0,0,0);">path</font><font style="color:rgb(0,0,0);">中的目录不存在则递归创建 </font></p>
<p><font style="color:rgb(0,0,0);">touch: </font><font style="color:rgb(0,0,0);">创建文件 </font></p>
<p><font style="color:rgb(0,0,0);">link: </font><font style="color:rgb(0,0,0);">设置软连接 </font></p>
<p><font style="color:rgb(0,0,0);">absent: </font><font style="color:rgb(0,0,0);">将目录或文件递归删除 </font></p>
<p><strong><font style="color:rgb(0,0,0);">ansible.builtin.file</font></strong><strong><font style="color:rgb(0,0,0);">模块使用 </font></strong></p>
<p><font style="color:rgb(0,0,0);">1.递归创建目录，并设置权限和属主、属组</font></p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-16-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-16-1" name="__codelineno-16-1"></a><span class="o">[</span>devops@workstation<span class="w"> </span>ansible<span class="o">]</span>$<span class="w"> </span>ansible<span class="w"> </span>dev<span class="w"> </span>-m<span class="w"> </span>file<span class="w"> </span>-a<span class="w"> </span><span class="s1">&#39;path=/server/tools group=root owner=root mode=0770 state=directory&#39;</span>
</code></pre></div></td></tr></table></div>
<p><font style="color:rgb(0,0,0);">2.</font><font style="color:rgb(0,0,0);">在</font><font style="color:rgb(0,0,0);">/server/tools</font><font style="color:rgb(0,0,0);">目录下创建一个</font><font style="color:rgb(0,0,0);">test</font><font style="color:rgb(0,0,0);">的文件</font><font style="color:rgb(0,0,0);"> (/server/tools </font><font style="color:rgb(0,0,0);">这个目录必须已存在</font><font style="color:rgb(0,0,0);">) </font></p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-17-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-17-1" name="__codelineno-17-1"></a><span class="o">[</span>devops@workstation<span class="w"> </span>ansible<span class="o">]</span>$<span class="w"> </span>ansible<span class="w"> </span>dev<span class="w"> </span>-m<span class="w"> </span>file<span class="w"> </span>-a<span class="w"> </span><span class="s1">&#39;path=/server/tools/test state=touch&#39;</span>
</code></pre></div></td></tr></table></div>
<p><font style="color:rgb(0,0,0);">4.</font><strong><font style="color:rgb(0,0,0);">ansible.builtin.</font></strong><strong><font style="color:rgb(0,0,0);">user </font></strong><font style="color:rgb(0,0,0);">模块 </font></p>
<p><font style="color:rgb(0,0,0);">ansible.builtin.user</font><font style="color:rgb(0,0,0);">模块可以用来添加、删除、修改用户，设置用户密码 </font></p>
<p><font style="color:rgb(0,0,0);">ansible.builtin.user</font><font style="color:rgb(0,0,0);">模块的主要参数： </font></p>
<p><font style="color:rgb(0,0,0);">name: </font><font style="color:rgb(0,0,0);">要操作的用户名 </font></p>
<p><font style="color:rgb(0,0,0);">state: </font><font style="color:rgb(0,0,0);">设置用户的状态，删除或创建用户，其值有</font><font style="color:rgb(0,0,0);">"present" </font><font style="color:rgb(0,0,0);">和</font><font style="color:rgb(0,0,0);">"absent",present</font><font style="color:rgb(0,0,0);">表示创 </font></p>
<p><font style="color:rgb(0,0,0);">建，默认值，</font><font style="color:rgb(0,0,0);">absent</font><font style="color:rgb(0,0,0);">表示删除 </font></p>
<p><font style="color:rgb(0,0,0);">group: </font><font style="color:rgb(0,0,0);">设置用户的基本组 </font></p>
<p><font style="color:rgb(0,0,0);">groups: </font><font style="color:rgb(0,0,0);">设置用户的附加组 </font></p>
<p><font style="color:rgb(0,0,0);">uid: </font><font style="color:rgb(0,0,0);">设置用户的</font><font style="color:rgb(0,0,0);">uid </font></p>
<p><font style="color:rgb(0,0,0);">home: </font><font style="color:rgb(0,0,0);">设置用户的家目录 </font></p>
<p><font style="color:rgb(0,0,0);">shell: </font><font style="color:rgb(0,0,0);">设置用户的默认</font><font style="color:rgb(0,0,0);">shell </font></p>
<p><font style="color:rgb(57,57,57);">password: </font><font style="color:rgb(57,57,57);">设置用户的密码，此处的密码必须是一个密文。在</font><font style="color:rgb(57,57,57);">playbook</font><font style="color:rgb(57,57,57);">中可以使用 </font></p>
<p><font style="color:rgb(57,57,57);">password: "{{ your_passwd | password_hash('sha512') }}"</font><font style="color:rgb(57,57,57);">这种方式设置密码。 </font></p>
<p><strong><font style="color:rgb(0,0,0);">ansible.builtin.user</font></strong><strong><font style="color:rgb(0,0,0);">模块使用 </font></strong></p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-18-1">1</a></span>
<span class="normal"><a href="#__codelineno-18-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-18-1" name="__codelineno-18-1"></a><span class="o">[</span>devops@workstation<span class="w"> </span>ansible<span class="o">]</span>$<span class="w"> </span>ansible<span class="w"> </span>dev<span class="w"> </span>-m<span class="w"> </span>user<span class="w"> </span>-a<span class="w"> </span><span class="s1">&#39;name=www uid=2000 </span>
<a id="__codelineno-18-2" name="__codelineno-18-2"></a><span class="s1">shell=/sbin/nologin&#39;</span>
</code></pre></div></td></tr></table></div>
<p><font style="color:rgb(0,0,0);">5.</font><strong><font style="color:rgb(0,0,0);">ansible.builtin.</font></strong><strong><font style="color:rgb(0,0,0);">group </font></strong><strong><font style="color:rgb(0,0,0);">模</font></strong><font style="color:rgb(0,0,0);">块 </font></p>
<p><font style="color:rgb(0,0,0);">ansible.builtin.group</font><font style="color:rgb(0,0,0);">模块用来创建或删除组 </font></p>
<p><font style="color:rgb(0,0,0);">ansible.builtin.group</font><font style="color:rgb(0,0,0);">模块常用的参数： </font></p>
<p><font style="color:rgb(0,0,0);">name: </font><font style="color:rgb(0,0,0);">组的名称 </font></p>
<p><font style="color:rgb(0,0,0);">gid: </font><font style="color:rgb(0,0,0);">设置组的</font><font style="color:rgb(0,0,0);">GID </font></p>
<p><font style="color:rgb(0,0,0);">state: </font><font style="color:rgb(0,0,0);">设置组的状态，默认是</font><font style="color:rgb(0,0,0);">present, absent</font><font style="color:rgb(0,0,0);">表示删除 </font></p>
<p><strong><font style="color:rgb(0,0,0);">ansible.builtin.group</font></strong><strong><font style="color:rgb(0,0,0);">模块使用 </font></strong></p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-19-1">1</a></span>
<span class="normal"><a href="#__codelineno-19-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-19-1" name="__codelineno-19-1"></a><span class="o">[</span>devops@workstation<span class="w"> </span>ansible<span class="o">]</span>$<span class="w"> </span>ansible<span class="w"> </span>dev<span class="w"> </span>-m<span class="w"> </span>group<span class="w"> </span>-a<span class="w"> </span><span class="s1">&#39;name=apache </span>
<a id="__codelineno-19-2" name="__codelineno-19-2"></a><span class="s1">gid=800&#39;</span>
</code></pre></div></td></tr></table></div>
<p><font style="color:rgb(0,0,0);">6.</font><strong><font style="color:rgb(0,0,0);">ansible.builtin.</font></strong><strong><font style="color:rgb(0,0,0);">script</font></strong><font style="color:rgb(0,0,0);">模块 </font></p>
<p><font style="color:rgb(0,0,0);">ansible.builtin.script</font><font style="color:rgb(0,0,0);">模块用于在受管主机上执行脚本。</font><font style="color:rgb(0,0,0);"> ansible </font><font style="color:rgb(0,0,0);">会将本地脚本传到受管主 </font></p>
<p><font style="color:rgb(0,0,0);">机上，然后在受管主机上执行脚本，在执行脚本时，使用的是受管主机的</font><font style="color:rgb(0,0,0);">shell</font><font style="color:rgb(0,0,0);">环境。 </font></p>
<p><strong><font style="color:rgb(0,0,0);">ansible.builtin.</font></strong><strong><font style="color:rgb(0,0,0);">script</font></strong><font style="color:rgb(0,0,0);">模块</font><font style="color:rgb(0,0,0);">主要参数： </font></p>
<p><font style="color:rgb(0,0,0);">chdir: </font><font style="color:rgb(0,0,0);">在受管主机上先切换到此目录下，再执行脚本 </font></p>
<p><font style="color:rgb(0,0,0);">creates: </font><font style="color:rgb(0,0,0);">当这个文件存在时，不执行脚本 </font></p>
<p><font style="color:rgb(0,0,0);">removes: </font><font style="color:rgb(0,0,0);">当这个文件不存在时，执行脚本 </font></p>
<p><strong><font style="color:rgb(0,0,0);">ansible.builtin.script</font></strong><strong><font style="color:rgb(0,0,0);">模块使用 </font></strong></p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-20-1">1</a></span>
<span class="normal"><a href="#__codelineno-20-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-20-1" name="__codelineno-20-1"></a><span class="o">[</span>devops@workstation<span class="w"> </span>ansible<span class="o">]</span>$<span class="w"> </span>ansible<span class="w"> </span>dev<span class="w"> </span>-m<span class="w"> </span>script<span class="w"> </span>-a<span class="w"> </span><span class="s1">&#39;creates=/tmp/a.txt </span>
<a id="__codelineno-20-2" name="__codelineno-20-2"></a><span class="s1">test.sh&#39;</span>
</code></pre></div></td></tr></table></div>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-21-1">1</a></span>
<span class="normal"><a href="#__codelineno-21-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-21-1" name="__codelineno-21-1"></a><span class="o">[</span>difu@control<span class="w"> </span>ansible<span class="o">]</span>$<span class="w"> </span>ansible<span class="w"> </span>all<span class="w"> </span>-m<span class="w"> </span>script<span class="w"> </span>-a<span class="w"> </span><span class="s1">&#39;creates=/etc/fstab </span>
<a id="__codelineno-21-2" name="__codelineno-21-2"></a><span class="s1">test.sh&#39;</span><span class="w"> </span>
</code></pre></div></td></tr></table></div>
<p><font style="color:rgb(57,57,57);">/etc/fstab这个文件存在，所以脚本不会被执行</font></p>
<p><font style="color:rgb(0,0,0);">7.</font><strong><font style="color:rgb(0,0,0);">ansible.builtin.</font></strong><strong><font style="color:rgb(0,0,0);">yum_repository</font></strong><strong><font style="color:rgb(0,0,0);">模块 </font></strong></p>
<p><font style="color:rgb(0,0,0);">ansible.builtin.yum_repository</font><font style="color:rgb(0,0,0);">模块可以实现为远程主机配置一个完整的</font><font style="color:rgb(0,0,0);">YUM</font><font style="color:rgb(0,0,0);">源 </font></p>
<p><font style="color:rgb(0,0,0);">主要参数： </font></p>
<p><font style="color:rgb(0,0,0);">file: </font><font style="color:rgb(0,0,0);">配置文件的名字。不需要</font><font style="color:rgb(0,0,0);">".repo" </font></p>
<p><font style="color:rgb(0,0,0);">name: </font><font style="color:rgb(0,0,0);">仓库</font><font style="color:rgb(0,0,0);">id </font></p>
<p><font style="color:rgb(0,0,0);">description</font><font style="color:rgb(0,0,0);">： 仓库描述 </font></p>
<p><font style="color:rgb(0,0,0);">baseurl: </font><font style="color:rgb(0,0,0);">仓库地址 </font></p>
<p><font style="color:rgb(0,0,0);">gpgcheck: 是否校验密钥</font></p>
<p><font style="color:rgb(0,0,0);">enabled: </font><font style="color:rgb(0,0,0);">是否激活仓库，默认是</font><font style="color:rgb(0,0,0);">yes </font></p>
<p><font style="color:rgb(0,0,0);">state: repo</font><font style="color:rgb(0,0,0);">文件的状态，默认是</font><font style="color:rgb(0,0,0);">present </font></p>
<p><strong><font style="color:rgb(0,0,0);">ansible.builtin.</font></strong><strong><font style="color:rgb(0,0,0);">yum_repository</font></strong><strong><font style="color:rgb(0,0,0);">模块使用 </font></strong></p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-22-1">1</a></span>
<span class="normal"><a href="#__codelineno-22-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-22-1" name="__codelineno-22-1"></a><span class="o">[</span>devops@workstation<span class="w"> </span>ansible<span class="o">]</span>$<span class="w"> </span>ansible<span class="w"> </span>dev<span class="w"> </span>-m<span class="w"> </span>yum_repository<span class="w"> </span>-a<span class="w"> </span><span class="s2">&quot;file=Base </span>
<a id="__codelineno-22-2" name="__codelineno-22-2"></a><span class="s2">name=B description=&#39;base repo&#39; baseurl=file:///mnt/BaseOS gpgcheck=no&quot;</span>
</code></pre></div></td></tr></table></div>
<p><strong><font style="color:rgb(0,0,0);">8. </font></strong><strong><font style="color:rgb(0,0,0);">ansible.builtin.</font></strong><strong><font style="color:rgb(0,0,0);">yum</font></strong><strong><font style="color:rgb(0,0,0);">模块 </font></strong></p>
<p><font style="color:rgb(0,0,0);">ansible.builtin.yum</font><font style="color:rgb(0,0,0);">模块用于安装、删除、更新软件包 </font></p>
<p><font style="color:rgb(0,0,0);">主要的参数有： </font></p>
<p><font style="color:rgb(0,0,0);">name: </font><font style="color:rgb(0,0,0);">软件包的名字，可以使用</font><font style="color:rgb(0,0,0);">"*"</font><font style="color:rgb(0,0,0);">进行通配 </font></p>
<p><font style="color:rgb(0,0,0);">list: </font><font style="color:rgb(0,0,0);">列出软件包 </font></p>
<p><font style="color:rgb(0,0,0);">state: </font><font style="color:rgb(0,0,0);">状态 ，可以写的值有： </font></p>
<p><font style="color:rgb(0,0,0);">present</font><font style="color:rgb(0,0,0);">和</font><font style="color:rgb(0,0,0);">installed </font><font style="color:rgb(0,0,0);">都表示安装包，</font><font style="color:rgb(0,0,0);">present</font><font style="color:rgb(0,0,0);">是默认值 </font></p>
<p><font style="color:rgb(0,0,0);">latest </font><font style="color:rgb(0,0,0);">表示安装最新版本的包 </font></p>
<p><font style="color:rgb(0,0,0);">absent/removed </font><font style="color:rgb(0,0,0);">表示删除包 </font></p>
<p><font style="color:rgb(0,0,0);">使用</font><font style="color:rgb(0,0,0);">ansible.builtin.yum</font><font style="color:rgb(0,0,0);">模块安装</font><font style="color:rgb(0,0,0);">vim </font></p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-23-1">1</a></span>
<span class="normal"><a href="#__codelineno-23-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-23-1" name="__codelineno-23-1"></a><span class="o">[</span>devops@workstation<span class="w"> </span>ansible<span class="o">]</span>$<span class="w"> </span>ansible<span class="w"> </span>dev<span class="w"> </span>-m<span class="w"> </span>yum<span class="w"> </span>-a<span class="w"> </span><span class="s1">&#39;name=httpd </span>
<a id="__codelineno-23-2" name="__codelineno-23-2"></a><span class="s1">state=latest&#39;</span>
</code></pre></div></td></tr></table></div>
<p><font style="color:rgb(0,0,0);">安装包组 </font></p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-24-1">1</a></span>
<span class="normal"><a href="#__codelineno-24-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-24-1" name="__codelineno-24-1"></a><span class="o">[</span>devops@workstation<span class="w"> </span>ansible<span class="o">]</span>$<span class="w"> </span>ansible<span class="w"> </span>dev<span class="w"> </span>-m<span class="w"> </span>yum<span class="w"> </span>-a<span class="w"> </span><span class="s1">&#39;name=&quot;@Development </span>
<a id="__codelineno-24-2" name="__codelineno-24-2"></a><span class="s1">Tools&quot; state=latest&#39;</span>
</code></pre></div></td></tr></table></div>
<p><strong><font style="color:rgb(0,0,0);">9.</font></strong><strong><font style="color:rgb(0,0,0);">ansible.builtin.</font></strong><strong><font style="color:rgb(0,0,0);">service </font></strong><strong><font style="color:rgb(0,0,0);">模块 </font></strong></p>
<p><font style="color:rgb(0,0,0);">ansible.builtin.service</font><font style="color:rgb(0,0,0);">模块用于服务管理和控制 </font></p>
<p><font style="color:rgb(0,0,0);">主要参数： </font></p>
<p><font style="color:rgb(0,0,0);">name: </font><font style="color:rgb(0,0,0);">服务名称 </font></p>
<p><font style="color:rgb(0,0,0);">enabled: </font><font style="color:rgb(0,0,0);">设置服务是否开机自启，默认是</font><font style="color:rgb(0,0,0);">no </font></p>
<p><font style="color:rgb(0,0,0);">state: </font><font style="color:rgb(0,0,0);">设置服务的状态。状态有： </font></p>
<p><font style="color:rgb(0,0,0);">started(</font><font style="color:rgb(0,0,0);">启动</font><font style="color:rgb(0,0,0);">) </font></p>
<p><font style="color:rgb(0,0,0);">stopped(</font><font style="color:rgb(0,0,0);">停止</font><font style="color:rgb(0,0,0);">) </font></p>
<p><font style="color:rgb(0,0,0);">restarted(重启)reloaded(重新加载配置)</font></p>
<p><font style="color:rgb(0,0,0);">重启</font><font style="color:rgb(0,0,0);">sshd</font><font style="color:rgb(0,0,0);">服务 </font></p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-25-1">1</a></span>
<span class="normal"><a href="#__codelineno-25-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-25-1" name="__codelineno-25-1"></a><span class="o">[</span>devops@workstation<span class="w"> </span>ansible<span class="o">]</span>$<span class="w"> </span>ansible<span class="w"> </span>all<span class="w"> </span>-m<span class="w"> </span>service<span class="w"> </span>-a<span class="w"> </span><span class="s1">&#39;name=sshd </span>
<a id="__codelineno-25-2" name="__codelineno-25-2"></a><span class="s1">state=restarted&#39;</span>
</code></pre></div></td></tr></table></div>
<p><strong><font style="color:rgb(0,0,0);">10. </font></strong><strong><font style="color:rgb(0,0,0);">ansible.builtin.</font></strong><strong><font style="color:rgb(0,0,0);">copy</font></strong><strong><font style="color:rgb(0,0,0);">模块 </font></strong></p>
<p><font style="color:rgb(0,0,0);">ansible.builtin.copy</font><font style="color:rgb(0,0,0);">模块用于将文件拷贝到远程主机上 </font></p>
<p><font style="color:rgb(0,0,0);">ansible.builtin.copy</font><font style="color:rgb(0,0,0);">模块的主要参数： </font></p>
<p><font style="color:rgb(0,0,0);">src: </font><font style="color:rgb(0,0,0);">指定拷贝的源文件的路径，如果拷贝的目录后面有</font><font style="color:rgb(0,0,0);">"/"</font><font style="color:rgb(0,0,0);">，则只把目录中的内容拷贝至远端， </font></p>
<p><font style="color:rgb(0,0,0);">目录后面没有</font><font style="color:rgb(0,0,0);">"/",</font><font style="color:rgb(0,0,0);">则把目录自身拷贝至远端。 </font></p>
<p><font style="color:rgb(0,0,0);">dest: </font><font style="color:rgb(0,0,0);">指定拷贝的目标路径 </font></p>
<p><font style="color:rgb(0,0,0);">content: </font><font style="color:rgb(0,0,0);">将给定的字符串内容保存至远程主机上</font><font style="color:rgb(0,0,0);">,content</font><font style="color:rgb(0,0,0);">会替代</font><font style="color:rgb(0,0,0);">src</font><font style="color:rgb(0,0,0);">参数 </font></p>
<p><font style="color:rgb(0,0,0);">backup: </font><font style="color:rgb(0,0,0);">是否对目标文件进行备份，默认是</font><font style="color:rgb(0,0,0);">no </font></p>
<p><font style="color:rgb(0,0,0);">owner: </font><font style="color:rgb(0,0,0);">设置目标文件的属主 </font></p>
<p><font style="color:rgb(0,0,0);">group: </font><font style="color:rgb(0,0,0);">设置目标文件的属组 </font></p>
<p><font style="color:rgb(0,0,0);">mode: </font><font style="color:rgb(0,0,0);">设置目标文件的权限 </font></p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-26-1">1</a></span>
<span class="normal"><a href="#__codelineno-26-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-26-1" name="__codelineno-26-1"></a><span class="o">[</span>devops@workstation<span class="w"> </span>ansible<span class="o">]</span>$<span class="w"> </span>ansible<span class="w"> </span>all<span class="w"> </span>-m<span class="w"> </span>copy<span class="w"> </span>-a<span class="w"> </span><span class="s1">&#39;src=test.txt </span>
<a id="__codelineno-26-2" name="__codelineno-26-2"></a><span class="s1">dest=/etc/motd mode=644&#39;</span>
</code></pre></div></td></tr></table></div>
<p><font style="color:rgb(0,0,0);">更多模块使用方法可以访问官方文档： </font></p>
<p><font style="color:rgb(0,0,0);">https://docs.ansible.com/ansible/latest/plugins/module.html</font></p>
<h1 id="playbook编写">playbook编写<a class="headerlink" href="#playbook编写" title="Permanent link">&para;</a></h1>
<p><strong><font style="color:rgb(0,0,0);">创建并运行playbook </font></strong></p>
<p><strong><font style="color:rgb(0,0,0);">playbook(剧本) </font></strong></p>
<p><font style="color:rgb(0,0,0);">playbook</font><font style="color:rgb(0,0,0);">是</font><font style="color:rgb(0,0,0);">ansible</font><font style="color:rgb(0,0,0);">一系列模块和命令的集合，使用</font><font style="color:rgb(0,0,0);">YAML</font><font style="color:rgb(0,0,0);">语言编写，可以编排有序的执行过程（就像电影会根据剧本向前发展）， </font></p>
<p><font style="color:rgb(0,0,0);">适合复杂的部署流程。 </font></p>
<p><strong><font style="color:rgb(0,0,0);">YAML的语法格式 </font></strong></p>
<p><font style="color:rgb(0,0,0);">1. </font><font style="color:rgb(0,0,0);">以</font><font style="color:rgb(0,0,0);">"---"</font><font style="color:rgb(0,0,0);">开头，表明这是一个</font><font style="color:rgb(0,0,0);">yaml</font><font style="color:rgb(0,0,0);">的文件。非必需，不写也没有影响 </font></p>
<p><font style="color:rgb(0,0,0);">2. </font><font style="color:rgb(0,0,0);">以</font><font style="color:rgb(0,0,0);">"#"</font><font style="color:rgb(0,0,0);">作为注释 </font></p>
<p><font style="color:rgb(0,0,0);">3. </font><font style="color:rgb(243,50,50);">同样层级关系的 必须 保持同样的 </font><strong><font style="color:rgb(243,50,50);">缩进宽度 </font></strong></p>
<p><font style="color:rgb(0,0,0);">模块中的参数，只需要比当前模块有更多缩进即可。 </font></p>
<p><font style="color:rgb(0,0,0);">无需与其他模块中的参数竖直对齐。 </font></p>
<p><font style="color:rgb(0,0,0);">同一tasks中的模块必须要竖直对齐 </font></p>
<p><font style="color:rgb(0,0,0);">4. </font><font style="color:rgb(0,0,0);">区分大小写 </font></p>
<p><font style="color:rgb(0,0,0);">5. </font><font style="color:rgb(0,0,0);">使用</font><font style="color:rgb(0,0,0);">"- "(</font><font style="color:rgb(0,0,0);">一个减号和一个空格</font><font style="color:rgb(0,0,0);">)</font><font style="color:rgb(0,0,0);">作为一个列表项 </font></p>
<p><font style="color:rgb(0,0,0);">- </font><font style="color:rgb(0,0,0);">一年级 </font></p>
<p><font style="color:rgb(0,0,0);">- </font><font style="color:rgb(0,0,0);">二年级 </font></p>
<p><font style="color:rgb(0,0,0);">- </font><font style="color:rgb(0,0,0);">三年级 </font></p>
<p><font style="color:rgb(0,0,0);">6. </font><font style="color:rgb(0,0,0);">使用</font><font style="color:rgb(0,0,0);">key: value(</font><strong><font style="color:rgb(223,64,42);">冒号</font></strong><strong><font style="color:rgb(223,64,42);">+</font></strong><strong><font style="color:rgb(223,64,42);">空格</font></strong><font style="color:rgb(0,0,0);">)</font><font style="color:rgb(0,0,0);">作为一个字典，字典一般是列表项的属性 </font></p>
<p><strong><font style="color:rgb(0,0,0);">playbook</font></strong><strong><font style="color:rgb(0,0,0);">的组成 </font></strong></p>
<p><font style="color:rgb(0,0,0);">1. </font><font style="color:rgb(0,0,0);">一个</font><font style="color:rgb(0,0,0);">playbook</font><font style="color:rgb(0,0,0);">是由一个</font><font style="color:rgb(0,0,0);">play</font><font style="color:rgb(0,0,0);">或多个</font><font style="color:rgb(0,0,0);">plays</font><font style="color:rgb(0,0,0);">组成 </font></p>
<p><font style="color:rgb(0,0,0);">2. </font><font style="color:rgb(0,0,0);">每一个</font><font style="color:rgb(0,0,0);">plays</font><font style="color:rgb(0,0,0);">是由</font><font style="color:rgb(0,0,0);"> "name"</font><font style="color:rgb(0,0,0);">、</font><font style="color:rgb(0,0,0);"> "hosts"</font><font style="color:rgb(0,0,0);">、</font><font style="color:rgb(0,0,0);"> "tasks" </font><font style="color:rgb(0,0,0);">等多个项组成，其中必须包含</font><font style="color:rgb(0,0,0);">"hosts"</font><font style="color:rgb(0,0,0);">和</font><font style="color:rgb(0,0,0);">"tasks" </font><font style="color:rgb(0,0,0);">这个两个项。 </font></p>
<p><font style="color:rgb(0,0,0);">hosts: </font><font style="color:rgb(0,0,0);">指定受管主机 </font></p>
<p><font style="color:rgb(0,0,0);">tasks: 定义将要在受管主机上运行的任务列表,一般是由多个模块构成</font></p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-27-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-27-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-27-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-27-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-27-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-27-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-27-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-27-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-27-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-27-10">10</a></span>
<span class="normal"><a href="#__codelineno-27-11">11</a></span>
<span class="normal"><a href="#__codelineno-27-12">12</a></span>
<span class="normal"><a href="#__codelineno-27-13">13</a></span>
<span class="normal"><a href="#__codelineno-27-14">14</a></span>
<span class="normal"><a href="#__codelineno-27-15">15</a></span>
<span class="normal"><a href="#__codelineno-27-16">16</a></span>
<span class="normal"><a href="#__codelineno-27-17">17</a></span>
<span class="normal"><a href="#__codelineno-27-18">18</a></span>
<span class="normal"><a href="#__codelineno-27-19">19</a></span>
<span class="normal"><a href="#__codelineno-27-20">20</a></span>
<span class="normal"><a href="#__codelineno-27-21">21</a></span>
<span class="normal"><a href="#__codelineno-27-22">22</a></span>
<span class="normal"><a href="#__codelineno-27-23">23</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-27-1" name="__codelineno-27-1"></a><span class="w"> </span>---
<a id="__codelineno-27-2" name="__codelineno-27-2"></a><span class="w"> </span>-<span class="w"> </span>name:<span class="w"> </span>任务一
<a id="__codelineno-27-3" name="__codelineno-27-3"></a><span class="w">   </span>hosts:<span class="w"> </span>webservers
<a id="__codelineno-27-4" name="__codelineno-27-4"></a><span class="w">   </span>tasks:
<a id="__codelineno-27-5" name="__codelineno-27-5"></a><span class="w">     </span>-<span class="w"> </span>name:<span class="w"> </span>复制文件
<a id="__codelineno-27-6" name="__codelineno-27-6"></a><span class="w">       </span>ansible.builtin.copy:
<a id="__codelineno-27-7" name="__codelineno-27-7"></a><span class="w">         </span>src:<span class="w"> </span>testpage
<a id="__codelineno-27-8" name="__codelineno-27-8"></a><span class="w">         </span>dest:<span class="w"> </span>/var/www/html/index.html
<a id="__codelineno-27-9" name="__codelineno-27-9"></a><span class="w">         </span>group:<span class="w"> </span>apache
<a id="__codelineno-27-10" name="__codelineno-27-10"></a><span class="w">         </span>owner:<span class="w"> </span>apache
<a id="__codelineno-27-11" name="__codelineno-27-11"></a><span class="w">         </span>mode:<span class="w"> </span><span class="m">0660</span>
<a id="__codelineno-27-12" name="__codelineno-27-12"></a><span class="w">     </span>-<span class="w"> </span>name:<span class="w"> </span>重启httpd
<a id="__codelineno-27-13" name="__codelineno-27-13"></a><span class="w">       </span>ansible.builtin.service:
<a id="__codelineno-27-14" name="__codelineno-27-14"></a><span class="w">         </span>name:<span class="w"> </span>httpd
<a id="__codelineno-27-15" name="__codelineno-27-15"></a><span class="w">         </span>state:<span class="w"> </span>restarted
<a id="__codelineno-27-16" name="__codelineno-27-16"></a>
<a id="__codelineno-27-17" name="__codelineno-27-17"></a><span class="w"> </span>-<span class="w"> </span>name:<span class="w"> </span>任务二
<a id="__codelineno-27-18" name="__codelineno-27-18"></a><span class="w">   </span>hosts:<span class="w"> </span>dbserver
<a id="__codelineno-27-19" name="__codelineno-27-19"></a><span class="w">   </span>tasks:
<a id="__codelineno-27-20" name="__codelineno-27-20"></a><span class="w">     </span>-<span class="w"> </span>name:<span class="w"> </span>重启服务
<a id="__codelineno-27-21" name="__codelineno-27-21"></a><span class="w">       </span>ansible.builtin.service:
<a id="__codelineno-27-22" name="__codelineno-27-22"></a><span class="w">         </span>name:<span class="w"> </span>mariadb
<a id="__codelineno-27-23" name="__codelineno-27-23"></a><span class="w">         </span>state:<span class="w"> </span>restarted
</code></pre></div></td></tr></table></div>
<p><font style="color:rgb(0,0,0);">上面这个</font><font style="color:rgb(0,0,0);">playbook</font><font style="color:rgb(0,0,0);">是由两个</font><font style="color:rgb(0,0,0);">plays</font><font style="color:rgb(0,0,0);">组成，分别是对两个主机组执行任务。 </font></p>
<p><font style="color:rgb(0,0,0);">playbook</font><font style="color:rgb(0,0,0);">中的缩进： </font></p>
<p><font style="color:rgb(0,0,0);">1.</font><font style="color:rgb(0,0,0);">同级的对象须有相同的缩进 </font></p>
<p><font style="color:rgb(0,0,0);">2.子对象必须比父对象有更多的缩进</font></p>
<p><strong><font style="color:rgb(0,0,0);">创建一个</font></strong><strong><font style="color:rgb(0,0,0);">playbook</font></strong><strong><font style="color:rgb(0,0,0);">文件 </font></strong></p>
<p><font style="color:rgb(0,0,0);">playboobk</font><font style="color:rgb(0,0,0);">文件通常会以</font><font style="color:rgb(0,0,0);">".yml"</font><font style="color:rgb(0,0,0);">作或</font><font style="color:rgb(0,0,0);">".yaml"</font><font style="color:rgb(0,0,0);">为后缀 </font></p>
<p><font style="color:rgb(0,0,0);">为了在使用</font><font style="color:rgb(0,0,0);">vim</font><font style="color:rgb(0,0,0);">编辑</font><font style="color:rgb(0,0,0);">playbook</font><font style="color:rgb(0,0,0);">时候方便，在家目录下修改下</font><font style="color:rgb(0,0,0);">vim</font><font style="color:rgb(0,0,0);">的默认配置 </font></p>
<p><font style="color:rgb(0,0,0);">在当前用户家目录下编辑</font><font style="color:rgb(0,0,0);">~/.vimrc </font></p>
<p><font style="color:rgb(0,0,0);">添加一行配置"</font><font style="color:rgb(223,64,42);">autocmd filetype yaml setlocal ai ts=2 sw=2 et</font><font style="color:rgb(0,0,0);">"</font></p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-28-1">1</a></span>
<span class="normal"><a href="#__codelineno-28-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-28-1" name="__codelineno-28-1"></a><span class="o">[</span>difu@control<span class="w"> </span>~<span class="o">]</span>$<span class="w"> </span>vim<span class="w"> </span>~/.vimrc
<a id="__codelineno-28-2" name="__codelineno-28-2"></a>autocmd<span class="w"> </span>filetype<span class="w"> </span>yaml<span class="w"> </span>setlocal<span class="w"> </span>ai<span class="w"> </span><span class="nv">ts</span><span class="o">=</span><span class="m">2</span><span class="w"> </span><span class="nv">sw</span><span class="o">=</span><span class="m">2</span><span class="w"> </span>et
</code></pre></div></td></tr></table></div>
<p><font style="color:rgb(0,0,0);">创建</font><font style="color:rgb(0,0,0);">playbook </font></p>
<p><font style="color:rgb(0,0,0);">注意：</font><font style="color:rgb(0,0,0);"> tasks</font><font style="color:rgb(0,0,0);">下每个</font><font style="color:rgb(0,0,0);">name</font><font style="color:rgb(0,0,0);">中只能有一个任务 </font></p>
<p><font style="color:rgb(0,0,0);">[difu@control ansible]$ vim test1.yml </font></p>
<p><font style="color:rgb(0,0,0);">下图为</font><font style="color:rgb(0,0,0);"> RHCE8</font><font style="color:rgb(0,0,0);">范例 </font></p>
<p><font style="color:rgb(0,0,0);">在RHCE9中，yum_repository模块名添加 ansible.builtin. 即可</font></p>
<p><img alt="" src="../../../../images/1718766447160-fb5719a1-c2ea-42c9-a726-6a2bdfebba95.png" /></p>
<p><font style="color:rgb(0,0,0);">这个</font><font style="color:rgb(0,0,0);">playbook</font><font style="color:rgb(0,0,0);">只有一个任务，在</font><font style="color:rgb(0,0,0);">RHCE9</font><font style="color:rgb(0,0,0);">中需要使用</font><font style="color:rgb(0,0,0);">ansible.builtin.yum_rpeository</font><font style="color:rgb(0,0,0);">模块， </font></p>
<p><strong><font style="color:rgb(0,0,0);">检查</font></strong><strong><font style="color:rgb(0,0,0);">playbook</font></strong><strong><font style="color:rgb(0,0,0);">文件语法 </font></strong></p>
<p><font style="color:rgb(0,0,0);">使用</font><font style="color:rgb(0,0,0);">--syntax-check</font><font style="color:rgb(0,0,0);">选项检测语法，如果有语法上的错误，则会给出相应的提示。 </font></p>
<p><font style="color:rgb(0,0,0);">以下为RHCE8中执行命令方式，在RHCE9中仍然适用。 </font></p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-29-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-29-1" name="__codelineno-29-1"></a><span class="o">[</span>devops@workstation<span class="w"> </span>ansible<span class="o">]</span>$<span class="w"> </span>ansible-playbook<span class="w"> </span>--syntax-check<span class="w"> </span>test1.yml
</code></pre></div></td></tr></table></div>
<p><img alt="" src="../../../../images/1718766462958-ae73f478-fab8-46c5-bb4d-596592c4037c.png" /></p>
<p><font style="color:rgb(0,0,0);">RHCE9方式： </font></p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-30-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-30-1" name="__codelineno-30-1"></a><span class="o">[</span>devops@workstation<span class="w"> </span>ansible<span class="o">]</span>$<span class="w"> </span>ansible-navigator<span class="w"> </span>run<span class="w"> </span>--syntax-check<span class="w"> </span>test1.yml<span class="w"> </span>-m<span class="w"> </span>stdout<span class="w"> </span>
</code></pre></div></td></tr></table></div>
<p><font style="color:rgb(0,0,0);">注意：在RHEL9中，以下操作仍然适用。 </font></p>
<p><strong><font style="color:rgb(0,0,0);">运行</font></strong><strong><font style="color:rgb(0,0,0);">playbook </font></strong></p>
<p><font style="color:rgb(0,0,0);">使用</font><font style="color:rgb(0,0,0);">ansible-playbook</font><font style="color:rgb(0,0,0);">运行</font><font style="color:rgb(0,0,0);">playbook </font></p>
<p><font style="color:rgb(0,0,0);">ansible-playbook</font><font style="color:rgb(0,0,0);">常用的选项 </font></p>
<p><font style="color:rgb(0,0,0);">--syntax-check </font><font style="color:rgb(0,0,0);">检查</font><font style="color:rgb(0,0,0);">playbook</font><font style="color:rgb(0,0,0);">的语法 </font></p>
<p><font style="color:rgb(0,0,0);">--list-tasks </font><font style="color:rgb(0,0,0);">列出将要被执行的</font><font style="color:rgb(0,0,0);">tasks </font></p>
<p><font style="color:rgb(0,0,0);">-C </font><font style="color:rgb(0,0,0);">模拟运行</font><font style="color:rgb(0,0,0);">playbook </font></p>
<p><font style="color:rgb(0,0,0);">-v /-vv / -vvv </font><font style="color:rgb(0,0,0);">显示运行</font><font style="color:rgb(0,0,0);">playbook</font><font style="color:rgb(0,0,0);">的详细过程 </font></p>
<p><font style="color:rgb(223,64,42);">playbook</font><font style="color:rgb(223,64,42);">执行是从上至下依次顺序执行，当某个任务在某个主机上执行错误或失败时，后续所有的任务都不再执行。 </font></p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-31-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-31-1" name="__codelineno-31-1"></a><span class="o">[</span>devops@workstation<span class="w"> </span>ansible<span class="o">]</span>$<span class="w"> </span>ansible-playbook<span class="w"> </span>test1.yml<span class="w"> </span>
</code></pre></div></td></tr></table></div>
<p><font style="color:rgb(223,64,42);">执行结果</font></p>
<p><img alt="" src="../../../../images/1718766486301-859622d0-8f31-47a2-a282-aa25eb240e4b.png" /></p>
<p><font style="color:rgb(0,0,0);">在</font><font style="color:rgb(0,0,0);">test1.yml</font><font style="color:rgb(0,0,0);">上继续扩充 </font></p>
<p><font style="color:rgb(0,0,0);">现在这个playbook一共有两个任务，分别是创建YUM仓库文件，重启防火墙.</font></p>
<p><img alt="" src="../../../../images/1718766498489-db4f82f6-30f5-4e62-be8e-436b046d242f.png" /> </p>
<p><font style="color:rgb(223,64,42);">执行结果</font></p>
<p><img alt="" src="../../../../images/1718766509014-4ba3ddcd-aa3d-4ab6-86a4-a588c5a66fbb.png" /></p>
<p><strong><font style="color:rgb(0,0,0);">定义</font></strong><strong><font style="color:rgb(0,0,0);">tasks</font></strong><strong><font style="color:rgb(0,0,0);">的一些细节 </font></strong></p>
<p><font style="color:rgb(0,0,0);">1.</font><font style="color:rgb(0,0,0);">一个</font><font style="color:rgb(0,0,0);">tasks</font><font style="color:rgb(0,0,0);">包含一个或多个任务，每个任务是由</font><font style="color:rgb(0,0,0);">ansible</font><font style="color:rgb(0,0,0);">对应的模块来完成 </font></p>
<p><font style="color:rgb(0,0,0);">2.</font><font style="color:rgb(0,0,0);">每个任务都可以加上</font><font style="color:rgb(0,0,0);">name</font><font style="color:rgb(0,0,0);">项，</font><font style="color:rgb(0,0,0);">name</font><font style="color:rgb(0,0,0);">只是一个描述任务的语句，可以定义在任何地方</font><font style="color:rgb(0,0,0);">(</font><font style="color:rgb(0,0,0);">也可以省略不写</font><font style="color:rgb(0,0,0);">) </font></p>
<p><font style="color:rgb(0,0,0);">3.tasks中还可以通过include和import来导入其他的playbook文件</font></p>
<h1 id="使用ansible-vault加密"><font style="color:rgb(0,0,0);">使用</font><strong><font style="color:rgb(0,0,0);">ansible vault加密</font></strong><a class="headerlink" href="#使用ansible-vault加密" title="Permanent link">&para;</a></h1>
<p><strong><font style="color:rgb(0,0,0);">为什么要加密 </font></strong></p>
<p><font style="color:rgb(0,0,0);">在</font><font style="color:rgb(0,0,0);">playbook</font><font style="color:rgb(0,0,0);">或主机清单中，通常会为了配置方便，可能会把密码或密钥等敏感数据以明文的方式存储 </font></p>
<p><font style="color:rgb(0,0,0);">在</font><font style="color:rgb(0,0,0);">playbook</font><font style="color:rgb(0,0,0);">或</font><font style="color:rgb(0,0,0);">inventory</font><font style="color:rgb(0,0,0);">文件中，很明显这样是不安全的，</font><font style="color:rgb(0,0,0);">ansible</font><font style="color:rgb(0,0,0);">已经考虑到这个情况，可以使 </font></p>
<p><font style="color:rgb(0,0,0);">用</font><font style="color:rgb(0,0,0);">ansible-vault</font><font style="color:rgb(0,0,0);">对敏感数据进行加密。 </font></p>
<p><strong><font style="color:rgb(0,0,0);">ansible-valut </font></strong></p>
<p><font style="color:rgb(0,0,0);">ansible-vault</font><font style="color:rgb(0,0,0);">可以用来创建、编辑、加密、解密和查看文件。</font><font style="color:rgb(0,0,0);">ansible-vault</font><font style="color:rgb(0,0,0);">可以对</font><font style="color:rgb(0,0,0);">ansible</font><font style="color:rgb(0,0,0);">中 </font></p>
<p><font style="color:rgb(0,0,0);">的任何文件进行加密，包括playbook文件，inventory文件，变量文件，tasks文件，roles中的文件。</font></p>
<p><strong><font style="color:rgb(0,0,0);">使用ansible-vault加密文件</font></strong></p>
<p><strong><font style="color:rgb(0,0,0);">加密</font></strong><strong><font style="color:rgb(0,0,0);">inventory</font></strong><strong><font style="color:rgb(0,0,0);">文件 </font></strong></p>
<p><font style="color:rgb(0,0,0);">对已存在的文件进行加密</font></p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-32-1">1</a></span>
<span class="normal"><a href="#__codelineno-32-2">2</a></span>
<span class="normal"><a href="#__codelineno-32-3">3</a></span>
<span class="normal"><a href="#__codelineno-32-4">4</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-32-1" name="__codelineno-32-1"></a><span class="o">[</span>devops@workstation<span class="w"> </span>ansible<span class="o">]</span>$<span class="w"> </span>ansible-vault<span class="w"> </span>encrypt<span class="w"> </span>inventory
<a id="__codelineno-32-2" name="__codelineno-32-2"></a><span class="w"> </span>New<span class="w"> </span>Vault<span class="w"> </span>password:<span class="w"> </span>（设置密码）
<a id="__codelineno-32-3" name="__codelineno-32-3"></a><span class="w"> </span>Confirm<span class="w"> </span>New<span class="w"> </span>Vault<span class="w"> </span>password:<span class="w"> </span>（确认密码）
<a id="__codelineno-32-4" name="__codelineno-32-4"></a><span class="w"> </span>Encryption<span class="w"> </span>successful
</code></pre></div></td></tr></table></div>
<p><font style="color:rgb(0,0,0);">加密之后，inventory文件就变成密文了</font></p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-33-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-33-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-33-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-33-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-33-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-33-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-33-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-33-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-33-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-33-10">10</a></span>
<span class="normal"><a href="#__codelineno-33-11">11</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-33-1" name="__codelineno-33-1"></a><span class="o">[</span>devops@workstation<span class="w"> </span>ansible<span class="o">]</span>$<span class="w"> </span>cat<span class="w"> </span>inventory
<a id="__codelineno-33-2" name="__codelineno-33-2"></a><span class="nv">$ANSIBLE_VAULT</span><span class="p">;</span><span class="m">1</span>.1<span class="p">;</span>AES256
<a id="__codelineno-33-3" name="__codelineno-33-3"></a><span class="m">30636162333430613664393161663662613934313563323736383066316135346236376664313664</span>
<a id="__codelineno-33-4" name="__codelineno-33-4"></a><span class="w"> </span>3932366563326634383737353161386534386462643733380a663834303238373637376434396135
<a id="__codelineno-33-5" name="__codelineno-33-5"></a><span class="w"> </span><span class="m">66643535383535383963373233316362633630306535333332373438376162303661356463633866</span>
<a id="__codelineno-33-6" name="__codelineno-33-6"></a><span class="w"> </span>3935653939363132310a376132326437396364313932396238623832383261613862633135356464
<a id="__codelineno-33-7" name="__codelineno-33-7"></a><span class="w"> </span><span class="m">39636630346530396130303062316433643436343863626534353537353563313134386436373564</span>
<a id="__codelineno-33-8" name="__codelineno-33-8"></a><span class="w"> </span><span class="m">64303234363638336333346631626531386339643364623735376639326566633537646234393866</span>
<a id="__codelineno-33-9" name="__codelineno-33-9"></a><span class="w"> </span><span class="m">66393439373861393832616537323733643133643836346562666466336664363765316331663138</span>
<a id="__codelineno-33-10" name="__codelineno-33-10"></a><span class="w"> </span><span class="m">63323365366465623363353438323662386163373961646631346164633234363438353831663465</span>
<a id="__codelineno-33-11" name="__codelineno-33-11"></a><span class="w"> </span><span class="m">6233</span>
</code></pre></div></td></tr></table></div>
<p><font style="color:rgb(0,0,0);">运行ad-hoc命令或playbook 就会出错，因为无法读取inventory文件</font></p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-34-1">1</a></span>
<span class="normal"><a href="#__codelineno-34-2">2</a></span>
<span class="normal"><a href="#__codelineno-34-3">3</a></span>
<span class="normal"><a href="#__codelineno-34-4">4</a></span>
<span class="normal"><a href="#__codelineno-34-5">5</a></span>
<span class="normal"><a href="#__codelineno-34-6">6</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-34-1" name="__codelineno-34-1"></a><span class="w"> </span><span class="o">[</span>devops@workstation<span class="w"> </span>ansible<span class="o">]</span>$<span class="w"> </span>ansible<span class="w"> </span>all<span class="w"> </span>-m<span class="w"> </span>ping
<a id="__codelineno-34-2" name="__codelineno-34-2"></a><span class="w"> </span><span class="o">[</span>WARNING<span class="o">]</span>:<span class="w"> </span>*<span class="w"> </span>Failed<span class="w"> </span>to<span class="w"> </span>parse<span class="w"> </span>/home/devops/ansible/inventory<span class="w"> </span>with<span class="w"> </span>yaml<span class="w"> </span>plugin:<span class="w"> </span>Attempting
<a id="__codelineno-34-3" name="__codelineno-34-3"></a><span class="w"> </span><span class="o">[</span>WARNING<span class="o">]</span>:<span class="w"> </span>*<span class="w"> </span>Failed<span class="w"> </span>to<span class="w"> </span>parse<span class="w"> </span>/home/devops/ansible/inventory<span class="w"> </span>with<span class="w"> </span>ini<span class="w"> </span>plugin:<span class="w"> </span>Attempting<span class="w"> </span>
<a id="__codelineno-34-4" name="__codelineno-34-4"></a><span class="w"> </span><span class="o">[</span>WARNING<span class="o">]</span>:<span class="w"> </span>Unable<span class="w"> </span>to<span class="w"> </span>parse<span class="w"> </span>/home/devops/ansible/inventory<span class="w"> </span>as<span class="w"> </span>an<span class="w"> </span>inventory<span class="w"> </span><span class="nb">source</span>
<a id="__codelineno-34-5" name="__codelineno-34-5"></a><span class="w"> </span><span class="o">[</span>WARNING<span class="o">]</span>:<span class="w"> </span>No<span class="w"> </span>inventory<span class="w"> </span>was<span class="w"> </span>parsed,<span class="w"> </span>only<span class="w"> </span>implicit<span class="w"> </span>localhost<span class="w"> </span>is<span class="w"> </span>available
<a id="__codelineno-34-6" name="__codelineno-34-6"></a><span class="w"> </span><span class="o">[</span>WARNING<span class="o">]</span>:<span class="w"> </span>provided<span class="w"> </span>hosts<span class="w"> </span>list<span class="w"> </span>is<span class="w"> </span>empty,<span class="w"> </span>only<span class="w"> </span>localhost<span class="w"> </span>is<span class="w"> </span>available.<span class="w"> </span>Note<span class="w"> </span>that<span class="w"> </span>the<span class="w"> </span>impli
</code></pre></div></td></tr></table></div>
<p><font style="color:rgb(0,0,0);">需要加上--ask-vault-pass ，提示输入密码才能运行</font></p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-35-1">1</a></span>
<span class="normal"><a href="#__codelineno-35-2">2</a></span>
<span class="normal"><a href="#__codelineno-35-3">3</a></span>
<span class="normal"><a href="#__codelineno-35-4">4</a></span>
<span class="normal"><a href="#__codelineno-35-5">5</a></span>
<span class="normal"><a href="#__codelineno-35-6">6</a></span>
<span class="normal"><a href="#__codelineno-35-7">7</a></span>
<span class="normal"><a href="#__codelineno-35-8">8</a></span>
<span class="normal"><a href="#__codelineno-35-9">9</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-35-1" name="__codelineno-35-1"></a><span class="w"> </span><span class="o">[</span>devops@workstation<span class="w"> </span>ansible<span class="o">]</span>$<span class="w"> </span>ansible<span class="w"> </span>dev<span class="w"> </span>-m<span class="w"> </span>ping<span class="w"> </span>--ask-vault-pass
<a id="__codelineno-35-2" name="__codelineno-35-2"></a><span class="w"> </span>Vault<span class="w"> </span>password:<span class="w"> </span><span class="o">(</span>输入密码<span class="o">)</span>
<a id="__codelineno-35-3" name="__codelineno-35-3"></a><span class="w"> </span>node1<span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="nv">SUCCESS</span><span class="w"> </span><span class="o">=</span>&gt;<span class="w"> </span><span class="o">{</span>
<a id="__codelineno-35-4" name="__codelineno-35-4"></a><span class="w"> </span><span class="s2">&quot;ansible_facts&quot;</span>:<span class="w"> </span><span class="o">{</span>
<a id="__codelineno-35-5" name="__codelineno-35-5"></a><span class="w"> </span><span class="s2">&quot;discovered_interpreter_python&quot;</span>:<span class="w"> </span><span class="s2">&quot;/usr/libexec/platform-python&quot;</span>
<a id="__codelineno-35-6" name="__codelineno-35-6"></a><span class="w"> </span><span class="o">}</span>,
<a id="__codelineno-35-7" name="__codelineno-35-7"></a><span class="w"> </span><span class="s2">&quot;changed&quot;</span>:<span class="w"> </span>false,
<a id="__codelineno-35-8" name="__codelineno-35-8"></a><span class="w"> </span><span class="s2">&quot;ping&quot;</span>:<span class="w"> </span><span class="s2">&quot;pong&quot;</span>
<a id="__codelineno-35-9" name="__codelineno-35-9"></a><span class="w"> </span><span class="o">}</span>
</code></pre></div></td></tr></table></div>
<p><strong><font style="color:rgb(0,0,0);">创建一个加密的playbook</font></strong></p>
<p><font style="color:rgb(0,0,0);">创建一个新文件并进行加密</font></p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-36-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-36-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-36-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-36-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-36-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-36-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-36-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-36-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-36-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-36-10">10</a></span>
<span class="normal"><a href="#__codelineno-36-11">11</a></span>
<span class="normal"><a href="#__codelineno-36-12">12</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-36-1" name="__codelineno-36-1"></a><span class="o">[</span>devops@workstation<span class="w"> </span>ansible<span class="o">]</span>$<span class="w"> </span>ansible-vault<span class="w"> </span>create<span class="w"> </span>site.yml
<a id="__codelineno-36-2" name="__codelineno-36-2"></a><span class="w"> </span>New<span class="w"> </span>Vault<span class="w"> </span>password:<span class="w"> </span>（设置密码）
<a id="__codelineno-36-3" name="__codelineno-36-3"></a><span class="w"> </span>Confirm<span class="w"> </span>New<span class="w"> </span>Vault<span class="w"> </span>password:<span class="w"> </span>（确认密码）
<a id="__codelineno-36-4" name="__codelineno-36-4"></a>
<a id="__codelineno-36-5" name="__codelineno-36-5"></a><span class="w"> </span>---
<a id="__codelineno-36-6" name="__codelineno-36-6"></a><span class="w"> </span>-<span class="w"> </span>name:<span class="w"> </span><span class="nb">test</span>
<a id="__codelineno-36-7" name="__codelineno-36-7"></a><span class="w"> </span>hosts:<span class="w"> </span>all
<a id="__codelineno-36-8" name="__codelineno-36-8"></a><span class="w"> </span>tasks:
<a id="__codelineno-36-9" name="__codelineno-36-9"></a><span class="w"> </span>-<span class="w"> </span>name:<span class="w"> </span>test1
<a id="__codelineno-36-10" name="__codelineno-36-10"></a><span class="w"> </span>ansible.builtin.service:
<a id="__codelineno-36-11" name="__codelineno-36-11"></a><span class="w"> </span>name:<span class="w"> </span>firewalld
<a id="__codelineno-36-12" name="__codelineno-36-12"></a><span class="w"> </span>state:<span class="w"> </span>stopped
</code></pre></div></td></tr></table></div>
<p><strong><font style="color:rgb(0,0,0);">查看加密后的密文</font></strong></p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-37-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-37-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-37-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-37-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-37-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-37-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-37-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-37-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-37-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-37-10">10</a></span>
<span class="normal"><a href="#__codelineno-37-11">11</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-37-1" name="__codelineno-37-1"></a><span class="w"> </span><span class="o">[</span>devops@workstation<span class="w"> </span>ansible<span class="o">]</span>$<span class="w"> </span>cat<span class="w"> </span>site.yml
<a id="__codelineno-37-2" name="__codelineno-37-2"></a><span class="w"> </span><span class="nv">$ANSIBLE_VAULT</span><span class="p">;</span><span class="m">1</span>.1<span class="p">;</span>AES256
<a id="__codelineno-37-3" name="__codelineno-37-3"></a><span class="w"> </span><span class="m">32393938626532336437303434336132313261313437353730333732343935663437633731613266</span>
<a id="__codelineno-37-4" name="__codelineno-37-4"></a><span class="w"> </span>3039353439663130626436373466623362383966626338640a623366323439663537613239646239
<a id="__codelineno-37-5" name="__codelineno-37-5"></a><span class="w"> </span><span class="m">37323461356162643165653864633236623738626233313563373930373864333964633761613132</span>
<a id="__codelineno-37-6" name="__codelineno-37-6"></a><span class="w"> </span>3534343361373938340a633031623364653935613936343864363430653064346437356364626533
<a id="__codelineno-37-7" name="__codelineno-37-7"></a><span class="w"> </span><span class="m">61353134356131643037613565313466623639316130653862396165376466643830643063353437</span>
<a id="__codelineno-37-8" name="__codelineno-37-8"></a><span class="w"> </span><span class="m">62346439333835353762366533323961373038656164353761326662303231353130616564306236</span>
<a id="__codelineno-37-9" name="__codelineno-37-9"></a><span class="w"> </span><span class="m">63326363623261386664323762613263343565323064626135336465636462353433623930353865</span>
<a id="__codelineno-37-10" name="__codelineno-37-10"></a><span class="w"> </span><span class="m">62633432323536303932336364643135653032646566343738393764393661323438396662653765</span>
<a id="__codelineno-37-11" name="__codelineno-37-11"></a><span class="w"> </span><span class="m">31646462656238653038633939393862663631343032336432383230396564353562</span>
</code></pre></div></td></tr></table></div>
<p><strong><font style="color:rgb(0,0,0);">解密被加密的文件</font></strong></p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-38-1">1</a></span>
<span class="normal"><a href="#__codelineno-38-2">2</a></span>
<span class="normal"><a href="#__codelineno-38-3">3</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-38-1" name="__codelineno-38-1"></a><span class="o">[</span>devops@workstation<span class="w"> </span>ansible<span class="o">]</span>$<span class="w"> </span>ansible-vault<span class="w"> </span>decrypt<span class="w"> </span>inventory
<a id="__codelineno-38-2" name="__codelineno-38-2"></a><span class="w"> </span>Vault<span class="w"> </span>password:
<a id="__codelineno-38-3" name="__codelineno-38-3"></a><span class="w">  </span>Decryption<span class="w"> </span>successful
</code></pre></div></td></tr></table></div>
<p><strong><font style="color:rgb(0,0,0);">执行加密的</font></strong><strong><font style="color:rgb(0,0,0);">playbook </font></strong></p>
<p><font style="color:rgb(0,0,0);">直接执行会提示错误，需要加--ask-vault-pass</font></p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-39-1">1</a></span>
<span class="normal"><a href="#__codelineno-39-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-39-1" name="__codelineno-39-1"></a><span class="o">[</span>devops@workstation<span class="w"> </span>ansible<span class="o">]</span>$<span class="w"> </span>ansible-playbook<span class="w"> </span>site.yml
<a id="__codelineno-39-2" name="__codelineno-39-2"></a><span class="w"> </span>ERROR!<span class="w"> </span>Attempting<span class="w"> </span>to<span class="w"> </span>decrypt<span class="w"> </span>but<span class="w"> </span>no<span class="w"> </span>vault<span class="w"> </span>secrets<span class="w"> </span>found
</code></pre></div></td></tr></table></div>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-40-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-40-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-40-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-40-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-40-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-40-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-40-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-40-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-40-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-40-10">10</a></span>
<span class="normal"><a href="#__codelineno-40-11">11</a></span>
<span class="normal"><a href="#__codelineno-40-12">12</a></span>
<span class="normal"><a href="#__codelineno-40-13">13</a></span>
<span class="normal"><a href="#__codelineno-40-14">14</a></span>
<span class="normal"><a href="#__codelineno-40-15">15</a></span>
<span class="normal"><a href="#__codelineno-40-16">16</a></span>
<span class="normal"><a href="#__codelineno-40-17">17</a></span>
<span class="normal"><a href="#__codelineno-40-18">18</a></span>
<span class="normal"><a href="#__codelineno-40-19">19</a></span>
<span class="normal"><a href="#__codelineno-40-20">20</a></span>
<span class="normal"><a href="#__codelineno-40-21">21</a></span>
<span class="normal"><a href="#__codelineno-40-22">22</a></span>
<span class="normal"><a href="#__codelineno-40-23">23</a></span>
<span class="normal"><a href="#__codelineno-40-24">24</a></span>
<span class="normal"><a href="#__codelineno-40-25">25</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-40-1" name="__codelineno-40-1"></a><span class="o">[</span>devops@workstation<span class="w"> </span>ansible<span class="o">]</span>$<span class="w"> </span>ansible-playbook<span class="w"> </span>site.yml<span class="w"> </span>--ask-vault-pass
<a id="__codelineno-40-2" name="__codelineno-40-2"></a><span class="w"> </span>Vault<span class="w"> </span>password:<span class="w"> </span>（输入密码）
<a id="__codelineno-40-3" name="__codelineno-40-3"></a>
<a id="__codelineno-40-4" name="__codelineno-40-4"></a><span class="w"> </span>PLAY<span class="w"> </span><span class="o">[</span>test<span class="o">]</span><span class="w"> </span>*****************************************************************************
<a id="__codelineno-40-5" name="__codelineno-40-5"></a>
<a id="__codelineno-40-6" name="__codelineno-40-6"></a><span class="w"> </span>TASK<span class="w"> </span><span class="o">[</span>Gathering<span class="w"> </span>Facts<span class="o">]</span><span class="w"> </span>******************************************************************
<a id="__codelineno-40-7" name="__codelineno-40-7"></a><span class="w"> </span>ok:<span class="w"> </span><span class="o">[</span>node1<span class="o">]</span>
<a id="__codelineno-40-8" name="__codelineno-40-8"></a><span class="w"> </span>ok:<span class="w"> </span><span class="o">[</span>node4<span class="o">]</span>
<a id="__codelineno-40-9" name="__codelineno-40-9"></a><span class="w"> </span>ok:<span class="w"> </span><span class="o">[</span>node3<span class="o">]</span>
<a id="__codelineno-40-10" name="__codelineno-40-10"></a><span class="w"> </span>ok:<span class="w"> </span><span class="o">[</span>node2<span class="o">]</span>
<a id="__codelineno-40-11" name="__codelineno-40-11"></a><span class="w"> </span>ok:<span class="w"> </span><span class="o">[</span>node5<span class="o">]</span>
<a id="__codelineno-40-12" name="__codelineno-40-12"></a>
<a id="__codelineno-40-13" name="__codelineno-40-13"></a><span class="w"> </span>TASK<span class="w"> </span><span class="o">[</span>test1<span class="o">]</span><span class="w"> </span>****************************************************************************
<a id="__codelineno-40-14" name="__codelineno-40-14"></a><span class="w"> </span>changed:<span class="w"> </span><span class="o">[</span>node3<span class="o">]</span>
<a id="__codelineno-40-15" name="__codelineno-40-15"></a><span class="w"> </span>changed:<span class="w"> </span><span class="o">[</span>node5<span class="o">]</span>
<a id="__codelineno-40-16" name="__codelineno-40-16"></a><span class="w"> </span>changed:<span class="w"> </span><span class="o">[</span>node2<span class="o">]</span>
<a id="__codelineno-40-17" name="__codelineno-40-17"></a><span class="w"> </span>changed:<span class="w"> </span><span class="o">[</span>node1<span class="o">]</span>
<a id="__codelineno-40-18" name="__codelineno-40-18"></a><span class="w"> </span>changed:<span class="w"> </span><span class="o">[</span>node4<span class="o">]</span>
<a id="__codelineno-40-19" name="__codelineno-40-19"></a>
<a id="__codelineno-40-20" name="__codelineno-40-20"></a><span class="w"> </span>PLAY<span class="w"> </span>RECAP<span class="w"> </span>******************************************************************************
<a id="__codelineno-40-21" name="__codelineno-40-21"></a><span class="w"> </span>node1<span class="w"> </span>:<span class="w"> </span><span class="nv">ok</span><span class="o">=</span><span class="m">2</span><span class="w"> </span><span class="nv">changed</span><span class="o">=</span><span class="m">1</span><span class="w"> </span><span class="nv">unreachable</span><span class="o">=</span><span class="m">0</span><span class="w"> </span><span class="nv">failed</span><span class="o">=</span><span class="m">0</span><span class="w"> </span><span class="nv">skipped</span><span class="o">=</span><span class="m">0</span>
<a id="__codelineno-40-22" name="__codelineno-40-22"></a><span class="w"> </span>node2<span class="w"> </span>:<span class="w"> </span><span class="nv">ok</span><span class="o">=</span><span class="m">2</span><span class="w"> </span><span class="nv">changed</span><span class="o">=</span><span class="m">1</span><span class="w"> </span><span class="nv">unreachable</span><span class="o">=</span><span class="m">0</span><span class="w"> </span><span class="nv">failed</span><span class="o">=</span><span class="m">0</span><span class="w"> </span><span class="nv">skipped</span><span class="o">=</span><span class="m">0</span>
<a id="__codelineno-40-23" name="__codelineno-40-23"></a><span class="w"> </span>node3<span class="w"> </span>:<span class="w"> </span><span class="nv">ok</span><span class="o">=</span><span class="m">2</span><span class="w"> </span><span class="nv">changed</span><span class="o">=</span><span class="m">1</span><span class="w"> </span><span class="nv">unreachable</span><span class="o">=</span><span class="m">0</span><span class="w"> </span><span class="nv">failed</span><span class="o">=</span><span class="m">0</span><span class="w"> </span><span class="nv">skipped</span><span class="o">=</span><span class="m">0</span>
<a id="__codelineno-40-24" name="__codelineno-40-24"></a><span class="w"> </span>node4<span class="w"> </span>:<span class="w"> </span><span class="nv">ok</span><span class="o">=</span><span class="m">2</span><span class="w"> </span><span class="nv">changed</span><span class="o">=</span><span class="m">1</span><span class="w"> </span><span class="nv">unreachable</span><span class="o">=</span><span class="m">0</span><span class="w"> </span><span class="nv">failed</span><span class="o">=</span><span class="m">0</span><span class="w"> </span><span class="nv">skipped</span><span class="o">=</span><span class="m">0</span>
<a id="__codelineno-40-25" name="__codelineno-40-25"></a><span class="w"> </span>node5<span class="w"> </span>:<span class="w"> </span><span class="nv">ok</span><span class="o">=</span><span class="m">2</span><span class="w"> </span><span class="nv">changed</span><span class="o">=</span><span class="m">1</span><span class="w"> </span><span class="nv">unreachable</span><span class="o">=</span><span class="m">0</span><span class="w"> </span><span class="nv">failed</span><span class="o">=</span><span class="m">0</span><span class="w"> </span><span class="nv">skipped</span><span class="o">=</span><span class="m">0</span>
</code></pre></div></td></tr></table></div>
<p><font style="color:rgb(0,0,0);">--ask-vault-pass </font><font style="color:rgb(0,0,0);">是一种交互式的询问密码，也可以使用非交互式的，将密码保存到文件中，然 </font></p>
<p><font style="color:rgb(0,0,0);">后指明密码文件的位置 </font></p>
<p><font style="color:rgb(0,0,0);">--vault-password-file 用来指明密码文件</font></p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-41-1">1</a></span>
<span class="normal"><a href="#__codelineno-41-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-41-1" name="__codelineno-41-1"></a><span class="o">[</span>devops@workstation<span class="w"> </span>ansible<span class="o">]</span>$<span class="w"> </span><span class="nb">echo</span><span class="w"> </span>redhat<span class="w"> </span>&gt;<span class="w"> </span>pass.txt
<a id="__codelineno-41-2" name="__codelineno-41-2"></a><span class="o">[</span>devops@workstation<span class="w"> </span>ansible<span class="o">]</span>$<span class="w"> </span>ansible-playbook<span class="w"> </span>site.yml<span class="w"> </span>--vault-password-file<span class="o">=</span>pass.txt
</code></pre></div></td></tr></table></div>
<p><strong><font style="color:rgb(0,0,0);">编辑已加密的playbook</font></strong></p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-42-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-42-1" name="__codelineno-42-1"></a><span class="w"> </span><span class="o">[</span>devops@workstation<span class="w"> </span>ansible<span class="o">]</span>$<span class="w"> </span>ansible-vault<span class="w"> </span>edit<span class="w"> </span>site.yml
</code></pre></div></td></tr></table></div>
<p><strong><font style="color:rgb(0,0,0);">查看已加密的文件</font></strong></p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-43-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-43-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-43-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-43-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-43-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-43-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-43-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-43-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-43-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-43-10">10</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-43-1" name="__codelineno-43-1"></a><span class="o">[</span>devops@workstation<span class="w"> </span>ansible<span class="o">]</span>$<span class="w"> </span>ansible-vault<span class="w"> </span>view<span class="w"> </span>site.yml
<a id="__codelineno-43-2" name="__codelineno-43-2"></a><span class="w"> </span>Vault<span class="w"> </span>password:<span class="w"> </span>（输入密码）
<a id="__codelineno-43-3" name="__codelineno-43-3"></a><span class="w"> </span>---
<a id="__codelineno-43-4" name="__codelineno-43-4"></a><span class="w"> </span>-<span class="w"> </span>name:<span class="w"> </span><span class="nb">test</span>
<a id="__codelineno-43-5" name="__codelineno-43-5"></a><span class="w"> </span>hosts:<span class="w"> </span>all
<a id="__codelineno-43-6" name="__codelineno-43-6"></a><span class="w"> </span>tasks:
<a id="__codelineno-43-7" name="__codelineno-43-7"></a><span class="w"> </span>-<span class="w"> </span>name:<span class="w"> </span>test1
<a id="__codelineno-43-8" name="__codelineno-43-8"></a><span class="w"> </span>ansible.builtin.service:
<a id="__codelineno-43-9" name="__codelineno-43-9"></a><span class="w"> </span>name:<span class="w"> </span>firewalld
<a id="__codelineno-43-10" name="__codelineno-43-10"></a><span class="w"> </span>state:<span class="w"> </span>stopped
</code></pre></div></td></tr></table></div>
<p><strong><font style="color:rgb(0,0,0);">修改加密的密码</font></strong></p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-44-1">1</a></span>
<span class="normal"><a href="#__codelineno-44-2">2</a></span>
<span class="normal"><a href="#__codelineno-44-3">3</a></span>
<span class="normal"><a href="#__codelineno-44-4">4</a></span>
<span class="normal"><a href="#__codelineno-44-5">5</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-44-1" name="__codelineno-44-1"></a><span class="o">[</span>devops@workstation<span class="w"> </span>ansible<span class="o">]</span>$<span class="w"> </span>ansible-vault<span class="w"> </span>rekey<span class="w"> </span>site.yml
<a id="__codelineno-44-2" name="__codelineno-44-2"></a>Vault<span class="w"> </span>password:<span class="w"> </span>（输入旧密码）
<a id="__codelineno-44-3" name="__codelineno-44-3"></a><span class="w"> </span>New<span class="w"> </span>Vault<span class="w"> </span>password:<span class="w"> </span>（输入新密码）
<a id="__codelineno-44-4" name="__codelineno-44-4"></a><span class="w"> </span>Confirm<span class="w"> </span>New<span class="w"> </span>Vault<span class="w"> </span>password:<span class="w"> </span>（确认新密码）
<a id="__codelineno-44-5" name="__codelineno-44-5"></a><span class="w"> </span>Rekey<span class="w"> </span>successful
</code></pre></div></td></tr></table></div>
<p><strong><font style="color:rgb(0,0,0);">解密文件</font></strong></p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-45-1">1</a></span>
<span class="normal"><a href="#__codelineno-45-2">2</a></span>
<span class="normal"><a href="#__codelineno-45-3">3</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-45-1" name="__codelineno-45-1"></a><span class="o">[</span>devops@workstation<span class="w"> </span>ansible<span class="o">]</span>$<span class="w"> </span>ansible-vault<span class="w"> </span>decrypt<span class="w"> </span>site.yml
<a id="__codelineno-45-2" name="__codelineno-45-2"></a><span class="w"> </span>Vault<span class="w"> </span>password:<span class="w"> </span>（输入密码）
<a id="__codelineno-45-3" name="__codelineno-45-3"></a><span class="w">  </span>Decryption<span class="w"> </span>successful
</code></pre></div></td></tr></table></div>
<h1 id="变量的定义和引用"><strong><font style="color:rgb(0,0,0);">变量的定义和引用</font></strong><a class="headerlink" href="#变量的定义和引用" title="Permanent link">&para;</a></h1>
<p><font style="color:rgb(0,0,0);">Ansible</font><font style="color:rgb(0,0,0);">支持变量功能，能将</font><font style="color:rgb(0,0,0);">value(</font><font style="color:rgb(0,0,0);">值</font><font style="color:rgb(0,0,0);">)</font><font style="color:rgb(0,0,0);">存储到变量中，这样就能在</font><font style="color:rgb(0,0,0);">Ansible</font><font style="color:rgb(0,0,0);">项目中重复使用 </font></p>
<p><font style="color:rgb(0,0,0);">了。这样就可以简化项目的创建和维护，减少错误率。 </font></p>
<p><font style="color:rgb(0,0,0);">变量提供了一种方便的方法来管理</font><font style="color:rgb(0,0,0);">ansible</font><font style="color:rgb(0,0,0);">项目中给定环境的</font><font style="color:rgb(223,64,42);">动态值</font><font style="color:rgb(0,0,0);">。 变量可以是要创建的用 </font></p>
<p><font style="color:rgb(0,0,0);">户，要安装的包，要启动的服务，要删除的文件，要从互联网下载的文件等等。</font></p>
<p><strong><font style="color:rgb(0,0,0);">变量名称规范 </font></strong></p>
<p><font style="color:rgb(0,0,0);">变量名由必须以字母开头的字符串组成，并且只能包含字母，数字和</font><font style="color:rgb(223,64,42);">下划线 </font></p>
<p><font style="color:rgb(0,0,0);">例如： </font><font style="color:rgb(0,0,0);">file_name </font></p>
<p><font style="color:rgb(0,0,0);">ipaddress_1 </font></p>
<p><font style="color:rgb(0,0,0);">webport </font></p>
<p><font style="color:rgb(0,0,0);">错误的变量名：</font><font style="color:rgb(0,0,0);"> file-name </font></p>
<p><font style="color:rgb(0,0,0);">1_port </font></p>
<p><font style="color:rgb(0,0,0);">web.port </font></p>
<p><strong><font style="color:rgb(0,0,0);">变量的作用域 </font></strong></p>
<p><font style="color:rgb(0,0,0);">根据变量的作用域可以分为四种变量 </font></p>
<p><font style="color:rgb(0,0,0);">1. </font><font style="color:rgb(0,0,0);">全局变量 </font></p>
<p><font style="color:rgb(0,0,0);">2. play </font><font style="color:rgb(0,0,0);">变量 </font></p>
<p><font style="color:rgb(0,0,0);">3. task </font><font style="color:rgb(0,0,0);">变量 </font></p>
<p><font style="color:rgb(0,0,0);">4. host </font><font style="color:rgb(0,0,0);">变量 </font></p>
<p><font style="color:rgb(0,0,0);">全局变量： 作用于全局范围，一般在</font><font style="color:rgb(0,0,0);">ansible</font><font style="color:rgb(0,0,0);">配置和</font><font style="color:rgb(0,0,0);">ansible</font><font style="color:rgb(0,0,0);">命令行中定义，命令行中定义的变量 </font></p>
<p><font style="color:rgb(0,0,0);">优先级最高。 </font></p>
<p><font style="color:rgb(0,0,0);">play </font><font style="color:rgb(0,0,0);">变量： 作用于整个</font><font style="color:rgb(0,0,0);">play </font></p>
<p><font style="color:rgb(0,0,0);">task </font><font style="color:rgb(0,0,0);">变量： 只对当前的</font><font style="color:rgb(0,0,0);">task</font><font style="color:rgb(0,0,0);">生效 </font></p>
<p><font style="color:rgb(0,0,0);">host 变量： 只对某些主机生效</font></p>
<p><strong><font style="color:rgb(0,0,0);">变量定义和引用 </font></strong></p>
<p><font style="color:rgb(0,0,0);">变量的位置：</font><font style="color:rgb(0,0,0);"> inventory</font><font style="color:rgb(0,0,0);">文件中、</font><font style="color:rgb(0,0,0);">playbook</font><font style="color:rgb(0,0,0);">中、单独的变量文件 </font></p>
<p><strong><font style="color:rgb(0,0,0);">在</font></strong><strong><font style="color:rgb(0,0,0);">playbook</font></strong><strong><font style="color:rgb(0,0,0);">中使用</font></strong><strong><font style="color:rgb(0,0,0);">vars</font></strong><strong><font style="color:rgb(0,0,0);">来定义变量 </font></strong></p>
<p><font style="color:rgb(0,0,0);">a: httpd </font></p>
<p><font style="color:rgb(0,0,0);">变量是使用键值对方式来定义，</font><strong><font style="color:rgb(0,0,0);">变量名： 变量的值 </font></strong></p>
<p><font style="color:rgb(0,0,0);">在playbook中定义并使用变量</font></p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-46-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-46-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-46-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-46-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-46-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-46-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-46-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-46-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-46-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-46-10">10</a></span>
<span class="normal"><a href="#__codelineno-46-11">11</a></span>
<span class="normal"><a href="#__codelineno-46-12">12</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-46-1" name="__codelineno-46-1"></a>---
<a id="__codelineno-46-2" name="__codelineno-46-2"></a><span class="w"> </span>-<span class="w"> </span>hosts:<span class="w"> </span>webserver
<a id="__codelineno-46-3" name="__codelineno-46-3"></a><span class="w"> </span>vars:
<a id="__codelineno-46-4" name="__codelineno-46-4"></a><span class="w"> </span>-<span class="w"> </span>web_package:<span class="w"> </span>httpd
<a id="__codelineno-46-5" name="__codelineno-46-5"></a><span class="w"> </span>-<span class="w"> </span>db_package:<span class="w"> </span>mariadb-server<span class="w"> </span>
<a id="__codelineno-46-6" name="__codelineno-46-6"></a><span class="w"> </span>tasks:
<a id="__codelineno-46-7" name="__codelineno-46-7"></a><span class="w"> </span>-<span class="w"> </span>name:<span class="w"> </span>install<span class="w"> </span><span class="s2">&quot;{{ web_package }}&quot;</span><span class="w"> </span>and<span class="w"> </span><span class="s2">&quot;{{ db_package }}&quot;</span>
<a id="__codelineno-46-8" name="__codelineno-46-8"></a><span class="w"> </span>ansible.builtin.yum:
<a id="__codelineno-46-9" name="__codelineno-46-9"></a><span class="w"> </span>name:
<a id="__codelineno-46-10" name="__codelineno-46-10"></a><span class="w"> </span>-<span class="w"> </span><span class="s2">&quot;{{ web_package }}&quot;</span>
<a id="__codelineno-46-11" name="__codelineno-46-11"></a><span class="w"> </span>-<span class="w"> </span><span class="s2">&quot;{{ db_package }}&quot;</span>
<a id="__codelineno-46-12" name="__codelineno-46-12"></a><span class="w"> </span>state:<span class="w"> </span>latest
</code></pre></div></td></tr></table></div>
<p><font style="color:rgb(0,0,0);">执行结果</font></p>
<p><img alt="" src="../../../../images/1718944106700-3695381b-9592-4687-9076-fa3c8c534a2b.png" /></p>
<p><strong><font style="color:rgb(0,0,0);">变量定义和使用细节 </font></strong></p>
<p><font style="color:rgb(0,0,0);">1.</font><font style="color:rgb(0,0,0);">变量必须被定义之后才能使用 </font></p>
<p><font style="color:rgb(0,0,0);">2.vars </font><font style="color:rgb(0,0,0);">和</font><font style="color:rgb(0,0,0);">hosts,tasks</font><font style="color:rgb(0,0,0);">是同一个层级，需要和</font><font style="color:rgb(0,0,0);">hosts,tasks</font><font style="color:rgb(0,0,0);">保持对齐 </font></p>
<p><font style="color:rgb(0,0,0);">3.</font><font style="color:rgb(0,0,0);">使用变量时用</font><font style="color:rgb(0,0,0);">"{{ </font><font style="color:rgb(0,0,0);">变量</font><font style="color:rgb(0,0,0);"> }}" </font><font style="color:rgb(0,0,0);">，</font><font style="color:rgb(0,0,0);">"</font><font style="color:rgb(0,0,0);">变量</font><font style="color:rgb(0,0,0);">" </font><font style="color:rgb(0,0,0);">前后必须要有空格 </font></p>
<p><font style="color:rgb(0,0,0);">4.变量名称要避免重复</font></p>
<p><strong><font style="color:rgb(0,0,0);">变量文件 </font></strong></p>
<p><font style="color:rgb(0,0,0);">当</font><font style="color:rgb(0,0,0);">plays</font><font style="color:rgb(0,0,0);">越来越复杂的时候，这时候再在一个</font><font style="color:rgb(0,0,0);">playbook</font><font style="color:rgb(0,0,0);">中定义非常多的变量就会变得很繁琐，在 </font></p>
<p><font style="color:rgb(0,0,0);">ansible</font><font style="color:rgb(0,0,0);">中可以某个文件定义变量，然后在</font><font style="color:rgb(0,0,0);">playbook</font><font style="color:rgb(0,0,0);">中引用这个变量文件。 </font></p>
<p><font style="color:rgb(0,0,0);">变量文件可以在任何目录中，但必须是以</font><font style="color:rgb(0,0,0);">"yml"</font><font style="color:rgb(0,0,0);">或</font><font style="color:rgb(0,0,0);">"yaml"</font><font style="color:rgb(0,0,0);">为后缀的文件 </font></p>
<p><strong><font style="color:rgb(0,0,0);">变量文件的引用 </font></strong></p>
<p><font style="color:rgb(0,0,0);">在playbook中使用"</font><font style="color:rgb(243,50,50);">vars_files</font><font style="color:rgb(0,0,0);">" 来引入变量文件</font></p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-47-1">1</a></span>
<span class="normal"><a href="#__codelineno-47-2">2</a></span>
<span class="normal"><a href="#__codelineno-47-3">3</a></span>
<span class="normal"><a href="#__codelineno-47-4">4</a></span>
<span class="normal"><a href="#__codelineno-47-5">5</a></span>
<span class="normal"><a href="#__codelineno-47-6">6</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-47-1" name="__codelineno-47-1"></a>---
<a id="__codelineno-47-2" name="__codelineno-47-2"></a><span class="w"> </span>-<span class="w"> </span>name:<span class="w"> </span><span class="nb">test</span><span class="w"> </span>plays
<a id="__codelineno-47-3" name="__codelineno-47-3"></a><span class="w"> </span>hosts:<span class="w"> </span>all
<a id="__codelineno-47-4" name="__codelineno-47-4"></a><span class="w"> </span>vars_files:
<a id="__codelineno-47-5" name="__codelineno-47-5"></a><span class="w"> </span>-<span class="w"> </span>/home/difu/ansible/vars1.yml
<a id="__codelineno-47-6" name="__codelineno-47-6"></a><span class="w"> </span>-<span class="w"> </span>/home/difu/ansible/vars2.yml
</code></pre></div></td></tr></table></div>
<p><font style="color:rgb(0,0,0);">变量文件中的内容</font></p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-48-1">1</a></span>
<span class="normal"><a href="#__codelineno-48-2">2</a></span>
<span class="normal"><a href="#__codelineno-48-3">3</a></span>
<span class="normal"><a href="#__codelineno-48-4">4</a></span>
<span class="normal"><a href="#__codelineno-48-5">5</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-48-1" name="__codelineno-48-1"></a><span class="o">[</span>difu@control<span class="w"> </span>ansible<span class="o">]</span>$<span class="w"> </span>cat<span class="w"> </span>vars1.yml<span class="w"> </span>
<a id="__codelineno-48-2" name="__codelineno-48-2"></a><span class="w"> </span>httpd_srv:<span class="w"> </span>httpd
<a id="__codelineno-48-3" name="__codelineno-48-3"></a><span class="w"> </span>firewalld_srv:<span class="w"> </span>firewalld
<a id="__codelineno-48-4" name="__codelineno-48-4"></a><span class="w"> </span><span class="o">[</span>difu@control<span class="w"> </span>ansible<span class="o">]</span>$<span class="w"> </span>cat<span class="w"> </span>vars2.yml<span class="w"> </span>
<a id="__codelineno-48-5" name="__codelineno-48-5"></a><span class="w"> </span>firewall_role:<span class="w"> </span>http
</code></pre></div></td></tr></table></div>
<p><font style="color:rgb(0,0,0);">完整的playbook</font></p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-49-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-49-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-49-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-49-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-49-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-49-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-49-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-49-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-49-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-49-10">10</a></span>
<span class="normal"><a href="#__codelineno-49-11">11</a></span>
<span class="normal"><a href="#__codelineno-49-12">12</a></span>
<span class="normal"><a href="#__codelineno-49-13">13</a></span>
<span class="normal"><a href="#__codelineno-49-14">14</a></span>
<span class="normal"><a href="#__codelineno-49-15">15</a></span>
<span class="normal"><a href="#__codelineno-49-16">16</a></span>
<span class="normal"><a href="#__codelineno-49-17">17</a></span>
<span class="normal"><a href="#__codelineno-49-18">18</a></span>
<span class="normal"><a href="#__codelineno-49-19">19</a></span>
<span class="normal"><a href="#__codelineno-49-20">20</a></span>
<span class="normal"><a href="#__codelineno-49-21">21</a></span>
<span class="normal"><a href="#__codelineno-49-22">22</a></span>
<span class="normal"><a href="#__codelineno-49-23">23</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-49-1" name="__codelineno-49-1"></a>---
<a id="__codelineno-49-2" name="__codelineno-49-2"></a><span class="w"> </span>-<span class="w"> </span>name:<span class="w"> </span><span class="nb">test</span><span class="w"> </span>plays
<a id="__codelineno-49-3" name="__codelineno-49-3"></a><span class="w"> </span>hosts:<span class="w"> </span>all
<a id="__codelineno-49-4" name="__codelineno-49-4"></a><span class="w"> </span>vars_files:
<a id="__codelineno-49-5" name="__codelineno-49-5"></a><span class="w"> </span>-<span class="w"> </span>/home/difu/ansible/vars1.yml
<a id="__codelineno-49-6" name="__codelineno-49-6"></a><span class="w"> </span>-<span class="w"> </span>/home/difu/ansible/vars2.yml
<a id="__codelineno-49-7" name="__codelineno-49-7"></a><span class="w"> </span>tasks:
<a id="__codelineno-49-8" name="__codelineno-49-8"></a><span class="w"> </span>-<span class="w"> </span>name:<span class="w"> </span>started<span class="w"> </span>and<span class="w"> </span>enabled<span class="w"> </span><span class="s2">&quot;{{ httpd_srv }}&quot;</span>
<a id="__codelineno-49-9" name="__codelineno-49-9"></a><span class="w"> </span>service:
<a id="__codelineno-49-10" name="__codelineno-49-10"></a><span class="w"> </span>name:<span class="w"> </span><span class="s2">&quot;{{ httpd_srv }}&quot;</span>
<a id="__codelineno-49-11" name="__codelineno-49-11"></a><span class="w"> </span>state:<span class="w"> </span>started
<a id="__codelineno-49-12" name="__codelineno-49-12"></a><span class="w"> </span>enabled:<span class="w"> </span>yes
<a id="__codelineno-49-13" name="__codelineno-49-13"></a><span class="w"> </span>-<span class="w"> </span>name:<span class="w"> </span>started<span class="w"> </span>and<span class="w"> </span>enabled<span class="w"> </span><span class="s2">&quot;{{ firewalld_srv }}&quot;</span>
<a id="__codelineno-49-14" name="__codelineno-49-14"></a><span class="w"> </span>service:
<a id="__codelineno-49-15" name="__codelineno-49-15"></a><span class="w"> </span>name:<span class="w"> </span><span class="s2">&quot;{{ firewalld_srv }}&quot;</span>
<a id="__codelineno-49-16" name="__codelineno-49-16"></a><span class="w"> </span>state:<span class="w"> </span>started
<a id="__codelineno-49-17" name="__codelineno-49-17"></a><span class="w"> </span>enabled:<span class="w"> </span>yes
<a id="__codelineno-49-18" name="__codelineno-49-18"></a><span class="w"> </span>-<span class="w"> </span>name:<span class="w"> </span>permit<span class="w"> </span><span class="s2">&quot;{{ firewall_role }}&quot;</span>
<a id="__codelineno-49-19" name="__codelineno-49-19"></a><span class="w"> </span>firewalld:
<a id="__codelineno-49-20" name="__codelineno-49-20"></a><span class="w"> </span>service:<span class="w"> </span><span class="s2">&quot;{{ firewall_role }}&quot;</span>
<a id="__codelineno-49-21" name="__codelineno-49-21"></a><span class="w"> </span>state:<span class="w"> </span>enabled
<a id="__codelineno-49-22" name="__codelineno-49-22"></a><span class="w"> </span>permanent:<span class="w"> </span>yes
<a id="__codelineno-49-23" name="__codelineno-49-23"></a><span class="w"> </span>immediate:<span class="w"> </span>yes
</code></pre></div></td></tr></table></div>
<p><strong><font style="color:rgb(0,0,0);">group</font></strong><strong><font style="color:rgb(0,0,0);">变量和</font></strong><strong><font style="color:rgb(0,0,0);">host</font></strong><strong><font style="color:rgb(0,0,0);">变量 </font></strong></p>
<p><font style="color:rgb(0,0,0);">group</font><font style="color:rgb(0,0,0);">变量和</font><font style="color:rgb(0,0,0);">host</font><font style="color:rgb(0,0,0);">变量只是限定了变量的使用范围，没有其他意义 </font></p>
<p><font style="color:rgb(0,0,0);">host</font><font style="color:rgb(0,0,0);">变量：仅对指定的某个主机生效</font><font style="color:rgb(0,0,0);">(</font><font style="color:rgb(0,0,0);">给某个主机定制的变量</font><font style="color:rgb(0,0,0);">) </font></p>
<p><font style="color:rgb(0,0,0);">group</font><font style="color:rgb(0,0,0);">变量： 仅对某个组生效</font><font style="color:rgb(0,0,0);">(</font><font style="color:rgb(0,0,0);">就是给某个组内的主机创建的变量，只有这个组内的主机才能使用</font><font style="color:rgb(0,0,0);">) </font></p>
<p><strong><font style="color:rgb(0,0,0);">group</font></strong><strong><font style="color:rgb(0,0,0);">变量和</font></strong><strong><font style="color:rgb(0,0,0);">host</font></strong><strong><font style="color:rgb(0,0,0);">变量的位置 </font></strong></p>
<p><font style="color:rgb(0,0,0);">1.在inventory 文件中定义</font></p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-50-1">1</a></span>
<span class="normal"><a href="#__codelineno-50-2">2</a></span>
<span class="normal"><a href="#__codelineno-50-3">3</a></span>
<span class="normal"><a href="#__codelineno-50-4">4</a></span>
<span class="normal"><a href="#__codelineno-50-5">5</a></span>
<span class="normal"><a href="#__codelineno-50-6">6</a></span>
<span class="normal"><a href="#__codelineno-50-7">7</a></span>
<span class="normal"><a href="#__codelineno-50-8">8</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-50-1" name="__codelineno-50-1"></a><span class="o">[</span>webserver<span class="o">]</span>
<a id="__codelineno-50-2" name="__codelineno-50-2"></a><span class="w"> </span>node1<span class="w"> </span><span class="nv">a</span><span class="o">=</span>tom<span class="w"> </span>主机变量
<a id="__codelineno-50-3" name="__codelineno-50-3"></a><span class="w"> </span>node2<span class="w"> </span><span class="nv">a</span><span class="o">=</span>jerry<span class="w"> </span>主机变量
<a id="__codelineno-50-4" name="__codelineno-50-4"></a><span class="w"> </span><span class="o">[</span>dbserver<span class="o">]</span>
<a id="__codelineno-50-5" name="__codelineno-50-5"></a><span class="w"> </span>node3
<a id="__codelineno-50-6" name="__codelineno-50-6"></a><span class="w"> </span>node4
<a id="__codelineno-50-7" name="__codelineno-50-7"></a><span class="w"> </span><span class="o">[</span>dbserver:vars<span class="o">]</span><span class="w"> </span>组变量
<a id="__codelineno-50-8" name="__codelineno-50-8"></a><span class="w"> </span><span class="nv">a</span><span class="o">=</span>devops
</code></pre></div></td></tr></table></div>
<p><font style="color:rgb(0,0,0);">在playbook中使用</font></p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-51-1">1</a></span>
<span class="normal"><a href="#__codelineno-51-2">2</a></span>
<span class="normal"><a href="#__codelineno-51-3">3</a></span>
<span class="normal"><a href="#__codelineno-51-4">4</a></span>
<span class="normal"><a href="#__codelineno-51-5">5</a></span>
<span class="normal"><a href="#__codelineno-51-6">6</a></span>
<span class="normal"><a href="#__codelineno-51-7">7</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-51-1" name="__codelineno-51-1"></a><span class="w"> </span>---
<a id="__codelineno-51-2" name="__codelineno-51-2"></a><span class="w"> </span>-<span class="w"> </span>name:<span class="w"> </span>create<span class="w"> </span>user
<a id="__codelineno-51-3" name="__codelineno-51-3"></a><span class="w"> </span>hosts:<span class="w"> </span>all
<a id="__codelineno-51-4" name="__codelineno-51-4"></a><span class="w"> </span>tasks:
<a id="__codelineno-51-5" name="__codelineno-51-5"></a><span class="w"> </span>-<span class="w"> </span>name:<span class="w"> </span>add<span class="w"> </span>user
<a id="__codelineno-51-6" name="__codelineno-51-6"></a><span class="w"> </span>ansible.builtin.user:
<a id="__codelineno-51-7" name="__codelineno-51-7"></a><span class="w"> </span>name:<span class="w"> </span><span class="s2">&quot;{{ a }}&quot;</span>
</code></pre></div></td></tr></table></div>
<p><strong><font style="color:rgb(0,0,0);">执行结果 </font></strong></p>
<p><font style="color:rgb(0,0,0);">在node1中添加了用户tom,在node2中添加了用户jerry,在node3和node4中添加了用户devops</font></p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-52-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-52-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-52-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-52-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-52-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-52-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-52-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-52-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-52-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-52-10">10</a></span>
<span class="normal"><a href="#__codelineno-52-11">11</a></span>
<span class="normal"><a href="#__codelineno-52-12">12</a></span>
<span class="normal"><a href="#__codelineno-52-13">13</a></span>
<span class="normal"><a href="#__codelineno-52-14">14</a></span>
<span class="normal"><a href="#__codelineno-52-15">15</a></span>
<span class="normal"><a href="#__codelineno-52-16">16</a></span>
<span class="normal"><a href="#__codelineno-52-17">17</a></span>
<span class="normal"><a href="#__codelineno-52-18">18</a></span>
<span class="normal"><a href="#__codelineno-52-19">19</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-52-1" name="__codelineno-52-1"></a>PLAY<span class="w"> </span><span class="o">[</span>create<span class="w"> </span>user<span class="o">]</span><span class="w"> </span>**********************************************************************
<a id="__codelineno-52-2" name="__codelineno-52-2"></a>
<a id="__codelineno-52-3" name="__codelineno-52-3"></a><span class="w"> </span>TASK<span class="w"> </span><span class="o">[</span>Gathering<span class="w"> </span>Facts<span class="o">]</span><span class="w"> </span>******************************************************************
<a id="__codelineno-52-4" name="__codelineno-52-4"></a><span class="w"> </span>ok:<span class="w"> </span><span class="o">[</span>node2<span class="o">]</span>
<a id="__codelineno-52-5" name="__codelineno-52-5"></a>ok:<span class="w"> </span><span class="o">[</span>node1<span class="o">]</span>
<a id="__codelineno-52-6" name="__codelineno-52-6"></a>ok:<span class="w"> </span><span class="o">[</span>node3<span class="o">]</span>
<a id="__codelineno-52-7" name="__codelineno-52-7"></a><span class="w"> </span>ok:<span class="w"> </span><span class="o">[</span>node4<span class="o">]</span>
<a id="__codelineno-52-8" name="__codelineno-52-8"></a>
<a id="__codelineno-52-9" name="__codelineno-52-9"></a><span class="w"> </span>TASK<span class="w"> </span><span class="o">[</span>add<span class="w"> </span>user<span class="o">]</span><span class="w"> </span>*************************************************************************
<a id="__codelineno-52-10" name="__codelineno-52-10"></a><span class="w"> </span>changed:<span class="w"> </span><span class="o">[</span>node4<span class="o">]</span><span class="w"> </span><span class="o">=</span>&gt;<span class="w"> </span><span class="o">{</span><span class="s2">&quot;changed&quot;</span>:<span class="w"> </span>true,<span class="w"> </span><span class="s2">&quot;comment&quot;</span>:<span class="w"> </span><span class="s2">&quot;&quot;</span>,<span class="w"> </span><span class="s2">&quot;create_home&quot;</span>:<span class="w"> </span>true,<span class="w"> </span><span class="s2">&quot;group&quot;</span>:<span class="w"> </span><span class="m">1002</span>,
<a id="__codelineno-52-11" name="__codelineno-52-11"></a><span class="w"> </span>changed:<span class="w"> </span><span class="o">[</span>node3<span class="o">]</span><span class="w"> </span><span class="o">=</span>&gt;<span class="w"> </span><span class="o">{</span><span class="s2">&quot;changed&quot;</span>:<span class="w"> </span>true,<span class="w"> </span><span class="s2">&quot;comment&quot;</span>:<span class="w"> </span><span class="s2">&quot;&quot;</span>,<span class="w"> </span><span class="s2">&quot;create_home&quot;</span>:<span class="w"> </span>true,<span class="w"> </span><span class="s2">&quot;group&quot;</span>:<span class="w"> </span><span class="m">1002</span>,
<a id="__codelineno-52-12" name="__codelineno-52-12"></a><span class="w"> </span>changed:<span class="w"> </span><span class="o">[</span>node2<span class="o">]</span><span class="w"> </span><span class="o">=</span>&gt;<span class="w"> </span><span class="o">{</span><span class="s2">&quot;changed&quot;</span>:<span class="w"> </span>true,<span class="w"> </span><span class="s2">&quot;comment&quot;</span>:<span class="w"> </span><span class="s2">&quot;&quot;</span>,<span class="w"> </span><span class="s2">&quot;create_home&quot;</span>:<span class="w"> </span>true,<span class="w"> </span><span class="s2">&quot;group&quot;</span>:<span class="w"> </span><span class="m">5001</span>,
<a id="__codelineno-52-13" name="__codelineno-52-13"></a><span class="w"> </span>changed:<span class="w"> </span><span class="o">[</span>node1<span class="o">]</span><span class="w"> </span><span class="o">=</span>&gt;<span class="w"> </span><span class="o">{</span><span class="s2">&quot;changed&quot;</span>:<span class="w"> </span>true,<span class="w"> </span><span class="s2">&quot;comment&quot;</span>:<span class="w"> </span><span class="s2">&quot;&quot;</span>,<span class="w"> </span><span class="s2">&quot;create_home&quot;</span>:<span class="w"> </span>true,<span class="w"> </span><span class="s2">&quot;group&quot;</span>:<span class="w"> </span><span class="m">5001</span>,
<a id="__codelineno-52-14" name="__codelineno-52-14"></a>
<a id="__codelineno-52-15" name="__codelineno-52-15"></a><span class="w"> </span>PLAY<span class="w"> </span>RECAP<span class="w"> </span>******************************************************************************
<a id="__codelineno-52-16" name="__codelineno-52-16"></a><span class="w"> </span>node1<span class="w"> </span>:<span class="w"> </span><span class="nv">ok</span><span class="o">=</span><span class="m">2</span><span class="w"> </span><span class="nv">changed</span><span class="o">=</span><span class="m">1</span><span class="w"> </span><span class="nv">unreachable</span><span class="o">=</span><span class="m">0</span><span class="w"> </span><span class="nv">failed</span><span class="o">=</span><span class="m">0</span><span class="w"> </span>
<a id="__codelineno-52-17" name="__codelineno-52-17"></a><span class="w"> </span>node2<span class="w"> </span>:<span class="w"> </span><span class="nv">ok</span><span class="o">=</span><span class="m">2</span><span class="w"> </span><span class="nv">changed</span><span class="o">=</span><span class="m">1</span><span class="w"> </span><span class="nv">unreachable</span><span class="o">=</span><span class="m">0</span><span class="w"> </span><span class="nv">failed</span><span class="o">=</span><span class="m">0</span><span class="w"> </span>
<a id="__codelineno-52-18" name="__codelineno-52-18"></a><span class="w"> </span>node3<span class="w"> </span>:<span class="w"> </span><span class="nv">ok</span><span class="o">=</span><span class="m">2</span><span class="w"> </span><span class="nv">changed</span><span class="o">=</span><span class="m">1</span><span class="w"> </span><span class="nv">unreachable</span><span class="o">=</span><span class="m">0</span><span class="w"> </span><span class="nv">failed</span><span class="o">=</span><span class="m">0</span><span class="w"> </span>
<a id="__codelineno-52-19" name="__codelineno-52-19"></a><span class="w"> </span>node4<span class="w"> </span>:<span class="w"> </span><span class="nv">ok</span><span class="o">=</span><span class="m">2</span><span class="w"> </span><span class="nv">changed</span><span class="o">=</span><span class="m">1</span><span class="w"> </span><span class="nv">unreachable</span><span class="o">=</span><span class="m">0</span><span class="w"> </span><span class="nv">failed</span><span class="o">=</span><span class="m">0</span>
</code></pre></div></td></tr></table></div>
<p><font style="color:rgb(0,0,0);">2.</font><font style="color:rgb(0,0,0);">在指定的目录中定义 </font></p>
<p><font style="color:rgb(0,0,0);">在</font><font style="color:rgb(0,0,0);">inventory</font><font style="color:rgb(0,0,0);">中定义主机变量和组变量使得</font><font style="color:rgb(0,0,0);">inventory</font><font style="color:rgb(0,0,0);">文件管理更加复杂了，因此可以将主机变量和 </font></p>
<p><font style="color:rgb(0,0,0);">组变量在特定的文件中定义。</font></p>
<p><strong><font style="color:rgb(0,0,0);">将变量定义在</font></strong><strong><font style="color:rgb(243,50,50);">host_vars</font></strong><strong><font style="color:rgb(0,0,0);">和</font></strong><strong><font style="color:rgb(243,50,50);">group_vars</font></strong><strong><font style="color:rgb(0,0,0);">目录中 </font></strong></p>
<p><font style="color:rgb(0,0,0);">host_vars</font><font style="color:rgb(0,0,0);">目录用于保存主机变量文件，</font><font style="color:rgb(243,50,50);">文件名以主机名称命名 </font></p>
<p><font style="color:rgb(0,0,0);">group_vars</font><font style="color:rgb(0,0,0);">目录用于保存组变量文件，</font><font style="color:rgb(243,50,50);">文件名以主机组命名 </font></p>
<p><font style="color:rgb(0,0,0);">注意：</font><font style="color:rgb(223,64,42);">1.</font><font style="color:rgb(223,64,42);">目录名称必须是</font><font style="color:rgb(223,64,42);">host_vars</font><font style="color:rgb(223,64,42);">和</font><font style="color:rgb(223,64,42);">group_vars </font></p>
<p><font style="color:rgb(223,64,42);">2.host_vars</font><font style="color:rgb(223,64,42);">和</font><font style="color:rgb(223,64,42);">group_vars</font><font style="color:rgb(223,64,42);">中文件必须是以</font><font style="color:rgb(223,64,42);">inventory</font><font style="color:rgb(223,64,42);">中定义的主机名或组名来命令的 </font></p>
<p><font style="color:rgb(223,64,42);">3. 在playbook中可以直接使用主机变量或主机组变量，不需要引入变量文件</font></p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-53-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-53-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-53-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-53-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-53-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-53-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-53-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-53-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-53-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-53-10">10</a></span>
<span class="normal"><a href="#__codelineno-53-11">11</a></span>
<span class="normal"><a href="#__codelineno-53-12">12</a></span>
<span class="normal"><a href="#__codelineno-53-13">13</a></span>
<span class="normal"><a href="#__codelineno-53-14">14</a></span>
<span class="normal"><a href="#__codelineno-53-15">15</a></span>
<span class="normal"><a href="#__codelineno-53-16">16</a></span>
<span class="normal"><a href="#__codelineno-53-17">17</a></span>
<span class="normal"><a href="#__codelineno-53-18">18</a></span>
<span class="normal"><a href="#__codelineno-53-19">19</a></span>
<span class="normal"><a href="#__codelineno-53-20">20</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-53-1" name="__codelineno-53-1"></a><span class="o">[</span>difu@control<span class="w"> </span>ansible<span class="o">]</span>$<span class="w"> </span>tree<span class="w"> </span>/home/difu/ansible/
<a id="__codelineno-53-2" name="__codelineno-53-2"></a><span class="w"> </span>/home/difu/ansible/
<a id="__codelineno-53-3" name="__codelineno-53-3"></a><span class="w"> </span>├──<span class="w"> </span>ansible.cfg
<a id="__codelineno-53-4" name="__codelineno-53-4"></a><span class="w"> </span>├──<span class="w"> </span>group_vars
<a id="__codelineno-53-5" name="__codelineno-53-5"></a><span class="w"> </span>│<span class="w"> </span>├──<span class="w"> </span>dbserver
<a id="__codelineno-53-6" name="__codelineno-53-6"></a><span class="w"> </span>│<span class="w"> </span>└──<span class="w"> </span>webserver
<a id="__codelineno-53-7" name="__codelineno-53-7"></a><span class="w"> </span>├──<span class="w"> </span>host_vars
<a id="__codelineno-53-8" name="__codelineno-53-8"></a><span class="w"> </span>│<span class="w"> </span>├──<span class="w"> </span>node1
<a id="__codelineno-53-9" name="__codelineno-53-9"></a><span class="w"> </span>│<span class="w"> </span>└──<span class="w"> </span>node2
<a id="__codelineno-53-10" name="__codelineno-53-10"></a><span class="w"> </span>├──<span class="w"> </span>inventory
<a id="__codelineno-53-11" name="__codelineno-53-11"></a><span class="w"> </span>└──<span class="w"> </span>test.yml
<a id="__codelineno-53-12" name="__codelineno-53-12"></a>
<a id="__codelineno-53-13" name="__codelineno-53-13"></a><span class="w"> </span><span class="o">[</span>difu@control<span class="w"> </span>ansible<span class="o">]</span>$<span class="w"> </span>cat<span class="w"> </span>host_vars/node1
<a id="__codelineno-53-14" name="__codelineno-53-14"></a><span class="w"> </span>user:<span class="w"> </span>bob
<a id="__codelineno-53-15" name="__codelineno-53-15"></a><span class="w"> </span><span class="o">[</span>difu@control<span class="w"> </span>ansible<span class="o">]</span>$<span class="w"> </span>cat<span class="w"> </span>host_vars/node2
<a id="__codelineno-53-16" name="__codelineno-53-16"></a><span class="w"> </span>user:<span class="w"> </span>jerry
<a id="__codelineno-53-17" name="__codelineno-53-17"></a><span class="w"> </span><span class="o">[</span>difu@control<span class="w"> </span>ansible<span class="o">]</span>$<span class="w"> </span>cat<span class="w"> </span>group_vars/webserver<span class="w"> </span>
<a id="__codelineno-53-18" name="__codelineno-53-18"></a><span class="w"> </span>package:<span class="w"> </span>httpd
<a id="__codelineno-53-19" name="__codelineno-53-19"></a><span class="w"> </span><span class="o">[</span>difu@control<span class="w"> </span>ansible<span class="o">]</span>$<span class="w"> </span>cat<span class="w"> </span>group_vars/dbserver<span class="w"> </span>
<a id="__codelineno-53-20" name="__codelineno-53-20"></a><span class="w"> </span>user:<span class="w"> </span>mysql
</code></pre></div></td></tr></table></div>
<p><font style="color:rgb(0,0,0);">在playbook中使用主机变量和组变量</font></p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-54-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-54-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-54-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-54-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-54-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-54-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-54-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-54-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-54-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-54-10">10</a></span>
<span class="normal"><a href="#__codelineno-54-11">11</a></span>
<span class="normal"><a href="#__codelineno-54-12">12</a></span>
<span class="normal"><a href="#__codelineno-54-13">13</a></span>
<span class="normal"><a href="#__codelineno-54-14">14</a></span>
<span class="normal"><a href="#__codelineno-54-15">15</a></span>
<span class="normal"><a href="#__codelineno-54-16">16</a></span>
<span class="normal"><a href="#__codelineno-54-17">17</a></span>
<span class="normal"><a href="#__codelineno-54-18">18</a></span>
<span class="normal"><a href="#__codelineno-54-19">19</a></span>
<span class="normal"><a href="#__codelineno-54-20">20</a></span>
<span class="normal"><a href="#__codelineno-54-21">21</a></span>
<span class="normal"><a href="#__codelineno-54-22">22</a></span>
<span class="normal"><a href="#__codelineno-54-23">23</a></span>
<span class="normal"><a href="#__codelineno-54-24">24</a></span>
<span class="normal"><a href="#__codelineno-54-25">25</a></span>
<span class="normal"><a href="#__codelineno-54-26">26</a></span>
<span class="normal"><a href="#__codelineno-54-27">27</a></span>
<span class="normal"><a href="#__codelineno-54-28">28</a></span>
<span class="normal"><a href="#__codelineno-54-29">29</a></span>
<span class="normal"><a href="#__codelineno-54-30">30</a></span>
<span class="normal"><a href="#__codelineno-54-31">31</a></span>
<span class="normal"><a href="#__codelineno-54-32">32</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-54-1" name="__codelineno-54-1"></a><span class="w"> </span><span class="o">[</span>difu@control<span class="w"> </span>ansible<span class="o">]</span>$<span class="w"> </span>vim<span class="w"> </span>site1.yml
<a id="__codelineno-54-2" name="__codelineno-54-2"></a><span class="w"> </span>---
<a id="__codelineno-54-3" name="__codelineno-54-3"></a><span class="w"> </span>-<span class="w"> </span>name:<span class="w"> </span>测试变量
<a id="__codelineno-54-4" name="__codelineno-54-4"></a><span class="w"> </span>hosts:<span class="w"> </span>webserver
<a id="__codelineno-54-5" name="__codelineno-54-5"></a><span class="w"> </span>tasks:
<a id="__codelineno-54-6" name="__codelineno-54-6"></a><span class="w"> </span>-<span class="w"> </span>name:<span class="w"> </span>创建用户
<a id="__codelineno-54-7" name="__codelineno-54-7"></a><span class="w"> </span>ansible.builtin.user:
<a id="__codelineno-54-8" name="__codelineno-54-8"></a><span class="w"> </span>name:<span class="w"> </span><span class="s2">&quot;{{ user }}&quot;</span>
<a id="__codelineno-54-9" name="__codelineno-54-9"></a><span class="w"> </span>-<span class="w"> </span>name:<span class="w"> </span>安装<span class="w"> </span><span class="s2">&quot;{{ package }}&quot;</span>
<a id="__codelineno-54-10" name="__codelineno-54-10"></a><span class="w"> </span>ansible.builtin.yum:
<a id="__codelineno-54-11" name="__codelineno-54-11"></a><span class="w"> </span>name:<span class="w"> </span><span class="s2">&quot;{{ package }}&quot;</span>
<a id="__codelineno-54-12" name="__codelineno-54-12"></a><span class="w"> </span>state:<span class="w"> </span>latest
<a id="__codelineno-54-13" name="__codelineno-54-13"></a>
<a id="__codelineno-54-14" name="__codelineno-54-14"></a><span class="w"> </span><span class="o">[</span>difu@control<span class="w"> </span>ansible<span class="o">]</span>$<span class="w"> </span>ansible-playbook<span class="w"> </span>site1.yml<span class="w"> </span>
<a id="__codelineno-54-15" name="__codelineno-54-15"></a>
<a id="__codelineno-54-16" name="__codelineno-54-16"></a>PLAY<span class="w"> </span><span class="o">[</span>测试变量<span class="o">]</span><span class="w"> </span>************************************************************************
<a id="__codelineno-54-17" name="__codelineno-54-17"></a>
<a id="__codelineno-54-18" name="__codelineno-54-18"></a><span class="w"> </span>TASK<span class="w"> </span><span class="o">[</span>Gathering<span class="w"> </span>Facts<span class="o">]</span><span class="w"> </span>******************************************************************
<a id="__codelineno-54-19" name="__codelineno-54-19"></a><span class="w"> </span>ok:<span class="w"> </span><span class="o">[</span>node2<span class="o">]</span>
<a id="__codelineno-54-20" name="__codelineno-54-20"></a><span class="w"> </span>ok:<span class="w"> </span><span class="o">[</span>node1<span class="o">]</span>
<a id="__codelineno-54-21" name="__codelineno-54-21"></a>
<a id="__codelineno-54-22" name="__codelineno-54-22"></a><span class="w"> </span>TASK<span class="w"> </span><span class="o">[</span>创建用户<span class="o">]</span><span class="w"> </span>*************************************************************************
<a id="__codelineno-54-23" name="__codelineno-54-23"></a><span class="w"> </span>changed:<span class="w"> </span><span class="o">[</span>node1<span class="o">]</span>
<a id="__codelineno-54-24" name="__codelineno-54-24"></a><span class="w"> </span>changed:<span class="w"> </span><span class="o">[</span>node2<span class="o">]</span>
<a id="__codelineno-54-25" name="__codelineno-54-25"></a>
<a id="__codelineno-54-26" name="__codelineno-54-26"></a><span class="w"> </span>TASK<span class="w"> </span><span class="o">[</span>安装<span class="w"> </span><span class="s2">&quot;httpd&quot;</span><span class="o">]</span><span class="w"> </span>*********************************************************************
<a id="__codelineno-54-27" name="__codelineno-54-27"></a><span class="w"> </span>changed:<span class="w"> </span><span class="o">[</span>node1<span class="o">]</span>
<a id="__codelineno-54-28" name="__codelineno-54-28"></a><span class="w"> </span>changed:<span class="w"> </span><span class="o">[</span>node2<span class="o">]</span>
<a id="__codelineno-54-29" name="__codelineno-54-29"></a>
<a id="__codelineno-54-30" name="__codelineno-54-30"></a><span class="w"> </span>PLAY<span class="w"> </span>RECAP<span class="w"> </span>******************************************************************************
<a id="__codelineno-54-31" name="__codelineno-54-31"></a><span class="w"> </span>node1<span class="w"> </span>:<span class="w"> </span><span class="nv">ok</span><span class="o">=</span><span class="m">3</span><span class="w"> </span><span class="nv">changed</span><span class="o">=</span><span class="m">2</span><span class="w"> </span><span class="nv">unreachable</span><span class="o">=</span><span class="m">0</span><span class="w"> </span><span class="nv">failed</span><span class="o">=</span><span class="m">0</span><span class="w"> </span>
<a id="__codelineno-54-32" name="__codelineno-54-32"></a><span class="w"> </span>node2<span class="w"> </span>:<span class="w"> </span><span class="nv">ok</span><span class="o">=</span><span class="m">3</span><span class="w"> </span><span class="nv">changed</span><span class="o">=</span><span class="m">2</span><span class="w"> </span><span class="nv">unreachable</span><span class="o">=</span><span class="m">0</span><span class="w"> </span><span class="nv">failed</span><span class="o">=</span><span class="m">0</span>
</code></pre></div></td></tr></table></div>
<p><strong><font style="color:rgb(0,0,0);">内置变量 </font></strong></p>
<p><font style="color:rgb(0,0,0);">ansible</font><font style="color:rgb(0,0,0);">中有一些内置变量，这些变量无需被定义，可以直接拿来使用 </font></p>
<p><font style="color:rgb(0,0,0);">常见的内置变量： </font></p>
<p><font style="color:rgb(0,0,0);">ansible_version: </font></p>
<p><font style="color:rgb(0,0,0);">hostvars: </font></p>
<p><font style="color:rgb(0,0,0);">inventory_dir: </font></p>
<p><font style="color:rgb(243,50,50);">inventory_hostname</font><font style="color:rgb(0,0,0);">: </font></p>
<p><font style="color:rgb(0,0,0);">groups: </font></p>
<p><font style="color:rgb(0,0,0);">group_name: </font></p>
<p><strong><font style="color:rgb(0,0,0);">注册变量 </font></strong></p>
<p><font style="color:rgb(0,0,0);">ansible </font><font style="color:rgb(0,0,0);">中模块在执行后都会返回很多信息，默认情况下这些信息都不会输出到屏幕，我们可以 </font></p>
<p><font style="color:rgb(0,0,0);">将这些输出信息注册到一个变量中，然后通过变量来获取这些信息。注册的变量可以给其他的</font><font style="color:rgb(0,0,0);">task</font><font style="color:rgb(0,0,0);">使 </font></p>
<p><font style="color:rgb(0,0,0);">用。</font></p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-55-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-55-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-55-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-55-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-55-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-55-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-55-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-55-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-55-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-55-10">10</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-55-1" name="__codelineno-55-1"></a><span class="w"> </span>---
<a id="__codelineno-55-2" name="__codelineno-55-2"></a><span class="w"> </span>-<span class="w"> </span>hosts:<span class="w"> </span>node1
<a id="__codelineno-55-3" name="__codelineno-55-3"></a><span class="w"> </span>tasks:
<a id="__codelineno-55-4" name="__codelineno-55-4"></a><span class="w"> </span>-<span class="w"> </span>name:<span class="w"> </span><span class="nb">test</span><span class="w"> </span>shell
<a id="__codelineno-55-5" name="__codelineno-55-5"></a><span class="w"> </span>ansible.builtin.shell:
<a id="__codelineno-55-6" name="__codelineno-55-6"></a><span class="w"> </span><span class="nb">echo</span><span class="w"> </span><span class="s1">&#39;Hello World&#39;</span>
<a id="__codelineno-55-7" name="__codelineno-55-7"></a><span class="w"> </span>register:<span class="w"> </span>a
<a id="__codelineno-55-8" name="__codelineno-55-8"></a><span class="w"> </span>-<span class="w"> </span>name:<span class="w"> </span>print<span class="w"> </span>echo_result
<a id="__codelineno-55-9" name="__codelineno-55-9"></a><span class="w"> </span>ansible.builtin.debug:
<a id="__codelineno-55-10" name="__codelineno-55-10"></a><span class="w"> </span>var:<span class="w"> </span>a
</code></pre></div></td></tr></table></div>
<p><font style="color:rgb(0,0,0);">这里用到了两个模块，</font><font style="color:rgb(0,0,0);">debug</font><font style="color:rgb(0,0,0);">和</font><font style="color:rgb(0,0,0);">register </font></p>
<p><strong><font style="color:rgb(0,0,0);">debug</font></strong><strong><font style="color:rgb(0,0,0);">模块 </font></strong></p>
<p><font style="color:rgb(0,0,0);">debug</font><font style="color:rgb(0,0,0);">是一个调试模块，用于打印输出信息，常用参数有： </font></p>
<p><font style="color:rgb(0,0,0);">msg: </font><font style="color:rgb(0,0,0);">自定义输出信息 </font></p>
<p><font style="color:rgb(0,0,0);">var: </font><font style="color:rgb(0,0,0);">将任务执行的结果注册为变量传递给</font><font style="color:rgb(0,0,0);">debug, debug</font><font style="color:rgb(0,0,0);">将结果输出出来 </font></p>
<p><strong><font style="color:rgb(0,0,0);">register</font></strong><strong><font style="color:rgb(0,0,0);">模块 </font></strong></p>
<p><font style="color:rgb(0,0,0);">register用于将任务的执行结果注册为变量，通常和debug模块一起使用debug和register模块使用示例</font></p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-56-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-56-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-56-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-56-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-56-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-56-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-56-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-56-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-56-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-56-10">10</a></span>
<span class="normal"><a href="#__codelineno-56-11">11</a></span>
<span class="normal"><a href="#__codelineno-56-12">12</a></span>
<span class="normal"><a href="#__codelineno-56-13">13</a></span>
<span class="normal"><a href="#__codelineno-56-14">14</a></span>
<span class="normal"><a href="#__codelineno-56-15">15</a></span>
<span class="normal"><a href="#__codelineno-56-16">16</a></span>
<span class="normal"><a href="#__codelineno-56-17">17</a></span>
<span class="normal"><a href="#__codelineno-56-18">18</a></span>
<span class="normal"><a href="#__codelineno-56-19">19</a></span>
<span class="normal"><a href="#__codelineno-56-20">20</a></span>
<span class="normal"><a href="#__codelineno-56-21">21</a></span>
<span class="normal"><a href="#__codelineno-56-22">22</a></span>
<span class="normal"><a href="#__codelineno-56-23">23</a></span>
<span class="normal"><a href="#__codelineno-56-24">24</a></span>
<span class="normal"><a href="#__codelineno-56-25">25</a></span>
<span class="normal"><a href="#__codelineno-56-26">26</a></span>
<span class="normal"><a href="#__codelineno-56-27">27</a></span>
<span class="normal"><a href="#__codelineno-56-28">28</a></span>
<span class="normal"><a href="#__codelineno-56-29">29</a></span>
<span class="normal"><a href="#__codelineno-56-30">30</a></span>
<span class="normal"><a href="#__codelineno-56-31">31</a></span>
<span class="normal"><a href="#__codelineno-56-32">32</a></span>
<span class="normal"><a href="#__codelineno-56-33">33</a></span>
<span class="normal"><a href="#__codelineno-56-34">34</a></span>
<span class="normal"><a href="#__codelineno-56-35">35</a></span>
<span class="normal"><a href="#__codelineno-56-36">36</a></span>
<span class="normal"><a href="#__codelineno-56-37">37</a></span>
<span class="normal"><a href="#__codelineno-56-38">38</a></span>
<span class="normal"><a href="#__codelineno-56-39">39</a></span>
<span class="normal"><a href="#__codelineno-56-40">40</a></span>
<span class="normal"><a href="#__codelineno-56-41">41</a></span>
<span class="normal"><a href="#__codelineno-56-42">42</a></span>
<span class="normal"><a href="#__codelineno-56-43">43</a></span>
<span class="normal"><a href="#__codelineno-56-44">44</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-56-1" name="__codelineno-56-1"></a><span class="w"> </span><span class="o">[</span>difu@control<span class="w"> </span>ansible<span class="o">]</span>$<span class="w"> </span>vim<span class="w"> </span>site2.yaml
<a id="__codelineno-56-2" name="__codelineno-56-2"></a><span class="w"> </span>---
<a id="__codelineno-56-3" name="__codelineno-56-3"></a><span class="w"> </span>-<span class="w"> </span>name:<span class="w"> </span>测试debug
<a id="__codelineno-56-4" name="__codelineno-56-4"></a><span class="w"> </span>hosts:<span class="w"> </span>node1
<a id="__codelineno-56-5" name="__codelineno-56-5"></a><span class="w"> </span>tasks:
<a id="__codelineno-56-6" name="__codelineno-56-6"></a><span class="w"> </span>-<span class="w"> </span>name:<span class="w"> </span>使用shell模块输出时间
<a id="__codelineno-56-7" name="__codelineno-56-7"></a><span class="w"> </span>ansible.builtin.shell:
<a id="__codelineno-56-8" name="__codelineno-56-8"></a><span class="w"> </span>date
<a id="__codelineno-56-9" name="__codelineno-56-9"></a><span class="w"> </span>register:<span class="w"> </span>c
<a id="__codelineno-56-10" name="__codelineno-56-10"></a><span class="w"> </span>-<span class="w"> </span>name:<span class="w"> </span>use<span class="w"> </span>debug
<a id="__codelineno-56-11" name="__codelineno-56-11"></a><span class="w"> </span>ansible.builtin.debug:
<a id="__codelineno-56-12" name="__codelineno-56-12"></a><span class="w"> </span>var:<span class="w"> </span>c
<a id="__codelineno-56-13" name="__codelineno-56-13"></a>
<a id="__codelineno-56-14" name="__codelineno-56-14"></a><span class="w"> </span><span class="o">[</span>difu@control<span class="w"> </span>ansible<span class="o">]</span>$<span class="w"> </span>ansible-playbook<span class="w"> </span>site2.yaml<span class="w"> </span>
<a id="__codelineno-56-15" name="__codelineno-56-15"></a>
<a id="__codelineno-56-16" name="__codelineno-56-16"></a><span class="w"> </span>PLAY<span class="w"> </span><span class="o">[</span>测试debug<span class="o">]</span><span class="w"> </span>************************************************************************
<a id="__codelineno-56-17" name="__codelineno-56-17"></a>
<a id="__codelineno-56-18" name="__codelineno-56-18"></a><span class="w"> </span>TASK<span class="w"> </span><span class="o">[</span>Gathering<span class="w"> </span>Facts<span class="o">]</span><span class="w"> </span>******************************************************************
<a id="__codelineno-56-19" name="__codelineno-56-19"></a><span class="w"> </span>ok:<span class="w"> </span><span class="o">[</span>node1<span class="o">]</span>
<a id="__codelineno-56-20" name="__codelineno-56-20"></a>
<a id="__codelineno-56-21" name="__codelineno-56-21"></a><span class="w"> </span>TASK<span class="w"> </span><span class="o">[</span>使用shell模块输出时间<span class="o">]</span><span class="w"> </span>*************************************************************
<a id="__codelineno-56-22" name="__codelineno-56-22"></a><span class="w"> </span>changed:<span class="w"> </span><span class="o">[</span>node1<span class="o">]</span>
<a id="__codelineno-56-23" name="__codelineno-56-23"></a>
<a id="__codelineno-56-24" name="__codelineno-56-24"></a><span class="w"> </span>TASK<span class="w"> </span><span class="o">[</span>debug<span class="o">]</span><span class="w"> </span>****************************************************************************
<a id="__codelineno-56-25" name="__codelineno-56-25"></a><span class="w"> </span>ok:<span class="w"> </span><span class="o">[</span>node1<span class="o">]</span><span class="w"> </span><span class="o">=</span>&gt;<span class="w"> </span><span class="o">{</span>
<a id="__codelineno-56-26" name="__codelineno-56-26"></a><span class="s2">&quot;c&quot;</span>:<span class="w"> </span><span class="o">{</span>
<a id="__codelineno-56-27" name="__codelineno-56-27"></a><span class="w"> </span><span class="s2">&quot;changed&quot;</span>:<span class="w"> </span>true,
<a id="__codelineno-56-28" name="__codelineno-56-28"></a><span class="w"> </span><span class="s2">&quot;cmd&quot;</span>:<span class="w"> </span><span class="s2">&quot;date&quot;</span>,
<a id="__codelineno-56-29" name="__codelineno-56-29"></a><span class="w"> </span><span class="s2">&quot;delta&quot;</span>:<span class="w"> </span><span class="s2">&quot;0:00:00.004983&quot;</span>,
<a id="__codelineno-56-30" name="__codelineno-56-30"></a><span class="w"> </span><span class="s2">&quot;end&quot;</span>:<span class="w"> </span><span class="s2">&quot;2019-05-26 15:10:41.329427&quot;</span>,
<a id="__codelineno-56-31" name="__codelineno-56-31"></a><span class="w"> </span><span class="s2">&quot;failed&quot;</span>:<span class="w"> </span>false,
<a id="__codelineno-56-32" name="__codelineno-56-32"></a><span class="w"> </span><span class="s2">&quot;rc&quot;</span>:<span class="w"> </span><span class="m">0</span>,
<a id="__codelineno-56-33" name="__codelineno-56-33"></a><span class="w"> </span><span class="s2">&quot;start&quot;</span>:<span class="w"> </span><span class="s2">&quot;2019-05-26 15:10:41.324444&quot;</span>,
<a id="__codelineno-56-34" name="__codelineno-56-34"></a><span class="w"> </span><span class="s2">&quot;stderr&quot;</span>:<span class="w"> </span><span class="s2">&quot;&quot;</span>,
<a id="__codelineno-56-35" name="__codelineno-56-35"></a><span class="w"> </span><span class="s2">&quot;stderr_lines&quot;</span>:<span class="w"> </span><span class="o">[]</span>,
<a id="__codelineno-56-36" name="__codelineno-56-36"></a><span class="w"> </span><span class="s2">&quot;stdout&quot;</span>:<span class="w"> </span><span class="s2">&quot;Sun May 26 15:10:41 CST 2019&quot;</span>,
<a id="__codelineno-56-37" name="__codelineno-56-37"></a><span class="w"> </span><span class="s2">&quot;stdout_lines&quot;</span>:<span class="w"> </span><span class="o">[</span>
<a id="__codelineno-56-38" name="__codelineno-56-38"></a><span class="w"> </span><span class="s2">&quot;Sun May 26 15:10:41 CST 2019&quot;</span>
<a id="__codelineno-56-39" name="__codelineno-56-39"></a><span class="w"> </span><span class="o">]</span>
<a id="__codelineno-56-40" name="__codelineno-56-40"></a><span class="w"> </span><span class="o">}</span>
<a id="__codelineno-56-41" name="__codelineno-56-41"></a><span class="w"> </span><span class="o">}</span>
<a id="__codelineno-56-42" name="__codelineno-56-42"></a>
<a id="__codelineno-56-43" name="__codelineno-56-43"></a><span class="w"> </span>PLAY<span class="w"> </span>RECAP<span class="w"> </span>******************************************************************************
<a id="__codelineno-56-44" name="__codelineno-56-44"></a><span class="w"> </span>node1<span class="w"> </span>:<span class="w"> </span><span class="nv">ok</span><span class="o">=</span><span class="m">3</span><span class="w"> </span><span class="nv">changed</span><span class="o">=</span><span class="m">1</span><span class="w"> </span><span class="nv">unreachable</span><span class="o">=</span><span class="m">0</span><span class="w"> </span><span class="nv">failed</span><span class="o">=</span><span class="m">0</span>
</code></pre></div></td></tr></table></div>
<p><font style="color:rgb(0,0,0);">从注册变量输出的信息可以发现，返回的信息是</font><font style="color:rgb(0,0,0);">json </font><font style="color:rgb(0,0,0);">格式的，包含了很多键值对，那么就可以获 </font></p>
<p><font style="color:rgb(0,0,0);">取某个指定的值。</font></p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-57-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-57-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-57-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-57-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-57-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-57-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-57-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-57-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-57-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-57-10">10</a></span>
<span class="normal"><a href="#__codelineno-57-11">11</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-57-1" name="__codelineno-57-1"></a>---
<a id="__codelineno-57-2" name="__codelineno-57-2"></a><span class="w"> </span>-<span class="w"> </span>name:<span class="w"> </span><span class="nb">test</span><span class="w"> </span>debug
<a id="__codelineno-57-3" name="__codelineno-57-3"></a><span class="w"> </span>hosts:<span class="w"> </span>node1
<a id="__codelineno-57-4" name="__codelineno-57-4"></a><span class="w"> </span>tasks:
<a id="__codelineno-57-5" name="__codelineno-57-5"></a><span class="w"> </span>-<span class="w"> </span>name:<span class="w"> </span><span class="nb">test</span><span class="w"> </span>shell
<a id="__codelineno-57-6" name="__codelineno-57-6"></a><span class="w"> </span>ansible.builtin.shell:
<a id="__codelineno-57-7" name="__codelineno-57-7"></a><span class="w"> </span>date
<a id="__codelineno-57-8" name="__codelineno-57-8"></a><span class="w"> </span>register:<span class="w"> </span>c
<a id="__codelineno-57-9" name="__codelineno-57-9"></a><span class="w"> </span>-<span class="w"> </span>name:<span class="w"> </span>print<span class="w"> </span>c.stdout
<a id="__codelineno-57-10" name="__codelineno-57-10"></a><span class="w"> </span>ansible.builtin.debug:
<a id="__codelineno-57-11" name="__codelineno-57-11"></a><span class="w"> </span>var:<span class="w"> </span>c.stdout
</code></pre></div></td></tr></table></div>
<p><font style="color:rgb(0,0,0);">执行结果</font></p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-58-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-58-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-58-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-58-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-58-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-58-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-58-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-58-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-58-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-58-10">10</a></span>
<span class="normal"><a href="#__codelineno-58-11">11</a></span>
<span class="normal"><a href="#__codelineno-58-12">12</a></span>
<span class="normal"><a href="#__codelineno-58-13">13</a></span>
<span class="normal"><a href="#__codelineno-58-14">14</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-58-1" name="__codelineno-58-1"></a>PLAY<span class="w"> </span><span class="o">[</span><span class="nb">test</span><span class="w"> </span>debug<span class="o">]</span><span class="w"> </span>********************************************************************
<a id="__codelineno-58-2" name="__codelineno-58-2"></a>
<a id="__codelineno-58-3" name="__codelineno-58-3"></a><span class="w"> </span>TASK<span class="w"> </span><span class="o">[</span>Gathering<span class="w"> </span>Facts<span class="o">]</span><span class="w"> </span>****************************************************************
<a id="__codelineno-58-4" name="__codelineno-58-4"></a>
<a id="__codelineno-58-5" name="__codelineno-58-5"></a><span class="w"> </span>TASK<span class="w"> </span><span class="o">[</span><span class="nb">test</span><span class="w"> </span>shell<span class="o">]</span><span class="w"> </span>*********************************************************************
<a id="__codelineno-58-6" name="__codelineno-58-6"></a><span class="w"> </span>changed:<span class="w"> </span><span class="o">[</span>node1<span class="o">]</span>
<a id="__codelineno-58-7" name="__codelineno-58-7"></a>
<a id="__codelineno-58-8" name="__codelineno-58-8"></a><span class="w"> </span>TASK<span class="w"> </span><span class="o">[</span>print<span class="w"> </span>c.stdout<span class="o">]</span><span class="w"> </span>*****************************************************************
<a id="__codelineno-58-9" name="__codelineno-58-9"></a><span class="w"> </span>ok:<span class="w"> </span><span class="o">[</span>node1<span class="o">]</span><span class="w"> </span><span class="o">=</span>&gt;<span class="w"> </span><span class="o">{</span>
<a id="__codelineno-58-10" name="__codelineno-58-10"></a><span class="w"> </span><span class="s2">&quot;c.stdout&quot;</span>:<span class="w"> </span><span class="s2">&quot;Sun May 26 15:10:41 CST 2019&quot;</span>
<a id="__codelineno-58-11" name="__codelineno-58-11"></a><span class="w"> </span><span class="o">}</span>
<a id="__codelineno-58-12" name="__codelineno-58-12"></a>
<a id="__codelineno-58-13" name="__codelineno-58-13"></a><span class="w"> </span>PLAY<span class="w"> </span>RECAP<span class="w"> </span>****************************************************************************
<a id="__codelineno-58-14" name="__codelineno-58-14"></a><span class="w"> </span>node1<span class="w"> </span>:<span class="w"> </span><span class="nv">ok</span><span class="o">=</span><span class="m">3</span><span class="w"> </span><span class="nv">changed</span><span class="o">=</span><span class="m">1</span><span class="w"> </span><span class="nv">unreachable</span><span class="o">=</span><span class="m">0</span><span class="w"> </span><span class="nv">failed</span><span class="o">=</span><span class="m">0</span>
</code></pre></div></td></tr></table></div>
<p><font style="color:rgb(0,0,0);">不同的模块，输出的信息也各不一样。将模块输出信息注册为变量，不仅可以输出某些指定的值，还 </font></p>
<p><font style="color:rgb(0,0,0);">可以通过这些值进行判断。 </font></p>
<h1 id="管理facts"><strong><font style="color:rgb(0,0,0);">管理Facts </font></strong><a class="headerlink" href="#管理facts" title="Permanent link">&para;</a></h1>
<p><font style="color:rgb(0,0,0);">ansible facts </font><font style="color:rgb(0,0,0);">是受管主机上通过</font><font style="color:rgb(0,0,0);">ansible</font><font style="color:rgb(0,0,0);">自动发现的一系列变量。</font><font style="color:rgb(0,0,0);">ansible facts</font><font style="color:rgb(0,0,0);">包含了受管 </font></p>
<p><font style="color:rgb(0,0,0);">主机的详细信息</font><font style="color:rgb(0,0,0);">,</font><font style="color:rgb(0,0,0);">如主机名，</font><font style="color:rgb(0,0,0);">ip</font><font style="color:rgb(0,0,0);">地址，系统版本，磁盘分区信息，</font><font style="color:rgb(0,0,0);">CPU</font><font style="color:rgb(0,0,0);">信息等。这些信息可以在 </font></p>
<p><font style="color:rgb(0,0,0);">playbook</font><font style="color:rgb(0,0,0);">中直接使用 </font></p>
<h2 id="setup模块"><strong><font style="color:rgb(0,0,0);">setup模块 </font></strong><a class="headerlink" href="#setup模块" title="Permanent link">&para;</a></h2>
<p><font style="color:rgb(0,0,0);">在执行</font><font style="color:rgb(0,0,0);">playbook</font><font style="color:rgb(0,0,0);">时候，</font><font style="color:rgb(0,0,0);">ansible</font><font style="color:rgb(0,0,0);">会自动执行第一个</font><font style="color:rgb(0,0,0);">task </font><font style="color:rgb(0,0,0);">运行</font><font style="color:rgb(0,0,0);">setup</font><font style="color:rgb(0,0,0);">模块，用于收集</font><font style="color:rgb(0,0,0);">facts</font><font style="color:rgb(0,0,0);">信息。 </font></p>
<p><font style="color:rgb(0,0,0);">setup模块的作用就是收集受管主机的各种信息，也可以通过ad-hoc方式来运行setup模块。</font></p>
<p><font style="color:rgb(0,0,0);">查看node1所有facts</font></p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-59-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-59-1" name="__codelineno-59-1"></a><span class="o">[</span>difu@control<span class="w"> </span>ansible<span class="o">]</span>$<span class="w"> </span>ansible<span class="w"> </span>node1<span class="w"> </span>-m<span class="w"> </span>setup
</code></pre></div></td></tr></table></div>
<p><font style="color:rgb(0,0,0);">在</font><font style="color:rgb(0,0,0);">playbook</font><font style="color:rgb(0,0,0);">中，执行的第一个</font><font style="color:rgb(0,0,0);">task</font><font style="color:rgb(0,0,0);">就是运行</font><font style="color:rgb(0,0,0);">setup</font><font style="color:rgb(0,0,0);">模块，收集</font><font style="color:rgb(0,0,0);">facts</font><font style="color:rgb(0,0,0);">。这个</font><font style="color:rgb(0,0,0);">task</font><font style="color:rgb(0,0,0);">是自动执行，不需 </font></p>
<p><font style="color:rgb(0,0,0);">要在</font><font style="color:rgb(0,0,0);">playbook</font><font style="color:rgb(0,0,0);">中定义。 </font></p>
<p><font style="color:rgb(0,0,0);">可以使用</font><strong><font style="color:rgb(0,0,0);">gather_facts</font></strong><font style="color:rgb(0,0,0);">参数来关闭这个task任务。</font></p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-60-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-60-1" name="__codelineno-60-1"></a><span class="o">[</span>difu@control<span class="w"> </span>ansible<span class="o">]</span>$<span class="w"> </span>ansible-playbook<span class="w"> </span>site1.yml
</code></pre></div></td></tr></table></div>
<h2 id="关闭facts"><strong><font style="color:rgb(0,0,0);">关闭facts</font></strong><a class="headerlink" href="#关闭facts" title="Permanent link">&para;</a></h2>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-61-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-61-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-61-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-61-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-61-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-61-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-61-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-61-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-61-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-61-10">10</a></span>
<span class="normal"><a href="#__codelineno-61-11">11</a></span>
<span class="normal"><a href="#__codelineno-61-12">12</a></span>
<span class="normal"><a href="#__codelineno-61-13">13</a></span>
<span class="normal"><a href="#__codelineno-61-14">14</a></span>
<span class="normal"><a href="#__codelineno-61-15">15</a></span>
<span class="normal"><a href="#__codelineno-61-16">16</a></span>
<span class="normal"><a href="#__codelineno-61-17">17</a></span>
<span class="normal"><a href="#__codelineno-61-18">18</a></span>
<span class="normal"><a href="#__codelineno-61-19">19</a></span>
<span class="normal"><a href="#__codelineno-61-20">20</a></span>
<span class="normal"><a href="#__codelineno-61-21">21</a></span>
<span class="normal"><a href="#__codelineno-61-22">22</a></span>
<span class="normal"><a href="#__codelineno-61-23">23</a></span>
<span class="normal"><a href="#__codelineno-61-24">24</a></span>
<span class="normal"><a href="#__codelineno-61-25">25</a></span>
<span class="normal"><a href="#__codelineno-61-26">26</a></span>
<span class="normal"><a href="#__codelineno-61-27">27</a></span>
<span class="normal"><a href="#__codelineno-61-28">28</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-61-1" name="__codelineno-61-1"></a>---
<a id="__codelineno-61-2" name="__codelineno-61-2"></a><span class="w"> </span>-<span class="w"> </span>name:<span class="w"> </span>测试变量
<a id="__codelineno-61-3" name="__codelineno-61-3"></a><span class="w"> </span>hosts:<span class="w"> </span>webserver
<a id="__codelineno-61-4" name="__codelineno-61-4"></a><span class="w"> </span>gather_facts:<span class="w"> </span>no
<a id="__codelineno-61-5" name="__codelineno-61-5"></a><span class="w"> </span>tasks:
<a id="__codelineno-61-6" name="__codelineno-61-6"></a><span class="w"> </span>-<span class="w"> </span>name:<span class="w"> </span>创建用户
<a id="__codelineno-61-7" name="__codelineno-61-7"></a><span class="w"> </span>ansible.builtin.user:
<a id="__codelineno-61-8" name="__codelineno-61-8"></a><span class="w"> </span>name:<span class="w"> </span><span class="s2">&quot;{{ user }}&quot;</span>
<a id="__codelineno-61-9" name="__codelineno-61-9"></a><span class="w"> </span>-<span class="w"> </span>name:<span class="w"> </span>安装<span class="w"> </span><span class="s2">&quot;{{ package }}&quot;</span>
<a id="__codelineno-61-10" name="__codelineno-61-10"></a><span class="w"> </span>ansible.builtin.yum:
<a id="__codelineno-61-11" name="__codelineno-61-11"></a><span class="w"> </span>name:<span class="w"> </span><span class="s2">&quot;{{ package }}&quot;</span>
<a id="__codelineno-61-12" name="__codelineno-61-12"></a><span class="w"> </span>state:<span class="w"> </span>latest
<a id="__codelineno-61-13" name="__codelineno-61-13"></a>
<a id="__codelineno-61-14" name="__codelineno-61-14"></a><span class="w"> </span><span class="o">[</span>difu@control<span class="w"> </span>ansible<span class="o">]</span>$<span class="w"> </span>ansible-playbook<span class="w"> </span>site1.yml<span class="w"> </span>
<a id="__codelineno-61-15" name="__codelineno-61-15"></a>
<a id="__codelineno-61-16" name="__codelineno-61-16"></a><span class="w"> </span>PLAY<span class="w"> </span><span class="o">[</span>测试变量<span class="o">]</span><span class="w"> </span>*******************************************************************
<a id="__codelineno-61-17" name="__codelineno-61-17"></a>
<a id="__codelineno-61-18" name="__codelineno-61-18"></a><span class="w"> </span>TASK<span class="w"> </span><span class="o">[</span>创建用户<span class="o">]</span><span class="w"> </span>*******************************************************************
<a id="__codelineno-61-19" name="__codelineno-61-19"></a><span class="w"> </span>ok:<span class="w"> </span><span class="o">[</span>node1<span class="o">]</span>
<a id="__codelineno-61-20" name="__codelineno-61-20"></a><span class="w"> </span>ok:<span class="w"> </span><span class="o">[</span>node2<span class="o">]</span>
<a id="__codelineno-61-21" name="__codelineno-61-21"></a>
<a id="__codelineno-61-22" name="__codelineno-61-22"></a><span class="w"> </span>TASK<span class="w"> </span><span class="o">[</span>安装<span class="w"> </span><span class="s2">&quot;httpd&quot;</span><span class="o">]</span><span class="w"> </span>***************************************************************
<a id="__codelineno-61-23" name="__codelineno-61-23"></a><span class="w"> </span>ok:<span class="w"> </span><span class="o">[</span>node2<span class="o">]</span>
<a id="__codelineno-61-24" name="__codelineno-61-24"></a><span class="w"> </span>ok:<span class="w"> </span><span class="o">[</span>node1<span class="o">]</span>
<a id="__codelineno-61-25" name="__codelineno-61-25"></a>
<a id="__codelineno-61-26" name="__codelineno-61-26"></a><span class="w"> </span>PLAY<span class="w"> </span>RECAP<span class="w"> </span>************************************************************************
<a id="__codelineno-61-27" name="__codelineno-61-27"></a><span class="w"> </span>node1<span class="w"> </span>:<span class="w"> </span><span class="nv">ok</span><span class="o">=</span><span class="m">2</span><span class="w"> </span><span class="nv">changed</span><span class="o">=</span><span class="m">0</span><span class="w"> </span><span class="nv">unreachable</span><span class="o">=</span><span class="m">0</span><span class="w"> </span><span class="nv">failed</span><span class="o">=</span><span class="m">0</span><span class="w"> </span>
<a id="__codelineno-61-28" name="__codelineno-61-28"></a><span class="w"> </span>node2<span class="w"> </span>:<span class="w"> </span><span class="nv">ok</span><span class="o">=</span><span class="m">2</span><span class="w"> </span><span class="nv">changed</span><span class="o">=</span><span class="m">0</span><span class="w"> </span><span class="nv">unreachable</span><span class="o">=</span><span class="m">0</span><span class="w"> </span><span class="nv">failed</span><span class="o">=</span><span class="m">0</span>
</code></pre></div></td></tr></table></div>
<p><strong><font style="color:rgb(0,0,0);">也可以在ansible.cfg中添加如下配置</font></strong></p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-62-1">1</a></span>
<span class="normal"><a href="#__codelineno-62-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-62-1" name="__codelineno-62-1"></a><span class="o">[</span>defaults<span class="o">]</span>
<a id="__codelineno-62-2" name="__codelineno-62-2"></a><span class="nv">gathering</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>explicit
</code></pre></div></td></tr></table></div>
<p><font style="color:rgb(0,0,0);">explicit表示默认不收集</font></p>
<p><strong><font style="color:rgb(0,0,0);">使用debug模块输出指定的facts信息</font></strong></p>
<p><font style="color:rgb(0,0,0);">facts信息是由多级信息构成，可以通过使用"[]" 或"."来获取子属性</font></p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-63-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-63-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-63-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-63-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-63-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-63-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-63-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-63-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-63-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-63-10">10</a></span>
<span class="normal"><a href="#__codelineno-63-11">11</a></span>
<span class="normal"><a href="#__codelineno-63-12">12</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-63-1" name="__codelineno-63-1"></a>---
<a id="__codelineno-63-2" name="__codelineno-63-2"></a><span class="w"> </span>-<span class="w"> </span>name:<span class="w"> </span>使用debug输出指定的facts信息
<a id="__codelineno-63-3" name="__codelineno-63-3"></a><span class="w"> </span>hosts:<span class="w"> </span>webserver
<a id="__codelineno-63-4" name="__codelineno-63-4"></a><span class="w"> </span>tasks:
<a id="__codelineno-63-5" name="__codelineno-63-5"></a><span class="w"> </span>-<span class="w"> </span>ansible.builtin.debug:
<a id="__codelineno-63-6" name="__codelineno-63-6"></a><span class="w"> </span>msg:<span class="w"> </span>ip地址：<span class="w"> </span><span class="o">{{</span><span class="w"> </span>ansible_default_ipv4.address<span class="w"> </span><span class="o">}}</span>
<a id="__codelineno-63-7" name="__codelineno-63-7"></a><span class="w"> </span>-<span class="w"> </span>ansible.builtin.debug:
<a id="__codelineno-63-8" name="__codelineno-63-8"></a><span class="w"> </span>msg:<span class="w"> </span>主机名：<span class="w"> </span><span class="o">{{</span><span class="w"> </span>ansible_fqdn<span class="w"> </span><span class="o">}}</span>
<a id="__codelineno-63-9" name="__codelineno-63-9"></a><span class="w"> </span>-<span class="w"> </span>ansible.builtin.debug:
<a id="__codelineno-63-10" name="__codelineno-63-10"></a><span class="w"> </span>msg:<span class="w"> </span>内核：<span class="w"> </span><span class="o">{{</span><span class="w"> </span>ansible_kernel<span class="w"> </span><span class="o">}}</span>
<a id="__codelineno-63-11" name="__codelineno-63-11"></a>
<a id="__codelineno-63-12" name="__codelineno-63-12"></a><span class="w"> </span><span class="o">[</span>difu@control<span class="w"> </span>ansible<span class="o">]</span>$<span class="w"> </span>ansible-playbook<span class="w"> </span>site3.yml
</code></pre></div></td></tr></table></div>
<p><strong><font style="color:rgb(0,0,0);">常用的facts变量 （可以通过setup模块查询）</font></strong></p>
<p><img alt="" src="../../../../images/1718945128512-e53aec29-0851-4d4d-bd6c-2e3694a26c0d.png" /></p>
<p><strong><font style="color:rgb(0,0,0);">自定义facts变量 </font></strong></p>
<p><font style="color:rgb(57,57,57);">除了默认的</font><font style="color:rgb(57,57,57);">facts</font><font style="color:rgb(57,57,57);">信息可以被</font><font style="color:rgb(57,57,57);">setup</font><font style="color:rgb(57,57,57);">模块收集，我们也可以自定义</font><font style="color:rgb(57,57,57);">facts</font><font style="color:rgb(57,57,57);">信息 </font></p>
<p><font style="color:rgb(57,57,57);">ansible </font><font style="color:rgb(57,57,57);">默认会到</font><font style="color:rgb(57,57,57);"> /etc/ansible/facts.d</font><font style="color:rgb(57,57,57);">目录下搜索以</font><font style="color:rgb(57,57,57);"> .fact</font><font style="color:rgb(57,57,57);">结尾的文件，并将文件中的数 </font></p>
<p><font style="color:rgb(57,57,57);">据收集到</font><font style="color:rgb(57,57,57);">facts</font><font style="color:rgb(57,57,57);">中。 </font></p>
<p><font style="color:rgb(57,57,57);">自定义一个facts</font></p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-64-1">1</a></span>
<span class="normal"><a href="#__codelineno-64-2">2</a></span>
<span class="normal"><a href="#__codelineno-64-3">3</a></span>
<span class="normal"><a href="#__codelineno-64-4">4</a></span>
<span class="normal"><a href="#__codelineno-64-5">5</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-64-1" name="__codelineno-64-1"></a><span class="w"> </span>root@control<span class="w"> </span>~<span class="o">]</span><span class="c1"># mkdir -p /etc/ansible/facts.d</span>
<a id="__codelineno-64-2" name="__codelineno-64-2"></a><span class="w"> </span><span class="o">[</span>root@control<span class="w"> </span>~<span class="o">]</span><span class="c1"># vim /etc/ansible/facts.d/my.fact</span>
<a id="__codelineno-64-3" name="__codelineno-64-3"></a><span class="w"> </span><span class="o">[</span>info<span class="o">]</span>
<a id="__codelineno-64-4" name="__codelineno-64-4"></a><span class="w"> </span><span class="nv">name</span><span class="o">=</span>redhat
<a id="__codelineno-64-5" name="__codelineno-64-5"></a><span class="w"> </span><span class="nv">age</span><span class="o">=</span><span class="m">28</span>
</code></pre></div></td></tr></table></div>
<p><font style="color:rgb(0,0,0);">为受管主机添加自定义facts信息 </font></p>
<p><font style="color:rgb(57,57,57);">custom.fact文件内容如下：</font></p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-65-1">1</a></span>
<span class="normal"><a href="#__codelineno-65-2">2</a></span>
<span class="normal"><a href="#__codelineno-65-3">3</a></span>
<span class="normal"><a href="#__codelineno-65-4">4</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-65-1" name="__codelineno-65-1"></a><span class="o">[</span>info<span class="o">]</span>
<a id="__codelineno-65-2" name="__codelineno-65-2"></a><span class="w"> </span><span class="nv">package</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>httpd
<a id="__codelineno-65-3" name="__codelineno-65-3"></a><span class="w"> </span><span class="nv">service</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>httpd
<a id="__codelineno-65-4" name="__codelineno-65-4"></a><span class="w"> </span><span class="nv">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>started
</code></pre></div></td></tr></table></div>
<p><font style="color:rgb(57,57,57);">然后我们编写一个playbook文件名为setup_facts.yml内容如下</font></p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-66-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-66-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-66-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-66-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-66-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-66-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-66-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-66-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-66-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-66-10">10</a></span>
<span class="normal"><a href="#__codelineno-66-11">11</a></span>
<span class="normal"><a href="#__codelineno-66-12">12</a></span>
<span class="normal"><a href="#__codelineno-66-13">13</a></span>
<span class="normal"><a href="#__codelineno-66-14">14</a></span>
<span class="normal"><a href="#__codelineno-66-15">15</a></span>
<span class="normal"><a href="#__codelineno-66-16">16</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-66-1" name="__codelineno-66-1"></a><span class="w"> </span>---
<a id="__codelineno-66-2" name="__codelineno-66-2"></a><span class="w"> </span>-<span class="w"> </span>name:<span class="w"> </span>Install<span class="w"> </span>remote<span class="w"> </span>facts
<a id="__codelineno-66-3" name="__codelineno-66-3"></a><span class="w"> </span>hosts:<span class="w"> </span>node1
<a id="__codelineno-66-4" name="__codelineno-66-4"></a><span class="w"> </span>vars:
<a id="__codelineno-66-5" name="__codelineno-66-5"></a><span class="w"> </span>-<span class="w"> </span>remote_dir:<span class="w"> </span>/etc/ansible/facts.d
<a id="__codelineno-66-6" name="__codelineno-66-6"></a><span class="w"> </span>-<span class="w"> </span>facts_file:<span class="w"> </span>/home/devops/ansible/facts.d/custom.fact
<a id="__codelineno-66-7" name="__codelineno-66-7"></a><span class="w"> </span>tasks:
<a id="__codelineno-66-8" name="__codelineno-66-8"></a><span class="w"> </span>-<span class="w"> </span>name:<span class="w"> </span>Create<span class="w"> </span>the<span class="w"> </span>remote<span class="w"> </span>directory
<a id="__codelineno-66-9" name="__codelineno-66-9"></a><span class="w"> </span>ansible.builtin.file:
<a id="__codelineno-66-10" name="__codelineno-66-10"></a><span class="w"> </span>state:<span class="w"> </span>directory
<a id="__codelineno-66-11" name="__codelineno-66-11"></a><span class="w"> </span>recurse:<span class="w"> </span>yes<span class="w"> </span>递归目录上的文件属性
<a id="__codelineno-66-12" name="__codelineno-66-12"></a><span class="w"> </span>path:<span class="w"> </span><span class="s2">&quot;{{ remote_dir }}&quot;</span>
<a id="__codelineno-66-13" name="__codelineno-66-13"></a><span class="w"> </span>-<span class="w"> </span>name:<span class="w"> </span>Install<span class="w"> </span>the<span class="w"> </span>new<span class="w"> </span>facts
<a id="__codelineno-66-14" name="__codelineno-66-14"></a><span class="w"> </span>ansible.builtin.copy:
<a id="__codelineno-66-15" name="__codelineno-66-15"></a><span class="w"> </span>src:<span class="w"> </span><span class="s2">&quot;{{ facts_file }}&quot;</span>
<a id="__codelineno-66-16" name="__codelineno-66-16"></a><span class="w"> </span>dest:<span class="w"> </span><span class="s2">&quot;{{ remote_dir }}&quot;</span>
</code></pre></div></td></tr></table></div>
<p><font style="color:rgb(57,57,57);">执行该</font><font style="color:rgb(57,57,57);">playbook</font><font style="color:rgb(57,57,57);">，完成</font><font style="color:rgb(57,57,57);">facts</font><font style="color:rgb(57,57,57);">的推送： </font><font style="color:rgb(57,57,57);">ansible-playbook setup_facts.yml </font></p>
<p><font style="color:rgb(57,57,57);">此时，我们可以在被控端看到新的</font><font style="color:rgb(57,57,57);">facts</font><font style="color:rgb(57,57,57);">已经生成： </font></p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-67-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-67-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-67-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-67-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-67-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-67-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-67-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-67-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-67-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-67-10">10</a></span>
<span class="normal"><a href="#__codelineno-67-11">11</a></span>
<span class="normal"><a href="#__codelineno-67-12">12</a></span>
<span class="normal"><a href="#__codelineno-67-13">13</a></span>
<span class="normal"><a href="#__codelineno-67-14">14</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-67-1" name="__codelineno-67-1"></a><span class="c1"># ansible test -m setup </span>
<a id="__codelineno-67-2" name="__codelineno-67-2"></a><span class="m">192</span>.168.0.187<span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="nv">SUCCESS</span><span class="w"> </span><span class="o">=</span>&gt;<span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="s2">&quot;ansible_facts&quot;</span>:<span class="w"> </span><span class="o">{</span><span class="w"> </span>
<a id="__codelineno-67-3" name="__codelineno-67-3"></a>...output<span class="w"> </span>omitted...<span class="w"> </span>
<a id="__codelineno-67-4" name="__codelineno-67-4"></a><span class="s2">&quot;ansible_local&quot;</span>:<span class="w"> </span><span class="o">{</span><span class="w"> </span>
<a id="__codelineno-67-5" name="__codelineno-67-5"></a><span class="s2">&quot;custom&quot;</span>:<span class="w"> </span><span class="o">{</span>
<a id="__codelineno-67-6" name="__codelineno-67-6"></a><span class="s2">&quot;info&quot;</span>:<span class="w"> </span><span class="o">{</span><span class="w"> </span>
<a id="__codelineno-67-7" name="__codelineno-67-7"></a><span class="s2">&quot;package&quot;</span>:<span class="w"> </span><span class="s2">&quot;httpd&quot;</span>,<span class="w"> </span>
<a id="__codelineno-67-8" name="__codelineno-67-8"></a><span class="s2">&quot;service&quot;</span>:<span class="w"> </span><span class="s2">&quot;httpd&quot;</span>,<span class="w"> </span>
<a id="__codelineno-67-9" name="__codelineno-67-9"></a><span class="s2">&quot;state&quot;</span>:<span class="w"> </span><span class="s2">&quot;started&quot;</span><span class="w"> </span>
<a id="__codelineno-67-10" name="__codelineno-67-10"></a><span class="o">}</span><span class="w"> </span>
<a id="__codelineno-67-11" name="__codelineno-67-11"></a><span class="o">}</span><span class="w"> </span>
<a id="__codelineno-67-12" name="__codelineno-67-12"></a><span class="o">}</span>,<span class="w"> </span>
<a id="__codelineno-67-13" name="__codelineno-67-13"></a>...output<span class="w"> </span>omitted...<span class="w"> </span>
<a id="__codelineno-67-14" name="__codelineno-67-14"></a><span class="o">}</span>
</code></pre></div></td></tr></table></div>
<h1 id="task-任务控制"><strong><font style="color:rgb(0,0,0);">task 任务控制</font></strong><a class="headerlink" href="#task-任务控制" title="Permanent link">&para;</a></h1>
<h2 id="ansible循环"><strong><font style="color:rgb(0,0,0);">Ansible循环 </font></strong><a class="headerlink" href="#ansible循环" title="Permanent link">&para;</a></h2>
<p><font style="color:rgb(0,0,0);">在</font><font style="color:rgb(0,0,0);">playbook</font><font style="color:rgb(0,0,0);">中可以使用循环语句来完成重复性的动作。 </font></p>
<p><font style="color:rgb(0,0,0);">使用</font><font style="color:rgb(243,50,50);">loop </font><font style="color:rgb(0,0,0);">关键词来定义循环项目，使用 </font><font style="color:rgb(243,50,50);">item</font><font style="color:rgb(0,0,0);">来调用循环。</font></p>
<p><font style="color:rgb(0,0,0);">例如要启动多个服务的时候，不使用循环的话，就得写多次task,这样就会有很多重复的操作。</font></p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-68-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-68-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-68-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-68-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-68-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-68-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-68-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-68-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-68-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-68-10">10</a></span>
<span class="normal"><a href="#__codelineno-68-11">11</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-68-1" name="__codelineno-68-1"></a>---
<a id="__codelineno-68-2" name="__codelineno-68-2"></a>-<span class="w"> </span>hosts:<span class="w"> </span>all
<a id="__codelineno-68-3" name="__codelineno-68-3"></a><span class="w"> </span>tasks:
<a id="__codelineno-68-4" name="__codelineno-68-4"></a><span class="w"> </span>-<span class="w"> </span>name:<span class="w"> </span>ssh<span class="w"> </span>is<span class="w"> </span>running
<a id="__codelineno-68-5" name="__codelineno-68-5"></a><span class="w"> </span>ansible.builtin.service:
<a id="__codelineno-68-6" name="__codelineno-68-6"></a><span class="w"> </span>name:<span class="w"> </span>sshd
<a id="__codelineno-68-7" name="__codelineno-68-7"></a><span class="w"> </span>state:<span class="w"> </span>started
<a id="__codelineno-68-8" name="__codelineno-68-8"></a><span class="w"> </span>-<span class="w"> </span>name:<span class="w"> </span>httpd<span class="w"> </span>is<span class="w"> </span>running
<a id="__codelineno-68-9" name="__codelineno-68-9"></a><span class="w"> </span>ansible.builtin.service:
<a id="__codelineno-68-10" name="__codelineno-68-10"></a><span class="w"> </span>name:<span class="w"> </span>httpd
<a id="__codelineno-68-11" name="__codelineno-68-11"></a><span class="w"> </span>state:<span class="w"> </span>started
</code></pre></div></td></tr></table></div>
<p><font style="color:rgb(0,0,0);">使用loop来循环</font></p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-69-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-69-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-69-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-69-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-69-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-69-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-69-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-69-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-69-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-69-10">10</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-69-1" name="__codelineno-69-1"></a>---
<a id="__codelineno-69-2" name="__codelineno-69-2"></a>-<span class="w"> </span>hosts:<span class="w"> </span>all
<a id="__codelineno-69-3" name="__codelineno-69-3"></a><span class="w"> </span>tasks:
<a id="__codelineno-69-4" name="__codelineno-69-4"></a><span class="w"> </span>-<span class="w"> </span>name:<span class="w"> </span>ssh<span class="w"> </span>and<span class="w"> </span>httpd<span class="w"> </span>is<span class="w"> </span>running
<a id="__codelineno-69-5" name="__codelineno-69-5"></a><span class="w"> </span>ansible.builtin.service:
<a id="__codelineno-69-6" name="__codelineno-69-6"></a><span class="w"> </span>name:<span class="w"> </span><span class="s2">&quot;{{ item }}&quot;</span>
<a id="__codelineno-69-7" name="__codelineno-69-7"></a><span class="w"> </span>state:<span class="w"> </span>started
<a id="__codelineno-69-8" name="__codelineno-69-8"></a><span class="w"> </span>loop:
<a id="__codelineno-69-9" name="__codelineno-69-9"></a><span class="w"> </span>-<span class="w"> </span>sshd
<a id="__codelineno-69-10" name="__codelineno-69-10"></a><span class="w"> </span>-<span class="w"> </span>httpd
</code></pre></div></td></tr></table></div>
<p><font style="color:rgb(57,57,57);">使用</font><font style="color:rgb(57,57,57);">loop</font><font style="color:rgb(57,57,57);">关键词来定义循环 </font></p>
<p><font style="color:rgb(57,57,57);">每个循环项目以</font><font style="color:rgb(57,57,57);">“- ” </font><font style="color:rgb(57,57,57);">开始 </font></p>
<p><font style="color:rgb(57,57,57);">使用 item 关键词来调用循环</font></p>
<p><strong><font style="color:rgb(0,0,0);">循环一个列表</font></strong></p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-70-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-70-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-70-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-70-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-70-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-70-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-70-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-70-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-70-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-70-10">10</a></span>
<span class="normal"><a href="#__codelineno-70-11">11</a></span>
<span class="normal"><a href="#__codelineno-70-12">12</a></span>
<span class="normal"><a href="#__codelineno-70-13">13</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-70-1" name="__codelineno-70-1"></a>---
<a id="__codelineno-70-2" name="__codelineno-70-2"></a>-<span class="w"> </span>hosts:<span class="w"> </span>all
<a id="__codelineno-70-3" name="__codelineno-70-3"></a><span class="w"> </span>tasks:
<a id="__codelineno-70-4" name="__codelineno-70-4"></a><span class="w"> </span>-<span class="w"> </span>name:<span class="w"> </span>create<span class="w"> </span>users
<a id="__codelineno-70-5" name="__codelineno-70-5"></a><span class="w"> </span>ansible.builtin.user:
<a id="__codelineno-70-6" name="__codelineno-70-6"></a><span class="w"> </span>name:<span class="w"> </span><span class="s2">&quot;{{ item.username }}&quot;</span>
<a id="__codelineno-70-7" name="__codelineno-70-7"></a><span class="w"> </span>groups:<span class="w"> </span><span class="s2">&quot;{{ item.groupname }}&quot;</span>
<a id="__codelineno-70-8" name="__codelineno-70-8"></a><span class="w"> </span>state:<span class="w"> </span>present
<a id="__codelineno-70-9" name="__codelineno-70-9"></a><span class="w"> </span>loop:
<a id="__codelineno-70-10" name="__codelineno-70-10"></a><span class="w"> </span>-<span class="w"> </span>username:<span class="w"> </span>tom
<a id="__codelineno-70-11" name="__codelineno-70-11"></a><span class="w"> </span>groupname:<span class="w"> </span>root
<a id="__codelineno-70-12" name="__codelineno-70-12"></a><span class="w"> </span>-<span class="w"> </span>username:<span class="w"> </span>jerry
<a id="__codelineno-70-13" name="__codelineno-70-13"></a><span class="w"> </span>groupname:<span class="w"> </span>wheel
</code></pre></div></td></tr></table></div>
<p><strong><font style="color:rgb(0,0,0);">循环一个变量 </font></strong></p>
<p><font style="color:rgb(57,57,57);">先定义一个组的变量，变量名称为userlist</font></p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-71-1">1</a></span>
<span class="normal"><a href="#__codelineno-71-2">2</a></span>
<span class="normal"><a href="#__codelineno-71-3">3</a></span>
<span class="normal"><a href="#__codelineno-71-4">4</a></span>
<span class="normal"><a href="#__codelineno-71-5">5</a></span>
<span class="normal"><a href="#__codelineno-71-6">6</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-71-1" name="__codelineno-71-1"></a><span class="o">[</span>root@workstation<span class="w"> </span>ansible<span class="o">]</span><span class="c1"># vim group_vars/all.yml</span>
<a id="__codelineno-71-2" name="__codelineno-71-2"></a>userlist:
<a id="__codelineno-71-3" name="__codelineno-71-3"></a><span class="w"> </span>-<span class="w"> </span>username:<span class="w"> </span>myth
<a id="__codelineno-71-4" name="__codelineno-71-4"></a><span class="w"> </span>group:<span class="w"> </span>developer
<a id="__codelineno-71-5" name="__codelineno-71-5"></a><span class="w"> </span>-<span class="w"> </span>username:<span class="w"> </span>william
<a id="__codelineno-71-6" name="__codelineno-71-6"></a><span class="w"> </span>group:<span class="w"> </span>manager
</code></pre></div></td></tr></table></div>
<p><font style="color:rgb(57,57,57);">开始循环这个变量</font></p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-72-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-72-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-72-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-72-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-72-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-72-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-72-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-72-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-72-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-72-10">10</a></span>
<span class="normal"><a href="#__codelineno-72-11">11</a></span>
<span class="normal"><a href="#__codelineno-72-12">12</a></span>
<span class="normal"><a href="#__codelineno-72-13">13</a></span>
<span class="normal"><a href="#__codelineno-72-14">14</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-72-1" name="__codelineno-72-1"></a><span class="o">[</span>root@workstation<span class="w"> </span>ansible<span class="o">]</span><span class="c1"># vim site1.yml</span>
<a id="__codelineno-72-2" name="__codelineno-72-2"></a>---
<a id="__codelineno-72-3" name="__codelineno-72-3"></a>-<span class="w"> </span>name:<span class="w"> </span><span class="nb">test</span><span class="w"> </span>loop
<a id="__codelineno-72-4" name="__codelineno-72-4"></a><span class="w"> </span>hosts:<span class="w"> </span>web
<a id="__codelineno-72-5" name="__codelineno-72-5"></a><span class="w"> </span>tasks:
<a id="__codelineno-72-6" name="__codelineno-72-6"></a><span class="w"> </span>-<span class="w"> </span>name:<span class="w"> </span>add<span class="w"> </span>group
<a id="__codelineno-72-7" name="__codelineno-72-7"></a><span class="w"> </span>ansible.builtin.group:
<a id="__codelineno-72-8" name="__codelineno-72-8"></a><span class="w"> </span>name:<span class="w"> </span><span class="s2">&quot;{{ item.group }}&quot;</span>
<a id="__codelineno-72-9" name="__codelineno-72-9"></a><span class="w"> </span>loop:<span class="w"> </span><span class="s2">&quot;{{ userlist }}&quot;</span>
<a id="__codelineno-72-10" name="__codelineno-72-10"></a><span class="w"> </span>-<span class="w"> </span>name:<span class="w"> </span>add<span class="w"> </span>user
<a id="__codelineno-72-11" name="__codelineno-72-11"></a><span class="w"> </span>ansible.builtin.user:
<a id="__codelineno-72-12" name="__codelineno-72-12"></a><span class="w"> </span>name:<span class="w"> </span><span class="s2">&quot;{{ item.username }}&quot;</span>
<a id="__codelineno-72-13" name="__codelineno-72-13"></a><span class="w"> </span>groups:<span class="w"> </span><span class="s2">&quot;{{ item.group }}&quot;</span>
<a id="__codelineno-72-14" name="__codelineno-72-14"></a><span class="w"> </span>loop:<span class="w"> </span><span class="s2">&quot;{{ userlist }}&quot;</span>
</code></pre></div></td></tr></table></div>
<h2 id="ansible条件判断"><strong><font style="color:rgb(0,0,0);">Ansible条件判断 </font></strong><a class="headerlink" href="#ansible条件判断" title="Permanent link">&para;</a></h2>
<p><font style="color:rgb(0,0,0);">在</font><font style="color:rgb(0,0,0);">playbook</font><font style="color:rgb(0,0,0);">中使用</font><font style="color:rgb(0,0,0);">"when"</font><font style="color:rgb(0,0,0);">来实现条件判断，即通过测试条件来决定任务是否会被执行，一般是只有测试条件成立时任 </font></p>
<p><font style="color:rgb(0,0,0);">务才会被执行。这样可以避免很多</font><font style="color:rgb(0,0,0);">task</font><font style="color:rgb(0,0,0);">意外的失败，还可以提高代码的执行效率。 </font></p>
<p><font style="color:rgb(0,0,0);">例如只在某个指定内核版本的机器上安装apache</font></p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-73-1">1</a></span>
<span class="normal"><a href="#__codelineno-73-2">2</a></span>
<span class="normal"><a href="#__codelineno-73-3">3</a></span>
<span class="normal"><a href="#__codelineno-73-4">4</a></span>
<span class="normal"><a href="#__codelineno-73-5">5</a></span>
<span class="normal"><a href="#__codelineno-73-6">6</a></span>
<span class="normal"><a href="#__codelineno-73-7">7</a></span>
<span class="normal"><a href="#__codelineno-73-8">8</a></span>
<span class="normal"><a href="#__codelineno-73-9">9</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-73-1" name="__codelineno-73-1"></a>---
<a id="__codelineno-73-2" name="__codelineno-73-2"></a>-<span class="w"> </span>name:<span class="w"> </span>测试条件判断
<a id="__codelineno-73-3" name="__codelineno-73-3"></a><span class="w"> </span>hosts:<span class="w"> </span>all
<a id="__codelineno-73-4" name="__codelineno-73-4"></a><span class="w"> </span>tasks:
<a id="__codelineno-73-5" name="__codelineno-73-5"></a><span class="w"> </span>-<span class="w"> </span>name:<span class="w"> </span>安装<span class="w"> </span>apache
<a id="__codelineno-73-6" name="__codelineno-73-6"></a><span class="w"> </span>ansible.builtin.yum:
<a id="__codelineno-73-7" name="__codelineno-73-7"></a><span class="w"> </span>name:<span class="w"> </span>httpd
<a id="__codelineno-73-8" name="__codelineno-73-8"></a><span class="w"> </span>state:<span class="w"> </span>latest
<a id="__codelineno-73-9" name="__codelineno-73-9"></a><span class="w"> </span>when:<span class="w"> </span><span class="nv">ansible_kernel</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;3.10.0-862.el7.x86_64&quot;</span>
</code></pre></div></td></tr></table></div>
<p><strong><font style="color:rgb(0,0,0);">when</font></strong><strong><font style="color:rgb(0,0,0);">的位置和作用 </font></strong></p>
<p><font style="color:rgb(57,57,57);">when </font><font style="color:rgb(57,57,57);">判断的对象是</font><font style="color:rgb(57,57,57);">task,</font><font style="color:rgb(57,57,57);">所以</font><font style="color:rgb(57,57,57);">when</font><font style="color:rgb(57,57,57);">必须和</font><font style="color:rgb(57,57,57);">task</font><font style="color:rgb(57,57,57);">任务保持对齐。 </font></p>
<p><font style="color:rgb(57,57,57);">when </font><font style="color:rgb(57,57,57);">条件判断的结果决定了它所在的</font><font style="color:rgb(57,57,57);">task</font><font style="color:rgb(57,57,57);">任务是否执行，对之后的</font><font style="color:rgb(57,57,57);">task</font><font style="color:rgb(57,57,57);">任务执行无影响。 </font></p>
<p><font style="color:rgb(57,57,57);">在</font><font style="color:rgb(57,57,57);">when</font><font style="color:rgb(57,57,57);">中引用变量时不需要加</font><font style="color:rgb(57,57,57);">"{{ }}" </font></p>
<p><font style="color:rgb(57,57,57);">when </font><font style="color:rgb(57,57,57);">支持逻辑组合</font><font style="color:rgb(57,57,57);"> or</font><font style="color:rgb(57,57,57);">，</font><font style="color:rgb(57,57,57);">not </font></p>
<p><strong><font style="color:rgb(0,0,0);">when </font></strong><strong><font style="color:rgb(0,0,0);">条件的写法 </font></strong></p>
<p><strong><font style="color:rgb(0,0,0);">1. </font></strong><strong><font style="color:rgb(0,0,0);">判断变量的值 </font></strong></p>
<p><font style="color:rgb(0,0,0);">可以 使用</font><font style="color:rgb(0,0,0);">"&gt;" "&lt;" "&gt;=" "&lt;=" "==" "!=" </font><font style="color:rgb(0,0,0);">这些符号来判断变量的值。 </font></p>
<p><font style="color:rgb(0,0,0);">示例：判断目标主机的swap大小，如果大于2048Mb 则输出swap分区大小</font></p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-74-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-74-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-74-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-74-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-74-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-74-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-74-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-74-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-74-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-74-10">10</a></span>
<span class="normal"><a href="#__codelineno-74-11">11</a></span>
<span class="normal"><a href="#__codelineno-74-12">12</a></span>
<span class="normal"><a href="#__codelineno-74-13">13</a></span>
<span class="normal"><a href="#__codelineno-74-14">14</a></span>
<span class="normal"><a href="#__codelineno-74-15">15</a></span>
<span class="normal"><a href="#__codelineno-74-16">16</a></span>
<span class="normal"><a href="#__codelineno-74-17">17</a></span>
<span class="normal"><a href="#__codelineno-74-18">18</a></span>
<span class="normal"><a href="#__codelineno-74-19">19</a></span>
<span class="normal"><a href="#__codelineno-74-20">20</a></span>
<span class="normal"><a href="#__codelineno-74-21">21</a></span>
<span class="normal"><a href="#__codelineno-74-22">22</a></span>
<span class="normal"><a href="#__codelineno-74-23">23</a></span>
<span class="normal"><a href="#__codelineno-74-24">24</a></span>
<span class="normal"><a href="#__codelineno-74-25">25</a></span>
<span class="normal"><a href="#__codelineno-74-26">26</a></span>
<span class="normal"><a href="#__codelineno-74-27">27</a></span>
<span class="normal"><a href="#__codelineno-74-28">28</a></span>
<span class="normal"><a href="#__codelineno-74-29">29</a></span>
<span class="normal"><a href="#__codelineno-74-30">30</a></span>
<span class="normal"><a href="#__codelineno-74-31">31</a></span>
<span class="normal"><a href="#__codelineno-74-32">32</a></span>
<span class="normal"><a href="#__codelineno-74-33">33</a></span>
<span class="normal"><a href="#__codelineno-74-34">34</a></span>
<span class="normal"><a href="#__codelineno-74-35">35</a></span>
<span class="normal"><a href="#__codelineno-74-36">36</a></span>
<span class="normal"><a href="#__codelineno-74-37">37</a></span>
<span class="normal"><a href="#__codelineno-74-38">38</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-74-1" name="__codelineno-74-1"></a>---
<a id="__codelineno-74-2" name="__codelineno-74-2"></a>-<span class="w"> </span>name:<span class="w"> </span>测试条件判断
<a id="__codelineno-74-3" name="__codelineno-74-3"></a><span class="w"> </span>hosts:<span class="w"> </span>all
<a id="__codelineno-74-4" name="__codelineno-74-4"></a><span class="w"> </span>tasks:
<a id="__codelineno-74-5" name="__codelineno-74-5"></a><span class="w"> </span>-<span class="w"> </span>ansible.builtin.debug:
<a id="__codelineno-74-6" name="__codelineno-74-6"></a><span class="w"> </span>msg:<span class="w"> </span><span class="s2">&quot;{{ ansible_swaptotal_mb }}&quot;</span>
<a id="__codelineno-74-7" name="__codelineno-74-7"></a><span class="w"> </span>when:<span class="w"> </span>ansible_swaptotal_mb<span class="w"> </span>&gt;<span class="w"> </span><span class="m">2048</span>
<a id="__codelineno-74-8" name="__codelineno-74-8"></a><span class="o">[</span>difu@control<span class="w"> </span>ansible<span class="o">]</span>$<span class="w"> </span>ansible-playbook<span class="w"> </span>site.yml
<a id="__codelineno-74-9" name="__codelineno-74-9"></a>PLAY<span class="w"> </span><span class="o">[</span>测试条件判断<span class="o">]</span>
<a id="__codelineno-74-10" name="__codelineno-74-10"></a>****************************************************************
<a id="__codelineno-74-11" name="__codelineno-74-11"></a>*********************************
<a id="__codelineno-74-12" name="__codelineno-74-12"></a>TASK<span class="w"> </span><span class="o">[</span>Gathering<span class="w"> </span>Facts<span class="o">]</span>
<a id="__codelineno-74-13" name="__codelineno-74-13"></a>****************************************************************
<a id="__codelineno-74-14" name="__codelineno-74-14"></a>************************
<a id="__codelineno-74-15" name="__codelineno-74-15"></a>ok:<span class="w"> </span><span class="o">[</span>node2<span class="o">]</span>
<a id="__codelineno-74-16" name="__codelineno-74-16"></a>ok:<span class="w"> </span><span class="o">[</span>node1<span class="o">]</span>
<a id="__codelineno-74-17" name="__codelineno-74-17"></a>ok:<span class="w"> </span><span class="o">[</span>node3<span class="o">]</span>
<a id="__codelineno-74-18" name="__codelineno-74-18"></a>ok:<span class="w"> </span><span class="o">[</span>node4<span class="o">]</span>
<a id="__codelineno-74-19" name="__codelineno-74-19"></a>TASK<span class="w"> </span><span class="o">[</span>debug<span class="o">]</span>
<a id="__codelineno-74-20" name="__codelineno-74-20"></a>****************************************************************
<a id="__codelineno-74-21" name="__codelineno-74-21"></a>**********************************
<a id="__codelineno-74-22" name="__codelineno-74-22"></a>skipping:<span class="w"> </span><span class="o">[</span>node4<span class="o">]</span>
<a id="__codelineno-74-23" name="__codelineno-74-23"></a>ok:<span class="w"> </span><span class="o">[</span>node3<span class="o">]</span><span class="w"> </span><span class="o">=</span>&gt;<span class="w"> </span><span class="o">{</span>
<a id="__codelineno-74-24" name="__codelineno-74-24"></a><span class="w"> </span><span class="s2">&quot;msg&quot;</span>:<span class="w"> </span><span class="m">2547</span>
<a id="__codelineno-74-25" name="__codelineno-74-25"></a><span class="o">}</span>
<a id="__codelineno-74-26" name="__codelineno-74-26"></a>skipping:<span class="w"> </span><span class="o">[</span>node1<span class="o">]</span>
<a id="__codelineno-74-27" name="__codelineno-74-27"></a>skipping:<span class="w"> </span><span class="o">[</span>node2<span class="o">]</span>
<a id="__codelineno-74-28" name="__codelineno-74-28"></a>PLAY<span class="w"> </span>RECAP
<a id="__codelineno-74-29" name="__codelineno-74-29"></a>****************************************************************
<a id="__codelineno-74-30" name="__codelineno-74-30"></a>************************************
<a id="__codelineno-74-31" name="__codelineno-74-31"></a>node1<span class="w"> </span>:<span class="w"> </span><span class="nv">ok</span><span class="o">=</span><span class="m">1</span><span class="w"> </span><span class="nv">changed</span><span class="o">=</span><span class="m">0</span><span class="w"> </span><span class="nv">unreachable</span><span class="o">=</span><span class="m">0</span><span class="w"> </span>
<a id="__codelineno-74-32" name="__codelineno-74-32"></a><span class="nv">failed</span><span class="o">=</span><span class="m">0</span><span class="w"> </span>
<a id="__codelineno-74-33" name="__codelineno-74-33"></a>node2<span class="w"> </span>:<span class="w"> </span><span class="nv">ok</span><span class="o">=</span><span class="m">1</span><span class="w"> </span><span class="nv">changed</span><span class="o">=</span><span class="m">0</span><span class="w"> </span><span class="nv">unreachable</span><span class="o">=</span><span class="m">0</span><span class="w"> </span>
<a id="__codelineno-74-34" name="__codelineno-74-34"></a><span class="nv">failed</span><span class="o">=</span><span class="m">0</span><span class="w"> </span>
<a id="__codelineno-74-35" name="__codelineno-74-35"></a>node3<span class="w"> </span>:<span class="w"> </span><span class="nv">ok</span><span class="o">=</span><span class="m">2</span><span class="w"> </span><span class="nv">changed</span><span class="o">=</span><span class="m">0</span><span class="w"> </span><span class="nv">unreachable</span><span class="o">=</span><span class="m">0</span><span class="w"> </span>
<a id="__codelineno-74-36" name="__codelineno-74-36"></a><span class="nv">failed</span><span class="o">=</span><span class="m">0</span><span class="w"> </span>
<a id="__codelineno-74-37" name="__codelineno-74-37"></a>node4<span class="w"> </span>:<span class="w"> </span><span class="nv">ok</span><span class="o">=</span><span class="m">1</span><span class="w"> </span><span class="nv">changed</span><span class="o">=</span><span class="m">0</span><span class="w"> </span><span class="nv">unreachable</span><span class="o">=</span><span class="m">0</span><span class="w"> </span>
<a id="__codelineno-74-38" name="__codelineno-74-38"></a><span class="nv">failed</span><span class="o">=</span><span class="m">0</span>
</code></pre></div></td></tr></table></div>
<p><strong><font style="color:rgb(0,0,0);">2. </font></strong><strong><font style="color:rgb(0,0,0);">判断变量是否存在 </font></strong></p>
<p><font style="color:rgb(0,0,0);">使用</font><font style="color:rgb(0,0,0);">"is defined" </font><font style="color:rgb(0,0,0);">和</font><font style="color:rgb(0,0,0);"> "is undefined" </font><font style="color:rgb(0,0,0);">来判断变量是否存在 </font></p>
<p><font style="color:rgb(0,0,0);">示例： 判断目标主机上是否存在sdb磁盘，如果存在则输出sdb磁盘的大小</font></p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-75-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-75-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-75-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-75-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-75-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-75-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-75-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-75-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-75-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-75-10">10</a></span>
<span class="normal"><a href="#__codelineno-75-11">11</a></span>
<span class="normal"><a href="#__codelineno-75-12">12</a></span>
<span class="normal"><a href="#__codelineno-75-13">13</a></span>
<span class="normal"><a href="#__codelineno-75-14">14</a></span>
<span class="normal"><a href="#__codelineno-75-15">15</a></span>
<span class="normal"><a href="#__codelineno-75-16">16</a></span>
<span class="normal"><a href="#__codelineno-75-17">17</a></span>
<span class="normal"><a href="#__codelineno-75-18">18</a></span>
<span class="normal"><a href="#__codelineno-75-19">19</a></span>
<span class="normal"><a href="#__codelineno-75-20">20</a></span>
<span class="normal"><a href="#__codelineno-75-21">21</a></span>
<span class="normal"><a href="#__codelineno-75-22">22</a></span>
<span class="normal"><a href="#__codelineno-75-23">23</a></span>
<span class="normal"><a href="#__codelineno-75-24">24</a></span>
<span class="normal"><a href="#__codelineno-75-25">25</a></span>
<span class="normal"><a href="#__codelineno-75-26">26</a></span>
<span class="normal"><a href="#__codelineno-75-27">27</a></span>
<span class="normal"><a href="#__codelineno-75-28">28</a></span>
<span class="normal"><a href="#__codelineno-75-29">29</a></span>
<span class="normal"><a href="#__codelineno-75-30">30</a></span>
<span class="normal"><a href="#__codelineno-75-31">31</a></span>
<span class="normal"><a href="#__codelineno-75-32">32</a></span>
<span class="normal"><a href="#__codelineno-75-33">33</a></span>
<span class="normal"><a href="#__codelineno-75-34">34</a></span>
<span class="normal"><a href="#__codelineno-75-35">35</a></span>
<span class="normal"><a href="#__codelineno-75-36">36</a></span>
<span class="normal"><a href="#__codelineno-75-37">37</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-75-1" name="__codelineno-75-1"></a>-<span class="w"> </span>name:<span class="w"> </span>测试条件判断
<a id="__codelineno-75-2" name="__codelineno-75-2"></a><span class="w"> </span>hosts:<span class="w"> </span>all
<a id="__codelineno-75-3" name="__codelineno-75-3"></a><span class="w"> </span>tasks:
<a id="__codelineno-75-4" name="__codelineno-75-4"></a><span class="w"> </span>-<span class="w"> </span>ansible.builtin.debug:
<a id="__codelineno-75-5" name="__codelineno-75-5"></a><span class="w"> </span>msg:<span class="w"> </span><span class="s2">&quot;{{ ansible_devices.sdb.size}}&quot;</span>
<a id="__codelineno-75-6" name="__codelineno-75-6"></a><span class="w"> </span>when:<span class="w"> </span>ansible_devices.sdb<span class="w"> </span>is<span class="w"> </span>defined
<a id="__codelineno-75-7" name="__codelineno-75-7"></a><span class="o">[</span>difu@control<span class="w"> </span>ansible<span class="o">]</span>$<span class="w"> </span>ansible-playbook<span class="w"> </span>site.yml
<a id="__codelineno-75-8" name="__codelineno-75-8"></a>PLAY<span class="w"> </span><span class="o">[</span>测试条件判断<span class="o">]</span>
<a id="__codelineno-75-9" name="__codelineno-75-9"></a>****************************************************************
<a id="__codelineno-75-10" name="__codelineno-75-10"></a>*********************************
<a id="__codelineno-75-11" name="__codelineno-75-11"></a>TASK<span class="w"> </span><span class="o">[</span>Gathering<span class="w"> </span>Facts<span class="o">]</span>
<a id="__codelineno-75-12" name="__codelineno-75-12"></a>****************************************************************
<a id="__codelineno-75-13" name="__codelineno-75-13"></a>************************
<a id="__codelineno-75-14" name="__codelineno-75-14"></a>ok:<span class="w"> </span><span class="o">[</span>node2<span class="o">]</span>
<a id="__codelineno-75-15" name="__codelineno-75-15"></a>ok:<span class="w"> </span><span class="o">[</span>node4<span class="o">]</span>
<a id="__codelineno-75-16" name="__codelineno-75-16"></a>ok:<span class="w"> </span><span class="o">[</span>node3<span class="o">]</span>
<a id="__codelineno-75-17" name="__codelineno-75-17"></a>ok:<span class="w"> </span><span class="o">[</span>node1<span class="o">]</span>
<a id="__codelineno-75-18" name="__codelineno-75-18"></a>TASK<span class="w"> </span><span class="o">[</span>debug<span class="o">]</span>
<a id="__codelineno-75-19" name="__codelineno-75-19"></a>****************************************************************
<a id="__codelineno-75-20" name="__codelineno-75-20"></a>**********************************
<a id="__codelineno-75-21" name="__codelineno-75-21"></a>skipping:<span class="w"> </span><span class="o">[</span>node3<span class="o">]</span>
<a id="__codelineno-75-22" name="__codelineno-75-22"></a>skipping:<span class="w"> </span><span class="o">[</span>node4<span class="o">]</span>
<a id="__codelineno-75-23" name="__codelineno-75-23"></a>skipping:<span class="w"> </span><span class="o">[</span>node1<span class="o">]</span>
<a id="__codelineno-75-24" name="__codelineno-75-24"></a>ok:<span class="w"> </span><span class="o">[</span>node2<span class="o">]</span><span class="w"> </span><span class="o">=</span>&gt;<span class="w"> </span><span class="o">{</span>
<a id="__codelineno-75-25" name="__codelineno-75-25"></a><span class="w"> </span><span class="s2">&quot;msg&quot;</span>:<span class="w"> </span><span class="s2">&quot;40.00 GB&quot;</span>
<a id="__codelineno-75-26" name="__codelineno-75-26"></a><span class="o">}</span>
<a id="__codelineno-75-27" name="__codelineno-75-27"></a>PLAY<span class="w"> </span>RECAP
<a id="__codelineno-75-28" name="__codelineno-75-28"></a>****************************************************************
<a id="__codelineno-75-29" name="__codelineno-75-29"></a>************************************
<a id="__codelineno-75-30" name="__codelineno-75-30"></a>node1<span class="w"> </span>:<span class="w"> </span><span class="nv">ok</span><span class="o">=</span><span class="m">1</span><span class="w"> </span><span class="nv">changed</span><span class="o">=</span><span class="m">0</span><span class="w"> </span><span class="nv">unreachable</span><span class="o">=</span><span class="m">0</span><span class="w"> </span>
<a id="__codelineno-75-31" name="__codelineno-75-31"></a><span class="nv">failed</span><span class="o">=</span><span class="m">0</span><span class="w"> </span>
<a id="__codelineno-75-32" name="__codelineno-75-32"></a>node2<span class="w"> </span>:<span class="w"> </span><span class="nv">ok</span><span class="o">=</span><span class="m">2</span><span class="w"> </span><span class="nv">changed</span><span class="o">=</span><span class="m">0</span><span class="w"> </span><span class="nv">unreachable</span><span class="o">=</span><span class="m">0</span><span class="w"> </span>
<a id="__codelineno-75-33" name="__codelineno-75-33"></a><span class="nv">failed</span><span class="o">=</span><span class="m">0</span><span class="w"> </span>
<a id="__codelineno-75-34" name="__codelineno-75-34"></a>node3<span class="w"> </span>:<span class="w"> </span><span class="nv">ok</span><span class="o">=</span><span class="m">1</span><span class="w"> </span><span class="nv">changed</span><span class="o">=</span><span class="m">0</span><span class="w"> </span><span class="nv">unreachable</span><span class="o">=</span><span class="m">0</span><span class="w"> </span>
<a id="__codelineno-75-35" name="__codelineno-75-35"></a><span class="nv">failed</span><span class="o">=</span><span class="m">0</span><span class="w"> </span>
<a id="__codelineno-75-36" name="__codelineno-75-36"></a>node4<span class="w"> </span>:<span class="w"> </span><span class="nv">ok</span><span class="o">=</span><span class="m">1</span><span class="w"> </span><span class="nv">changed</span><span class="o">=</span><span class="m">0</span><span class="w"> </span><span class="nv">unreachable</span><span class="o">=</span><span class="m">0</span><span class="w"> </span>
<a id="__codelineno-75-37" name="__codelineno-75-37"></a><span class="nv">failed</span><span class="o">=</span><span class="m">0</span>
</code></pre></div></td></tr></table></div>
<p><strong><font style="color:rgb(0,0,0);">3. </font></strong><strong><font style="color:rgb(0,0,0);">判断变量是否在指定的列表中 </font></strong></p>
<p><font style="color:rgb(57,57,57);">使用 “in” 来判断</font></p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-76-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-76-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-76-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-76-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-76-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-76-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-76-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-76-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-76-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-76-10">10</a></span>
<span class="normal"><a href="#__codelineno-76-11">11</a></span>
<span class="normal"><a href="#__codelineno-76-12">12</a></span>
<span class="normal"><a href="#__codelineno-76-13">13</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-76-1" name="__codelineno-76-1"></a>---
<a id="__codelineno-76-2" name="__codelineno-76-2"></a>-<span class="w"> </span>name:<span class="w"> </span><span class="nb">test</span><span class="w"> </span>when
<a id="__codelineno-76-3" name="__codelineno-76-3"></a><span class="w"> </span>hosts:<span class="w"> </span>node1
<a id="__codelineno-76-4" name="__codelineno-76-4"></a><span class="w"> </span>vars:
<a id="__codelineno-76-5" name="__codelineno-76-5"></a><span class="w"> </span>system_support:
<a id="__codelineno-76-6" name="__codelineno-76-6"></a><span class="w"> </span>-<span class="w"> </span>RedHat
<a id="__codelineno-76-7" name="__codelineno-76-7"></a><span class="w"> </span>-<span class="w"> </span>CentOS
<a id="__codelineno-76-8" name="__codelineno-76-8"></a><span class="w"> </span>tasks:
<a id="__codelineno-76-9" name="__codelineno-76-9"></a><span class="w"> </span>-<span class="w"> </span>name:<span class="w"> </span>install<span class="w"> </span>httpd
<a id="__codelineno-76-10" name="__codelineno-76-10"></a><span class="w"> </span>ansible.builtin.yum:
<a id="__codelineno-76-11" name="__codelineno-76-11"></a><span class="w"> </span>name:<span class="w"> </span>httpd
<a id="__codelineno-76-12" name="__codelineno-76-12"></a><span class="w"> </span>state:<span class="w"> </span>latest
<a id="__codelineno-76-13" name="__codelineno-76-13"></a><span class="w"> </span>when:<span class="w"> </span>ansible_distribution<span class="w"> </span><span class="k">in</span><span class="w"> </span>system_support
</code></pre></div></td></tr></table></div>
<p><strong><font style="color:rgb(0,0,0);">handler触发器 </font></strong></p>
<p><font style="color:rgb(0,0,0);">当我们修改了某些应用服务的配置文件，需要重启服务才能使配置生效，这时就需要使用触发器了。在</font><font style="color:rgb(0,0,0);">task</font><font style="color:rgb(0,0,0);">任务中定义 </font></p>
<p><font style="color:rgb(0,0,0);">notify,</font><font style="color:rgb(0,0,0);">当任务被改变时就会触发</font><font style="color:rgb(0,0,0);">notify,notify</font><font style="color:rgb(0,0,0);">将定义好的信息传递给</font><font style="color:rgb(0,0,0);">handler</font><font style="color:rgb(0,0,0);">，</font><font style="color:rgb(0,0,0);">handler</font><font style="color:rgb(0,0,0);">则根据</font><font style="color:rgb(0,0,0);">notify</font><font style="color:rgb(0,0,0);">传递的信息 </font></p>
<p><font style="color:rgb(0,0,0);">执行相应的任务。 </font></p>
<p><font style="color:rgb(57,57,57);">handler </font><font style="color:rgb(57,57,57);">仅会在所有的</font><font style="color:rgb(57,57,57);">tasks</font><font style="color:rgb(57,57,57);">结束后运行一次 </font></p>
<p><font style="color:rgb(57,57,57);">只有</font><font style="color:rgb(57,57,57);">task</font><font style="color:rgb(57,57,57);">任务发生改变时才会触发</font><font style="color:rgb(57,57,57);">notify</font><font style="color:rgb(57,57,57);">，进而触发</font><font style="color:rgb(57,57,57);">handler </font></p>
<p><font style="color:rgb(223,64,42);">handler </font><font style="color:rgb(223,64,42);">的</font><font style="color:rgb(223,64,42);">name </font><font style="color:rgb(223,64,42);">和</font><font style="color:rgb(223,64,42);">notify </font><font style="color:rgb(223,64,42);">中定义的</font><font style="color:rgb(223,64,42);">name</font><font style="color:rgb(223,64,42);">必须保持一致 </font></p>
<p><font style="color:rgb(57,57,57);">handler</font><font style="color:rgb(57,57,57);">可以理解成一种特殊的</font><font style="color:rgb(57,57,57);">task</font><font style="color:rgb(57,57,57);">任务，使用</font><font style="color:rgb(57,57,57);">handlers</font><font style="color:rgb(57,57,57);">来定义，和</font><font style="color:rgb(57,57,57);">tasks</font><font style="color:rgb(57,57,57);">保持对齐，</font><font style="color:rgb(57,57,57);">handlers</font><font style="color:rgb(57,57,57);">放在</font><font style="color:rgb(57,57,57);">playbook</font><font style="color:rgb(57,57,57);">的最 </font></p>
<p><font style="color:rgb(57,57,57);">后 </font></p>
<p><font style="color:rgb(0,0,0);">可以在</font><font style="color:rgb(0,0,0);">playbook</font><font style="color:rgb(0,0,0);">中定义强制执行</font><font style="color:rgb(0,0,0);">handler </font></p>
<p><strong><font style="color:rgb(0,0,0);">force_handlers: yes</font></strong></p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-77-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-77-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-77-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-77-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-77-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-77-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-77-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-77-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-77-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-77-10">10</a></span>
<span class="normal"><a href="#__codelineno-77-11">11</a></span>
<span class="normal"><a href="#__codelineno-77-12">12</a></span>
<span class="normal"><a href="#__codelineno-77-13">13</a></span>
<span class="normal"><a href="#__codelineno-77-14">14</a></span>
<span class="normal"><a href="#__codelineno-77-15">15</a></span>
<span class="normal"><a href="#__codelineno-77-16">16</a></span>
<span class="normal"><a href="#__codelineno-77-17">17</a></span>
<span class="normal"><a href="#__codelineno-77-18">18</a></span>
<span class="normal"><a href="#__codelineno-77-19">19</a></span>
<span class="normal"><a href="#__codelineno-77-20">20</a></span>
<span class="normal"><a href="#__codelineno-77-21">21</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-77-1" name="__codelineno-77-1"></a>-<span class="w"> </span>name:<span class="w"> </span><span class="nb">test</span><span class="w"> </span>handler
<a id="__codelineno-77-2" name="__codelineno-77-2"></a><span class="w"> </span>hosts:<span class="w"> </span>web
<a id="__codelineno-77-3" name="__codelineno-77-3"></a><span class="w"> </span>tasks:
<a id="__codelineno-77-4" name="__codelineno-77-4"></a><span class="w"> </span>-<span class="w"> </span>name:<span class="w"> </span>install<span class="w"> </span>httpd
<a id="__codelineno-77-5" name="__codelineno-77-5"></a><span class="w"> </span>ansible.builtin.yum:
<a id="__codelineno-77-6" name="__codelineno-77-6"></a><span class="w"> </span>name:<span class="w"> </span>httpd
<a id="__codelineno-77-7" name="__codelineno-77-7"></a><span class="w"> </span>state:<span class="w"> </span>latest
<a id="__codelineno-77-8" name="__codelineno-77-8"></a><span class="w"> </span>-<span class="w"> </span>name:<span class="w"> </span>copy<span class="w"> </span>config<span class="w"> </span>file
<a id="__codelineno-77-9" name="__codelineno-77-9"></a><span class="w"> </span>ansible.builtin.copy:
<a id="__codelineno-77-10" name="__codelineno-77-10"></a><span class="w"> </span>src:<span class="w"> </span>files/vhost.conf
<a id="__codelineno-77-11" name="__codelineno-77-11"></a><span class="w"> </span>dest:<span class="w"> </span>/etc/httpd/conf.d/vhost.conf
<a id="__codelineno-77-12" name="__codelineno-77-12"></a><span class="w"> </span>notify:<span class="w"> </span>restart<span class="w"> </span>httpd
<a id="__codelineno-77-13" name="__codelineno-77-13"></a><span class="w"> </span>-<span class="w"> </span>name:<span class="w"> </span>start<span class="w"> </span>httpd
<a id="__codelineno-77-14" name="__codelineno-77-14"></a><span class="w"> </span>ansible.builtin.service:
<a id="__codelineno-77-15" name="__codelineno-77-15"></a><span class="w"> </span>name:<span class="w"> </span>httpd
<a id="__codelineno-77-16" name="__codelineno-77-16"></a><span class="w"> </span>state:<span class="w"> </span>started
<a id="__codelineno-77-17" name="__codelineno-77-17"></a><span class="w"> </span>handlers:<span class="w"> </span>
<a id="__codelineno-77-18" name="__codelineno-77-18"></a><span class="w"> </span>-<span class="w"> </span>name:<span class="w"> </span>restart<span class="w"> </span>httpd
<a id="__codelineno-77-19" name="__codelineno-77-19"></a><span class="w"> </span>ansible.builtin.service:
<a id="__codelineno-77-20" name="__codelineno-77-20"></a><span class="w"> </span>name:<span class="w"> </span>httpd
<a id="__codelineno-77-21" name="__codelineno-77-21"></a><span class="w"> </span>state:<span class="w"> </span>restarted
</code></pre></div></td></tr></table></div>
<p><font style="color:rgb(0,0,0);">正常执行时，handler没有被触发</font></p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-78-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-78-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-78-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-78-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-78-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-78-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-78-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-78-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-78-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-78-10">10</a></span>
<span class="normal"><a href="#__codelineno-78-11">11</a></span>
<span class="normal"><a href="#__codelineno-78-12">12</a></span>
<span class="normal"><a href="#__codelineno-78-13">13</a></span>
<span class="normal"><a href="#__codelineno-78-14">14</a></span>
<span class="normal"><a href="#__codelineno-78-15">15</a></span>
<span class="normal"><a href="#__codelineno-78-16">16</a></span>
<span class="normal"><a href="#__codelineno-78-17">17</a></span>
<span class="normal"><a href="#__codelineno-78-18">18</a></span>
<span class="normal"><a href="#__codelineno-78-19">19</a></span>
<span class="normal"><a href="#__codelineno-78-20">20</a></span>
<span class="normal"><a href="#__codelineno-78-21">21</a></span>
<span class="normal"><a href="#__codelineno-78-22">22</a></span>
<span class="normal"><a href="#__codelineno-78-23">23</a></span>
<span class="normal"><a href="#__codelineno-78-24">24</a></span>
<span class="normal"><a href="#__codelineno-78-25">25</a></span>
<span class="normal"><a href="#__codelineno-78-26">26</a></span>
<span class="normal"><a href="#__codelineno-78-27">27</a></span>
<span class="normal"><a href="#__codelineno-78-28">28</a></span>
<span class="normal"><a href="#__codelineno-78-29">29</a></span>
<span class="normal"><a href="#__codelineno-78-30">30</a></span>
<span class="normal"><a href="#__codelineno-78-31">31</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-78-1" name="__codelineno-78-1"></a><span class="o">[</span>root@workstation<span class="w"> </span>ansible<span class="o">]</span><span class="c1"># ansible-navigator run site5.yml -m stdout</span>
<a id="__codelineno-78-2" name="__codelineno-78-2"></a>PLAY<span class="w"> </span><span class="o">[</span><span class="nb">test</span><span class="w"> </span>handler<span class="o">]</span>
<a id="__codelineno-78-3" name="__codelineno-78-3"></a>*****************************************************************************************
<a id="__codelineno-78-4" name="__codelineno-78-4"></a>***************
<a id="__codelineno-78-5" name="__codelineno-78-5"></a>TASK<span class="w"> </span><span class="o">[</span>Gathering<span class="w"> </span>Facts<span class="o">]</span>
<a id="__codelineno-78-6" name="__codelineno-78-6"></a>*****************************************************************************************
<a id="__codelineno-78-7" name="__codelineno-78-7"></a>*************
<a id="__codelineno-78-8" name="__codelineno-78-8"></a>ok:<span class="w"> </span><span class="o">[</span>node2<span class="o">]</span>
<a id="__codelineno-78-9" name="__codelineno-78-9"></a>ok:<span class="w"> </span><span class="o">[</span>node1<span class="o">]</span>
<a id="__codelineno-78-10" name="__codelineno-78-10"></a>TASK<span class="w"> </span><span class="o">[</span>install<span class="w"> </span>httpd<span class="o">]</span>
<a id="__codelineno-78-11" name="__codelineno-78-11"></a>*****************************************************************************************
<a id="__codelineno-78-12" name="__codelineno-78-12"></a>***************
<a id="__codelineno-78-13" name="__codelineno-78-13"></a>ok:<span class="w"> </span><span class="o">[</span>node1<span class="o">]</span>
<a id="__codelineno-78-14" name="__codelineno-78-14"></a>ok:<span class="w"> </span><span class="o">[</span>node2<span class="o">]</span>
<a id="__codelineno-78-15" name="__codelineno-78-15"></a>TASK<span class="w"> </span><span class="o">[</span>copy<span class="w"> </span>config<span class="w"> </span>file<span class="o">]</span>
<a id="__codelineno-78-16" name="__codelineno-78-16"></a>*****************************************************************************************
<a id="__codelineno-78-17" name="__codelineno-78-17"></a>************
<a id="__codelineno-78-18" name="__codelineno-78-18"></a>ok:<span class="w"> </span><span class="o">[</span>node1<span class="o">]</span>
<a id="__codelineno-78-19" name="__codelineno-78-19"></a>ok:<span class="w"> </span><span class="o">[</span>node2<span class="o">]</span>
<a id="__codelineno-78-20" name="__codelineno-78-20"></a>TASK<span class="w"> </span><span class="o">[</span>start<span class="w"> </span>httpd<span class="o">]</span>
<a id="__codelineno-78-21" name="__codelineno-78-21"></a>*****************************************************************************************
<a id="__codelineno-78-22" name="__codelineno-78-22"></a>*****************
<a id="__codelineno-78-23" name="__codelineno-78-23"></a>ok:<span class="w"> </span><span class="o">[</span>node2<span class="o">]</span>
<a id="__codelineno-78-24" name="__codelineno-78-24"></a>ok:<span class="w"> </span><span class="o">[</span>node1<span class="o">]</span>
<a id="__codelineno-78-25" name="__codelineno-78-25"></a>PLAY<span class="w"> </span>RECAP
<a id="__codelineno-78-26" name="__codelineno-78-26"></a>*****************************************************************************************
<a id="__codelineno-78-27" name="__codelineno-78-27"></a>*************************
<a id="__codelineno-78-28" name="__codelineno-78-28"></a>node1<span class="w"> </span>:<span class="w"> </span><span class="nv">ok</span><span class="o">=</span><span class="m">4</span><span class="w"> </span><span class="nv">changed</span><span class="o">=</span><span class="m">0</span><span class="w"> </span><span class="nv">unreachable</span><span class="o">=</span><span class="m">0</span><span class="w"> </span><span class="nv">failed</span><span class="o">=</span><span class="m">0</span><span class="w"> </span><span class="nv">skipped</span><span class="o">=</span><span class="m">0</span><span class="w"> </span>
<a id="__codelineno-78-29" name="__codelineno-78-29"></a><span class="nv">rescued</span><span class="o">=</span><span class="m">0</span><span class="w"> </span><span class="nv">ignored</span><span class="o">=</span><span class="m">0</span><span class="w"> </span>
<a id="__codelineno-78-30" name="__codelineno-78-30"></a>node2<span class="w"> </span>:<span class="w"> </span><span class="nv">ok</span><span class="o">=</span><span class="m">4</span><span class="w"> </span><span class="nv">changed</span><span class="o">=</span><span class="m">0</span><span class="w"> </span><span class="nv">unreachable</span><span class="o">=</span><span class="m">0</span><span class="w"> </span><span class="nv">failed</span><span class="o">=</span><span class="m">0</span><span class="w"> </span><span class="nv">skipped</span><span class="o">=</span><span class="m">0</span><span class="w"> </span>
<a id="__codelineno-78-31" name="__codelineno-78-31"></a><span class="nv">rescued</span><span class="o">=</span><span class="m">0</span><span class="w"> </span><span class="nv">ignored</span><span class="o">=</span><span class="m">0</span>
</code></pre></div></td></tr></table></div>
<p><font style="color:rgb(0,0,0);">修改了被copy的文件之后，再次执行会发现handler被触发了。</font></p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-79-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-79-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-79-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-79-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-79-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-79-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-79-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-79-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-79-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-79-10">10</a></span>
<span class="normal"><a href="#__codelineno-79-11">11</a></span>
<span class="normal"><a href="#__codelineno-79-12">12</a></span>
<span class="normal"><a href="#__codelineno-79-13">13</a></span>
<span class="normal"><a href="#__codelineno-79-14">14</a></span>
<span class="normal"><a href="#__codelineno-79-15">15</a></span>
<span class="normal"><a href="#__codelineno-79-16">16</a></span>
<span class="normal"><a href="#__codelineno-79-17">17</a></span>
<span class="normal"><a href="#__codelineno-79-18">18</a></span>
<span class="normal"><a href="#__codelineno-79-19">19</a></span>
<span class="normal"><a href="#__codelineno-79-20">20</a></span>
<span class="normal"><a href="#__codelineno-79-21">21</a></span>
<span class="normal"><a href="#__codelineno-79-22">22</a></span>
<span class="normal"><a href="#__codelineno-79-23">23</a></span>
<span class="normal"><a href="#__codelineno-79-24">24</a></span>
<span class="normal"><a href="#__codelineno-79-25">25</a></span>
<span class="normal"><a href="#__codelineno-79-26">26</a></span>
<span class="normal"><a href="#__codelineno-79-27">27</a></span>
<span class="normal"><a href="#__codelineno-79-28">28</a></span>
<span class="normal"><a href="#__codelineno-79-29">29</a></span>
<span class="normal"><a href="#__codelineno-79-30">30</a></span>
<span class="normal"><a href="#__codelineno-79-31">31</a></span>
<span class="normal"><a href="#__codelineno-79-32">32</a></span>
<span class="normal"><a href="#__codelineno-79-33">33</a></span>
<span class="normal"><a href="#__codelineno-79-34">34</a></span>
<span class="normal"><a href="#__codelineno-79-35">35</a></span>
<span class="normal"><a href="#__codelineno-79-36">36</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-79-1" name="__codelineno-79-1"></a><span class="o">[</span>root@workstation<span class="w"> </span>ansible<span class="o">]</span><span class="c1"># ansible-navigator run site5.yml -m stdout</span>
<a id="__codelineno-79-2" name="__codelineno-79-2"></a>PLAY<span class="w"> </span><span class="o">[</span><span class="nb">test</span><span class="w"> </span>handler<span class="o">]</span>
<a id="__codelineno-79-3" name="__codelineno-79-3"></a>************************************************************************
<a id="__codelineno-79-4" name="__codelineno-79-4"></a>********************************
<a id="__codelineno-79-5" name="__codelineno-79-5"></a>TASK<span class="w"> </span><span class="o">[</span>Gathering<span class="w"> </span>Facts<span class="o">]</span>
<a id="__codelineno-79-6" name="__codelineno-79-6"></a>************************************************************************
<a id="__codelineno-79-7" name="__codelineno-79-7"></a>******************************
<a id="__codelineno-79-8" name="__codelineno-79-8"></a>ok:<span class="w"> </span><span class="o">[</span>node2<span class="o">]</span>
<a id="__codelineno-79-9" name="__codelineno-79-9"></a>ok:<span class="w"> </span><span class="o">[</span>node1<span class="o">]</span>
<a id="__codelineno-79-10" name="__codelineno-79-10"></a>TASK<span class="w"> </span><span class="o">[</span>install<span class="w"> </span>httpd<span class="o">]</span>
<a id="__codelineno-79-11" name="__codelineno-79-11"></a>************************************************************************
<a id="__codelineno-79-12" name="__codelineno-79-12"></a>********************************
<a id="__codelineno-79-13" name="__codelineno-79-13"></a>ok:<span class="w"> </span><span class="o">[</span>node1<span class="o">]</span>
<a id="__codelineno-79-14" name="__codelineno-79-14"></a>ok:<span class="w"> </span><span class="o">[</span>node2<span class="o">]</span>
<a id="__codelineno-79-15" name="__codelineno-79-15"></a>TASK<span class="w"> </span><span class="o">[</span>copy<span class="w"> </span>config<span class="w"> </span>file<span class="o">]</span>
<a id="__codelineno-79-16" name="__codelineno-79-16"></a>************************************************************************
<a id="__codelineno-79-17" name="__codelineno-79-17"></a>*****************************
<a id="__codelineno-79-18" name="__codelineno-79-18"></a>changed:<span class="w"> </span><span class="o">[</span>node1<span class="o">]</span>
<a id="__codelineno-79-19" name="__codelineno-79-19"></a>changed:<span class="w"> </span><span class="o">[</span>node2<span class="o">]</span>
<a id="__codelineno-79-20" name="__codelineno-79-20"></a>TASK<span class="w"> </span><span class="o">[</span>start<span class="w"> </span>httpd<span class="o">]</span>
<a id="__codelineno-79-21" name="__codelineno-79-21"></a>************************************************************************
<a id="__codelineno-79-22" name="__codelineno-79-22"></a>**********************************
<a id="__codelineno-79-23" name="__codelineno-79-23"></a>changed:<span class="w"> </span><span class="o">[</span>node1<span class="o">]</span>
<a id="__codelineno-79-24" name="__codelineno-79-24"></a>changed:<span class="w"> </span><span class="o">[</span>node2<span class="o">]</span>
<a id="__codelineno-79-25" name="__codelineno-79-25"></a>RUNNING<span class="w"> </span>HANDLER<span class="w"> </span><span class="o">[</span>restart<span class="w"> </span>httpd<span class="o">]</span>
<a id="__codelineno-79-26" name="__codelineno-79-26"></a>************************************************************************
<a id="__codelineno-79-27" name="__codelineno-79-27"></a>*********************
<a id="__codelineno-79-28" name="__codelineno-79-28"></a>changed:<span class="w"> </span><span class="o">[</span>node1<span class="o">]</span>
<a id="__codelineno-79-29" name="__codelineno-79-29"></a>changed:<span class="w"> </span><span class="o">[</span>node2<span class="o">]</span>
<a id="__codelineno-79-30" name="__codelineno-79-30"></a>PLAY<span class="w"> </span>RECAP
<a id="__codelineno-79-31" name="__codelineno-79-31"></a>************************************************************************
<a id="__codelineno-79-32" name="__codelineno-79-32"></a>******************************************
<a id="__codelineno-79-33" name="__codelineno-79-33"></a>node1<span class="w"> </span>:<span class="w"> </span><span class="nv">ok</span><span class="o">=</span><span class="m">5</span><span class="w"> </span><span class="nv">changed</span><span class="o">=</span><span class="m">3</span><span class="w"> </span><span class="nv">unreachable</span><span class="o">=</span><span class="m">0</span><span class="w"> </span>
<a id="__codelineno-79-34" name="__codelineno-79-34"></a><span class="nv">failed</span><span class="o">=</span><span class="m">0</span><span class="w"> </span><span class="nv">skipped</span><span class="o">=</span><span class="m">0</span><span class="w"> </span><span class="nv">rescued</span><span class="o">=</span><span class="m">0</span><span class="w"> </span><span class="nv">ignored</span><span class="o">=</span><span class="m">0</span><span class="w"> </span>
<a id="__codelineno-79-35" name="__codelineno-79-35"></a>node2<span class="w"> </span>:<span class="w"> </span><span class="nv">ok</span><span class="o">=</span><span class="m">5</span><span class="w"> </span><span class="nv">changed</span><span class="o">=</span><span class="m">3</span><span class="w"> </span><span class="nv">unreachable</span><span class="o">=</span><span class="m">0</span><span class="w"> </span>
<a id="__codelineno-79-36" name="__codelineno-79-36"></a><span class="nv">failed</span><span class="o">=</span><span class="m">0</span><span class="w"> </span><span class="nv">skipped</span><span class="o">=</span><span class="m">0</span><span class="w"> </span><span class="nv">rescued</span><span class="o">=</span><span class="m">0</span><span class="w"> </span><span class="nv">ignored</span><span class="o">=</span><span class="m">0</span>
</code></pre></div></td></tr></table></div>
<p><strong><font style="color:rgb(0,0,0);">异常处理 </font></strong></p>
<p><strong><font style="color:rgb(0,0,0);">1. 忽略错误 </font></strong></p>
<p><font style="color:rgb(0,0,0);">playbook</font><font style="color:rgb(0,0,0);">在执行</font><font style="color:rgb(0,0,0);">tasks</font><font style="color:rgb(0,0,0);">任务时，如果某个任务出错就会直接退出，后面的任务也不会执行，对于某些任务即使报错还 </font></p>
<p><font style="color:rgb(0,0,0);">要继续执行后面的任务就需要对这个任务进行错误忽略。 </font></p>
<p><font style="color:rgb(0,0,0);">在任务中定义</font><strong><font style="color:rgb(0,0,0);">ignore_errors: yes </font></strong><font style="color:rgb(0,0,0);">可以来忽略错误。 </font></p>
<p><strong><font style="color:rgb(0,0,0);">2. block块 </font></strong></p>
<p><font style="color:rgb(0,0,0);">在</font><font style="color:rgb(0,0,0);">Ansible</font><font style="color:rgb(0,0,0);">中可以使用</font><font style="color:rgb(0,0,0);">block</font><font style="color:rgb(0,0,0);">将多个任务定义成一个块，一个</font><font style="color:rgb(0,0,0);">block</font><font style="color:rgb(0,0,0);">块可以看成是一个组或一个整体，我们可以对整个 </font></p>
<p><font style="color:rgb(0,0,0);">block</font><font style="color:rgb(0,0,0);">块进行条件判断，当条件成立时，块中所有的任务都会被执行。 </font></p>
<p><font style="color:rgb(0,0,0);">block</font><font style="color:rgb(0,0,0);">还可以配合</font><font style="color:rgb(0,0,0);">rescue</font><font style="color:rgb(0,0,0);">和</font><font style="color:rgb(0,0,0);">always</font><font style="color:rgb(0,0,0);">使用，</font><font style="color:rgb(0,0,0);">rescue</font><font style="color:rgb(0,0,0);">可以对</font><font style="color:rgb(0,0,0);">block</font><font style="color:rgb(0,0,0);">中的任务进行错误捕捉，当</font><font style="color:rgb(0,0,0);">block</font><font style="color:rgb(0,0,0);">中的任何一个任务 </font></p>
<p><font style="color:rgb(0,0,0);">出错时，都会执行rescue中的任务。always是无论block块中的任务是否执行成功，都会执行always中的任务。</font></p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-80-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-80-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-80-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-80-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-80-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-80-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-80-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-80-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-80-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-80-10">10</a></span>
<span class="normal"><a href="#__codelineno-80-11">11</a></span>
<span class="normal"><a href="#__codelineno-80-12">12</a></span>
<span class="normal"><a href="#__codelineno-80-13">13</a></span>
<span class="normal"><a href="#__codelineno-80-14">14</a></span>
<span class="normal"><a href="#__codelineno-80-15">15</a></span>
<span class="normal"><a href="#__codelineno-80-16">16</a></span>
<span class="normal"><a href="#__codelineno-80-17">17</a></span>
<span class="normal"><a href="#__codelineno-80-18">18</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-80-1" name="__codelineno-80-1"></a>---
<a id="__codelineno-80-2" name="__codelineno-80-2"></a>-<span class="w"> </span>hosts:<span class="w"> </span>web
<a id="__codelineno-80-3" name="__codelineno-80-3"></a><span class="w"> </span>vars:
<a id="__codelineno-80-4" name="__codelineno-80-4"></a><span class="w"> </span>web_pkg:<span class="w"> </span>http
<a id="__codelineno-80-5" name="__codelineno-80-5"></a><span class="w"> </span>db_pkg:
<a id="__codelineno-80-6" name="__codelineno-80-6"></a><span class="w"> </span>-<span class="w"> </span>mariadb-server
<a id="__codelineno-80-7" name="__codelineno-80-7"></a><span class="w"> </span>-<span class="w"> </span>mariadb
<a id="__codelineno-80-8" name="__codelineno-80-8"></a><span class="w"> </span>tasks:
<a id="__codelineno-80-9" name="__codelineno-80-9"></a><span class="w"> </span>-<span class="w"> </span>block:
<a id="__codelineno-80-10" name="__codelineno-80-10"></a><span class="w"> </span>-<span class="w"> </span>name:<span class="w"> </span>install<span class="w"> </span><span class="s2">&quot;{{ web_pkg }}&quot;</span>
<a id="__codelineno-80-11" name="__codelineno-80-11"></a><span class="w"> </span>ansible.builtin.yum:
<a id="__codelineno-80-12" name="__codelineno-80-12"></a><span class="w"> </span>name:<span class="w"> </span><span class="s2">&quot;{{ web_pkg }}&quot;</span>
<a id="__codelineno-80-13" name="__codelineno-80-13"></a><span class="w"> </span>state:<span class="w"> </span>latest
<a id="__codelineno-80-14" name="__codelineno-80-14"></a><span class="w"> </span>rescue:
<a id="__codelineno-80-15" name="__codelineno-80-15"></a><span class="w"> </span>-<span class="w"> </span>name:<span class="w"> </span>install<span class="w"> </span>dbpkg
<a id="__codelineno-80-16" name="__codelineno-80-16"></a><span class="w"> </span>ansible.builtin.yum:
<a id="__codelineno-80-17" name="__codelineno-80-17"></a><span class="w"> </span>name:<span class="w"> </span><span class="s2">&quot;{{ db_pkg }}&quot;</span>
<a id="__codelineno-80-18" name="__codelineno-80-18"></a><span class="w"> </span>state:<span class="w"> </span>latest
</code></pre></div></td></tr></table></div>
<p><font style="color:rgb(0,0,0);">执行结果： 可以看到block中的任务执行失败了，所以执行了rescue 中的任务。</font></p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-81-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-81-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-81-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-81-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-81-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-81-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-81-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-81-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-81-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-81-10">10</a></span>
<span class="normal"><a href="#__codelineno-81-11">11</a></span>
<span class="normal"><a href="#__codelineno-81-12">12</a></span>
<span class="normal"><a href="#__codelineno-81-13">13</a></span>
<span class="normal"><a href="#__codelineno-81-14">14</a></span>
<span class="normal"><a href="#__codelineno-81-15">15</a></span>
<span class="normal"><a href="#__codelineno-81-16">16</a></span>
<span class="normal"><a href="#__codelineno-81-17">17</a></span>
<span class="normal"><a href="#__codelineno-81-18">18</a></span>
<span class="normal"><a href="#__codelineno-81-19">19</a></span>
<span class="normal"><a href="#__codelineno-81-20">20</a></span>
<span class="normal"><a href="#__codelineno-81-21">21</a></span>
<span class="normal"><a href="#__codelineno-81-22">22</a></span>
<span class="normal"><a href="#__codelineno-81-23">23</a></span>
<span class="normal"><a href="#__codelineno-81-24">24</a></span>
<span class="normal"><a href="#__codelineno-81-25">25</a></span>
<span class="normal"><a href="#__codelineno-81-26">26</a></span>
<span class="normal"><a href="#__codelineno-81-27">27</a></span>
<span class="normal"><a href="#__codelineno-81-28">28</a></span>
<span class="normal"><a href="#__codelineno-81-29">29</a></span>
<span class="normal"><a href="#__codelineno-81-30">30</a></span>
<span class="normal"><a href="#__codelineno-81-31">31</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-81-1" name="__codelineno-81-1"></a>PLAY<span class="w"> </span><span class="o">[</span>web<span class="o">]</span>
<a id="__codelineno-81-2" name="__codelineno-81-2"></a>***************************************************************
<a id="__codelineno-81-3" name="__codelineno-81-3"></a>*****************************************************
<a id="__codelineno-81-4" name="__codelineno-81-4"></a>TASK<span class="w"> </span><span class="o">[</span>Gathering<span class="w"> </span>Facts<span class="o">]</span>
<a id="__codelineno-81-5" name="__codelineno-81-5"></a>***************************************************************
<a id="__codelineno-81-6" name="__codelineno-81-6"></a>*****************************************
<a id="__codelineno-81-7" name="__codelineno-81-7"></a>ok:<span class="w"> </span><span class="o">[</span>node2<span class="o">]</span>
<a id="__codelineno-81-8" name="__codelineno-81-8"></a>ok:<span class="w"> </span><span class="o">[</span>node1<span class="o">]</span>
<a id="__codelineno-81-9" name="__codelineno-81-9"></a>TASK<span class="w"> </span><span class="o">[</span>install<span class="w"> </span><span class="s2">&quot;http&quot;</span><span class="o">]</span>
<a id="__codelineno-81-10" name="__codelineno-81-10"></a>***************************************************************
<a id="__codelineno-81-11" name="__codelineno-81-11"></a>******************************************
<a id="__codelineno-81-12" name="__codelineno-81-12"></a>fatal:<span class="w"> </span><span class="o">[</span>node1<span class="o">]</span>:<span class="w"> </span>FAILED!<span class="w"> </span><span class="o">=</span>&gt;<span class="w"> </span><span class="o">{</span><span class="s2">&quot;changed&quot;</span>:<span class="w"> </span>false,<span class="w"> </span><span class="s2">&quot;msg&quot;</span>:<span class="w"> </span><span class="s2">&quot;No</span>
<a id="__codelineno-81-13" name="__codelineno-81-13"></a><span class="s2">package matching &#39;http&#39; found available, installed or updated&quot;</span>,
<a id="__codelineno-81-14" name="__codelineno-81-14"></a><span class="s2">&quot;rc&quot;</span>:<span class="w"> </span><span class="m">126</span>,<span class="w"> </span><span class="s2">&quot;results&quot;</span>:<span class="w"> </span><span class="o">[</span><span class="s2">&quot;No package matching &#39;http&#39; found</span>
<a id="__codelineno-81-15" name="__codelineno-81-15"></a><span class="s2">available, installed or updated&quot;</span><span class="o">]}</span>
<a id="__codelineno-81-16" name="__codelineno-81-16"></a>fatal:<span class="w"> </span><span class="o">[</span>node2<span class="o">]</span>:<span class="w"> </span>FAILED!<span class="w"> </span><span class="o">=</span>&gt;<span class="w"> </span><span class="o">{</span><span class="s2">&quot;changed&quot;</span>:<span class="w"> </span>false,<span class="w"> </span><span class="s2">&quot;msg&quot;</span>:<span class="w"> </span><span class="s2">&quot;No</span>
<a id="__codelineno-81-17" name="__codelineno-81-17"></a><span class="s2">package matching &#39;http&#39; found available, installed or updated&quot;</span>,
<a id="__codelineno-81-18" name="__codelineno-81-18"></a><span class="s2">&quot;rc&quot;</span>:<span class="w"> </span><span class="m">126</span>,<span class="w"> </span><span class="s2">&quot;results&quot;</span>:<span class="w"> </span><span class="o">[</span><span class="s2">&quot;No package matching &#39;http&#39; found</span>
<a id="__codelineno-81-19" name="__codelineno-81-19"></a><span class="s2">available, installed or updated&quot;</span><span class="o">]}</span>
<a id="__codelineno-81-20" name="__codelineno-81-20"></a>TASK<span class="w"> </span><span class="o">[</span>install<span class="w"> </span>dbpkg<span class="o">]</span>
<a id="__codelineno-81-21" name="__codelineno-81-21"></a>***************************************************************
<a id="__codelineno-81-22" name="__codelineno-81-22"></a>***************
<a id="__codelineno-81-23" name="__codelineno-81-23"></a>changed:<span class="w"> </span><span class="o">[</span>node1<span class="o">]</span>
<a id="__codelineno-81-24" name="__codelineno-81-24"></a>changed:<span class="w"> </span><span class="o">[</span>node2<span class="o">]</span>
<a id="__codelineno-81-25" name="__codelineno-81-25"></a>PLAY<span class="w"> </span>RECAP
<a id="__codelineno-81-26" name="__codelineno-81-26"></a>***************************************************************
<a id="__codelineno-81-27" name="__codelineno-81-27"></a>*****************************************************
<a id="__codelineno-81-28" name="__codelineno-81-28"></a>node1<span class="w"> </span>:<span class="w"> </span><span class="nv">ok</span><span class="o">=</span><span class="m">2</span><span class="w"> </span><span class="nv">changed</span><span class="o">=</span><span class="m">1</span><span class="w"> </span><span class="nv">unreachable</span><span class="o">=</span><span class="m">0</span>
<a id="__codelineno-81-29" name="__codelineno-81-29"></a><span class="nv">failed</span><span class="o">=</span><span class="m">0</span><span class="w"> </span><span class="nv">skipped</span><span class="o">=</span><span class="m">0</span><span class="w"> </span><span class="nv">rescued</span><span class="o">=</span><span class="m">1</span><span class="w"> </span><span class="nv">ignored</span><span class="o">=</span><span class="m">0</span><span class="w"> </span>
<a id="__codelineno-81-30" name="__codelineno-81-30"></a>node2<span class="w"> </span>:<span class="w"> </span><span class="nv">ok</span><span class="o">=</span><span class="m">2</span><span class="w"> </span><span class="nv">changed</span><span class="o">=</span><span class="m">1</span><span class="w"> </span><span class="nv">unreachable</span><span class="o">=</span><span class="m">0</span>
<a id="__codelineno-81-31" name="__codelineno-81-31"></a><span class="nv">failed</span><span class="o">=</span><span class="m">0</span><span class="w"> </span><span class="nv">skipped</span><span class="o">=</span><span class="m">0</span><span class="w"> </span><span class="nv">rescued</span><span class="o">=</span><span class="m">1</span><span class="w"> </span><span class="nv">ignored</span><span class="o">=</span><span class="m">0</span>
</code></pre></div></td></tr></table></div>
<p><strong><font style="color:rgb(0,0,0);">对</font></strong><strong><font style="color:rgb(0,0,0);">block</font></strong><strong><font style="color:rgb(0,0,0);">块进行判断</font></strong><strong><font style="color:rgb(0,0,0);"> (</font></strong><strong><font style="color:rgb(0,0,0);">需要完成内容集合部分的学习</font></strong><strong><font style="color:rgb(0,0,0);">) </font></strong></p>
<p><strong><font style="color:rgb(0,0,0);">需求：如果存在磁盘vdb,则在vdb上创建一个4GB分区，如果空间不够4GB，则创建1GB分区。</font></strong></p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-82-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-82-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-82-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-82-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-82-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-82-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-82-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-82-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-82-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-82-10">10</a></span>
<span class="normal"><a href="#__codelineno-82-11">11</a></span>
<span class="normal"><a href="#__codelineno-82-12">12</a></span>
<span class="normal"><a href="#__codelineno-82-13">13</a></span>
<span class="normal"><a href="#__codelineno-82-14">14</a></span>
<span class="normal"><a href="#__codelineno-82-15">15</a></span>
<span class="normal"><a href="#__codelineno-82-16">16</a></span>
<span class="normal"><a href="#__codelineno-82-17">17</a></span>
<span class="normal"><a href="#__codelineno-82-18">18</a></span>
<span class="normal"><a href="#__codelineno-82-19">19</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-82-1" name="__codelineno-82-1"></a>-<span class="w"> </span>hosts:<span class="w"> </span>all
<a id="__codelineno-82-2" name="__codelineno-82-2"></a><span class="w"> </span>tasks:
<a id="__codelineno-82-3" name="__codelineno-82-3"></a><span class="w"> </span>-<span class="w"> </span>block:
<a id="__codelineno-82-4" name="__codelineno-82-4"></a><span class="w"> </span>-<span class="w"> </span>name:<span class="w"> </span>create<span class="w"> </span>4GiB<span class="w"> </span>part
<a id="__codelineno-82-5" name="__codelineno-82-5"></a><span class="w"> </span>community.general.parted:
<a id="__codelineno-82-6" name="__codelineno-82-6"></a><span class="w"> </span>device:<span class="w"> </span>/dev/vdb
<a id="__codelineno-82-7" name="__codelineno-82-7"></a><span class="w"> </span>number:<span class="w"> </span><span class="m">2</span>
<a id="__codelineno-82-8" name="__codelineno-82-8"></a><span class="w"> </span>part_end:<span class="w"> </span>6GiB
<a id="__codelineno-82-9" name="__codelineno-82-9"></a><span class="w"> </span>part_start:<span class="w"> </span>2GiB
<a id="__codelineno-82-10" name="__codelineno-82-10"></a><span class="w"> </span>state:<span class="w"> </span>present
<a id="__codelineno-82-11" name="__codelineno-82-11"></a><span class="w"> </span>rescue:
<a id="__codelineno-82-12" name="__codelineno-82-12"></a><span class="w"> </span>-<span class="w"> </span>name:<span class="w"> </span>create<span class="w"> </span><span class="m">1</span><span class="w"> </span>GiB<span class="w"> </span>part
<a id="__codelineno-82-13" name="__codelineno-82-13"></a><span class="w"> </span>community.general.parted:
<a id="__codelineno-82-14" name="__codelineno-82-14"></a><span class="w"> </span>device:<span class="w"> </span>/dev/vdb
<a id="__codelineno-82-15" name="__codelineno-82-15"></a><span class="w"> </span>number:<span class="w"> </span><span class="m">2</span>
<a id="__codelineno-82-16" name="__codelineno-82-16"></a><span class="w"> </span>part_end:<span class="w"> </span>3GiB
<a id="__codelineno-82-17" name="__codelineno-82-17"></a><span class="w"> </span>part_start:<span class="w"> </span>2GiB
<a id="__codelineno-82-18" name="__codelineno-82-18"></a><span class="w"> </span>state:<span class="w"> </span>present
<a id="__codelineno-82-19" name="__codelineno-82-19"></a><span class="w"> </span>when:<span class="w"> </span>ansible_devices.vdb<span class="w"> </span>is<span class="w"> </span>defined
</code></pre></div></td></tr></table></div>
<p><strong><font style="color:rgb(0,0,0);">执行结果</font></strong></p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-83-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-83-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-83-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-83-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-83-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-83-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-83-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-83-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-83-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-83-10">10</a></span>
<span class="normal"><a href="#__codelineno-83-11">11</a></span>
<span class="normal"><a href="#__codelineno-83-12">12</a></span>
<span class="normal"><a href="#__codelineno-83-13">13</a></span>
<span class="normal"><a href="#__codelineno-83-14">14</a></span>
<span class="normal"><a href="#__codelineno-83-15">15</a></span>
<span class="normal"><a href="#__codelineno-83-16">16</a></span>
<span class="normal"><a href="#__codelineno-83-17">17</a></span>
<span class="normal"><a href="#__codelineno-83-18">18</a></span>
<span class="normal"><a href="#__codelineno-83-19">19</a></span>
<span class="normal"><a href="#__codelineno-83-20">20</a></span>
<span class="normal"><a href="#__codelineno-83-21">21</a></span>
<span class="normal"><a href="#__codelineno-83-22">22</a></span>
<span class="normal"><a href="#__codelineno-83-23">23</a></span>
<span class="normal"><a href="#__codelineno-83-24">24</a></span>
<span class="normal"><a href="#__codelineno-83-25">25</a></span>
<span class="normal"><a href="#__codelineno-83-26">26</a></span>
<span class="normal"><a href="#__codelineno-83-27">27</a></span>
<span class="normal"><a href="#__codelineno-83-28">28</a></span>
<span class="normal"><a href="#__codelineno-83-29">29</a></span>
<span class="normal"><a href="#__codelineno-83-30">30</a></span>
<span class="normal"><a href="#__codelineno-83-31">31</a></span>
<span class="normal"><a href="#__codelineno-83-32">32</a></span>
<span class="normal"><a href="#__codelineno-83-33">33</a></span>
<span class="normal"><a href="#__codelineno-83-34">34</a></span>
<span class="normal"><a href="#__codelineno-83-35">35</a></span>
<span class="normal"><a href="#__codelineno-83-36">36</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-83-1" name="__codelineno-83-1"></a>PLAY<span class="w"> </span><span class="o">[</span>all<span class="o">]</span>
<a id="__codelineno-83-2" name="__codelineno-83-2"></a>***************************************************************
<a id="__codelineno-83-3" name="__codelineno-83-3"></a>*****************************************************
<a id="__codelineno-83-4" name="__codelineno-83-4"></a>TASK<span class="w"> </span><span class="o">[</span>Gathering<span class="w"> </span>Facts<span class="o">]</span>
<a id="__codelineno-83-5" name="__codelineno-83-5"></a>***************************************************************
<a id="__codelineno-83-6" name="__codelineno-83-6"></a>*****************************************
<a id="__codelineno-83-7" name="__codelineno-83-7"></a>ok:<span class="w"> </span><span class="o">[</span>node4<span class="o">]</span>
<a id="__codelineno-83-8" name="__codelineno-83-8"></a>ok:<span class="w"> </span><span class="o">[</span>node2<span class="o">]</span>
<a id="__codelineno-83-9" name="__codelineno-83-9"></a>ok:<span class="w"> </span><span class="o">[</span>node3<span class="o">]</span>
<a id="__codelineno-83-10" name="__codelineno-83-10"></a>ok:<span class="w"> </span><span class="o">[</span>node1<span class="o">]</span>
<a id="__codelineno-83-11" name="__codelineno-83-11"></a>TASK<span class="w"> </span><span class="o">[</span>create<span class="w"> </span>4GiB<span class="w"> </span>part<span class="o">]</span>
<a id="__codelineno-83-12" name="__codelineno-83-12"></a>***************************************************************
<a id="__codelineno-83-13" name="__codelineno-83-13"></a>****************************************
<a id="__codelineno-83-14" name="__codelineno-83-14"></a>skipping:<span class="w"> </span><span class="o">[</span>node1<span class="o">]</span>
<a id="__codelineno-83-15" name="__codelineno-83-15"></a>skipping:<span class="w"> </span><span class="o">[</span>node2<span class="o">]</span>
<a id="__codelineno-83-16" name="__codelineno-83-16"></a>fatal:<span class="w"> </span><span class="o">[</span>node3<span class="o">]</span>:<span class="w"> </span>FAILED!<span class="w"> </span><span class="o">=</span>&gt;<span class="w"> </span><span class="o">{</span><span class="s2">&quot;changed&quot;</span>:<span class="w"> </span>false,<span class="w"> </span><span class="s2">&quot;err&quot;</span>:<span class="w"> </span><span class="s2">&quot;Error:</span>
<a id="__codelineno-83-17" name="__codelineno-83-17"></a><span class="s2">The location 6GiB is outside of the device /dev/vdb.\n&quot;</span>,<span class="w"> </span><span class="s2">&quot;msg&quot;</span>:
<a id="__codelineno-83-18" name="__codelineno-83-18"></a><span class="s2">&quot;Error while running parted script: /usr/sbin/parted -s -m -a</span>
<a id="__codelineno-83-19" name="__codelineno-83-19"></a><span class="s2">optimal /dev/vdb -- unit KiB mkpart primary 2GiB 6GiB&quot;</span>,<span class="w"> </span><span class="s2">&quot;out&quot;</span>:
<a id="__codelineno-83-20" name="__codelineno-83-20"></a><span class="s2">&quot;&quot;</span>,<span class="w"> </span><span class="s2">&quot;rc&quot;</span>:<span class="w"> </span><span class="m">1</span><span class="o">}</span>
<a id="__codelineno-83-21" name="__codelineno-83-21"></a>changed:<span class="w"> </span><span class="o">[</span>node4<span class="o">]</span>
<a id="__codelineno-83-22" name="__codelineno-83-22"></a>TASK<span class="w"> </span><span class="o">[</span>create<span class="w"> </span><span class="m">1</span><span class="w"> </span>GiB<span class="w"> </span>part<span class="o">]</span>
<a id="__codelineno-83-23" name="__codelineno-83-23"></a>***************************************************************
<a id="__codelineno-83-24" name="__codelineno-83-24"></a>***************************************
<a id="__codelineno-83-25" name="__codelineno-83-25"></a>changed:<span class="w"> </span><span class="o">[</span>node3<span class="o">]</span>
<a id="__codelineno-83-26" name="__codelineno-83-26"></a>PLAY<span class="w"> </span>RECAP
<a id="__codelineno-83-27" name="__codelineno-83-27"></a>***************************************************************
<a id="__codelineno-83-28" name="__codelineno-83-28"></a>*****************************************************
<a id="__codelineno-83-29" name="__codelineno-83-29"></a>node1<span class="w"> </span>:<span class="w"> </span><span class="nv">ok</span><span class="o">=</span><span class="m">1</span><span class="w"> </span><span class="nv">changed</span><span class="o">=</span><span class="m">0</span><span class="w"> </span><span class="nv">unreachable</span><span class="o">=</span><span class="m">0</span>
<a id="__codelineno-83-30" name="__codelineno-83-30"></a><span class="nv">failed</span><span class="o">=</span><span class="m">0</span><span class="w"> </span><span class="nv">skipped</span><span class="o">=</span><span class="m">1</span><span class="w"> </span><span class="nv">rescued</span><span class="o">=</span><span class="m">0</span><span class="w"> </span><span class="nv">ignored</span><span class="o">=</span><span class="m">0</span><span class="w"> </span>
<a id="__codelineno-83-31" name="__codelineno-83-31"></a>node2<span class="w"> </span>:<span class="w"> </span><span class="nv">ok</span><span class="o">=</span><span class="m">1</span><span class="w"> </span><span class="nv">changed</span><span class="o">=</span><span class="m">0</span><span class="w"> </span><span class="nv">unreachable</span><span class="o">=</span><span class="m">0</span>
<a id="__codelineno-83-32" name="__codelineno-83-32"></a><span class="nv">failed</span><span class="o">=</span><span class="m">0</span><span class="w"> </span><span class="nv">skipped</span><span class="o">=</span><span class="m">1</span><span class="w"> </span><span class="nv">rescued</span><span class="o">=</span><span class="m">0</span><span class="w"> </span><span class="nv">ignored</span><span class="o">=</span><span class="m">0</span><span class="w"> </span>
<a id="__codelineno-83-33" name="__codelineno-83-33"></a>node3<span class="w"> </span>:<span class="w"> </span><span class="nv">ok</span><span class="o">=</span><span class="m">2</span><span class="w"> </span><span class="nv">changed</span><span class="o">=</span><span class="m">1</span><span class="w"> </span><span class="nv">unreachable</span><span class="o">=</span><span class="m">0</span>
<a id="__codelineno-83-34" name="__codelineno-83-34"></a><span class="nv">failed</span><span class="o">=</span><span class="m">0</span><span class="w"> </span><span class="nv">skipped</span><span class="o">=</span><span class="m">0</span><span class="w"> </span><span class="nv">rescued</span><span class="o">=</span><span class="m">1</span><span class="w"> </span><span class="nv">ignored</span><span class="o">=</span><span class="m">0</span><span class="w"> </span>
<a id="__codelineno-83-35" name="__codelineno-83-35"></a>node4<span class="w"> </span>:<span class="w"> </span><span class="nv">ok</span><span class="o">=</span><span class="m">2</span><span class="w"> </span><span class="nv">changed</span><span class="o">=</span><span class="m">1</span><span class="w"> </span><span class="nv">unreachable</span><span class="o">=</span><span class="m">0</span>
<a id="__codelineno-83-36" name="__codelineno-83-36"></a><span class="nv">failed</span><span class="o">=</span><span class="m">0</span><span class="w"> </span><span class="nv">skipped</span><span class="o">=</span><span class="m">0</span><span class="w"> </span><span class="nv">rescued</span><span class="o">=</span><span class="m">0</span><span class="w"> </span><span class="nv">ignored</span><span class="o">=</span><span class="m">0</span>
</code></pre></div></td></tr></table></div>
<h1 id="roles结构"><strong><font style="color:rgb(0,0,0);">roles结构</font></strong><a class="headerlink" href="#roles结构" title="Permanent link">&para;</a></h1>
<p><font style="color:rgb(0,0,0);">roles </font><font style="color:rgb(0,0,0);">其实就是</font><font style="color:rgb(223,64,42);">变量</font><font style="color:rgb(0,0,0);">文件、</font><font style="color:rgb(223,64,42);">模板</font><font style="color:rgb(0,0,0);">文件、</font><font style="color:rgb(223,64,42);">handlers</font><font style="color:rgb(0,0,0);">文件、</font><font style="color:rgb(223,64,42);">tasks</font><font style="color:rgb(0,0,0);">文件的一 </font></p>
<p><font style="color:rgb(0,0,0);">个集合，我们将各个文件放在</font><font style="color:rgb(0,0,0);">roles</font><font style="color:rgb(0,0,0);">的指定目录下，使用一个主</font><font style="color:rgb(0,0,0);">playbook</font><font style="color:rgb(0,0,0);">来调 </font></p>
<p><font style="color:rgb(0,0,0);">用这些文件，这样可以使得整个</font><font style="color:rgb(0,0,0);">playbook</font><font style="color:rgb(0,0,0);">具有</font><font style="color:rgb(223,64,42);">可移植性和重复性</font><font style="color:rgb(0,0,0);">。 </font></p>
<p><font style="color:rgb(0,0,0);">roles 有一个标准的目录结构：</font></p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-84-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-84-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-84-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-84-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-84-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-84-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-84-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-84-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-84-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-84-10">10</a></span>
<span class="normal"><a href="#__codelineno-84-11">11</a></span>
<span class="normal"><a href="#__codelineno-84-12">12</a></span>
<span class="normal"><a href="#__codelineno-84-13">13</a></span>
<span class="normal"><a href="#__codelineno-84-14">14</a></span>
<span class="normal"><a href="#__codelineno-84-15">15</a></span>
<span class="normal"><a href="#__codelineno-84-16">16</a></span>
<span class="normal"><a href="#__codelineno-84-17">17</a></span>
<span class="normal"><a href="#__codelineno-84-18">18</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-84-1" name="__codelineno-84-1"></a><span class="o">[</span>root@workstation<span class="w"> </span>ansible<span class="o">]</span><span class="c1"># tree lamp</span>
<a id="__codelineno-84-2" name="__codelineno-84-2"></a>lamp
<a id="__codelineno-84-3" name="__codelineno-84-3"></a>├──<span class="w"> </span>defaults
<a id="__codelineno-84-4" name="__codelineno-84-4"></a>│<span class="w"> </span>└──<span class="w"> </span>main.yml
<a id="__codelineno-84-5" name="__codelineno-84-5"></a>├──<span class="w"> </span>files
<a id="__codelineno-84-6" name="__codelineno-84-6"></a>├──<span class="w"> </span>handlers
<a id="__codelineno-84-7" name="__codelineno-84-7"></a>│<span class="w"> </span>└──<span class="w"> </span>main.yml
<a id="__codelineno-84-8" name="__codelineno-84-8"></a>├──<span class="w"> </span>meta
<a id="__codelineno-84-9" name="__codelineno-84-9"></a>│<span class="w"> </span>└──<span class="w"> </span>main.yml
<a id="__codelineno-84-10" name="__codelineno-84-10"></a>├──<span class="w"> </span>README.md
<a id="__codelineno-84-11" name="__codelineno-84-11"></a>├──<span class="w"> </span>tasks
<a id="__codelineno-84-12" name="__codelineno-84-12"></a>│<span class="w"> </span>└──<span class="w"> </span>main.yml
<a id="__codelineno-84-13" name="__codelineno-84-13"></a>├──<span class="w"> </span>templates
<a id="__codelineno-84-14" name="__codelineno-84-14"></a>├──<span class="w"> </span>tests
<a id="__codelineno-84-15" name="__codelineno-84-15"></a>│<span class="w"> </span>├──<span class="w"> </span>inventory
<a id="__codelineno-84-16" name="__codelineno-84-16"></a>│<span class="w"> </span>└──<span class="w"> </span>test.yml
<a id="__codelineno-84-17" name="__codelineno-84-17"></a>└──<span class="w"> </span>vars
<a id="__codelineno-84-18" name="__codelineno-84-18"></a>└──<span class="w"> </span>main.yml
</code></pre></div></td></tr></table></div>
<p><font style="color:rgb(0,0,0);">各个目录文件的作用： </font></p>
<p><strong><font style="color:rgb(0,0,0);">defaults/main.yml</font></strong><font style="color:rgb(0,0,0);">: </font><font style="color:rgb(0,0,0);">用于存放</font><font style="color:rgb(0,0,0);">roles</font><font style="color:rgb(0,0,0);">中的默认变量，此文件中的变量</font><font style="color:rgb(223,64,42);">优先 </font></p>
<p><font style="color:rgb(223,64,42);">级最低 </font></p>
<p><strong><font style="color:rgb(0,0,0);">files: </font></strong><font style="color:rgb(0,0,0);">用于存放需要拷贝的文件 </font></p>
<p><strong><font style="color:rgb(0,0,0);">handlers/mail.yml: </font></strong><font style="color:rgb(0,0,0);">用于存放</font><font style="color:rgb(0,0,0);">handler</font><font style="color:rgb(0,0,0);">任务，当</font><font style="color:rgb(0,0,0);">roles</font><font style="color:rgb(0,0,0);">中需要调用 </font></p>
<p><font style="color:rgb(0,0,0);">handler</font><font style="color:rgb(0,0,0);">时就会在此文件中查找相应的</font><font style="color:rgb(0,0,0);">handler</font><font style="color:rgb(0,0,0);">（触发）</font><font style="color:rgb(0,0,0);">. </font></p>
<p><strong><font style="color:rgb(0,0,0);">meta/main.yml: </font></strong><font style="color:rgb(0,0,0);">用于存放</font><font style="color:rgb(0,0,0);">roles</font><font style="color:rgb(0,0,0);">的元数据，如作者、角色的作用描述以及</font><font style="color:rgb(223,64,42);">角 </font></p>
<p><font style="color:rgb(223,64,42);">色的依赖关系</font><font style="color:rgb(0,0,0);">. </font></p>
<p><strong><font style="color:rgb(0,0,0);">tasks/main.yml: </font></strong><font style="color:rgb(0,0,0);">用于存放角色需要执行的主要任务，也可以在</font><font style="color:rgb(0,0,0);">main.yml </font></p>
<p><font style="color:rgb(0,0,0);">中导入其他的task­­­­incloud，import.</font></p>
<p><strong><font style="color:rgb(223,64,42);">templetes</font></strong><strong><font style="color:rgb(0,0,0);">: </font></strong><font style="color:rgb(0,0,0);">用于存放</font><font style="color:rgb(0,0,0);">jinja2</font><font style="color:rgb(0,0,0);">模板文件，文件以</font><font style="color:rgb(0,0,0);">".j2"</font><font style="color:rgb(0,0,0);">作为后缀的文件</font><font style="color:rgb(0,0,0);">. </font></p>
<p><strong><font style="color:rgb(0,0,0);">tests: </font></strong><font style="color:rgb(0,0,0);">用于存放测试</font><font style="color:rgb(0,0,0);">role</font><font style="color:rgb(0,0,0);">自身的</font><font style="color:rgb(0,0,0);">playbook</font><font style="color:rgb(0,0,0);">和主机列表文件</font><font style="color:rgb(0,0,0);">. </font></p>
<p><strong><font style="color:rgb(0,0,0);">vars/main.yml: </font></strong><font style="color:rgb(0,0,0);">用于存放roles中所用到的变量，</font><font style="color:rgb(223,64,42);">优先级很高.</font></p>
<p><strong><font style="color:rgb(0,0,0);">创建</font></strong><strong><font style="color:rgb(0,0,0);">roles </font></strong></p>
<p><font style="color:rgb(0,0,0);">1. </font><font style="color:rgb(0,0,0);">可以手动创建</font><font style="color:rgb(0,0,0);">roles</font><font style="color:rgb(0,0,0);">相关的目录和文件 </font></p>
<p><font style="color:rgb(0,0,0);">2. </font><font style="color:rgb(0,0,0);">可以使用</font><font style="color:rgb(0,0,0);">ansible­galaxy </font><font style="color:rgb(0,0,0);">来创建</font><font style="color:rgb(0,0,0);">roles </font></p>
<p><font style="color:rgb(0,0,0);">使用</font><strong><font style="color:rgb(0,0,0);">ansible­galaxy init roles_NAME</font></strong><font style="color:rgb(0,0,0);">来自动初始化一个角色</font></p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-85-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-85-1" name="__codelineno-85-1"></a><span class="o">[</span>root@workstation<span class="w"> </span>ansible<span class="o">]</span><span class="c1"># ansible­galaxy init lamp</span>
</code></pre></div></td></tr></table></div>
<p><strong><font style="color:rgb(0,0,0);">roles</font></strong><strong><font style="color:rgb(0,0,0);">的引用和执行 </font></strong></p>
<p><strong><font style="color:rgb(0,0,0);">在</font></strong><strong><font style="color:rgb(0,0,0);">playbook</font></strong><strong><font style="color:rgb(0,0,0);">中使用</font></strong><strong><font style="color:rgb(0,0,0);">roles </font></strong></p>
<p><font style="color:rgb(0,0,0);">在playbook中使用roles关键词来引入roles</font></p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-86-1">1</a></span>
<span class="normal"><a href="#__codelineno-86-2">2</a></span>
<span class="normal"><a href="#__codelineno-86-3">3</a></span>
<span class="normal"><a href="#__codelineno-86-4">4</a></span>
<span class="normal"><a href="#__codelineno-86-5">5</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-86-1" name="__codelineno-86-1"></a>---
<a id="__codelineno-86-2" name="__codelineno-86-2"></a>-<span class="w"> </span>name:<span class="w"> </span><span class="nb">test</span>
<a id="__codelineno-86-3" name="__codelineno-86-3"></a>hosts:<span class="w"> </span>all
<a id="__codelineno-86-4" name="__codelineno-86-4"></a>roles:
<a id="__codelineno-86-5" name="__codelineno-86-5"></a>-<span class="w"> </span>apache
</code></pre></div></td></tr></table></div>
<p><font style="color:rgb(0,0,0);">或者是</font></p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-87-1">1</a></span>
<span class="normal"><a href="#__codelineno-87-2">2</a></span>
<span class="normal"><a href="#__codelineno-87-3">3</a></span>
<span class="normal"><a href="#__codelineno-87-4">4</a></span>
<span class="normal"><a href="#__codelineno-87-5">5</a></span>
<span class="normal"><a href="#__codelineno-87-6">6</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-87-1" name="__codelineno-87-1"></a>---
<a id="__codelineno-87-2" name="__codelineno-87-2"></a>-<span class="w"> </span>name:<span class="w"> </span><span class="nb">test</span>
<a id="__codelineno-87-3" name="__codelineno-87-3"></a>hosts:<span class="w"> </span>all
<a id="__codelineno-87-4" name="__codelineno-87-4"></a>roles:
<a id="__codelineno-87-5" name="__codelineno-87-5"></a>-<span class="w"> </span>role:<span class="w"> </span>roleB
<a id="__codelineno-87-6" name="__codelineno-87-6"></a>-<span class="w"> </span>role:<span class="w"> </span>/root/roleC
</code></pre></div></td></tr></table></div>
<p><font style="color:rgb(0,0,0);">playbook</font><font style="color:rgb(0,0,0);">在加载</font><font style="color:rgb(0,0,0);">roles</font><font style="color:rgb(0,0,0);">时按以下路径先后顺寻进行搜索 </font></p>
<p><font style="color:rgb(0,0,0);">1. playbook</font><font style="color:rgb(0,0,0);">运行的当前目录 </font></p>
<p><font style="color:rgb(0,0,0);">2. playbook</font><font style="color:rgb(0,0,0);">运行目录下的</font><font style="color:rgb(0,0,0);">roles</font><font style="color:rgb(0,0,0);">目录 </font></p>
<p><font style="color:rgb(0,0,0);">3. </font><font style="color:rgb(0,0,0);">当前用户家目录下的</font><font style="color:rgb(0,0,0);">.ansible/roles</font><font style="color:rgb(0,0,0);">目录 </font></p>
<p><font style="color:rgb(0,0,0);">4. </font><font style="color:rgb(0,0,0);">系统</font><font style="color:rgb(0,0,0);">roles</font><font style="color:rgb(0,0,0);">路径</font><font style="color:rgb(0,0,0);">/usr/share/ansible/roles </font></p>
<p><font style="color:rgb(0,0,0);">5.ansible.cfg中定义的roles_path路径，默认是/etc/ansible/roles</font></p>
<p><strong><font style="color:rgb(0,0,0);">在</font></strong><strong><font style="color:rgb(0,0,0);">tasks</font></strong><strong><font style="color:rgb(0,0,0);">中使用</font></strong><strong><font style="color:rgb(0,0,0);">roles </font></strong></p>
<p><font style="color:rgb(0,0,0);">在tasks中使用include_role或import_role来引入roles</font></p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-88-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-88-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-88-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-88-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-88-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-88-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-88-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-88-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-88-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-88-10">10</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-88-1" name="__codelineno-88-1"></a>---
<a id="__codelineno-88-2" name="__codelineno-88-2"></a>-<span class="w"> </span>name:<span class="w"> </span><span class="nb">test</span>
<a id="__codelineno-88-3" name="__codelineno-88-3"></a>hosts:<span class="w"> </span>all
<a id="__codelineno-88-4" name="__codelineno-88-4"></a>tasks:
<a id="__codelineno-88-5" name="__codelineno-88-5"></a>-<span class="w"> </span>name:<span class="w"> </span><span class="nb">test</span><span class="w"> </span>task1
<a id="__codelineno-88-6" name="__codelineno-88-6"></a>debug:
<a id="__codelineno-88-7" name="__codelineno-88-7"></a>msg:<span class="w"> </span><span class="s1">&#39;test task1&#39;</span>
<a id="__codelineno-88-8" name="__codelineno-88-8"></a>-<span class="w"> </span>name:<span class="w"> </span>import<span class="w"> </span>role
<a id="__codelineno-88-9" name="__codelineno-88-9"></a>include_role:
<a id="__codelineno-88-10" name="__codelineno-88-10"></a>name:<span class="w"> </span>roleC
</code></pre></div></td></tr></table></div>
<p><strong><font style="color:rgb(0,0,0);">playbook</font></strong><strong><font style="color:rgb(0,0,0);">执行顺序 </font></strong></p>
<p><font style="color:rgb(0,0,0);">在默认情况下，</font><font style="color:rgb(0,0,0);">playbook</font><font style="color:rgb(0,0,0);">会按先后顺序执行</font><font style="color:rgb(0,0,0);">tasks,</font><font style="color:rgb(0,0,0);">但是如果在</font><font style="color:rgb(0,0,0);">playbook</font><font style="color:rgb(0,0,0);">中 </font></p>
<p><font style="color:rgb(0,0,0);">使用了</font><font style="color:rgb(223,64,42);">roles</font><font style="color:rgb(0,0,0);">，则会优先执行roles部分，再执行</font><font style="color:rgb(223,64,42);">tasks</font><font style="color:rgb(0,0,0);">.</font></p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-89-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-89-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-89-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-89-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-89-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-89-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-89-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-89-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-89-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-89-10">10</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-89-1" name="__codelineno-89-1"></a>---
<a id="__codelineno-89-2" name="__codelineno-89-2"></a>-<span class="w"> </span>name:<span class="w"> </span><span class="nb">test</span>
<a id="__codelineno-89-3" name="__codelineno-89-3"></a>hosts:<span class="w"> </span>servera
<a id="__codelineno-89-4" name="__codelineno-89-4"></a>gather_facts:<span class="w"> </span>no
<a id="__codelineno-89-5" name="__codelineno-89-5"></a>tasks:
<a id="__codelineno-89-6" name="__codelineno-89-6"></a>-<span class="w"> </span>name:<span class="w"> </span><span class="nb">test</span><span class="w"> </span>task1
<a id="__codelineno-89-7" name="__codelineno-89-7"></a>debug:
<a id="__codelineno-89-8" name="__codelineno-89-8"></a>msg:<span class="w"> </span><span class="s1">&#39;test task1&#39;</span>
<a id="__codelineno-89-9" name="__codelineno-89-9"></a>roles:
<a id="__codelineno-89-10" name="__codelineno-89-10"></a>-<span class="w"> </span>role:<span class="w"> </span>roleC
</code></pre></div></td></tr></table></div>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-90-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-90-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-90-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-90-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-90-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-90-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-90-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-90-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-90-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-90-10">10</a></span>
<span class="normal"><a href="#__codelineno-90-11">11</a></span>
<span class="normal"><a href="#__codelineno-90-12">12</a></span>
<span class="normal"><a href="#__codelineno-90-13">13</a></span>
<span class="normal"><a href="#__codelineno-90-14">14</a></span>
<span class="normal"><a href="#__codelineno-90-15">15</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-90-1" name="__codelineno-90-1"></a>PLAY<span class="w"> </span><span class="o">[</span>test<span class="o">]</span>
<a id="__codelineno-90-2" name="__codelineno-90-2"></a>****************************************************************
<a id="__codelineno-90-3" name="__codelineno-90-3"></a>************************************
<a id="__codelineno-90-4" name="__codelineno-90-4"></a>TASK<span class="w"> </span><span class="o">[</span>roleC<span class="w"> </span>:<span class="w"> </span>debug<span class="o">]</span>
<a id="__codelineno-90-5" name="__codelineno-90-5"></a>****************************************************************
<a id="__codelineno-90-6" name="__codelineno-90-6"></a>***************************
<a id="__codelineno-90-7" name="__codelineno-90-7"></a>ok:<span class="w"> </span><span class="o">[</span>servera<span class="o">]</span><span class="w"> </span><span class="o">=</span>&gt;<span class="w"> </span><span class="o">{</span>
<a id="__codelineno-90-8" name="__codelineno-90-8"></a><span class="s2">&quot;msg&quot;</span>:<span class="w"> </span><span class="s2">&quot;Hello world&quot;</span>
<a id="__codelineno-90-9" name="__codelineno-90-9"></a><span class="o">}</span>
<a id="__codelineno-90-10" name="__codelineno-90-10"></a>TASK<span class="w"> </span><span class="o">[</span><span class="nb">test</span><span class="w"> </span>task1<span class="o">]</span>
<a id="__codelineno-90-11" name="__codelineno-90-11"></a>****************************************************************
<a id="__codelineno-90-12" name="__codelineno-90-12"></a>*****************************
<a id="__codelineno-90-13" name="__codelineno-90-13"></a>ok:<span class="w"> </span><span class="o">[</span>servera<span class="o">]</span><span class="w"> </span><span class="o">=</span>&gt;<span class="w"> </span><span class="o">{</span>
<a id="__codelineno-90-14" name="__codelineno-90-14"></a><span class="s2">&quot;msg&quot;</span>:<span class="w"> </span><span class="s2">&quot;test task1&quot;</span>
<a id="__codelineno-90-15" name="__codelineno-90-15"></a><span class="o">}</span>
</code></pre></div></td></tr></table></div>
<p><font style="color:rgb(0,0,0);">可以看到，虽然把</font><font style="color:rgb(0,0,0);">tasks</font><font style="color:rgb(0,0,0);">定义在</font><font style="color:rgb(0,0,0);">roles</font><font style="color:rgb(0,0,0);">的前面，但是执行的时候是先执行的 </font></p>
<p><font style="color:rgb(223,64,42);">roles</font><font style="color:rgb(0,0,0);">。想要规范</font><font style="color:rgb(0,0,0);">tasks</font><font style="color:rgb(0,0,0);">和</font><font style="color:rgb(0,0,0);">roles</font><font style="color:rgb(0,0,0);">的执行顺序，可以使用</font><strong><font style="color:rgb(0,0,0);">pre_tasks</font></strong><font style="color:rgb(0,0,0);">和 </font></p>
<p><strong><font style="color:rgb(0,0,0);">post_tasks</font></strong><strong><font style="color:rgb(0,0,0);">。 </font></strong></p>
<p><font style="color:rgb(0,0,0);">pre_tasks: </font><font style="color:rgb(0,0,0);">最优先被执行 </font></p>
<p><font style="color:rgb(0,0,0);">post_tasks: </font><font style="color:rgb(0,0,0);">最后被执行 </font></p>
<p><strong><font style="color:rgb(0,0,0);">playbook</font></strong><strong><font style="color:rgb(0,0,0);">的任务执行顺序： </font></strong></p>
<p><font style="color:rgb(0,0,0);">1. pre_tasks</font><font style="color:rgb(0,0,0);">中定义的任务 </font></p>
<p><font style="color:rgb(0,0,0);">2. roles</font><font style="color:rgb(0,0,0);">中任务 </font></p>
<p><font style="color:rgb(0,0,0);">3. tasks</font><font style="color:rgb(0,0,0);">中的任务 </font></p>
<p><font style="color:rgb(0,0,0);">4. post_tasks</font><font style="color:rgb(0,0,0);">中的任务 </font></p>
<p><strong><font style="color:rgb(0,0,0);">roles</font></strong><strong><font style="color:rgb(0,0,0);">的依赖 </font></strong></p>
<p><font style="color:rgb(0,0,0);">当一个</font><font style="color:rgb(0,0,0);">roles</font><font style="color:rgb(0,0,0);">在运行时需要依赖另一个</font><font style="color:rgb(0,0,0);">rolers</font><font style="color:rgb(0,0,0);">时候，就需要在</font><font style="color:rgb(0,0,0);">roles</font><font style="color:rgb(0,0,0);">的 </font></p>
<p><font style="color:rgb(0,0,0);">meta/main.yml</font><font style="color:rgb(0,0,0);">中定义好依赖关系。 </font></p>
<p><font style="color:rgb(0,0,0);">在meta/main.yml中使用dependencies关键词来定义所依赖的roles</font></p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-91-1">1</a></span>
<span class="normal"><a href="#__codelineno-91-2">2</a></span>
<span class="normal"><a href="#__codelineno-91-3">3</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-91-1" name="__codelineno-91-1"></a>dependencies:
<a id="__codelineno-91-2" name="__codelineno-91-2"></a>-<span class="w"> </span>roleB
<a id="__codelineno-91-3" name="__codelineno-91-3"></a>-<span class="w"> </span>roleC
</code></pre></div></td></tr></table></div>
<p><strong><font style="color:rgb(0,0,0);">在使用</font></strong><strong><font style="color:rgb(0,0,0);">roles</font></strong><strong><font style="color:rgb(0,0,0);">依赖时注意： </font></strong></p>
<p><font style="color:rgb(0,0,0);">1. </font><font style="color:rgb(0,0,0);">如果</font><font style="color:rgb(0,0,0);">roleA</font><font style="color:rgb(0,0,0);">依赖</font><font style="color:rgb(0,0,0);">roleB,</font><font style="color:rgb(0,0,0);">必须是在</font><font style="color:rgb(0,0,0);">roleA</font><font style="color:rgb(0,0,0);">的</font><font style="color:rgb(0,0,0);">meta/main.yml</font><font style="color:rgb(0,0,0);">中配置依赖 </font></p>
<p><font style="color:rgb(0,0,0);">2. </font><font style="color:rgb(0,0,0);">在</font><font style="color:rgb(0,0,0);">meta/main.yml</font><font style="color:rgb(0,0,0);">中使用</font><font style="color:rgb(0,0,0);">dependencies</font><font style="color:rgb(0,0,0);">来引入被依赖的</font><font style="color:rgb(0,0,0);">role </font></p>
<p><font style="color:rgb(0,0,0);">3. </font><font style="color:rgb(0,0,0);">可以以列表方式引入多个</font><font style="color:rgb(0,0,0);">role </font></p>
<p><font style="color:rgb(0,0,0);">4. </font><font style="color:rgb(0,0,0);">被引入的</font><font style="color:rgb(0,0,0);">role</font><font style="color:rgb(0,0,0);">会优先执行 </font></p>
<p><strong><font style="color:rgb(0,0,0);">使用</font></strong><strong><font style="color:rgb(0,0,0);">ansible galaxy </font></strong><strong><font style="color:rgb(0,0,0);">部署角色 </font></strong></p>
<p><font style="color:rgb(0,0,0);">ansible galaxy </font><font style="color:rgb(0,0,0);">是</font><font style="color:rgb(0,0,0);">ansible</font><font style="color:rgb(0,0,0);">的社区中心，用于共享</font><font style="color:rgb(0,0,0);">ansible </font><font style="color:rgb(0,0,0);">角色，我 </font></p>
<p><font style="color:rgb(0,0,0);">们可以使用</font><font style="color:rgb(0,0,0);">ansible­galaxy</font><font style="color:rgb(0,0,0);">来下载别人共享的角色。默认是从 </font></p>
<p><font style="color:rgb(0,56,132);">galaxy.ansible.com </font><font style="color:rgb(0,0,0);">下载。 </font></p>
<p><strong><font style="color:rgb(0,0,0);">ansible­galaxy</font></strong><strong><font style="color:rgb(0,0,0);">使用 </font></strong></p>
<p><font style="color:rgb(0,0,0);">1.搜索角色</font></p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-92-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-92-1" name="__codelineno-92-1"></a><span class="c1"># ansible-galaxy search &#39;roels_name&#39;</span>
</code></pre></div></td></tr></table></div>
<p><font style="color:rgb(0,0,0);">2. </font><font style="color:rgb(0,0,0);">获取角色信息 </font></p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-93-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-93-1" name="__codelineno-93-1"></a><span class="c1"># ansible­-galaxy info roels_name </span>
</code></pre></div></td></tr></table></div>
<p><font style="color:rgb(0,0,0);">3. </font><font style="color:rgb(0,0,0);">安装角色 </font></p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-94-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-94-1" name="__codelineno-94-1"></a><span class="c1"># ansible­-galaxy install roels_name ­p roles/ </span>
</code></pre></div></td></tr></table></div>
<p><font style="color:rgb(0,0,0);">­p </font><font style="color:rgb(0,0,0);">指定安装路径 </font></p>
<p><font style="color:rgb(0,0,0);">4. </font><font style="color:rgb(0,0,0);">从指定文件中安装角色 </font></p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-95-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-95-1" name="__codelineno-95-1"></a><span class="c1"># ansible­galaxy install roels_name ­p roles/ ­r require.yml</span>
</code></pre></div></td></tr></table></div>
<p><font style="color:rgb(0,0,0);">把安装请求信息写入到yml文件中，可以指定请求的位置、角色版本、请求 </font></p>
<p><font style="color:rgb(0,0,0);">方法等信息。 </font></p>
<p><font style="color:rgb(0,0,0);">require.yml </font><font style="color:rgb(0,0,0);">文件内容 </font></p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-96-1">1</a></span>
<span class="normal"><a href="#__codelineno-96-2">2</a></span>
<span class="normal"><a href="#__codelineno-96-3">3</a></span>
<span class="normal"><a href="#__codelineno-96-4">4</a></span>
<span class="normal"><a href="#__codelineno-96-5">5</a></span>
<span class="normal"><a href="#__codelineno-96-6">6</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-96-1" name="__codelineno-96-1"></a>-<span class="w"> </span>src:<span class="w"> </span>git@workstation.lab.example.com:student/bash_env<span class="w"> </span>
<a id="__codelineno-96-2" name="__codelineno-96-2"></a>scm:<span class="w"> </span>git<span class="w"> </span>
<a id="__codelineno-96-3" name="__codelineno-96-3"></a>version:<span class="w"> </span>master<span class="w"> </span>
<a id="__codelineno-96-4" name="__codelineno-96-4"></a>name:<span class="w"> </span>student.bash_env<span class="w"> </span>
<a id="__codelineno-96-5" name="__codelineno-96-5"></a>-<span class="w"> </span>src:<span class="w"> </span>file:///opt/local/roles/myroles.tar<span class="w"> </span>
<a id="__codelineno-96-6" name="__codelineno-96-6"></a>name:<span class="w"> </span>myrole<span class="w"> </span>
</code></pre></div></td></tr></table></div>
<p><font style="color:rgb(0,0,0);">所请求文件中的</font><font style="color:rgb(0,0,0);">src</font><font style="color:rgb(0,0,0);">路径是存储</font><font style="color:rgb(0,0,0);">roles</font><font style="color:rgb(0,0,0);">的</font><font style="color:rgb(0,0,0);">URL </font></p>
<p><strong><font style="color:rgb(0,0,0);">使用</font></strong><strong><font style="color:rgb(0,0,0);">rhel­system roles </font></strong></p>
<p><font style="color:rgb(0,0,0);">rhel­system roles </font><font style="color:rgb(0,0,0);">是为了帮助</font><font style="color:rgb(0,0,0);">it</font><font style="color:rgb(0,0,0);">用户更好的管理</font><font style="color:rgb(0,0,0);">RHEL</font><font style="color:rgb(0,0,0);">系统而引入的 </font></p>
<p><font style="color:rgb(0,0,0);">一个系统角色</font><font style="color:rgb(0,0,0);">. </font></p>
<p><strong><font style="color:rgb(0,0,0);">安装</font></strong><strong><font style="color:rgb(0,0,0);">rhel­system roles </font></strong></p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-97-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-97-1" name="__codelineno-97-1"></a><span class="c1"># yum -y install rhel-system-roles </span>
</code></pre></div></td></tr></table></div>
<p><font style="color:rgb(0,0,0);">安装好之后，相关的角色都是在</font><font style="color:rgb(0,0,0);">/usr/share/ansible/roles</font><font style="color:rgb(0,0,0);">目录下 </font></p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-98-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-98-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-98-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-98-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-98-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-98-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-98-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-98-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-98-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-98-10">10</a></span>
<span class="normal"><a href="#__codelineno-98-11">11</a></span>
<span class="normal"><a href="#__codelineno-98-12">12</a></span>
<span class="normal"><a href="#__codelineno-98-13">13</a></span>
<span class="normal"><a href="#__codelineno-98-14">14</a></span>
<span class="normal"><a href="#__codelineno-98-15">15</a></span>
<span class="normal"><a href="#__codelineno-98-16">16</a></span>
<span class="normal"><a href="#__codelineno-98-17">17</a></span>
<span class="normal"><a href="#__codelineno-98-18">18</a></span>
<span class="normal"><a href="#__codelineno-98-19">19</a></span>
<span class="normal"><a href="#__codelineno-98-20">20</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-98-1" name="__codelineno-98-1"></a><span class="o">[</span>student@workstation<span class="w"> </span>~<span class="o">]</span>$<span class="w"> </span>ls<span class="w"> </span>-l<span class="w"> </span>/usr/share/ansible/roles/<span class="w"> </span>
<a id="__codelineno-98-2" name="__codelineno-98-2"></a>total<span class="w"> </span><span class="m">0</span><span class="w"> </span>
<a id="__codelineno-98-3" name="__codelineno-98-3"></a>lrwxrwxrwx.<span class="w"> </span><span class="m">1</span><span class="w"> </span>root<span class="w"> </span>root<span class="w"> </span><span class="m">23</span><span class="w"> </span>Sep<span class="w"> </span><span class="m">26</span><span class="w"> </span><span class="m">18</span>:22<span class="w"> </span>linux­system­roles.kdump<span class="w"> </span>
<a id="__codelineno-98-4" name="__codelineno-98-4"></a>­&gt;<span class="w"> </span>rhel­system­roles.kdump<span class="w"> </span>
<a id="__codelineno-98-5" name="__codelineno-98-5"></a>lrwxrwxrwx.<span class="w"> </span><span class="m">1</span><span class="w"> </span>root<span class="w"> </span>root<span class="w"> </span><span class="m">25</span><span class="w"> </span>Sep<span class="w"> </span><span class="m">26</span><span class="w"> </span><span class="m">18</span>:22<span class="w"> </span>linux­system
<a id="__codelineno-98-6" name="__codelineno-98-6"></a>roles.network<span class="w"> </span>­&gt;<span class="w"> </span>rhel­system­roles.network<span class="w"> </span>
<a id="__codelineno-98-7" name="__codelineno-98-7"></a>lrwxrwxrwx.<span class="w"> </span><span class="m">1</span><span class="w"> </span>root<span class="w"> </span>root<span class="w"> </span><span class="m">25</span><span class="w"> </span>Sep<span class="w"> </span><span class="m">26</span><span class="w"> </span><span class="m">18</span>:22<span class="w"> </span>linux­system
<a id="__codelineno-98-8" name="__codelineno-98-8"></a>roles.postfix<span class="w"> </span>­&gt;<span class="w"> </span>rhel­system­roles.postfix<span class="w"> </span>
<a id="__codelineno-98-9" name="__codelineno-98-9"></a>lrwxrwxrwx.<span class="w"> </span><span class="m">1</span><span class="w"> </span>root<span class="w"> </span>root<span class="w"> </span><span class="m">25</span><span class="w"> </span>Sep<span class="w"> </span><span class="m">26</span><span class="w"> </span><span class="m">18</span>:22<span class="w"> </span>linux­system
<a id="__codelineno-98-10" name="__codelineno-98-10"></a>roles.selinux<span class="w"> </span>­&gt;<span class="w"> </span>rhel­system­roles.selinux<span class="w"> </span>
<a id="__codelineno-98-11" name="__codelineno-98-11"></a>lrwxrwxrwx.<span class="w"> </span><span class="m">1</span><span class="w"> </span>root<span class="w"> </span>root<span class="w"> </span><span class="m">26</span><span class="w"> </span>Sep<span class="w"> </span><span class="m">26</span><span class="w"> </span><span class="m">18</span>:22<span class="w"> </span>linux­system
<a id="__codelineno-98-12" name="__codelineno-98-12"></a>roles.timesync<span class="w"> </span>­&gt;<span class="w"> </span>rhel­system­roles.timesync<span class="w"> </span>
<a id="__codelineno-98-13" name="__codelineno-98-13"></a>drwxr­xr­x.<span class="w"> </span><span class="m">8</span><span class="w"> </span>root<span class="w"> </span>root<span class="w"> </span><span class="m">142</span><span class="w"> </span>Sep<span class="w"> </span><span class="m">26</span><span class="w"> </span><span class="m">18</span>:22<span class="w"> </span>rhel­system­roles.kdump<span class="w"> </span>
<a id="__codelineno-98-14" name="__codelineno-98-14"></a>drwxr­xr­x.<span class="w"> </span><span class="m">8</span><span class="w"> </span>root<span class="w"> </span>root<span class="w"> </span><span class="m">177</span><span class="w"> </span>Sep<span class="w"> </span><span class="m">26</span><span class="w"> </span><span class="m">18</span>:22<span class="w"> </span>rhel­system
<a id="__codelineno-98-15" name="__codelineno-98-15"></a>roles.network<span class="w"> </span>
<a id="__codelineno-98-16" name="__codelineno-98-16"></a>drwxr­xr­x.<span class="w"> </span><span class="m">6</span><span class="w"> </span>root<span class="w"> </span>root<span class="w"> </span><span class="m">95</span><span class="w"> </span>Sep<span class="w"> </span><span class="m">26</span><span class="w"> </span><span class="m">18</span>:22<span class="w"> </span>rhel­system
<a id="__codelineno-98-17" name="__codelineno-98-17"></a>roles.postfixdrwxr­xr­x.<span class="w"> </span><span class="m">7</span><span class="w"> </span>root<span class="w"> </span>root<span class="w"> </span><span class="m">120</span><span class="w"> </span>Sep<span class="w"> </span><span class="m">26</span><span class="w"> </span><span class="m">18</span>:22<span class="w"> </span>rhel­system
<a id="__codelineno-98-18" name="__codelineno-98-18"></a>roles.selinux<span class="w"> </span>
<a id="__codelineno-98-19" name="__codelineno-98-19"></a>drwxr­xr­x.<span class="w"> </span><span class="m">10</span><span class="w"> </span>root<span class="w"> </span>root<span class="w"> </span><span class="m">169</span><span class="w"> </span>Sep<span class="w"> </span><span class="m">26</span><span class="w"> </span><span class="m">18</span>:22<span class="w"> </span>rhel­system
<a id="__codelineno-98-20" name="__codelineno-98-20"></a>roles.timesync<span class="w"> </span>
</code></pre></div></td></tr></table></div>
<p><font style="color:rgb(0,0,0);">rhel­system roles</font><font style="color:rgb(0,0,0);">提供了五种</font><font style="color:rgb(0,0,0);">ansible </font><font style="color:rgb(0,0,0);">角色，分别是 </font></p>
<p><font style="color:rgb(0,0,0);">kdump,network,postfix,selinux,timesync </font></p>
<p><font style="color:rgb(0,0,0);">各个角色的使用方法可以参照</font><font style="color:rgb(0,0,0);">/usr/share/doc/rhel­system­roles­ </font></p>
<p><font style="color:rgb(0,0,0);">1.0 </font><font style="color:rgb(0,0,0);">目录下的各个</font><font style="color:rgb(0,0,0);">playbook</font><font style="color:rgb(0,0,0);">示例。 </font></p>
<p><font style="color:rgb(0,0,0);">使用rhel­system­roles.timesync </font></p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">YAML</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-99-1">1</a></span>
<span class="normal"><a href="#__codelineno-99-2">2</a></span>
<span class="normal"><a href="#__codelineno-99-3">3</a></span>
<span class="normal"><a href="#__codelineno-99-4">4</a></span>
<span class="normal"><a href="#__codelineno-99-5">5</a></span>
<span class="normal"><a href="#__codelineno-99-6">6</a></span>
<span class="normal"><a href="#__codelineno-99-7">7</a></span>
<span class="normal"><a href="#__codelineno-99-8">8</a></span>
<span class="normal"><a href="#__codelineno-99-9">9</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-99-1" name="__codelineno-99-1"></a><span class="nn">---</span>
<a id="__codelineno-99-2" name="__codelineno-99-2"></a><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">time sync</span><span class="w"> </span>
<a id="__codelineno-99-3" name="__codelineno-99-3"></a><span class="nt">hosts</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">all</span><span class="w"> </span>
<a id="__codelineno-99-4" name="__codelineno-99-4"></a><span class="nt">vars</span><span class="p">:</span><span class="w"> </span>
<a id="__codelineno-99-5" name="__codelineno-99-5"></a><span class="nt">timesync_ntp_servers</span><span class="p">:</span><span class="w"> </span>
<a id="__codelineno-99-6" name="__codelineno-99-6"></a><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">hostname</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">172.25.0.254</span><span class="w"> </span>
<a id="__codelineno-99-7" name="__codelineno-99-7"></a><span class="nt">iburst</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">yes</span><span class="w"> </span>
<a id="__codelineno-99-8" name="__codelineno-99-8"></a><span class="nt">roles</span><span class="p">:</span><span class="w"> </span>
<a id="__codelineno-99-9" name="__codelineno-99-9"></a><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">rhel-system-roles.timesync</span>
</code></pre></div></td></tr></table></div>
<h1 id="常用文件操作模块">常用文件操作模块<a class="headerlink" href="#常用文件操作模块" title="Permanent link">&para;</a></h1>
<p><font style="color:rgb(0,0,0);">常见的文件操作模块有copy、file、fetch、blockinfile、lineinfile 等</font></p>
<p><font style="color:rgb(57,57,57);">copy</font><font style="color:rgb(57,57,57);">模块和</font><font style="color:rgb(57,57,57);">fetch</font><font style="color:rgb(57,57,57);">模块类似，</font><font style="color:rgb(57,57,57);">copy</font><font style="color:rgb(57,57,57);">模块是将文件从</font><font style="color:rgb(57,57,57);">ansible </font><font style="color:rgb(57,57,57);">主机拷贝到受管主机上。 </font></p>
<p><font style="color:rgb(57,57,57);">fetch</font><font style="color:rgb(57,57,57);">模块是将文件从受管主机上拉取到</font><font style="color:rgb(57,57,57);">ansible</font><font style="color:rgb(57,57,57);">主机。 </font></p>
<p><font style="color:rgb(57,57,57);">file</font><font style="color:rgb(57,57,57);">模块主要是用来操作文件的，例如创建删除文件、修改文件权限等。 </font></p>
<p><font style="color:rgb(57,57,57);">blockinfile </font><font style="color:rgb(57,57,57);">模块用来向文件中写入文本，这段文本是被标记过的。 </font></p>
<p><font style="color:rgb(0,0,0);">常用参数： </font></p>
<p><font style="color:rgb(0,0,0);">path: </font><font style="color:rgb(0,0,0);">指定要操作的文件 </font></p>
<p><font style="color:rgb(0,0,0);">block: </font><font style="color:rgb(0,0,0);">指定需要写入的文本，</font><font style="color:rgb(0,0,0);">block</font><font style="color:rgb(0,0,0);">可以用</font><font style="color:rgb(0,0,0);">content</font><font style="color:rgb(0,0,0);">代替。 使用</font><font style="color:rgb(0,0,0);">"|" </font><font style="color:rgb(0,0,0);">可以将文本分行写 </font></p>
<p><font style="color:rgb(0,0,0);">入。（默认所有文本都是一行） </font></p>
<p><font style="color:rgb(0,0,0);">marker: </font><font style="color:rgb(0,0,0);">指定标记，在写入文本时，这一段文本默认会有两个标记，一个是起始标记 </font><font style="color:rgb(57,57,57);"># </font></p>
<p><font style="color:rgb(57,57,57);">BEGIN ANSIBLE MANAGED BLOCK</font><font style="color:rgb(0,0,0);">，一个是结束标记</font><font style="color:rgb(57,57,57);"># END ANSIBLE MANAGED BLOCK</font><font style="color:rgb(57,57,57);">，也可以 </font></p>
<p><font style="color:rgb(57,57,57);">自定义，如</font><font style="color:rgb(57,57,57);">marker=#test </font></p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">YAML</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-100-1">1</a></span>
<span class="normal"><a href="#__codelineno-100-2">2</a></span>
<span class="normal"><a href="#__codelineno-100-3">3</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-100-1" name="__codelineno-100-1"></a><span class="c1"># BEGIN ANSIBLE MANAGED BLOCK </span>
<a id="__codelineno-100-2" name="__codelineno-100-2"></a><span class="l l-Scalar l-Scalar-Plain">test world</span><span class="w"> </span>
<a id="__codelineno-100-3" name="__codelineno-100-3"></a><span class="l l-Scalar l-Scalar-Plain"># END ANSIBLE MANAGED BLOCK</span><span class="w"> </span>
</code></pre></div></td></tr></table></div>
<p><font style="color:rgb(0,0,0);">state: </font><font style="color:rgb(0,0,0);">默认值是</font><font style="color:rgb(0,0,0);">present,</font><font style="color:rgb(0,0,0);">表示写入文本，如果值是</font><font style="color:rgb(0,0,0);">absent</font><font style="color:rgb(0,0,0);">，则表示删除相应的文本 </font></p>
<p><font style="color:rgb(0,0,0);">backup: </font><font style="color:rgb(0,0,0);">修改文件前是否备份 </font></p>
<p><font style="color:rgb(0,0,0);">create: </font><font style="color:rgb(0,0,0);">文件不存在是否创建，默认是</font><font style="color:rgb(0,0,0);">no </font></p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">YAML</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-101-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-101-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-101-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-101-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-101-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-101-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-101-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-101-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-101-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-101-10">10</a></span>
<span class="normal"><a href="#__codelineno-101-11">11</a></span>
<span class="normal"><a href="#__codelineno-101-12">12</a></span>
<span class="normal"><a href="#__codelineno-101-13">13</a></span>
<span class="normal"><a href="#__codelineno-101-14">14</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-101-1" name="__codelineno-101-1"></a><span class="nn">---</span><span class="w"> </span>
<a id="__codelineno-101-2" name="__codelineno-101-2"></a><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">hosts</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">node1</span><span class="w"> </span>
<a id="__codelineno-101-3" name="__codelineno-101-3"></a><span class="w w-Error"> </span><span class="nt">tasks</span><span class="p">:</span><span class="w"> </span>
<a id="__codelineno-101-4" name="__codelineno-101-4"></a><span class="w"> </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">blockinfile</span><span class="w"> </span>
<a id="__codelineno-101-5" name="__codelineno-101-5"></a><span class="w"> </span><span class="nt">ansible.builtin.blockinfile</span><span class="p">:</span><span class="w"> </span>
<a id="__codelineno-101-6" name="__codelineno-101-6"></a><span class="w"> </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/tmp/test2</span><span class="w"> </span>
<a id="__codelineno-101-7" name="__codelineno-101-7"></a><span class="w"> </span><span class="nt">block</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span><span class="w"> </span>
<a id="__codelineno-101-8" name="__codelineno-101-8"></a><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">first line</span><span class="w"> </span>
<a id="__codelineno-101-9" name="__codelineno-101-9"></a><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">second line</span><span class="w"> </span>
<a id="__codelineno-101-10" name="__codelineno-101-10"></a><span class="w"> </span><span class="nt">create</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">yes</span><span class="w"> </span>
<a id="__codelineno-101-11" name="__codelineno-101-11"></a><span class="c1"># BEGIN ANSIBLE MANAGED BLOCK </span>
<a id="__codelineno-101-12" name="__codelineno-101-12"></a><span class="l l-Scalar l-Scalar-Plain">first line</span><span class="w"> </span>
<a id="__codelineno-101-13" name="__codelineno-101-13"></a><span class="l l-Scalar l-Scalar-Plain">second line</span><span class="w"> </span>
<a id="__codelineno-101-14" name="__codelineno-101-14"></a><span class="c1"># END ANSIBLE MANAGED BLOCK</span>
</code></pre></div></td></tr></table></div>
<p><font style="color:rgb(57,57,57);">lineinfile </font><font style="color:rgb(57,57,57);">模块用于向文件中写入一行文本，如果写入的文本已经存在于文件中了，则不会写 </font></p>
<p><font style="color:rgb(57,57,57);">入，也可以用来替换已有的文本 </font></p>
<p><font style="color:rgb(0,0,0);">常用的参数： </font></p>
<p><font style="color:rgb(0,0,0);">path: </font><font style="color:rgb(0,0,0);">指定要操作的文件 </font></p>
<p><font style="color:rgb(0,0,0);">line: </font><font style="color:rgb(0,0,0);">要写入的文本内容 </font></p>
<p><font style="color:rgb(0,0,0);">state: </font><font style="color:rgb(0,0,0);">默认值是</font><font style="color:rgb(0,0,0);">present,</font><font style="color:rgb(0,0,0);">表示写入，</font><font style="color:rgb(0,0,0);">absent</font><font style="color:rgb(0,0,0);">则表示删除相应的内容 </font></p>
<p><font style="color:rgb(0,0,0);">backup: </font><font style="color:rgb(0,0,0);">修改前是否备份文件 </font></p>
<p><font style="color:rgb(0,0,0);">create: </font><font style="color:rgb(0,0,0);">如果文件不存在是否创建 </font></p>
<p><font style="color:rgb(57,57,57);">replace </font><font style="color:rgb(57,57,57);">模块可以根据我们指定的正则表达式替换文件中的字符串，文件中所有被匹配到的字符串 </font></p>
<p><font style="color:rgb(57,57,57);">都会被替换。 </font><font style="color:rgb(57,57,57);">replace </font><font style="color:rgb(57,57,57);">模块和</font><font style="color:rgb(57,57,57);"> lineinfile</font><font style="color:rgb(57,57,57);">、</font><font style="color:rgb(57,57,57);">blockinfile </font><font style="color:rgb(57,57,57);">两个模块不同，它并不是 </font></p>
<p><font style="color:rgb(57,57,57);">Ansible </font><font style="color:rgb(57,57,57);">的核心模块，而是由社区维护。 </font></p>
<p><font style="color:rgb(0,0,0);">常用的参数： </font></p>
<p><font style="color:rgb(0,0,0);">path: </font><font style="color:rgb(0,0,0);">必须指定的参数，指定要操作的文件 </font></p>
<p><font style="color:rgb(0,0,0);">regexp: </font><font style="color:rgb(0,0,0);">必须指定的参数，指定一个正则表达式，文件中与正则表达式匹配的字符串将 </font></p>
<p><font style="color:rgb(0,0,0);">会被替换。 </font></p>
<p><font style="color:rgb(0,0,0);">replace</font><font style="color:rgb(0,0,0);">：替换</font><font style="color:rgb(0,0,0);">regexp</font><font style="color:rgb(0,0,0);">参数指定的正则表达式匹配的字符串，如果没有</font><font style="color:rgb(0,0,0);">replace</font><font style="color:rgb(0,0,0);">参数， </font></p>
<p><font style="color:rgb(0,0,0);">则删除匹配的所有字符串。 </font></p>
<p><strong><font style="color:rgb(0,0,0);">练习： </font></strong></p>
<p><font style="color:rgb(0,0,0);">1.</font><font style="color:rgb(0,0,0);">在</font><font style="color:rgb(0,0,0);">dev</font><font style="color:rgb(0,0,0);">组的主机上创建一个目录</font><font style="color:rgb(0,0,0);">/webdev </font></p>
<p><font style="color:rgb(0,0,0);">2.</font><font style="color:rgb(0,0,0);">此目录的属组是</font><font style="color:rgb(0,0,0);">webdev </font></p>
<p><font style="color:rgb(0,0,0);">3.</font><font style="color:rgb(0,0,0);">此目录的权限为 属主</font><font style="color:rgb(0,0,0);">:rwx </font><font style="color:rgb(0,0,0);">， 属组：</font><font style="color:rgb(0,0,0);">rwx, others: r-x </font></p>
<p><font style="color:rgb(0,0,0);">4.</font><font style="color:rgb(0,0,0);">为此目录设置</font><font style="color:rgb(0,0,0);">sgid</font><font style="color:rgb(0,0,0);">权限 </font></p>
<p><font style="color:rgb(0,0,0);">5.</font><font style="color:rgb(0,0,0);">用符号链接将</font><font style="color:rgb(0,0,0);">/var/www/html/webdev </font><font style="color:rgb(0,0,0);">链接到</font><font style="color:rgb(0,0,0);">/webdev </font></p>
<p><font style="color:rgb(0,0,0);">6.</font><font style="color:rgb(0,0,0);">创建一个文件</font><font style="color:rgb(0,0,0);">/webdev/index.html ,</font><font style="color:rgb(0,0,0);">并写入一行文本</font><font style="color:rgb(0,0,0);">"Development" </font></p>
<p><font style="color:rgb(0,0,0);">7.在dev 主机组中主机上浏览此目录将生成以下输出：</font><strong><font style="color:rgb(0,0,0);">Development</font></strong></p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">YAML</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-102-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-102-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-102-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-102-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-102-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-102-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-102-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-102-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-102-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-102-10">10</a></span>
<span class="normal"><a href="#__codelineno-102-11">11</a></span>
<span class="normal"><a href="#__codelineno-102-12">12</a></span>
<span class="normal"><a href="#__codelineno-102-13">13</a></span>
<span class="normal"><a href="#__codelineno-102-14">14</a></span>
<span class="normal"><a href="#__codelineno-102-15">15</a></span>
<span class="normal"><a href="#__codelineno-102-16">16</a></span>
<span class="normal"><a href="#__codelineno-102-17">17</a></span>
<span class="normal"><a href="#__codelineno-102-18">18</a></span>
<span class="normal"><a href="#__codelineno-102-19">19</a></span>
<span class="normal"><a href="#__codelineno-102-20">20</a></span>
<span class="normal"><a href="#__codelineno-102-21">21</a></span>
<span class="normal"><a href="#__codelineno-102-22">22</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-102-1" name="__codelineno-102-1"></a><span class="nn">---</span>
<a id="__codelineno-102-2" name="__codelineno-102-2"></a><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">create web directory</span>
<a id="__codelineno-102-3" name="__codelineno-102-3"></a><span class="w w-Error"> </span><span class="nt">hosts</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">web</span>
<a id="__codelineno-102-4" name="__codelineno-102-4"></a><span class="w"> </span><span class="nt">tasks</span><span class="p">:</span>
<a id="__codelineno-102-5" name="__codelineno-102-5"></a><span class="w"> </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">add webdev group</span>
<a id="__codelineno-102-6" name="__codelineno-102-6"></a><span class="w"> </span><span class="nt">ansible.builtin.group</span><span class="p">:</span>
<a id="__codelineno-102-7" name="__codelineno-102-7"></a><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">webdev</span>
<a id="__codelineno-102-8" name="__codelineno-102-8"></a><span class="w"> </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">create dir /webdev</span>
<a id="__codelineno-102-9" name="__codelineno-102-9"></a><span class="w"> </span><span class="nt">ansible.builtin.file</span><span class="p">:</span>
<a id="__codelineno-102-10" name="__codelineno-102-10"></a><span class="w"> </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/webdev</span>
<a id="__codelineno-102-11" name="__codelineno-102-11"></a><span class="w"> </span><span class="nt">group</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">webdev</span>
<a id="__codelineno-102-12" name="__codelineno-102-12"></a><span class="w"> </span><span class="nt">mode</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;2775&#39;</span>
<a id="__codelineno-102-13" name="__codelineno-102-13"></a><span class="w"> </span><span class="nt">state</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">directory</span>
<a id="__codelineno-102-14" name="__codelineno-102-14"></a><span class="w"> </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">create link dir</span>
<a id="__codelineno-102-15" name="__codelineno-102-15"></a><span class="w"> </span><span class="nt">ansible.builtin.file</span><span class="p">:</span>
<a id="__codelineno-102-16" name="__codelineno-102-16"></a><span class="w"> </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/var/www/html/webdev</span>
<a id="__codelineno-102-17" name="__codelineno-102-17"></a><span class="w"> </span><span class="nt">src</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/webdev</span>
<a id="__codelineno-102-18" name="__codelineno-102-18"></a><span class="w"> </span><span class="nt">state</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">link</span>
<a id="__codelineno-102-19" name="__codelineno-102-19"></a><span class="w"> </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">linein file</span>
<a id="__codelineno-102-20" name="__codelineno-102-20"></a><span class="w"> </span><span class="nt">ansible.builtin.copy</span><span class="p">:</span>
<a id="__codelineno-102-21" name="__codelineno-102-21"></a><span class="w"> </span><span class="nt">dest</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/webdev/index.html</span>
<a id="__codelineno-102-22" name="__codelineno-102-22"></a><span class="w"> </span><span class="nt">content</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Development&quot;</span>
</code></pre></div></td></tr></table></div>
<h1 id="使用jinja2模板部署自定义文件"><strong><font style="color:rgb(0,0,0);">使用Jinja2模板部署自定义文件 </font></strong><a class="headerlink" href="#使用jinja2模板部署自定义文件" title="Permanent link">&para;</a></h1>
<p><font style="color:rgb(0,0,0);">jinja2 是在python中被广泛使用的一个模板引擎，ansible 可以通过jinja2模板来实现动 态表达式和变量引用。 </font></p>
<p><font style="color:rgb(0,0,0);">template模块使用来复制模板到受管主机的，template 使用jinja2模板语言，会对模板文件 中的变量进行替换。 </font></p>
<p><font style="color:rgb(0,0,0);">template </font><font style="color:rgb(0,0,0);">模块使用： </font></p>
<p><font style="color:rgb(0,0,0);">常用参数： </font></p>
<p><font style="color:rgb(0,0,0);">src: </font><font style="color:rgb(0,0,0);">模板文件的路径 </font></p>
<p><font style="color:rgb(0,0,0);">dest: </font><font style="color:rgb(0,0,0);">拷贝到受管主机上的文件路径 </font></p>
<p><font style="color:rgb(0,0,0);">group: </font><font style="color:rgb(0,0,0);">文件的属组 </font></p>
<p><font style="color:rgb(0,0,0);">owner: </font><font style="color:rgb(0,0,0);">文件的属主 </font></p>
<p><font style="color:rgb(0,0,0);">mode: </font><font style="color:rgb(0,0,0);">文件的权限，支持数字法和字符法 </font></p>
<p><font style="color:rgb(0,0,0);">template</font><font style="color:rgb(0,0,0);">使用示例： </font></p>
<p><font style="color:rgb(0,0,0);">需求：在目标主机上生成一个文件</font><font style="color:rgb(0,0,0);">/tmp/host.txt, </font><font style="color:rgb(0,0,0);">文件中包含目标主机的</font><font style="color:rgb(0,0,0);">ip</font><font style="color:rgb(0,0,0);">主机名。</font></p>
<p><font style="color:rgb(0,0,0);">1.创建一个模板文件 </font></p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">YAML</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-103-1">1</a></span>
<span class="normal"><a href="#__codelineno-103-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-103-1" name="__codelineno-103-1"></a><span class="nt">IP</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{{</span><span class="w"> </span><span class="nv">ansible_default_ipv4.address</span><span class="w"> </span><span class="p p-Indicator">}}</span><span class="w"> </span>
<a id="__codelineno-103-2" name="__codelineno-103-2"></a><span class="nt">HOSTNAME</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{{</span><span class="w"> </span><span class="nv">ansible_fqdn</span><span class="w"> </span><span class="p p-Indicator">}}</span><span class="w"> </span>
</code></pre></div></td></tr></table></div>
<p><font style="color:rgb(0,0,0);">2. </font><font style="color:rgb(0,0,0);">使用</font><font style="color:rgb(0,0,0);">template </font><font style="color:rgb(0,0,0);">模块 </font></p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">YAML</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-104-1">1</a></span>
<span class="normal"><a href="#__codelineno-104-2">2</a></span>
<span class="normal"><a href="#__codelineno-104-3">3</a></span>
<span class="normal"><a href="#__codelineno-104-4">4</a></span>
<span class="normal"><a href="#__codelineno-104-5">5</a></span>
<span class="normal"><a href="#__codelineno-104-6">6</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-104-1" name="__codelineno-104-1"></a><span class="nn">---</span><span class="w"> </span>
<a id="__codelineno-104-2" name="__codelineno-104-2"></a><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">hosts</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">all</span><span class="w"> </span>
<a id="__codelineno-104-3" name="__codelineno-104-3"></a><span class="w w-Error"> </span><span class="nt">tasks</span><span class="p">:</span><span class="w"> </span>
<a id="__codelineno-104-4" name="__codelineno-104-4"></a><span class="w"> </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">ansible.builtin.template</span><span class="p">:</span><span class="w"> </span>
<a id="__codelineno-104-5" name="__codelineno-104-5"></a><span class="w"> </span><span class="nt">src</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">host</span><span class="w"> </span>
<a id="__codelineno-104-6" name="__codelineno-104-6"></a><span class="w"> </span><span class="nt">dest</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/tmp/host.txt</span><span class="w"> </span>
</code></pre></div></td></tr></table></div>
<p><font style="color:rgb(0,0,0);">执行后在各个受管主机得到结果： </font></p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">YAML</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-105-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-105-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-105-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-105-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-105-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-105-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-105-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-105-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-105-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-105-10">10</a></span>
<span class="normal"><a href="#__codelineno-105-11">11</a></span>
<span class="normal"><a href="#__codelineno-105-12">12</a></span>
<span class="normal"><a href="#__codelineno-105-13">13</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-105-1" name="__codelineno-105-1"></a><span class="p p-Indicator">[</span><span class="nv">root@workstation ansible</span><span class="p p-Indicator">]</span><span class="c1"># ansible all -m shell -a &#39;cat /tmp/host.txt&#39; </span>
<a id="__codelineno-105-2" name="__codelineno-105-2"></a><span class="l l-Scalar l-Scalar-Plain">node1 | CHANGED | rc=0 &gt;&gt;</span><span class="w"> </span>
<a id="__codelineno-105-3" name="__codelineno-105-3"></a><span class="l l-Scalar l-Scalar-Plain">IP</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">172.16.1.11</span><span class="w"> </span>
<a id="__codelineno-105-4" name="__codelineno-105-4"></a><span class="nt">HOSTNAME</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">node1</span><span class="w"> </span>
<a id="__codelineno-105-5" name="__codelineno-105-5"></a><span class="l l-Scalar l-Scalar-Plain">node4 | CHANGED | rc=0 &gt;&gt;</span><span class="w"> </span>
<a id="__codelineno-105-6" name="__codelineno-105-6"></a><span class="nt">IP</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">172.16.1.14</span><span class="w"> </span>
<a id="__codelineno-105-7" name="__codelineno-105-7"></a><span class="nt">HOSTNAME</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">node4</span><span class="w"> </span>
<a id="__codelineno-105-8" name="__codelineno-105-8"></a><span class="l l-Scalar l-Scalar-Plain">node2 | CHANGED | rc=0 &gt;&gt;</span><span class="w"> </span>
<a id="__codelineno-105-9" name="__codelineno-105-9"></a><span class="nt">IP</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">172.16.1.12</span><span class="w"> </span>
<a id="__codelineno-105-10" name="__codelineno-105-10"></a><span class="nt">HOSTNAME</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">node2</span><span class="w"> </span>
<a id="__codelineno-105-11" name="__codelineno-105-11"></a><span class="l l-Scalar l-Scalar-Plain">node3 | CHANGED | rc=0 &gt;&gt;</span><span class="w"> </span>
<a id="__codelineno-105-12" name="__codelineno-105-12"></a><span class="nt">IP</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">172.16.1.13</span><span class="w"> </span>
<a id="__codelineno-105-13" name="__codelineno-105-13"></a><span class="nt">HOSTNAME</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">node3</span><span class="w"> </span>
</code></pre></div></td></tr></table></div>
<p><strong><font style="color:rgb(57,57,57);">jinja2 </font></strong><strong><font style="color:rgb(57,57,57);">模板语法 </font></strong></p>
<p><font style="color:rgb(57,57,57);">jinja2</font><font style="color:rgb(57,57,57);">模板语法非常灵活，可以使用变量、表达式、</font><font style="color:rgb(57,57,57);">if</font><font style="color:rgb(57,57,57);">控制语句、</font><font style="color:rgb(57,57,57);">for</font><font style="color:rgb(57,57,57);">循环等。 </font></p>
<p><font style="color:rgb(57,57,57);">基本语法格式： </font></p>
<p><font style="color:rgb(57,57,57);">1.</font><font style="color:rgb(57,57,57);">使用双花括号</font><font style="color:rgb(57,57,57);">"{{ }}" </font><font style="color:rgb(57,57,57);">来装载变量 </font></p>
<p><font style="color:rgb(57,57,57);">2.</font><font style="color:rgb(57,57,57);">使用</font><font style="color:rgb(57,57,57);">{% %} </font><font style="color:rgb(57,57,57);">来装载控制语句 </font></p>
<p><strong><font style="color:rgb(57,57,57);">jinja2</font></strong><strong><font style="color:rgb(57,57,57);">中的</font></strong><strong><font style="color:rgb(57,57,57);">if</font></strong><strong><font style="color:rgb(57,57,57);">判断 </font></strong></p>
<p><strong><font style="color:rgb(57,57,57);">语法格式： </font></strong></p>
<p><font style="color:rgb(57,57,57);">1.单条件判断</font></p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">YAML</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-106-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-106-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-106-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-106-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-106-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-106-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-106-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-106-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-106-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-106-10">10</a></span>
<span class="normal"><a href="#__codelineno-106-11">11</a></span>
<span class="normal"><a href="#__codelineno-106-12">12</a></span>
<span class="normal"><a href="#__codelineno-106-13">13</a></span>
<span class="normal"><a href="#__codelineno-106-14">14</a></span>
<span class="normal"><a href="#__codelineno-106-15">15</a></span>
<span class="normal"><a href="#__codelineno-106-16">16</a></span>
<span class="normal"><a href="#__codelineno-106-17">17</a></span>
<span class="normal"><a href="#__codelineno-106-18">18</a></span>
<span class="normal"><a href="#__codelineno-106-19">19</a></span>
<span class="normal"><a href="#__codelineno-106-20">20</a></span>
<span class="normal"><a href="#__codelineno-106-21">21</a></span>
<span class="normal"><a href="#__codelineno-106-22">22</a></span>
<span class="normal"><a href="#__codelineno-106-23">23</a></span>
<span class="normal"><a href="#__codelineno-106-24">24</a></span>
<span class="normal"><a href="#__codelineno-106-25">25</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-106-1" name="__codelineno-106-1"></a><span class="p p-Indicator">{</span><span class="err">%</span><span class="w"> </span><span class="nv">if 判断条件 %</span><span class="p p-Indicator">}</span><span class="w"> </span>
<a id="__codelineno-106-2" name="__codelineno-106-2"></a><span class="l l-Scalar l-Scalar-Plain">操作1</span><span class="w"> </span>
<a id="__codelineno-106-3" name="__codelineno-106-3"></a><span class="l l-Scalar l-Scalar-Plain">操作2</span><span class="w"> </span>
<a id="__codelineno-106-4" name="__codelineno-106-4"></a><span class="nn">...</span><span class="w"> </span>
<a id="__codelineno-106-5" name="__codelineno-106-5"></a><span class="p p-Indicator">{</span><span class="err">%</span><span class="w"> </span><span class="nv">endif %</span><span class="p p-Indicator">}</span><span class="w"> </span>
<a id="__codelineno-106-6" name="__codelineno-106-6"></a><span class="l l-Scalar l-Scalar-Plain">2.双条件判断</span><span class="w"> </span>
<a id="__codelineno-106-7" name="__codelineno-106-7"></a><span class="l l-Scalar l-Scalar-Plain">{% if 判断条件 %}</span><span class="w"> </span>
<a id="__codelineno-106-8" name="__codelineno-106-8"></a><span class="l l-Scalar l-Scalar-Plain">操作1</span><span class="w"> </span>
<a id="__codelineno-106-9" name="__codelineno-106-9"></a><span class="l l-Scalar l-Scalar-Plain">操作2</span><span class="w"> </span>
<a id="__codelineno-106-10" name="__codelineno-106-10"></a><span class="nn">...</span><span class="w"> </span>
<a id="__codelineno-106-11" name="__codelineno-106-11"></a><span class="p p-Indicator">{</span><span class="err">%</span><span class="w"> </span><span class="nv">else %</span><span class="p p-Indicator">}</span><span class="w"> </span>
<a id="__codelineno-106-12" name="__codelineno-106-12"></a><span class="l l-Scalar l-Scalar-Plain">操作3</span><span class="w"> </span>
<a id="__codelineno-106-13" name="__codelineno-106-13"></a><span class="l l-Scalar l-Scalar-Plain">操作4</span><span class="w"> </span>
<a id="__codelineno-106-14" name="__codelineno-106-14"></a><span class="nn">...</span><span class="w"> </span>
<a id="__codelineno-106-15" name="__codelineno-106-15"></a><span class="p p-Indicator">{</span><span class="err">%</span><span class="w"> </span><span class="nv">endif %</span><span class="p p-Indicator">}</span><span class="w"> </span>
<a id="__codelineno-106-16" name="__codelineno-106-16"></a><span class="l l-Scalar l-Scalar-Plain">3.多条件判断</span><span class="w"> </span>
<a id="__codelineno-106-17" name="__codelineno-106-17"></a><span class="l l-Scalar l-Scalar-Plain">{% if 判断条件1 %}</span><span class="w"> </span>
<a id="__codelineno-106-18" name="__codelineno-106-18"></a><span class="l l-Scalar l-Scalar-Plain">操作1</span><span class="w"> </span>
<a id="__codelineno-106-19" name="__codelineno-106-19"></a><span class="nn">...</span><span class="w"> </span>
<a id="__codelineno-106-20" name="__codelineno-106-20"></a><span class="p p-Indicator">{</span><span class="err">%</span><span class="w"> </span><span class="nv">elif 判断条件2 %</span><span class="p p-Indicator">}</span><span class="w"> </span>
<a id="__codelineno-106-21" name="__codelineno-106-21"></a><span class="l l-Scalar l-Scalar-Plain">操作2</span><span class="w"> </span>
<a id="__codelineno-106-22" name="__codelineno-106-22"></a><span class="l l-Scalar l-Scalar-Plain">{% elif 判断条件3 %}</span><span class="w"> </span>
<a id="__codelineno-106-23" name="__codelineno-106-23"></a><span class="l l-Scalar l-Scalar-Plain">操作3</span><span class="w"> </span>
<a id="__codelineno-106-24" name="__codelineno-106-24"></a><span class="nn">...</span><span class="w"> </span>
<a id="__codelineno-106-25" name="__codelineno-106-25"></a><span class="p p-Indicator">{</span><span class="err">%</span><span class="w"> </span><span class="nv">endif %</span><span class="p p-Indicator">}</span><span class="w"> </span>
</code></pre></div></td></tr></table></div>
<p><strong><font style="color:rgb(0,0,0);">判断表达式 </font></strong></p>
<p><font style="color:rgb(0,0,0);">if的判断条件就是一个表达式，这个表达式可以是字符比较，文件测试或者变量测试 </font></p>
<p><font style="color:rgb(0,0,0);">示例1： 在受管主机上生成一个文件/tmp/diskinfo.txt , 显示vdb的大小，如果没有相应的磁盘则显示 </font></p>
<p><font style="color:rgb(0,0,0);">为NONE </font></p>
<p><font style="color:rgb(0,0,0);">1.j2模板 </font></p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">YAML</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-107-1">1</a></span>
<span class="normal"><a href="#__codelineno-107-2">2</a></span>
<span class="normal"><a href="#__codelineno-107-3">3</a></span>
<span class="normal"><a href="#__codelineno-107-4">4</a></span>
<span class="normal"><a href="#__codelineno-107-5">5</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-107-1" name="__codelineno-107-1"></a><span class="p p-Indicator">{</span><span class="err">%</span><span class="w"> </span><span class="nv">if ansible_devices.vdb is defined %</span><span class="p p-Indicator">}</span><span class="w"> </span>
<a id="__codelineno-107-2" name="__codelineno-107-2"></a><span class="nt">vdb_size</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{{</span><span class="w"> </span><span class="nv">ansible_devices.vdb.size</span><span class="w"> </span><span class="p p-Indicator">}}</span><span class="w"> </span>
<a id="__codelineno-107-3" name="__codelineno-107-3"></a><span class="p p-Indicator">{</span><span class="err">%</span><span class="w"> </span><span class="nv">else %</span><span class="p p-Indicator">}</span><span class="w"> </span>
<a id="__codelineno-107-4" name="__codelineno-107-4"></a><span class="nt">vdb_size</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">NONE</span><span class="w"> </span>
<a id="__codelineno-107-5" name="__codelineno-107-5"></a><span class="p p-Indicator">{</span><span class="err">%</span><span class="w"> </span><span class="nv">endif %</span><span class="p p-Indicator">}</span><span class="w"> </span>
</code></pre></div></td></tr></table></div>
<p><font style="color:rgb(0,0,0);">2. 将模板发送各个受管主机上</font></p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">YAML</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-108-1">1</a></span>
<span class="normal"><a href="#__codelineno-108-2">2</a></span>
<span class="normal"><a href="#__codelineno-108-3">3</a></span>
<span class="normal"><a href="#__codelineno-108-4">4</a></span>
<span class="normal"><a href="#__codelineno-108-5">5</a></span>
<span class="normal"><a href="#__codelineno-108-6">6</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-108-1" name="__codelineno-108-1"></a><span class="nn">---</span><span class="w"> </span>
<a id="__codelineno-108-2" name="__codelineno-108-2"></a><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">hosts</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">all</span><span class="w"> </span>
<a id="__codelineno-108-3" name="__codelineno-108-3"></a><span class="w w-Error"> </span><span class="nt">tasks</span><span class="p">:</span><span class="w"> </span>
<a id="__codelineno-108-4" name="__codelineno-108-4"></a><span class="w"> </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">ansible.builtin.template</span><span class="p">:</span><span class="w"> </span>
<a id="__codelineno-108-5" name="__codelineno-108-5"></a><span class="w"> </span><span class="nt">src</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">diskinfo.j2</span><span class="w"> </span>
<a id="__codelineno-108-6" name="__codelineno-108-6"></a><span class="w"> </span><span class="nt">dest</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/tmp/diskinfo.txt</span><span class="w"> </span>
</code></pre></div></td></tr></table></div>
<p><font style="color:rgb(0,0,0);">在受管主机上生成的文件 </font></p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">YAML</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-109-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-109-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-109-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-109-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-109-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-109-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-109-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-109-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-109-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-109-10">10</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-109-1" name="__codelineno-109-1"></a><span class="p p-Indicator">[</span><span class="nv">root@workstation ansible</span><span class="p p-Indicator">]</span><span class="c1"># ansible all -m shell -a &#39;cat </span>
<a id="__codelineno-109-2" name="__codelineno-109-2"></a><span class="l l-Scalar l-Scalar-Plain">/tmp/diskinfo.txt&#39;</span><span class="w"> </span>
<a id="__codelineno-109-3" name="__codelineno-109-3"></a><span class="l l-Scalar l-Scalar-Plain">node1 | CHANGED | rc=0 &gt;&gt;</span><span class="w"> </span>
<a id="__codelineno-109-4" name="__codelineno-109-4"></a><span class="l l-Scalar l-Scalar-Plain">vdb_size</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">NONE</span><span class="w"> </span>
<a id="__codelineno-109-5" name="__codelineno-109-5"></a><span class="l l-Scalar l-Scalar-Plain">node2 | CHANGED | rc=0 &gt;&gt;</span><span class="w"> </span>
<a id="__codelineno-109-6" name="__codelineno-109-6"></a><span class="nt">vdb_size</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">NONE</span><span class="w"> </span>
<a id="__codelineno-109-7" name="__codelineno-109-7"></a><span class="l l-Scalar l-Scalar-Plain">node3 | CHANGED | rc=0 &gt;&gt;</span><span class="w"> </span>
<a id="__codelineno-109-8" name="__codelineno-109-8"></a><span class="nt">vdb_size</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">5.00 GB</span><span class="w"> </span>
<a id="__codelineno-109-9" name="__codelineno-109-9"></a><span class="l l-Scalar l-Scalar-Plain">node4 | CHANGED | rc=0 &gt;&gt;</span><span class="w"> </span>
<a id="__codelineno-109-10" name="__codelineno-109-10"></a><span class="nt">vdb_size</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10.00 GB</span><span class="w"> </span>
</code></pre></div></td></tr></table></div>
<p><strong><font style="color:rgb(0,0,0);">jinja2</font></strong><strong><font style="color:rgb(0,0,0);">中的</font></strong><strong><font style="color:rgb(0,0,0);">for</font></strong><strong><font style="color:rgb(0,0,0);">循环 </font></strong></p>
<p><strong><font style="color:rgb(0,0,0);">for</font></strong><strong><font style="color:rgb(0,0,0);">循环语法格式： </font></strong></p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">YAML</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-110-1">1</a></span>
<span class="normal"><a href="#__codelineno-110-2">2</a></span>
<span class="normal"><a href="#__codelineno-110-3">3</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-110-1" name="__codelineno-110-1"></a><span class="p p-Indicator">{</span><span class="err">%</span><span class="w"> </span><span class="nv">for 变量 in 变量的可迭代对象 %</span><span class="p p-Indicator">}</span><span class="w"> </span>
<a id="__codelineno-110-2" name="__codelineno-110-2"></a><span class="p p-Indicator">{{</span><span class="w"> </span><span class="nv">变量</span><span class="w"> </span><span class="p p-Indicator">}}</span><span class="w"> </span>
<a id="__codelineno-110-3" name="__codelineno-110-3"></a><span class="p p-Indicator">{</span><span class="err">%</span><span class="w"> </span><span class="nv">endfor %</span><span class="p p-Indicator">}</span><span class="w"> </span>
</code></pre></div></td></tr></table></div>
<p><font style="color:rgb(0,0,0);">变量的可迭代对象可以是一个列表、字典、已存在的变量 </font></p>
<p><font style="color:rgb(0,0,0);">列表：</font><font style="color:rgb(0,0,0);"> ['</font><font style="color:rgb(0,0,0);">值</font><font style="color:rgb(0,0,0);">1'</font><font style="color:rgb(0,0,0);">，</font><font style="color:rgb(0,0,0);">'</font><font style="color:rgb(0,0,0);">值</font><font style="color:rgb(0,0,0);">2'</font><font style="color:rgb(0,0,0);">，</font><font style="color:rgb(0,0,0);">...] </font><font style="color:rgb(0,0,0);">或</font><font style="color:rgb(0,0,0);"> '</font><font style="color:rgb(0,0,0);">值</font><font style="color:rgb(0,0,0);">1'</font><font style="color:rgb(0,0,0);">，</font><font style="color:rgb(0,0,0);">'</font><font style="color:rgb(0,0,0);">值</font><font style="color:rgb(0,0,0);">2'</font><font style="color:rgb(0,0,0);">，</font><font style="color:rgb(0,0,0);">... </font></p>
<p><font style="color:rgb(0,0,0);">字典：</font><font style="color:rgb(0,0,0);"> {'key1':'value1','key2':'value2',...} </font></p>
<p><font style="color:rgb(0,0,0);">示例</font><font style="color:rgb(0,0,0);">1</font><font style="color:rgb(0,0,0);">： 循环列表 </font></p>
<p><font style="color:rgb(0,0,0);">j2</font><font style="color:rgb(0,0,0);">模板： </font></p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">YAML</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-111-1">1</a></span>
<span class="normal"><a href="#__codelineno-111-2">2</a></span>
<span class="normal"><a href="#__codelineno-111-3">3</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-111-1" name="__codelineno-111-1"></a><span class="p p-Indicator">{</span><span class="err">%</span><span class="w"> </span><span class="nv">for host in</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;node1.com&quot;</span><span class="p p-Indicator">,</span><span class="s">&quot;node2.com&quot;</span><span class="p p-Indicator">,</span><span class="s">&quot;node3.com&quot;</span><span class="p p-Indicator">,</span><span class="s">&quot;node4.com&quot;</span><span class="p p-Indicator">]</span><span class="w"> </span><span class="err">%</span><span class="p p-Indicator">}</span><span class="w"> </span>
<a id="__codelineno-111-2" name="__codelineno-111-2"></a><span class="nt">hostname</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{{</span><span class="w"> </span><span class="nv">host</span><span class="w"> </span><span class="p p-Indicator">}}</span><span class="w"> </span>
<a id="__codelineno-111-3" name="__codelineno-111-3"></a><span class="p p-Indicator">{</span><span class="err">%</span><span class="w"> </span><span class="nv">endfor %</span><span class="p p-Indicator">}</span><span class="w"> </span>
</code></pre></div></td></tr></table></div>
<p><font style="color:rgb(0,0,0);">得到结果：</font></p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">YAML</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-112-1">1</a></span>
<span class="normal"><a href="#__codelineno-112-2">2</a></span>
<span class="normal"><a href="#__codelineno-112-3">3</a></span>
<span class="normal"><a href="#__codelineno-112-4">4</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-112-1" name="__codelineno-112-1"></a><span class="nt">hostname</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">node1.com</span><span class="w"> </span>
<a id="__codelineno-112-2" name="__codelineno-112-2"></a><span class="nt">hostname</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">node2.com</span><span class="w"> </span>
<a id="__codelineno-112-3" name="__codelineno-112-3"></a><span class="nt">hostname</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">node3.com</span><span class="w"> </span>
<a id="__codelineno-112-4" name="__codelineno-112-4"></a><span class="nt">hostname</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">node4.com</span><span class="w"> </span>
</code></pre></div></td></tr></table></div>
<p><font style="color:rgb(0,0,0);">示例二： 循环字典 </font></p>
<p><font style="color:rgb(0,0,0);">使用字典的时候，必须使用</font><font style="color:rgb(0,0,0);">itertiems()</font><font style="color:rgb(0,0,0);">或</font><font style="color:rgb(0,0,0);">items() </font><font style="color:rgb(0,0,0);">函数对字典进行处理。 </font></p>
<p><font style="color:rgb(0,0,0);">j2</font><font style="color:rgb(0,0,0);">模板： </font></p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">YAML</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-113-1">1</a></span>
<span class="normal"><a href="#__codelineno-113-2">2</a></span>
<span class="normal"><a href="#__codelineno-113-3">3</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-113-1" name="__codelineno-113-1"></a><span class="p p-Indicator">{</span><span class="err">%</span><span class="w"> </span><span class="nv">for key</span><span class="p p-Indicator">,</span><span class="nv">value in</span><span class="w"> </span><span class="p p-Indicator">{</span><span class="s">&#39;name&#39;</span><span class="p p-Indicator">:</span><span class="s">&#39;bob&#39;</span><span class="p p-Indicator">,</span><span class="s">&#39;age&#39;</span><span class="p p-Indicator">:</span><span class="nv">21</span><span class="p p-Indicator">,</span><span class="s">&#39;job&#39;</span><span class="p p-Indicator">:</span><span class="s">&#39;student&#39;</span><span class="p p-Indicator">}</span><span class="nv">.iteritems() %</span><span class="w"> </span>
<a id="__codelineno-113-2" name="__codelineno-113-2"></a><span class="p p-Indicator">{{</span><span class="w"> </span><span class="nv">key</span><span class="w"> </span><span class="p p-Indicator">}}:{{</span><span class="w"> </span><span class="nv">value</span><span class="w"> </span><span class="p p-Indicator">}}</span><span class="w"> </span>
<a id="__codelineno-113-3" name="__codelineno-113-3"></a><span class="p p-Indicator">{</span><span class="err">%</span><span class="w"> </span><span class="nv">endfor %</span><span class="p p-Indicator">}</span><span class="w"> </span>
</code></pre></div></td></tr></table></div>
<p><font style="color:rgb(0,0,0);">得到的结果： </font></p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">YAML</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-114-1">1</a></span>
<span class="normal"><a href="#__codelineno-114-2">2</a></span>
<span class="normal"><a href="#__codelineno-114-3">3</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-114-1" name="__codelineno-114-1"></a><span class="l l-Scalar l-Scalar-Plain">job:student</span><span class="w"> </span>
<a id="__codelineno-114-2" name="__codelineno-114-2"></a><span class="l l-Scalar l-Scalar-Plain">age:21</span><span class="w"> </span>
<a id="__codelineno-114-3" name="__codelineno-114-3"></a><span class="l l-Scalar l-Scalar-Plain">name:bob</span><span class="w"> </span>
</code></pre></div></td></tr></table></div>
<p><font style="color:rgb(243,50,50);">示例三： 循环一个变量 </font></p>
<p><font style="color:rgb(0,0,0);">j2</font><font style="color:rgb(0,0,0);">模板： </font></p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">YAML</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-115-1">1</a></span>
<span class="normal"><a href="#__codelineno-115-2">2</a></span>
<span class="normal"><a href="#__codelineno-115-3">3</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-115-1" name="__codelineno-115-1"></a><span class="p p-Indicator">{</span><span class="err">%</span><span class="w"> </span><span class="nv">for host in groups.all %</span><span class="p p-Indicator">}</span><span class="w"> </span>
<a id="__codelineno-115-2" name="__codelineno-115-2"></a><span class="p p-Indicator">{{</span><span class="w"> </span><span class="nv">host</span><span class="w"> </span><span class="p p-Indicator">}}</span><span class="w"> </span>
<a id="__codelineno-115-3" name="__codelineno-115-3"></a><span class="p p-Indicator">{</span><span class="err">%</span><span class="w"> </span><span class="nv">endfor %</span><span class="p p-Indicator">}</span><span class="w"> </span>
</code></pre></div></td></tr></table></div>
<p><font style="color:rgb(0,0,0);">注：</font><font style="color:rgb(0,0,0);">groups </font><font style="color:rgb(0,0,0);">是</font><font style="color:rgb(0,0,0);">ansible</font><font style="color:rgb(0,0,0);">的默认变量，其中包含所有的组和组内的主机，字典格式 </font></p>
<p><font style="color:rgb(0,0,0);">得到的结果： </font></p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">YAML</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-116-1">1</a></span>
<span class="normal"><a href="#__codelineno-116-2">2</a></span>
<span class="normal"><a href="#__codelineno-116-3">3</a></span>
<span class="normal"><a href="#__codelineno-116-4">4</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-116-1" name="__codelineno-116-1"></a><span class="l l-Scalar l-Scalar-Plain">node3</span><span class="w"> </span>
<a id="__codelineno-116-2" name="__codelineno-116-2"></a><span class="l l-Scalar l-Scalar-Plain">node4</span><span class="w"> </span>
<a id="__codelineno-116-3" name="__codelineno-116-3"></a><span class="l l-Scalar l-Scalar-Plain">node1</span><span class="w"> </span>
<a id="__codelineno-116-4" name="__codelineno-116-4"></a><span class="l l-Scalar l-Scalar-Plain">node2</span><span class="w"> </span>
</code></pre></div></td></tr></table></div>
<p><strong><font style="color:rgb(0,0,0);">循环示例练习： </font></strong></p>
<p><strong><font style="color:rgb(0,0,0);">需求： </font></strong></p>
<p><font style="color:rgb(0,0,0);">在所有受管主机上修改</font><font style="color:rgb(0,0,0);">/etc/hosts</font><font style="color:rgb(0,0,0);">文件，最终所有受管主机上的</font><font style="color:rgb(0,0,0);">/etc/hosts </font></p>
<p><font style="color:rgb(0,0,0);">文件内容格式如下：</font></p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">YAML</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-117-1">1</a></span>
<span class="normal"><a href="#__codelineno-117-2">2</a></span>
<span class="normal"><a href="#__codelineno-117-3">3</a></span>
<span class="normal"><a href="#__codelineno-117-4">4</a></span>
<span class="normal"><a href="#__codelineno-117-5">5</a></span>
<span class="normal"><a href="#__codelineno-117-6">6</a></span>
<span class="normal"><a href="#__codelineno-117-7">7</a></span>
<span class="normal"><a href="#__codelineno-117-8">8</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-117-1" name="__codelineno-117-1"></a><span class="l l-Scalar l-Scalar-Plain">127.0.0.1 localhost localhost.localdomain localhost4</span><span class="w"> </span>
<a id="__codelineno-117-2" name="__codelineno-117-2"></a><span class="l l-Scalar l-Scalar-Plain">localhost4.localdomain4</span><span class="w"> </span>
<a id="__codelineno-117-3" name="__codelineno-117-3"></a><span class="l l-Scalar l-Scalar-Plain">::1 localhost localhost.localdomain localhost6</span><span class="w"> </span>
<a id="__codelineno-117-4" name="__codelineno-117-4"></a><span class="l l-Scalar l-Scalar-Plain">localhost6.localdomain6</span><span class="w"> </span>
<a id="__codelineno-117-5" name="__codelineno-117-5"></a><span class="l l-Scalar l-Scalar-Plain">172.16.1.11 node1</span><span class="w"> </span>
<a id="__codelineno-117-6" name="__codelineno-117-6"></a><span class="l l-Scalar l-Scalar-Plain">172.16.1.12 node2</span><span class="w"> </span>
<a id="__codelineno-117-7" name="__codelineno-117-7"></a><span class="l l-Scalar l-Scalar-Plain">172.16.1.13 node3</span><span class="w"> </span>
<a id="__codelineno-117-8" name="__codelineno-117-8"></a><span class="l l-Scalar l-Scalar-Plain">172.16.1.14 node4</span><span class="w"> </span>
</code></pre></div></td></tr></table></div>
<p><font style="color:rgb(0,0,0);">j2</font><font style="color:rgb(0,0,0);">模板： </font></p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">YAML</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-118-1">1</a></span>
<span class="normal"><a href="#__codelineno-118-2">2</a></span>
<span class="normal"><a href="#__codelineno-118-3">3</a></span>
<span class="normal"><a href="#__codelineno-118-4">4</a></span>
<span class="normal"><a href="#__codelineno-118-5">5</a></span>
<span class="normal"><a href="#__codelineno-118-6">6</a></span>
<span class="normal"><a href="#__codelineno-118-7">7</a></span>
<span class="normal"><a href="#__codelineno-118-8">8</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-118-1" name="__codelineno-118-1"></a><span class="l l-Scalar l-Scalar-Plain">127.0.0.1 localhost localhost.localdomain localhost4</span><span class="w"> </span>
<a id="__codelineno-118-2" name="__codelineno-118-2"></a><span class="l l-Scalar l-Scalar-Plain">localhost4.localdomain4</span><span class="w"> </span>
<a id="__codelineno-118-3" name="__codelineno-118-3"></a><span class="l l-Scalar l-Scalar-Plain">::1 localhost localhost.localdomain localhost6</span><span class="w"> </span>
<a id="__codelineno-118-4" name="__codelineno-118-4"></a><span class="l l-Scalar l-Scalar-Plain">localhost6.localdomain6</span><span class="w"> </span>
<a id="__codelineno-118-5" name="__codelineno-118-5"></a><span class="l l-Scalar l-Scalar-Plain">{% for host in groups[&#39;all&#39;] %}</span><span class="w"> </span>
<a id="__codelineno-118-6" name="__codelineno-118-6"></a><span class="l l-Scalar l-Scalar-Plain">{{ hostvars[host].ansible_default_ipv4.address }} {{</span><span class="w"> </span>
<a id="__codelineno-118-7" name="__codelineno-118-7"></a><span class="l l-Scalar l-Scalar-Plain">hostvars[host].ansible_fqdn }}</span><span class="w"> </span>
<a id="__codelineno-118-8" name="__codelineno-118-8"></a><span class="l l-Scalar l-Scalar-Plain">{% endfor %}</span>
</code></pre></div></td></tr></table></div>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  回到页面顶部
</button>
        
      </main>
      
        <footer class="md-footer">
  
    
      
      <nav class="md-footer__inner md-grid" aria-label="页脚" >
        
          
          <a href="../../%E7%BD%91%E7%BB%9C%E7%AE%A1%E7%90%86/" class="md-footer__link md-footer__link--prev" aria-label="上一页: 网络管理">
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
            </div>
            <div class="md-footer__title">
              <span class="md-footer__direction">
                上一页
              </span>
              <div class="md-ellipsis">
                网络管理
              </div>
            </div>
          </a>
        
        
          
          <a href="../RHEL9-RHCSA%E5%AD%A6%E4%B9%A0/" class="md-footer__link md-footer__link--next" aria-label="下一页: 文件目录">
            <div class="md-footer__title">
              <span class="md-footer__direction">
                下一页
              </span>
              <div class="md-ellipsis">
                文件目录
              </div>
            </div>
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11z"/></svg>
            </div>
          </a>
        
      </nav>
    
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy; 2025 李烨栋
    </div>
  
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../../../..", "features": ["header.autohide", "announce.dismiss", "navigation.instant", "navigation.tracking", "content.code.annotate", "toc.integrate", "toc.follow", "navigation.path", "navigation.top", "navigation.tabs", "navigation.prune", "navigation.footer", "navigation.tabs.sticky", "navigation.sections", "navigation.expand", "content.code.copy", "navigation.indexes", "search.share", "search.suggest", "search.highlight"], "search": "../../../../assets/javascripts/workers/search.f8cc74c7.min.js", "translations": {"clipboard.copied": "\u5df2\u590d\u5236", "clipboard.copy": "\u590d\u5236", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.term.missing": "\u7f3a\u5c11", "select.version": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}}</script>
    
    
      <script src="../../../../assets/javascripts/bundle.c8b220af.min.js"></script>
      
    
  </body>
</html>