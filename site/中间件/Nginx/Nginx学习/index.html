
<!doctype html>
<html lang="zh" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="美少男">
      
      
        <meta name="author" content="李烨栋">
      
      
        <link rel="canonical" href="https://li-ye-dong.github.io/%E4%B8%AD%E9%97%B4%E4%BB%B6/Nginx/Nginx%E5%AD%A6%E4%B9%A0/">
      
      
        <link rel="prev" href="../../../k8s%E5%92%8C%E5%AE%B9%E5%99%A8/Docker/Dokcer%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86/">
      
      
        <link rel="next" href="../../haproxy/haproxy%E5%AD%A6%E4%B9%A0/">
      
      
      <link rel="icon" href="../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.7">
    
    
      
        <title>Nginx学习 - 李烨栋的博客</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.8608ea7d.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
    
    
      <link rel="stylesheet" href="../../../static/stylesheets/google_font.css">
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="green" data-md-color-accent="green">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#nginx学习" class="md-skip">
          跳转至
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow md-header--lifted" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="页眉">
    <a href="../../.." title="李烨栋的博客" class="md-header__button md-logo" aria-label="李烨栋的博客" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            李烨栋的博客
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Nginx学习
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="green" data-md-color-accent="green"  aria-label="日间模式"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="日间模式" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="blue" data-md-color-accent="blue"  aria-label="夜间模式"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="夜间模式" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="搜索" placeholder="搜索" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="查找">
        
          <a href="javascript:void(0)" class="md-search__icon md-icon" title="分享" aria-label="分享" data-clipboard data-clipboard-text="" data-md-component="search-share" tabindex="-1">
            
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91s2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08"/></svg>
          </a>
        
        <button type="reset" class="md-search__icon md-icon" title="清空当前内容" aria-label="清空当前内容" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            正在初始化搜索引擎
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/li-ye-dong/liyedong.github.io.git" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    li-ye-dong.github.io
  </div>
</a>
      </div>
    
  </nav>
  
    
      
<nav class="md-tabs" aria-label="标签" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../.." class="md-tabs__link">
        
  
    
  
  知识库索引

      </a>
    </li>
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../PDF/" class="md-tabs__link">
          
  
    
  
  PDF

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../k8s%E5%92%8C%E5%AE%B9%E5%99%A8/KubeSphere%E4%BD%93%E9%AA%8C/" class="md-tabs__link">
          
  
    
  
  K8s和容器

        </a>
      </li>
    
  

      
        
  
  
    
  
  
    
    
      
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="./" class="md-tabs__link">
          
  
    
  
  中间件

        </a>
      </li>
    
  

    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../%E5%AE%89%E5%85%A8/Burp%20Suite%E6%8A%93%E5%8C%85%E5%B7%A5%E5%85%B7/" class="md-tabs__link">
          
  
    
  
  安全

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../%E5%BC%80%E5%8F%91/FastApi%E5%AD%A6%E4%B9%A0/" class="md-tabs__link">
          
  
    
  
  开发

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/RHEL9/RHEL9-RHCE%E5%AD%A6%E4%B9%A0/" class="md-tabs__link">
          
  
    
  
  操作系统

        </a>
      </li>
    
  

    
  

      
        
  
  
  
    
    
      
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../%E6%95%B0%E6%8D%AE%E5%BA%93%E7%AC%94%E8%AE%B0/MongoDB/MongoDB%20%E6%95%B0%E6%8D%AE%E4%B8%80%E8%87%B4%E6%80%A7%E5%92%8C%E9%9A%94%E7%A6%BB/" class="md-tabs__link">
          
  
    
  
  数据库笔记

        </a>
      </li>
    
  

    
  

      
        
  
  
  
    
    
      
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../%E8%99%9A%E6%8B%9F%E5%8C%96/%E8%99%9A%E6%8B%9F%E5%8C%96/RVtools%E4%BD%BF%E7%94%A8/" class="md-tabs__link">
          
  
    
  
  虚拟化

        </a>
      </li>
    
  

    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../%E8%AE%A4%E8%AF%81%E7%9B%B8%E5%85%B3/credly%E6%9F%A5%E7%9C%8B%E5%8B%8B%E7%AB%A0/" class="md-tabs__link">
          
  
    
  
  认证相关

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
    
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


  

<nav class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" aria-label="导航栏" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="李烨栋的博客" class="md-nav__button md-logo" aria-label="李烨栋的博客" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    李烨栋的博客
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/li-ye-dong/liyedong.github.io.git" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    li-ye-dong.github.io
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    知识库索引
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
    
    
      
      
        
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../../PDF/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    PDF
    
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
        
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../../k8s%E5%92%8C%E5%AE%B9%E5%99%A8/KubeSphere%E4%BD%93%E9%AA%8C/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    K8s和容器
    
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
      
        
      
        
      
        
      
    
    
      
        
        
      
      
        
      
    
    
      
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" checked>
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="">
            
  
  <span class="md-ellipsis">
    中间件
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            中间件
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
    
  
  
  
    
    
      
        
      
    
    
      
      
        
          
          
        
      
    
    
      
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_1" checked>
        
          
          <label class="md-nav__link" for="__nav_4_1" id="__nav_4_1_label" tabindex="">
            
  
  <span class="md-ellipsis">
    Nginx
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_1_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_4_1">
            <span class="md-nav__icon md-icon"></span>
            Nginx
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    Nginx学习
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    Nginx学习
    
  </span>
  

      </a>
      
        

  

<nav class="md-nav md-nav--secondary" aria-label="在这个页面">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      在这个页面
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#1tengine介绍" class="md-nav__link">
    <span class="md-ellipsis">
      1.Tengine介绍
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2安装nginx" class="md-nav__link">
    <span class="md-ellipsis">
      2.安装Nginx
    </span>
  </a>
  
    <nav class="md-nav" aria-label="2.安装Nginx">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ayum源安装" class="md-nav__link">
    <span class="md-ellipsis">
      A.yum源安装
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#b源码安装" class="md-nav__link">
    <span class="md-ellipsis">
      B.源码安装
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#c查看nginx进程" class="md-nav__link">
    <span class="md-ellipsis">
      C.查看Nginx进程
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3nginx配置文件详解" class="md-nav__link">
    <span class="md-ellipsis">
      3.Nginx配置文件详解
    </span>
  </a>
  
    <nav class="md-nav" aria-label="3.Nginx配置文件详解">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#anginxconf全局配置" class="md-nav__link">
    <span class="md-ellipsis">
      A.nginx.conf全局配置
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bevents配置项结构" class="md-nav__link">
    <span class="md-ellipsis">
      B.events配置项结构
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#chttp配置项" class="md-nav__link">
    <span class="md-ellipsis">
      C.http配置项
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dserver配置项" class="md-nav__link">
    <span class="md-ellipsis">
      D.server配置项
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#e范例" class="md-nav__link">
    <span class="md-ellipsis">
      E.范例
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#4架构分析" class="md-nav__link">
    <span class="md-ellipsis">
      4.架构分析
    </span>
  </a>
  
    <nav class="md-nav" aria-label="4.架构分析">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#anginx模块化" class="md-nav__link">
    <span class="md-ellipsis">
      A.Nginx模块化
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bnginx的web请求机制" class="md-nav__link">
    <span class="md-ellipsis">
      B.Nginx的web请求机制
    </span>
  </a>
  
    <nav class="md-nav" aria-label="B.Nginx的web请求机制">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#同步机制" class="md-nav__link">
    <span class="md-ellipsis">
      同步机制
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#异步机制" class="md-nav__link">
    <span class="md-ellipsis">
      异步机制
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#阻塞" class="md-nav__link">
    <span class="md-ellipsis">
      阻塞
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#非阻塞" class="md-nav__link">
    <span class="md-ellipsis">
      非阻塞
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#nginx的请求机制" class="md-nav__link">
    <span class="md-ellipsis">
      Nginx的请求机制
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#c事件驱动模型" class="md-nav__link">
    <span class="md-ellipsis">
      C.事件驱动模型
    </span>
  </a>
  
    <nav class="md-nav" aria-label="C.事件驱动模型">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#nginx的事件驱动模型" class="md-nav__link">
    <span class="md-ellipsis">
      Nginx的事件驱动模型
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#select模型" class="md-nav__link">
    <span class="md-ellipsis">
      select模型
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#poll模型" class="md-nav__link">
    <span class="md-ellipsis">
      poll模型
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#epoll模型" class="md-nav__link">
    <span class="md-ellipsis">
      epoll模型
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dnginx架构" class="md-nav__link">
    <span class="md-ellipsis">
      D.Nginx架构
    </span>
  </a>
  
    <nav class="md-nav" aria-label="D.Nginx架构">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#主进程" class="md-nav__link">
    <span class="md-ellipsis">
      主进程
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#子进程worker-process" class="md-nav__link">
    <span class="md-ellipsis">
      子进程（worker process)
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#5虚拟主机配置" class="md-nav__link">
    <span class="md-ellipsis">
      5.虚拟主机配置
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#6rewrite配置" class="md-nav__link">
    <span class="md-ellipsis">
      6.rewrite配置
    </span>
  </a>
  
    <nav class="md-nav" aria-label="6.rewrite配置">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#nginx-常用全局变量" class="md-nav__link">
    <span class="md-ellipsis">
      nginx 常用全局变量
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#if条件举例" class="md-nav__link">
    <span class="md-ellipsis">
      if条件举例
    </span>
  </a>
  
    <nav class="md-nav" aria-label="if条件举例">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#示例1" class="md-nav__link">
    <span class="md-ellipsis">
      示例1
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#示例2" class="md-nav__link">
    <span class="md-ellipsis">
      示例2
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#示例3" class="md-nav__link">
    <span class="md-ellipsis">
      示例3
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#示例4" class="md-nav__link">
    <span class="md-ellipsis">
      示例4
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#rewrite中的break和last" class="md-nav__link">
    <span class="md-ellipsis">
      rewrite中的break和last
    </span>
  </a>
  
    <nav class="md-nav" aria-label="rewrite中的break和last">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#break和last在location-外部" class="md-nav__link">
    <span class="md-ellipsis">
      break和last在location {}外部
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#当break和last在location里面" class="md-nav__link">
    <span class="md-ellipsis">
      当break和last在location{}里面
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#结论" class="md-nav__link">
    <span class="md-ellipsis">
      结论
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#nginx的return指令" class="md-nav__link">
    <span class="md-ellipsis">
      nginx的return指令
    </span>
  </a>
  
    <nav class="md-nav" aria-label="nginx的return指令">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#直接返回状态码" class="md-nav__link">
    <span class="md-ellipsis">
      直接返回状态码
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#返回字符串" class="md-nav__link">
    <span class="md-ellipsis">
      返回字符串
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#返回url" class="md-nav__link">
    <span class="md-ellipsis">
      返回url
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#生产场景实战" class="md-nav__link">
    <span class="md-ellipsis">
      生产场景实战
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#rewrite规则" class="md-nav__link">
    <span class="md-ellipsis">
      rewrite规则
    </span>
  </a>
  
    <nav class="md-nav" aria-label="rewrite规则">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#示例1_1" class="md-nav__link">
    <span class="md-ellipsis">
      示例1
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#示例2_1" class="md-nav__link">
    <span class="md-ellipsis">
      示例2
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#示例3_1" class="md-nav__link">
    <span class="md-ellipsis">
      示例3
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#示例4_1" class="md-nav__link">
    <span class="md-ellipsis">
      示例4
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#示例5" class="md-nav__link">
    <span class="md-ellipsis">
      示例5
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#rewrite实战" class="md-nav__link">
    <span class="md-ellipsis">
      Rewrite实战
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Rewrite实战">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#域名跳转域名重定向" class="md-nav__link">
    <span class="md-ellipsis">
      域名跳转（域名重定向）
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#防盗链" class="md-nav__link">
    <span class="md-ellipsis">
      防盗链
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#伪静态" class="md-nav__link">
    <span class="md-ellipsis">
      伪静态
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#rewrite多个条件的并且" class="md-nav__link">
    <span class="md-ellipsis">
      rewrite多个条件的并且
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#7location配置" class="md-nav__link">
    <span class="md-ellipsis">
      7.location配置
    </span>
  </a>
  
    <nav class="md-nav" aria-label="7.location配置">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#a安装echo模块" class="md-nav__link">
    <span class="md-ellipsis">
      A.安装echo模块
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#location语法" class="md-nav__link">
    <span class="md-ellipsis">
      location语法
    </span>
  </a>
  
    <nav class="md-nav" aria-label="location语法">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#规则优先级" class="md-nav__link">
    <span class="md-ellipsis">
      规则优先级
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#规则示例" class="md-nav__link">
    <span class="md-ellipsis">
      规则示例
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#小常识" class="md-nav__link">
    <span class="md-ellipsis">
      小常识
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#8nginx代理" class="md-nav__link">
    <span class="md-ellipsis">
      8.nginx代理
    </span>
  </a>
  
    <nav class="md-nav" aria-label="8.nginx代理">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#a正向代理" class="md-nav__link">
    <span class="md-ellipsis">
      A.正向代理
    </span>
  </a>
  
    <nav class="md-nav" aria-label="A.正向代理">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#nginx正向代理配置文件" class="md-nav__link">
    <span class="md-ellipsis">
      Nginx正向代理配置文件
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#nginx正向代理配置执行说明" class="md-nav__link">
    <span class="md-ellipsis">
      Nginx正向代理配置执行说明
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#nginx正向代理支持https" class="md-nav__link">
    <span class="md-ellipsis">
      Nginx正向代理支持https
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#nginx正向代理配置文件_1" class="md-nav__link">
    <span class="md-ellipsis">
      Nginx正向代理配置文件
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#测试示例" class="md-nav__link">
    <span class="md-ellipsis">
      测试示例
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#linux机器上配置全局代理" class="md-nav__link">
    <span class="md-ellipsis">
      linux机器上配置全局代理
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#b反向代理" class="md-nav__link">
    <span class="md-ellipsis">
      B.反向代理
    </span>
  </a>
  
    <nav class="md-nav" aria-label="B.反向代理">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#配置说明" class="md-nav__link">
    <span class="md-ellipsis">
      配置说明
    </span>
  </a>
  
    <nav class="md-nav" aria-label="配置说明">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-proxy_pass" class="md-nav__link">
    <span class="md-ellipsis">
      1. proxy_pass
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-proxy_set_header" class="md-nav__link">
    <span class="md-ellipsis">
      2. proxy_set_header
    </span>
  </a>
  
    <nav class="md-nav" aria-label="2. proxy_set_header">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#总结" class="md-nav__link">
    <span class="md-ellipsis">
      总结
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-proxy_redirect" class="md-nav__link">
    <span class="md-ellipsis">
      3. proxy_redirect
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#9buffer与cache" class="md-nav__link">
    <span class="md-ellipsis">
      9.buffer与cache
    </span>
  </a>
  
    <nav class="md-nav" aria-label="9.buffer与cache">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#abuffer" class="md-nav__link">
    <span class="md-ellipsis">
      A.buffer
    </span>
  </a>
  
    <nav class="md-nav" aria-label="A.buffer">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#proxy_buffering设置" class="md-nav__link">
    <span class="md-ellipsis">
      proxy_buffering设置
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#以下配置都是针对每一个http请求的" class="md-nav__link">
    <span class="md-ellipsis">
      #以下配置，都是针对每一个http请求的。
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#proxy_buffer示例" class="md-nav__link">
    <span class="md-ellipsis">
      proxy_buffer示例
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bcache" class="md-nav__link">
    <span class="md-ellipsis">
      B.cache
    </span>
  </a>
  
    <nav class="md-nav" aria-label="B.cache">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#proxy_cache设置" class="md-nav__link">
    <span class="md-ellipsis">
      proxy_cache设置
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#proxy_cache主要参数" class="md-nav__link">
    <span class="md-ellipsis">
      #proxy_cache主要参数
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#proxy_cache示例" class="md-nav__link">
    <span class="md-ellipsis">
      proxy_cache示例
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#10nginx的负载均衡配置" class="md-nav__link">
    <span class="md-ellipsis">
      10.Nginx的负载均衡配置
    </span>
  </a>
  
    <nav class="md-nav" aria-label="10.Nginx的负载均衡配置">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#案例一简单的轮询" class="md-nav__link">
    <span class="md-ellipsis">
      案例一（简单的轮询）
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#案例二带权重轮询ip_hash算法" class="md-nav__link">
    <span class="md-ellipsis">
      案例二（带权重轮询+ip_hash算法）
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#案例三upstream其他配置" class="md-nav__link">
    <span class="md-ellipsis">
      案例三（upstream其他配置）
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#案例四根据不同的uri" class="md-nav__link">
    <span class="md-ellipsis">
      案例四（根据不同的uri）
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#案例五根据不同的目录" class="md-nav__link">
    <span class="md-ellipsis">
      案例五（根据不同的目录）
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#11nginx访问控制" class="md-nav__link">
    <span class="md-ellipsis">
      11.Nginx访问控制
    </span>
  </a>
  
    <nav class="md-nav" aria-label="11.Nginx访问控制">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#语法" class="md-nav__link">
    <span class="md-ellipsis">
      语法
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#示例" class="md-nav__link">
    <span class="md-ellipsis">
      示例
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#12nginx基于document_uri的访问控制" class="md-nav__link">
    <span class="md-ellipsis">
      12.Nginx基于$document_uri的访问控制
    </span>
  </a>
  
    <nav class="md-nav" aria-label="12.Nginx基于$document_uri的访问控制">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#示例1_2" class="md-nav__link">
    <span class="md-ellipsis">
      示例1
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#示例2_2" class="md-nav__link">
    <span class="md-ellipsis">
      示例2
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#示例3_2" class="md-nav__link">
    <span class="md-ellipsis">
      示例3
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#13nginx基于request_uri访问控制" class="md-nav__link">
    <span class="md-ellipsis">
      13.nginx基于$request_uri访问控制
    </span>
  </a>
  
    <nav class="md-nav" aria-label="13.nginx基于$request_uri访问控制">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#示例_1" class="md-nav__link">
    <span class="md-ellipsis">
      示例
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#14nginx基于user_agent的访问控制" class="md-nav__link">
    <span class="md-ellipsis">
      14.Nginx基于$user_agent的访问控制
    </span>
  </a>
  
    <nav class="md-nav" aria-label="14.Nginx基于$user_agent的访问控制">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#示例_2" class="md-nav__link">
    <span class="md-ellipsis">
      示例
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#15nginx基于http_referer的访问控制" class="md-nav__link">
    <span class="md-ellipsis">
      15.Nginx基于$http_referer的访问控制
    </span>
  </a>
  
    <nav class="md-nav" aria-label="15.Nginx基于$http_referer的访问控制">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#示例_3" class="md-nav__link">
    <span class="md-ellipsis">
      示例
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#16nginx的限速" class="md-nav__link">
    <span class="md-ellipsis">
      16.Nginx的限速
    </span>
  </a>
  
    <nav class="md-nav" aria-label="16.Nginx的限速">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ngx_http_limit_conn_module" class="md-nav__link">
    <span class="md-ellipsis">
      ngx_http_limit_conn_module
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ngx_http_limit_conn_module">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-并发限制" class="md-nav__link">
    <span class="md-ellipsis">
      #1. 并发限制
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-速度限制" class="md-nav__link">
    <span class="md-ellipsis">
      #2. 速度限制
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ngx_http_limit_req_module" class="md-nav__link">
    <span class="md-ellipsis">
      ngx_http_limit_req_module
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ngx_http_limit_req_module">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-limit_req_zone" class="md-nav__link">
    <span class="md-ellipsis">
      #1. limit_req_zone
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-limit_req" class="md-nav__link">
    <span class="md-ellipsis">
      #2. limit_req
    </span>
  </a>
  
    <nav class="md-nav" aria-label="#2. limit_req">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#设定白名单ip" class="md-nav__link">
    <span class="md-ellipsis">
      设定白名单IP
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#17nginx的用户认证类似tomcatbasic认证" class="md-nav__link">
    <span class="md-ellipsis">
      17.Nginx的用户认证（类似tomcatbasic认证）
    </span>
  </a>
  
    <nav class="md-nav" aria-label="17.Nginx的用户认证（类似tomcatbasic认证）">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#步骤和示例" class="md-nav__link">
    <span class="md-ellipsis">
      步骤和示例
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#18ca证书" class="md-nav__link">
    <span class="md-ellipsis">
      18.CA证书
    </span>
  </a>
  
    <nav class="md-nav" aria-label="18.CA证书">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#什么是ca" class="md-nav__link">
    <span class="md-ellipsis">
      什么是CA？
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#什么是ca证书" class="md-nav__link">
    <span class="md-ellipsis">
      什么是CA证书？
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#什么是证书之间的信任关系" class="md-nav__link">
    <span class="md-ellipsis">
      什么是证书之间的信任关系？
    </span>
  </a>
  
    <nav class="md-nav" aria-label="什么是证书之间的信任关系？">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#什么是证书信任链" class="md-nav__link">
    <span class="md-ellipsis">
      什么是证书信任链？
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#什么是根证书" class="md-nav__link">
    <span class="md-ellipsis">
      什么是根证书？
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#证书有啥用" class="md-nav__link">
    <span class="md-ellipsis">
      证书有啥用？
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#19ssl原理" class="md-nav__link">
    <span class="md-ellipsis">
      19.SSL原理
    </span>
  </a>
  
    <nav class="md-nav" aria-label="19.SSL原理">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#申请证书过程" class="md-nav__link">
    <span class="md-ellipsis">
      #申请证书过程
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ssl工作流程单向" class="md-nav__link">
    <span class="md-ellipsis">
      SSL工作流程（单向）
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ssl工作流程双向" class="md-nav__link">
    <span class="md-ellipsis">
      SSL工作流程（双向）
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#20自制ca证书" class="md-nav__link">
    <span class="md-ellipsis">
      20.自制ca证书
    </span>
  </a>
  
    <nav class="md-nav" aria-label="20.自制ca证书">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#生成ca根证书" class="md-nav__link">
    <span class="md-ellipsis">
      生成CA根证书
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#生成server端证书" class="md-nav__link">
    <span class="md-ellipsis">
      生成server端证书
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#生成客户端证书" class="md-nav__link">
    <span class="md-ellipsis">
      生成客户端证书
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#21nginx配置ssl" class="md-nav__link">
    <span class="md-ellipsis">
      21.Nginx配置SSL
    </span>
  </a>
  
    <nav class="md-nav" aria-label="21.Nginx配置SSL">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#nginx配置示例单向" class="md-nav__link">
    <span class="md-ellipsis">
      Nginx配置示例（单向）
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Nginx配置示例（单向）">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#配置说明_1" class="md-nav__link">
    <span class="md-ellipsis">
      配置说明
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#nginx配置双向认证" class="md-nav__link">
    <span class="md-ellipsis">
      Nginx配置双向认证
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Nginx配置双向认证">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#客户端浏览器操作" class="md-nav__link">
    <span class="md-ellipsis">
      客户端（浏览器）操作
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#22nginx的错误日志" class="md-nav__link">
    <span class="md-ellipsis">
      22.Nginx的错误日志
    </span>
  </a>
  
    <nav class="md-nav" aria-label="22.Nginx的错误日志">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#nginx错误日志级别" class="md-nav__link">
    <span class="md-ellipsis">
      Nginx错误日志级别
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#nginx错误日志示例" class="md-nav__link">
    <span class="md-ellipsis">
      Nginx错误日志示例
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#23nginx访问日志配置" class="md-nav__link">
    <span class="md-ellipsis">
      23.Nginx访问日志配置
    </span>
  </a>
  
    <nav class="md-nav" aria-label="23.Nginx访问日志配置">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#配置示例" class="md-nav__link">
    <span class="md-ellipsis">
      配置示例
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#24nginx访问日志格式" class="md-nav__link">
    <span class="md-ellipsis">
      24.Nginx访问日志格式
    </span>
  </a>
  
    <nav class="md-nav" aria-label="24.Nginx访问日志格式">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#访问日志格式示例" class="md-nav__link">
    <span class="md-ellipsis">
      访问日志格式示例
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#配置实例" class="md-nav__link">
    <span class="md-ellipsis">
      配置实例
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#常见变量" class="md-nav__link">
    <span class="md-ellipsis">
      常见变量
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#25nginx访问日志过滤" class="md-nav__link">
    <span class="md-ellipsis">
      25.Nginx访问日志过滤
    </span>
  </a>
  
    <nav class="md-nav" aria-label="25.Nginx访问日志过滤">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#配置示例_1" class="md-nav__link">
    <span class="md-ellipsis">
      配置示例
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#26nginx访问日志切割" class="md-nav__link">
    <span class="md-ellipsis">
      26.Nginx访问日志切割
    </span>
  </a>
  
    <nav class="md-nav" aria-label="26.Nginx访问日志切割">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#shell脚本切割nginx日志" class="md-nav__link">
    <span class="md-ellipsis">
      shell脚本切割Nginx日志
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#系统日志切割机制" class="md-nav__link">
    <span class="md-ellipsis">
      系统日志切割机制
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#27nginx配置参数优化" class="md-nav__link">
    <span class="md-ellipsis">
      27.Nginx配置参数优化
    </span>
  </a>
  
    <nav class="md-nav" aria-label="27.Nginx配置参数优化">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#worker进程" class="md-nav__link">
    <span class="md-ellipsis">
      worker进程
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#http和tcp连接" class="md-nav__link">
    <span class="md-ellipsis">
      http和tcp连接
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#buffer和cache以下配置都是针对单个请求" class="md-nav__link">
    <span class="md-ellipsis">
      buffer和cache(以下配置都是针对单个请求)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#压缩" class="md-nav__link">
    <span class="md-ellipsis">
      压缩
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#日志" class="md-nav__link">
    <span class="md-ellipsis">
      日志
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#静态文件过期" class="md-nav__link">
    <span class="md-ellipsis">
      静态文件过期
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#作为代理服务器" class="md-nav__link">
    <span class="md-ellipsis">
      作为代理服务器
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ssl优化" class="md-nav__link">
    <span class="md-ellipsis">
      SSL优化
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#28调整linux内核参数" class="md-nav__link">
    <span class="md-ellipsis">
      28.调整Linux内核参数
    </span>
  </a>
  
    <nav class="md-nav" aria-label="28.调整Linux内核参数">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#设置和范例" class="md-nav__link">
    <span class="md-ellipsis">
      设置和范例
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#29监控nginx" class="md-nav__link">
    <span class="md-ellipsis">
      29.监控nginx
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#30配置nginx状态" class="md-nav__link">
    <span class="md-ellipsis">
      30.配置Nginx状态
    </span>
  </a>
  
    <nav class="md-nav" aria-label="30.配置Nginx状态">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#nginx配置文件示例" class="md-nav__link">
    <span class="md-ellipsis">
      Nginx配置文件示例
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#配置说明_2" class="md-nav__link">
    <span class="md-ellipsis">
      配置说明
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#测试和结果说明" class="md-nav__link">
    <span class="md-ellipsis">
      测试和结果说明
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#31nginx架构-lnmp" class="md-nav__link">
    <span class="md-ellipsis">
      31.Nginx架构-LNMP
    </span>
  </a>
  
    <nav class="md-nav" aria-label="31.Nginx架构-LNMP">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#安装mysql" class="md-nav__link">
    <span class="md-ellipsis">
      安装MySQL
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#安装php" class="md-nav__link">
    <span class="md-ellipsis">
      安装php
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#安装-nginx" class="md-nav__link">
    <span class="md-ellipsis">
      安装 Nginx
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#测试是否解析php文件" class="md-nav__link">
    <span class="md-ellipsis">
      测试是否解析php文件
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#32nginxtomcat架构" class="md-nav__link">
    <span class="md-ellipsis">
      32.Nginx+Tomcat架构
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#33nginxkeepalived高可用架构" class="md-nav__link">
    <span class="md-ellipsis">
      33.nginx+keepalived高可用架构
    </span>
  </a>
  
    <nav class="md-nav" aria-label="33.nginx+keepalived高可用架构">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1keepalived" class="md-nav__link">
    <span class="md-ellipsis">
      1、keepalived
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2安装-keepalived" class="md-nav__link">
    <span class="md-ellipsis">
      2、安装 keepalived
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3完成高可用配置" class="md-nav__link">
    <span class="md-ellipsis">
      3、完成高可用配置
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4开启服务并且测试" class="md-nav__link">
    <span class="md-ellipsis">
      4、开启服务并且测试
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#34nginx运维规范" class="md-nav__link">
    <span class="md-ellipsis">
      34.nginx运维规范
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
    
    
      
      
        
          
          
        
      
    
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4_2" >
        
          
          <label class="md-nav__link" for="__nav_4_2" id="__nav_4_2_label" tabindex="">
            
  
  <span class="md-ellipsis">
    Haproxy
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_2">
            <span class="md-nav__icon md-icon"></span>
            Haproxy
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../haproxy/haproxy%E5%AD%A6%E4%B9%A0/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Haproxy+Keeplived实践
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
    
    
      
      
        
          
          
        
      
    
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4_3" >
        
          
          <label class="md-nav__link" for="__nav_4_3" id="__nav_4_3_label" tabindex="">
            
  
  <span class="md-ellipsis">
    中间件
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_3">
            <span class="md-nav__icon md-icon"></span>
            中间件
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../%E4%B8%AD%E9%97%B4%E4%BB%B6/Tomcat%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Tomcat学习笔记
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../%E4%B8%AD%E9%97%B4%E4%BB%B6/docker%E5%AE%89%E8%A3%85jenkins/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Docker安装jenkins
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../%E4%B8%AD%E9%97%B4%E4%BB%B6/docker%E5%AE%89%E8%A3%85postgres/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Docker安装postgres
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../%E4%B8%AD%E9%97%B4%E4%BB%B6/docker%E5%AE%89%E8%A3%85redis/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Docker安装redis
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
    
    
      
      
        
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../../%E5%AE%89%E5%85%A8/Burp%20Suite%E6%8A%93%E5%8C%85%E5%B7%A5%E5%85%B7/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    安全
    
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
        
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../../%E5%BC%80%E5%8F%91/FastApi%E5%AD%A6%E4%B9%A0/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    开发
    
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
    
    
      
      
        
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    
  
  
    <a href="../../../%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/RHEL9/RHEL9-RHCE%E5%AD%A6%E4%B9%A0/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    操作系统
    
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

  

      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
    
    
      
      
        
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    
  
  
    <a href="../../../%E6%95%B0%E6%8D%AE%E5%BA%93%E7%AC%94%E8%AE%B0/MongoDB/MongoDB%20%E6%95%B0%E6%8D%AE%E4%B8%80%E8%87%B4%E6%80%A7%E5%92%8C%E9%9A%94%E7%A6%BB/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    数据库笔记
    
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

  

      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
    
    
      
      
        
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    
  
  
    <a href="../../../%E8%99%9A%E6%8B%9F%E5%8C%96/%E8%99%9A%E6%8B%9F%E5%8C%96/RVtools%E4%BD%BF%E7%94%A8/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    虚拟化
    
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

  

      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
    
    
      
      
        
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../../%E8%AE%A4%E8%AF%81%E7%9B%B8%E5%85%B3/credly%E6%9F%A5%E7%9C%8B%E5%8B%8B%E7%AB%A0/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    认证相关
    
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="nginx学习">Nginx学习<a class="headerlink" href="#nginx学习" title="Permanent link">&para;</a></h1>
<h2 id="1tengine介绍">1.Tengine介绍<a class="headerlink" href="#1tengine介绍" title="Permanent link">&para;</a></h2>
<p>由淘宝对Nginx进行二次开发的一个分支服务器，一般用在高并发长场景</p>
<p>官网</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">HTML</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a>https://tengine.taobao.org/
</code></pre></div></td></tr></table></div>
<h2 id="2安装nginx">2.安装Nginx<a class="headerlink" href="#2安装nginx" title="Permanent link">&para;</a></h2>
<h3 id="ayum源安装">A.yum源安装<a class="headerlink" href="#ayum源安装" title="Permanent link">&para;</a></h3>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-1-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-1-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-1-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-1-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-1-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-1-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-1-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-1-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-1-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-1-10">10</a></span>
<span class="normal"><a href="#__codelineno-1-11">11</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1"></a>vi<span class="w"> </span>/etc/yum.repos.d/nginx.repo<span class="w"> </span><span class="c1">#配置nginx较新版本yum源</span>
<a id="__codelineno-1-2" name="__codelineno-1-2"></a><span class="w">    </span><span class="o">[</span>nginx<span class="o">]</span>
<a id="__codelineno-1-3" name="__codelineno-1-3"></a><span class="w">    </span><span class="nv">name</span><span class="o">=</span>nginx<span class="w"> </span>repo
<a id="__codelineno-1-4" name="__codelineno-1-4"></a><span class="w">    </span><span class="nv">baseurl</span><span class="o">=</span>http://nginx.org/packages/centos/<span class="nv">$releasever</span>/<span class="nv">$basearch</span>/
<a id="__codelineno-1-5" name="__codelineno-1-5"></a><span class="w">    </span><span class="nv">gpgcheck</span><span class="o">=</span><span class="m">0</span>
<a id="__codelineno-1-6" name="__codelineno-1-6"></a><span class="w">    </span><span class="nv">enabled</span><span class="o">=</span><span class="m">1</span>
<a id="__codelineno-1-7" name="__codelineno-1-7"></a><span class="c1">#或者下载拓展源epel-release，版本较旧 </span>
<a id="__codelineno-1-8" name="__codelineno-1-8"></a><span class="c1">#yum install epel-release -y</span>
<a id="__codelineno-1-9" name="__codelineno-1-9"></a>yum<span class="w"> </span>list<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>nginx
<a id="__codelineno-1-10" name="__codelineno-1-10"></a>yum<span class="w"> </span>install<span class="w"> </span>nginx<span class="w"> </span>-y
<a id="__codelineno-1-11" name="__codelineno-1-11"></a>whereis<span class="w"> </span>nginx
</code></pre></div></td></tr></table></div>
<h3 id="b源码安装">B.源码安装<a class="headerlink" href="#b源码安装" title="Permanent link">&para;</a></h3>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-2-1">1</a></span>
<span class="normal"><a href="#__codelineno-2-2">2</a></span>
<span class="normal"><a href="#__codelineno-2-3">3</a></span>
<span class="normal"><a href="#__codelineno-2-4">4</a></span>
<span class="normal"><a href="#__codelineno-2-5">5</a></span>
<span class="normal"><a href="#__codelineno-2-6">6</a></span>
<span class="normal"><a href="#__codelineno-2-7">7</a></span>
<span class="normal"><a href="#__codelineno-2-8">8</a></span>
<span class="normal"><a href="#__codelineno-2-9">9</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1"></a>yum<span class="w"> </span>intall<span class="w"> </span>wget
<a id="__codelineno-2-2" name="__codelineno-2-2"></a>wget<span class="w"> </span>url
<a id="__codelineno-2-3" name="__codelineno-2-3"></a>tar<span class="w"> </span>xf<span class="w"> </span>xxx.gz<span class="w"> </span>-C<span class="w"> </span>/usr/local
<a id="__codelineno-2-4" name="__codelineno-2-4"></a><span class="nb">cd</span><span class="w"> </span>/usr/local/nginx-1.2.5
<a id="__codelineno-2-5" name="__codelineno-2-5"></a>./configure<span class="w"> </span>--prefix<span class="o">=</span>/usr/local/nginx
<a id="__codelineno-2-6" name="__codelineno-2-6"></a><span class="c1">#缺少pcre  yum install pcre-devel</span>
<a id="__codelineno-2-7" name="__codelineno-2-7"></a><span class="c1">#缺少zlib    yum install zlib-devel</span>
<a id="__codelineno-2-8" name="__codelineno-2-8"></a>make<span class="w"> </span><span class="c1">#编译</span>
<a id="__codelineno-2-9" name="__codelineno-2-9"></a>make<span class="w"> </span>install<span class="w"> </span><span class="c1">#安装</span>
</code></pre></div></td></tr></table></div>
<h3 id="c查看nginx进程">C.查看Nginx进程<a class="headerlink" href="#c查看nginx进程" title="Permanent link">&para;</a></h3>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-3-1">1</a></span>
<span class="normal"><a href="#__codelineno-3-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1"></a>netstat<span class="w"> </span>-lnp<span class="p">|</span>grep<span class="w"> </span><span class="m">80</span><span class="w"> </span><span class="c1">#查看80端口占用情况</span>
<a id="__codelineno-3-2" name="__codelineno-3-2"></a>ps<span class="w"> </span>-ef<span class="p">|</span>grep<span class="w"> </span>nginx<span class="w"> </span><span class="c1">#查看nginx进程</span>
</code></pre></div></td></tr></table></div>
<h2 id="3nginx配置文件详解">3.Nginx配置文件详解<a class="headerlink" href="#3nginx配置文件详解" title="Permanent link">&para;</a></h2>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-4-1">1</a></span>
<span class="normal"><a href="#__codelineno-4-2">2</a></span>
<span class="normal"><a href="#__codelineno-4-3">3</a></span>
<span class="normal"><a href="#__codelineno-4-4">4</a></span>
<span class="normal"><a href="#__codelineno-4-5">5</a></span>
<span class="normal"><a href="#__codelineno-4-6">6</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1"></a><span class="o">[</span>root@master<span class="w"> </span>nginx<span class="o">]</span><span class="c1"># ll</span>
<a id="__codelineno-4-2" name="__codelineno-4-2"></a>总用量<span class="w"> </span><span class="m">4</span>
<a id="__codelineno-4-3" name="__codelineno-4-3"></a>drwxr-xr-x.<span class="w"> </span><span class="m">2</span><span class="w"> </span>root<span class="w"> </span>root<span class="w"> </span><span class="m">4096</span><span class="w"> </span>8月<span class="w">  </span><span class="m">21</span><span class="w"> </span><span class="m">10</span>:21<span class="w"> </span>conf<span class="w"> </span><span class="c1">#配置文件目录</span>
<a id="__codelineno-4-4" name="__codelineno-4-4"></a>drwxr-xr-x.<span class="w"> </span><span class="m">2</span><span class="w"> </span>root<span class="w"> </span>root<span class="w">   </span><span class="m">40</span><span class="w"> </span>8月<span class="w">  </span><span class="m">21</span><span class="w"> </span><span class="m">09</span>:40<span class="w"> </span>html<span class="w"> </span><span class="c1">#html目录</span>
<a id="__codelineno-4-5" name="__codelineno-4-5"></a>drwxr-xr-x.<span class="w"> </span><span class="m">2</span><span class="w"> </span>root<span class="w"> </span>root<span class="w">    </span><span class="m">6</span><span class="w"> </span>8月<span class="w">  </span><span class="m">21</span><span class="w"> </span><span class="m">09</span>:40<span class="w"> </span>logs<span class="w"> </span><span class="c1">#日志</span>
<a id="__codelineno-4-6" name="__codelineno-4-6"></a>drwxr-xr-x.<span class="w"> </span><span class="m">2</span><span class="w"> </span>root<span class="w"> </span>root<span class="w">   </span><span class="m">19</span><span class="w"> </span>8月<span class="w">  </span><span class="m">21</span><span class="w"> </span><span class="m">09</span>:40<span class="w"> </span>sbin<span class="w"> </span><span class="c1">#启动脚本</span>
</code></pre></div></td></tr></table></div>
<h3 id="anginxconf全局配置">A.nginx.conf全局配置<a class="headerlink" href="#anginxconf全局配置" title="Permanent link">&para;</a></h3>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-5-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-5-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-5-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-5-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-5-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-5-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-5-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-5-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-5-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-5-10">10</a></span>
<span class="normal"><a href="#__codelineno-5-11">11</a></span>
<span class="normal"><a href="#__codelineno-5-12">12</a></span>
<span class="normal"><a href="#__codelineno-5-13">13</a></span>
<span class="normal"><a href="#__codelineno-5-14">14</a></span>
<span class="normal"><a href="#__codelineno-5-15">15</a></span>
<span class="normal"><a href="#__codelineno-5-16">16</a></span>
<span class="normal"><a href="#__codelineno-5-17">17</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1"></a>user<span class="w"> </span>nobody<span class="p">;</span>
<a id="__codelineno-5-2" name="__codelineno-5-2"></a><span class="c1">#定义运行nginx服务的用户,还可以加上组,如 user nobody nobody;</span>
<a id="__codelineno-5-3" name="__codelineno-5-3"></a>worker_processes<span class="w"> </span><span class="m">1</span><span class="p">;</span>
<a id="__codelineno-5-4" name="__codelineno-5-4"></a><span class="c1">#定义nginx子进程数量，即提供服务的进程数量，该数值建议和服务cpu核数保持一致。</span>
<a id="__codelineno-5-5" name="__codelineno-5-5"></a><span class="c1">#除了可以定义数字外，还可以定义为auto，表示让系统自动调整。</span>
<a id="__codelineno-5-6" name="__codelineno-5-6"></a>error_log<span class="w"> </span>logs/error.log<span class="p">;</span>
<a id="__codelineno-5-7" name="__codelineno-5-7"></a><span class="c1">#定义错误日志的路径，可以是相对路径（相对prefix路径的），也可以是绝对路径。</span>
<a id="__codelineno-5-8" name="__codelineno-5-8"></a><span class="c1">#该配置可以在此处定义，也可以定义到http、server、location里</span>
<a id="__codelineno-5-9" name="__codelineno-5-9"></a>error_log<span class="w"> </span>logs/error.log<span class="w"> </span>notice<span class="p">;</span>
<a id="__codelineno-5-10" name="__codelineno-5-10"></a><span class="c1">#定义错误日志路径以及日志级别.</span>
<a id="__codelineno-5-11" name="__codelineno-5-11"></a><span class="c1">##错误日志级别：常见的错误日志级别有[debug|info|notice|warn|error|crit|alert|emerg]，级别越高记录的信息越少。</span>
<a id="__codelineno-5-12" name="__codelineno-5-12"></a><span class="c1">#如果不定义默认是error</span>
<a id="__codelineno-5-13" name="__codelineno-5-13"></a>pid<span class="w"> </span>logs/nginx.pid<span class="p">;</span>
<a id="__codelineno-5-14" name="__codelineno-5-14"></a><span class="c1">#定义nginx进程pid文件所在路径，可以是相对路径，也可以是绝对路径。</span>
<a id="__codelineno-5-15" name="__codelineno-5-15"></a>worker_rlimit_nofile<span class="w"> </span><span class="m">100000</span><span class="p">;</span>
<a id="__codelineno-5-16" name="__codelineno-5-16"></a><span class="c1">#定义nginx最多打开文件数限制。如果没设置的话，这个值为操作系统（ulimit -n）的限制保持一致。</span>
<a id="__codelineno-5-17" name="__codelineno-5-17"></a><span class="c1">#把这个值设高，nginx就不会有“too many open files”问题了。</span>
</code></pre></div></td></tr></table></div>
<h3 id="bevents配置项结构">B.events配置项结构<a class="headerlink" href="#bevents配置项结构" title="Permanent link">&para;</a></h3>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-6-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-6-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-6-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-6-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-6-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-6-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-6-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-6-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-6-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-6-10">10</a></span>
<span class="normal"><a href="#__codelineno-6-11">11</a></span>
<span class="normal"><a href="#__codelineno-6-12">12</a></span>
<span class="normal"><a href="#__codelineno-6-13">13</a></span>
<span class="normal"><a href="#__codelineno-6-14">14</a></span>
<span class="normal"><a href="#__codelineno-6-15">15</a></span>
<span class="normal"><a href="#__codelineno-6-16">16</a></span>
<span class="normal"><a href="#__codelineno-6-17">17</a></span>
<span class="normal"><a href="#__codelineno-6-18">18</a></span>
<span class="normal"><a href="#__codelineno-6-19">19</a></span>
<span class="normal"><a href="#__codelineno-6-20">20</a></span>
<span class="normal"><a href="#__codelineno-6-21">21</a></span>
<span class="normal"><a href="#__codelineno-6-22">22</a></span>
<span class="normal"><a href="#__codelineno-6-23">23</a></span>
<span class="normal"><a href="#__codelineno-6-24">24</a></span>
<span class="normal"><a href="#__codelineno-6-25">25</a></span>
<span class="normal"><a href="#__codelineno-6-26">26</a></span>
<span class="normal"><a href="#__codelineno-6-27">27</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1"></a>events配置部分
<a id="__codelineno-6-2" name="__codelineno-6-2"></a>worker_connections<span class="w"> </span><span class="m">1024</span><span class="p">;</span>
<a id="__codelineno-6-3" name="__codelineno-6-3"></a><span class="c1">#定义每个work_process同时开启的最大连接数，即允许最多只能有这么多连接。</span>
<a id="__codelineno-6-4" name="__codelineno-6-4"></a>accept_mutex<span class="w"> </span>on<span class="p">;</span>
<a id="__codelineno-6-5" name="__codelineno-6-5"></a><span class="c1">#当某一个时刻只有一个网络连接请求服务器时，服务器上有多个睡眠的进程会被同时叫醒，这样会损耗一定的服务器性能。</span>
<a id="__codelineno-6-6" name="__codelineno-6-6"></a><span class="c1">#Nginx中的accept_mutex设置为on，将会对多个Nginx进程（worker processer）接收连接时进行序列化，防止多个进程争抢资源。</span>
<a id="__codelineno-6-7" name="__codelineno-6-7"></a><span class="c1">#默认就是on。</span>
<a id="__codelineno-6-8" name="__codelineno-6-8"></a>multi_accept<span class="w"> </span>on<span class="p">;</span>
<a id="__codelineno-6-9" name="__codelineno-6-9"></a><span class="c1">#nginx worker processer可以做到同时接收多个新到达的网络连接，前提是把该参数设置为on。</span>
<a id="__codelineno-6-10" name="__codelineno-6-10"></a><span class="c1">#默认为off，即每个worker process一次只能接收一个新到达的网络连接。</span>
<a id="__codelineno-6-11" name="__codelineno-6-11"></a>use<span class="w"> </span>epoll<span class="p">;</span>
<a id="__codelineno-6-12" name="__codelineno-6-12"></a><span class="c1">#Nginx服务器提供了多个事件驱动器模型来处理网络消息。</span>
<a id="__codelineno-6-13" name="__codelineno-6-13"></a><span class="c1">#其支持的类型有：select、poll、kqueue、epoll、rtsing、/dev/poll以及eventport。</span>
<a id="__codelineno-6-14" name="__codelineno-6-14"></a>
<a id="__codelineno-6-15" name="__codelineno-6-15"></a><span class="c1">#select：只能在Windows下使用，这个事件模型不建议在高负载的系统使用</span>
<a id="__codelineno-6-16" name="__codelineno-6-16"></a>
<a id="__codelineno-6-17" name="__codelineno-6-17"></a><span class="c1">#poll:Nginx默认首选，但不是在所有系统下都可用</span>
<a id="__codelineno-6-18" name="__codelineno-6-18"></a>
<a id="__codelineno-6-19" name="__codelineno-6-19"></a><span class="c1">#kqueue:这种方式在FreeBSD 4.1+, OpenBSD2.9+, NetBSD 2.0, 和 MacOS X系统中是最高效的</span>
<a id="__codelineno-6-20" name="__codelineno-6-20"></a>
<a id="__codelineno-6-21" name="__codelineno-6-21"></a><span class="c1">#epoll: 这种方式是在Linux 2.6+内核中最高效的方式</span>
<a id="__codelineno-6-22" name="__codelineno-6-22"></a>
<a id="__codelineno-6-23" name="__codelineno-6-23"></a><span class="c1">#rtsig:实时信号，可用在Linux 2.2.19的内核中，但不适用在高流量的系统中</span>
<a id="__codelineno-6-24" name="__codelineno-6-24"></a>
<a id="__codelineno-6-25" name="__codelineno-6-25"></a><span class="c1">#/dev/poll: Solaris 7 11/99+,HP/UX 11.22+, IRIX 6.5.15+, and Tru64 UNIX 5.1A+操作系统最高效的方式</span>
<a id="__codelineno-6-26" name="__codelineno-6-26"></a>
<a id="__codelineno-6-27" name="__codelineno-6-27"></a><span class="c1">#eventport: Solaris 10最高效的方式</span>
</code></pre></div></td></tr></table></div>
<h3 id="chttp配置项">C.http配置项<a class="headerlink" href="#chttp配置项" title="Permanent link">&para;</a></h3>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Nginx Configuration File</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-7-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-7-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-7-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-7-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-7-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-7-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-7-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-7-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-7-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-7-10">10</a></span>
<span class="normal"><a href="#__codelineno-7-11">11</a></span>
<span class="normal"><a href="#__codelineno-7-12">12</a></span>
<span class="normal"><a href="#__codelineno-7-13">13</a></span>
<span class="normal"><a href="#__codelineno-7-14">14</a></span>
<span class="normal"><a href="#__codelineno-7-15">15</a></span>
<span class="normal"><a href="#__codelineno-7-16">16</a></span>
<span class="normal"><a href="#__codelineno-7-17">17</a></span>
<span class="normal"><a href="#__codelineno-7-18">18</a></span>
<span class="normal"><a href="#__codelineno-7-19">19</a></span>
<span class="normal"><a href="#__codelineno-7-20">20</a></span>
<span class="normal"><a href="#__codelineno-7-21">21</a></span>
<span class="normal"><a href="#__codelineno-7-22">22</a></span>
<span class="normal"><a href="#__codelineno-7-23">23</a></span>
<span class="normal"><a href="#__codelineno-7-24">24</a></span>
<span class="normal"><a href="#__codelineno-7-25">25</a></span>
<span class="normal"><a href="#__codelineno-7-26">26</a></span>
<span class="normal"><a href="#__codelineno-7-27">27</a></span>
<span class="normal"><a href="#__codelineno-7-28">28</a></span>
<span class="normal"><a href="#__codelineno-7-29">29</a></span>
<span class="normal"><a href="#__codelineno-7-30">30</a></span>
<span class="normal"><a href="#__codelineno-7-31">31</a></span>
<span class="normal"><a href="#__codelineno-7-32">32</a></span>
<span class="normal"><a href="#__codelineno-7-33">33</a></span>
<span class="normal"><a href="#__codelineno-7-34">34</a></span>
<span class="normal"><a href="#__codelineno-7-35">35</a></span>
<span class="normal"><a href="#__codelineno-7-36">36</a></span>
<span class="normal"><a href="#__codelineno-7-37">37</a></span>
<span class="normal"><a href="#__codelineno-7-38">38</a></span>
<span class="normal"><a href="#__codelineno-7-39">39</a></span>
<span class="normal"><a href="#__codelineno-7-40">40</a></span>
<span class="normal"><a href="#__codelineno-7-41">41</a></span>
<span class="normal"><a href="#__codelineno-7-42">42</a></span>
<span class="normal"><a href="#__codelineno-7-43">43</a></span>
<span class="normal"><a href="#__codelineno-7-44">44</a></span>
<span class="normal"><a href="#__codelineno-7-45">45</a></span>
<span class="normal"><a href="#__codelineno-7-46">46</a></span>
<span class="normal"><a href="#__codelineno-7-47">47</a></span>
<span class="normal"><a href="#__codelineno-7-48">48</a></span>
<span class="normal"><a href="#__codelineno-7-49">49</a></span>
<span class="normal"><a href="#__codelineno-7-50">50</a></span>
<span class="normal"><a href="#__codelineno-7-51">51</a></span>
<span class="normal"><a href="#__codelineno-7-52">52</a></span>
<span class="normal"><a href="#__codelineno-7-53">53</a></span>
<span class="normal"><a href="#__codelineno-7-54">54</a></span>
<span class="normal"><a href="#__codelineno-7-55">55</a></span>
<span class="normal"><a href="#__codelineno-7-56">56</a></span>
<span class="normal"><a href="#__codelineno-7-57">57</a></span>
<span class="normal"><a href="#__codelineno-7-58">58</a></span>
<span class="normal"><a href="#__codelineno-7-59">59</a></span>
<span class="normal"><a href="#__codelineno-7-60">60</a></span>
<span class="normal"><a href="#__codelineno-7-61">61</a></span>
<span class="normal"><a href="#__codelineno-7-62">62</a></span>
<span class="normal"><a href="#__codelineno-7-63">63</a></span>
<span class="normal"><a href="#__codelineno-7-64">64</a></span>
<span class="normal"><a href="#__codelineno-7-65">65</a></span>
<span class="normal"><a href="#__codelineno-7-66">66</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1"></a><span class="k">MIME-Type</span>
<a id="__codelineno-7-2" name="__codelineno-7-2"></a><span class="s">include</span><span class="w">       </span><span class="s">mime.types</span><span class="p">;</span><span class="w">  </span><span class="k">//cat</span><span class="w"> </span><span class="s">conf/mime.types</span>
<a id="__codelineno-7-3" name="__codelineno-7-3"></a><span class="c1">#定义nginx能识别的网络资源媒体类型（如，文本、html、js、css、流媒体等）</span>
<a id="__codelineno-7-4" name="__codelineno-7-4"></a>
<a id="__codelineno-7-5" name="__codelineno-7-5"></a><span class="s">default_type</span><span class="w">  </span><span class="s">application/octet-stream</span><span class="p">;</span>
<a id="__codelineno-7-6" name="__codelineno-7-6"></a><span class="c1">#定义默认的type，如果不定义该项，默认为text/plain.</span>
<a id="__codelineno-7-7" name="__codelineno-7-7"></a><span class="k">log_format</span>
<a id="__codelineno-7-8" name="__codelineno-7-8"></a><span class="s">log_format</span><span class="w"> </span><span class="s">main</span><span class="w">  </span><span class="s">&#39;</span><span class="nv">$remote_addr</span><span class="w"> </span><span class="s">-</span><span class="w"> </span><span class="nv">$remote_user</span><span class="w"> </span><span class="s">[</span><span class="nv">$time_local]</span><span class="w"> </span><span class="s">&quot;</span><span class="nv">$request&quot;</span><span class="w"> </span><span class="s">&#39;</span>
<a id="__codelineno-7-9" name="__codelineno-7-9"></a><span class="w">                  </span><span class="s">&#39;</span><span class="nv">$status</span><span class="w"> </span><span class="nv">$body_bytes_sent</span><span class="w"> </span><span class="s">&quot;</span><span class="nv">$http_referer&quot;</span><span class="w"> </span><span class="s">&#39;</span>
<a id="__codelineno-7-10" name="__codelineno-7-10"></a><span class="w">                  </span><span class="s">&#39;&quot;</span><span class="nv">$http_user_agent&quot;</span><span class="w"> </span><span class="s">&quot;</span><span class="nv">$http_x_forwarded_for&quot;&#39;</span><span class="p">;</span>
<a id="__codelineno-7-11" name="__codelineno-7-11"></a>
<a id="__codelineno-7-12" name="__codelineno-7-12"></a><span class="c1">#其中main为日志格式的名字，后面的为nginx的内部变量组成的一串字符串。</span>
<a id="__codelineno-7-13" name="__codelineno-7-13"></a><span class="k">access_log</span><span class="w"> </span><span class="s">logs/access.log</span><span class="w"> </span><span class="s">main</span><span class="p">;</span>
<a id="__codelineno-7-14" name="__codelineno-7-14"></a><span class="c1">#定义日志的路径以及采用的日志格式，该参数可以在server配置块中定义。</span>
<a id="__codelineno-7-15" name="__codelineno-7-15"></a><span class="k">sendfile</span><span class="w"> </span><span class="no">on</span><span class="p">;</span>
<a id="__codelineno-7-16" name="__codelineno-7-16"></a><span class="c1">#是否调用sendfile函数传输文件，默认为off，使用sendfile函数传输，可以减少user mode和kernel mode的切换，从而提升服务器性能。</span>
<a id="__codelineno-7-17" name="__codelineno-7-17"></a><span class="c1">#对于普通应用设为 on，如果用来进行下载等应用磁盘IO重负载应用，可设置为off，以平衡磁盘与网络I/O处理速度，降低系统的负载。</span>
<a id="__codelineno-7-18" name="__codelineno-7-18"></a><span class="k">sendfile_max_chunk</span><span class="w"> </span><span class="mi">128k</span><span class="p">;</span>
<a id="__codelineno-7-19" name="__codelineno-7-19"></a><span class="c1">#该参数限定Nginx worker process每次调用sendfile()函数传输数据的最大值，默认值为0，如果设置为0则无限制。</span>
<a id="__codelineno-7-20" name="__codelineno-7-20"></a><span class="k">tcp_nopush</span><span class="w"> </span><span class="no">on</span><span class="p">;</span>
<a id="__codelineno-7-21" name="__codelineno-7-21"></a><span class="c1">#当tcp_nopush设置为on时，会调用tcp_cork方法进行数据传输。</span>
<a id="__codelineno-7-22" name="__codelineno-7-22"></a><span class="c1">#使用该方法会产生这样的效果：当应用程序产生数据时，内核不会立马封装包，而是当数据量积累到一定量时才会封装，然后传输。这样有助于解决网络堵塞问题。</span>
<a id="__codelineno-7-23" name="__codelineno-7-23"></a><span class="c1">#默认值为on。举例：快递员收快递、发快递，包裹累积到一定量才会发，节省运输成本。</span>
<a id="__codelineno-7-24" name="__codelineno-7-24"></a><span class="k">keepalive_timeout</span><span class="w"> </span><span class="mi">65</span><span class="w"> </span><span class="mi">60</span><span class="p">;</span>
<a id="__codelineno-7-25" name="__codelineno-7-25"></a><span class="c1">#该参数有两个值，第一个值设置nginx服务器与客户端会话结束后仍旧保持连接的最长时间，单位是秒，默认为75s。</span>
<a id="__codelineno-7-26" name="__codelineno-7-26"></a><span class="c1">#第二个值可以省略，它是针对客户端的浏览器来设置的，可以通过curl -I看到header信息中有一项Keep-Alive: timeout=60，如果不设置就没有这一项。</span>
<a id="__codelineno-7-27" name="__codelineno-7-27"></a><span class="c1">#第二个数值设置后，浏览器就会根据这个数值决定何时主动关闭连接，Nginx服务器就不操心了。但有的浏览器并不认可该参数。</span>
<a id="__codelineno-7-28" name="__codelineno-7-28"></a><span class="k">send_timeout</span>
<a id="__codelineno-7-29" name="__codelineno-7-29"></a><span class="c1">#这个超时时间是发送响应的超时时间，即Nginx服务器向客户端发送了数据包，但客户端一直没有去接收这个数据包。</span>
<a id="__codelineno-7-30" name="__codelineno-7-30"></a><span class="c1">#如果某个连接超过send_timeout定义的超时时间，那么Nginx将会关闭这个连接。</span>
<a id="__codelineno-7-31" name="__codelineno-7-31"></a><span class="s">client_max_body_size</span><span class="w"> </span><span class="mi">10m</span><span class="p">;</span>
<a id="__codelineno-7-32" name="__codelineno-7-32"></a><span class="c1">#浏览器在发送含有较大HTTP包体的请求时，其头部会有一个Content-Length字段，client_max_body_size是用来限制Content-Length所示值的大小的。</span>
<a id="__codelineno-7-33" name="__codelineno-7-33"></a><span class="c1">#这个限制包体的配置不用等Nginx接收完所有的HTTP包体，就可以告诉用户请求过大不被接受。会返回413状态码。</span>
<a id="__codelineno-7-34" name="__codelineno-7-34"></a><span class="c1">#例如，用户试图上传一个1GB的文件，Nginx在收完包头后，发现Content-Length超过client_max_body_size定义的值，</span>
<a id="__codelineno-7-35" name="__codelineno-7-35"></a><span class="c1">#就直接发送413(Request Entity Too Large)响应给客户端。</span>
<a id="__codelineno-7-36" name="__codelineno-7-36"></a><span class="k">gzip</span><span class="w"> </span><span class="no">on</span><span class="s">；</span>
<a id="__codelineno-7-37" name="__codelineno-7-37"></a><span class="c1">#是否开启gzip压缩。</span>
<a id="__codelineno-7-38" name="__codelineno-7-38"></a><span class="s">gzip_min_length</span><span class="w"> </span><span class="mi">1k</span><span class="p">;</span>
<a id="__codelineno-7-39" name="__codelineno-7-39"></a><span class="c1">#设置允许压缩的页面最小字节数，页面字节数从header头得content-length中进行获取。默认值是20。建议设置成大于1k的字节数，小于1k可能会越压越大。</span>
<a id="__codelineno-7-40" name="__codelineno-7-40"></a><span class="k">gzip_buffers</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="mi">16k</span><span class="p">;</span>
<a id="__codelineno-7-41" name="__codelineno-7-41"></a><span class="c1">#设置系统获取几个单位的buffer用于存储gzip的压缩结果数据流。4 16k代表分配4个16k的buffer。</span>
<a id="__codelineno-7-42" name="__codelineno-7-42"></a><span class="k">gzip_http_version</span><span class="w"> </span><span class="mi">1</span><span class="s">.1</span><span class="p">;</span>
<a id="__codelineno-7-43" name="__codelineno-7-43"></a><span class="c1">#用于识别 http 协议的版本，早期的浏览器不支持 Gzip 压缩，用户会看到乱码，所以为了支持前期版本加上了这个选项。</span>
<a id="__codelineno-7-44" name="__codelineno-7-44"></a><span class="c1">#如果你用了Nginx反向代理并期望也启用Gzip压缩的话，由于末端通信是http/1.1，故请设置为 1.1。</span>
<a id="__codelineno-7-45" name="__codelineno-7-45"></a><span class="k">gzip_comp_level</span><span class="w"> </span><span class="mi">6</span><span class="p">;</span>
<a id="__codelineno-7-46" name="__codelineno-7-46"></a><span class="c1">#gzip压缩比，1压缩比最小处理速度最快，9压缩比最大但处理速度最慢(传输快但比较消耗cpu)</span>
<a id="__codelineno-7-47" name="__codelineno-7-47"></a><span class="k">gzip_types</span><span class="w"> </span><span class="s">mime-type</span><span class="w"> </span><span class="s">...</span><span class="w"> </span><span class="p">;</span>
<a id="__codelineno-7-48" name="__codelineno-7-48"></a><span class="c1">#匹配mime类型进行压缩，无论是否指定,”text/html”类型总是会被压缩的。</span>
<a id="__codelineno-7-49" name="__codelineno-7-49"></a><span class="c1">#在conf/mime.conf里查看对应的type。</span>
<a id="__codelineno-7-50" name="__codelineno-7-50"></a>
<a id="__codelineno-7-51" name="__codelineno-7-51"></a><span class="c1">#示例：gzip_types       text/plain application/x-javascript text/css text/html application/xml;</span>
<a id="__codelineno-7-52" name="__codelineno-7-52"></a><span class="k">gzip_proxied</span><span class="w"> </span><span class="s">any</span><span class="p">;</span>
<a id="__codelineno-7-53" name="__codelineno-7-53"></a><span class="c1">#Nginx作为反向代理的时候启用，决定开启或者关闭后端服务器返回的结果是否压缩，匹配的前提是后端服务器必须要返回包含”Via”的 header头。</span>
<a id="__codelineno-7-54" name="__codelineno-7-54"></a>
<a id="__codelineno-7-55" name="__codelineno-7-55"></a><span class="c1">#以下为可用的值：</span>
<a id="__codelineno-7-56" name="__codelineno-7-56"></a><span class="c1">#off - 关闭所有的代理结果数据的压缩</span>
<a id="__codelineno-7-57" name="__codelineno-7-57"></a><span class="c1">#expired - 启用压缩，如果header头中包含 &quot;Expires&quot; 头信息</span>
<a id="__codelineno-7-58" name="__codelineno-7-58"></a><span class="c1">#no-cache - 启用压缩，如果header头中包含 &quot;Cache-Control:no-cache&quot; 头信息</span>
<a id="__codelineno-7-59" name="__codelineno-7-59"></a><span class="c1">#no-store - 启用压缩，如果header头中包含 &quot;Cache-Control:no-store&quot; 头信息</span>
<a id="__codelineno-7-60" name="__codelineno-7-60"></a><span class="c1">#private - 启用压缩，如果header头中包含 &quot;Cache-Control:private&quot; 头信息</span>
<a id="__codelineno-7-61" name="__codelineno-7-61"></a><span class="c1">#no_last_modified - 启用压缩,如果header头中不包含 &quot;Last-Modified&quot; 头信息</span>
<a id="__codelineno-7-62" name="__codelineno-7-62"></a><span class="c1">#no_etag - 启用压缩 ,如果header头中不包含 &quot;ETag&quot; 头信息</span>
<a id="__codelineno-7-63" name="__codelineno-7-63"></a><span class="c1">#auth - 启用压缩 , 如果header头中包含 &quot;Authorization&quot; 头信息</span>
<a id="__codelineno-7-64" name="__codelineno-7-64"></a><span class="c1">#any - 无条件启用压缩</span>
<a id="__codelineno-7-65" name="__codelineno-7-65"></a><span class="c1">#gzip_vary on；</span>
<a id="__codelineno-7-66" name="__codelineno-7-66"></a><span class="c1">#和http头有关系，会在响应头加个 Vary: Accept-Encoding ，可以让前端的缓存服务器缓存经过gzip压缩的页面，例如，用Squid缓存经过Nginx压缩的数据。</span>
</code></pre></div></td></tr></table></div>
<h3 id="dserver配置项">D.server配置项<a class="headerlink" href="#dserver配置项" title="Permanent link">&para;</a></h3>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Nginx Configuration File</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-8-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-8-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-8-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-8-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-8-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-8-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-8-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-8-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-8-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-8-10">10</a></span>
<span class="normal"><a href="#__codelineno-8-11">11</a></span>
<span class="normal"><a href="#__codelineno-8-12">12</a></span>
<span class="normal"><a href="#__codelineno-8-13">13</a></span>
<span class="normal"><a href="#__codelineno-8-14">14</a></span>
<span class="normal"><a href="#__codelineno-8-15">15</a></span>
<span class="normal"><a href="#__codelineno-8-16">16</a></span>
<span class="normal"><a href="#__codelineno-8-17">17</a></span>
<span class="normal"><a href="#__codelineno-8-18">18</a></span>
<span class="normal"><a href="#__codelineno-8-19">19</a></span>
<span class="normal"><a href="#__codelineno-8-20">20</a></span>
<span class="normal"><a href="#__codelineno-8-21">21</a></span>
<span class="normal"><a href="#__codelineno-8-22">22</a></span>
<span class="normal"><a href="#__codelineno-8-23">23</a></span>
<span class="normal"><a href="#__codelineno-8-24">24</a></span>
<span class="normal"><a href="#__codelineno-8-25">25</a></span>
<span class="normal"><a href="#__codelineno-8-26">26</a></span>
<span class="normal"><a href="#__codelineno-8-27">27</a></span>
<span class="normal"><a href="#__codelineno-8-28">28</a></span>
<span class="normal"><a href="#__codelineno-8-29">29</a></span>
<span class="normal"><a href="#__codelineno-8-30">30</a></span>
<span class="normal"><a href="#__codelineno-8-31">31</a></span>
<span class="normal"><a href="#__codelineno-8-32">32</a></span>
<span class="normal"><a href="#__codelineno-8-33">33</a></span>
<span class="normal"><a href="#__codelineno-8-34">34</a></span>
<span class="normal"><a href="#__codelineno-8-35">35</a></span>
<span class="normal"><a href="#__codelineno-8-36">36</a></span>
<span class="normal"><a href="#__codelineno-8-37">37</a></span>
<span class="normal"><a href="#__codelineno-8-38">38</a></span>
<span class="normal"><a href="#__codelineno-8-39">39</a></span>
<span class="normal"><a href="#__codelineno-8-40">40</a></span>
<span class="normal"><a href="#__codelineno-8-41">41</a></span>
<span class="normal"><a href="#__codelineno-8-42">42</a></span>
<span class="normal"><a href="#__codelineno-8-43">43</a></span>
<span class="normal"><a href="#__codelineno-8-44">44</a></span>
<span class="normal"><a href="#__codelineno-8-45">45</a></span>
<span class="normal"><a href="#__codelineno-8-46">46</a></span>
<span class="normal"><a href="#__codelineno-8-47">47</a></span>
<span class="normal"><a href="#__codelineno-8-48">48</a></span>
<span class="normal"><a href="#__codelineno-8-49">49</a></span>
<span class="normal"><a href="#__codelineno-8-50">50</a></span>
<span class="normal"><a href="#__codelineno-8-51">51</a></span>
<span class="normal"><a href="#__codelineno-8-52">52</a></span>
<span class="normal"><a href="#__codelineno-8-53">53</a></span>
<span class="normal"><a href="#__codelineno-8-54">54</a></span>
<span class="normal"><a href="#__codelineno-8-55">55</a></span>
<span class="normal"><a href="#__codelineno-8-56">56</a></span>
<span class="normal"><a href="#__codelineno-8-57">57</a></span>
<span class="normal"><a href="#__codelineno-8-58">58</a></span>
<span class="normal"><a href="#__codelineno-8-59">59</a></span>
<span class="normal"><a href="#__codelineno-8-60">60</a></span>
<span class="normal"><a href="#__codelineno-8-61">61</a></span>
<span class="normal"><a href="#__codelineno-8-62">62</a></span>
<span class="normal"><a href="#__codelineno-8-63">63</a></span>
<span class="normal"><a href="#__codelineno-8-64">64</a></span>
<span class="normal"><a href="#__codelineno-8-65">65</a></span>
<span class="normal"><a href="#__codelineno-8-66">66</a></span>
<span class="normal"><a href="#__codelineno-8-67">67</a></span>
<span class="normal"><a href="#__codelineno-8-68">68</a></span>
<span class="normal"><a href="#__codelineno-8-69">69</a></span>
<span class="normal"><a href="#__codelineno-8-70">70</a></span>
<span class="normal"><a href="#__codelineno-8-71">71</a></span>
<span class="normal"><a href="#__codelineno-8-72">72</a></span>
<span class="normal"><a href="#__codelineno-8-73">73</a></span>
<span class="normal"><a href="#__codelineno-8-74">74</a></span>
<span class="normal"><a href="#__codelineno-8-75">75</a></span>
<span class="normal"><a href="#__codelineno-8-76">76</a></span>
<span class="normal"><a href="#__codelineno-8-77">77</a></span>
<span class="normal"><a href="#__codelineno-8-78">78</a></span>
<span class="normal"><a href="#__codelineno-8-79">79</a></span>
<span class="normal"><a href="#__codelineno-8-80">80</a></span>
<span class="normal"><a href="#__codelineno-8-81">81</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1"></a><span class="w">   </span><span class="k">server</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-8-2" name="__codelineno-8-2"></a><span class="w">    </span><span class="kn">listen</span><span class="w">       </span><span class="mi">80</span><span class="p">;</span><span class="w">  </span><span class="kn">//监听端口为80，可以自定义其他端口，也可以加上IP地址，如，listen</span><span class="w"> </span><span class="n">127.0.0.1</span><span class="p">:</span><span class="mi">8080</span><span class="p">;</span>
<a id="__codelineno-8-3" name="__codelineno-8-3"></a><span class="w">    </span><span class="kn">server_name</span><span class="w">  </span><span class="s">localhost</span><span class="p">;</span><span class="w"> </span><span class="kn">//定义网站域名，可以写多个，用空格分隔。</span>
<a id="__codelineno-8-4" name="__codelineno-8-4"></a><span class="w">    </span><span class="c1">#charset koi8-r; //定义网站的字符集，一般不设置，而是在网页代码中设置。</span>
<a id="__codelineno-8-5" name="__codelineno-8-5"></a><span class="w">    </span><span class="c1">#access_log  logs/host.access.log  main; //定义访问日志，可以针对每一个server（即每一个站点）设置它们自己的访问日志。</span>
<a id="__codelineno-8-6" name="__codelineno-8-6"></a>
<a id="__codelineno-8-7" name="__codelineno-8-7"></a><span class="w">    </span><span class="c1">##在server{}里有很多location配置段</span>
<a id="__codelineno-8-8" name="__codelineno-8-8"></a><span class="w">    </span><span class="s">location</span><span class="w"> </span><span class="s">/</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-8-9" name="__codelineno-8-9"></a><span class="w">        </span><span class="kn">root</span><span class="w">   </span><span class="s">html</span><span class="p">;</span><span class="w">  </span><span class="kn">//定义网站根目录，目录可以是相对路径也可以是绝对路径。</span>
<a id="__codelineno-8-10" name="__codelineno-8-10"></a><span class="w">        </span><span class="s">index</span><span class="w">  </span><span class="s">index.html</span><span class="w"> </span><span class="s">index.htm</span><span class="p">;</span><span class="w"> </span><span class="kn">//定义站点的默认页。</span>
<a id="__codelineno-8-11" name="__codelineno-8-11"></a><span class="w">    </span><span class="err">}</span>
<a id="__codelineno-8-12" name="__codelineno-8-12"></a>
<a id="__codelineno-8-13" name="__codelineno-8-13"></a><span class="w">    </span><span class="c1">#error_page  404              /404.html;  //定义404页面</span>
<a id="__codelineno-8-14" name="__codelineno-8-14"></a>
<a id="__codelineno-8-15" name="__codelineno-8-15"></a><span class="w">    </span><span class="c1"># redirect server error pages to the static page /50x.html</span>
<a id="__codelineno-8-16" name="__codelineno-8-16"></a><span class="w">    </span><span class="c1">#</span>
<a id="__codelineno-8-17" name="__codelineno-8-17"></a><span class="w">    </span><span class="s">error_page</span><span class="w">   </span><span class="mi">500</span><span class="w"> </span><span class="mi">502</span><span class="w"> </span><span class="mi">503</span><span class="w"> </span><span class="mi">504</span><span class="w">  </span><span class="s">/50x.html</span><span class="p">;</span><span class="w">  </span><span class="kn">//当状态码为500、502、503、504时，则访问50x.html</span>
<a id="__codelineno-8-18" name="__codelineno-8-18"></a><span class="w">    </span><span class="s">location</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">/50x.html</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-8-19" name="__codelineno-8-19"></a><span class="w">        </span><span class="kn">root</span><span class="w">   </span><span class="s">html</span><span class="p">;</span><span class="w">  </span><span class="kn">//定义50x.html所在路径</span>
<a id="__codelineno-8-20" name="__codelineno-8-20"></a><span class="w">    </span><span class="err">}</span>
<a id="__codelineno-8-21" name="__codelineno-8-21"></a>
<a id="__codelineno-8-22" name="__codelineno-8-22"></a><span class="w">    </span><span class="c1"># proxy the PHP scripts to Apache listening on 127.0.0.1:80</span>
<a id="__codelineno-8-23" name="__codelineno-8-23"></a><span class="w">    </span><span class="c1">#</span>
<a id="__codelineno-8-24" name="__codelineno-8-24"></a><span class="w">    </span><span class="c1">#定义访问php脚本时，将会执行本location{}部分指令</span>
<a id="__codelineno-8-25" name="__codelineno-8-25"></a><span class="w">    </span><span class="c1">#location ~ \.php$ {</span>
<a id="__codelineno-8-26" name="__codelineno-8-26"></a><span class="w">    </span><span class="c1">#    proxy_pass   http://127.0.0.1;  //proxy_pass后面指定要访问的url链接，用proxy_pass实现代理。</span>
<a id="__codelineno-8-27" name="__codelineno-8-27"></a><span class="w">    </span><span class="c1">#}</span>
<a id="__codelineno-8-28" name="__codelineno-8-28"></a>
<a id="__codelineno-8-29" name="__codelineno-8-29"></a><span class="w">    </span><span class="c1"># pass the PHP scripts to FastCGI server listening on 127.0.0.1:9000</span>
<a id="__codelineno-8-30" name="__codelineno-8-30"></a><span class="w">    </span><span class="c1">#</span>
<a id="__codelineno-8-31" name="__codelineno-8-31"></a><span class="w">    </span><span class="c1">#location ~ \.php$ {</span>
<a id="__codelineno-8-32" name="__codelineno-8-32"></a><span class="w">    </span><span class="c1">#    root           html;</span>
<a id="__codelineno-8-33" name="__codelineno-8-33"></a><span class="w">    </span><span class="c1">#    fastcgi_pass   127.0.0.1:9000;  //定义FastCGI服务器监听端口与地址，支持两种形式，1 IP:Port， 2 unix:/path/to/sockt</span>
<a id="__codelineno-8-34" name="__codelineno-8-34"></a><span class="w">    </span><span class="c1">#    fastcgi_index  index.php;</span>
<a id="__codelineno-8-35" name="__codelineno-8-35"></a><span class="w">    </span><span class="c1">#    fastcgi_param  SCRIPT_FILENAME  /scripts$fastcgi_script_name;  //定义SCRIPT_FILENAME变量，后面的路径/scripts为上面的root指定的目录</span>
<a id="__codelineno-8-36" name="__codelineno-8-36"></a><span class="w">    </span><span class="c1">#    include        fastcgi_params; //引用prefix/conf/fastcgi_params文件，该文件定义了fastcgi相关的变量</span>
<a id="__codelineno-8-37" name="__codelineno-8-37"></a><span class="w">    </span><span class="c1">#}</span>
<a id="__codelineno-8-38" name="__codelineno-8-38"></a>
<a id="__codelineno-8-39" name="__codelineno-8-39"></a><span class="w">    </span><span class="c1"># deny access to .htaccess files, if Apache&#39;s document root</span>
<a id="__codelineno-8-40" name="__codelineno-8-40"></a><span class="w">    </span><span class="c1"># concurs with nginx&#39;s one</span>
<a id="__codelineno-8-41" name="__codelineno-8-41"></a><span class="w">    </span><span class="c1"># </span>
<a id="__codelineno-8-42" name="__codelineno-8-42"></a><span class="w">    </span><span class="c1">#location ~ /\.ht {   //访问的url中，以/.ht开头的，如，www.example.com/.htaccess，会被拒绝，返回403状态码。</span>
<a id="__codelineno-8-43" name="__codelineno-8-43"></a><span class="w">    </span><span class="c1">#    deny  all;  //这里的all指的是所有的请求。</span>
<a id="__codelineno-8-44" name="__codelineno-8-44"></a><span class="w">    </span><span class="c1">#}</span>
<a id="__codelineno-8-45" name="__codelineno-8-45"></a><span class="err">}</span>
<a id="__codelineno-8-46" name="__codelineno-8-46"></a>
<a id="__codelineno-8-47" name="__codelineno-8-47"></a>
<a id="__codelineno-8-48" name="__codelineno-8-48"></a><span class="c1"># another virtual host using mix of IP-, name-, and port-based configuration</span>
<a id="__codelineno-8-49" name="__codelineno-8-49"></a><span class="c1">#</span>
<a id="__codelineno-8-50" name="__codelineno-8-50"></a><span class="c1">#server {</span>
<a id="__codelineno-8-51" name="__codelineno-8-51"></a><span class="c1">#    listen       8000;  //监听8000端口</span>
<a id="__codelineno-8-52" name="__codelineno-8-52"></a><span class="c1">#    listen       somename:8080;  //指定ip:port</span>
<a id="__codelineno-8-53" name="__codelineno-8-53"></a><span class="c1">#    server_name  somename  alias  another.alias;  //指定多个server_name</span>
<a id="__codelineno-8-54" name="__codelineno-8-54"></a>
<a id="__codelineno-8-55" name="__codelineno-8-55"></a><span class="c1">#    location / {</span>
<a id="__codelineno-8-56" name="__codelineno-8-56"></a><span class="c1">#        root   html;</span>
<a id="__codelineno-8-57" name="__codelineno-8-57"></a><span class="c1">#        index  index.html index.htm;</span>
<a id="__codelineno-8-58" name="__codelineno-8-58"></a><span class="c1">#    }</span>
<a id="__codelineno-8-59" name="__codelineno-8-59"></a><span class="c1">#}</span>
<a id="__codelineno-8-60" name="__codelineno-8-60"></a>
<a id="__codelineno-8-61" name="__codelineno-8-61"></a>
<a id="__codelineno-8-62" name="__codelineno-8-62"></a><span class="c1"># HTTPS server</span>
<a id="__codelineno-8-63" name="__codelineno-8-63"></a><span class="c1">#</span>
<a id="__codelineno-8-64" name="__codelineno-8-64"></a><span class="c1">#server {</span>
<a id="__codelineno-8-65" name="__codelineno-8-65"></a><span class="c1">#    listen       443 ssl;  //监听443端口，即ssl</span>
<a id="__codelineno-8-66" name="__codelineno-8-66"></a><span class="c1">#    server_name  localhost;</span>
<a id="__codelineno-8-67" name="__codelineno-8-67"></a>
<a id="__codelineno-8-68" name="__codelineno-8-68"></a><span class="c1">### 以下为ssl相关配置</span>
<a id="__codelineno-8-69" name="__codelineno-8-69"></a><span class="c1">#    ssl_certificate      cert.pem;    //指定pem文件路径</span>
<a id="__codelineno-8-70" name="__codelineno-8-70"></a><span class="c1">#    ssl_certificate_key  cert.key;  //指定key文件路径</span>
<a id="__codelineno-8-71" name="__codelineno-8-71"></a>
<a id="__codelineno-8-72" name="__codelineno-8-72"></a><span class="c1">#    ssl_session_cache    shared:SSL:1m;  //指定session cache大小</span>
<a id="__codelineno-8-73" name="__codelineno-8-73"></a><span class="c1">#    ssl_session_timeout  5m;  //指定session超时时间</span>
<a id="__codelineno-8-74" name="__codelineno-8-74"></a><span class="c1">#    ssl_protocols TLSv1 TLSv1.1 TLSv1.2;   //指定ssl协议</span>
<a id="__codelineno-8-75" name="__codelineno-8-75"></a><span class="c1">#    ssl_ciphers  HIGH:!aNULL:!MD5;  //指定ssl算法</span>
<a id="__codelineno-8-76" name="__codelineno-8-76"></a><span class="c1">#    ssl_prefer_server_ciphers  on;  //优先采取服务器算法</span>
<a id="__codelineno-8-77" name="__codelineno-8-77"></a><span class="c1">#    location / {</span>
<a id="__codelineno-8-78" name="__codelineno-8-78"></a><span class="c1">#        root   html;</span>
<a id="__codelineno-8-79" name="__codelineno-8-79"></a><span class="c1">#        index  index.html index.htm;</span>
<a id="__codelineno-8-80" name="__codelineno-8-80"></a><span class="c1">#    }</span>
<a id="__codelineno-8-81" name="__codelineno-8-81"></a><span class="c1">#}</span>
</code></pre></div></td></tr></table></div>
<h3 id="e范例">E.范例<a class="headerlink" href="#e范例" title="Permanent link">&para;</a></h3>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Nginx Configuration File</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-9-1">  1</a></span>
<span class="normal"><a href="#__codelineno-9-2">  2</a></span>
<span class="normal"><a href="#__codelineno-9-3">  3</a></span>
<span class="normal"><a href="#__codelineno-9-4">  4</a></span>
<span class="normal"><a href="#__codelineno-9-5">  5</a></span>
<span class="normal"><a href="#__codelineno-9-6">  6</a></span>
<span class="normal"><a href="#__codelineno-9-7">  7</a></span>
<span class="normal"><a href="#__codelineno-9-8">  8</a></span>
<span class="normal"><a href="#__codelineno-9-9">  9</a></span>
<span class="normal"><a href="#__codelineno-9-10"> 10</a></span>
<span class="normal"><a href="#__codelineno-9-11"> 11</a></span>
<span class="normal"><a href="#__codelineno-9-12"> 12</a></span>
<span class="normal"><a href="#__codelineno-9-13"> 13</a></span>
<span class="normal"><a href="#__codelineno-9-14"> 14</a></span>
<span class="normal"><a href="#__codelineno-9-15"> 15</a></span>
<span class="normal"><a href="#__codelineno-9-16"> 16</a></span>
<span class="normal"><a href="#__codelineno-9-17"> 17</a></span>
<span class="normal"><a href="#__codelineno-9-18"> 18</a></span>
<span class="normal"><a href="#__codelineno-9-19"> 19</a></span>
<span class="normal"><a href="#__codelineno-9-20"> 20</a></span>
<span class="normal"><a href="#__codelineno-9-21"> 21</a></span>
<span class="normal"><a href="#__codelineno-9-22"> 22</a></span>
<span class="normal"><a href="#__codelineno-9-23"> 23</a></span>
<span class="normal"><a href="#__codelineno-9-24"> 24</a></span>
<span class="normal"><a href="#__codelineno-9-25"> 25</a></span>
<span class="normal"><a href="#__codelineno-9-26"> 26</a></span>
<span class="normal"><a href="#__codelineno-9-27"> 27</a></span>
<span class="normal"><a href="#__codelineno-9-28"> 28</a></span>
<span class="normal"><a href="#__codelineno-9-29"> 29</a></span>
<span class="normal"><a href="#__codelineno-9-30"> 30</a></span>
<span class="normal"><a href="#__codelineno-9-31"> 31</a></span>
<span class="normal"><a href="#__codelineno-9-32"> 32</a></span>
<span class="normal"><a href="#__codelineno-9-33"> 33</a></span>
<span class="normal"><a href="#__codelineno-9-34"> 34</a></span>
<span class="normal"><a href="#__codelineno-9-35"> 35</a></span>
<span class="normal"><a href="#__codelineno-9-36"> 36</a></span>
<span class="normal"><a href="#__codelineno-9-37"> 37</a></span>
<span class="normal"><a href="#__codelineno-9-38"> 38</a></span>
<span class="normal"><a href="#__codelineno-9-39"> 39</a></span>
<span class="normal"><a href="#__codelineno-9-40"> 40</a></span>
<span class="normal"><a href="#__codelineno-9-41"> 41</a></span>
<span class="normal"><a href="#__codelineno-9-42"> 42</a></span>
<span class="normal"><a href="#__codelineno-9-43"> 43</a></span>
<span class="normal"><a href="#__codelineno-9-44"> 44</a></span>
<span class="normal"><a href="#__codelineno-9-45"> 45</a></span>
<span class="normal"><a href="#__codelineno-9-46"> 46</a></span>
<span class="normal"><a href="#__codelineno-9-47"> 47</a></span>
<span class="normal"><a href="#__codelineno-9-48"> 48</a></span>
<span class="normal"><a href="#__codelineno-9-49"> 49</a></span>
<span class="normal"><a href="#__codelineno-9-50"> 50</a></span>
<span class="normal"><a href="#__codelineno-9-51"> 51</a></span>
<span class="normal"><a href="#__codelineno-9-52"> 52</a></span>
<span class="normal"><a href="#__codelineno-9-53"> 53</a></span>
<span class="normal"><a href="#__codelineno-9-54"> 54</a></span>
<span class="normal"><a href="#__codelineno-9-55"> 55</a></span>
<span class="normal"><a href="#__codelineno-9-56"> 56</a></span>
<span class="normal"><a href="#__codelineno-9-57"> 57</a></span>
<span class="normal"><a href="#__codelineno-9-58"> 58</a></span>
<span class="normal"><a href="#__codelineno-9-59"> 59</a></span>
<span class="normal"><a href="#__codelineno-9-60"> 60</a></span>
<span class="normal"><a href="#__codelineno-9-61"> 61</a></span>
<span class="normal"><a href="#__codelineno-9-62"> 62</a></span>
<span class="normal"><a href="#__codelineno-9-63"> 63</a></span>
<span class="normal"><a href="#__codelineno-9-64"> 64</a></span>
<span class="normal"><a href="#__codelineno-9-65"> 65</a></span>
<span class="normal"><a href="#__codelineno-9-66"> 66</a></span>
<span class="normal"><a href="#__codelineno-9-67"> 67</a></span>
<span class="normal"><a href="#__codelineno-9-68"> 68</a></span>
<span class="normal"><a href="#__codelineno-9-69"> 69</a></span>
<span class="normal"><a href="#__codelineno-9-70"> 70</a></span>
<span class="normal"><a href="#__codelineno-9-71"> 71</a></span>
<span class="normal"><a href="#__codelineno-9-72"> 72</a></span>
<span class="normal"><a href="#__codelineno-9-73"> 73</a></span>
<span class="normal"><a href="#__codelineno-9-74"> 74</a></span>
<span class="normal"><a href="#__codelineno-9-75"> 75</a></span>
<span class="normal"><a href="#__codelineno-9-76"> 76</a></span>
<span class="normal"><a href="#__codelineno-9-77"> 77</a></span>
<span class="normal"><a href="#__codelineno-9-78"> 78</a></span>
<span class="normal"><a href="#__codelineno-9-79"> 79</a></span>
<span class="normal"><a href="#__codelineno-9-80"> 80</a></span>
<span class="normal"><a href="#__codelineno-9-81"> 81</a></span>
<span class="normal"><a href="#__codelineno-9-82"> 82</a></span>
<span class="normal"><a href="#__codelineno-9-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-9-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-9-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-9-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-9-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-9-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-9-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-9-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-9-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-9-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-9-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-9-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-9-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-9-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-9-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-9-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-9-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-9-100">100</a></span>
<span class="normal"><a href="#__codelineno-9-101">101</a></span>
<span class="normal"><a href="#__codelineno-9-102">102</a></span>
<span class="normal"><a href="#__codelineno-9-103">103</a></span>
<span class="normal"><a href="#__codelineno-9-104">104</a></span>
<span class="normal"><a href="#__codelineno-9-105">105</a></span>
<span class="normal"><a href="#__codelineno-9-106">106</a></span>
<span class="normal"><a href="#__codelineno-9-107">107</a></span>
<span class="normal"><a href="#__codelineno-9-108">108</a></span>
<span class="normal"><a href="#__codelineno-9-109">109</a></span>
<span class="normal"><a href="#__codelineno-9-110">110</a></span>
<span class="normal"><a href="#__codelineno-9-111">111</a></span>
<span class="normal"><a href="#__codelineno-9-112">112</a></span>
<span class="normal"><a href="#__codelineno-9-113">113</a></span>
<span class="normal"><a href="#__codelineno-9-114">114</a></span>
<span class="normal"><a href="#__codelineno-9-115">115</a></span>
<span class="normal"><a href="#__codelineno-9-116">116</a></span>
<span class="normal"><a href="#__codelineno-9-117">117</a></span>
<span class="normal"><a href="#__codelineno-9-118">118</a></span>
<span class="normal"><a href="#__codelineno-9-119">119</a></span>
<span class="normal"><a href="#__codelineno-9-120">120</a></span>
<span class="normal"><a href="#__codelineno-9-121">121</a></span>
<span class="normal"><a href="#__codelineno-9-122">122</a></span>
<span class="normal"><a href="#__codelineno-9-123">123</a></span>
<span class="normal"><a href="#__codelineno-9-124">124</a></span>
<span class="normal"><a href="#__codelineno-9-125">125</a></span>
<span class="normal"><a href="#__codelineno-9-126">126</a></span>
<span class="normal"><a href="#__codelineno-9-127">127</a></span>
<span class="normal"><a href="#__codelineno-9-128">128</a></span>
<span class="normal"><a href="#__codelineno-9-129">129</a></span>
<span class="normal"><a href="#__codelineno-9-130">130</a></span>
<span class="normal"><a href="#__codelineno-9-131">131</a></span>
<span class="normal"><a href="#__codelineno-9-132">132</a></span>
<span class="normal"><a href="#__codelineno-9-133">133</a></span>
<span class="normal"><a href="#__codelineno-9-134">134</a></span>
<span class="normal"><a href="#__codelineno-9-135">135</a></span>
<span class="normal"><a href="#__codelineno-9-136">136</a></span>
<span class="normal"><a href="#__codelineno-9-137">137</a></span>
<span class="normal"><a href="#__codelineno-9-138">138</a></span>
<span class="normal"><a href="#__codelineno-9-139">139</a></span>
<span class="normal"><a href="#__codelineno-9-140">140</a></span>
<span class="normal"><a href="#__codelineno-9-141">141</a></span>
<span class="normal"><a href="#__codelineno-9-142">142</a></span>
<span class="normal"><a href="#__codelineno-9-143">143</a></span>
<span class="normal"><a href="#__codelineno-9-144">144</a></span>
<span class="normal"><a href="#__codelineno-9-145">145</a></span>
<span class="normal"><a href="#__codelineno-9-146">146</a></span>
<span class="normal"><a href="#__codelineno-9-147">147</a></span>
<span class="normal"><a href="#__codelineno-9-148">148</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-9-1" name="__codelineno-9-1"></a><span class="k">user</span><span class="w"> </span><span class="s">nobody</span><span class="p">;</span><span class="w"> </span><span class="c1"># 定义运行nginx服务的用户,还可以加上组,如 user nobody nobody</span>
<a id="__codelineno-9-2" name="__codelineno-9-2"></a>
<a id="__codelineno-9-3" name="__codelineno-9-3"></a><span class="k">worker_processes</span><span class="w">  </span><span class="mi">8</span><span class="p">;</span><span class="w"> </span><span class="c1">#开启8个工作进程</span>
<a id="__codelineno-9-4" name="__codelineno-9-4"></a><span class="k">worker_cpu_affinity</span><span class="w"> </span><span class="mi">00000001</span><span class="w"> </span><span class="mi">00000010</span><span class="w"> </span><span class="mi">00000100</span><span class="w"> </span><span class="mi">00001000</span><span class="w"> </span><span class="mi">00010000</span><span class="w"> </span><span class="mi">00100000</span><span class="w"> </span><span class="mi">01000000</span><span class="w"> </span><span class="mi">10000000</span><span class="p">;</span><span class="w"> </span><span class="c1">#将8个工作进程固定在8个cpu上</span>
<a id="__codelineno-9-5" name="__codelineno-9-5"></a>
<a id="__codelineno-9-6" name="__codelineno-9-6"></a><span class="c1">#以下为4核CPU的范例</span>
<a id="__codelineno-9-7" name="__codelineno-9-7"></a><span class="c1">#worker_processes  4;</span>
<a id="__codelineno-9-8" name="__codelineno-9-8"></a><span class="c1">#worker_cpu_affinity 0001 0010 0100 1000;</span>
<a id="__codelineno-9-9" name="__codelineno-9-9"></a>
<a id="__codelineno-9-10" name="__codelineno-9-10"></a><span class="k">error_log</span><span class="w"> </span><span class="s">logs/error.log</span><span class="w"> </span><span class="s">crit</span><span class="p">;</span><span class="w"> </span><span class="c1">#定义错误日志的路径和级别。错误日志级别：常见的错误日志级别有[debug|info|notice|warn|error|crit|alert|emerg]，级别越高记录的信息越少。</span>
<a id="__codelineno-9-11" name="__codelineno-9-11"></a>
<a id="__codelineno-9-12" name="__codelineno-9-12"></a><span class="k">pid</span><span class="w"> </span><span class="s">logs/nginx.pid</span><span class="p">;</span><span class="w"> </span><span class="c1">#定义nginx进程pid文件所在路径，可以是相对路径，也可以是绝对路径。</span>
<a id="__codelineno-9-13" name="__codelineno-9-13"></a>
<a id="__codelineno-9-14" name="__codelineno-9-14"></a><span class="k">worker_rlimit_nofile</span><span class="w"> </span><span class="mi">1024000</span><span class="p">;</span><span class="w"> </span><span class="c1">#定义nginx最多打开文件数限制。如果没设置的话，这个值为操作系统（ulimit -n）的限制保持一致。</span>
<a id="__codelineno-9-15" name="__codelineno-9-15"></a>
<a id="__codelineno-9-16" name="__codelineno-9-16"></a><span class="k">events</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-9-17" name="__codelineno-9-17"></a>
<a id="__codelineno-9-18" name="__codelineno-9-18"></a><span class="w">    </span><span class="kn">use</span><span class="w"> </span><span class="s">epoll</span><span class="p">;</span><span class="w"> </span><span class="c1">#Nginx服务器提供了多个事件驱动器模型来处理网络消息。epol这种方式是在Linux 2.6+内核中最高效的方式</span>
<a id="__codelineno-9-19" name="__codelineno-9-19"></a><span class="w">    </span><span class="kn">worker_connections</span><span class="w">  </span><span class="mi">65535</span><span class="p">;</span><span class="w"> </span><span class="c1">#定义每个work_process同时开启的最大连接数，即允许最多只能有这么多连接。</span>
<a id="__codelineno-9-20" name="__codelineno-9-20"></a><span class="w">    </span><span class="kn">accept_mutex</span><span class="w"> </span><span class="no">on</span><span class="p">;</span><span class="w"> </span><span class="c1">#当某一个时刻只有一个网络连接请求服务器时，服务器上有多个睡眠的进程会被同时叫醒，这样会损耗一定的服务器性能。Nginx中的accept_mutex设置为on，将会对多个Nginx进程（worker processer）接收连接时进行序列化，防止多个进程争抢资源。</span>
<a id="__codelineno-9-21" name="__codelineno-9-21"></a><span class="w">    </span><span class="kn">multi_accept</span><span class="w"> </span><span class="no">on</span><span class="p">;</span><span class="w"> </span><span class="c1">#nginx worker processer可以做到同时接收多个新到达的网络连接，前提是把该参数设置为on。默认为off，即每个worker process一次只能接收一个新到达的网络连接。</span>
<a id="__codelineno-9-22" name="__codelineno-9-22"></a><span class="p">}</span><span class="w"> </span>
<a id="__codelineno-9-23" name="__codelineno-9-23"></a>
<a id="__codelineno-9-24" name="__codelineno-9-24"></a><span class="k">http</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-9-25" name="__codelineno-9-25"></a><span class="w">    </span><span class="kn">include</span><span class="w">        </span><span class="s">/etc/nginx/mime.types</span><span class="p">;</span><span class="w"> </span><span class="c1"># 定义nginx能识别的网络资源媒体类型（如，文本、html、js、css、流媒体等</span>
<a id="__codelineno-9-26" name="__codelineno-9-26"></a><span class="w">    </span><span class="kn">default_type</span><span class="w">  </span><span class="s">application/octet-stream</span><span class="p">;</span><span class="w"> </span><span class="c1">#定义默认的type，如果不定义该项，默认为text/plain.</span>
<a id="__codelineno-9-27" name="__codelineno-9-27"></a><span class="w">    </span><span class="kn">client_max_body_size</span><span class="w"> </span><span class="s">1024M</span><span class="p">;</span><span class="w"> </span><span class="c1">#定义允许最大可以上传多大的文件，超过该值就会报413</span>
<a id="__codelineno-9-28" name="__codelineno-9-28"></a><span class="w">    </span><span class="kn">log_format</span><span class="w"> </span><span class="s">main</span><span class="w">  </span><span class="s">&#39;</span><span class="nv">$remote_addr</span><span class="w"> </span><span class="nv">$http_x_forwarded_for</span><span class="w"> </span><span class="s">[</span><span class="nv">$time_local]&#39;</span>
<a id="__codelineno-9-29" name="__codelineno-9-29"></a><span class="w">    </span><span class="s">&#39;</span><span class="nv">$host</span><span class="w"> </span><span class="s">&quot;</span><span class="nv">$request_uri&quot;</span><span class="w"> </span><span class="nv">$status&#39;</span>
<a id="__codelineno-9-30" name="__codelineno-9-30"></a><span class="w">    </span><span class="s">&#39;&quot;</span><span class="nv">$http_referer&quot;</span><span class="w"> </span><span class="s">&quot;</span><span class="nv">$http_user_agent&quot;&#39;</span><span class="p">;</span>
<a id="__codelineno-9-31" name="__codelineno-9-31"></a><span class="w">    </span><span class="c1">#这里定义日志的格式，其中main为日志格式的名字，后面的为nginx的内部变量组成的一串字符串。</span>
<a id="__codelineno-9-32" name="__codelineno-9-32"></a><span class="w">    </span><span class="kn">sendfile</span><span class="w">        </span><span class="no">on</span><span class="p">;</span><span class="w"> </span><span class="c1">#使用内核的FD文件传输功能，可以减少user mode和kernel mode的切换，从而提升服务器性能。</span>
<a id="__codelineno-9-33" name="__codelineno-9-33"></a><span class="w">    </span><span class="kn">sendfile_max_chunk</span><span class="w"> </span><span class="mi">128k</span><span class="p">;</span><span class="w"> </span><span class="c1">#该参数限定Nginx worker process每次调用sendfile()函数传输数据的最大值，默认值为0，如果设置为0则无限制。</span>
<a id="__codelineno-9-34" name="__codelineno-9-34"></a><span class="w">    </span><span class="kn">tcp_nopush</span><span class="w">      </span><span class="no">on</span><span class="p">;</span><span class="w"> </span><span class="c1">#设置为on时，会调用tcp_cork方法进行数据传输。当应用程序产生数据时，内核不会立马封装包，而是当数据量积累到一定量时才会封装，然后传输。</span>
<a id="__codelineno-9-35" name="__codelineno-9-35"></a><span class="w">    </span><span class="kn">tcp_nodelay</span><span class="w">     </span><span class="no">on</span><span class="p">;</span><span class="w"> </span><span class="c1">#不缓存data-sends（关闭 Nagle 算法），这个能够提高高频发送小数据报文的实时性。</span>
<a id="__codelineno-9-36" name="__codelineno-9-36"></a><span class="w">    </span><span class="kn">server_tokens</span><span class="w">   </span><span class="no">off</span><span class="p">;</span><span class="c1">#将Nginx版本信息关闭，提升安全性。</span>
<a id="__codelineno-9-37" name="__codelineno-9-37"></a><span class="w">    </span><span class="kn">keepalive_timeout</span><span class="w"> </span><span class="mi">65</span><span class="w"> </span><span class="mi">60</span><span class="p">;</span><span class="w"> </span><span class="c1">#该参数有两个值，第一个值设置nginx服务器与客户端会话结束后仍旧保持连接的最长时间，单位是秒，默认为75s。第二个值可以省略，它是针对客户端的浏览器来设置的，可以通过curl -I看到header信息中有一项Keep-Alive: timeout=60，如果不设置就没有这一项。第二个数值设置后，浏览器就会根据这个数值决定何时主动关闭连接，Nginx服务器就不操心了。但有的浏览器并不认可该参数。</span>
<a id="__codelineno-9-38" name="__codelineno-9-38"></a><span class="w">    </span><span class="kn">send_timeout</span><span class="w"> </span><span class="mi">10</span><span class="p">;</span><span class="w"> </span><span class="c1">#这个超时时间是发送响应的超时时间，即Nginx服务器向客户端发送了数据包，但客户端一直没有去接收这个数据包。如果某个连接超过send_timeout定义的超时时间，那么Nginx将会关闭这个连接。</span>
<a id="__codelineno-9-39" name="__codelineno-9-39"></a><span class="w">    </span><span class="kn">client_header_timeout</span><span class="w"> </span><span class="mi">15</span><span class="p">;</span><span class="w"> </span><span class="c1">#客户端如果在该指定时间内没有加载完头部数据，则断开连接，单位是秒，默认60，可以设置为15。</span>
<a id="__codelineno-9-40" name="__codelineno-9-40"></a><span class="w">    </span><span class="kn">client_body_timeout</span><span class="w"> </span><span class="mi">120</span><span class="p">;</span><span class="w">  </span><span class="c1">#客户端如果在该指定时间内没有加载完body数据，则断开连接，单位是秒，默认60，建议大一点，因为有时候下载大文件时间会比较久。</span>
<a id="__codelineno-9-41" name="__codelineno-9-41"></a><span class="w">    </span><span class="kn">client_body_buffer_size</span><span class="w"> </span><span class="mi">128k</span><span class="p">;</span><span class="w"> </span><span class="c1">#当客户端以POST方法提交一些数据到服务端时，会先写入到client_body_buffer中，如果buffer写满会写到临时文件里。</span>
<a id="__codelineno-9-42" name="__codelineno-9-42"></a><span class="w">    </span><span class="kn">client_header_buffer_size</span><span class="w"> </span><span class="mi">4k</span><span class="p">;</span><span class="w"> </span><span class="c1">#客户端请求头部的缓冲区大小，这个可以根据你的系统分页大小来设置，一般一个请求头的大小不会超过1k，不过由于一般系统分页都要大于1k,所以还是要大一些。</span>
<a id="__codelineno-9-43" name="__codelineno-9-43"></a><span class="w">    </span><span class="kn">large_client_header_buffers</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="mi">8k</span><span class="p">;</span><span class="w"> </span><span class="c1">#对于比较大的header（超过client_header_buffer_size）将会使用该部分buffer，两个数值，第一个是个数，第二个是每个buffer的大小。</span>
<a id="__codelineno-9-44" name="__codelineno-9-44"></a><span class="w">    </span><span class="kn">open_file_cache</span><span class="w"> </span><span class="s">max=204800</span><span class="w"> </span><span class="s">inactive=20s</span><span class="p">;</span><span class="w"> </span><span class="c1">#max设定缓存文件的数量，inactive设定经过多长时间文件没被请求后删除缓存。</span>
<a id="__codelineno-9-45" name="__codelineno-9-45"></a><span class="w">    </span><span class="kn">open_file_cache_min_uses</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="c1">#open_file_cache指令中的inactive参数时间内文件的最少使用次数，如,将该参数设置为1，则表示，如果文件在inactive时间内一次都没被使用，它将被移除。</span>
<a id="__codelineno-9-46" name="__codelineno-9-46"></a><span class="w">    </span><span class="kn">open_file_cache_valid</span><span class="w"> </span><span class="s">30s</span><span class="p">;</span><span class="w"> </span><span class="c1">#指多长时间检查一次缓存的有效信息。建议设置为30s。</span>
<a id="__codelineno-9-47" name="__codelineno-9-47"></a>
<a id="__codelineno-9-48" name="__codelineno-9-48"></a><span class="w">    </span><span class="kn">gzip</span><span class="w"> </span><span class="no">on</span><span class="p">;</span><span class="w">  </span><span class="c1">#开启gzip功能</span>
<a id="__codelineno-9-49" name="__codelineno-9-49"></a><span class="w">    </span><span class="kn">gzip_min_length</span><span class="w"> </span><span class="mi">1024</span><span class="p">;</span><span class="w">  </span><span class="c1">#设置请求资源超过该数值才进行压缩，单位字节</span>
<a id="__codelineno-9-50" name="__codelineno-9-50"></a><span class="w">    </span><span class="kn">gzip_buffers</span><span class="w"> </span><span class="mi">16</span><span class="w"> </span><span class="mi">8k</span><span class="p">;</span><span class="w"> </span><span class="c1">#设置压缩使用的buffer大小，第一个数字为数量，第二个为每个buffer的大小</span>
<a id="__codelineno-9-51" name="__codelineno-9-51"></a><span class="w">    </span><span class="kn">gzip_comp_level</span><span class="w"> </span><span class="mi">6</span><span class="p">;</span><span class="w"> </span><span class="c1">#设置压缩级别，范围1-9,9压缩级别最高，也最耗费CPU资源</span>
<a id="__codelineno-9-52" name="__codelineno-9-52"></a><span class="w">    </span><span class="kn">gzip_types</span><span class="w"> </span><span class="s">text/plain</span><span class="w"> </span><span class="s">text/xhtml</span><span class="w"> </span><span class="s">text/css</span><span class="w"> </span><span class="s">text/js</span><span class="w"> </span><span class="s">text/csv</span><span class="w"> </span><span class="s">application/javascript</span><span class="w"> </span><span class="s">application/x-javascript</span><span class="w"> </span><span class="s">application/json</span><span class="w"> </span><span class="s">application/xml</span><span class="w"> </span><span class="s">text/xml</span><span class="w"> </span><span class="s">application/atom+xml</span><span class="w"> </span><span class="s">application/rss+xml</span><span class="w"> </span><span class="s">application/vnd.android.package-archive</span><span class="w"> </span><span class="s">application/vnd.iphone</span><span class="p">;</span><span class="w"> </span><span class="c1">#指定哪些类型的文件需要压缩</span>
<a id="__codelineno-9-53" name="__codelineno-9-53"></a><span class="w">    </span><span class="kn">gzip_disable</span><span class="w"> </span><span class="s">&quot;MSIE</span><span class="w"> </span><span class="mi">6</span><span class="s">\.&quot;</span><span class="p">;</span><span class="w"> </span><span class="c1">#IE6浏览器不启用压缩</span>
<a id="__codelineno-9-54" name="__codelineno-9-54"></a><span class="w">    </span><span class="kn">gzip_proxied</span><span class="w"> </span><span class="s">any</span><span class="p">;</span><span class="w"> </span><span class="c1">#Nginx作为反向代理的时候启用，决定开启或者关闭后端服务器返回的结果是否压缩，匹配的前提是后端服务器必须要返回包含”Via”的 header头。</span>
<a id="__codelineno-9-55" name="__codelineno-9-55"></a>
<a id="__codelineno-9-56" name="__codelineno-9-56"></a><span class="w">    </span><span class="kn">include</span><span class="w"> </span><span class="s">conf.d/*.conf</span><span class="p">;</span><span class="w"> </span><span class="c1">#要加载conf.d/下的所有.conf配置文件</span>
<a id="__codelineno-9-57" name="__codelineno-9-57"></a><span class="p">}</span>
<a id="__codelineno-9-58" name="__codelineno-9-58"></a>
<a id="__codelineno-9-59" name="__codelineno-9-59"></a>
<a id="__codelineno-9-60" name="__codelineno-9-60"></a><span class="c1">##以下为conf.d/example.conf的内容</span>
<a id="__codelineno-9-61" name="__codelineno-9-61"></a><span class="k">server</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-9-62" name="__codelineno-9-62"></a>
<a id="__codelineno-9-63" name="__codelineno-9-63"></a><span class="w">    </span><span class="kn">listen</span><span class="w">      </span><span class="mi">443</span><span class="p">;</span><span class="w">  </span><span class="c1">#监听端口为443，可以自定义其他端口，也可以加上IP地址，如，listen 127.0.0.1:8080;</span>
<a id="__codelineno-9-64" name="__codelineno-9-64"></a><span class="w">    </span><span class="kn">server_name</span><span class="w">  </span><span class="s">aaa.com</span><span class="w"> </span><span class="s">aaa.net</span><span class="p">;</span><span class="w"> </span><span class="c1">#定义网站域名，可以写多个，用空格分隔。</span>
<a id="__codelineno-9-65" name="__codelineno-9-65"></a><span class="w">    </span><span class="c1">#以下配置为开启ssl认证</span>
<a id="__codelineno-9-66" name="__codelineno-9-66"></a><span class="w">    </span><span class="kn">ssl_certificate</span><span class="w"> </span><span class="s">sslkey/www.crt</span><span class="p">;</span><span class="w"> </span><span class="c1">#指定crt文件路径</span>
<a id="__codelineno-9-67" name="__codelineno-9-67"></a><span class="w">    </span><span class="kn">ssl_certificate_key</span><span class="w"> </span><span class="s">sslkey/www.key</span><span class="p">;</span><span class="w"> </span><span class="c1">#指定私钥文件路径</span>
<a id="__codelineno-9-68" name="__codelineno-9-68"></a><span class="w">    </span><span class="kn">ssl_session_cache</span><span class="w">   </span><span class="s">shared:SSL:10m</span><span class="p">;</span><span class="w"> </span><span class="c1">#设置ssl会话使用的缓存为10M</span>
<a id="__codelineno-9-69" name="__codelineno-9-69"></a><span class="w">    </span><span class="kn">ssl_session_timeout</span><span class="w"> </span><span class="mi">10m</span><span class="p">;</span><span class="w"> </span><span class="c1">#ssl会话超时时间为10分钟</span>
<a id="__codelineno-9-70" name="__codelineno-9-70"></a><span class="w">    </span><span class="kn">ssl_protocols</span><span class="w"> </span><span class="s">TLSv1.1</span><span class="w"> </span><span class="s">TLSv1.2</span><span class="p">;</span><span class="w"> </span><span class="c1">#ssl版本，不要加1.0了，1.0不安全</span>
<a id="__codelineno-9-71" name="__codelineno-9-71"></a><span class="w">    </span><span class="kn">ssl_ciphers</span><span class="w"> </span><span class="s">AES256-SHA256:AES128-SHA256:AES256-SHA:AES128-SHA:!aNULL:!eNULL:!MD5:!DH:!ECDH:!DHE:!ECDHE:!RC4:!EXPORT</span><span class="p">;</span><span class="w"> </span><span class="c1">#开启或者关闭指定算法,这些是安全漏洞工具建议的配置</span>
<a id="__codelineno-9-72" name="__codelineno-9-72"></a><span class="w">    </span><span class="kn">ssl_prefer_server_ciphers</span><span class="w"> </span><span class="no">on</span><span class="p">;</span><span class="w"> </span><span class="c1">#如果不指定默认为off，当为on时，服务器加密算法将优于客户端加密算法。</span>
<a id="__codelineno-9-73" name="__codelineno-9-73"></a>
<a id="__codelineno-9-74" name="__codelineno-9-74"></a><span class="w">    </span><span class="kn">access_log</span><span class="w">  </span><span class="s">logs/host.access.log</span><span class="w">  </span><span class="s">main</span><span class="p">;</span><span class="w"> </span><span class="c1">#定义访问日志，可以针对每一个server（即每一个站点）设置它们自己的访问日志。</span>
<a id="__codelineno-9-75" name="__codelineno-9-75"></a>
<a id="__codelineno-9-76" name="__codelineno-9-76"></a><span class="w">    </span><span class="c1">##在server{}里有很多location配置段</span>
<a id="__codelineno-9-77" name="__codelineno-9-77"></a><span class="w">    </span><span class="kn">location</span><span class="w"> </span><span class="s">/</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-9-78" name="__codelineno-9-78"></a><span class="w">        </span><span class="kn">root</span><span class="w">   </span><span class="s">html</span><span class="p">;</span><span class="w">  </span><span class="c1">#定义网站根目录，目录可以是相对路径也可以是绝对路径。</span>
<a id="__codelineno-9-79" name="__codelineno-9-79"></a><span class="w">        </span><span class="kn">index</span><span class="w">  </span><span class="s">index.html</span><span class="w"> </span><span class="s">index.htm</span><span class="p">;</span><span class="w"> </span><span class="c1">#定义站点的默认页。</span>
<a id="__codelineno-9-80" name="__codelineno-9-80"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-9-81" name="__codelineno-9-81"></a>
<a id="__codelineno-9-82" name="__codelineno-9-82"></a><span class="w">    </span><span class="kn">error_page</span><span class="w">  </span><span class="mi">404</span><span class="w">              </span><span class="s">/404.html</span><span class="p">;</span><span class="w">  </span><span class="c1">#定义404页面</span>
<a id="__codelineno-9-83" name="__codelineno-9-83"></a><span class="w">    </span><span class="kn">error_page</span><span class="w">   </span><span class="mi">500</span><span class="w"> </span><span class="mi">502</span><span class="w"> </span><span class="mi">503</span><span class="w"> </span><span class="mi">504</span><span class="w">  </span><span class="s">/50x.html</span><span class="p">;</span><span class="w">  </span><span class="c1">#当状态码为500、502、503、504时，则访问50x.html</span>
<a id="__codelineno-9-84" name="__codelineno-9-84"></a><span class="w">    </span><span class="kn">location</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">/50x.html</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-9-85" name="__codelineno-9-85"></a><span class="w">        </span><span class="kn">root</span><span class="w">   </span><span class="s">html</span><span class="p">;</span><span class="w">  </span><span class="c1">#定义50x.html所在路径</span>
<a id="__codelineno-9-86" name="__codelineno-9-86"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-9-87" name="__codelineno-9-87"></a>
<a id="__codelineno-9-88" name="__codelineno-9-88"></a><span class="w">    </span><span class="c1">#定义哪些目录下的php不能访问，一般要限制所有可写的目录下的php</span>
<a id="__codelineno-9-89" name="__codelineno-9-89"></a><span class="w">    </span><span class="kn">location</span><span class="w"> </span><span class="p">~</span><span class="w"> </span><span class="sr">.*(data|config|template|attachments|forumdata|attachment|images|log|conf|cache)/.*\.php$</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-9-90" name="__codelineno-9-90"></a><span class="w">        </span><span class="kn">deny</span><span class="w"> </span><span class="s">all</span><span class="p">;</span>
<a id="__codelineno-9-91" name="__codelineno-9-91"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-9-92" name="__codelineno-9-92"></a>
<a id="__codelineno-9-93" name="__codelineno-9-93"></a><span class="w">    </span><span class="c1">#设置防盗链，不记录日志，缓存过期时间为7天</span>
<a id="__codelineno-9-94" name="__codelineno-9-94"></a><span class="w">    </span><span class="kn">location</span><span class="w"> </span><span class="p">~</span><span class="sr">*</span><span class="w"> </span><span class="s">^.+\.(swf|jpg|gif|bmp|png|jpeg|zip|rar)</span>$<span class="w"> </span><span class="p">{</span>
<a id="__codelineno-9-95" name="__codelineno-9-95"></a><span class="w">         </span><span class="kn">expires</span><span class="w"> </span><span class="s">7d</span><span class="p">;</span>
<a id="__codelineno-9-96" name="__codelineno-9-96"></a><span class="w">         </span><span class="kn">access_log</span><span class="w"> </span><span class="s">/dev/null</span><span class="p">;</span>
<a id="__codelineno-9-97" name="__codelineno-9-97"></a><span class="w">         </span><span class="kn">valid_referers</span><span class="w"> </span><span class="s">none</span><span class="w"> </span><span class="s">blocked</span><span class="w"> </span><span class="s">server_names</span><span class="w"> </span><span class="s">*.aaa.net</span><span class="w"> </span><span class="s">*.aaa.com</span><span class="p">;</span>
<a id="__codelineno-9-98" name="__codelineno-9-98"></a><span class="w">         </span><span class="kn">if</span><span class="w"> </span><span class="s">(</span><span class="nv">$invalid_referer</span><span class="s">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-9-99" name="__codelineno-9-99"></a><span class="w">              </span><span class="kn">return</span><span class="w"> </span><span class="mi">403</span><span class="p">;</span>
<a id="__codelineno-9-100" name="__codelineno-9-100"></a><span class="w">         </span><span class="p">}</span>
<a id="__codelineno-9-101" name="__codelineno-9-101"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-9-102" name="__codelineno-9-102"></a><span class="w">    </span><span class="c1">#js、css不记录日志，缓存过期时间为7天</span>
<a id="__codelineno-9-103" name="__codelineno-9-103"></a><span class="w">    </span><span class="kn">location</span><span class="w"> </span><span class="p">~</span><span class="w"> </span><span class="sr">.*\.(js|css)$</span>
<a id="__codelineno-9-104" name="__codelineno-9-104"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-9-105" name="__codelineno-9-105"></a><span class="w">            </span><span class="kn">expires</span><span class="w">      </span><span class="s">7d</span><span class="p">;</span>
<a id="__codelineno-9-106" name="__codelineno-9-106"></a><span class="w">            </span><span class="kn">access_log</span><span class="w"> </span><span class="no">off</span><span class="p">;</span>
<a id="__codelineno-9-107" name="__codelineno-9-107"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-9-108" name="__codelineno-9-108"></a>
<a id="__codelineno-9-109" name="__codelineno-9-109"></a><span class="w">    </span><span class="c1">#针对php的配置</span>
<a id="__codelineno-9-110" name="__codelineno-9-110"></a><span class="w">    </span><span class="kn">location</span><span class="w"> </span><span class="p">~</span><span class="w"> </span><span class="sr">\.php$</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-9-111" name="__codelineno-9-111"></a><span class="w">            </span><span class="c1">#fastcgi_pass   unix:/tmp/55188_71-fpm.sock;</span>
<a id="__codelineno-9-112" name="__codelineno-9-112"></a><span class="w">            </span><span class="kn">fastcgi_pass</span><span class="w">   </span><span class="n">127.0.0.1</span><span class="p">:</span><span class="mi">9005</span><span class="p">;</span><span class="w"> </span><span class="c1">#这个是php-fpm的监听端口，nginx会把php的请求转发给php-fpm处理</span>
<a id="__codelineno-9-113" name="__codelineno-9-113"></a><span class="w">            </span><span class="kn">fastcgi_index</span><span class="w">  </span><span class="s">index.php</span><span class="p">;</span>
<a id="__codelineno-9-114" name="__codelineno-9-114"></a><span class="w">            </span><span class="kn">fastcgi_param</span><span class="w">  </span><span class="s">SCRIPT_FILENAME</span><span class="w">  </span><span class="nv">$document_root$fastcgi_script_name</span><span class="p">;</span>
<a id="__codelineno-9-115" name="__codelineno-9-115"></a><span class="w">            </span><span class="kn">fastcgi_param</span><span class="w">  </span><span class="s">X-Real-IP</span><span class="w"> </span><span class="nv">$remote_addr</span><span class="p">;</span>
<a id="__codelineno-9-116" name="__codelineno-9-116"></a><span class="w">            </span><span class="kn">include</span><span class="w">        </span><span class="s">fastcgi_params</span><span class="p">;</span>
<a id="__codelineno-9-117" name="__codelineno-9-117"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-9-118" name="__codelineno-9-118"></a>
<a id="__codelineno-9-119" name="__codelineno-9-119"></a><span class="w">    </span><span class="c1">#针对admin.php做限制</span>
<a id="__codelineno-9-120" name="__codelineno-9-120"></a><span class="w">    </span><span class="kn">location</span><span class="w">  </span><span class="s">/admin.php</span><span class="w"> </span>
<a id="__codelineno-9-121" name="__codelineno-9-121"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-9-122" name="__codelineno-9-122"></a><span class="w">    </span><span class="kn">allow</span><span class="w"> </span><span class="mi">12</span><span class="s">.13.12.12</span><span class="p">;</span><span class="w"> </span><span class="c1">#允许的ip</span>
<a id="__codelineno-9-123" name="__codelineno-9-123"></a><span class="w">        </span><span class="kn">allow</span><span class="w"> </span><span class="mi">22</span><span class="s">.22.22.0/24</span><span class="p">;</span><span class="w"> </span><span class="c1">#允许的ip段</span>
<a id="__codelineno-9-124" name="__codelineno-9-124"></a><span class="w">        </span><span class="kn">deny</span><span class="w"> </span><span class="s">all</span><span class="p">;</span>
<a id="__codelineno-9-125" name="__codelineno-9-125"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-9-126" name="__codelineno-9-126"></a>
<a id="__codelineno-9-127" name="__codelineno-9-127"></a><span class="p">}</span>
<a id="__codelineno-9-128" name="__codelineno-9-128"></a>
<a id="__codelineno-9-129" name="__codelineno-9-129"></a><span class="c1">## 反向代理示例</span>
<a id="__codelineno-9-130" name="__codelineno-9-130"></a><span class="k">server</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-9-131" name="__codelineno-9-131"></a><span class="w">    </span><span class="kn">listen</span><span class="w"> </span><span class="mi">80</span><span class="p">;</span>
<a id="__codelineno-9-132" name="__codelineno-9-132"></a><span class="w">    </span><span class="kn">server_name</span><span class="w"> </span><span class="s">bbb.com</span><span class="p">;</span>
<a id="__codelineno-9-133" name="__codelineno-9-133"></a><span class="w">    </span><span class="kn">proxy_buffering</span><span class="w"> </span><span class="no">on</span><span class="p">;</span><span class="w"> </span><span class="c1">#该参数设置是否开启proxy的buffer功能, 如果这个设置为off，那么proxy_buffers和proxy_busy_buffers_size这两个指令将会失效</span>
<a id="__codelineno-9-134" name="__codelineno-9-134"></a><span class="w">    </span><span class="kn">proxy_buffer_size</span><span class="w"> </span><span class="mi">4k</span><span class="p">;</span><span class="w"> </span><span class="c1">#该参数用来设置header缓存的大小，不能低于4k</span>
<a id="__codelineno-9-135" name="__codelineno-9-135"></a><span class="w">    </span><span class="kn">proxy_buffers</span><span class="w"> </span><span class="mi">8</span><span class="w"> </span><span class="mi">4k</span><span class="p">;</span><span class="w"> </span><span class="c1">#这个参数设置存储被代理服务器上的数据所占用的buffer的个数和每个buffer的大小。</span>
<a id="__codelineno-9-136" name="__codelineno-9-136"></a><span class="w">    </span><span class="kn">proxy_busy_buffers_size</span><span class="w"> </span><span class="mi">16k</span><span class="p">;</span><span class="w"> </span><span class="c1">#在所有的buffer里，我们需要规定一部分buffer把自己存的数据传给A，这部分buffer就叫做busy_buffer，该参数用来设置处于busy状态的buffer有多大。</span>
<a id="__codelineno-9-137" name="__codelineno-9-137"></a><span class="w">    </span><span class="kn">proxy_temp_path</span><span class="w"> </span><span class="s">/tmp/nginx_proxy_tmp</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span><span class="w"> </span><span class="c1">#定义proxy的临时文件存在目录以及目录的层级，1表示层级1的目录名为一个数字(0-9),2表示层级2目录名为2个数字(00-99)</span>
<a id="__codelineno-9-138" name="__codelineno-9-138"></a><span class="w">    </span><span class="kn">proxy_max_temp_file_size</span><span class="w"> </span><span class="s">100M</span><span class="p">;</span><span class="w"> </span><span class="c1">#设置临时文件的总大小</span>
<a id="__codelineno-9-139" name="__codelineno-9-139"></a><span class="w">    </span><span class="kn">proxy_temp_file_write_size</span><span class="w"> </span><span class="mi">16k</span><span class="p">;</span><span class="w"> </span><span class="c1">#设置同时写入临时文件的数据量的总大小</span>
<a id="__codelineno-9-140" name="__codelineno-9-140"></a>
<a id="__codelineno-9-141" name="__codelineno-9-141"></a><span class="w">    </span><span class="kn">location</span><span class="w"> </span><span class="s">/</span>
<a id="__codelineno-9-142" name="__codelineno-9-142"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-9-143" name="__codelineno-9-143"></a><span class="w">        </span><span class="kn">proxy_pass</span><span class="w"> </span><span class="s">http://123.23.13.11/</span><span class="p">;</span><span class="w"> </span><span class="c1">#后端服务器的ip地址</span>
<a id="__codelineno-9-144" name="__codelineno-9-144"></a><span class="w">        </span><span class="kn">proxy_set_header</span><span class="w"> </span><span class="s">Host</span><span class="w">   </span><span class="nv">$host</span><span class="p">;</span><span class="w"> </span><span class="c1">#访问后端服务器时，用哪个域名访问呢，这里的$host就是server_name。</span>
<a id="__codelineno-9-145" name="__codelineno-9-145"></a><span class="w">        </span><span class="kn">proxy_set_header</span><span class="w"> </span><span class="s">X-Real-IP</span><span class="w">      </span><span class="nv">$remote_addr</span><span class="p">;</span><span class="w"> </span><span class="c1"># 用来设置被代理端接收到的远程客户端IP，如果不设置，则header信息中并不会透传远程真实客户端的IP地址。</span>
<a id="__codelineno-9-146" name="__codelineno-9-146"></a><span class="w">        </span><span class="kn">proxy_set_header</span><span class="w"> </span><span class="s">X-Forwarded-For</span><span class="w"> </span><span class="nv">$proxy_add_x_forwarded_for</span><span class="p">;</span><span class="w"> </span><span class="c1">#同上</span>
<a id="__codelineno-9-147" name="__codelineno-9-147"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-9-148" name="__codelineno-9-148"></a><span class="p">}</span><span class="w"> </span>
</code></pre></div></td></tr></table></div>
<h2 id="4架构分析">4.架构分析<a class="headerlink" href="#4架构分析" title="Permanent link">&para;</a></h2>
<h3 id="anginx模块化">A.Nginx模块化<a class="headerlink" href="#anginx模块化" title="Permanent link">&para;</a></h3>
<p>Nginx基于模块化设计，每个模块是一个功能实现，分布式开发，团队协作</p>
<p>核心模块、标准HTTP模块、可选HTTP模块、邮件模块、第三方模块</p>
<p>编译后的源码目录objs/ngx_modules.c</p>
<h3 id="bnginx的web请求机制">B.Nginx的web请求机制<a class="headerlink" href="#bnginx的web请求机制" title="Permanent link">&para;</a></h3>
<p><a href="https://camo.githubusercontent.com/afe0fb6249105656f24d1a8b0b454c3a3ea504c18a1bbb5499e01b4b00d6fe87/687474703a2f2f61736b2e6170656c6561726e2e636f6d2f75706c6f6164732f6e67696e782f6576656e74322e706e67"><img alt="img" src="https://camo.githubusercontent.com/afe0fb6249105656f24d1a8b0b454c3a3ea504c18a1bbb5499e01b4b00d6fe87/687474703a2f2f61736b2e6170656c6561726e2e636f6d2f75706c6f6164732f6e67696e782f6576656e74322e706e67" /></a></p>
<h5 id="同步机制">同步机制<a class="headerlink" href="#同步机制" title="Permanent link">&para;</a></h5>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Text Only</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-10-1">1</a></span>
<span class="normal"><a href="#__codelineno-10-2">2</a></span>
<span class="normal"><a href="#__codelineno-10-3">3</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-10-1" name="__codelineno-10-1"></a>同步、异步发生在当客户端发起请求后，服务端处理客户端的请求时。
<a id="__codelineno-10-2" name="__codelineno-10-2"></a>同步机制，是指客户端发送请求后，需要等待服务端（内核）返回信息后，再继续发送下一个请求。
<a id="__codelineno-10-3" name="__codelineno-10-3"></a>在同步机制中，所有的请求在服务器端得到同步，即发送方和接收方对请求的处理步调是一致的。
</code></pre></div></td></tr></table></div>
<h5 id="异步机制">异步机制<a class="headerlink" href="#异步机制" title="Permanent link">&para;</a></h5>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Text Only</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-11-1">1</a></span>
<span class="normal"><a href="#__codelineno-11-2">2</a></span>
<span class="normal"><a href="#__codelineno-11-3">3</a></span>
<span class="normal"><a href="#__codelineno-11-4">4</a></span>
<span class="normal"><a href="#__codelineno-11-5">5</a></span>
<span class="normal"><a href="#__codelineno-11-6">6</a></span>
<span class="normal"><a href="#__codelineno-11-7">7</a></span>
<span class="normal"><a href="#__codelineno-11-8">8</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-11-1" name="__codelineno-11-1"></a>异步机制，是指客户端发出一个请求后，不等待服务端（内核）返回信息，就继续发送下一个请求。
<a id="__codelineno-11-2" name="__codelineno-11-2"></a>在异步机制中，所有来自发送方的请求形成一个队列，接收方处理完后再通知发送方。
<a id="__codelineno-11-3" name="__codelineno-11-3"></a>
<a id="__codelineno-11-4" name="__codelineno-11-4"></a>
<a id="__codelineno-11-5" name="__codelineno-11-5"></a>举例：一家酒店前台，在旺季的高峰时间段会接很多预定酒席的电话。
<a id="__codelineno-11-6" name="__codelineno-11-6"></a>如果是同步机制情况下，前台每接一个电话后先不挂掉电话，而是去查询有无剩余酒席，查到结果后，告诉客户。
<a id="__codelineno-11-7" name="__codelineno-11-7"></a>如果是异步机制情况下，前台每接一个预定电话直接回复客户，一会回复，此时前台把查询这件事情交给了另外的同事，
<a id="__codelineno-11-8" name="__codelineno-11-8"></a>该前台挂掉电话后，继续处理其他客户的事情，当另外的同事查询到结果后再通知给前台，前台再通知客户。
</code></pre></div></td></tr></table></div>
<h5 id="阻塞">阻塞<a class="headerlink" href="#阻塞" title="Permanent link">&para;</a></h5>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Text Only</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-12-1">1</a></span>
<span class="normal"><a href="#__codelineno-12-2">2</a></span>
<span class="normal"><a href="#__codelineno-12-3">3</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-12-1" name="__codelineno-12-1"></a>阻塞与非阻塞发生在IO调度中，比如内核到磁盘IO。
<a id="__codelineno-12-2" name="__codelineno-12-2"></a>阻塞方式下，进程/线程在获取最终结果之前，被系统挂起了，也就是所谓的阻塞了，在阻塞过程中该进程什么都干不了，
<a id="__codelineno-12-3" name="__codelineno-12-3"></a>直到最终结果反馈给它时，它才恢复运行状态。
</code></pre></div></td></tr></table></div>
<h5 id="非阻塞">非阻塞<a class="headerlink" href="#非阻塞" title="Permanent link">&para;</a></h5>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Text Only</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-13-1">1</a></span>
<span class="normal"><a href="#__codelineno-13-2">2</a></span>
<span class="normal"><a href="#__codelineno-13-3">3</a></span>
<span class="normal"><a href="#__codelineno-13-4">4</a></span>
<span class="normal"><a href="#__codelineno-13-5">5</a></span>
<span class="normal"><a href="#__codelineno-13-6">6</a></span>
<span class="normal"><a href="#__codelineno-13-7">7</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-13-1" name="__codelineno-13-1"></a>非阻塞方式和阻塞相反，进程/线程在获取最终结果之前，并没有进入被挂起的状态，而是该进程可以继续执行新的任务。
<a id="__codelineno-13-2" name="__codelineno-13-2"></a>当有最终结果反馈给该进程时，它再把结果交给客户端。
<a id="__codelineno-13-3" name="__codelineno-13-3"></a>
<a id="__codelineno-13-4" name="__codelineno-13-4"></a>举例：依然是酒店前台接待预定酒席电话的案例。
<a id="__codelineno-13-5" name="__codelineno-13-5"></a>此时角色不再是前台，而是她的查询有无剩余酒席的同事。如果是阻塞方式，该同事在查询有无剩余酒席的过程中，需要傻傻地
<a id="__codelineno-13-6" name="__codelineno-13-6"></a>等待酒店管理系统给他返回结果，在此期间不能做其他事情。
<a id="__codelineno-13-7" name="__codelineno-13-7"></a>如果是非阻塞，该同事在等待酒店管理系统给他返回结果这段时间，可以做其他事情，比如可以通知前台剩余酒席的情况。
</code></pre></div></td></tr></table></div>
<h5 id="nginx的请求机制">Nginx的请求机制<a class="headerlink" href="#nginx的请求机制" title="Permanent link">&para;</a></h5>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Text Only</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-14-1">1</a></span>
<span class="normal"><a href="#__codelineno-14-2">2</a></span>
<span class="normal"><a href="#__codelineno-14-3">3</a></span>
<span class="normal"><a href="#__codelineno-14-4">4</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-14-1" name="__codelineno-14-1"></a>Nginx之所以可以支持高并发，是因为Nginx用的是异步非阻塞的机制，而Nginx是靠事件驱动模型来实现这种机制的。
<a id="__codelineno-14-2" name="__codelineno-14-2"></a>
<a id="__codelineno-14-3" name="__codelineno-14-3"></a>在Nginx的事件驱动模型下，客户端发起的所有请求在服务端都会被标记为一个事件，Nginx会把这些事件收集到“事件收集器”里，
<a id="__codelineno-14-4" name="__codelineno-14-4"></a>然后再把这些事件交给内核去处理。
</code></pre></div></td></tr></table></div>
<h3 id="c事件驱动模型">C.事件驱动模型<a class="headerlink" href="#c事件驱动模型" title="Permanent link">&para;</a></h3>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Text Only</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-15-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-15-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-15-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-15-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-15-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-15-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-15-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-15-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-15-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-15-10">10</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-15-1" name="__codelineno-15-1"></a>事件驱动模型是实现异步非阻塞的一个手段。事件驱动模型中，一个进程（线程）就可以了。
<a id="__codelineno-15-2" name="__codelineno-15-2"></a>
<a id="__codelineno-15-3" name="__codelineno-15-3"></a>对于web服务器来说，客户端A的请求连接到服务端时，服务端的某个进程（Nginx worker process）会处理该请求，
<a id="__codelineno-15-4" name="__codelineno-15-4"></a>此进程在没有返回给客户端A结果时，它又去处理了客户端B的请求。
<a id="__codelineno-15-5" name="__codelineno-15-5"></a>服务端把客户端A以及客户端B发来的请求作为事件交给了“事件收集器”，
<a id="__codelineno-15-6" name="__codelineno-15-6"></a>而“事件收集器”再把收集到的事件交由“事件发送器”发送给“事件处理器”进行处理。
<a id="__codelineno-15-7" name="__codelineno-15-7"></a>最后“事件处理器”处理完该事件后，通知服务端进程，服务端进程再把结果返回给客户端A、客户端B。
<a id="__codelineno-15-8" name="__codelineno-15-8"></a>
<a id="__codelineno-15-9" name="__codelineno-15-9"></a>在这个过程中，服务端进程做的事情属于用户级别的，而事件处理这部分工作属于内核级别的。
<a id="__codelineno-15-10" name="__codelineno-15-10"></a>也就是说这个事件驱动模型是需要操作系统内核来作为支撑的。
</code></pre></div></td></tr></table></div>
<h4 id="nginx的事件驱动模型">Nginx的事件驱动模型<a class="headerlink" href="#nginx的事件驱动模型" title="Permanent link">&para;</a></h4>
<p><a href="https://camo.githubusercontent.com/4c61c8f7129bc7240ebb99366f92d02c1ae79679dbb75811cfd3c4b377b951d2/687474703a2f2f61736b2e6170656c6561726e2e636f6d2f75706c6f6164732f6e67696e782f6e67696e785f6576656e742e706e67"><img alt="image" src="https://camo.githubusercontent.com/4c61c8f7129bc7240ebb99366f92d02c1ae79679dbb75811cfd3c4b377b951d2/687474703a2f2f61736b2e6170656c6561726e2e636f6d2f75706c6f6164732f6e67696e782f6e67696e785f6576656e742e706e67" /></a></p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Text Only</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-16-1">1</a></span>
<span class="normal"><a href="#__codelineno-16-2">2</a></span>
<span class="normal"><a href="#__codelineno-16-3">3</a></span>
<span class="normal"><a href="#__codelineno-16-4">4</a></span>
<span class="normal"><a href="#__codelineno-16-5">5</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-16-1" name="__codelineno-16-1"></a>Nginx的事件驱动模型，支持select、poll、epoll、rtsig、kqueue、/dev/poll、eventport等。
<a id="__codelineno-16-2" name="__codelineno-16-2"></a>最常用的是前三种，其中kqueue模型用于支持BSD系列平台的事件驱动模型。kqueue是poll模型的一个变种，本质上和epoll一样。
<a id="__codelineno-16-3" name="__codelineno-16-3"></a>/dev/poll是Unix平台的事件驱动模型，其主要在Solaris7及以上版本、HP/UX11.22及以上版本、IRIX6.5.15及以上版本、
<a id="__codelineno-16-4" name="__codelineno-16-4"></a>Tru64 Unix 5.1A及以上版本的平台使用。
<a id="__codelineno-16-5" name="__codelineno-16-5"></a>eventport是用于支持Solaris10及以上版本的事件驱动模型。
</code></pre></div></td></tr></table></div>
<h4 id="select模型">select模型<a class="headerlink" href="#select模型" title="Permanent link">&para;</a></h4>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Text Only</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-17-1">1</a></span>
<span class="normal"><a href="#__codelineno-17-2">2</a></span>
<span class="normal"><a href="#__codelineno-17-3">3</a></span>
<span class="normal"><a href="#__codelineno-17-4">4</a></span>
<span class="normal"><a href="#__codelineno-17-5">5</a></span>
<span class="normal"><a href="#__codelineno-17-6">6</a></span>
<span class="normal"><a href="#__codelineno-17-7">7</a></span>
<span class="normal"><a href="#__codelineno-17-8">8</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-17-1" name="__codelineno-17-1"></a>Linux和Windows都支持，使用select模型的步骤是：
<a id="__codelineno-17-2" name="__codelineno-17-2"></a>
<a id="__codelineno-17-3" name="__codelineno-17-3"></a>1. 创建所关注事件的描述符集合，对于一个描述符，可以关注其上面的读(Read)事件、写(Write)事件以及异常发生(Exception)事件。
<a id="__codelineno-17-4" name="__codelineno-17-4"></a>在select模型中，要创建这3类事件描述符集合。
<a id="__codelineno-17-5" name="__codelineno-17-5"></a>
<a id="__codelineno-17-6" name="__codelineno-17-6"></a>2. 调用底层提供的select()函数，等待事件发生。
<a id="__codelineno-17-7" name="__codelineno-17-7"></a>
<a id="__codelineno-17-8" name="__codelineno-17-8"></a>3. 轮询所有事件描述符集合中的每一个事件描述符，检查是否有相应的事件发生，如果有就进行处理。
</code></pre></div></td></tr></table></div>
<h4 id="poll模型">poll模型<a class="headerlink" href="#poll模型" title="Permanent link">&para;</a></h4>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Text Only</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-18-1">1</a></span>
<span class="normal"><a href="#__codelineno-18-2">2</a></span>
<span class="normal"><a href="#__codelineno-18-3">3</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-18-1" name="__codelineno-18-1"></a>poll模型是Linux平台上的事件驱动模型，在Linux2.1.23中引入的，Windows平台不支持该模型。
<a id="__codelineno-18-2" name="__codelineno-18-2"></a>
<a id="__codelineno-18-3" name="__codelineno-18-3"></a>poll模型和select模型工作方式基本相同，区别在于，select模型创建了3个描述符集合，而poll模型只创建一个描述符集合。
</code></pre></div></td></tr></table></div>
<h4 id="epoll模型">epoll模型<a class="headerlink" href="#epoll模型" title="Permanent link">&para;</a></h4>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Text Only</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-19-1">1</a></span>
<span class="normal"><a href="#__codelineno-19-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-19-1" name="__codelineno-19-1"></a>epoll模型属于poll模型的变种，在Linux2.5.44中引入。epoll比poll更加高效，原因在于它不需要轮询整个描述符集合，
<a id="__codelineno-19-2" name="__codelineno-19-2"></a>而是Linux内核会关注事件集合，当有变动时，内核会发来通知。
</code></pre></div></td></tr></table></div>
<h3 id="dnginx架构">D.Nginx架构<a class="headerlink" href="#dnginx架构" title="Permanent link">&para;</a></h3>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Text Only</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-20-1">1</a></span>
<span class="normal"><a href="#__codelineno-20-2">2</a></span>
<span class="normal"><a href="#__codelineno-20-3">3</a></span>
<span class="normal"><a href="#__codelineno-20-4">4</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-20-1" name="__codelineno-20-1"></a>Nginx服务器使用 master/worker 多进程模式。
<a id="__codelineno-20-2" name="__codelineno-20-2"></a>主进程(Master process)启动后，会接收和处理外部信号；
<a id="__codelineno-20-3" name="__codelineno-20-3"></a>主进程启动后通过fork() 函数产生一个或多个子进程(work process)，每个子进程会进行进程初始化、
<a id="__codelineno-20-4" name="__codelineno-20-4"></a>模块调用以及对事件的接收和处理等工作。
</code></pre></div></td></tr></table></div>
<p><a href="https://camo.githubusercontent.com/99a15b034c77501c19fc6bb0cee34cd09e6198f9e247c0de922c00b3c0affa79/687474703a2f2f61736b2e6170656c6561726e2e636f6d2f75706c6f6164732f6e67696e782f6e67696e785f6a672e706e67"><img alt="image" src="https://camo.githubusercontent.com/99a15b034c77501c19fc6bb0cee34cd09e6198f9e247c0de922c00b3c0affa79/687474703a2f2f61736b2e6170656c6561726e2e636f6d2f75706c6f6164732f6e67696e782f6e67696e785f6a672e706e67" /></a></p>
<h4 id="主进程">主进程<a class="headerlink" href="#主进程" title="Permanent link">&para;</a></h4>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Text Only</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-21-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-21-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-21-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-21-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-21-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-21-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-21-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-21-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-21-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-21-10">10</a></span>
<span class="normal"><a href="#__codelineno-21-11">11</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-21-1" name="__codelineno-21-1"></a>主要功能是和外界通信和对内部其他进程进行管理，具体来说有以下几点：
<a id="__codelineno-21-2" name="__codelineno-21-2"></a>
<a id="__codelineno-21-3" name="__codelineno-21-3"></a>* 读取Nginx配置文件并验证其有效性和正确性
<a id="__codelineno-21-4" name="__codelineno-21-4"></a>
<a id="__codelineno-21-5" name="__codelineno-21-5"></a>* 建立、绑定和关闭socket
<a id="__codelineno-21-6" name="__codelineno-21-6"></a>
<a id="__codelineno-21-7" name="__codelineno-21-7"></a>* 按照配置生成、管理工作进程
<a id="__codelineno-21-8" name="__codelineno-21-8"></a>
<a id="__codelineno-21-9" name="__codelineno-21-9"></a>* 接收外界指令，比如重启、关闭、重载服务等指令
<a id="__codelineno-21-10" name="__codelineno-21-10"></a>
<a id="__codelineno-21-11" name="__codelineno-21-11"></a>* 日志文件管理
</code></pre></div></td></tr></table></div>
<h4 id="子进程worker-process">子进程（worker process)<a class="headerlink" href="#子进程worker-process" title="Permanent link">&para;</a></h4>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Text Only</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-22-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-22-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-22-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-22-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-22-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-22-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-22-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-22-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-22-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-22-10">10</a></span>
<span class="normal"><a href="#__codelineno-22-11">11</a></span>
<span class="normal"><a href="#__codelineno-22-12">12</a></span>
<span class="normal"><a href="#__codelineno-22-13">13</a></span>
<span class="normal"><a href="#__codelineno-22-14">14</a></span>
<span class="normal"><a href="#__codelineno-22-15">15</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-22-1" name="__codelineno-22-1"></a>是由主进程生成，生成数量可以在配置文件中定义。该进程主要工作有：
<a id="__codelineno-22-2" name="__codelineno-22-2"></a>
<a id="__codelineno-22-3" name="__codelineno-22-3"></a>* 接收客户端请求
<a id="__codelineno-22-4" name="__codelineno-22-4"></a>
<a id="__codelineno-22-5" name="__codelineno-22-5"></a>* 将请求依次送入各个功能模块进行过滤处理
<a id="__codelineno-22-6" name="__codelineno-22-6"></a>
<a id="__codelineno-22-7" name="__codelineno-22-7"></a>* IO调用，获取响应数据
<a id="__codelineno-22-8" name="__codelineno-22-8"></a>
<a id="__codelineno-22-9" name="__codelineno-22-9"></a>* 与后端服务器通信，接收后端服务器处理结果
<a id="__codelineno-22-10" name="__codelineno-22-10"></a>
<a id="__codelineno-22-11" name="__codelineno-22-11"></a>* 数据缓存，访问缓存索引，查询和调用缓存数据
<a id="__codelineno-22-12" name="__codelineno-22-12"></a>
<a id="__codelineno-22-13" name="__codelineno-22-13"></a>* 发送请求结果，响应客户端请求
<a id="__codelineno-22-14" name="__codelineno-22-14"></a>
<a id="__codelineno-22-15" name="__codelineno-22-15"></a>* 接收主进程指令，如重启、重载、退出等
</code></pre></div></td></tr></table></div>
<p><a href="https://camo.githubusercontent.com/efa1c7acafb7fde344e5fe7d7c7024d25498839e4016b15d1dec09f6f27f64e0/687474703a2f2f61736b2e6170656c6561726e2e636f6d2f75706c6f6164732f6e67696e782f6e67696e785f6d2e6a7067"><img alt="img" src="https://camo.githubusercontent.com/efa1c7acafb7fde344e5fe7d7c7024d25498839e4016b15d1dec09f6f27f64e0/687474703a2f2f61736b2e6170656c6561726e2e636f6d2f75706c6f6164732f6e67696e782f6e67696e785f6d2e6a7067" /></a></p>
<h2 id="5虚拟主机配置">5.虚拟主机配置<a class="headerlink" href="#5虚拟主机配置" title="Permanent link">&para;</a></h2>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Nginx Configuration File</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-23-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-23-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-23-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-23-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-23-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-23-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-23-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-23-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-23-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-23-10">10</a></span>
<span class="normal"><a href="#__codelineno-23-11">11</a></span>
<span class="normal"><a href="#__codelineno-23-12">12</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-23-1" name="__codelineno-23-1"></a><span class="k">user</span><span class="w"> </span><span class="s">nobody</span><span class="p">;</span><span class="w"> </span><span class="c1"># 定义运行nginx服务的用户,还可以加上组,如 user nobody nobody</span>
<a id="__codelineno-23-2" name="__codelineno-23-2"></a><span class="k">worker_processes</span><span class="w">  </span><span class="mi">1</span><span class="p">;</span>
<a id="__codelineno-23-3" name="__codelineno-23-3"></a><span class="k">events</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-23-4" name="__codelineno-23-4"></a><span class="w">    </span><span class="kn">worker_connections</span><span class="w">  </span><span class="mi">1024</span><span class="p">;</span>
<a id="__codelineno-23-5" name="__codelineno-23-5"></a><span class="p">}</span>
<a id="__codelineno-23-6" name="__codelineno-23-6"></a><span class="k">http</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-23-7" name="__codelineno-23-7"></a><span class="w">    </span><span class="kn">include</span><span class="w">       </span><span class="s">mime.types</span><span class="p">;</span>
<a id="__codelineno-23-8" name="__codelineno-23-8"></a><span class="w">    </span><span class="kn">default_type</span><span class="w">  </span><span class="s">application/octet-stream</span><span class="p">;</span>
<a id="__codelineno-23-9" name="__codelineno-23-9"></a><span class="w">    </span><span class="kn">sendfile</span><span class="w">        </span><span class="no">on</span><span class="p">;</span>
<a id="__codelineno-23-10" name="__codelineno-23-10"></a><span class="w">    </span><span class="kn">keepalive_timeout</span><span class="w">  </span><span class="mi">65</span><span class="p">;</span>
<a id="__codelineno-23-11" name="__codelineno-23-11"></a><span class="w">    </span><span class="kn">include</span><span class="w"> </span><span class="s">vhost/*.conf</span><span class="p">;</span><span class="w"> </span><span class="c1">#包含vhost下的.conf文件</span>
<a id="__codelineno-23-12" name="__codelineno-23-12"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Nginx Configuration File</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-24-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-24-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-24-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-24-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-24-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-24-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-24-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-24-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-24-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-24-10">10</a></span>
<span class="normal"><a href="#__codelineno-24-11">11</a></span>
<span class="normal"><a href="#__codelineno-24-12">12</a></span>
<span class="normal"><a href="#__codelineno-24-13">13</a></span>
<span class="normal"><a href="#__codelineno-24-14">14</a></span>
<span class="normal"><a href="#__codelineno-24-15">15</a></span>
<span class="normal"><a href="#__codelineno-24-16">16</a></span>
<span class="normal"><a href="#__codelineno-24-17">17</a></span>
<span class="normal"><a href="#__codelineno-24-18">18</a></span>
<span class="normal"><a href="#__codelineno-24-19">19</a></span>
<span class="normal"><a href="#__codelineno-24-20">20</a></span>
<span class="normal"><a href="#__codelineno-24-21">21</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-24-1" name="__codelineno-24-1"></a><span class="k">mkdir</span><span class="w"> </span><span class="s">/usr/local/nginx/conf/vhost</span>
<a id="__codelineno-24-2" name="__codelineno-24-2"></a><span class="s">vi</span><span class="w"> </span><span class="s">/usr/local/nginx/conf/vhost/www.1.com.conf</span>
<a id="__codelineno-24-3" name="__codelineno-24-3"></a><span class="w">    </span><span class="s">server</span><span class="p">{</span>
<a id="__codelineno-24-4" name="__codelineno-24-4"></a><span class="w">    </span><span class="kn">listen</span><span class="w"> </span><span class="mi">80</span><span class="p">;</span>
<a id="__codelineno-24-5" name="__codelineno-24-5"></a><span class="w">    </span><span class="kn">server_name</span><span class="w"> </span><span class="s">www.1.com</span><span class="p">;</span>
<a id="__codelineno-24-6" name="__codelineno-24-6"></a><span class="w">    </span><span class="kn">root</span><span class="w"> </span><span class="s">/data/wwwroot/www.1.com</span><span class="p">;</span>
<a id="__codelineno-24-7" name="__codelineno-24-7"></a><span class="w">    </span><span class="kn">index</span><span class="w"> </span><span class="s">index.html</span><span class="w"> </span><span class="s">index.htm</span><span class="p">;</span>
<a id="__codelineno-24-8" name="__codelineno-24-8"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-24-9" name="__codelineno-24-9"></a><span class="k">vi</span><span class="w"> </span><span class="s">/usr/local/nginx/conf/vhost/www.1.com.conf</span>
<a id="__codelineno-24-10" name="__codelineno-24-10"></a><span class="w">    </span><span class="s">server</span><span class="p">{</span>
<a id="__codelineno-24-11" name="__codelineno-24-11"></a><span class="w">    </span><span class="kn">listen</span><span class="w"> </span><span class="mi">80</span><span class="p">;</span>
<a id="__codelineno-24-12" name="__codelineno-24-12"></a><span class="w">    </span><span class="kn">server_name</span><span class="w"> </span><span class="s">*.2.com</span><span class="w"> </span><span class="mi">2</span><span class="s">.com</span><span class="p">;</span>
<a id="__codelineno-24-13" name="__codelineno-24-13"></a><span class="w">    </span><span class="kn">root</span><span class="w"> </span><span class="s">/data/wwwroot/www.2.com</span><span class="p">;</span>
<a id="__codelineno-24-14" name="__codelineno-24-14"></a><span class="w">    </span><span class="kn">index</span><span class="w"> </span><span class="s">index.html</span><span class="w"> </span><span class="s">index.htm</span><span class="p">;</span>
<a id="__codelineno-24-15" name="__codelineno-24-15"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-24-16" name="__codelineno-24-16"></a><span class="k">vi</span><span class="w"> </span><span class="s">/usr/local/nginx/conf/vhost/default.conf</span>
<a id="__codelineno-24-17" name="__codelineno-24-17"></a><span class="w">    </span><span class="s">server</span><span class="p">{</span>
<a id="__codelineno-24-18" name="__codelineno-24-18"></a><span class="w">        </span><span class="kn">listen</span><span class="w"> </span><span class="mi">80</span><span class="w"> </span><span class="s">default_server</span><span class="p">;</span>
<a id="__codelineno-24-19" name="__codelineno-24-19"></a><span class="w">        </span><span class="kn">deny</span><span class="w"> </span><span class="s">all</span><span class="p">;</span>
<a id="__codelineno-24-20" name="__codelineno-24-20"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-24-21" name="__codelineno-24-21"></a><span class="k">mkdir</span><span class="w"> </span><span class="s">-p</span><span class="w"> </span><span class="s">/data/wwwroot</span>
</code></pre></div></td></tr></table></div>
<h2 id="6rewrite配置">6.rewrite配置<a class="headerlink" href="#6rewrite配置" title="Permanent link">&para;</a></h2>
<h3 id="nginx-常用全局变量">nginx 常用全局变量<a class="headerlink" href="#nginx-常用全局变量" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>变量</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>$args</td>
<td>请求中的参数，如www.123.com/1.php?a=1&amp;b=2的$args就是a=1&amp;b=2</td>
</tr>
<tr>
<td>$content_length</td>
<td>HTTP请求信息里的"Content-Length"</td>
</tr>
<tr>
<td>$conten_type</td>
<td>HTTP请求信息里的"Content-Type"</td>
</tr>
<tr>
<td>$document_root</td>
<td>nginx虚拟主机配置文件中的root参数对应的值</td>
</tr>
<tr>
<td>$document_uri</td>
<td>当前请求中不包含指令的URI，如www.123.com/1.php?a=1&amp;b=2的$document_uri就是1.php,不包含后面的参数</td>
</tr>
<tr>
<td>$host</td>
<td>主机头，也就是域名</td>
</tr>
<tr>
<td>$http_user_agent</td>
<td>客户端的详细信息，也就是浏览器的标识，用curl -A可以指定</td>
</tr>
<tr>
<td>$http_cookie</td>
<td>客户端的cookie信息</td>
</tr>
<tr>
<td>$limit_rate</td>
<td>如果nginx服务器使用limit_rate配置了显示网络速率，则会显示，如果没有设置， 则显示0</td>
</tr>
<tr>
<td>$remote_addr</td>
<td>客户端的公网ip</td>
</tr>
<tr>
<td>$remote_port</td>
<td>客户端的port</td>
</tr>
<tr>
<td>$remote_user</td>
<td>如果nginx有配置认证，该变量代表客户端认证的用户名</td>
</tr>
<tr>
<td>$request_body_file</td>
<td>做反向代理时发给后端服务器的本地资源的名称</td>
</tr>
<tr>
<td>$request_method</td>
<td>请求资源的方式，GET/PUT/DELETE等</td>
</tr>
<tr>
<td>$request_filename</td>
<td>当前请求的资源文件的路径名称，相当于是<span class="arithmatex">\(document_root/\)</span>document_uri的组合</td>
</tr>
<tr>
<td>$request_uri</td>
<td>请求的链接，包括<span class="arithmatex">\(document_uri和\)</span>args</td>
</tr>
<tr>
<td>$scheme</td>
<td>请求的协议，如ftp,http,https</td>
</tr>
<tr>
<td>$server_protocol</td>
<td>客户端请求资源使用的协议的版本，如HTTP/1.0，HTTP/1.1，HTTP/2.0等</td>
</tr>
<tr>
<td>$server_addr</td>
<td>服务器IP地址</td>
</tr>
<tr>
<td>$server_name</td>
<td>服务器的主机名</td>
</tr>
<tr>
<td>$server_port</td>
<td>服务器的端口号</td>
</tr>
<tr>
<td>$uri</td>
<td>和$document_uri相同</td>
</tr>
<tr>
<td>$http_referer</td>
<td>客户端请求时的referer，通俗讲就是该请求是通过哪个链接跳过来的，用curl -e可以指定</td>
</tr>
</tbody>
</table>
<h3 id="if条件举例">if条件举例<a class="headerlink" href="#if条件举例" title="Permanent link">&para;</a></h3>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Text Only</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-25-1">1</a></span>
<span class="normal"><a href="#__codelineno-25-2">2</a></span>
<span class="normal"><a href="#__codelineno-25-3">3</a></span>
<span class="normal"><a href="#__codelineno-25-4">4</a></span>
<span class="normal"><a href="#__codelineno-25-5">5</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-25-1" name="__codelineno-25-1"></a>条件判断语句由Nginx内置变量、逻辑判断符号和目标字符串三部分组成。
<a id="__codelineno-25-2" name="__codelineno-25-2"></a>其中，内置变量是Nginx固定的非自定义的变量，如，$request_method, $request_uri等。
<a id="__codelineno-25-3" name="__codelineno-25-3"></a>逻辑判断符号，有=, !=, ~, ~*, !~, !~*
<a id="__codelineno-25-4" name="__codelineno-25-4"></a>!表示相反的意思，~为匹配符号，它右侧为正则表达式，区分大小写，而~*为不区分大小写匹配。
<a id="__codelineno-25-5" name="__codelineno-25-5"></a>目标字符串可以是正则表达式，通常不用加引号，但表达式中有特殊符号时，比如空格、花括号、分号等，需要用单引号引起来。
</code></pre></div></td></tr></table></div>
<h4 id="示例1">示例1<a class="headerlink" href="#示例1" title="Permanent link">&para;</a></h4>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Nginx Configuration File</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-26-1">1</a></span>
<span class="normal"><a href="#__codelineno-26-2">2</a></span>
<span class="normal"><a href="#__codelineno-26-3">3</a></span>
<span class="normal"><a href="#__codelineno-26-4">4</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-26-1" name="__codelineno-26-1"></a><span class="k">nginxif</span><span class="w"> </span><span class="s">(</span><span class="nv">$request_method</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">POST)</span><span class="w">  </span><span class="s">//当请求的方法为POST时，直接返回405状态码</span>
<a id="__codelineno-26-2" name="__codelineno-26-2"></a><span class="p">{</span>
<a id="__codelineno-26-3" name="__codelineno-26-3"></a><span class="w">    </span><span class="kn">return</span><span class="w"> </span><span class="mi">405</span><span class="p">;</span><span class="w"> </span><span class="kn">//在该示例中并未用到rewrite规则，if中支持用return指令。</span>
<a id="__codelineno-26-4" name="__codelineno-26-4"></a><span class="err">}</span>
</code></pre></div></td></tr></table></div>
<h4 id="示例2">示例2<a class="headerlink" href="#示例2" title="Permanent link">&para;</a></h4>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Nginx Configuration File</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-27-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-27-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-27-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-27-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-27-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-27-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-27-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-27-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-27-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-27-10">10</a></span>
<span class="normal"><a href="#__codelineno-27-11">11</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-27-1" name="__codelineno-27-1"></a><span class="k">if</span><span class="w"> </span><span class="s">(</span><span class="nv">$http_user_agent</span><span class="w"> </span><span class="p">~</span><span class="w"> </span><span class="sr">MSIE)</span><span class="w"> </span><span class="s">//user_agent带有MSIE字符的请求，直接返回403状态码</span>
<a id="__codelineno-27-2" name="__codelineno-27-2"></a><span class="p">{</span>
<a id="__codelineno-27-3" name="__codelineno-27-3"></a><span class="w">    </span><span class="kn">return</span><span class="w"> </span><span class="mi">403</span><span class="p">;</span>
<a id="__codelineno-27-4" name="__codelineno-27-4"></a><span class="p">}</span>
<a id="__codelineno-27-5" name="__codelineno-27-5"></a>
<a id="__codelineno-27-6" name="__codelineno-27-6"></a><span class="k">如果想同时限制多个user_agent，还可以写成这样</span>
<a id="__codelineno-27-7" name="__codelineno-27-7"></a>
<a id="__codelineno-27-8" name="__codelineno-27-8"></a><span class="s">if</span><span class="w"> </span><span class="s">(</span><span class="nv">$http_user_agent</span><span class="w"> </span><span class="p">~</span><span class="w"> </span><span class="sr">&quot;MSIE|firefox|spider&quot;)</span>
<a id="__codelineno-27-9" name="__codelineno-27-9"></a><span class="p">{</span>
<a id="__codelineno-27-10" name="__codelineno-27-10"></a><span class="w">    </span><span class="kn">return</span><span class="w"> </span><span class="mi">403</span><span class="p">;</span>
<a id="__codelineno-27-11" name="__codelineno-27-11"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<h4 id="示例3">示例3<a class="headerlink" href="#示例3" title="Permanent link">&para;</a></h4>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Nginx Configuration File</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-28-1">1</a></span>
<span class="normal"><a href="#__codelineno-28-2">2</a></span>
<span class="normal"><a href="#__codelineno-28-3">3</a></span>
<span class="normal"><a href="#__codelineno-28-4">4</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-28-1" name="__codelineno-28-1"></a><span class="k">if(!-f</span><span class="w"> </span><span class="nv">$request_filename</span><span class="s">)</span><span class="w">  </span><span class="s">//当请求的文件不存在，将会执行下面的rewrite规则</span>
<a id="__codelineno-28-2" name="__codelineno-28-2"></a><span class="p">{</span>
<a id="__codelineno-28-3" name="__codelineno-28-3"></a><span class="w">    </span><span class="kn">rewrite</span><span class="w"> </span><span class="s">语句</span><span class="p">;</span>
<a id="__codelineno-28-4" name="__codelineno-28-4"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<h4 id="示例4">示例4<a class="headerlink" href="#示例4" title="Permanent link">&para;</a></h4>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Nginx Configuration File</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-29-1">1</a></span>
<span class="normal"><a href="#__codelineno-29-2">2</a></span>
<span class="normal"><a href="#__codelineno-29-3">3</a></span>
<span class="normal"><a href="#__codelineno-29-4">4</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-29-1" name="__codelineno-29-1"></a><span class="k">if($request_uri</span><span class="w"> </span><span class="p">~</span><span class="sr">*</span><span class="w"> </span><span class="s">&#39;gid=\d</span><span class="p">{</span><span class="kn">9,12}/&#39;)</span><span class="w">  </span><span class="s">//\d表示数字，</span><span class="p">{</span><span class="kn">9,12}表示数字出现的次数是9到12次，如gid=123456789/就是符合条件的。</span>
<a id="__codelineno-29-2" name="__codelineno-29-2"></a><span class="p">{</span>
<a id="__codelineno-29-3" name="__codelineno-29-3"></a><span class="w">    </span><span class="kn">rewrite</span><span class="w"> </span><span class="s">语句</span><span class="p">;</span>
<a id="__codelineno-29-4" name="__codelineno-29-4"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<h3 id="rewrite中的break和last">rewrite中的break和last<a class="headerlink" href="#rewrite中的break和last" title="Permanent link">&para;</a></h3>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Nginx Configuration File</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-30-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-30-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-30-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-30-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-30-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-30-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-30-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-30-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-30-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-30-10">10</a></span>
<span class="normal"><a href="#__codelineno-30-11">11</a></span>
<span class="normal"><a href="#__codelineno-30-12">12</a></span>
<span class="normal"><a href="#__codelineno-30-13">13</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-30-1" name="__codelineno-30-1"></a><span class="k">两个指令用法相同，但含义不同，需要放到rewrite规则的末尾，用来控制重写后的链接是否继续被nginx配置执行(主要是rewrite、return指令)。</span>
<a id="__codelineno-30-2" name="__codelineno-30-2"></a>
<a id="__codelineno-30-3" name="__codelineno-30-3"></a><span class="s">示例1（连续两条rewrite规则）：</span>
<a id="__codelineno-30-4" name="__codelineno-30-4"></a><span class="s">server</span><span class="p">{</span>
<a id="__codelineno-30-5" name="__codelineno-30-5"></a><span class="w">    </span><span class="kn">listen</span><span class="w"> </span><span class="mi">80</span><span class="p">;</span><span class="w"> </span>
<a id="__codelineno-30-6" name="__codelineno-30-6"></a><span class="w">    </span><span class="kn">server_name</span><span class="w"> </span><span class="s">test.com</span><span class="p">;</span>
<a id="__codelineno-30-7" name="__codelineno-30-7"></a><span class="w">    </span><span class="kn">root</span><span class="w"> </span><span class="s">/tmp/123.com</span><span class="p">;</span>
<a id="__codelineno-30-8" name="__codelineno-30-8"></a>
<a id="__codelineno-30-9" name="__codelineno-30-9"></a><span class="w">    </span><span class="kn">rewrite</span><span class="w"> </span><span class="s">/1.html</span><span class="w"> </span><span class="s">/2.html</span><span class="w"> </span><span class="p">;</span>
<a id="__codelineno-30-10" name="__codelineno-30-10"></a><span class="w">    </span><span class="kn">rewrite</span><span class="w"> </span><span class="s">/2.html</span><span class="w"> </span><span class="s">/3.html</span><span class="w"> </span><span class="p">;</span>
<a id="__codelineno-30-11" name="__codelineno-30-11"></a>
<a id="__codelineno-30-12" name="__codelineno-30-12"></a><span class="p">}</span>
<a id="__codelineno-30-13" name="__codelineno-30-13"></a><span class="k">当我们请求1.html时，最终访问到的是3.html，两条rewrite规则先后执行。</span>
</code></pre></div></td></tr></table></div>
<h4 id="break和last在location-外部">break和last在location {}外部<a class="headerlink" href="#break和last在location-外部" title="Permanent link">&para;</a></h4>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Nginx Configuration File</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-31-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-31-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-31-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-31-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-31-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-31-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-31-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-31-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-31-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-31-10">10</a></span>
<span class="normal"><a href="#__codelineno-31-11">11</a></span>
<span class="normal"><a href="#__codelineno-31-12">12</a></span>
<span class="normal"><a href="#__codelineno-31-13">13</a></span>
<span class="normal"><a href="#__codelineno-31-14">14</a></span>
<span class="normal"><a href="#__codelineno-31-15">15</a></span>
<span class="normal"><a href="#__codelineno-31-16">16</a></span>
<span class="normal"><a href="#__codelineno-31-17">17</a></span>
<span class="normal"><a href="#__codelineno-31-18">18</a></span>
<span class="normal"><a href="#__codelineno-31-19">19</a></span>
<span class="normal"><a href="#__codelineno-31-20">20</a></span>
<span class="normal"><a href="#__codelineno-31-21">21</a></span>
<span class="normal"><a href="#__codelineno-31-22">22</a></span>
<span class="normal"><a href="#__codelineno-31-23">23</a></span>
<span class="normal"><a href="#__codelineno-31-24">24</a></span>
<span class="normal"><a href="#__codelineno-31-25">25</a></span>
<span class="normal"><a href="#__codelineno-31-26">26</a></span>
<span class="normal"><a href="#__codelineno-31-27">27</a></span>
<span class="normal"><a href="#__codelineno-31-28">28</a></span>
<span class="normal"><a href="#__codelineno-31-29">29</a></span>
<span class="normal"><a href="#__codelineno-31-30">30</a></span>
<span class="normal"><a href="#__codelineno-31-31">31</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-31-1" name="__codelineno-31-1"></a><span class="k">格式：rewrite</span><span class="w"> </span><span class="s">xxxxx</span><span class="w">  </span><span class="s">break</span><span class="p">;</span>
<a id="__codelineno-31-2" name="__codelineno-31-2"></a>
<a id="__codelineno-31-3" name="__codelineno-31-3"></a><span class="k">示例2（增加break）：</span>
<a id="__codelineno-31-4" name="__codelineno-31-4"></a><span class="s">server</span><span class="p">{</span>
<a id="__codelineno-31-5" name="__codelineno-31-5"></a><span class="w">    </span><span class="kn">listen</span><span class="w"> </span><span class="mi">80</span><span class="p">;</span><span class="w"> </span>
<a id="__codelineno-31-6" name="__codelineno-31-6"></a><span class="w">    </span><span class="kn">server_name</span><span class="w"> </span><span class="s">test.com</span><span class="p">;</span>
<a id="__codelineno-31-7" name="__codelineno-31-7"></a><span class="w">    </span><span class="kn">root</span><span class="w"> </span><span class="s">/tmp/123.com</span><span class="p">;</span>
<a id="__codelineno-31-8" name="__codelineno-31-8"></a>
<a id="__codelineno-31-9" name="__codelineno-31-9"></a><span class="w">    </span><span class="kn">rewrite</span><span class="w"> </span><span class="s">/1.html</span><span class="w"> </span><span class="s">/2.html</span><span class="w"> </span><span class="s">break</span><span class="p">;</span>
<a id="__codelineno-31-10" name="__codelineno-31-10"></a><span class="w">    </span><span class="kn">rewrite</span><span class="w"> </span><span class="s">/2.html</span><span class="w"> </span><span class="s">/3.html</span><span class="p">;</span>
<a id="__codelineno-31-11" name="__codelineno-31-11"></a><span class="p">}</span>
<a id="__codelineno-31-12" name="__codelineno-31-12"></a><span class="k">当我们请求1.html时，最终访问到的是2.html</span>
<a id="__codelineno-31-13" name="__codelineno-31-13"></a><span class="s">说明break在此示例中，作用是不再执行break以下的rewrite规则。</span>
<a id="__codelineno-31-14" name="__codelineno-31-14"></a>
<a id="__codelineno-31-15" name="__codelineno-31-15"></a><span class="s">但，当配置文件中有location时，它还会去执行location</span><span class="p">{}</span><span class="k">段的配置（请求要匹配该location）。</span>
<a id="__codelineno-31-16" name="__codelineno-31-16"></a>
<a id="__codelineno-31-17" name="__codelineno-31-17"></a><span class="s">示例3（break后面还有location段）：</span>
<a id="__codelineno-31-18" name="__codelineno-31-18"></a><span class="s">server</span><span class="p">{</span>
<a id="__codelineno-31-19" name="__codelineno-31-19"></a><span class="w">    </span><span class="kn">listen</span><span class="w"> </span><span class="mi">80</span><span class="p">;</span><span class="w"> </span>
<a id="__codelineno-31-20" name="__codelineno-31-20"></a><span class="w">    </span><span class="kn">server_name</span><span class="w"> </span><span class="s">test.com</span><span class="p">;</span>
<a id="__codelineno-31-21" name="__codelineno-31-21"></a><span class="w">    </span><span class="kn">root</span><span class="w"> </span><span class="s">/tmp/123.com</span><span class="p">;</span>
<a id="__codelineno-31-22" name="__codelineno-31-22"></a>
<a id="__codelineno-31-23" name="__codelineno-31-23"></a><span class="w">    </span><span class="kn">rewrite</span><span class="w"> </span><span class="s">/1.html</span><span class="w"> </span><span class="s">/2.html</span><span class="w"> </span><span class="s">break</span><span class="p">;</span>
<a id="__codelineno-31-24" name="__codelineno-31-24"></a><span class="w">    </span><span class="kn">rewrite</span><span class="w"> </span><span class="s">/2.html</span><span class="w"> </span><span class="s">/3.html</span><span class="p">;</span>
<a id="__codelineno-31-25" name="__codelineno-31-25"></a><span class="w">    </span><span class="kn">location</span><span class="w"> </span><span class="s">/2.html</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-31-26" name="__codelineno-31-26"></a><span class="w">        </span><span class="kn">return</span><span class="w"> </span><span class="mi">403</span><span class="p">;</span>
<a id="__codelineno-31-27" name="__codelineno-31-27"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-31-28" name="__codelineno-31-28"></a><span class="p">}</span>
<a id="__codelineno-31-29" name="__codelineno-31-29"></a><span class="k">当请求1.html时，最终会返回403状态码，说明它去匹配了break后面的location{}配置。</span>
<a id="__codelineno-31-30" name="__codelineno-31-30"></a>
<a id="__codelineno-31-31" name="__codelineno-31-31"></a><span class="s">以上2个示例中，可以把break替换为last，它们两者起到的效果一模一样。</span>
</code></pre></div></td></tr></table></div>
<h4 id="当break和last在location里面">当break和last在location{}里面<a class="headerlink" href="#当break和last在location里面" title="Permanent link">&para;</a></h4>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Nginx Configuration File</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-32-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-32-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-32-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-32-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-32-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-32-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-32-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-32-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-32-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-32-10">10</a></span>
<span class="normal"><a href="#__codelineno-32-11">11</a></span>
<span class="normal"><a href="#__codelineno-32-12">12</a></span>
<span class="normal"><a href="#__codelineno-32-13">13</a></span>
<span class="normal"><a href="#__codelineno-32-14">14</a></span>
<span class="normal"><a href="#__codelineno-32-15">15</a></span>
<span class="normal"><a href="#__codelineno-32-16">16</a></span>
<span class="normal"><a href="#__codelineno-32-17">17</a></span>
<span class="normal"><a href="#__codelineno-32-18">18</a></span>
<span class="normal"><a href="#__codelineno-32-19">19</a></span>
<span class="normal"><a href="#__codelineno-32-20">20</a></span>
<span class="normal"><a href="#__codelineno-32-21">21</a></span>
<span class="normal"><a href="#__codelineno-32-22">22</a></span>
<span class="normal"><a href="#__codelineno-32-23">23</a></span>
<span class="normal"><a href="#__codelineno-32-24">24</a></span>
<span class="normal"><a href="#__codelineno-32-25">25</a></span>
<span class="normal"><a href="#__codelineno-32-26">26</a></span>
<span class="normal"><a href="#__codelineno-32-27">27</a></span>
<span class="normal"><a href="#__codelineno-32-28">28</a></span>
<span class="normal"><a href="#__codelineno-32-29">29</a></span>
<span class="normal"><a href="#__codelineno-32-30">30</a></span>
<span class="normal"><a href="#__codelineno-32-31">31</a></span>
<span class="normal"><a href="#__codelineno-32-32">32</a></span>
<span class="normal"><a href="#__codelineno-32-33">33</a></span>
<span class="normal"><a href="#__codelineno-32-34">34</a></span>
<span class="normal"><a href="#__codelineno-32-35">35</a></span>
<span class="normal"><a href="#__codelineno-32-36">36</a></span>
<span class="normal"><a href="#__codelineno-32-37">37</a></span>
<span class="normal"><a href="#__codelineno-32-38">38</a></span>
<span class="normal"><a href="#__codelineno-32-39">39</a></span>
<span class="normal"><a href="#__codelineno-32-40">40</a></span>
<span class="normal"><a href="#__codelineno-32-41">41</a></span>
<span class="normal"><a href="#__codelineno-32-42">42</a></span>
<span class="normal"><a href="#__codelineno-32-43">43</a></span>
<span class="normal"><a href="#__codelineno-32-44">44</a></span>
<span class="normal"><a href="#__codelineno-32-45">45</a></span>
<span class="normal"><a href="#__codelineno-32-46">46</a></span>
<span class="normal"><a href="#__codelineno-32-47">47</a></span>
<span class="normal"><a href="#__codelineno-32-48">48</a></span>
<span class="normal"><a href="#__codelineno-32-49">49</a></span>
<span class="normal"><a href="#__codelineno-32-50">50</a></span>
<span class="normal"><a href="#__codelineno-32-51">51</a></span>
<span class="normal"><a href="#__codelineno-32-52">52</a></span>
<span class="normal"><a href="#__codelineno-32-53">53</a></span>
<span class="normal"><a href="#__codelineno-32-54">54</a></span>
<span class="normal"><a href="#__codelineno-32-55">55</a></span>
<span class="normal"><a href="#__codelineno-32-56">56</a></span>
<span class="normal"><a href="#__codelineno-32-57">57</a></span>
<span class="normal"><a href="#__codelineno-32-58">58</a></span>
<span class="normal"><a href="#__codelineno-32-59">59</a></span>
<span class="normal"><a href="#__codelineno-32-60">60</a></span>
<span class="normal"><a href="#__codelineno-32-61">61</a></span>
<span class="normal"><a href="#__codelineno-32-62">62</a></span>
<span class="normal"><a href="#__codelineno-32-63">63</a></span>
<span class="normal"><a href="#__codelineno-32-64">64</a></span>
<span class="normal"><a href="#__codelineno-32-65">65</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-32-1" name="__codelineno-32-1"></a><span class="k">示例4（什么都不加）：</span>
<a id="__codelineno-32-2" name="__codelineno-32-2"></a><span class="s">server</span><span class="p">{</span>
<a id="__codelineno-32-3" name="__codelineno-32-3"></a><span class="w">    </span><span class="kn">listen</span><span class="w"> </span><span class="mi">80</span><span class="p">;</span><span class="w"> </span>
<a id="__codelineno-32-4" name="__codelineno-32-4"></a><span class="w">    </span><span class="kn">server_name</span><span class="w"> </span><span class="s">test.com</span><span class="p">;</span>
<a id="__codelineno-32-5" name="__codelineno-32-5"></a><span class="w">    </span><span class="kn">root</span><span class="w"> </span><span class="s">/tmp/123.com</span><span class="p">;</span>
<a id="__codelineno-32-6" name="__codelineno-32-6"></a>
<a id="__codelineno-32-7" name="__codelineno-32-7"></a><span class="w">    </span><span class="kn">location</span><span class="w"> </span><span class="s">/</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-32-8" name="__codelineno-32-8"></a><span class="w">        </span><span class="kn">rewrite</span><span class="w"> </span><span class="s">/1.html</span><span class="w"> </span><span class="s">/2.html</span><span class="p">;</span>
<a id="__codelineno-32-9" name="__codelineno-32-9"></a><span class="w">        </span><span class="kn">rewrite</span><span class="w"> </span><span class="s">/2.html</span><span class="w"> </span><span class="s">/3.html</span><span class="p">;</span>
<a id="__codelineno-32-10" name="__codelineno-32-10"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-32-11" name="__codelineno-32-11"></a><span class="w">    </span><span class="kn">location</span><span class="w"> </span><span class="s">/2.html</span>
<a id="__codelineno-32-12" name="__codelineno-32-12"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-32-13" name="__codelineno-32-13"></a><span class="w">        </span><span class="kn">rewrite</span><span class="w"> </span><span class="s">/2.html</span><span class="w"> </span><span class="s">/a.html</span><span class="p">;</span>
<a id="__codelineno-32-14" name="__codelineno-32-14"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-32-15" name="__codelineno-32-15"></a><span class="w">    </span><span class="kn">location</span><span class="w"> </span><span class="s">/3.html</span>
<a id="__codelineno-32-16" name="__codelineno-32-16"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-32-17" name="__codelineno-32-17"></a><span class="w">        </span><span class="kn">rewrite</span><span class="w"> </span><span class="s">/3.html</span><span class="w"> </span><span class="s">/b.html</span><span class="p">;</span>
<a id="__codelineno-32-18" name="__codelineno-32-18"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-32-19" name="__codelineno-32-19"></a><span class="p">}</span>
<a id="__codelineno-32-20" name="__codelineno-32-20"></a><span class="k">当请求/1.html，最终将会访问/b.html，连续执行location</span><span class="w"> </span><span class="s">/下的两次rewrite，跳转到了/3.html，然后又匹配location</span><span class="w"> </span><span class="s">/3.html</span>
<a id="__codelineno-32-21" name="__codelineno-32-21"></a>
<a id="__codelineno-32-22" name="__codelineno-32-22"></a><span class="s">示例5（增加break）：</span>
<a id="__codelineno-32-23" name="__codelineno-32-23"></a><span class="s">server</span><span class="p">{</span>
<a id="__codelineno-32-24" name="__codelineno-32-24"></a><span class="w">    </span><span class="kn">listen</span><span class="w"> </span><span class="mi">80</span><span class="p">;</span><span class="w"> </span>
<a id="__codelineno-32-25" name="__codelineno-32-25"></a><span class="w">    </span><span class="kn">server_name</span><span class="w"> </span><span class="s">test.com</span><span class="p">;</span>
<a id="__codelineno-32-26" name="__codelineno-32-26"></a><span class="w">    </span><span class="kn">root</span><span class="w"> </span><span class="s">/tmp/123.com</span><span class="p">;</span>
<a id="__codelineno-32-27" name="__codelineno-32-27"></a>
<a id="__codelineno-32-28" name="__codelineno-32-28"></a><span class="w">    </span><span class="kn">location</span><span class="w"> </span><span class="s">/</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-32-29" name="__codelineno-32-29"></a><span class="w">        </span><span class="kn">rewrite</span><span class="w"> </span><span class="s">/1.html</span><span class="w"> </span><span class="s">/2.html</span><span class="w"> </span><span class="s">break</span><span class="p">;</span>
<a id="__codelineno-32-30" name="__codelineno-32-30"></a><span class="w">        </span><span class="kn">rewrite</span><span class="w"> </span><span class="s">/2.html</span><span class="w"> </span><span class="s">/3.html</span><span class="p">;</span>
<a id="__codelineno-32-31" name="__codelineno-32-31"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-32-32" name="__codelineno-32-32"></a><span class="w">    </span><span class="kn">location</span><span class="w"> </span><span class="s">/2.html</span>
<a id="__codelineno-32-33" name="__codelineno-32-33"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-32-34" name="__codelineno-32-34"></a><span class="w">        </span><span class="kn">rewrite</span><span class="w"> </span><span class="s">/2.html</span><span class="w"> </span><span class="s">/a.html</span><span class="p">;</span>
<a id="__codelineno-32-35" name="__codelineno-32-35"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-32-36" name="__codelineno-32-36"></a><span class="w">    </span><span class="kn">location</span><span class="w"> </span><span class="s">/3.html</span>
<a id="__codelineno-32-37" name="__codelineno-32-37"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-32-38" name="__codelineno-32-38"></a><span class="w">        </span><span class="kn">rewrite</span><span class="w"> </span><span class="s">/3.html</span><span class="w"> </span><span class="s">/b.html</span><span class="p">;</span>
<a id="__codelineno-32-39" name="__codelineno-32-39"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-32-40" name="__codelineno-32-40"></a><span class="p">}</span>
<a id="__codelineno-32-41" name="__codelineno-32-41"></a><span class="k">当请求/1.html，最终会访问/2.html</span>
<a id="__codelineno-32-42" name="__codelineno-32-42"></a><span class="s">在location</span><span class="p">{}</span><span class="k">内部，遇到break，本location{}内以及后面的所有location{}内的所有指令都不再执行。</span>
<a id="__codelineno-32-43" name="__codelineno-32-43"></a>
<a id="__codelineno-32-44" name="__codelineno-32-44"></a>
<a id="__codelineno-32-45" name="__codelineno-32-45"></a><span class="s">示例6（增加last）:</span>
<a id="__codelineno-32-46" name="__codelineno-32-46"></a><span class="s">server</span><span class="p">{</span>
<a id="__codelineno-32-47" name="__codelineno-32-47"></a><span class="w">    </span><span class="kn">listen</span><span class="w"> </span><span class="mi">80</span><span class="p">;</span><span class="w"> </span>
<a id="__codelineno-32-48" name="__codelineno-32-48"></a><span class="w">    </span><span class="kn">server_name</span><span class="w"> </span><span class="s">test.com</span><span class="p">;</span>
<a id="__codelineno-32-49" name="__codelineno-32-49"></a><span class="w">    </span><span class="kn">root</span><span class="w"> </span><span class="s">/tmp/123.com</span><span class="p">;</span>
<a id="__codelineno-32-50" name="__codelineno-32-50"></a>
<a id="__codelineno-32-51" name="__codelineno-32-51"></a><span class="w">    </span><span class="kn">location</span><span class="w"> </span><span class="s">/</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-32-52" name="__codelineno-32-52"></a><span class="w">        </span><span class="kn">rewrite</span><span class="w"> </span><span class="s">/1.html</span><span class="w"> </span><span class="s">/2.html</span><span class="w"> </span><span class="s">last</span><span class="p">;</span>
<a id="__codelineno-32-53" name="__codelineno-32-53"></a><span class="w">        </span><span class="kn">rewrite</span><span class="w"> </span><span class="s">/2.html</span><span class="w"> </span><span class="s">/3.html</span><span class="p">;</span>
<a id="__codelineno-32-54" name="__codelineno-32-54"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-32-55" name="__codelineno-32-55"></a><span class="w">    </span><span class="kn">location</span><span class="w"> </span><span class="s">/2.html</span>
<a id="__codelineno-32-56" name="__codelineno-32-56"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-32-57" name="__codelineno-32-57"></a><span class="w">        </span><span class="kn">rewrite</span><span class="w"> </span><span class="s">/2.html</span><span class="w"> </span><span class="s">/a.html</span><span class="p">;</span>
<a id="__codelineno-32-58" name="__codelineno-32-58"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-32-59" name="__codelineno-32-59"></a><span class="w">    </span><span class="kn">location</span><span class="w"> </span><span class="s">/3.html</span>
<a id="__codelineno-32-60" name="__codelineno-32-60"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-32-61" name="__codelineno-32-61"></a><span class="w">        </span><span class="kn">rewrite</span><span class="w"> </span><span class="s">/3.html</span><span class="w"> </span><span class="s">/b.html</span><span class="p">;</span>
<a id="__codelineno-32-62" name="__codelineno-32-62"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-32-63" name="__codelineno-32-63"></a><span class="p">}</span>
<a id="__codelineno-32-64" name="__codelineno-32-64"></a><span class="k">当请求/1.html，最终会访问/a.html</span>
<a id="__codelineno-32-65" name="__codelineno-32-65"></a><span class="s">在location</span><span class="p">{}</span><span class="k">内部，遇到last，本location{}内后续指令不再执行，而重写后的url再次从头开始，从头到尾匹配一遍规则。</span>
</code></pre></div></td></tr></table></div>
<h4 id="结论">结论<a class="headerlink" href="#结论" title="Permanent link">&para;</a></h4>
<ul>
<li>当rewrite规则在location{}外，break和last作用一样，遇到break或last后，其后续的rewrite/return语句不再执行。但后续有location{}的话，还会近一步执行location{}里面的语句,当然前提是请求必须要匹配该location。</li>
<li>当rewrite规则在location{}里，遇到break后，本location{}与其他location{}的所有rewrite/return规则都不再执行。</li>
<li>当rewrite规则在location{}里，遇到last后，本location{}里后续rewrite/return规则不执行，但重写后的url再次从头开始执行所有规则，哪个匹配执行哪个。</li>
</ul>
<h3 id="nginx的return指令">nginx的return指令<a class="headerlink" href="#nginx的return指令" title="Permanent link">&para;</a></h3>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Text Only</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-33-1">1</a></span>
<span class="normal"><a href="#__codelineno-33-2">2</a></span>
<span class="normal"><a href="#__codelineno-33-3">3</a></span>
<span class="normal"><a href="#__codelineno-33-4">4</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-33-1" name="__codelineno-33-1"></a>该指令一般用于对请求的客户端直接返回响应状态码。在该作用域内return后面的所有nginx配置都是无效的。
<a id="__codelineno-33-2" name="__codelineno-33-2"></a>可以使用在server、location以及if配置中。
<a id="__codelineno-33-3" name="__codelineno-33-3"></a>
<a id="__codelineno-33-4" name="__codelineno-33-4"></a>除了支持跟状态码，还可以跟字符串或者url链接。
</code></pre></div></td></tr></table></div>
<h4 id="直接返回状态码">直接返回状态码<a class="headerlink" href="#直接返回状态码" title="Permanent link">&para;</a></h4>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Nginx Configuration File</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-34-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-34-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-34-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-34-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-34-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-34-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-34-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-34-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-34-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-34-10">10</a></span>
<span class="normal"><a href="#__codelineno-34-11">11</a></span>
<span class="normal"><a href="#__codelineno-34-12">12</a></span>
<span class="normal"><a href="#__codelineno-34-13">13</a></span>
<span class="normal"><a href="#__codelineno-34-14">14</a></span>
<span class="normal"><a href="#__codelineno-34-15">15</a></span>
<span class="normal"><a href="#__codelineno-34-16">16</a></span>
<span class="normal"><a href="#__codelineno-34-17">17</a></span>
<span class="normal"><a href="#__codelineno-34-18">18</a></span>
<span class="normal"><a href="#__codelineno-34-19">19</a></span>
<span class="normal"><a href="#__codelineno-34-20">20</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-34-1" name="__codelineno-34-1"></a><span class="k">示例1：</span>
<a id="__codelineno-34-2" name="__codelineno-34-2"></a><span class="s">server</span><span class="p">{</span>
<a id="__codelineno-34-3" name="__codelineno-34-3"></a><span class="w">    </span><span class="kn">listen</span><span class="w"> </span><span class="mi">80</span><span class="p">;</span>
<a id="__codelineno-34-4" name="__codelineno-34-4"></a><span class="w">    </span><span class="kn">server_name</span><span class="w"> </span><span class="s">www.aming.com</span><span class="p">;</span>
<a id="__codelineno-34-5" name="__codelineno-34-5"></a><span class="w">    </span><span class="kn">return</span><span class="w"> </span><span class="mi">403</span><span class="p">;</span>
<a id="__codelineno-34-6" name="__codelineno-34-6"></a><span class="w">    </span><span class="kn">rewrite</span><span class="w"> </span><span class="s">/(.*)</span><span class="w"> </span><span class="s">/abc/</span><span class="nv">$1</span><span class="p">;</span><span class="w">  </span><span class="kn">//该行配置不会被执行。</span>
<a id="__codelineno-34-7" name="__codelineno-34-7"></a><span class="err">}</span>
<a id="__codelineno-34-8" name="__codelineno-34-8"></a>
<a id="__codelineno-34-9" name="__codelineno-34-9"></a><span class="s">示例2：</span>
<a id="__codelineno-34-10" name="__codelineno-34-10"></a><span class="s">server</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-34-11" name="__codelineno-34-11"></a><span class="kn">.....</span>
<a id="__codelineno-34-12" name="__codelineno-34-12"></a>
<a id="__codelineno-34-13" name="__codelineno-34-13"></a><span class="s">if</span><span class="w"> </span><span class="s">(</span><span class="nv">$request_uri</span><span class="w"> </span><span class="p">~</span><span class="w"> </span><span class="sr">&quot;\.htpasswd|\.bak&quot;)</span>
<a id="__codelineno-34-14" name="__codelineno-34-14"></a><span class="p">{</span>
<a id="__codelineno-34-15" name="__codelineno-34-15"></a><span class="w">    </span><span class="kn">return</span><span class="w"> </span><span class="mi">404</span><span class="p">;</span>
<a id="__codelineno-34-16" name="__codelineno-34-16"></a><span class="w">    </span><span class="kn">rewrite</span><span class="w"> </span><span class="s">/(.*)</span><span class="w"> </span><span class="s">/aaa.txt</span><span class="p">;</span><span class="w">  </span><span class="kn">//该行配置不会被执行。</span>
<a id="__codelineno-34-17" name="__codelineno-34-17"></a><span class="err">}</span>
<a id="__codelineno-34-18" name="__codelineno-34-18"></a><span class="s">//如果下面还有其他配置，会被执行。</span>
<a id="__codelineno-34-19" name="__codelineno-34-19"></a><span class="s">.....</span>
<a id="__codelineno-34-20" name="__codelineno-34-20"></a><span class="err">}</span>
</code></pre></div></td></tr></table></div>
<h4 id="返回字符串">返回字符串<a class="headerlink" href="#返回字符串" title="Permanent link">&para;</a></h4>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Nginx Configuration File</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-35-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-35-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-35-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-35-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-35-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-35-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-35-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-35-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-35-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-35-10">10</a></span>
<span class="normal"><a href="#__codelineno-35-11">11</a></span>
<span class="normal"><a href="#__codelineno-35-12">12</a></span>
<span class="normal"><a href="#__codelineno-35-13">13</a></span>
<span class="normal"><a href="#__codelineno-35-14">14</a></span>
<span class="normal"><a href="#__codelineno-35-15">15</a></span>
<span class="normal"><a href="#__codelineno-35-16">16</a></span>
<span class="normal"><a href="#__codelineno-35-17">17</a></span>
<span class="normal"><a href="#__codelineno-35-18">18</a></span>
<span class="normal"><a href="#__codelineno-35-19">19</a></span>
<span class="normal"><a href="#__codelineno-35-20">20</a></span>
<span class="normal"><a href="#__codelineno-35-21">21</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-35-1" name="__codelineno-35-1"></a><span class="k">示例3：</span>
<a id="__codelineno-35-2" name="__codelineno-35-2"></a><span class="s">server</span><span class="p">{</span>
<a id="__codelineno-35-3" name="__codelineno-35-3"></a><span class="w">    </span><span class="kn">listen</span><span class="w"> </span><span class="mi">80</span><span class="p">;</span>
<a id="__codelineno-35-4" name="__codelineno-35-4"></a><span class="w">    </span><span class="kn">server_name</span><span class="w"> </span><span class="s">www.aming.com</span><span class="p">;</span>
<a id="__codelineno-35-5" name="__codelineno-35-5"></a><span class="w">    </span><span class="kn">return</span><span class="w"> </span><span class="mi">200</span><span class="w"> </span><span class="s">&quot;hello&quot;</span><span class="p">;</span>
<a id="__codelineno-35-6" name="__codelineno-35-6"></a><span class="p">}</span>
<a id="__codelineno-35-7" name="__codelineno-35-7"></a><span class="k">说明：如果要想返回字符串，必须要加上状态码，否则会报错。</span>
<a id="__codelineno-35-8" name="__codelineno-35-8"></a><span class="s">还可以支持json数据</span>
<a id="__codelineno-35-9" name="__codelineno-35-9"></a>
<a id="__codelineno-35-10" name="__codelineno-35-10"></a><span class="s">示例4：</span>
<a id="__codelineno-35-11" name="__codelineno-35-11"></a><span class="s">location</span><span class="w"> </span><span class="s">^~</span><span class="w"> </span><span class="s">/aming</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-35-12" name="__codelineno-35-12"></a><span class="w">    </span><span class="kn">default_type</span><span class="w"> </span><span class="s">application/json</span><span class="w"> </span><span class="p">;</span>
<a id="__codelineno-35-13" name="__codelineno-35-13"></a><span class="w">    </span><span class="kn">return</span><span class="w"> </span><span class="mi">200</span><span class="w">  </span><span class="s">&#39;</span><span class="p">{</span><span class="kn">&quot;name&quot;:&quot;aming&quot;,&quot;id&quot;:&quot;100&quot;}&#39;</span><span class="p">;</span>
<a id="__codelineno-35-14" name="__codelineno-35-14"></a><span class="p">}</span>
<a id="__codelineno-35-15" name="__codelineno-35-15"></a>
<a id="__codelineno-35-16" name="__codelineno-35-16"></a><span class="kn">也支持写一个变量</span>
<a id="__codelineno-35-17" name="__codelineno-35-17"></a>
<a id="__codelineno-35-18" name="__codelineno-35-18"></a><span class="s">示例5：</span>
<a id="__codelineno-35-19" name="__codelineno-35-19"></a><span class="s">location</span><span class="w"> </span><span class="s">/test</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-35-20" name="__codelineno-35-20"></a><span class="w">    </span><span class="kn">return</span><span class="w"> </span><span class="mi">200</span><span class="w"> </span><span class="s">&quot;</span><span class="nv">$host</span><span class="w"> </span><span class="nv">$request_uri&quot;</span><span class="p">;</span>
<a id="__codelineno-35-21" name="__codelineno-35-21"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<h4 id="返回url">返回url<a class="headerlink" href="#返回url" title="Permanent link">&para;</a></h4>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Nginx Configuration File</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-36-1">1</a></span>
<span class="normal"><a href="#__codelineno-36-2">2</a></span>
<span class="normal"><a href="#__codelineno-36-3">3</a></span>
<span class="normal"><a href="#__codelineno-36-4">4</a></span>
<span class="normal"><a href="#__codelineno-36-5">5</a></span>
<span class="normal"><a href="#__codelineno-36-6">6</a></span>
<span class="normal"><a href="#__codelineno-36-7">7</a></span>
<span class="normal"><a href="#__codelineno-36-8">8</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-36-1" name="__codelineno-36-1"></a><span class="k">示例6：</span>
<a id="__codelineno-36-2" name="__codelineno-36-2"></a><span class="s">server</span><span class="p">{</span>
<a id="__codelineno-36-3" name="__codelineno-36-3"></a><span class="w">    </span><span class="kn">listen</span><span class="w"> </span><span class="mi">80</span><span class="p">;</span>
<a id="__codelineno-36-4" name="__codelineno-36-4"></a><span class="w">    </span><span class="kn">server_name</span><span class="w"> </span><span class="s">www.aming.com</span><span class="p">;</span>
<a id="__codelineno-36-5" name="__codelineno-36-5"></a><span class="w">    </span><span class="kn">return</span><span class="w"> </span><span class="s">http://www.aminglinux.com/123.html</span><span class="p">;</span>
<a id="__codelineno-36-6" name="__codelineno-36-6"></a><span class="w">    </span><span class="kn">rewrite</span><span class="w"> </span><span class="s">/(.*)</span><span class="w"> </span><span class="s">/abc/</span><span class="nv">$1</span><span class="p">;</span><span class="w">  </span><span class="kn">//该行配置不会被执行。</span>
<a id="__codelineno-36-7" name="__codelineno-36-7"></a><span class="err">}</span>
<a id="__codelineno-36-8" name="__codelineno-36-8"></a><span class="s">注意：return后面的url必须是以http://或者https://开头的。</span>
</code></pre></div></td></tr></table></div>
<h4 id="生产场景实战">生产场景实战<a class="headerlink" href="#生产场景实战" title="Permanent link">&para;</a></h4>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Nginx Configuration File</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-37-1">1</a></span>
<span class="normal"><a href="#__codelineno-37-2">2</a></span>
<span class="normal"><a href="#__codelineno-37-3">3</a></span>
<span class="normal"><a href="#__codelineno-37-4">4</a></span>
<span class="normal"><a href="#__codelineno-37-5">5</a></span>
<span class="normal"><a href="#__codelineno-37-6">6</a></span>
<span class="normal"><a href="#__codelineno-37-7">7</a></span>
<span class="normal"><a href="#__codelineno-37-8">8</a></span>
<span class="normal"><a href="#__codelineno-37-9">9</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-37-1" name="__codelineno-37-1"></a><span class="k">背景：网站被黑了，凡是在百度点击到本网站的请求，全部都跳转到了一个赌博网站。</span>
<a id="__codelineno-37-2" name="__codelineno-37-2"></a><span class="s">通过nginx解决：</span>
<a id="__codelineno-37-3" name="__codelineno-37-3"></a><span class="s">if</span><span class="w"> </span><span class="s">(</span><span class="nv">$http_referer</span><span class="w"> </span><span class="p">~</span><span class="w"> </span><span class="sr">&#39;baidu.com&#39;)</span><span class="w"> </span>
<a id="__codelineno-37-4" name="__codelineno-37-4"></a><span class="p">{</span>
<a id="__codelineno-37-5" name="__codelineno-37-5"></a><span class="w">    </span><span class="kn">return</span><span class="w"> </span><span class="mi">200</span><span class="w"> </span><span class="s">&quot;&lt;html&gt;&lt;script&gt;window.location.href=&#39;//</span><span class="nv">$host$request_uri&#39;</span><span class="p">;</span><span class="kn">&lt;/script&gt;&lt;/html&gt;&quot;</span><span class="p">;</span>
<a id="__codelineno-37-6" name="__codelineno-37-6"></a><span class="p">}</span>
<a id="__codelineno-37-7" name="__codelineno-37-7"></a>
<a id="__codelineno-37-8" name="__codelineno-37-8"></a><span class="k">如果写成：</span>
<a id="__codelineno-37-9" name="__codelineno-37-9"></a><span class="s">return</span><span class="w"> </span><span class="s">http://</span><span class="nv">$host$request_uri</span><span class="p">;</span><span class="w"> </span><span class="k">在浏览器中会提示“重定向的次数过多”。</span>
</code></pre></div></td></tr></table></div>
<h3 id="rewrite规则">rewrite规则<a class="headerlink" href="#rewrite规则" title="Permanent link">&para;</a></h3>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Nginx Configuration File</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-38-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-38-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-38-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-38-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-38-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-38-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-38-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-38-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-38-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-38-10">10</a></span>
<span class="normal"><a href="#__codelineno-38-11">11</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-38-1" name="__codelineno-38-1"></a><span class="k">格式：rewrite</span><span class="w">  </span><span class="s">regex</span><span class="w"> </span><span class="s">replacement</span><span class="w"> </span><span class="s">[flag]</span><span class="w"> </span>
<a id="__codelineno-38-2" name="__codelineno-38-2"></a>
<a id="__codelineno-38-3" name="__codelineno-38-3"></a><span class="s">*</span><span class="w"> </span><span class="s">rewrite配置可以在server、location以及if配置段内生效</span>
<a id="__codelineno-38-4" name="__codelineno-38-4"></a>
<a id="__codelineno-38-5" name="__codelineno-38-5"></a><span class="s">*</span><span class="w"> </span><span class="s">regex是用于匹配URI的正则表达式，其不会匹配到</span><span class="nv">$host（域名）</span>
<a id="__codelineno-38-6" name="__codelineno-38-6"></a>
<a id="__codelineno-38-7" name="__codelineno-38-7"></a><span class="s">*</span><span class="w"> </span><span class="s">replacement是目标跳转的URI，可以以http://或者https://开头，也可以省略掉</span><span class="nv">$host，直接写$request_uri部分（即请求的链接）</span>
<a id="__codelineno-38-8" name="__codelineno-38-8"></a>
<a id="__codelineno-38-9" name="__codelineno-38-9"></a><span class="s">*</span><span class="w"> </span><span class="s">flag，用来设置rewrite对URI的处理行为，其中有break、last、rediect、permanent，其中break和last在前面已经介绍过，</span>
<a id="__codelineno-38-10" name="__codelineno-38-10"></a><span class="s">rediect和permanent的区别在于，前者为临时重定向(302)，而后者是永久重定向(301)，对于用户通过浏览器访问，这两者的效果是一致的。</span>
<a id="__codelineno-38-11" name="__codelineno-38-11"></a><span class="s">但是，对于搜索引擎蜘蛛爬虫来说就有区别了，使用301更有利于SEO。所以，建议replacemnet是以http://或者https://开头的flag使用permanent。</span>
</code></pre></div></td></tr></table></div>
<h4 id="示例1_1">示例1<a class="headerlink" href="#示例1_1" title="Permanent link">&para;</a></h4>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Nginx Configuration File</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-39-1">1</a></span>
<span class="normal"><a href="#__codelineno-39-2">2</a></span>
<span class="normal"><a href="#__codelineno-39-3">3</a></span>
<span class="normal"><a href="#__codelineno-39-4">4</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-39-1" name="__codelineno-39-1"></a><span class="k">location</span><span class="w"> </span><span class="s">/</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-39-2" name="__codelineno-39-2"></a><span class="w">    </span><span class="kn">rewrite</span><span class="w"> </span><span class="s">/(.*)</span><span class="w"> </span><span class="s">http://www.aming.com/</span><span class="nv">$1</span><span class="w"> </span><span class="s">permanent</span><span class="p">;</span>
<a id="__codelineno-39-3" name="__codelineno-39-3"></a><span class="p">}</span>
<a id="__codelineno-39-4" name="__codelineno-39-4"></a><span class="k">说明：.*为正则表达式，用()括起来，在后面的URI中可以调用它，第一次出现的()用$1调用，第二次出现的()用$2调用，以此类推。</span>
</code></pre></div></td></tr></table></div>
<h4 id="示例2_1">示例2<a class="headerlink" href="#示例2_1" title="Permanent link">&para;</a></h4>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Nginx Configuration File</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-40-1">1</a></span>
<span class="normal"><a href="#__codelineno-40-2">2</a></span>
<span class="normal"><a href="#__codelineno-40-3">3</a></span>
<span class="normal"><a href="#__codelineno-40-4">4</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-40-1" name="__codelineno-40-1"></a><span class="k">location</span><span class="w"> </span><span class="s">/</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-40-2" name="__codelineno-40-2"></a><span class="w">    </span><span class="kn">rewrite</span><span class="w"> </span><span class="s">/.*</span><span class="w"> </span><span class="s">http://www.aming.com</span><span class="nv">$request_uri</span><span class="w"> </span><span class="s">permanent</span><span class="p">;</span>
<a id="__codelineno-40-3" name="__codelineno-40-3"></a><span class="p">}</span>
<a id="__codelineno-40-4" name="__codelineno-40-4"></a><span class="k">说明：在replacement中，支持变量，这里的$request_uri就是客户端请求的链接</span>
</code></pre></div></td></tr></table></div>
<h4 id="示例3_1">示例3<a class="headerlink" href="#示例3_1" title="Permanent link">&para;</a></h4>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Nginx Configuration File</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-41-1">1</a></span>
<span class="normal"><a href="#__codelineno-41-2">2</a></span>
<span class="normal"><a href="#__codelineno-41-3">3</a></span>
<span class="normal"><a href="#__codelineno-41-4">4</a></span>
<span class="normal"><a href="#__codelineno-41-5">5</a></span>
<span class="normal"><a href="#__codelineno-41-6">6</a></span>
<span class="normal"><a href="#__codelineno-41-7">7</a></span>
<span class="normal"><a href="#__codelineno-41-8">8</a></span>
<span class="normal"><a href="#__codelineno-41-9">9</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-41-1" name="__codelineno-41-1"></a><span class="k">server{</span>
<a id="__codelineno-41-2" name="__codelineno-41-2"></a><span class="w">    </span><span class="s">listen</span><span class="w"> </span><span class="mi">80</span><span class="p">;</span>
<a id="__codelineno-41-3" name="__codelineno-41-3"></a><span class="w">    </span><span class="k">server_name</span><span class="w"> </span><span class="s">www.123.com</span><span class="p">;</span>
<a id="__codelineno-41-4" name="__codelineno-41-4"></a><span class="w">    </span><span class="k">root</span><span class="w"> </span><span class="s">/tmp/123.com</span><span class="p">;</span>
<a id="__codelineno-41-5" name="__codelineno-41-5"></a><span class="w">    </span><span class="k">index</span><span class="w"> </span><span class="s">index.html</span><span class="p">;</span>
<a id="__codelineno-41-6" name="__codelineno-41-6"></a><span class="w">    </span><span class="k">rewrite</span><span class="w"> </span><span class="s">/(.*)</span><span class="w"> </span><span class="s">/abc/</span><span class="nv">$1</span><span class="w"> </span><span class="s">redirect</span><span class="p">;</span>
<a id="__codelineno-41-7" name="__codelineno-41-7"></a><span class="k">}</span>
<a id="__codelineno-41-8" name="__codelineno-41-8"></a><span class="s">说明：本例中的rewrite规则有问题，会造连续循环，最终会失败，解决该问题有两个方案。</span>
<a id="__codelineno-41-9" name="__codelineno-41-9"></a><span class="s">关于循环次数，经测试发现，curl</span><span class="w"> </span><span class="s">会循环50次，chrome会循环80次，IE会循环120次，firefox会循环20次。</span>
</code></pre></div></td></tr></table></div>
<h4 id="示例4_1">示例4<a class="headerlink" href="#示例4_1" title="Permanent link">&para;</a></h4>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Nginx Configuration File</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-42-1">1</a></span>
<span class="normal"><a href="#__codelineno-42-2">2</a></span>
<span class="normal"><a href="#__codelineno-42-3">3</a></span>
<span class="normal"><a href="#__codelineno-42-4">4</a></span>
<span class="normal"><a href="#__codelineno-42-5">5</a></span>
<span class="normal"><a href="#__codelineno-42-6">6</a></span>
<span class="normal"><a href="#__codelineno-42-7">7</a></span>
<span class="normal"><a href="#__codelineno-42-8">8</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-42-1" name="__codelineno-42-1"></a><span class="k">server{</span>
<a id="__codelineno-42-2" name="__codelineno-42-2"></a><span class="w">    </span><span class="s">listen</span><span class="w"> </span><span class="mi">80</span><span class="p">;</span>
<a id="__codelineno-42-3" name="__codelineno-42-3"></a><span class="w">    </span><span class="k">server_name</span><span class="w"> </span><span class="s">www.123.com</span><span class="p">;</span>
<a id="__codelineno-42-4" name="__codelineno-42-4"></a><span class="w">    </span><span class="k">root</span><span class="w"> </span><span class="s">/tmp/123.com</span><span class="p">;</span>
<a id="__codelineno-42-5" name="__codelineno-42-5"></a><span class="w">    </span><span class="k">index</span><span class="w"> </span><span class="s">index.html</span><span class="p">;</span>
<a id="__codelineno-42-6" name="__codelineno-42-6"></a><span class="w">    </span><span class="k">rewrite</span><span class="w"> </span><span class="s">/(.*)</span><span class="w"> </span><span class="s">/abc/</span><span class="nv">$1</span><span class="w"> </span><span class="s">break</span><span class="p">;</span>
<a id="__codelineno-42-7" name="__codelineno-42-7"></a><span class="k">}</span>
<a id="__codelineno-42-8" name="__codelineno-42-8"></a><span class="s">说明：在rewrite中使用break，会避免循环。</span>
</code></pre></div></td></tr></table></div>
<h4 id="示例5">示例5<a class="headerlink" href="#示例5" title="Permanent link">&para;</a></h4>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Nginx Configuration File</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-43-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-43-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-43-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-43-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-43-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-43-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-43-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-43-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-43-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-43-10">10</a></span>
<span class="normal"><a href="#__codelineno-43-11">11</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-43-1" name="__codelineno-43-1"></a><span class="k">server{</span>
<a id="__codelineno-43-2" name="__codelineno-43-2"></a><span class="w">    </span><span class="s">listen</span><span class="w"> </span><span class="mi">80</span><span class="p">;</span>
<a id="__codelineno-43-3" name="__codelineno-43-3"></a><span class="w">    </span><span class="k">server_name</span><span class="w"> </span><span class="s">www.123.com</span><span class="p">;</span>
<a id="__codelineno-43-4" name="__codelineno-43-4"></a><span class="w">    </span><span class="k">root</span><span class="w"> </span><span class="s">/tmp/123.com</span><span class="p">;</span>
<a id="__codelineno-43-5" name="__codelineno-43-5"></a><span class="w">    </span><span class="k">index</span><span class="w"> </span><span class="s">index.html</span><span class="p">;</span>
<a id="__codelineno-43-6" name="__codelineno-43-6"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="s">(</span><span class="nv">$request_uri</span><span class="w"> </span><span class="s">!~</span><span class="w"> </span><span class="s">&#39;^/abc/&#39;)</span>
<a id="__codelineno-43-7" name="__codelineno-43-7"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-43-8" name="__codelineno-43-8"></a><span class="w">        </span><span class="kn">rewrite</span><span class="w"> </span><span class="s">/(.*)</span><span class="w"> </span><span class="s">/abc/</span><span class="nv">$1</span><span class="w"> </span><span class="s">redirect</span><span class="p">;</span>
<a id="__codelineno-43-9" name="__codelineno-43-9"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-43-10" name="__codelineno-43-10"></a><span class="k">}</span>
<a id="__codelineno-43-11" name="__codelineno-43-11"></a><span class="s">说明：加一个条件限制，也可以避免产生循环</span>
</code></pre></div></td></tr></table></div>
<h3 id="rewrite实战">Rewrite实战<a class="headerlink" href="#rewrite实战" title="Permanent link">&para;</a></h3>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Text Only</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-44-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-44-1" name="__codelineno-44-1"></a>本部分内容为nginx生产环境中使用的场景示例。
</code></pre></div></td></tr></table></div>
<h4 id="域名跳转域名重定向">域名跳转（域名重定向）<a class="headerlink" href="#域名跳转域名重定向" title="Permanent link">&para;</a></h4>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Nginx Configuration File</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-45-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-45-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-45-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-45-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-45-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-45-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-45-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-45-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-45-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-45-10">10</a></span>
<span class="normal"><a href="#__codelineno-45-11">11</a></span>
<span class="normal"><a href="#__codelineno-45-12">12</a></span>
<span class="normal"><a href="#__codelineno-45-13">13</a></span>
<span class="normal"><a href="#__codelineno-45-14">14</a></span>
<span class="normal"><a href="#__codelineno-45-15">15</a></span>
<span class="normal"><a href="#__codelineno-45-16">16</a></span>
<span class="normal"><a href="#__codelineno-45-17">17</a></span>
<span class="normal"><a href="#__codelineno-45-18">18</a></span>
<span class="normal"><a href="#__codelineno-45-19">19</a></span>
<span class="normal"><a href="#__codelineno-45-20">20</a></span>
<span class="normal"><a href="#__codelineno-45-21">21</a></span>
<span class="normal"><a href="#__codelineno-45-22">22</a></span>
<span class="normal"><a href="#__codelineno-45-23">23</a></span>
<span class="normal"><a href="#__codelineno-45-24">24</a></span>
<span class="normal"><a href="#__codelineno-45-25">25</a></span>
<span class="normal"><a href="#__codelineno-45-26">26</a></span>
<span class="normal"><a href="#__codelineno-45-27">27</a></span>
<span class="normal"><a href="#__codelineno-45-28">28</a></span>
<span class="normal"><a href="#__codelineno-45-29">29</a></span>
<span class="normal"><a href="#__codelineno-45-30">30</a></span>
<span class="normal"><a href="#__codelineno-45-31">31</a></span>
<span class="normal"><a href="#__codelineno-45-32">32</a></span>
<span class="normal"><a href="#__codelineno-45-33">33</a></span>
<span class="normal"><a href="#__codelineno-45-34">34</a></span>
<span class="normal"><a href="#__codelineno-45-35">35</a></span>
<span class="normal"><a href="#__codelineno-45-36">36</a></span>
<span class="normal"><a href="#__codelineno-45-37">37</a></span>
<span class="normal"><a href="#__codelineno-45-38">38</a></span>
<span class="normal"><a href="#__codelineno-45-39">39</a></span>
<span class="normal"><a href="#__codelineno-45-40">40</a></span>
<span class="normal"><a href="#__codelineno-45-41">41</a></span>
<span class="normal"><a href="#__codelineno-45-42">42</a></span>
<span class="normal"><a href="#__codelineno-45-43">43</a></span>
<span class="normal"><a href="#__codelineno-45-44">44</a></span>
<span class="normal"><a href="#__codelineno-45-45">45</a></span>
<span class="normal"><a href="#__codelineno-45-46">46</a></span>
<span class="normal"><a href="#__codelineno-45-47">47</a></span>
<span class="normal"><a href="#__codelineno-45-48">48</a></span>
<span class="normal"><a href="#__codelineno-45-49">49</a></span>
<span class="normal"><a href="#__codelineno-45-50">50</a></span>
<span class="normal"><a href="#__codelineno-45-51">51</a></span>
<span class="normal"><a href="#__codelineno-45-52">52</a></span>
<span class="normal"><a href="#__codelineno-45-53">53</a></span>
<span class="normal"><a href="#__codelineno-45-54">54</a></span>
<span class="normal"><a href="#__codelineno-45-55">55</a></span>
<span class="normal"><a href="#__codelineno-45-56">56</a></span>
<span class="normal"><a href="#__codelineno-45-57">57</a></span>
<span class="normal"><a href="#__codelineno-45-58">58</a></span>
<span class="normal"><a href="#__codelineno-45-59">59</a></span>
<span class="normal"><a href="#__codelineno-45-60">60</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-45-1" name="__codelineno-45-1"></a><span class="k">示例1（不带条件的）：</span>
<a id="__codelineno-45-2" name="__codelineno-45-2"></a><span class="s">server</span><span class="p">{</span>
<a id="__codelineno-45-3" name="__codelineno-45-3"></a><span class="w">    </span><span class="kn">listen</span><span class="w"> </span><span class="mi">80</span><span class="p">;</span>
<a id="__codelineno-45-4" name="__codelineno-45-4"></a><span class="w">    </span><span class="kn">server_name</span><span class="w"> </span><span class="s">www.aminglinux.com</span><span class="p">;</span>
<a id="__codelineno-45-5" name="__codelineno-45-5"></a><span class="w">    </span><span class="kn">rewrite</span><span class="w"> </span><span class="s">/(.*)</span><span class="w"> </span><span class="s">http://www.aming.com/</span><span class="nv">$1</span><span class="w"> </span><span class="s">permanent</span><span class="p">;</span>
<a id="__codelineno-45-6" name="__codelineno-45-6"></a><span class="w">    </span><span class="kn">.......</span>
<a id="__codelineno-45-7" name="__codelineno-45-7"></a>
<a id="__codelineno-45-8" name="__codelineno-45-8"></a><span class="err">}</span>
<a id="__codelineno-45-9" name="__codelineno-45-9"></a>
<a id="__codelineno-45-10" name="__codelineno-45-10"></a><span class="s">示例2（带条件的）：</span>
<a id="__codelineno-45-11" name="__codelineno-45-11"></a><span class="s">server</span><span class="p">{</span>
<a id="__codelineno-45-12" name="__codelineno-45-12"></a><span class="w">    </span><span class="kn">listen</span><span class="w"> </span><span class="mi">80</span><span class="p">;</span>
<a id="__codelineno-45-13" name="__codelineno-45-13"></a><span class="w">    </span><span class="kn">server_name</span><span class="w"> </span><span class="s">www.aminglinux.com</span><span class="w"> </span><span class="s">aminglinux.com</span><span class="p">;</span>
<a id="__codelineno-45-14" name="__codelineno-45-14"></a><span class="w">    </span><span class="kn">if</span><span class="w"> </span><span class="s">(</span><span class="nv">$host</span><span class="w"> </span><span class="s">!=</span><span class="w"> </span><span class="s">&#39;www.aminglinux.com&#39;)</span>
<a id="__codelineno-45-15" name="__codelineno-45-15"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-45-16" name="__codelineno-45-16"></a><span class="w">        </span><span class="kn">rewrite</span><span class="w"> </span><span class="s">/(.*)</span><span class="w"> </span><span class="s">http://www.aminglinux.com/</span><span class="nv">$1</span><span class="w"> </span><span class="s">permanent</span><span class="p">;</span>
<a id="__codelineno-45-17" name="__codelineno-45-17"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-45-18" name="__codelineno-45-18"></a><span class="w">    </span><span class="kn">.......</span>
<a id="__codelineno-45-19" name="__codelineno-45-19"></a>
<a id="__codelineno-45-20" name="__codelineno-45-20"></a><span class="err">}</span>
<a id="__codelineno-45-21" name="__codelineno-45-21"></a><span class="s">示例3（http跳转到https）：</span>
<a id="__codelineno-45-22" name="__codelineno-45-22"></a><span class="s">server</span><span class="p">{</span>
<a id="__codelineno-45-23" name="__codelineno-45-23"></a><span class="w">    </span><span class="kn">listen</span><span class="w"> </span><span class="mi">80</span><span class="p">;</span>
<a id="__codelineno-45-24" name="__codelineno-45-24"></a><span class="w">    </span><span class="kn">server_name</span><span class="w"> </span><span class="s">www.aminglinux.com</span><span class="p">;</span>
<a id="__codelineno-45-25" name="__codelineno-45-25"></a><span class="w">    </span><span class="kn">rewrite</span><span class="w"> </span><span class="s">/(.*)</span><span class="w"> </span><span class="s">https://www.aminglinux.com/</span><span class="nv">$1</span><span class="w"> </span><span class="s">permanent</span><span class="p">;</span>
<a id="__codelineno-45-26" name="__codelineno-45-26"></a><span class="w">    </span><span class="kn">.......</span>
<a id="__codelineno-45-27" name="__codelineno-45-27"></a>
<a id="__codelineno-45-28" name="__codelineno-45-28"></a><span class="err">}</span>
<a id="__codelineno-45-29" name="__codelineno-45-29"></a><span class="s">示例4（域名访问二级目录）</span>
<a id="__codelineno-45-30" name="__codelineno-45-30"></a><span class="s">server</span><span class="p">{</span>
<a id="__codelineno-45-31" name="__codelineno-45-31"></a><span class="w">    </span><span class="kn">listen</span><span class="w"> </span><span class="mi">80</span><span class="p">;</span>
<a id="__codelineno-45-32" name="__codelineno-45-32"></a><span class="w">    </span><span class="kn">server_name</span><span class="w"> </span><span class="s">bbs.aminglinux.com</span><span class="p">;</span>
<a id="__codelineno-45-33" name="__codelineno-45-33"></a><span class="w">    </span><span class="kn">rewrite</span><span class="w"> </span><span class="s">/(.*)</span><span class="w"> </span><span class="s">http://www.aminglinux.com/bbs/</span><span class="nv">$1</span><span class="w"> </span><span class="s">last</span><span class="p">;</span>
<a id="__codelineno-45-34" name="__codelineno-45-34"></a><span class="w">    </span><span class="kn">.......</span>
<a id="__codelineno-45-35" name="__codelineno-45-35"></a>
<a id="__codelineno-45-36" name="__codelineno-45-36"></a><span class="err">}</span>
<a id="__codelineno-45-37" name="__codelineno-45-37"></a><span class="s">示例5（静态请求分离）</span>
<a id="__codelineno-45-38" name="__codelineno-45-38"></a><span class="s">server</span><span class="p">{</span>
<a id="__codelineno-45-39" name="__codelineno-45-39"></a><span class="w">    </span><span class="kn">listen</span><span class="w"> </span><span class="mi">80</span><span class="p">;</span>
<a id="__codelineno-45-40" name="__codelineno-45-40"></a><span class="w">    </span><span class="kn">server_name</span><span class="w"> </span><span class="s">www.aminglinux.com</span><span class="p">;</span>
<a id="__codelineno-45-41" name="__codelineno-45-41"></a><span class="w">    </span><span class="kn">location</span><span class="w"> </span><span class="p">~</span><span class="sr">*</span><span class="w"> </span><span class="s">^.+.(jpg|jpeg|gif|css|png|js)</span>$
<a id="__codelineno-45-42" name="__codelineno-45-42"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-45-43" name="__codelineno-45-43"></a><span class="w">        </span><span class="kn">rewrite</span><span class="w"> </span><span class="s">/(.*)</span><span class="w"> </span><span class="s">http://img.aminglinux.com/</span><span class="nv">$1</span><span class="w"> </span><span class="s">permanent</span><span class="p">;</span>
<a id="__codelineno-45-44" name="__codelineno-45-44"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-45-45" name="__codelineno-45-45"></a>
<a id="__codelineno-45-46" name="__codelineno-45-46"></a><span class="w">    </span><span class="kn">.......</span>
<a id="__codelineno-45-47" name="__codelineno-45-47"></a>
<a id="__codelineno-45-48" name="__codelineno-45-48"></a><span class="err">}</span>
<a id="__codelineno-45-49" name="__codelineno-45-49"></a><span class="s">或者：</span>
<a id="__codelineno-45-50" name="__codelineno-45-50"></a><span class="s">server</span><span class="p">{</span>
<a id="__codelineno-45-51" name="__codelineno-45-51"></a><span class="w">    </span><span class="kn">listen</span><span class="w"> </span><span class="mi">80</span><span class="p">;</span>
<a id="__codelineno-45-52" name="__codelineno-45-52"></a><span class="w">    </span><span class="kn">server_name</span><span class="w"> </span><span class="s">www.aminglinux.com</span><span class="p">;</span>
<a id="__codelineno-45-53" name="__codelineno-45-53"></a><span class="w">    </span><span class="kn">if</span><span class="w"> </span><span class="s">(</span><span class="w"> </span><span class="nv">$uri</span><span class="w"> </span><span class="p">~</span><span class="sr">*</span><span class="w"> </span><span class="s">&#39;jpg|jpeg|gif|css|png|js</span><span class="nv">$&#39;</span><span class="s">)</span>
<a id="__codelineno-45-54" name="__codelineno-45-54"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-45-55" name="__codelineno-45-55"></a><span class="w">        </span><span class="kn">rewrite</span><span class="w"> </span><span class="s">/(.*)</span><span class="w"> </span><span class="s">http://img.aminglinux.com/</span><span class="nv">$1</span><span class="w"> </span><span class="s">permanent</span><span class="p">;</span>
<a id="__codelineno-45-56" name="__codelineno-45-56"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-45-57" name="__codelineno-45-57"></a>
<a id="__codelineno-45-58" name="__codelineno-45-58"></a><span class="w">    </span><span class="kn">.......</span>
<a id="__codelineno-45-59" name="__codelineno-45-59"></a>
<a id="__codelineno-45-60" name="__codelineno-45-60"></a><span class="err">}</span>
</code></pre></div></td></tr></table></div>
<h4 id="防盗链">防盗链<a class="headerlink" href="#防盗链" title="Permanent link">&para;</a></h4>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Nginx Configuration File</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-46-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-46-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-46-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-46-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-46-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-46-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-46-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-46-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-46-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-46-10">10</a></span>
<span class="normal"><a href="#__codelineno-46-11">11</a></span>
<span class="normal"><a href="#__codelineno-46-12">12</a></span>
<span class="normal"><a href="#__codelineno-46-13">13</a></span>
<span class="normal"><a href="#__codelineno-46-14">14</a></span>
<span class="normal"><a href="#__codelineno-46-15">15</a></span>
<span class="normal"><a href="#__codelineno-46-16">16</a></span>
<span class="normal"><a href="#__codelineno-46-17">17</a></span>
<span class="normal"><a href="#__codelineno-46-18">18</a></span>
<span class="normal"><a href="#__codelineno-46-19">19</a></span>
<span class="normal"><a href="#__codelineno-46-20">20</a></span>
<span class="normal"><a href="#__codelineno-46-21">21</a></span>
<span class="normal"><a href="#__codelineno-46-22">22</a></span>
<span class="normal"><a href="#__codelineno-46-23">23</a></span>
<span class="normal"><a href="#__codelineno-46-24">24</a></span>
<span class="normal"><a href="#__codelineno-46-25">25</a></span>
<span class="normal"><a href="#__codelineno-46-26">26</a></span>
<span class="normal"><a href="#__codelineno-46-27">27</a></span>
<span class="normal"><a href="#__codelineno-46-28">28</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-46-1" name="__codelineno-46-1"></a><span class="k">示例6</span>
<a id="__codelineno-46-2" name="__codelineno-46-2"></a><span class="s">server</span><span class="p">{</span>
<a id="__codelineno-46-3" name="__codelineno-46-3"></a><span class="w">    </span><span class="kn">listen</span><span class="w"> </span><span class="mi">80</span><span class="p">;</span>
<a id="__codelineno-46-4" name="__codelineno-46-4"></a><span class="w">    </span><span class="kn">server_name</span><span class="w"> </span><span class="s">www.aminglinux.com</span><span class="p">;</span>
<a id="__codelineno-46-5" name="__codelineno-46-5"></a><span class="w">    </span><span class="kn">location</span><span class="w"> </span><span class="p">~</span><span class="sr">*</span><span class="w"> </span><span class="s">^.+.(jpg|jpeg|gif|css|png|js|rar|zip|flv)</span>$
<a id="__codelineno-46-6" name="__codelineno-46-6"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-46-7" name="__codelineno-46-7"></a><span class="w">        </span><span class="kn">valid_referers</span><span class="w"> </span><span class="s">none</span><span class="w"> </span><span class="s">blocked</span><span class="w"> </span><span class="s">server_names</span><span class="w"> </span><span class="s">*.aminglinux.com</span><span class="w"> </span><span class="s">aminglinux.com</span><span class="w"> </span><span class="s">*.aming.com</span><span class="w"> </span><span class="s">aming.com</span><span class="p">;</span>
<a id="__codelineno-46-8" name="__codelineno-46-8"></a><span class="w">        </span><span class="kn">if</span><span class="w"> </span><span class="s">(</span><span class="nv">$invalid_referer</span><span class="s">)</span>
<a id="__codelineno-46-9" name="__codelineno-46-9"></a><span class="w">        </span><span class="p">{</span>
<a id="__codelineno-46-10" name="__codelineno-46-10"></a><span class="w">            </span><span class="kn">rewrite</span><span class="w"> </span><span class="s">/(.*)</span><span class="w"> </span><span class="s">http://img.aminglinux.com/images/forbidden.png</span><span class="p">;</span>
<a id="__codelineno-46-11" name="__codelineno-46-11"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-46-12" name="__codelineno-46-12"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-46-13" name="__codelineno-46-13"></a>
<a id="__codelineno-46-14" name="__codelineno-46-14"></a><span class="w">    </span><span class="kn">.......</span>
<a id="__codelineno-46-15" name="__codelineno-46-15"></a>
<a id="__codelineno-46-16" name="__codelineno-46-16"></a><span class="err">}</span>
<a id="__codelineno-46-17" name="__codelineno-46-17"></a><span class="s">说明：*这里是通配，跟正则里面的*不是一个意思，none指的是referer不存在的情况（curl</span><span class="w"> </span><span class="s">-e</span><span class="w"> </span><span class="s">测试），</span>
<a id="__codelineno-46-18" name="__codelineno-46-18"></a><span class="w">      </span><span class="s">blocked指的是referer头部的值被防火墙或者代理服务器删除或者伪装的情况，</span>
<a id="__codelineno-46-19" name="__codelineno-46-19"></a><span class="w">      </span><span class="s">该情况下，referer头部的值不以http://或者https://开头（curl</span><span class="w"> </span><span class="s">-e</span><span class="w"> </span><span class="s">后面跟的referer不以http://或者https://开头）。</span>
<a id="__codelineno-46-20" name="__codelineno-46-20"></a><span class="s">或者：</span>
<a id="__codelineno-46-21" name="__codelineno-46-21"></a><span class="w">    </span><span class="s">location</span><span class="w"> </span><span class="p">~</span><span class="sr">*</span><span class="w"> </span><span class="s">^.+.(jpg|jpeg|gif|css|png|js|rar|zip|flv)</span>$
<a id="__codelineno-46-22" name="__codelineno-46-22"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-46-23" name="__codelineno-46-23"></a><span class="w">        </span><span class="kn">valid_referers</span><span class="w"> </span><span class="s">none</span><span class="w"> </span><span class="s">blocked</span><span class="w"> </span><span class="s">server_names</span><span class="w"> </span><span class="s">*.aminglinux.com</span><span class="w"> </span><span class="s">*.aming.com</span><span class="w"> </span><span class="s">aminglinux.com</span><span class="w"> </span><span class="s">aming.com</span><span class="p">;</span>
<a id="__codelineno-46-24" name="__codelineno-46-24"></a><span class="w">        </span><span class="kn">if</span><span class="w"> </span><span class="s">(</span><span class="nv">$invalid_referer</span><span class="s">)</span>
<a id="__codelineno-46-25" name="__codelineno-46-25"></a><span class="w">        </span><span class="p">{</span>
<a id="__codelineno-46-26" name="__codelineno-46-26"></a><span class="w">            </span><span class="kn">return</span><span class="w"> </span><span class="mi">403</span><span class="p">;</span>
<a id="__codelineno-46-27" name="__codelineno-46-27"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-46-28" name="__codelineno-46-28"></a><span class="w">    </span><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<h4 id="伪静态">伪静态<a class="headerlink" href="#伪静态" title="Permanent link">&para;</a></h4>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Nginx Configuration File</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-47-1">1</a></span>
<span class="normal"><a href="#__codelineno-47-2">2</a></span>
<span class="normal"><a href="#__codelineno-47-3">3</a></span>
<span class="normal"><a href="#__codelineno-47-4">4</a></span>
<span class="normal"><a href="#__codelineno-47-5">5</a></span>
<span class="normal"><a href="#__codelineno-47-6">6</a></span>
<span class="normal"><a href="#__codelineno-47-7">7</a></span>
<span class="normal"><a href="#__codelineno-47-8">8</a></span>
<span class="normal"><a href="#__codelineno-47-9">9</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-47-1" name="__codelineno-47-1"></a><span class="k">示例7(discuz伪静态)：</span>
<a id="__codelineno-47-2" name="__codelineno-47-2"></a><span class="s">location</span><span class="w"> </span><span class="s">/</span><span class="w">  </span><span class="p">{</span>
<a id="__codelineno-47-3" name="__codelineno-47-3"></a><span class="w">    </span><span class="kn">rewrite</span><span class="w"> </span><span class="s">^([^\.]*)/topic-(.+)\.html</span>$<span class="w"> </span><span class="nv">$1/portal.php?mod=topic&amp;topic=$2</span><span class="w"> </span><span class="s">last</span><span class="p">;</span>
<a id="__codelineno-47-4" name="__codelineno-47-4"></a><span class="w">    </span><span class="kn">rewrite</span><span class="w"> </span><span class="s">^([^\.]*)/forum-(\w+)-([0-9]+)\.html</span>$<span class="w"> </span><span class="nv">$1/forum.php?mod=forumdisplay&amp;fid=$2&amp;page=$3</span><span class="w"> </span><span class="s">last</span><span class="p">;</span>
<a id="__codelineno-47-5" name="__codelineno-47-5"></a><span class="w">    </span><span class="kn">rewrite</span><span class="w"> </span><span class="s">^([^\.]*)/thread-([0-9]+)-([0-9]+)-([0-9]+)\.html</span>$<span class="w"> </span><span class="nv">$1/forum.php?mod=viewthread&amp;tid=$2&amp;extra=page%3D$4&amp;page=$3</span><span class="w"> </span><span class="s">last</span><span class="p">;</span>
<a id="__codelineno-47-6" name="__codelineno-47-6"></a><span class="w">    </span><span class="kn">rewrite</span><span class="w"> </span><span class="s">^([^\.]*)/group-([0-9]+)-([0-9]+)\.html</span>$<span class="w"> </span><span class="nv">$1/forum.php?mod=group&amp;fid=$2&amp;page=$3</span><span class="w"> </span><span class="s">last</span><span class="p">;</span>
<a id="__codelineno-47-7" name="__codelineno-47-7"></a><span class="w">    </span><span class="kn">rewrite</span><span class="w"> </span><span class="s">^([^\.]*)/space-(username|uid)-(.+)\.html</span>$<span class="w"> </span><span class="nv">$1/home.php?mod=space&amp;$2=$3</span><span class="w"> </span><span class="s">last</span><span class="p">;</span>
<a id="__codelineno-47-8" name="__codelineno-47-8"></a><span class="w">    </span><span class="kn">rewrite</span><span class="w"> </span><span class="s">^([^\.]*)/(fid|tid)-([0-9]+)\.html</span>$<span class="w"> </span><span class="nv">$1/index.php?action=$2&amp;value=$3</span><span class="w"> </span><span class="s">last</span><span class="p">;</span>
<a id="__codelineno-47-9" name="__codelineno-47-9"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<h4 id="rewrite多个条件的并且">rewrite多个条件的并且<a class="headerlink" href="#rewrite多个条件的并且" title="Permanent link">&para;</a></h4>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Nginx Configuration File</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-48-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-48-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-48-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-48-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-48-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-48-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-48-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-48-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-48-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-48-10">10</a></span>
<span class="normal"><a href="#__codelineno-48-11">11</a></span>
<span class="normal"><a href="#__codelineno-48-12">12</a></span>
<span class="normal"><a href="#__codelineno-48-13">13</a></span>
<span class="normal"><a href="#__codelineno-48-14">14</a></span>
<span class="normal"><a href="#__codelineno-48-15">15</a></span>
<span class="normal"><a href="#__codelineno-48-16">16</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-48-1" name="__codelineno-48-1"></a><span class="k">示例8：</span>
<a id="__codelineno-48-2" name="__codelineno-48-2"></a><span class="s">location</span><span class="w"> </span><span class="s">/</span><span class="p">{</span>
<a id="__codelineno-48-3" name="__codelineno-48-3"></a><span class="w">    </span><span class="kn">set</span><span class="w"> </span><span class="nv">$rule</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-48-4" name="__codelineno-48-4"></a><span class="w">    </span><span class="kn">if</span><span class="w"> </span><span class="s">(</span><span class="nv">$document_uri</span><span class="w"> </span><span class="s">!~</span><span class="w"> </span><span class="s">&#39;^/abc&#39;)</span>
<a id="__codelineno-48-5" name="__codelineno-48-5"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-48-6" name="__codelineno-48-6"></a><span class="w">        </span><span class="kn">set</span><span class="w"> </span><span class="nv">$rule</span><span class="w"> </span><span class="s">&quot;</span><span class="nv">${rule}1&quot;</span><span class="p">;</span>
<a id="__codelineno-48-7" name="__codelineno-48-7"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-48-8" name="__codelineno-48-8"></a><span class="w">    </span><span class="kn">if</span><span class="w"> </span><span class="s">(</span><span class="nv">$http_user_agent</span><span class="w"> </span><span class="p">~</span><span class="sr">*</span><span class="w"> </span><span class="s">&#39;ie6|firefox&#39;)</span>
<a id="__codelineno-48-9" name="__codelineno-48-9"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-48-10" name="__codelineno-48-10"></a><span class="w">       </span><span class="kn">set</span><span class="w"> </span><span class="nv">$rule</span><span class="w"> </span><span class="s">&quot;</span><span class="nv">${rule}2&quot;</span><span class="p">;</span>
<a id="__codelineno-48-11" name="__codelineno-48-11"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-48-12" name="__codelineno-48-12"></a><span class="w">    </span><span class="kn">if</span><span class="w"> </span><span class="s">(</span><span class="nv">$rule</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;012&quot;)</span>
<a id="__codelineno-48-13" name="__codelineno-48-13"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-48-14" name="__codelineno-48-14"></a><span class="w">        </span><span class="kn">rewrite</span><span class="w"> </span><span class="s">/(.*)</span><span class="w"> </span><span class="s">/abc/</span><span class="nv">$1</span><span class="w"> </span><span class="s">redirect</span><span class="p">;</span>
<a id="__codelineno-48-15" name="__codelineno-48-15"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-48-16" name="__codelineno-48-16"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<h2 id="7location配置">7.location配置<a class="headerlink" href="#7location配置" title="Permanent link">&para;</a></h2>
<h3 id="a安装echo模块">A.安装echo模块<a class="headerlink" href="#a安装echo模块" title="Permanent link">&para;</a></h3>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-49-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-49-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-49-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-49-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-49-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-49-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-49-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-49-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-49-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-49-10">10</a></span>
<span class="normal"><a href="#__codelineno-49-11">11</a></span>
<span class="normal"><a href="#__codelineno-49-12">12</a></span>
<span class="normal"><a href="#__codelineno-49-13">13</a></span>
<span class="normal"><a href="#__codelineno-49-14">14</a></span>
<span class="normal"><a href="#__codelineno-49-15">15</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-49-1" name="__codelineno-49-1"></a>git<span class="w"> </span>clone<span class="w"> </span>https://github.com/openresty/echo-nginx-module.git
<a id="__codelineno-49-2" name="__codelineno-49-2"></a>make<span class="w"> </span>clean
<a id="__codelineno-49-3" name="__codelineno-49-3"></a>./configure<span class="w"> </span>--prefix<span class="o">=</span>/usr/local/nginx<span class="w"> </span>--add-module<span class="o">=</span>/echo-nginx-module
<a id="__codelineno-49-4" name="__codelineno-49-4"></a>make
<a id="__codelineno-49-5" name="__codelineno-49-5"></a>make<span class="w"> </span>install
<a id="__codelineno-49-6" name="__codelineno-49-6"></a>/usr/local/nginx/sbin/nginx<span class="w"> </span>-s<span class="w"> </span>stop
<a id="__codelineno-49-7" name="__codelineno-49-7"></a>/usr/local/nginx/sbin/nginx
<a id="__codelineno-49-8" name="__codelineno-49-8"></a>
<a id="__codelineno-49-9" name="__codelineno-49-9"></a>
<a id="__codelineno-49-10" name="__codelineno-49-10"></a>vi<span class="w"> </span>/usr/local/nginx/conf/vhost/www.1.com.conf
<a id="__codelineno-49-11" name="__codelineno-49-11"></a><span class="w">    </span>location<span class="w"> </span>/abc/
<a id="__codelineno-49-12" name="__codelineno-49-12"></a><span class="w">    </span><span class="o">{</span>
<a id="__codelineno-49-13" name="__codelineno-49-13"></a><span class="w">        </span><span class="nb">echo</span><span class="w"> </span><span class="m">123</span><span class="p">;</span>
<a id="__codelineno-49-14" name="__codelineno-49-14"></a><span class="w">    </span><span class="o">}</span>
<a id="__codelineno-49-15" name="__codelineno-49-15"></a>curl<span class="w"> </span>-x127.0.0.1:80<span class="w"> </span>www.1.com/abc/ssss
</code></pre></div></td></tr></table></div>
<h3 id="location语法">location语法<a class="headerlink" href="#location语法" title="Permanent link">&para;</a></h3>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Nginx Configuration File</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-50-1">1</a></span>
<span class="normal"><a href="#__codelineno-50-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-50-1" name="__codelineno-50-1"></a><span class="k">nginx</span><span class="w"> </span><span class="s">location语法规则：location</span><span class="w"> </span><span class="s">[=|~|~*|^~]</span><span class="w"> </span><span class="s">/uri/</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kn">…</span><span class="w"> </span><span class="err">}</span>
<a id="__codelineno-50-2" name="__codelineno-50-2"></a><span class="s">nginx的location匹配的变量是</span><span class="nv">$uri</span>
</code></pre></div></td></tr></table></div>
<table>
<thead>
<tr>
<th>符号</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>=</td>
<td>表示精确匹配</td>
</tr>
<tr>
<td>^~</td>
<td>表示uri以指定字符或字符串开头</td>
</tr>
<tr>
<td>~</td>
<td>表示区分大小写的正则匹配</td>
</tr>
<tr>
<td>~*</td>
<td>表示不区分大小写的正则匹配</td>
</tr>
<tr>
<td>/</td>
<td>通用匹配，任何请求都会匹配到</td>
</tr>
</tbody>
</table>
<h4 id="规则优先级">规则优先级<a class="headerlink" href="#规则优先级" title="Permanent link">&para;</a></h4>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Text Only</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-51-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-51-1" name="__codelineno-51-1"></a>=  高于  ^~  高于  ~* 等于 ~  高于  /
</code></pre></div></td></tr></table></div>
<h4 id="规则示例">规则示例<a class="headerlink" href="#规则示例" title="Permanent link">&para;</a></h4>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Nginx Configuration File</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-52-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-52-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-52-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-52-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-52-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-52-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-52-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-52-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-52-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-52-10">10</a></span>
<span class="normal"><a href="#__codelineno-52-11">11</a></span>
<span class="normal"><a href="#__codelineno-52-12">12</a></span>
<span class="normal"><a href="#__codelineno-52-13">13</a></span>
<span class="normal"><a href="#__codelineno-52-14">14</a></span>
<span class="normal"><a href="#__codelineno-52-15">15</a></span>
<span class="normal"><a href="#__codelineno-52-16">16</a></span>
<span class="normal"><a href="#__codelineno-52-17">17</a></span>
<span class="normal"><a href="#__codelineno-52-18">18</a></span>
<span class="normal"><a href="#__codelineno-52-19">19</a></span>
<span class="normal"><a href="#__codelineno-52-20">20</a></span>
<span class="normal"><a href="#__codelineno-52-21">21</a></span>
<span class="normal"><a href="#__codelineno-52-22">22</a></span>
<span class="normal"><a href="#__codelineno-52-23">23</a></span>
<span class="normal"><a href="#__codelineno-52-24">24</a></span>
<span class="normal"><a href="#__codelineno-52-25">25</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-52-1" name="__codelineno-52-1"></a><span class="k">location</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;/12.jpg&quot;</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kn">...</span><span class="w"> </span><span class="err">}</span>
<a id="__codelineno-52-2" name="__codelineno-52-2"></a><span class="s">如：</span>
<a id="__codelineno-52-3" name="__codelineno-52-3"></a><span class="s">www.aminglinux.com/12.jpg</span><span class="w"> </span><span class="s">匹配</span>
<a id="__codelineno-52-4" name="__codelineno-52-4"></a><span class="s">www.aminglinux.com/abc/12.jpg</span><span class="w"> </span><span class="s">不匹配</span>
<a id="__codelineno-52-5" name="__codelineno-52-5"></a>
<a id="__codelineno-52-6" name="__codelineno-52-6"></a><span class="s">location</span><span class="w"> </span><span class="s">^~</span><span class="w"> </span><span class="s">&quot;/abc/&quot;</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kn">...</span><span class="w"> </span><span class="err">}</span>
<a id="__codelineno-52-7" name="__codelineno-52-7"></a><span class="s">如：</span>
<a id="__codelineno-52-8" name="__codelineno-52-8"></a><span class="s">www.aminglinux.com/abc/123.html</span><span class="w"> </span><span class="s">匹配</span>
<a id="__codelineno-52-9" name="__codelineno-52-9"></a><span class="s">www.aminglinux.com/a/abc/123.jpg</span><span class="w"> </span><span class="s">不匹配</span>
<a id="__codelineno-52-10" name="__codelineno-52-10"></a>
<a id="__codelineno-52-11" name="__codelineno-52-11"></a><span class="s">location</span><span class="w"> </span><span class="p">~</span><span class="w"> </span><span class="sr">&quot;png&quot;</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kn">...</span><span class="w"> </span><span class="err">}</span>
<a id="__codelineno-52-12" name="__codelineno-52-12"></a><span class="s">如：</span>
<a id="__codelineno-52-13" name="__codelineno-52-13"></a><span class="s">www.aminglinux.com/aaa/bbb/ccc/123.png</span><span class="w"> </span><span class="s">匹配</span>
<a id="__codelineno-52-14" name="__codelineno-52-14"></a><span class="s">www.aminglinux.com/aaa/png/123.html</span><span class="w"> </span><span class="s">匹配</span>
<a id="__codelineno-52-15" name="__codelineno-52-15"></a>
<a id="__codelineno-52-16" name="__codelineno-52-16"></a><span class="s">location</span><span class="w"> </span><span class="p">~</span><span class="sr">*</span><span class="w"> </span><span class="s">&quot;png&quot;</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kn">...</span><span class="w"> </span><span class="err">}</span>
<a id="__codelineno-52-17" name="__codelineno-52-17"></a><span class="s">如：</span>
<a id="__codelineno-52-18" name="__codelineno-52-18"></a><span class="s">www.aminglinux.com/aaa/bbb/ccc/123.PNG</span><span class="w"> </span><span class="s">匹配</span>
<a id="__codelineno-52-19" name="__codelineno-52-19"></a><span class="s">www.aminglinux.com/aaa/png/123.html</span><span class="w"> </span><span class="s">匹配</span>
<a id="__codelineno-52-20" name="__codelineno-52-20"></a>
<a id="__codelineno-52-21" name="__codelineno-52-21"></a>
<a id="__codelineno-52-22" name="__codelineno-52-22"></a><span class="s">location</span><span class="w"> </span><span class="s">/admin/</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kn">...</span><span class="w"> </span><span class="err">}</span>
<a id="__codelineno-52-23" name="__codelineno-52-23"></a><span class="s">如：</span>
<a id="__codelineno-52-24" name="__codelineno-52-24"></a><span class="s">www.aminglinux.com/admin/aaa/1.php</span><span class="w"> </span><span class="s">匹配</span>
<a id="__codelineno-52-25" name="__codelineno-52-25"></a><span class="s">www.aminglinux.com/123/admin/1.php</span><span class="w"> </span><span class="s">不匹配</span>
</code></pre></div></td></tr></table></div>
<h4 id="小常识">小常识<a class="headerlink" href="#小常识" title="Permanent link">&para;</a></h4>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Nginx Configuration File</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-53-1">1</a></span>
<span class="normal"><a href="#__codelineno-53-2">2</a></span>
<span class="normal"><a href="#__codelineno-53-3">3</a></span>
<span class="normal"><a href="#__codelineno-53-4">4</a></span>
<span class="normal"><a href="#__codelineno-53-5">5</a></span>
<span class="normal"><a href="#__codelineno-53-6">6</a></span>
<span class="normal"><a href="#__codelineno-53-7">7</a></span>
<span class="normal"><a href="#__codelineno-53-8">8</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-53-1" name="__codelineno-53-1"></a><span class="k">有些资料上介绍location支持不匹配</span><span class="w"> </span><span class="s">!~，</span>
<a id="__codelineno-53-2" name="__codelineno-53-2"></a><span class="s">如：</span><span class="w"> </span><span class="s">location</span><span class="w"> </span><span class="s">!~</span><span class="w"> </span><span class="s">&#39;png&#39;</span><span class="p">{</span><span class="w"> </span><span class="kn">...</span><span class="w"> </span><span class="err">}</span>
<a id="__codelineno-53-3" name="__codelineno-53-3"></a><span class="s">这是错误的，location不支持</span><span class="w"> </span><span class="s">!~</span>
<a id="__codelineno-53-4" name="__codelineno-53-4"></a>
<a id="__codelineno-53-5" name="__codelineno-53-5"></a><span class="s">如果有这样的需求，可以通过if来实现，</span>
<a id="__codelineno-53-6" name="__codelineno-53-6"></a><span class="s">如：</span><span class="w"> </span><span class="s">if</span><span class="w"> </span><span class="s">(</span><span class="nv">$uri</span><span class="w"> </span><span class="s">!~</span><span class="w"> </span><span class="s">&#39;png&#39;)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kn">...</span><span class="w"> </span><span class="err">}</span>
<a id="__codelineno-53-7" name="__codelineno-53-7"></a>
<a id="__codelineno-53-8" name="__codelineno-53-8"></a><span class="s">注意：location优先级小于if</span>
</code></pre></div></td></tr></table></div>
<h2 id="8nginx代理">8.nginx代理<a class="headerlink" href="#8nginx代理" title="Permanent link">&para;</a></h2>
<h3 id="a正向代理">A.正向代理<a class="headerlink" href="#a正向代理" title="Permanent link">&para;</a></h3>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Text Only</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-54-1">1</a></span>
<span class="normal"><a href="#__codelineno-54-2">2</a></span>
<span class="normal"><a href="#__codelineno-54-3">3</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-54-1" name="__codelineno-54-1"></a>Nginx正向代理使用场景并不多见。
<a id="__codelineno-54-2" name="__codelineno-54-2"></a>需求场景1：
<a id="__codelineno-54-3" name="__codelineno-54-3"></a>如果在机房中，只有一台机器可以联网，其他机器只有内网，内网的机器想用使用yum安装软件包，在能能联网的机器上配置一个正向代理即可。
</code></pre></div></td></tr></table></div>
<h4 id="nginx正向代理配置文件">Nginx正向代理配置文件<a class="headerlink" href="#nginx正向代理配置文件" title="Permanent link">&para;</a></h4>
<p>说明： 以下配置文件为nginx官方提供，该方法只能实现针对http的网站的访问，如果是https就会有问题。要想实现https的正向代理，可以使用一个三方模块，后面介绍。</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Nginx Configuration File</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-55-1">1</a></span>
<span class="normal"><a href="#__codelineno-55-2">2</a></span>
<span class="normal"><a href="#__codelineno-55-3">3</a></span>
<span class="normal"><a href="#__codelineno-55-4">4</a></span>
<span class="normal"><a href="#__codelineno-55-5">5</a></span>
<span class="normal"><a href="#__codelineno-55-6">6</a></span>
<span class="normal"><a href="#__codelineno-55-7">7</a></span>
<span class="normal"><a href="#__codelineno-55-8">8</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-55-1" name="__codelineno-55-1"></a><span class="k">server</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-55-2" name="__codelineno-55-2"></a><span class="w">    </span><span class="kn">listen</span><span class="w"> </span><span class="mi">80</span><span class="w"> </span><span class="s">default_server</span><span class="p">;</span>
<a id="__codelineno-55-3" name="__codelineno-55-3"></a><span class="w">    </span><span class="kn">resolver</span><span class="w"> </span><span class="mi">119</span><span class="s">.29.29.29</span><span class="p">;</span>
<a id="__codelineno-55-4" name="__codelineno-55-4"></a><span class="w">    </span><span class="kn">location</span><span class="w"> </span><span class="s">/</span>
<a id="__codelineno-55-5" name="__codelineno-55-5"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-55-6" name="__codelineno-55-6"></a><span class="w">        </span><span class="kn">proxy_pass</span><span class="w"> </span><span class="s">http://</span><span class="nv">$host$request_uri</span><span class="p">;</span>
<a id="__codelineno-55-7" name="__codelineno-55-7"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-55-8" name="__codelineno-55-8"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<h4 id="nginx正向代理配置执行说明">Nginx正向代理配置执行说明<a class="headerlink" href="#nginx正向代理配置执行说明" title="Permanent link">&para;</a></h4>
<ul>
<li>resolver</li>
</ul>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Nginx Configuration File</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-56-1">1</a></span>
<span class="normal"><a href="#__codelineno-56-2">2</a></span>
<span class="normal"><a href="#__codelineno-56-3">3</a></span>
<span class="normal"><a href="#__codelineno-56-4">4</a></span>
<span class="normal"><a href="#__codelineno-56-5">5</a></span>
<span class="normal"><a href="#__codelineno-56-6">6</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-56-1" name="__codelineno-56-1"></a><span class="k">语法：resolver</span><span class="w"> </span><span class="s">address</span><span class="p">;</span>
<a id="__codelineno-56-2" name="__codelineno-56-2"></a>
<a id="__codelineno-56-3" name="__codelineno-56-3"></a><span class="k">address为DNS服务器的地址，国内通用的DNS</span><span class="w"> </span><span class="mi">119</span><span class="s">.29.29.29为dnspod公司提供。</span><span class="w"> </span><span class="s">国际通用DNS</span><span class="w"> </span><span class="mi">8</span><span class="s">.8.8.8或者8.8.4.4为google提供。</span>
<a id="__codelineno-56-4" name="__codelineno-56-4"></a><span class="s">其他可以参考</span><span class="w"> </span><span class="s">http://dns.lisect.com/</span>
<a id="__codelineno-56-5" name="__codelineno-56-5"></a>
<a id="__codelineno-56-6" name="__codelineno-56-6"></a><span class="s">示例：resolver</span><span class="w"> </span><span class="mi">119</span><span class="s">.29.29.29</span><span class="p">;</span>
</code></pre></div></td></tr></table></div>
<ul>
<li>default_server</li>
</ul>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Text Only</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-57-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-57-1" name="__codelineno-57-1"></a>之所以要设置为默认虚拟主机，是因为这样就不用设置server_name了，任何域名解析过来都可以正常访问。
</code></pre></div></td></tr></table></div>
<ul>
<li>proxy_pass</li>
</ul>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Text Only</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-58-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-58-1" name="__codelineno-58-1"></a>该指令用来设置要代理的目标url，正向代理服务器设置就保持该固定值即可。关于该指令的详细解释在反向代理配置中。
</code></pre></div></td></tr></table></div>
<h4 id="nginx正向代理支持https">Nginx正向代理支持https<a class="headerlink" href="#nginx正向代理支持https" title="Permanent link">&para;</a></h4>
<p>下载三方模块ngx_http_proxy_connect_module，github地址：https://github.com/chobits/ngx_http_proxy_connect_module 注意，不同的Nginx版本，还需要下载不同的patch包。</p>
<p>下面的例子，以1.9.12为例</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-59-1">1</a></span>
<span class="normal"><a href="#__codelineno-59-2">2</a></span>
<span class="normal"><a href="#__codelineno-59-3">3</a></span>
<span class="normal"><a href="#__codelineno-59-4">4</a></span>
<span class="normal"><a href="#__codelineno-59-5">5</a></span>
<span class="normal"><a href="#__codelineno-59-6">6</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-59-1" name="__codelineno-59-1"></a>wget<span class="w"> </span>http://nginx.org/download/nginx-1.9.12.tar.gz
<a id="__codelineno-59-2" name="__codelineno-59-2"></a>tar<span class="w"> </span>-xzvf<span class="w"> </span>nginx-1.9.12.tar.gz
<a id="__codelineno-59-3" name="__codelineno-59-3"></a><span class="nb">cd</span><span class="w"> </span>nginx-1.9.12/
<a id="__codelineno-59-4" name="__codelineno-59-4"></a>patch<span class="w"> </span>-p1<span class="w"> </span>&lt;<span class="w"> </span>/path/to/ngx_http_proxy_connect_module/patch/proxy_connect.patch
<a id="__codelineno-59-5" name="__codelineno-59-5"></a>./configure<span class="w"> </span>--add-dynamic-module<span class="o">=</span>/path/to/ngx_http_proxy_connect_module
<a id="__codelineno-59-6" name="__codelineno-59-6"></a>make<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>make<span class="w"> </span>install
</code></pre></div></td></tr></table></div>
<h4 id="nginx正向代理配置文件_1">Nginx正向代理配置文件<a class="headerlink" href="#nginx正向代理配置文件_1" title="Permanent link">&para;</a></h4>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Nginx Configuration File</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-60-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-60-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-60-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-60-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-60-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-60-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-60-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-60-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-60-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-60-10">10</a></span>
<span class="normal"><a href="#__codelineno-60-11">11</a></span>
<span class="normal"><a href="#__codelineno-60-12">12</a></span>
<span class="normal"><a href="#__codelineno-60-13">13</a></span>
<span class="normal"><a href="#__codelineno-60-14">14</a></span>
<span class="normal"><a href="#__codelineno-60-15">15</a></span>
<span class="normal"><a href="#__codelineno-60-16">16</a></span>
<span class="normal"><a href="#__codelineno-60-17">17</a></span>
<span class="normal"><a href="#__codelineno-60-18">18</a></span>
<span class="normal"><a href="#__codelineno-60-19">19</a></span>
<span class="normal"><a href="#__codelineno-60-20">20</a></span>
<span class="normal"><a href="#__codelineno-60-21">21</a></span>
<span class="normal"><a href="#__codelineno-60-22">22</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-60-1" name="__codelineno-60-1"></a><span class="k">server</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-60-2" name="__codelineno-60-2"></a><span class="w">     </span><span class="kn">listen</span><span class="w">                         </span><span class="mi">3128</span><span class="p">;</span>
<a id="__codelineno-60-3" name="__codelineno-60-3"></a>
<a id="__codelineno-60-4" name="__codelineno-60-4"></a>
<a id="__codelineno-60-5" name="__codelineno-60-5"></a><span class="w">     </span><span class="c1"># dns resolver used by forward proxying</span>
<a id="__codelineno-60-6" name="__codelineno-60-6"></a><span class="w">     </span><span class="kn">resolver</span><span class="w">                       </span><span class="mi">119</span><span class="s">.29.29.29</span><span class="p">;</span>
<a id="__codelineno-60-7" name="__codelineno-60-7"></a>
<a id="__codelineno-60-8" name="__codelineno-60-8"></a>
<a id="__codelineno-60-9" name="__codelineno-60-9"></a><span class="w">     </span><span class="c1"># forward proxy for CONNECT request</span>
<a id="__codelineno-60-10" name="__codelineno-60-10"></a><span class="w">     </span><span class="kn">proxy_connect</span><span class="p">;</span>
<a id="__codelineno-60-11" name="__codelineno-60-11"></a><span class="w">     </span><span class="kn">proxy_connect_allow</span><span class="w">            </span><span class="mi">80</span><span class="w"> </span><span class="mi">443</span><span class="w"> </span><span class="mi">3000</span><span class="w"> </span><span class="mi">9070</span><span class="w"> </span><span class="mi">9074</span><span class="p">;</span>
<a id="__codelineno-60-12" name="__codelineno-60-12"></a><span class="w">     </span><span class="kn">proxy_connect_connect_timeout</span><span class="w">  </span><span class="s">10s</span><span class="p">;</span>
<a id="__codelineno-60-13" name="__codelineno-60-13"></a><span class="w">     </span><span class="kn">proxy_connect_read_timeout</span><span class="w">     </span><span class="s">10s</span><span class="p">;</span>
<a id="__codelineno-60-14" name="__codelineno-60-14"></a><span class="w">     </span><span class="kn">proxy_connect_send_timeout</span><span class="w">     </span><span class="s">10s</span><span class="p">;</span>
<a id="__codelineno-60-15" name="__codelineno-60-15"></a>
<a id="__codelineno-60-16" name="__codelineno-60-16"></a>
<a id="__codelineno-60-17" name="__codelineno-60-17"></a><span class="w">     </span><span class="c1"># forward proxy for non-CONNECT request</span>
<a id="__codelineno-60-18" name="__codelineno-60-18"></a><span class="w">     </span><span class="kn">location</span><span class="w"> </span><span class="s">/</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-60-19" name="__codelineno-60-19"></a><span class="w">         </span><span class="kn">proxy_pass</span><span class="w"> </span><span class="s">http://</span><span class="nv">$host</span><span class="p">;</span>
<a id="__codelineno-60-20" name="__codelineno-60-20"></a><span class="w">         </span><span class="kn">proxy_set_header</span><span class="w"> </span><span class="s">Host</span><span class="w"> </span><span class="nv">$host</span><span class="p">;</span>
<a id="__codelineno-60-21" name="__codelineno-60-21"></a><span class="w">     </span><span class="p">}</span>
<a id="__codelineno-60-22" name="__codelineno-60-22"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<h4 id="测试示例">测试示例<a class="headerlink" href="#测试示例" title="Permanent link">&para;</a></h4>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-61-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-61-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-61-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-61-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-61-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-61-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-61-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-61-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-61-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-61-10">10</a></span>
<span class="normal"><a href="#__codelineno-61-11">11</a></span>
<span class="normal"><a href="#__codelineno-61-12">12</a></span>
<span class="normal"><a href="#__codelineno-61-13">13</a></span>
<span class="normal"><a href="#__codelineno-61-14">14</a></span>
<span class="normal"><a href="#__codelineno-61-15">15</a></span>
<span class="normal"><a href="#__codelineno-61-16">16</a></span>
<span class="normal"><a href="#__codelineno-61-17">17</a></span>
<span class="normal"><a href="#__codelineno-61-18">18</a></span>
<span class="normal"><a href="#__codelineno-61-19">19</a></span>
<span class="normal"><a href="#__codelineno-61-20">20</a></span>
<span class="normal"><a href="#__codelineno-61-21">21</a></span>
<span class="normal"><a href="#__codelineno-61-22">22</a></span>
<span class="normal"><a href="#__codelineno-61-23">23</a></span>
<span class="normal"><a href="#__codelineno-61-24">24</a></span>
<span class="normal"><a href="#__codelineno-61-25">25</a></span>
<span class="normal"><a href="#__codelineno-61-26">26</a></span>
<span class="normal"><a href="#__codelineno-61-27">27</a></span>
<span class="normal"><a href="#__codelineno-61-28">28</a></span>
<span class="normal"><a href="#__codelineno-61-29">29</a></span>
<span class="normal"><a href="#__codelineno-61-30">30</a></span>
<span class="normal"><a href="#__codelineno-61-31">31</a></span>
<span class="normal"><a href="#__codelineno-61-32">32</a></span>
<span class="normal"><a href="#__codelineno-61-33">33</a></span>
<span class="normal"><a href="#__codelineno-61-34">34</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-61-1" name="__codelineno-61-1"></a>$<span class="w"> </span>curl<span class="w"> </span>https://github.com/<span class="w"> </span>-v<span class="w"> </span>-x<span class="w"> </span><span class="m">127</span>.0.0.1:3128
<a id="__codelineno-61-2" name="__codelineno-61-2"></a>*<span class="w">   </span>Trying<span class="w"> </span><span class="m">127</span>.0.0.1...<span class="w">                                           </span>-.
<a id="__codelineno-61-3" name="__codelineno-61-3"></a>*<span class="w"> </span>Connected<span class="w"> </span>to<span class="w"> </span><span class="m">127</span>.0.0.1<span class="w"> </span><span class="o">(</span><span class="m">127</span>.0.0.1<span class="o">)</span><span class="w"> </span>port<span class="w"> </span><span class="m">3128</span><span class="w"> </span><span class="o">(</span><span class="c1">#0)                | curl creates TCP connection with nginx (with proxy_connect module).</span>
<a id="__codelineno-61-4" name="__codelineno-61-4"></a>*<span class="w"> </span>Establish<span class="w"> </span>HTTP<span class="w"> </span>proxy<span class="w"> </span>tunnel<span class="w"> </span>to<span class="w"> </span>github.com:443<span class="w">                   </span>-<span class="s1">&#39;</span>
<a id="__codelineno-61-5" name="__codelineno-61-5"></a><span class="s1">&gt; CONNECT github.com:443 HTTP/1.1                                 -.</span>
<a id="__codelineno-61-6" name="__codelineno-61-6"></a><span class="s1">&gt; Host: github.com:443                                         (1) | curl sends CONNECT request to create tunnel.</span>
<a id="__codelineno-61-7" name="__codelineno-61-7"></a><span class="s1">&gt; User-Agent: curl/7.43.0                                          |</span>
<a id="__codelineno-61-8" name="__codelineno-61-8"></a><span class="s1">&gt; Proxy-Connection: Keep-Alive                                    -&#39;</span>
<a id="__codelineno-61-9" name="__codelineno-61-9"></a>&gt;
<a id="__codelineno-61-10" name="__codelineno-61-10"></a>&lt;<span class="w"> </span>HTTP/1.0<span class="w"> </span><span class="m">200</span><span class="w"> </span>Connection<span class="w"> </span>Established<span class="w">                             </span>.-<span class="w"> </span>nginx<span class="w"> </span>replies<span class="w"> </span><span class="m">200</span><span class="w"> </span>that<span class="w"> </span>tunnel<span class="w"> </span>is<span class="w"> </span>established.
<a id="__codelineno-61-11" name="__codelineno-61-11"></a>&lt;<span class="w"> </span>Proxy-agent:<span class="w"> </span>nginx<span class="w">                                           </span><span class="o">(</span><span class="m">2</span><span class="o">)</span><span class="p">|</span><span class="w">  </span><span class="o">(</span>The<span class="w"> </span>client<span class="w"> </span>is<span class="w"> </span>now<span class="w"> </span>being<span class="w"> </span>proxied<span class="w"> </span>to<span class="w"> </span>the<span class="w"> </span>remote<span class="w"> </span>host.<span class="w"> </span>Any<span class="w"> </span>data<span class="w"> </span>sent
<a id="__codelineno-61-12" name="__codelineno-61-12"></a>&lt;<span class="w">                                                                 </span><span class="s1">&#39;-  to nginx is now forwarded, unmodified, to the remote host)</span>
<a id="__codelineno-61-13" name="__codelineno-61-13"></a>
<a id="__codelineno-61-14" name="__codelineno-61-14"></a><span class="s1">* Proxy replied OK to CONNECT request</span>
<a id="__codelineno-61-15" name="__codelineno-61-15"></a><span class="s1">* TLS 1.2 connection using TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256  -.</span>
<a id="__codelineno-61-16" name="__codelineno-61-16"></a><span class="s1">* Server certificate: github.com                                   |</span>
<a id="__codelineno-61-17" name="__codelineno-61-17"></a><span class="s1">* Server certificate: DigiCert SHA2 Extended Validation Server CA  | curl sends &quot;https://github.com&quot; request via tunnel,</span>
<a id="__codelineno-61-18" name="__codelineno-61-18"></a><span class="s1">* Server certificate: DigiCert High Assurance EV Root CA           | proxy_connect module will proxy data to remote host (github.com).</span>
<a id="__codelineno-61-19" name="__codelineno-61-19"></a><span class="s1">&gt; GET / HTTP/1.1                                                   |</span>
<a id="__codelineno-61-20" name="__codelineno-61-20"></a><span class="s1">&gt; Host: github.com                                             (3) |</span>
<a id="__codelineno-61-21" name="__codelineno-61-21"></a><span class="s1">&gt; User-Agent: curl/7.43.0                                          |</span>
<a id="__codelineno-61-22" name="__codelineno-61-22"></a><span class="s1">&gt; Accept: */*                                                     -&#39;</span>
<a id="__codelineno-61-23" name="__codelineno-61-23"></a>&gt;
<a id="__codelineno-61-24" name="__codelineno-61-24"></a>&lt;<span class="w"> </span>HTTP/1.1<span class="w"> </span><span class="m">200</span><span class="w"> </span>OK<span class="w">                                                 </span>.-
<a id="__codelineno-61-25" name="__codelineno-61-25"></a>&lt;<span class="w"> </span>Date:<span class="w"> </span>Fri,<span class="w"> </span><span class="m">11</span><span class="w"> </span>Aug<span class="w"> </span><span class="m">2017</span><span class="w"> </span><span class="m">04</span>:13:57<span class="w"> </span>GMT<span class="w">                             </span><span class="p">|</span>
<a id="__codelineno-61-26" name="__codelineno-61-26"></a>&lt;<span class="w"> </span>Content-Type:<span class="w"> </span>text/html<span class="p">;</span><span class="w"> </span><span class="nv">charset</span><span class="o">=</span>utf-8<span class="w">                          </span><span class="p">|</span><span class="w">  </span>Any<span class="w"> </span>data<span class="w"> </span>received<span class="w"> </span>from<span class="w"> </span>remote<span class="w"> </span>host<span class="w"> </span>will<span class="w"> </span>be<span class="w"> </span>sent<span class="w"> </span>to<span class="w"> </span>client
<a id="__codelineno-61-27" name="__codelineno-61-27"></a>&lt;<span class="w"> </span>Transfer-Encoding:<span class="w"> </span>chunked<span class="w">                                      </span><span class="p">|</span><span class="w">  </span>by<span class="w"> </span>proxy_connect<span class="w"> </span>module.
<a id="__codelineno-61-28" name="__codelineno-61-28"></a>&lt;<span class="w"> </span>Server:<span class="w"> </span>GitHub.com<span class="w">                                           </span><span class="o">(</span><span class="m">4</span><span class="o">)</span><span class="p">|</span>
<a id="__codelineno-61-29" name="__codelineno-61-29"></a>&lt;<span class="w"> </span>Status:<span class="w"> </span><span class="m">200</span><span class="w"> </span>OK<span class="w">                                                  </span><span class="p">|</span>
<a id="__codelineno-61-30" name="__codelineno-61-30"></a>&lt;<span class="w"> </span>Cache-Control:<span class="w"> </span>no-cache<span class="w">                                         </span><span class="p">|</span>
<a id="__codelineno-61-31" name="__codelineno-61-31"></a>&lt;<span class="w"> </span>Vary:<span class="w"> </span>X-PJAX<span class="w">                                                    </span><span class="p">|</span>
<a id="__codelineno-61-32" name="__codelineno-61-32"></a>...<span class="w">                                                               </span><span class="p">|</span>
<a id="__codelineno-61-33" name="__codelineno-61-33"></a>...<span class="w"> </span>&lt;other<span class="w"> </span>response<span class="w"> </span>headers<span class="w"> </span><span class="p">&amp;</span><span class="w"> </span>response<span class="w"> </span>body&gt;<span class="w"> </span>...<span class="w">                  </span><span class="p">|</span>
<a id="__codelineno-61-34" name="__codelineno-61-34"></a>...<span class="w">                                                               </span>
</code></pre></div></td></tr></table></div>
<h4 id="linux机器上配置全局代理">linux机器上配置全局代理<a class="headerlink" href="#linux机器上配置全局代理" title="Permanent link">&para;</a></h4>
<p>在 /etc/profile 文件中增加如下三项。</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Text Only</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-62-1">1</a></span>
<span class="normal"><a href="#__codelineno-62-2">2</a></span>
<span class="normal"><a href="#__codelineno-62-3">3</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-62-1" name="__codelineno-62-1"></a>export proxy=&quot;http://{proxy_server_ip}:3128&quot;
<a id="__codelineno-62-2" name="__codelineno-62-2"></a>export http_proxy=$proxy
<a id="__codelineno-62-3" name="__codelineno-62-3"></a>export https_proxy=$proxy
</code></pre></div></td></tr></table></div>
<p>使配置生效</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-63-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-63-1" name="__codelineno-63-1"></a><span class="nb">source</span><span class="w"> </span>/etc/profile
</code></pre></div></td></tr></table></div>
<p>对那些没有域名解析通过绑定hosts文件来访问的域名，不让其走http/https代理，需要额外增加环境变量：</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-64-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-64-1" name="__codelineno-64-1"></a><span class="nb">export</span><span class="w"> </span><span class="nv">no_proxy</span><span class="o">=</span><span class="s1">&#39;a.test.com,127.0.0.1,2.2.2.2&#39;</span>
</code></pre></div></td></tr></table></div>
<h3 id="b反向代理">B.反向代理<a class="headerlink" href="#b反向代理" title="Permanent link">&para;</a></h3>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Nginx Configuration File</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-65-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-65-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-65-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-65-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-65-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-65-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-65-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-65-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-65-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-65-10">10</a></span>
<span class="normal"><a href="#__codelineno-65-11">11</a></span>
<span class="normal"><a href="#__codelineno-65-12">12</a></span>
<span class="normal"><a href="#__codelineno-65-13">13</a></span>
<span class="normal"><a href="#__codelineno-65-14">14</a></span>
<span class="normal"><a href="#__codelineno-65-15">15</a></span>
<span class="normal"><a href="#__codelineno-65-16">16</a></span>
<span class="normal"><a href="#__codelineno-65-17">17</a></span>
<span class="normal"><a href="#__codelineno-65-18">18</a></span>
<span class="normal"><a href="#__codelineno-65-19">19</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-65-1" name="__codelineno-65-1"></a><span class="k">Nginx反向代理在生产环境中使用很多的。</span>
<a id="__codelineno-65-2" name="__codelineno-65-2"></a>
<a id="__codelineno-65-3" name="__codelineno-65-3"></a><span class="s">场景1：</span>
<a id="__codelineno-65-4" name="__codelineno-65-4"></a><span class="s">域名没有备案，可以把域名解析到香港一台云主机上，在香港云主机做个代理，而网站数据是在大陆的服务器上。</span>
<a id="__codelineno-65-5" name="__codelineno-65-5"></a>
<a id="__codelineno-65-6" name="__codelineno-65-6"></a><span class="s">示例1：</span>
<a id="__codelineno-65-7" name="__codelineno-65-7"></a><span class="s">server</span><span class="w"> </span>
<a id="__codelineno-65-8" name="__codelineno-65-8"></a><span class="p">{</span>
<a id="__codelineno-65-9" name="__codelineno-65-9"></a><span class="w">    </span><span class="kn">listen</span><span class="w"> </span><span class="mi">80</span><span class="p">;</span>
<a id="__codelineno-65-10" name="__codelineno-65-10"></a><span class="w">    </span><span class="kn">server_name</span><span class="w"> </span><span class="s">aminglinux.com</span><span class="p">;</span>
<a id="__codelineno-65-11" name="__codelineno-65-11"></a>
<a id="__codelineno-65-12" name="__codelineno-65-12"></a><span class="w">    </span><span class="kn">location</span><span class="w"> </span><span class="s">/</span>
<a id="__codelineno-65-13" name="__codelineno-65-13"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-65-14" name="__codelineno-65-14"></a><span class="w">        </span><span class="kn">proxy_pass</span><span class="w"> </span><span class="s">http://123.23.13.11/</span><span class="p">;</span>
<a id="__codelineno-65-15" name="__codelineno-65-15"></a><span class="w">        </span><span class="kn">proxy_set_header</span><span class="w"> </span><span class="s">Host</span><span class="w">   </span><span class="nv">$host</span><span class="p">;</span>
<a id="__codelineno-65-16" name="__codelineno-65-16"></a><span class="w">        </span><span class="kn">proxy_set_header</span><span class="w"> </span><span class="s">X-Real-IP</span><span class="w">      </span><span class="nv">$remote_addr</span><span class="p">;</span>
<a id="__codelineno-65-17" name="__codelineno-65-17"></a><span class="w">        </span><span class="kn">proxy_set_header</span><span class="w"> </span><span class="s">X-Forwarded-For</span><span class="w"> </span><span class="nv">$proxy_add_x_forwarded_for</span><span class="p">;</span>
<a id="__codelineno-65-18" name="__codelineno-65-18"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-65-19" name="__codelineno-65-19"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<h4 id="配置说明">配置说明<a class="headerlink" href="#配置说明" title="Permanent link">&para;</a></h4>
<h5 id="1-proxy_pass">1. proxy_pass<a class="headerlink" href="#1-proxy_pass" title="Permanent link">&para;</a></h5>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Nginx Configuration File</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-66-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-66-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-66-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-66-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-66-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-66-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-66-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-66-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-66-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-66-10">10</a></span>
<span class="normal"><a href="#__codelineno-66-11">11</a></span>
<span class="normal"><a href="#__codelineno-66-12">12</a></span>
<span class="normal"><a href="#__codelineno-66-13">13</a></span>
<span class="normal"><a href="#__codelineno-66-14">14</a></span>
<span class="normal"><a href="#__codelineno-66-15">15</a></span>
<span class="normal"><a href="#__codelineno-66-16">16</a></span>
<span class="normal"><a href="#__codelineno-66-17">17</a></span>
<span class="normal"><a href="#__codelineno-66-18">18</a></span>
<span class="normal"><a href="#__codelineno-66-19">19</a></span>
<span class="normal"><a href="#__codelineno-66-20">20</a></span>
<span class="normal"><a href="#__codelineno-66-21">21</a></span>
<span class="normal"><a href="#__codelineno-66-22">22</a></span>
<span class="normal"><a href="#__codelineno-66-23">23</a></span>
<span class="normal"><a href="#__codelineno-66-24">24</a></span>
<span class="normal"><a href="#__codelineno-66-25">25</a></span>
<span class="normal"><a href="#__codelineno-66-26">26</a></span>
<span class="normal"><a href="#__codelineno-66-27">27</a></span>
<span class="normal"><a href="#__codelineno-66-28">28</a></span>
<span class="normal"><a href="#__codelineno-66-29">29</a></span>
<span class="normal"><a href="#__codelineno-66-30">30</a></span>
<span class="normal"><a href="#__codelineno-66-31">31</a></span>
<span class="normal"><a href="#__codelineno-66-32">32</a></span>
<span class="normal"><a href="#__codelineno-66-33">33</a></span>
<span class="normal"><a href="#__codelineno-66-34">34</a></span>
<span class="normal"><a href="#__codelineno-66-35">35</a></span>
<span class="normal"><a href="#__codelineno-66-36">36</a></span>
<span class="normal"><a href="#__codelineno-66-37">37</a></span>
<span class="normal"><a href="#__codelineno-66-38">38</a></span>
<span class="normal"><a href="#__codelineno-66-39">39</a></span>
<span class="normal"><a href="#__codelineno-66-40">40</a></span>
<span class="normal"><a href="#__codelineno-66-41">41</a></span>
<span class="normal"><a href="#__codelineno-66-42">42</a></span>
<span class="normal"><a href="#__codelineno-66-43">43</a></span>
<span class="normal"><a href="#__codelineno-66-44">44</a></span>
<span class="normal"><a href="#__codelineno-66-45">45</a></span>
<span class="normal"><a href="#__codelineno-66-46">46</a></span>
<span class="normal"><a href="#__codelineno-66-47">47</a></span>
<span class="normal"><a href="#__codelineno-66-48">48</a></span>
<span class="normal"><a href="#__codelineno-66-49">49</a></span>
<span class="normal"><a href="#__codelineno-66-50">50</a></span>
<span class="normal"><a href="#__codelineno-66-51">51</a></span>
<span class="normal"><a href="#__codelineno-66-52">52</a></span>
<span class="normal"><a href="#__codelineno-66-53">53</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-66-1" name="__codelineno-66-1"></a><span class="k">在正向代理中，已经使用过该指令。</span>
<a id="__codelineno-66-2" name="__codelineno-66-2"></a><span class="s">格式很简单：</span><span class="w"> </span><span class="s">proxy_pass</span><span class="w">  </span><span class="s">URL</span><span class="p">;</span>
<a id="__codelineno-66-3" name="__codelineno-66-3"></a><span class="k">其中URL包含：传输协议（http://,</span><span class="w"> </span><span class="s">https://等）、主机名（域名或者IP:PORT）、uri。</span>
<a id="__codelineno-66-4" name="__codelineno-66-4"></a>
<a id="__codelineno-66-5" name="__codelineno-66-5"></a><span class="s">示例如下：</span>
<a id="__codelineno-66-6" name="__codelineno-66-6"></a><span class="s">proxy_pass</span><span class="w"> </span><span class="s">http://www.aminglinux.com/</span><span class="p">;</span>
<a id="__codelineno-66-7" name="__codelineno-66-7"></a><span class="k">proxy_pass</span><span class="w"> </span><span class="s">http://192.168.200.101:8080/uri</span><span class="p">;</span>
<a id="__codelineno-66-8" name="__codelineno-66-8"></a><span class="k">proxy_pass</span><span class="w"> </span><span class="s">unix:/tmp/www.sock</span><span class="p">;</span>
<a id="__codelineno-66-9" name="__codelineno-66-9"></a>
<a id="__codelineno-66-10" name="__codelineno-66-10"></a><span class="k">对于proxy_pass的配置有几种情况需要注意。</span>
<a id="__codelineno-66-11" name="__codelineno-66-11"></a><span class="s">示例2：</span>
<a id="__codelineno-66-12" name="__codelineno-66-12"></a><span class="s">location</span><span class="w"> </span><span class="s">/aming/</span>
<a id="__codelineno-66-13" name="__codelineno-66-13"></a><span class="p">{</span>
<a id="__codelineno-66-14" name="__codelineno-66-14"></a><span class="w">    </span><span class="kn">proxy_pass</span><span class="w"> </span><span class="s">http://192.168.1.10</span><span class="p">;</span>
<a id="__codelineno-66-15" name="__codelineno-66-15"></a><span class="w">    </span><span class="kn">...</span>
<a id="__codelineno-66-16" name="__codelineno-66-16"></a><span class="err">}</span>
<a id="__codelineno-66-17" name="__codelineno-66-17"></a>
<a id="__codelineno-66-18" name="__codelineno-66-18"></a>
<a id="__codelineno-66-19" name="__codelineno-66-19"></a><span class="s">示例3：</span>
<a id="__codelineno-66-20" name="__codelineno-66-20"></a><span class="s">location</span><span class="w"> </span><span class="s">/aming/</span>
<a id="__codelineno-66-21" name="__codelineno-66-21"></a><span class="p">{</span>
<a id="__codelineno-66-22" name="__codelineno-66-22"></a><span class="w">    </span><span class="kn">proxy_pass</span><span class="w"> </span><span class="s">http://192.168.1.10/</span><span class="p">;</span>
<a id="__codelineno-66-23" name="__codelineno-66-23"></a><span class="w">    </span><span class="kn">...</span>
<a id="__codelineno-66-24" name="__codelineno-66-24"></a><span class="err">}</span>
<a id="__codelineno-66-25" name="__codelineno-66-25"></a>
<a id="__codelineno-66-26" name="__codelineno-66-26"></a><span class="s">示例4：</span>
<a id="__codelineno-66-27" name="__codelineno-66-27"></a><span class="s">location</span><span class="w"> </span><span class="s">/aming/</span>
<a id="__codelineno-66-28" name="__codelineno-66-28"></a><span class="p">{</span>
<a id="__codelineno-66-29" name="__codelineno-66-29"></a><span class="w">    </span><span class="kn">proxy_pass</span><span class="w"> </span><span class="s">http://192.168.1.10/linux/</span><span class="p">;</span>
<a id="__codelineno-66-30" name="__codelineno-66-30"></a><span class="w">    </span><span class="kn">...</span>
<a id="__codelineno-66-31" name="__codelineno-66-31"></a><span class="err">}</span>
<a id="__codelineno-66-32" name="__codelineno-66-32"></a>
<a id="__codelineno-66-33" name="__codelineno-66-33"></a><span class="s">示例5：</span>
<a id="__codelineno-66-34" name="__codelineno-66-34"></a><span class="s">location</span><span class="w"> </span><span class="s">/aming/</span>
<a id="__codelineno-66-35" name="__codelineno-66-35"></a><span class="p">{</span>
<a id="__codelineno-66-36" name="__codelineno-66-36"></a><span class="w">    </span><span class="kn">proxy_pass</span><span class="w"> </span><span class="s">http://192.168.1.10/linux</span><span class="p">;</span>
<a id="__codelineno-66-37" name="__codelineno-66-37"></a><span class="w">    </span><span class="kn">...</span>
<a id="__codelineno-66-38" name="__codelineno-66-38"></a><span class="err">}</span>
<a id="__codelineno-66-39" name="__codelineno-66-39"></a>
<a id="__codelineno-66-40" name="__codelineno-66-40"></a><span class="s">假设server_name为www.aminglinux.com</span>
<a id="__codelineno-66-41" name="__codelineno-66-41"></a><span class="s">当请求http://www.aminglinux.com/aming/a.html的时候，以上示例2-5分别访问的结果是</span>
<a id="__codelineno-66-42" name="__codelineno-66-42"></a>
<a id="__codelineno-66-43" name="__codelineno-66-43"></a><span class="s">示例2：http://192.168.1.10/aming/a.html</span>
<a id="__codelineno-66-44" name="__codelineno-66-44"></a>
<a id="__codelineno-66-45" name="__codelineno-66-45"></a><span class="s">示例3：http://192.168.1.10/a.html</span>
<a id="__codelineno-66-46" name="__codelineno-66-46"></a>
<a id="__codelineno-66-47" name="__codelineno-66-47"></a><span class="s">示例4：http://192.168.1.10/linux/a.html</span>
<a id="__codelineno-66-48" name="__codelineno-66-48"></a>
<a id="__codelineno-66-49" name="__codelineno-66-49"></a><span class="s">示例5：http://192.168.1.10/linuxa.html</span>
<a id="__codelineno-66-50" name="__codelineno-66-50"></a>
<a id="__codelineno-66-51" name="__codelineno-66-51"></a>
<a id="__codelineno-66-52" name="__codelineno-66-52"></a><span class="s">总结：代理加上根&#39;/path&#39;的话，会把location的路径也加上。</span>
<a id="__codelineno-66-53" name="__codelineno-66-53"></a><span class="w">     </span><span class="s">加上&#39;/&#39;比较规范，且可读性强</span>
</code></pre></div></td></tr></table></div>
<h5 id="2-proxy_set_header">2. proxy_set_header<a class="headerlink" href="#2-proxy_set_header" title="Permanent link">&para;</a></h5>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Nginx Configuration File</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-67-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-67-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-67-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-67-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-67-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-67-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-67-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-67-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-67-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-67-10">10</a></span>
<span class="normal"><a href="#__codelineno-67-11">11</a></span>
<span class="normal"><a href="#__codelineno-67-12">12</a></span>
<span class="normal"><a href="#__codelineno-67-13">13</a></span>
<span class="normal"><a href="#__codelineno-67-14">14</a></span>
<span class="normal"><a href="#__codelineno-67-15">15</a></span>
<span class="normal"><a href="#__codelineno-67-16">16</a></span>
<span class="normal"><a href="#__codelineno-67-17">17</a></span>
<span class="normal"><a href="#__codelineno-67-18">18</a></span>
<span class="normal"><a href="#__codelineno-67-19">19</a></span>
<span class="normal"><a href="#__codelineno-67-20">20</a></span>
<span class="normal"><a href="#__codelineno-67-21">21</a></span>
<span class="normal"><a href="#__codelineno-67-22">22</a></span>
<span class="normal"><a href="#__codelineno-67-23">23</a></span>
<span class="normal"><a href="#__codelineno-67-24">24</a></span>
<span class="normal"><a href="#__codelineno-67-25">25</a></span>
<span class="normal"><a href="#__codelineno-67-26">26</a></span>
<span class="normal"><a href="#__codelineno-67-27">27</a></span>
<span class="normal"><a href="#__codelineno-67-28">28</a></span>
<span class="normal"><a href="#__codelineno-67-29">29</a></span>
<span class="normal"><a href="#__codelineno-67-30">30</a></span>
<span class="normal"><a href="#__codelineno-67-31">31</a></span>
<span class="normal"><a href="#__codelineno-67-32">32</a></span>
<span class="normal"><a href="#__codelineno-67-33">33</a></span>
<span class="normal"><a href="#__codelineno-67-34">34</a></span>
<span class="normal"><a href="#__codelineno-67-35">35</a></span>
<span class="normal"><a href="#__codelineno-67-36">36</a></span>
<span class="normal"><a href="#__codelineno-67-37">37</a></span>
<span class="normal"><a href="#__codelineno-67-38">38</a></span>
<span class="normal"><a href="#__codelineno-67-39">39</a></span>
<span class="normal"><a href="#__codelineno-67-40">40</a></span>
<span class="normal"><a href="#__codelineno-67-41">41</a></span>
<span class="normal"><a href="#__codelineno-67-42">42</a></span>
<span class="normal"><a href="#__codelineno-67-43">43</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-67-1" name="__codelineno-67-1"></a><span class="k">proxy_set_header用来设定被代理服务器接收到的header信息。</span>
<a id="__codelineno-67-2" name="__codelineno-67-2"></a>
<a id="__codelineno-67-3" name="__codelineno-67-3"></a><span class="s">语法：proxy_set_header</span><span class="w"> </span><span class="s">field</span><span class="w"> </span><span class="s">value</span><span class="p">;</span>
<a id="__codelineno-67-4" name="__codelineno-67-4"></a><span class="k">field为要更改的项目，也可以理解为变量的名字，比如host</span>
<a id="__codelineno-67-5" name="__codelineno-67-5"></a><span class="s">value为变量的值</span>
<a id="__codelineno-67-6" name="__codelineno-67-6"></a>
<a id="__codelineno-67-7" name="__codelineno-67-7"></a><span class="s">如果不设置proxy_set_header，则默认host的值为proxy_pass后面跟的那个域名或者IP（一般写IP），</span>
<a id="__codelineno-67-8" name="__codelineno-67-8"></a><span class="s">比如示例4，请求到后端的服务器上时，完整请求uri为：http://192.168.1.10/linux/a.html</span>
<a id="__codelineno-67-9" name="__codelineno-67-9"></a>
<a id="__codelineno-67-10" name="__codelineno-67-10"></a><span class="s">如果设置proxy_set_header，如</span><span class="w"> </span><span class="s">proxy_set_header</span><span class="w"> </span><span class="s">host</span><span class="w"> </span><span class="nv">$host</span><span class="p">;</span>
<a id="__codelineno-67-11" name="__codelineno-67-11"></a><span class="k">比如示例4，请求到后端的服务器完整uri为：http://www.aminglinux.com/linux/a.html</span>
<a id="__codelineno-67-12" name="__codelineno-67-12"></a>
<a id="__codelineno-67-13" name="__codelineno-67-13"></a><span class="s">proxy_set_header</span><span class="w"> </span><span class="s">X-Real-IP</span><span class="w"> </span><span class="nv">$remote_addr</span><span class="p">;</span><span class="k">和proxy_set_header</span><span class="w"> </span><span class="s">X-Forwarded-For</span><span class="w"> </span><span class="nv">$proxy_add_x_forwarded_for</span><span class="p">;</span>
<a id="__codelineno-67-14" name="__codelineno-67-14"></a><span class="k">用来设置被代理端接收到的远程客户端IP，如果不设置，则header信息中并不会透传远程真实客户端的IP地址。</span>
<a id="__codelineno-67-15" name="__codelineno-67-15"></a><span class="s">可以用如下示例来测试：</span>
<a id="__codelineno-67-16" name="__codelineno-67-16"></a>
<a id="__codelineno-67-17" name="__codelineno-67-17"></a>
<a id="__codelineno-67-18" name="__codelineno-67-18"></a><span class="s">示例6(被代理端)C端</span>
<a id="__codelineno-67-19" name="__codelineno-67-19"></a><span class="s">server</span><span class="p">{</span>
<a id="__codelineno-67-20" name="__codelineno-67-20"></a><span class="w">    </span><span class="kn">listen</span><span class="w"> </span><span class="mi">8080</span><span class="p">;</span>
<a id="__codelineno-67-21" name="__codelineno-67-21"></a><span class="w">    </span><span class="kn">server_name</span><span class="w"> </span><span class="s">www.aminglinux.com</span><span class="p">;</span>
<a id="__codelineno-67-22" name="__codelineno-67-22"></a><span class="w">    </span><span class="kn">root</span><span class="w"> </span><span class="s">/tmp/123.com_8080</span><span class="p">;</span>
<a id="__codelineno-67-23" name="__codelineno-67-23"></a><span class="w">    </span><span class="kn">index</span><span class="w"> </span><span class="s">index.html</span><span class="p">;</span>
<a id="__codelineno-67-24" name="__codelineno-67-24"></a><span class="w">        </span><span class="kn">location</span><span class="w"> </span><span class="s">/linux/</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-67-25" name="__codelineno-67-25"></a><span class="w">        </span><span class="kn">echo</span><span class="w"> </span><span class="s">&quot;</span><span class="nv">$host&quot;</span><span class="p">;</span>
<a id="__codelineno-67-26" name="__codelineno-67-26"></a><span class="w">        </span><span class="kn">echo</span><span class="w"> </span><span class="nv">$remote_addr</span><span class="p">;</span>
<a id="__codelineno-67-27" name="__codelineno-67-27"></a><span class="w">        </span><span class="kn">echo</span><span class="w"> </span><span class="nv">$proxy_add_x_forwarded_for</span><span class="p">;</span>
<a id="__codelineno-67-28" name="__codelineno-67-28"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-67-29" name="__codelineno-67-29"></a><span class="p">}</span>
<a id="__codelineno-67-30" name="__codelineno-67-30"></a>
<a id="__codelineno-67-31" name="__codelineno-67-31"></a><span class="k">示例7（代理服务器上）B端</span>
<a id="__codelineno-67-32" name="__codelineno-67-32"></a><span class="s">server</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-67-33" name="__codelineno-67-33"></a><span class="w">    </span><span class="kn">listen</span><span class="w"> </span><span class="mi">80</span><span class="p">;</span>
<a id="__codelineno-67-34" name="__codelineno-67-34"></a><span class="w">    </span><span class="kn">server_name</span><span class="w"> </span><span class="s">www.aminglinux.com</span><span class="p">;</span>
<a id="__codelineno-67-35" name="__codelineno-67-35"></a>
<a id="__codelineno-67-36" name="__codelineno-67-36"></a><span class="w">    </span><span class="kn">location</span><span class="w"> </span><span class="s">/aming/</span>
<a id="__codelineno-67-37" name="__codelineno-67-37"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-67-38" name="__codelineno-67-38"></a><span class="w">    </span><span class="kn">proxy_pass</span><span class="w"> </span><span class="s">http://192.168.1.10:8080/linux/</span><span class="p">;</span>
<a id="__codelineno-67-39" name="__codelineno-67-39"></a><span class="w">    </span><span class="kn">proxy_set_header</span><span class="w"> </span><span class="s">host</span><span class="w"> </span><span class="nv">$host</span><span class="p">;</span>
<a id="__codelineno-67-40" name="__codelineno-67-40"></a><span class="w">    </span><span class="kn">proxy_set_header</span><span class="w"> </span><span class="s">X-Real-IP</span><span class="w">      </span><span class="nv">$remote_addr</span><span class="p">;</span>
<a id="__codelineno-67-41" name="__codelineno-67-41"></a><span class="w">    </span><span class="kn">proxy_set_header</span><span class="w"> </span><span class="s">X-Forwarded-For</span><span class="w"> </span><span class="nv">$proxy_add_x_forwarded_for</span><span class="p">;</span>
<a id="__codelineno-67-42" name="__codelineno-67-42"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-67-43" name="__codelineno-67-43"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<h6 id="总结">总结<a class="headerlink" href="#总结" title="Permanent link">&para;</a></h6>
<ul>
<li>A端（客户端）-&gt;B端（nginx反向代理服务器）-&gt;C端（Server端）；</li>
<li>如果在B端不设置host，那么如果是tomcat同一个端口下的虚拟机主机，则无法正常解析，在nginx端需配上proxy_set_header host $host，设置成功以后，经过反向代理后，发送给C端的时候会带着这个host域名;</li>
<li>如果我们在B端不设置X-Real-IP头，那么我们在C端记录日志就无法记录访问的客户机IP，不利于日志的收集，所以反向代理服务器需要加上proxy_set_header X-Real-IP      $remote_addr;这个配置项。</li>
<li>proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;请求经过的代理服务器的 IP 地址列表，可以通过这个变量来查看反向代理的功能是否正常。</li>
</ul>
<h5 id="3-proxy_redirect">3. proxy_redirect<a class="headerlink" href="#3-proxy_redirect" title="Permanent link">&para;</a></h5>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Nginx Configuration File</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-68-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-68-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-68-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-68-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-68-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-68-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-68-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-68-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-68-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-68-10">10</a></span>
<span class="normal"><a href="#__codelineno-68-11">11</a></span>
<span class="normal"><a href="#__codelineno-68-12">12</a></span>
<span class="normal"><a href="#__codelineno-68-13">13</a></span>
<span class="normal"><a href="#__codelineno-68-14">14</a></span>
<span class="normal"><a href="#__codelineno-68-15">15</a></span>
<span class="normal"><a href="#__codelineno-68-16">16</a></span>
<span class="normal"><a href="#__codelineno-68-17">17</a></span>
<span class="normal"><a href="#__codelineno-68-18">18</a></span>
<span class="normal"><a href="#__codelineno-68-19">19</a></span>
<span class="normal"><a href="#__codelineno-68-20">20</a></span>
<span class="normal"><a href="#__codelineno-68-21">21</a></span>
<span class="normal"><a href="#__codelineno-68-22">22</a></span>
<span class="normal"><a href="#__codelineno-68-23">23</a></span>
<span class="normal"><a href="#__codelineno-68-24">24</a></span>
<span class="normal"><a href="#__codelineno-68-25">25</a></span>
<span class="normal"><a href="#__codelineno-68-26">26</a></span>
<span class="normal"><a href="#__codelineno-68-27">27</a></span>
<span class="normal"><a href="#__codelineno-68-28">28</a></span>
<span class="normal"><a href="#__codelineno-68-29">29</a></span>
<span class="normal"><a href="#__codelineno-68-30">30</a></span>
<span class="normal"><a href="#__codelineno-68-31">31</a></span>
<span class="normal"><a href="#__codelineno-68-32">32</a></span>
<span class="normal"><a href="#__codelineno-68-33">33</a></span>
<span class="normal"><a href="#__codelineno-68-34">34</a></span>
<span class="normal"><a href="#__codelineno-68-35">35</a></span>
<span class="normal"><a href="#__codelineno-68-36">36</a></span>
<span class="normal"><a href="#__codelineno-68-37">37</a></span>
<span class="normal"><a href="#__codelineno-68-38">38</a></span>
<span class="normal"><a href="#__codelineno-68-39">39</a></span>
<span class="normal"><a href="#__codelineno-68-40">40</a></span>
<span class="normal"><a href="#__codelineno-68-41">41</a></span>
<span class="normal"><a href="#__codelineno-68-42">42</a></span>
<span class="normal"><a href="#__codelineno-68-43">43</a></span>
<span class="normal"><a href="#__codelineno-68-44">44</a></span>
<span class="normal"><a href="#__codelineno-68-45">45</a></span>
<span class="normal"><a href="#__codelineno-68-46">46</a></span>
<span class="normal"><a href="#__codelineno-68-47">47</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-68-1" name="__codelineno-68-1"></a><span class="k">该指令用来修改被代理服务器返回的响应头中的Location头域和“refresh”头域。</span>
<a id="__codelineno-68-2" name="__codelineno-68-2"></a><span class="s">语法结构为：</span>
<a id="__codelineno-68-3" name="__codelineno-68-3"></a><span class="s">proxy_redirect</span><span class="w"> </span><span class="s">redirect</span><span class="w"> </span><span class="s">replacement</span><span class="p">;</span>
<a id="__codelineno-68-4" name="__codelineno-68-4"></a><span class="k">proxy_redirect</span><span class="w"> </span><span class="s">default</span><span class="p">;</span>
<a id="__codelineno-68-5" name="__codelineno-68-5"></a><span class="k">proxy_redirect</span><span class="w"> </span><span class="no">off</span><span class="p">;</span>
<a id="__codelineno-68-6" name="__codelineno-68-6"></a>
<a id="__codelineno-68-7" name="__codelineno-68-7"></a><span class="k">示例8：</span>
<a id="__codelineno-68-8" name="__codelineno-68-8"></a><span class="s">server</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-68-9" name="__codelineno-68-9"></a><span class="w">    </span><span class="kn">listen</span><span class="w"> </span><span class="mi">80</span><span class="p">;</span>
<a id="__codelineno-68-10" name="__codelineno-68-10"></a><span class="w">    </span><span class="kn">server_name</span><span class="w"> </span><span class="s">www.aminglinux.com</span><span class="p">;</span>
<a id="__codelineno-68-11" name="__codelineno-68-11"></a><span class="w">    </span><span class="kn">index</span><span class="w">  </span><span class="s">index.html</span><span class="p">;</span>
<a id="__codelineno-68-12" name="__codelineno-68-12"></a>
<a id="__codelineno-68-13" name="__codelineno-68-13"></a><span class="w">    </span><span class="kn">location</span><span class="w"> </span><span class="s">/</span>
<a id="__codelineno-68-14" name="__codelineno-68-14"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-68-15" name="__codelineno-68-15"></a><span class="w">    </span><span class="kn">proxy_pass</span><span class="w"> </span><span class="s">http://127.0.0.1:8080</span><span class="p">;</span>
<a id="__codelineno-68-16" name="__codelineno-68-16"></a><span class="w">    </span><span class="kn">proxy_set_header</span><span class="w"> </span><span class="s">host</span><span class="w"> </span><span class="nv">$host</span><span class="p">;</span>
<a id="__codelineno-68-17" name="__codelineno-68-17"></a><span class="w">    </span><span class="kn">proxy_set_header</span><span class="w"> </span><span class="s">X-Real-IP</span><span class="w">      </span><span class="nv">$remote_addr</span><span class="p">;</span>
<a id="__codelineno-68-18" name="__codelineno-68-18"></a><span class="w">    </span><span class="kn">proxy_set_header</span><span class="w"> </span><span class="s">X-Forwarded-For</span><span class="w"> </span><span class="nv">$proxy_add_x_forwarded_for</span><span class="p">;</span>
<a id="__codelineno-68-19" name="__codelineno-68-19"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-68-20" name="__codelineno-68-20"></a><span class="p">}</span>
<a id="__codelineno-68-21" name="__codelineno-68-21"></a>
<a id="__codelineno-68-22" name="__codelineno-68-22"></a><span class="k">当请求的链接为</span><span class="w"> </span><span class="s">http://www.aminglinux.com/aming</span>
<a id="__codelineno-68-23" name="__codelineno-68-23"></a><span class="s">结果会返回301，定向到了</span><span class="w"> </span><span class="s">http://www.aminglinux.com:8080/aming/</span>
<a id="__codelineno-68-24" name="__codelineno-68-24"></a>
<a id="__codelineno-68-25" name="__codelineno-68-25"></a><span class="s">注意：返回301有几个先决条件</span>
<a id="__codelineno-68-26" name="__codelineno-68-26"></a><span class="mi">1</span><span class="s">.</span><span class="w"> </span><span class="s">location后面必须是/</span><span class="p">;</span><span class="w"> </span>
<a id="__codelineno-68-27" name="__codelineno-68-27"></a><span class="k">2.</span><span class="w"> </span><span class="s">proxy_pass后面的URL不能加uri,只能是IP或者IP:port结尾，并不能以/结尾；</span>
<a id="__codelineno-68-28" name="__codelineno-68-28"></a><span class="mi">3</span><span class="s">.</span><span class="w"> </span><span class="s">访问的uri必须是一个真实存在的目录，如，这里的aming必须是存在的</span>
<a id="__codelineno-68-29" name="__codelineno-68-29"></a><span class="mi">4</span><span class="s">.</span><span class="w"> </span><span class="s">访问的时候，不能以/结尾，只能是</span><span class="w"> </span><span class="s">www.aminglinux.com/aming</span>
<a id="__codelineno-68-30" name="__codelineno-68-30"></a>
<a id="__codelineno-68-31" name="__codelineno-68-31"></a><span class="s">虽然，这4个条件挺苛刻，但确实会遇到类似的请求。解决方法是，加一行proxy_redirect</span><span class="w"> </span><span class="s">http://</span><span class="nv">$host:8080/</span><span class="w"> </span><span class="s">/</span><span class="p">;</span>
<a id="__codelineno-68-32" name="__codelineno-68-32"></a>
<a id="__codelineno-68-33" name="__codelineno-68-33"></a><span class="k">示例9：</span>
<a id="__codelineno-68-34" name="__codelineno-68-34"></a><span class="s">server</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-68-35" name="__codelineno-68-35"></a><span class="w">    </span><span class="kn">listen</span><span class="w"> </span><span class="mi">80</span><span class="p">;</span>
<a id="__codelineno-68-36" name="__codelineno-68-36"></a><span class="w">    </span><span class="kn">server_name</span><span class="w"> </span><span class="s">www.aminglinux.com</span><span class="p">;</span>
<a id="__codelineno-68-37" name="__codelineno-68-37"></a><span class="w">    </span><span class="kn">index</span><span class="w">  </span><span class="s">index.html</span><span class="p">;</span>
<a id="__codelineno-68-38" name="__codelineno-68-38"></a>
<a id="__codelineno-68-39" name="__codelineno-68-39"></a><span class="w">    </span><span class="kn">location</span><span class="w"> </span><span class="s">/</span>
<a id="__codelineno-68-40" name="__codelineno-68-40"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-68-41" name="__codelineno-68-41"></a><span class="w">    </span><span class="kn">proxy_pass</span><span class="w"> </span><span class="s">http://127.0.0.1:8080</span><span class="p">;</span>
<a id="__codelineno-68-42" name="__codelineno-68-42"></a><span class="w">    </span><span class="kn">proxy_set_header</span><span class="w"> </span><span class="s">host</span><span class="w"> </span><span class="nv">$host</span><span class="p">;</span>
<a id="__codelineno-68-43" name="__codelineno-68-43"></a><span class="w">    </span><span class="kn">proxy_redirect</span><span class="w"> </span><span class="s">http://</span><span class="nv">$host:8080/</span><span class="w"> </span><span class="s">/</span><span class="p">;</span>
<a id="__codelineno-68-44" name="__codelineno-68-44"></a><span class="w">    </span><span class="kn">proxy_set_header</span><span class="w"> </span><span class="s">X-Real-IP</span><span class="w">      </span><span class="nv">$remote_addr</span><span class="p">;</span>
<a id="__codelineno-68-45" name="__codelineno-68-45"></a><span class="w">    </span><span class="kn">proxy_set_header</span><span class="w"> </span><span class="s">X-Forwarded-For</span><span class="w"> </span><span class="nv">$proxy_add_x_forwarded_for</span><span class="p">;</span>
<a id="__codelineno-68-46" name="__codelineno-68-46"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-68-47" name="__codelineno-68-47"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<h2 id="9buffer与cache">9.buffer与cache<a class="headerlink" href="#9buffer与cache" title="Permanent link">&para;</a></h2>
<h3 id="abuffer">A.buffer<a class="headerlink" href="#abuffer" title="Permanent link">&para;</a></h3>
<h4 id="proxy_buffering设置">proxy_buffering设置<a class="headerlink" href="#proxy_buffering设置" title="Permanent link">&para;</a></h4>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Nginx Configuration File</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-69-1">1</a></span>
<span class="normal"><a href="#__codelineno-69-2">2</a></span>
<span class="normal"><a href="#__codelineno-69-3">3</a></span>
<span class="normal"><a href="#__codelineno-69-4">4</a></span>
<span class="normal"><a href="#__codelineno-69-5">5</a></span>
<span class="normal"><a href="#__codelineno-69-6">6</a></span>
<span class="normal"><a href="#__codelineno-69-7">7</a></span>
<span class="normal"><a href="#__codelineno-69-8">8</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-69-1" name="__codelineno-69-1"></a><span class="k">proxy_buffering主要是实现被代理服务器的数据和客户端的请求异步。</span>
<a id="__codelineno-69-2" name="__codelineno-69-2"></a><span class="s">为了方便理解，我们定义三个角色，A为客户端，B为代理服务器，C为被代理服务器。</span>
<a id="__codelineno-69-3" name="__codelineno-69-3"></a>
<a id="__codelineno-69-4" name="__codelineno-69-4"></a><span class="s">当proxy_buffering开启，A发起请求到B，B再到C，C反馈的数据先到B的buffer上，</span>
<a id="__codelineno-69-5" name="__codelineno-69-5"></a><span class="s">然后B会根据proxy_busy_buffer_size来决定什么时候开始把数据传输给A。在此过程中，如果所有的buffer被写满，</span>
<a id="__codelineno-69-6" name="__codelineno-69-6"></a><span class="s">数据将会写入到temp_file中。</span>
<a id="__codelineno-69-7" name="__codelineno-69-7"></a>
<a id="__codelineno-69-8" name="__codelineno-69-8"></a><span class="s">相反，如果proxy_buffering关闭，C反馈的数据实时地通过B传输给A。</span>
</code></pre></div></td></tr></table></div>
<h4 id="以下配置都是针对每一个http请求的">#以下配置，都是针对每一个http请求的。<a class="headerlink" href="#以下配置都是针对每一个http请求的" title="Permanent link">&para;</a></h4>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Nginx Configuration File</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-70-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-70-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-70-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-70-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-70-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-70-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-70-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-70-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-70-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-70-10">10</a></span>
<span class="normal"><a href="#__codelineno-70-11">11</a></span>
<span class="normal"><a href="#__codelineno-70-12">12</a></span>
<span class="normal"><a href="#__codelineno-70-13">13</a></span>
<span class="normal"><a href="#__codelineno-70-14">14</a></span>
<span class="normal"><a href="#__codelineno-70-15">15</a></span>
<span class="normal"><a href="#__codelineno-70-16">16</a></span>
<span class="normal"><a href="#__codelineno-70-17">17</a></span>
<span class="normal"><a href="#__codelineno-70-18">18</a></span>
<span class="normal"><a href="#__codelineno-70-19">19</a></span>
<span class="normal"><a href="#__codelineno-70-20">20</a></span>
<span class="normal"><a href="#__codelineno-70-21">21</a></span>
<span class="normal"><a href="#__codelineno-70-22">22</a></span>
<span class="normal"><a href="#__codelineno-70-23">23</a></span>
<span class="normal"><a href="#__codelineno-70-24">24</a></span>
<span class="normal"><a href="#__codelineno-70-25">25</a></span>
<span class="normal"><a href="#__codelineno-70-26">26</a></span>
<span class="normal"><a href="#__codelineno-70-27">27</a></span>
<span class="normal"><a href="#__codelineno-70-28">28</a></span>
<span class="normal"><a href="#__codelineno-70-29">29</a></span>
<span class="normal"><a href="#__codelineno-70-30">30</a></span>
<span class="normal"><a href="#__codelineno-70-31">31</a></span>
<span class="normal"><a href="#__codelineno-70-32">32</a></span>
<span class="normal"><a href="#__codelineno-70-33">33</a></span>
<span class="normal"><a href="#__codelineno-70-34">34</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-70-1" name="__codelineno-70-1"></a><span class="k">1.</span><span class="w"> </span><span class="s">proxy_buffering</span><span class="w">  </span><span class="no">on</span><span class="p">;</span>
<a id="__codelineno-70-2" name="__codelineno-70-2"></a><span class="k">该参数设置是否开启proxy的buffer功能，参数的值为on或者off。</span>
<a id="__codelineno-70-3" name="__codelineno-70-3"></a><span class="s">如果这个设置为off，那么proxy_buffers和proxy_busy_buffers_size这两个指令将会失效。</span><span class="w"> </span>
<a id="__codelineno-70-4" name="__codelineno-70-4"></a><span class="s">但是无论proxy_buffering是否开启，proxy_buffer_size都是生效的</span>
<a id="__codelineno-70-5" name="__codelineno-70-5"></a>
<a id="__codelineno-70-6" name="__codelineno-70-6"></a><span class="mi">2</span><span class="s">.</span><span class="w"> </span><span class="s">proxy_buffer_size</span><span class="w">  </span><span class="mi">4k</span><span class="p">;</span>
<a id="__codelineno-70-7" name="__codelineno-70-7"></a><span class="k">该参数用来设置一个特殊的buffer大小的。</span>
<a id="__codelineno-70-8" name="__codelineno-70-8"></a><span class="s">从被代理服务器（C）上获取到的第一部分响应数据内容到代理服务器（B）上，通常是header，就存到了这个buffer中。</span><span class="w"> </span>
<a id="__codelineno-70-9" name="__codelineno-70-9"></a><span class="s">如果该参数设置太小，会出现502错误码，这是因为这部分buffer不够存储header信息。建议设置为4k。</span>
<a id="__codelineno-70-10" name="__codelineno-70-10"></a>
<a id="__codelineno-70-11" name="__codelineno-70-11"></a><span class="mi">3</span><span class="s">.</span><span class="w"> </span><span class="s">proxy_buffers</span><span class="w">  </span><span class="mi">8</span><span class="w">  </span><span class="mi">4k</span><span class="p">;</span>
<a id="__codelineno-70-12" name="__codelineno-70-12"></a><span class="k">这个参数设置存储被代理服务器上的数据所占用的buffer的个数和每个buffer的大小。</span>
<a id="__codelineno-70-13" name="__codelineno-70-13"></a><span class="s">所有buffer的大小为这两个数字的乘积。</span>
<a id="__codelineno-70-14" name="__codelineno-70-14"></a>
<a id="__codelineno-70-15" name="__codelineno-70-15"></a><span class="mi">4</span><span class="s">.</span><span class="w"> </span><span class="s">proxy_busy_buffer_size</span><span class="w"> </span><span class="mi">16k</span><span class="p">;</span>
<a id="__codelineno-70-16" name="__codelineno-70-16"></a><span class="k">在所有的buffer里，我们需要规定一部分buffer把自己存的数据传给A，这部分buffer就叫做busy_buffer。</span>
<a id="__codelineno-70-17" name="__codelineno-70-17"></a><span class="s">proxy_busy_buffer_size参数用来设置处于busy状态的buffer有多大。</span>
<a id="__codelineno-70-18" name="__codelineno-70-18"></a>
<a id="__codelineno-70-19" name="__codelineno-70-19"></a><span class="s">对于B上buffer里的数据何时传输给A，我个人的理解是这样的：</span>
<a id="__codelineno-70-20" name="__codelineno-70-20"></a><span class="mi">1</span><span class="s">）如果完整数据大小小于busy_buffer大小，当数据传输完成后，马上传给A；</span>
<a id="__codelineno-70-21" name="__codelineno-70-21"></a><span class="mi">2</span><span class="s">）如果完整数据大小不少于busy_buffer大小，则装满busy_buffer后，马上传给A；</span>
<a id="__codelineno-70-22" name="__codelineno-70-22"></a>
<a id="__codelineno-70-23" name="__codelineno-70-23"></a><span class="mi">5</span><span class="s">.</span><span class="w"> </span><span class="s">proxy_temp_path</span>
<a id="__codelineno-70-24" name="__codelineno-70-24"></a><span class="s">语法：proxy_temp_path</span><span class="w">  </span><span class="s">path</span><span class="w"> </span><span class="s">[level1</span><span class="w"> </span><span class="s">level2</span><span class="w"> </span><span class="s">level3]</span>
<a id="__codelineno-70-25" name="__codelineno-70-25"></a><span class="s">定义proxy的临时文件存在目录以及目录的层级。</span>
<a id="__codelineno-70-26" name="__codelineno-70-26"></a>
<a id="__codelineno-70-27" name="__codelineno-70-27"></a><span class="s">例：proxy_temp_path</span><span class="w"> </span><span class="s">/usr/local/nginx/proxy_temp</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span>
<a id="__codelineno-70-28" name="__codelineno-70-28"></a><span class="k">其中/usr/local/nginx/proxy_temp为临时文件所在目录，1表示层级1的目录名为一个数字(0-9),2表示层级2目录名为2个数字(00-99)</span>
<a id="__codelineno-70-29" name="__codelineno-70-29"></a>
<a id="__codelineno-70-30" name="__codelineno-70-30"></a><span class="mi">6</span><span class="s">.</span><span class="w"> </span><span class="s">proxy_max_temp_file_size</span>
<a id="__codelineno-70-31" name="__codelineno-70-31"></a><span class="s">设置临时文件的总大小，例如</span><span class="w"> </span><span class="s">proxy_max_temp_file_size</span><span class="w"> </span><span class="s">100M</span><span class="p">;</span>
<a id="__codelineno-70-32" name="__codelineno-70-32"></a>
<a id="__codelineno-70-33" name="__codelineno-70-33"></a><span class="k">7.</span><span class="w"> </span><span class="s">proxy_temp_file_wirte_size</span>
<a id="__codelineno-70-34" name="__codelineno-70-34"></a><span class="s">设置同时写入临时文件的数据量的总大小。通常设置为8k或者16k。</span>
</code></pre></div></td></tr></table></div>
<h4 id="proxy_buffer示例">proxy_buffer示例<a class="headerlink" href="#proxy_buffer示例" title="Permanent link">&para;</a></h4>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Nginx Configuration File</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-71-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-71-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-71-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-71-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-71-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-71-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-71-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-71-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-71-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-71-10">10</a></span>
<span class="normal"><a href="#__codelineno-71-11">11</a></span>
<span class="normal"><a href="#__codelineno-71-12">12</a></span>
<span class="normal"><a href="#__codelineno-71-13">13</a></span>
<span class="normal"><a href="#__codelineno-71-14">14</a></span>
<span class="normal"><a href="#__codelineno-71-15">15</a></span>
<span class="normal"><a href="#__codelineno-71-16">16</a></span>
<span class="normal"><a href="#__codelineno-71-17">17</a></span>
<span class="normal"><a href="#__codelineno-71-18">18</a></span>
<span class="normal"><a href="#__codelineno-71-19">19</a></span>
<span class="normal"><a href="#__codelineno-71-20">20</a></span>
<span class="normal"><a href="#__codelineno-71-21">21</a></span>
<span class="normal"><a href="#__codelineno-71-22">22</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-71-1" name="__codelineno-71-1"></a><span class="k">server</span>
<a id="__codelineno-71-2" name="__codelineno-71-2"></a><span class="p">{</span>
<a id="__codelineno-71-3" name="__codelineno-71-3"></a><span class="w">    </span><span class="kn">listen</span><span class="w"> </span><span class="mi">80</span><span class="p">;</span>
<a id="__codelineno-71-4" name="__codelineno-71-4"></a><span class="w">    </span><span class="kn">server_name</span><span class="w"> </span><span class="s">www.aminglinux.com</span><span class="p">;</span>
<a id="__codelineno-71-5" name="__codelineno-71-5"></a><span class="w">    </span><span class="kn">proxy_buffering</span><span class="w"> </span><span class="no">on</span><span class="p">;</span>
<a id="__codelineno-71-6" name="__codelineno-71-6"></a><span class="w">    </span><span class="kn">proxy_buffer_size</span><span class="w"> </span><span class="mi">4k</span><span class="p">;</span>
<a id="__codelineno-71-7" name="__codelineno-71-7"></a><span class="w">    </span><span class="kn">proxy_buffers</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">4k</span><span class="p">;</span>
<a id="__codelineno-71-8" name="__codelineno-71-8"></a><span class="w">    </span><span class="kn">proxy_busy_buffers_size</span><span class="w"> </span><span class="mi">4k</span><span class="p">;</span>
<a id="__codelineno-71-9" name="__codelineno-71-9"></a><span class="w">    </span><span class="kn">proxy_temp_path</span><span class="w"> </span><span class="s">/tmp/nginx_proxy_tmp</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span>
<a id="__codelineno-71-10" name="__codelineno-71-10"></a><span class="w">    </span><span class="kn">proxy_max_temp_file_size</span><span class="w"> </span><span class="s">20M</span><span class="p">;</span>
<a id="__codelineno-71-11" name="__codelineno-71-11"></a><span class="w">    </span><span class="kn">proxy_temp_file_write_size</span><span class="w"> </span><span class="mi">8k</span><span class="p">;</span>
<a id="__codelineno-71-12" name="__codelineno-71-12"></a>
<a id="__codelineno-71-13" name="__codelineno-71-13"></a><span class="w">    </span><span class="kn">location</span><span class="w"> </span><span class="s">/</span>
<a id="__codelineno-71-14" name="__codelineno-71-14"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-71-15" name="__codelineno-71-15"></a><span class="w">        </span><span class="kn">proxy_pass</span><span class="w">      </span><span class="s">http://192.168.10.110:8080/</span><span class="p">;</span>
<a id="__codelineno-71-16" name="__codelineno-71-16"></a><span class="w">        </span><span class="kn">proxy_set_header</span><span class="w"> </span><span class="s">Host</span><span class="w">   </span><span class="nv">$host</span><span class="p">;</span>
<a id="__codelineno-71-17" name="__codelineno-71-17"></a><span class="w">        </span><span class="kn">proxy_set_header</span><span class="w"> </span><span class="s">X-Real-IP</span><span class="w">      </span><span class="nv">$remote_addr</span><span class="p">;</span>
<a id="__codelineno-71-18" name="__codelineno-71-18"></a><span class="w">        </span><span class="kn">proxy_set_header</span><span class="w"> </span><span class="s">X-Forwarded-For</span><span class="w"> </span><span class="nv">$proxy_add_x_forwarded_for</span><span class="p">;</span>
<a id="__codelineno-71-19" name="__codelineno-71-19"></a>
<a id="__codelineno-71-20" name="__codelineno-71-20"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-71-21" name="__codelineno-71-21"></a>
<a id="__codelineno-71-22" name="__codelineno-71-22"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<h3 id="bcache">B.cache<a class="headerlink" href="#bcache" title="Permanent link">&para;</a></h3>
<h4 id="proxy_cache设置">proxy_cache设置<a class="headerlink" href="#proxy_cache设置" title="Permanent link">&para;</a></h4>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Nginx Configuration File</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-72-1">1</a></span>
<span class="normal"><a href="#__codelineno-72-2">2</a></span>
<span class="normal"><a href="#__codelineno-72-3">3</a></span>
<span class="normal"><a href="#__codelineno-72-4">4</a></span>
<span class="normal"><a href="#__codelineno-72-5">5</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-72-1" name="__codelineno-72-1"></a><span class="k">proxy_cache将从C上获取到的数据根据预设规则存放到B上（内存+磁盘）留着备用，</span>
<a id="__codelineno-72-2" name="__codelineno-72-2"></a><span class="s">A请求B时，B会把缓存的这些数据直接给A，而不需要再去向C去获取。</span>
<a id="__codelineno-72-3" name="__codelineno-72-3"></a>
<a id="__codelineno-72-4" name="__codelineno-72-4"></a><span class="s">proxy_cache相关功能生效的前提是，需要设置proxy_buffering</span><span class="w"> </span><span class="no">on</span><span class="p">;</span>
<a id="__codelineno-72-5" name="__codelineno-72-5"></a><span class="c1">#注意：proxy_buffering默认时开启的，如果需要开启缓存不需要配置该项</span>
</code></pre></div></td></tr></table></div>
<h4 id="proxy_cache主要参数">#proxy_cache主要参数<a class="headerlink" href="#proxy_cache主要参数" title="Permanent link">&para;</a></h4>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Nginx Configuration File</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-73-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-73-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-73-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-73-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-73-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-73-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-73-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-73-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-73-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-73-10">10</a></span>
<span class="normal"><a href="#__codelineno-73-11">11</a></span>
<span class="normal"><a href="#__codelineno-73-12">12</a></span>
<span class="normal"><a href="#__codelineno-73-13">13</a></span>
<span class="normal"><a href="#__codelineno-73-14">14</a></span>
<span class="normal"><a href="#__codelineno-73-15">15</a></span>
<span class="normal"><a href="#__codelineno-73-16">16</a></span>
<span class="normal"><a href="#__codelineno-73-17">17</a></span>
<span class="normal"><a href="#__codelineno-73-18">18</a></span>
<span class="normal"><a href="#__codelineno-73-19">19</a></span>
<span class="normal"><a href="#__codelineno-73-20">20</a></span>
<span class="normal"><a href="#__codelineno-73-21">21</a></span>
<span class="normal"><a href="#__codelineno-73-22">22</a></span>
<span class="normal"><a href="#__codelineno-73-23">23</a></span>
<span class="normal"><a href="#__codelineno-73-24">24</a></span>
<span class="normal"><a href="#__codelineno-73-25">25</a></span>
<span class="normal"><a href="#__codelineno-73-26">26</a></span>
<span class="normal"><a href="#__codelineno-73-27">27</a></span>
<span class="normal"><a href="#__codelineno-73-28">28</a></span>
<span class="normal"><a href="#__codelineno-73-29">29</a></span>
<span class="normal"><a href="#__codelineno-73-30">30</a></span>
<span class="normal"><a href="#__codelineno-73-31">31</a></span>
<span class="normal"><a href="#__codelineno-73-32">32</a></span>
<span class="normal"><a href="#__codelineno-73-33">33</a></span>
<span class="normal"><a href="#__codelineno-73-34">34</a></span>
<span class="normal"><a href="#__codelineno-73-35">35</a></span>
<span class="normal"><a href="#__codelineno-73-36">36</a></span>
<span class="normal"><a href="#__codelineno-73-37">37</a></span>
<span class="normal"><a href="#__codelineno-73-38">38</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-73-1" name="__codelineno-73-1"></a><span class="k">1.</span><span class="w"> </span><span class="s">proxy_cache</span>
<a id="__codelineno-73-2" name="__codelineno-73-2"></a><span class="s">语法：proxy_cache</span><span class="w"> </span><span class="s">zone|off</span>
<a id="__codelineno-73-3" name="__codelineno-73-3"></a>
<a id="__codelineno-73-4" name="__codelineno-73-4"></a><span class="s">默认为off，即关闭proxy_cache功能，zone为用于存放缓存的内存区域名称。</span>
<a id="__codelineno-73-5" name="__codelineno-73-5"></a><span class="s">例：proxy_cache</span><span class="w"> </span><span class="s">my_zone</span><span class="p">;</span>
<a id="__codelineno-73-6" name="__codelineno-73-6"></a>
<a id="__codelineno-73-7" name="__codelineno-73-7"></a><span class="k">从nginx</span><span class="w"> </span><span class="mi">0</span><span class="s">.7.66版本开始，proxy_cache机制开启后会检测被代理端的HTTP响应头中的&quot;Cache-Control&quot;、&quot;Expire&quot;头域。</span>
<a id="__codelineno-73-8" name="__codelineno-73-8"></a><span class="s">如，Cache-Control为no-cache时，是不会缓存数据的。</span>
<a id="__codelineno-73-9" name="__codelineno-73-9"></a>
<a id="__codelineno-73-10" name="__codelineno-73-10"></a><span class="mi">2</span><span class="s">.</span><span class="w"> </span><span class="s">proxy_cache_bypass</span><span class="w"> </span>
<a id="__codelineno-73-11" name="__codelineno-73-11"></a><span class="s">语法：proxy_cache_bypass</span><span class="w"> </span><span class="s">string</span><span class="p">;</span>
<a id="__codelineno-73-12" name="__codelineno-73-12"></a>
<a id="__codelineno-73-13" name="__codelineno-73-13"></a><span class="k">该参数设定，什么情况下的请求不读取cache而是直接从后端的服务器上获取资源。</span>
<a id="__codelineno-73-14" name="__codelineno-73-14"></a><span class="s">这里的string通常为nginx的一些变量。</span>
<a id="__codelineno-73-15" name="__codelineno-73-15"></a>
<a id="__codelineno-73-16" name="__codelineno-73-16"></a><span class="s">例：proxy_cahce_bypass</span><span class="w"> </span><span class="nv">$cookie_nocache</span><span class="w"> </span><span class="nv">$arg_nocache$arg_comment</span><span class="p">;</span>
<a id="__codelineno-73-17" name="__codelineno-73-17"></a><span class="k">意思是，如果$cookie_nocache</span><span class="w"> </span><span class="nv">$arg_nocache$arg_comment这些变量的值只要任何一个不为0或者不为空时，</span>
<a id="__codelineno-73-18" name="__codelineno-73-18"></a><span class="s">则响应数据不从cache中获取，而是直接从后端的服务器上获取。</span>
<a id="__codelineno-73-19" name="__codelineno-73-19"></a>
<a id="__codelineno-73-20" name="__codelineno-73-20"></a><span class="mi">3</span><span class="s">.</span><span class="w"> </span><span class="s">proxy_no_cache</span>
<a id="__codelineno-73-21" name="__codelineno-73-21"></a><span class="s">语法：proxy_no_cache</span><span class="w"> </span><span class="s">string</span><span class="p">;</span>
<a id="__codelineno-73-22" name="__codelineno-73-22"></a>
<a id="__codelineno-73-23" name="__codelineno-73-23"></a><span class="k">该参数和proxy_cache_bypass类似，用来设定什么情况下不缓存。</span>
<a id="__codelineno-73-24" name="__codelineno-73-24"></a>
<a id="__codelineno-73-25" name="__codelineno-73-25"></a><span class="s">例：proxy_no_cache</span><span class="w"> </span><span class="nv">$cookie_nocache</span><span class="w"> </span><span class="nv">$arg_nocache</span><span class="w"> </span><span class="nv">$arg_comment</span><span class="p">;</span>
<a id="__codelineno-73-26" name="__codelineno-73-26"></a><span class="k">表示，如果$cookie_nocache</span><span class="w"> </span><span class="nv">$arg_nocache</span><span class="w"> </span><span class="nv">$arg_comment的值只要有一项不为0或者不为空时，不缓存数据。</span>
<a id="__codelineno-73-27" name="__codelineno-73-27"></a>
<a id="__codelineno-73-28" name="__codelineno-73-28"></a><span class="mi">4</span><span class="s">.</span><span class="w"> </span><span class="s">proxy_cache_key</span>
<a id="__codelineno-73-29" name="__codelineno-73-29"></a><span class="s">语法：proxy_cache_key</span><span class="w"> </span><span class="s">string</span><span class="p">;</span>
<a id="__codelineno-73-30" name="__codelineno-73-30"></a>
<a id="__codelineno-73-31" name="__codelineno-73-31"></a><span class="k">定义cache</span><span class="w"> </span><span class="s">key，如：</span><span class="w"> </span><span class="s">proxy_cache_key</span><span class="w"> </span><span class="nv">$scheme$proxy_host$uri$is_args$args</span><span class="p">;</span><span class="w"> </span><span class="k">（该值为默认值，一般不用设置）</span>
<a id="__codelineno-73-32" name="__codelineno-73-32"></a>
<a id="__codelineno-73-33" name="__codelineno-73-33"></a><span class="mi">5</span><span class="s">.</span><span class="w"> </span><span class="s">proxy_cache_path</span>
<a id="__codelineno-73-34" name="__codelineno-73-34"></a><span class="s">语法：proxy_cache_path</span><span class="w"> </span><span class="s">path</span><span class="w"> </span><span class="s">[levels=levels]</span><span class="w"> </span><span class="s">keys_zone=name:size</span><span class="w">  </span><span class="s">[inactive=time]</span><span class="w"> </span><span class="s">[max_size=size]</span><span class="w"> </span>
<a id="__codelineno-73-35" name="__codelineno-73-35"></a>
<a id="__codelineno-73-36" name="__codelineno-73-36"></a><span class="s">path设置缓存数据存放的路径；</span>
<a id="__codelineno-73-37" name="__codelineno-73-37"></a>
<a id="__codelineno-73-38" name="__codelineno-73-38"></a><span class="s">levels设置目录层级，如levels=1:2，表示有两级子目录,第一个目录名取md5值的倒数第一个值，第二个目录名取md5值的第2和3个值。如下图：</span>
</code></pre></div></td></tr></table></div>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Nginx Configuration File</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-74-1">1</a></span>
<span class="normal"><a href="#__codelineno-74-2">2</a></span>
<span class="normal"><a href="#__codelineno-74-3">3</a></span>
<span class="normal"><a href="#__codelineno-74-4">4</a></span>
<span class="normal"><a href="#__codelineno-74-5">5</a></span>
<span class="normal"><a href="#__codelineno-74-6">6</a></span>
<span class="normal"><a href="#__codelineno-74-7">7</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-74-1" name="__codelineno-74-1"></a><span class="k">keys_zone设置内存zone的名字和大小，如keys_zone=my_zone:10m</span>
<a id="__codelineno-74-2" name="__codelineno-74-2"></a>
<a id="__codelineno-74-3" name="__codelineno-74-3"></a><span class="s">inactive设置缓存多长时间就失效，当硬盘上的缓存数据在该时间段内没有被访问过，就会失效了，该数据就会被删除，默认为10s。</span>
<a id="__codelineno-74-4" name="__codelineno-74-4"></a>
<a id="__codelineno-74-5" name="__codelineno-74-5"></a><span class="s">max_size设置硬盘中最多可以缓存多少数据，当到达该数值时，nginx会删除最少访问的数据。</span>
<a id="__codelineno-74-6" name="__codelineno-74-6"></a>
<a id="__codelineno-74-7" name="__codelineno-74-7"></a><span class="s">例：proxy_cache_path</span><span class="w"> </span><span class="s">/data/nginx_cache/</span><span class="w"> </span><span class="s">levels=1:2</span><span class="w"> </span><span class="s">keys_zone=my_zone:10m</span><span class="w"> </span><span class="s">inactive=300s</span><span class="w"> </span><span class="s">max_size=5g</span>
</code></pre></div></td></tr></table></div>
<h4 id="proxy_cache示例">proxy_cache示例<a class="headerlink" href="#proxy_cache示例" title="Permanent link">&para;</a></h4>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Nginx Configuration File</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-75-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-75-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-75-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-75-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-75-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-75-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-75-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-75-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-75-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-75-10">10</a></span>
<span class="normal"><a href="#__codelineno-75-11">11</a></span>
<span class="normal"><a href="#__codelineno-75-12">12</a></span>
<span class="normal"><a href="#__codelineno-75-13">13</a></span>
<span class="normal"><a href="#__codelineno-75-14">14</a></span>
<span class="normal"><a href="#__codelineno-75-15">15</a></span>
<span class="normal"><a href="#__codelineno-75-16">16</a></span>
<span class="normal"><a href="#__codelineno-75-17">17</a></span>
<span class="normal"><a href="#__codelineno-75-18">18</a></span>
<span class="normal"><a href="#__codelineno-75-19">19</a></span>
<span class="normal"><a href="#__codelineno-75-20">20</a></span>
<span class="normal"><a href="#__codelineno-75-21">21</a></span>
<span class="normal"><a href="#__codelineno-75-22">22</a></span>
<span class="normal"><a href="#__codelineno-75-23">23</a></span>
<span class="normal"><a href="#__codelineno-75-24">24</a></span>
<span class="normal"><a href="#__codelineno-75-25">25</a></span>
<span class="normal"><a href="#__codelineno-75-26">26</a></span>
<span class="normal"><a href="#__codelineno-75-27">27</a></span>
<span class="normal"><a href="#__codelineno-75-28">28</a></span>
<span class="normal"><a href="#__codelineno-75-29">29</a></span>
<span class="normal"><a href="#__codelineno-75-30">30</a></span>
<span class="normal"><a href="#__codelineno-75-31">31</a></span>
<span class="normal"><a href="#__codelineno-75-32">32</a></span>
<span class="normal"><a href="#__codelineno-75-33">33</a></span>
<span class="normal"><a href="#__codelineno-75-34">34</a></span>
<span class="normal"><a href="#__codelineno-75-35">35</a></span>
<span class="normal"><a href="#__codelineno-75-36">36</a></span>
<span class="normal"><a href="#__codelineno-75-37">37</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-75-1" name="__codelineno-75-1"></a><span class="k">http</span><span class="w"> </span>
<a id="__codelineno-75-2" name="__codelineno-75-2"></a><span class="p">{</span>
<a id="__codelineno-75-3" name="__codelineno-75-3"></a><span class="w">    </span><span class="kn">...</span><span class="p">;</span>
<a id="__codelineno-75-4" name="__codelineno-75-4"></a>
<a id="__codelineno-75-5" name="__codelineno-75-5"></a><span class="w">    </span><span class="kn">proxy_cache_path</span><span class="w"> </span><span class="s">/data/nginx_cache/</span><span class="w"> </span><span class="s">levels=1:2</span><span class="w"> </span><span class="s">keys_zone=my_zone:10m</span><span class="w"> </span><span class="s">inactive=300s</span><span class="w"> </span><span class="s">max_size=5g</span><span class="p">;</span>
<a id="__codelineno-75-6" name="__codelineno-75-6"></a>
<a id="__codelineno-75-7" name="__codelineno-75-7"></a><span class="w">    </span><span class="kn">...</span><span class="p">;</span>
<a id="__codelineno-75-8" name="__codelineno-75-8"></a>
<a id="__codelineno-75-9" name="__codelineno-75-9"></a><span class="w">    </span><span class="kn">server</span>
<a id="__codelineno-75-10" name="__codelineno-75-10"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-75-11" name="__codelineno-75-11"></a><span class="w">        </span><span class="kn">listen</span><span class="w"> </span><span class="mi">80</span><span class="p">;</span>
<a id="__codelineno-75-12" name="__codelineno-75-12"></a><span class="w">        </span><span class="kn">server_name</span><span class="w"> </span><span class="s">www.aminglinux.com</span><span class="p">;</span>
<a id="__codelineno-75-13" name="__codelineno-75-13"></a><span class="w">        </span><span class="c1">#缓冲区默认开启，这个配置可以根据自己是否需要设置大小来进行配置，也可使用默认</span>
<a id="__codelineno-75-14" name="__codelineno-75-14"></a><span class="w">        </span><span class="kn">proxy_buffering</span><span class="w"> </span><span class="no">on</span><span class="p">;</span>
<a id="__codelineno-75-15" name="__codelineno-75-15"></a><span class="w">        </span><span class="kn">proxy_buffer_size</span><span class="w"> </span><span class="mi">4k</span><span class="p">;</span>
<a id="__codelineno-75-16" name="__codelineno-75-16"></a><span class="w">        </span><span class="kn">proxy_buffers</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">4k</span><span class="p">;</span>
<a id="__codelineno-75-17" name="__codelineno-75-17"></a><span class="w">        </span><span class="kn">proxy_busy_buffers_size</span><span class="w"> </span><span class="mi">4k</span><span class="p">;</span>
<a id="__codelineno-75-18" name="__codelineno-75-18"></a><span class="w">        </span><span class="kn">proxy_temp_path</span><span class="w"> </span><span class="s">/tmp/nginx_proxy_tmp</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span>
<a id="__codelineno-75-19" name="__codelineno-75-19"></a><span class="w">        </span><span class="kn">proxy_max_temp_file_size</span><span class="w"> </span><span class="s">20M</span><span class="p">;</span>
<a id="__codelineno-75-20" name="__codelineno-75-20"></a><span class="w">        </span><span class="kn">proxy_temp_file_write_size</span><span class="w"> </span><span class="mi">8k</span><span class="p">;</span>
<a id="__codelineno-75-21" name="__codelineno-75-21"></a>
<a id="__codelineno-75-22" name="__codelineno-75-22"></a>
<a id="__codelineno-75-23" name="__codelineno-75-23"></a>
<a id="__codelineno-75-24" name="__codelineno-75-24"></a><span class="w">        </span><span class="kn">location</span><span class="w"> </span><span class="s">/</span>
<a id="__codelineno-75-25" name="__codelineno-75-25"></a><span class="w">        </span><span class="p">{</span>
<a id="__codelineno-75-26" name="__codelineno-75-26"></a><span class="w">            </span><span class="kn">proxy_cache</span><span class="w"> </span><span class="s">my_zone</span><span class="p">;</span>
<a id="__codelineno-75-27" name="__codelineno-75-27"></a><span class="w">            </span><span class="kn">proxy_pass</span><span class="w">      </span><span class="s">http://192.168.10.110:8080/</span><span class="p">;</span>
<a id="__codelineno-75-28" name="__codelineno-75-28"></a><span class="w">            </span><span class="kn">proxy_set_header</span><span class="w"> </span><span class="s">Host</span><span class="w">   </span><span class="nv">$host</span><span class="p">;</span>
<a id="__codelineno-75-29" name="__codelineno-75-29"></a><span class="w">            </span><span class="kn">proxy_set_header</span><span class="w"> </span><span class="s">X-Real-IP</span><span class="w">      </span><span class="nv">$remote_addr</span><span class="p">;</span>
<a id="__codelineno-75-30" name="__codelineno-75-30"></a><span class="w">            </span><span class="kn">proxy_set_header</span><span class="w"> </span><span class="s">X-Forwarded-For</span><span class="w"> </span><span class="nv">$proxy_add_x_forwarded_for</span><span class="p">;</span>
<a id="__codelineno-75-31" name="__codelineno-75-31"></a>
<a id="__codelineno-75-32" name="__codelineno-75-32"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-75-33" name="__codelineno-75-33"></a>
<a id="__codelineno-75-34" name="__codelineno-75-34"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-75-35" name="__codelineno-75-35"></a><span class="p">}</span>
<a id="__codelineno-75-36" name="__codelineno-75-36"></a>
<a id="__codelineno-75-37" name="__codelineno-75-37"></a><span class="k">说明：核心配置为proxy_cache_path那一行。</span>
</code></pre></div></td></tr></table></div>
<h2 id="10nginx的负载均衡配置">10.Nginx的负载均衡配置<a class="headerlink" href="#10nginx的负载均衡配置" title="Permanent link">&para;</a></h2>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Text Only</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-76-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-76-1" name="__codelineno-76-1"></a>Nginx通过upstream和proxy_pass实现了负载均衡。本质上也是Nginx的反向代理功能，只不过后端的server为多个。
</code></pre></div></td></tr></table></div>
<h3 id="案例一简单的轮询">案例一（简单的轮询）<a class="headerlink" href="#案例一简单的轮询" title="Permanent link">&para;</a></h3>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Nginx Configuration File</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-77-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-77-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-77-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-77-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-77-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-77-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-77-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-77-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-77-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-77-10">10</a></span>
<span class="normal"><a href="#__codelineno-77-11">11</a></span>
<span class="normal"><a href="#__codelineno-77-12">12</a></span>
<span class="normal"><a href="#__codelineno-77-13">13</a></span>
<span class="normal"><a href="#__codelineno-77-14">14</a></span>
<span class="normal"><a href="#__codelineno-77-15">15</a></span>
<span class="normal"><a href="#__codelineno-77-16">16</a></span>
<span class="normal"><a href="#__codelineno-77-17">17</a></span>
<span class="normal"><a href="#__codelineno-77-18">18</a></span>
<span class="normal"><a href="#__codelineno-77-19">19</a></span>
<span class="normal"><a href="#__codelineno-77-20">20</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-77-1" name="__codelineno-77-1"></a><span class="k">upstream</span><span class="w"> </span><span class="s">www</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-77-2" name="__codelineno-77-2"></a><span class="w">    </span><span class="kn">server</span><span class="w"> </span><span class="n">172.37.150.109</span><span class="p">:</span><span class="mi">80</span><span class="p">;</span>
<a id="__codelineno-77-3" name="__codelineno-77-3"></a><span class="w">    </span><span class="kn">server</span><span class="w"> </span><span class="n">172.37.150.101</span><span class="p">:</span><span class="mi">80</span><span class="p">;</span>
<a id="__codelineno-77-4" name="__codelineno-77-4"></a><span class="w">    </span><span class="kn">server</span><span class="w"> </span><span class="n">172.37.150.110</span><span class="p">:</span><span class="mi">80</span><span class="p">;</span>
<a id="__codelineno-77-5" name="__codelineno-77-5"></a><span class="p">}</span>
<a id="__codelineno-77-6" name="__codelineno-77-6"></a>
<a id="__codelineno-77-7" name="__codelineno-77-7"></a><span class="k">server</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-77-8" name="__codelineno-77-8"></a><span class="w">    </span><span class="kn">listen</span><span class="w"> </span><span class="mi">80</span><span class="p">;</span>
<a id="__codelineno-77-9" name="__codelineno-77-9"></a><span class="w">    </span><span class="kn">server_name</span><span class="w"> </span><span class="s">www.aminglinux.com</span><span class="p">;</span>
<a id="__codelineno-77-10" name="__codelineno-77-10"></a><span class="w">    </span><span class="kn">location</span><span class="w"> </span><span class="s">/</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-77-11" name="__codelineno-77-11"></a><span class="w">        </span><span class="kn">proxy_pass</span><span class="w"> </span><span class="s">http://www/</span><span class="p">;</span>
<a id="__codelineno-77-12" name="__codelineno-77-12"></a><span class="w">        </span><span class="kn">proxy_set_header</span><span class="w"> </span><span class="s">Host</span><span class="w">   </span><span class="nv">$host</span><span class="p">;</span>
<a id="__codelineno-77-13" name="__codelineno-77-13"></a><span class="w">        </span><span class="kn">proxy_set_header</span><span class="w"> </span><span class="s">X-Real-IP</span><span class="w">      </span><span class="nv">$remote_addr</span><span class="p">;</span>
<a id="__codelineno-77-14" name="__codelineno-77-14"></a><span class="w">        </span><span class="kn">proxy_set_header</span><span class="w"> </span><span class="s">X-Forwarded-For</span><span class="w"> </span><span class="nv">$proxy_add_x_forwarded_for</span><span class="p">;</span>
<a id="__codelineno-77-15" name="__codelineno-77-15"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-77-16" name="__codelineno-77-16"></a><span class="p">}</span>
<a id="__codelineno-77-17" name="__codelineno-77-17"></a>
<a id="__codelineno-77-18" name="__codelineno-77-18"></a><span class="k">说明：当被代理的机器有多台时，需要使用upstream来定义一个服务器组，</span>
<a id="__codelineno-77-19" name="__codelineno-77-19"></a><span class="s">其中www名字可以自定义，在后面的proxy_pass那里引用。</span>
<a id="__codelineno-77-20" name="__codelineno-77-20"></a><span class="s">这样nginx会将请求均衡地轮询发送给www组内的三台服务器。</span>
</code></pre></div></td></tr></table></div>
<h3 id="案例二带权重轮询ip_hash算法">案例二（带权重轮询+ip_hash算法）<a class="headerlink" href="#案例二带权重轮询ip_hash算法" title="Permanent link">&para;</a></h3>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Nginx Configuration File</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-78-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-78-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-78-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-78-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-78-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-78-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-78-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-78-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-78-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-78-10">10</a></span>
<span class="normal"><a href="#__codelineno-78-11">11</a></span>
<span class="normal"><a href="#__codelineno-78-12">12</a></span>
<span class="normal"><a href="#__codelineno-78-13">13</a></span>
<span class="normal"><a href="#__codelineno-78-14">14</a></span>
<span class="normal"><a href="#__codelineno-78-15">15</a></span>
<span class="normal"><a href="#__codelineno-78-16">16</a></span>
<span class="normal"><a href="#__codelineno-78-17">17</a></span>
<span class="normal"><a href="#__codelineno-78-18">18</a></span>
<span class="normal"><a href="#__codelineno-78-19">19</a></span>
<span class="normal"><a href="#__codelineno-78-20">20</a></span>
<span class="normal"><a href="#__codelineno-78-21">21</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-78-1" name="__codelineno-78-1"></a><span class="k">upstream</span><span class="w"> </span><span class="s">www</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-78-2" name="__codelineno-78-2"></a><span class="w">    </span><span class="kn">server</span><span class="w"> </span><span class="n">172.37.150.109</span><span class="p">:</span><span class="mi">80</span><span class="w"> </span><span class="s">weight=50</span><span class="p">;</span>
<a id="__codelineno-78-3" name="__codelineno-78-3"></a><span class="w">    </span><span class="kn">server</span><span class="w"> </span><span class="n">172.37.150.101</span><span class="p">:</span><span class="mi">80</span><span class="w"> </span><span class="s">weight=100</span><span class="p">;</span>
<a id="__codelineno-78-4" name="__codelineno-78-4"></a><span class="w">    </span><span class="kn">server</span><span class="w"> </span><span class="n">172.37.150.110</span><span class="p">:</span><span class="mi">80</span><span class="w"> </span><span class="s">weight=50</span><span class="p">;</span>
<a id="__codelineno-78-5" name="__codelineno-78-5"></a><span class="w">    </span><span class="kn">ip_hash</span><span class="p">;</span>
<a id="__codelineno-78-6" name="__codelineno-78-6"></a><span class="p">}</span>
<a id="__codelineno-78-7" name="__codelineno-78-7"></a>
<a id="__codelineno-78-8" name="__codelineno-78-8"></a><span class="k">server</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-78-9" name="__codelineno-78-9"></a><span class="w">    </span><span class="kn">listen</span><span class="w"> </span><span class="mi">80</span><span class="p">;</span>
<a id="__codelineno-78-10" name="__codelineno-78-10"></a><span class="w">    </span><span class="kn">server_name</span><span class="w"> </span><span class="s">www.aminglinux.com</span><span class="p">;</span>
<a id="__codelineno-78-11" name="__codelineno-78-11"></a><span class="w">    </span><span class="kn">location</span><span class="w"> </span><span class="s">/</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-78-12" name="__codelineno-78-12"></a><span class="w">        </span><span class="kn">proxy_pass</span><span class="w"> </span><span class="s">http://www/</span><span class="p">;</span>
<a id="__codelineno-78-13" name="__codelineno-78-13"></a><span class="w">        </span><span class="kn">proxy_set_header</span><span class="w"> </span><span class="s">Host</span><span class="w">   </span><span class="nv">$host</span><span class="p">;</span>
<a id="__codelineno-78-14" name="__codelineno-78-14"></a><span class="w">        </span><span class="kn">proxy_set_header</span><span class="w"> </span><span class="s">X-Real-IP</span><span class="w">      </span><span class="nv">$remote_addr</span><span class="p">;</span>
<a id="__codelineno-78-15" name="__codelineno-78-15"></a><span class="w">        </span><span class="kn">proxy_set_header</span><span class="w"> </span><span class="s">X-Forwarded-For</span><span class="w"> </span><span class="nv">$proxy_add_x_forwarded_for</span><span class="p">;</span>
<a id="__codelineno-78-16" name="__codelineno-78-16"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-78-17" name="__codelineno-78-17"></a><span class="p">}</span>
<a id="__codelineno-78-18" name="__codelineno-78-18"></a>
<a id="__codelineno-78-19" name="__codelineno-78-19"></a><span class="k">说明：可以给www组内的三台机器配置权重，权重越高，则分配到的请求越多。</span>
<a id="__codelineno-78-20" name="__codelineno-78-20"></a><span class="s">ip_hash为nginx负载均衡算法，原理很简单，它根据请求所属的客户端IP计算得到一个数值，然后把请求发往该数值对应的后端。</span>
<a id="__codelineno-78-21" name="__codelineno-78-21"></a><span class="s">所以同一个客户端的请求，都会发往同一台后端，除非该后端不可用了。ip_hash能够达到保持会话的效果。</span>
</code></pre></div></td></tr></table></div>
<h3 id="案例三upstream其他配置">案例三（upstream其他配置）<a class="headerlink" href="#案例三upstream其他配置" title="Permanent link">&para;</a></h3>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Nginx Configuration File</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-79-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-79-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-79-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-79-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-79-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-79-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-79-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-79-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-79-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-79-10">10</a></span>
<span class="normal"><a href="#__codelineno-79-11">11</a></span>
<span class="normal"><a href="#__codelineno-79-12">12</a></span>
<span class="normal"><a href="#__codelineno-79-13">13</a></span>
<span class="normal"><a href="#__codelineno-79-14">14</a></span>
<span class="normal"><a href="#__codelineno-79-15">15</a></span>
<span class="normal"><a href="#__codelineno-79-16">16</a></span>
<span class="normal"><a href="#__codelineno-79-17">17</a></span>
<span class="normal"><a href="#__codelineno-79-18">18</a></span>
<span class="normal"><a href="#__codelineno-79-19">19</a></span>
<span class="normal"><a href="#__codelineno-79-20">20</a></span>
<span class="normal"><a href="#__codelineno-79-21">21</a></span>
<span class="normal"><a href="#__codelineno-79-22">22</a></span>
<span class="normal"><a href="#__codelineno-79-23">23</a></span>
<span class="normal"><a href="#__codelineno-79-24">24</a></span>
<span class="normal"><a href="#__codelineno-79-25">25</a></span>
<span class="normal"><a href="#__codelineno-79-26">26</a></span>
<span class="normal"><a href="#__codelineno-79-27">27</a></span>
<span class="normal"><a href="#__codelineno-79-28">28</a></span>
<span class="normal"><a href="#__codelineno-79-29">29</a></span>
<span class="normal"><a href="#__codelineno-79-30">30</a></span>
<span class="normal"><a href="#__codelineno-79-31">31</a></span>
<span class="normal"><a href="#__codelineno-79-32">32</a></span>
<span class="normal"><a href="#__codelineno-79-33">33</a></span>
<span class="normal"><a href="#__codelineno-79-34">34</a></span>
<span class="normal"><a href="#__codelineno-79-35">35</a></span>
<span class="normal"><a href="#__codelineno-79-36">36</a></span>
<span class="normal"><a href="#__codelineno-79-37">37</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-79-1" name="__codelineno-79-1"></a><span class="k">upstream</span><span class="w"> </span><span class="s">www</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-79-2" name="__codelineno-79-2"></a><span class="w">        </span><span class="kn">server</span><span class="w"> </span><span class="n">172.37.150.109</span><span class="p">:</span><span class="mi">80</span><span class="w"> </span><span class="s">weight=50</span><span class="w"> </span><span class="s">max_fails=3</span><span class="w"> </span><span class="s">fail_timeout=30s</span><span class="p">;</span>
<a id="__codelineno-79-3" name="__codelineno-79-3"></a><span class="w">        </span><span class="kn">server</span><span class="w"> </span><span class="n">172.37.150.101</span><span class="p">:</span><span class="mi">80</span><span class="w"> </span><span class="s">weight=100</span><span class="p">;</span>
<a id="__codelineno-79-4" name="__codelineno-79-4"></a><span class="w">        </span><span class="kn">server</span><span class="w"> </span><span class="n">172.37.150.110</span><span class="p">:</span><span class="mi">80</span><span class="w"> </span><span class="s">down</span><span class="p">;</span>
<a id="__codelineno-79-5" name="__codelineno-79-5"></a><span class="w">        </span><span class="kn">server</span><span class="w"> </span><span class="n">172.37.150.110</span><span class="p">:</span><span class="mi">80</span><span class="w"> </span><span class="s">backup</span><span class="p">;</span>
<a id="__codelineno-79-6" name="__codelineno-79-6"></a><span class="p">}</span>
<a id="__codelineno-79-7" name="__codelineno-79-7"></a><span class="k">server</span>
<a id="__codelineno-79-8" name="__codelineno-79-8"></a><span class="p">{</span>
<a id="__codelineno-79-9" name="__codelineno-79-9"></a><span class="w">    </span><span class="kn">listen</span><span class="w"> </span><span class="mi">80</span><span class="p">;</span>
<a id="__codelineno-79-10" name="__codelineno-79-10"></a><span class="w">    </span><span class="kn">server_name</span><span class="w"> </span><span class="s">www.aminglinux.com</span><span class="p">;</span>
<a id="__codelineno-79-11" name="__codelineno-79-11"></a><span class="w">    </span><span class="kn">location</span><span class="w"> </span><span class="s">/</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-79-12" name="__codelineno-79-12"></a><span class="w">        </span><span class="kn">proxy_next_upstream</span><span class="w"> </span><span class="no">off</span><span class="p">;</span>
<a id="__codelineno-79-13" name="__codelineno-79-13"></a><span class="w">        </span><span class="kn">proxy_pass</span><span class="w"> </span><span class="s">http://www/</span><span class="p">;</span>
<a id="__codelineno-79-14" name="__codelineno-79-14"></a><span class="w">        </span><span class="kn">proxy_set_header</span><span class="w"> </span><span class="s">Host</span><span class="w">   </span><span class="nv">$host</span><span class="p">;</span>
<a id="__codelineno-79-15" name="__codelineno-79-15"></a><span class="w">        </span><span class="kn">proxy_set_header</span><span class="w"> </span><span class="s">X-Real-IP</span><span class="w">      </span><span class="nv">$remote_addr</span><span class="p">;</span>
<a id="__codelineno-79-16" name="__codelineno-79-16"></a><span class="w">        </span><span class="kn">proxy_set_header</span><span class="w"> </span><span class="s">X-Forwarded-For</span><span class="w"> </span><span class="nv">$proxy_add_x_forwarded_for</span><span class="p">;</span>
<a id="__codelineno-79-17" name="__codelineno-79-17"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-79-18" name="__codelineno-79-18"></a><span class="p">}</span>
<a id="__codelineno-79-19" name="__codelineno-79-19"></a>
<a id="__codelineno-79-20" name="__codelineno-79-20"></a><span class="k">说明：down，表示当前的server不参与负载均衡；</span>
<a id="__codelineno-79-21" name="__codelineno-79-21"></a><span class="s">backup，为预留的机器，当其他的server（非backup）出现故障或者忙的时候，才会请求backup机器</span><span class="p">;</span>
<a id="__codelineno-79-22" name="__codelineno-79-22"></a><span class="k">max_fails，允许请求失败的次数，默认为1。当失败次数达到该值，就认为该机器down掉了。</span><span class="w"> </span><span class="s">失败的指标是由proxy_next_upstream模块定义，其中404状态码不认为是失败。</span>
<a id="__codelineno-79-23" name="__codelineno-79-23"></a><span class="s">fail_timeount，定义失败的超时时间，也就是说在该时间段内达到max_fails，才算真正的失败。默认是10秒。</span>
<a id="__codelineno-79-24" name="__codelineno-79-24"></a>
<a id="__codelineno-79-25" name="__codelineno-79-25"></a><span class="s">proxy_next_upstream，通过后端服务器返回的响应状态码，表示服务器死活，可以灵活控制后端机器是否加入分发列表。</span>
<a id="__codelineno-79-26" name="__codelineno-79-26"></a><span class="s">语法:</span><span class="w"> </span><span class="s">proxy_next_upstream</span><span class="w"> </span><span class="s">error</span><span class="w"> </span><span class="s">|</span><span class="w"> </span><span class="s">timeout</span><span class="w"> </span><span class="s">|</span><span class="w"> </span><span class="s">invalid_header</span><span class="w"> </span><span class="s">|</span><span class="w"> </span><span class="s">http_500</span><span class="w"> </span><span class="s">|</span><span class="w"> </span><span class="s">http_502</span><span class="w"> </span><span class="s">|</span><span class="w"> </span><span class="s">http_503</span><span class="w"> </span><span class="s">|</span><span class="w"> </span><span class="s">http_504</span><span class="w"> </span><span class="s">|http_404</span><span class="w"> </span><span class="s">|</span><span class="w"> </span><span class="no">off</span><span class="w"> </span><span class="s">...</span><span class="p">;</span><span class="w"> </span>
<a id="__codelineno-79-27" name="__codelineno-79-27"></a><span class="k">默认值:</span><span class="w"> </span><span class="s">proxy_next_upstream</span><span class="w"> </span><span class="s">error</span><span class="w"> </span><span class="s">timeout</span>
<a id="__codelineno-79-28" name="__codelineno-79-28"></a>
<a id="__codelineno-79-29" name="__codelineno-79-29"></a><span class="s">error</span><span class="w">      </span><span class="c1"># 和后端服务器建立连接时，或者向后端服务器发送请求时，或者从后端服务器接收响应头时，出现错误</span>
<a id="__codelineno-79-30" name="__codelineno-79-30"></a><span class="s">timeout</span><span class="w">    </span><span class="c1"># 和后端服务器建立连接时，或者向后端服务器发送请求时，或者从后端服务器接收响应头时，出现超时</span>
<a id="__codelineno-79-31" name="__codelineno-79-31"></a><span class="s">invalid_header</span><span class="w">  </span><span class="c1"># 后端服务器返回空响应或者非法响应头</span>
<a id="__codelineno-79-32" name="__codelineno-79-32"></a><span class="s">http_500</span><span class="w">   </span><span class="c1"># 后端服务器返回的响应状态码为500</span>
<a id="__codelineno-79-33" name="__codelineno-79-33"></a><span class="s">http_502</span><span class="w">   </span><span class="c1"># 后端服务器返回的响应状态码为502</span>
<a id="__codelineno-79-34" name="__codelineno-79-34"></a><span class="s">http_503</span><span class="w">   </span><span class="c1"># 后端服务器返回的响应状态码为503</span>
<a id="__codelineno-79-35" name="__codelineno-79-35"></a><span class="s">http_504</span><span class="w">   </span><span class="c1"># 后端服务器返回的响应状态码为504</span>
<a id="__codelineno-79-36" name="__codelineno-79-36"></a><span class="s">http_404</span><span class="w">   </span><span class="c1"># 后端服务器返回的响应状态码为404</span>
<a id="__codelineno-79-37" name="__codelineno-79-37"></a><span class="no">off</span><span class="w">        </span><span class="c1"># 停止将请求发送给下一台后端服务器</span>
</code></pre></div></td></tr></table></div>
<h3 id="案例四根据不同的uri">案例四（根据不同的uri）<a class="headerlink" href="#案例四根据不同的uri" title="Permanent link">&para;</a></h3>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Nginx Configuration File</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-80-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-80-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-80-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-80-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-80-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-80-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-80-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-80-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-80-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-80-10">10</a></span>
<span class="normal"><a href="#__codelineno-80-11">11</a></span>
<span class="normal"><a href="#__codelineno-80-12">12</a></span>
<span class="normal"><a href="#__codelineno-80-13">13</a></span>
<span class="normal"><a href="#__codelineno-80-14">14</a></span>
<span class="normal"><a href="#__codelineno-80-15">15</a></span>
<span class="normal"><a href="#__codelineno-80-16">16</a></span>
<span class="normal"><a href="#__codelineno-80-17">17</a></span>
<span class="normal"><a href="#__codelineno-80-18">18</a></span>
<span class="normal"><a href="#__codelineno-80-19">19</a></span>
<span class="normal"><a href="#__codelineno-80-20">20</a></span>
<span class="normal"><a href="#__codelineno-80-21">21</a></span>
<span class="normal"><a href="#__codelineno-80-22">22</a></span>
<span class="normal"><a href="#__codelineno-80-23">23</a></span>
<span class="normal"><a href="#__codelineno-80-24">24</a></span>
<span class="normal"><a href="#__codelineno-80-25">25</a></span>
<span class="normal"><a href="#__codelineno-80-26">26</a></span>
<span class="normal"><a href="#__codelineno-80-27">27</a></span>
<span class="normal"><a href="#__codelineno-80-28">28</a></span>
<span class="normal"><a href="#__codelineno-80-29">29</a></span>
<span class="normal"><a href="#__codelineno-80-30">30</a></span>
<span class="normal"><a href="#__codelineno-80-31">31</a></span>
<span class="normal"><a href="#__codelineno-80-32">32</a></span>
<span class="normal"><a href="#__codelineno-80-33">33</a></span>
<span class="normal"><a href="#__codelineno-80-34">34</a></span>
<span class="normal"><a href="#__codelineno-80-35">35</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-80-1" name="__codelineno-80-1"></a><span class="w">    </span><span class="k">upstream</span><span class="w"> </span><span class="s">aa.com</span><span class="w"> </span><span class="p">{</span><span class="w">         </span>
<a id="__codelineno-80-2" name="__codelineno-80-2"></a><span class="w">                      </span><span class="kn">server</span><span class="w"> </span><span class="mi">192</span><span class="s">.168.0.121</span><span class="p">;</span>
<a id="__codelineno-80-3" name="__codelineno-80-3"></a><span class="w">                      </span><span class="kn">server</span><span class="w"> </span><span class="mi">192</span><span class="s">.168.0.122</span><span class="p">;</span><span class="w">  </span>
<a id="__codelineno-80-4" name="__codelineno-80-4"></a><span class="w">     </span><span class="p">}</span>
<a id="__codelineno-80-5" name="__codelineno-80-5"></a><span class="w">    </span><span class="k">upstream</span><span class="w"> </span><span class="s">bb.com</span><span class="w"> </span><span class="p">{</span><span class="w">  </span>
<a id="__codelineno-80-6" name="__codelineno-80-6"></a><span class="w">                       </span><span class="kn">server</span><span class="w"> </span><span class="mi">192</span><span class="s">.168.0.123</span><span class="p">;</span>
<a id="__codelineno-80-7" name="__codelineno-80-7"></a><span class="w">                       </span><span class="kn">server</span><span class="w"> </span><span class="mi">192</span><span class="s">.168.0.124</span><span class="p">;</span>
<a id="__codelineno-80-8" name="__codelineno-80-8"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-80-9" name="__codelineno-80-9"></a><span class="w">    </span><span class="k">server</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-80-10" name="__codelineno-80-10"></a><span class="w">        </span><span class="kn">listen</span><span class="w">       </span><span class="mi">80</span><span class="p">;</span>
<a id="__codelineno-80-11" name="__codelineno-80-11"></a><span class="w">        </span><span class="kn">server_name</span><span class="w">  </span><span class="s">www.aminglinux.com</span><span class="p">;</span>
<a id="__codelineno-80-12" name="__codelineno-80-12"></a><span class="w">        </span><span class="kn">location</span><span class="w"> </span><span class="p">~</span><span class="w"> </span><span class="sr">aa.php</span>
<a id="__codelineno-80-13" name="__codelineno-80-13"></a><span class="w">        </span><span class="p">{</span>
<a id="__codelineno-80-14" name="__codelineno-80-14"></a><span class="w">            </span><span class="kn">proxy_pass</span><span class="w"> </span><span class="s">http://aa.com/</span><span class="p">;</span>
<a id="__codelineno-80-15" name="__codelineno-80-15"></a><span class="w">            </span><span class="kn">proxy_set_header</span><span class="w"> </span><span class="s">Host</span><span class="w">   </span><span class="nv">$host</span><span class="p">;</span>
<a id="__codelineno-80-16" name="__codelineno-80-16"></a><span class="w">            </span><span class="kn">proxy_set_header</span><span class="w"> </span><span class="s">X-Real-IP</span><span class="w">      </span><span class="nv">$remote_addr</span><span class="p">;</span>
<a id="__codelineno-80-17" name="__codelineno-80-17"></a><span class="w">            </span><span class="kn">proxy_set_header</span><span class="w"> </span><span class="s">X-Forwarded-For</span><span class="w"> </span><span class="nv">$proxy_add_x_forwarded_for</span><span class="p">;</span>
<a id="__codelineno-80-18" name="__codelineno-80-18"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-80-19" name="__codelineno-80-19"></a><span class="w">        </span><span class="kn">location</span><span class="w"> </span><span class="p">~</span><span class="w"> </span><span class="sr">bb.php</span>
<a id="__codelineno-80-20" name="__codelineno-80-20"></a><span class="w">        </span><span class="p">{</span>
<a id="__codelineno-80-21" name="__codelineno-80-21"></a><span class="w">              </span><span class="kn">proxy_pass</span><span class="w"> </span><span class="s">http://bb.com/</span><span class="p">;</span>
<a id="__codelineno-80-22" name="__codelineno-80-22"></a><span class="w">              </span><span class="kn">proxy_set_header</span><span class="w"> </span><span class="s">Host</span><span class="w">   </span><span class="nv">$host</span><span class="p">;</span>
<a id="__codelineno-80-23" name="__codelineno-80-23"></a><span class="w">              </span><span class="kn">proxy_set_header</span><span class="w"> </span><span class="s">X-Real-IP</span><span class="w">      </span><span class="nv">$remote_addr</span><span class="p">;</span>
<a id="__codelineno-80-24" name="__codelineno-80-24"></a><span class="w">              </span><span class="kn">proxy_set_header</span><span class="w"> </span><span class="s">X-Forwarded-For</span><span class="w"> </span><span class="nv">$proxy_add_x_forwarded_for</span><span class="p">;</span>
<a id="__codelineno-80-25" name="__codelineno-80-25"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-80-26" name="__codelineno-80-26"></a><span class="w">        </span><span class="kn">location</span><span class="w"> </span><span class="s">/</span>
<a id="__codelineno-80-27" name="__codelineno-80-27"></a><span class="w">        </span><span class="p">{</span>
<a id="__codelineno-80-28" name="__codelineno-80-28"></a><span class="w">              </span><span class="kn">proxy_pass</span><span class="w"> </span><span class="s">http://bb.com/</span><span class="p">;</span>
<a id="__codelineno-80-29" name="__codelineno-80-29"></a><span class="w">              </span><span class="kn">proxy_set_header</span><span class="w"> </span><span class="s">Host</span><span class="w">   </span><span class="nv">$host</span><span class="p">;</span>
<a id="__codelineno-80-30" name="__codelineno-80-30"></a><span class="w">              </span><span class="kn">proxy_set_header</span><span class="w"> </span><span class="s">X-Real-IP</span><span class="w">      </span><span class="nv">$remote_addr</span><span class="p">;</span>
<a id="__codelineno-80-31" name="__codelineno-80-31"></a><span class="w">              </span><span class="kn">proxy_set_header</span><span class="w"> </span><span class="s">X-Forwarded-For</span><span class="w"> </span><span class="nv">$proxy_add_x_forwarded_for</span><span class="p">;</span>
<a id="__codelineno-80-32" name="__codelineno-80-32"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-80-33" name="__codelineno-80-33"></a><span class="p">}</span>
<a id="__codelineno-80-34" name="__codelineno-80-34"></a>
<a id="__codelineno-80-35" name="__codelineno-80-35"></a><span class="k">说明：请求aa.php的，会到aa.com组，请求bb.php的会到bb.com，其他请求全部到bb.com。</span>
</code></pre></div></td></tr></table></div>
<h3 id="案例五根据不同的目录">案例五（根据不同的目录）<a class="headerlink" href="#案例五根据不同的目录" title="Permanent link">&para;</a></h3>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Nginx Configuration File</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-81-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-81-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-81-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-81-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-81-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-81-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-81-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-81-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-81-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-81-10">10</a></span>
<span class="normal"><a href="#__codelineno-81-11">11</a></span>
<span class="normal"><a href="#__codelineno-81-12">12</a></span>
<span class="normal"><a href="#__codelineno-81-13">13</a></span>
<span class="normal"><a href="#__codelineno-81-14">14</a></span>
<span class="normal"><a href="#__codelineno-81-15">15</a></span>
<span class="normal"><a href="#__codelineno-81-16">16</a></span>
<span class="normal"><a href="#__codelineno-81-17">17</a></span>
<span class="normal"><a href="#__codelineno-81-18">18</a></span>
<span class="normal"><a href="#__codelineno-81-19">19</a></span>
<span class="normal"><a href="#__codelineno-81-20">20</a></span>
<span class="normal"><a href="#__codelineno-81-21">21</a></span>
<span class="normal"><a href="#__codelineno-81-22">22</a></span>
<span class="normal"><a href="#__codelineno-81-23">23</a></span>
<span class="normal"><a href="#__codelineno-81-24">24</a></span>
<span class="normal"><a href="#__codelineno-81-25">25</a></span>
<span class="normal"><a href="#__codelineno-81-26">26</a></span>
<span class="normal"><a href="#__codelineno-81-27">27</a></span>
<span class="normal"><a href="#__codelineno-81-28">28</a></span>
<span class="normal"><a href="#__codelineno-81-29">29</a></span>
<span class="normal"><a href="#__codelineno-81-30">30</a></span>
<span class="normal"><a href="#__codelineno-81-31">31</a></span>
<span class="normal"><a href="#__codelineno-81-32">32</a></span>
<span class="normal"><a href="#__codelineno-81-33">33</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-81-1" name="__codelineno-81-1"></a><span class="k">upstream</span><span class="w"> </span><span class="s">aaa.com</span>
<a id="__codelineno-81-2" name="__codelineno-81-2"></a><span class="p">{</span>
<a id="__codelineno-81-3" name="__codelineno-81-3"></a><span class="w">            </span><span class="kn">server</span><span class="w"> </span><span class="mi">192</span><span class="s">.168.111.6</span><span class="p">;</span>
<a id="__codelineno-81-4" name="__codelineno-81-4"></a><span class="p">}</span>
<a id="__codelineno-81-5" name="__codelineno-81-5"></a><span class="k">upstream</span><span class="w"> </span><span class="s">bbb.com</span>
<a id="__codelineno-81-6" name="__codelineno-81-6"></a><span class="p">{</span>
<a id="__codelineno-81-7" name="__codelineno-81-7"></a><span class="w">            </span><span class="kn">server</span><span class="w"> </span><span class="mi">192</span><span class="s">.168.111.20</span><span class="p">;</span>
<a id="__codelineno-81-8" name="__codelineno-81-8"></a><span class="p">}</span>
<a id="__codelineno-81-9" name="__codelineno-81-9"></a><span class="k">server</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-81-10" name="__codelineno-81-10"></a><span class="w">        </span><span class="kn">listen</span><span class="w"> </span><span class="mi">80</span><span class="p">;</span>
<a id="__codelineno-81-11" name="__codelineno-81-11"></a><span class="w">        </span><span class="kn">server_name</span><span class="w"> </span><span class="s">www.aminglinux.com</span><span class="p">;</span>
<a id="__codelineno-81-12" name="__codelineno-81-12"></a><span class="w">        </span><span class="kn">location</span><span class="w"> </span><span class="s">/aaa/</span>
<a id="__codelineno-81-13" name="__codelineno-81-13"></a><span class="w">        </span><span class="p">{</span>
<a id="__codelineno-81-14" name="__codelineno-81-14"></a><span class="w">            </span><span class="kn">proxy_pass</span><span class="w"> </span><span class="s">http://aaa.com/aaa/</span><span class="p">;</span>
<a id="__codelineno-81-15" name="__codelineno-81-15"></a><span class="w">            </span><span class="kn">proxy_set_header</span><span class="w"> </span><span class="s">Host</span><span class="w">   </span><span class="nv">$host</span><span class="p">;</span>
<a id="__codelineno-81-16" name="__codelineno-81-16"></a><span class="w">            </span><span class="kn">proxy_set_header</span><span class="w"> </span><span class="s">X-Real-IP</span><span class="w">      </span><span class="nv">$remote_addr</span><span class="p">;</span>
<a id="__codelineno-81-17" name="__codelineno-81-17"></a><span class="w">            </span><span class="kn">proxy_set_header</span><span class="w"> </span><span class="s">X-Forwarded-For</span><span class="w"> </span><span class="nv">$proxy_add_x_forwarded_for</span><span class="p">;</span>
<a id="__codelineno-81-18" name="__codelineno-81-18"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-81-19" name="__codelineno-81-19"></a><span class="w">        </span><span class="kn">location</span><span class="w"> </span><span class="s">/bbb/</span>
<a id="__codelineno-81-20" name="__codelineno-81-20"></a><span class="w">        </span><span class="p">{</span>
<a id="__codelineno-81-21" name="__codelineno-81-21"></a><span class="w">            </span><span class="kn">proxy_pass</span><span class="w"> </span><span class="s">http://bbb.com/bbb/</span><span class="p">;</span>
<a id="__codelineno-81-22" name="__codelineno-81-22"></a><span class="w">            </span><span class="kn">proxy_set_header</span><span class="w"> </span><span class="s">Host</span><span class="w">   </span><span class="nv">$host</span><span class="p">;</span>
<a id="__codelineno-81-23" name="__codelineno-81-23"></a><span class="w">            </span><span class="kn">proxy_set_header</span><span class="w"> </span><span class="s">X-Real-IP</span><span class="w">      </span><span class="nv">$remote_addr</span><span class="p">;</span>
<a id="__codelineno-81-24" name="__codelineno-81-24"></a><span class="w">            </span><span class="kn">proxy_set_header</span><span class="w"> </span><span class="s">X-Forwarded-For</span><span class="w"> </span><span class="nv">$proxy_add_x_forwarded_for</span><span class="p">;</span>
<a id="__codelineno-81-25" name="__codelineno-81-25"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-81-26" name="__codelineno-81-26"></a><span class="w">        </span><span class="kn">location</span><span class="w"> </span><span class="s">/</span>
<a id="__codelineno-81-27" name="__codelineno-81-27"></a><span class="w">        </span><span class="p">{</span>
<a id="__codelineno-81-28" name="__codelineno-81-28"></a><span class="w">            </span><span class="kn">proxy_pass</span><span class="w"> </span><span class="s">http://bbb.com/</span><span class="p">;</span>
<a id="__codelineno-81-29" name="__codelineno-81-29"></a><span class="w">            </span><span class="kn">proxy_set_header</span><span class="w"> </span><span class="s">Host</span><span class="w">   </span><span class="nv">$host</span><span class="p">;</span>
<a id="__codelineno-81-30" name="__codelineno-81-30"></a><span class="w">            </span><span class="kn">proxy_set_header</span><span class="w"> </span><span class="s">X-Real-IP</span><span class="w">      </span><span class="nv">$remote_addr</span><span class="p">;</span>
<a id="__codelineno-81-31" name="__codelineno-81-31"></a><span class="w">            </span><span class="kn">proxy_set_header</span><span class="w"> </span><span class="s">X-Forwarded-For</span><span class="w"> </span><span class="nv">$proxy_add_x_forwarded_for</span><span class="p">;</span>
<a id="__codelineno-81-32" name="__codelineno-81-32"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-81-33" name="__codelineno-81-33"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<h2 id="11nginx访问控制">11.Nginx访问控制<a class="headerlink" href="#11nginx访问控制" title="Permanent link">&para;</a></h2>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Text Only</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-82-1">1</a></span>
<span class="normal"><a href="#__codelineno-82-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-82-1" name="__codelineno-82-1"></a>Nginx的deny和allow指令是由ngx_http_access_module模块提供，Nginx安装默认内置了该模块。
<a id="__codelineno-82-2" name="__codelineno-82-2"></a>除非在安装时有指定 --without-http_access_module。
</code></pre></div></td></tr></table></div>
<h3 id="语法">语法<a class="headerlink" href="#语法" title="Permanent link">&para;</a></h3>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Nginx Configuration File</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-83-1">1</a></span>
<span class="normal"><a href="#__codelineno-83-2">2</a></span>
<span class="normal"><a href="#__codelineno-83-3">3</a></span>
<span class="normal"><a href="#__codelineno-83-4">4</a></span>
<span class="normal"><a href="#__codelineno-83-5">5</a></span>
<span class="normal"><a href="#__codelineno-83-6">6</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-83-1" name="__codelineno-83-1"></a><span class="k">语法：allow/deny</span><span class="w"> </span><span class="s">address</span><span class="w"> </span><span class="s">|</span><span class="w"> </span><span class="s">CIDR</span><span class="w"> </span><span class="s">|</span><span class="w"> </span><span class="s">unix:</span><span class="w"> </span><span class="s">|</span><span class="w"> </span><span class="s">all</span>
<a id="__codelineno-83-2" name="__codelineno-83-2"></a>
<a id="__codelineno-83-3" name="__codelineno-83-3"></a><span class="s">它表示，允许/拒绝某个ip或者一个ip段访问.如果指定unix:,那将允许socket的访问。</span>
<a id="__codelineno-83-4" name="__codelineno-83-4"></a><span class="s">注意：unix在1.5.1中新加入的功能。</span>
<a id="__codelineno-83-5" name="__codelineno-83-5"></a>
<a id="__codelineno-83-6" name="__codelineno-83-6"></a><span class="s">在nginx中，allow和deny的规则是按顺序执行的。</span>
</code></pre></div></td></tr></table></div>
<h3 id="示例">示例<a class="headerlink" href="#示例" title="Permanent link">&para;</a></h3>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Nginx Configuration File</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-84-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-84-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-84-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-84-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-84-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-84-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-84-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-84-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-84-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-84-10">10</a></span>
<span class="normal"><a href="#__codelineno-84-11">11</a></span>
<span class="normal"><a href="#__codelineno-84-12">12</a></span>
<span class="normal"><a href="#__codelineno-84-13">13</a></span>
<span class="normal"><a href="#__codelineno-84-14">14</a></span>
<span class="normal"><a href="#__codelineno-84-15">15</a></span>
<span class="normal"><a href="#__codelineno-84-16">16</a></span>
<span class="normal"><a href="#__codelineno-84-17">17</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-84-1" name="__codelineno-84-1"></a><span class="k">示例1：</span>
<a id="__codelineno-84-2" name="__codelineno-84-2"></a><span class="s">location</span><span class="w"> </span><span class="s">/</span>
<a id="__codelineno-84-3" name="__codelineno-84-3"></a><span class="p">{</span>
<a id="__codelineno-84-4" name="__codelineno-84-4"></a><span class="w">    </span><span class="kn">allow</span><span class="w"> </span><span class="mi">192</span><span class="s">.168.0.0/24</span><span class="p">;</span>
<a id="__codelineno-84-5" name="__codelineno-84-5"></a><span class="w">    </span><span class="kn">allow</span><span class="w"> </span><span class="mi">127</span><span class="s">.0.0.1</span><span class="p">;</span>
<a id="__codelineno-84-6" name="__codelineno-84-6"></a><span class="w">    </span><span class="kn">deny</span><span class="w"> </span><span class="s">all</span><span class="p">;</span>
<a id="__codelineno-84-7" name="__codelineno-84-7"></a><span class="p">}</span>
<a id="__codelineno-84-8" name="__codelineno-84-8"></a>
<a id="__codelineno-84-9" name="__codelineno-84-9"></a><span class="k">说明：这段配置值允许192.168.0.0/24网段和127.0.0.1的请求，其他来源IP全部拒绝。</span>
<a id="__codelineno-84-10" name="__codelineno-84-10"></a>
<a id="__codelineno-84-11" name="__codelineno-84-11"></a><span class="s">示例2：</span>
<a id="__codelineno-84-12" name="__codelineno-84-12"></a><span class="s">location</span><span class="w"> </span><span class="p">~</span><span class="w"> </span><span class="sr">&quot;admin&quot;</span>
<a id="__codelineno-84-13" name="__codelineno-84-13"></a><span class="p">{</span>
<a id="__codelineno-84-14" name="__codelineno-84-14"></a><span class="w">    </span><span class="kn">allow</span><span class="w"> </span><span class="mi">110</span><span class="s">.21.33.121</span><span class="p">;</span>
<a id="__codelineno-84-15" name="__codelineno-84-15"></a><span class="w">    </span><span class="kn">deny</span><span class="w"> </span><span class="s">all</span>
<a id="__codelineno-84-16" name="__codelineno-84-16"></a><span class="err">}</span>
<a id="__codelineno-84-17" name="__codelineno-84-17"></a><span class="s">说明：访问的uri中包含admin的请求，只允许110.21.33.121这个IP的请求。</span>
</code></pre></div></td></tr></table></div>
<h2 id="12nginx基于document_uri的访问控制">12.Nginx基于$document_uri的访问控制<a class="headerlink" href="#12nginx基于document_uri的访问控制" title="Permanent link">&para;</a></h2>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Text Only</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-85-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-85-1" name="__codelineno-85-1"></a>这就用到了变量$document_uri，根据前面所学内容，该变量等价于$uri，其实也等价于location匹配。
</code></pre></div></td></tr></table></div>
<h3 id="示例1_2">示例1<a class="headerlink" href="#示例1_2" title="Permanent link">&para;</a></h3>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Nginx Configuration File</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-86-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-86-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-86-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-86-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-86-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-86-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-86-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-86-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-86-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-86-10">10</a></span>
<span class="normal"><a href="#__codelineno-86-11">11</a></span>
<span class="normal"><a href="#__codelineno-86-12">12</a></span>
<span class="normal"><a href="#__codelineno-86-13">13</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-86-1" name="__codelineno-86-1"></a><span class="k">if</span><span class="w"> </span><span class="s">(</span><span class="nv">$document_uri</span><span class="w"> </span><span class="p">~</span><span class="w"> </span><span class="sr">&quot;/admin/&quot;)</span>
<a id="__codelineno-86-2" name="__codelineno-86-2"></a><span class="p">{</span>
<a id="__codelineno-86-3" name="__codelineno-86-3"></a><span class="w">    </span><span class="kn">return</span><span class="w"> </span><span class="mi">403</span><span class="p">;</span>
<a id="__codelineno-86-4" name="__codelineno-86-4"></a><span class="p">}</span>
<a id="__codelineno-86-5" name="__codelineno-86-5"></a>
<a id="__codelineno-86-6" name="__codelineno-86-6"></a><span class="k">说明：当请求的uri中包含/admin/时，直接返回403.</span>
<a id="__codelineno-86-7" name="__codelineno-86-7"></a>
<a id="__codelineno-86-8" name="__codelineno-86-8"></a><span class="s">if结构中不支持使用allow和deny。</span>
<a id="__codelineno-86-9" name="__codelineno-86-9"></a>
<a id="__codelineno-86-10" name="__codelineno-86-10"></a><span class="s">测试链接：</span>
<a id="__codelineno-86-11" name="__codelineno-86-11"></a><span class="mi">1</span><span class="s">.</span><span class="w"> </span><span class="s">www.aminglinux.com/123/admin/1.html</span><span class="w"> </span><span class="s">匹配</span>
<a id="__codelineno-86-12" name="__codelineno-86-12"></a><span class="mi">2</span><span class="s">.</span><span class="w"> </span><span class="s">www.aminglinux.com/admin123/1.html</span><span class="w">  </span><span class="s">不匹配</span>
<a id="__codelineno-86-13" name="__codelineno-86-13"></a><span class="mi">3</span><span class="s">.</span><span class="w"> </span><span class="s">www.aminglinux.com/admin.php</span><span class="w">  </span><span class="s">不匹配</span>
</code></pre></div></td></tr></table></div>
<h3 id="示例2_2">示例2<a class="headerlink" href="#示例2_2" title="Permanent link">&para;</a></h3>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Nginx Configuration File</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-87-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-87-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-87-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-87-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-87-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-87-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-87-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-87-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-87-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-87-10">10</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-87-1" name="__codelineno-87-1"></a><span class="k">if</span><span class="w"> </span><span class="s">(</span><span class="nv">$document_uri</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">/admin.php)</span>
<a id="__codelineno-87-2" name="__codelineno-87-2"></a><span class="p">{</span>
<a id="__codelineno-87-3" name="__codelineno-87-3"></a><span class="w">    </span><span class="kn">return</span><span class="w"> </span><span class="mi">403</span><span class="p">;</span>
<a id="__codelineno-87-4" name="__codelineno-87-4"></a><span class="p">}</span>
<a id="__codelineno-87-5" name="__codelineno-87-5"></a>
<a id="__codelineno-87-6" name="__codelineno-87-6"></a><span class="k">说明：请求的uri为/admin.php时返回403状态码。</span>
<a id="__codelineno-87-7" name="__codelineno-87-7"></a>
<a id="__codelineno-87-8" name="__codelineno-87-8"></a><span class="s">测试链接：</span>
<a id="__codelineno-87-9" name="__codelineno-87-9"></a><span class="mi">1</span><span class="s">.</span><span class="w"> </span><span class="s">www.aminglinux.com/admin.php</span><span class="w"> </span><span class="s">匹配</span>
<a id="__codelineno-87-10" name="__codelineno-87-10"></a><span class="mi">2</span><span class="s">.</span><span class="w"> </span><span class="s">www.aminglinux.com/123/admin.php</span><span class="w">  </span><span class="s">不匹配</span>
</code></pre></div></td></tr></table></div>
<h3 id="示例3_2">示例3<a class="headerlink" href="#示例3_2" title="Permanent link">&para;</a></h3>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Nginx Configuration File</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-88-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-88-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-88-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-88-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-88-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-88-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-88-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-88-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-88-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-88-10">10</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-88-1" name="__codelineno-88-1"></a><span class="k">if</span><span class="w"> </span><span class="s">(</span><span class="nv">$document_uri</span><span class="w"> </span><span class="p">~</span><span class="w"> </span><span class="sr">&#39;/data/|/cache/.*\.php$&#39;)</span>
<a id="__codelineno-88-2" name="__codelineno-88-2"></a><span class="p">{</span>
<a id="__codelineno-88-3" name="__codelineno-88-3"></a><span class="w">    </span><span class="kn">return</span><span class="w"> </span><span class="mi">403</span><span class="p">;</span>
<a id="__codelineno-88-4" name="__codelineno-88-4"></a><span class="p">}</span>
<a id="__codelineno-88-5" name="__codelineno-88-5"></a>
<a id="__codelineno-88-6" name="__codelineno-88-6"></a><span class="k">说明：请求的uri包含data或者cache目录，并且是php时，返回403状态码。</span>
<a id="__codelineno-88-7" name="__codelineno-88-7"></a>
<a id="__codelineno-88-8" name="__codelineno-88-8"></a><span class="s">测试链接：</span>
<a id="__codelineno-88-9" name="__codelineno-88-9"></a><span class="mi">1</span><span class="s">.</span><span class="w"> </span><span class="s">www.aminglinux.com/data/123.php</span><span class="w">  </span><span class="s">匹配</span>
<a id="__codelineno-88-10" name="__codelineno-88-10"></a><span class="mi">2</span><span class="s">.</span><span class="w"> </span><span class="s">www.aminglinux.com/cache1/123.php</span><span class="w"> </span><span class="s">不匹配</span>
</code></pre></div></td></tr></table></div>
<h2 id="13nginx基于request_uri访问控制">13.nginx基于$request_uri访问控制<a class="headerlink" href="#13nginx基于request_uri访问控制" title="Permanent link">&para;</a></h2>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Text Only</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-89-1">1</a></span>
<span class="normal"><a href="#__codelineno-89-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-89-1" name="__codelineno-89-1"></a>$request_uri比$docuemnt_uri多了请求的参数。
<a id="__codelineno-89-2" name="__codelineno-89-2"></a>主要是针对请求的uri中的参数进行控制。
</code></pre></div></td></tr></table></div>
<h5 id="示例_1">示例<a class="headerlink" href="#示例_1" title="Permanent link">&para;</a></h5>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Nginx Configuration File</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-90-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-90-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-90-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-90-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-90-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-90-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-90-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-90-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-90-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-90-10">10</a></span>
<span class="normal"><a href="#__codelineno-90-11">11</a></span>
<span class="normal"><a href="#__codelineno-90-12">12</a></span>
<span class="normal"><a href="#__codelineno-90-13">13</a></span>
<span class="normal"><a href="#__codelineno-90-14">14</a></span>
<span class="normal"><a href="#__codelineno-90-15">15</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-90-1" name="__codelineno-90-1"></a><span class="k">if</span><span class="w"> </span><span class="s">(</span><span class="nv">$request_uri</span><span class="w"> </span><span class="p">~</span><span class="w"> </span><span class="sr">&quot;gid=\d</span><span class="p">{</span><span class="kn">9,12}&quot;)</span>
<a id="__codelineno-90-2" name="__codelineno-90-2"></a><span class="p">{</span>
<a id="__codelineno-90-3" name="__codelineno-90-3"></a><span class="w">    </span><span class="kn">return</span><span class="w"> </span><span class="mi">403</span><span class="p">;</span>
<a id="__codelineno-90-4" name="__codelineno-90-4"></a><span class="p">}</span>
<a id="__codelineno-90-5" name="__codelineno-90-5"></a>
<a id="__codelineno-90-6" name="__codelineno-90-6"></a><span class="kn">说明：\d{9,12}是正则表达式，表示9到12个数字，例如gid=1234567890就符号要求。</span>
<a id="__codelineno-90-7" name="__codelineno-90-7"></a>
<a id="__codelineno-90-8" name="__codelineno-90-8"></a><span class="s">测试链接：</span>
<a id="__codelineno-90-9" name="__codelineno-90-9"></a><span class="mi">1</span><span class="s">.</span><span class="w"> </span><span class="s">www.aminglinux.com/index.php?gid=1234567890&amp;pid=111</span><span class="w">  </span><span class="s">匹配</span>
<a id="__codelineno-90-10" name="__codelineno-90-10"></a><span class="mi">2</span><span class="s">.</span><span class="w"> </span><span class="s">www.aminglinux.com/gid=123</span><span class="w">  </span><span class="s">不匹配</span>
<a id="__codelineno-90-11" name="__codelineno-90-11"></a>
<a id="__codelineno-90-12" name="__codelineno-90-12"></a><span class="s">背景知识：</span>
<a id="__codelineno-90-13" name="__codelineno-90-13"></a><span class="s">曾经有一个客户的网站cc攻击，对方发起太多类似这样的请求：/read-123405150-1-1.html</span>
<a id="__codelineno-90-14" name="__codelineno-90-14"></a><span class="s">实际上，这样的请求并不是正常的请求，网站会抛出一个页面，提示帖子不存在。</span>
<a id="__codelineno-90-15" name="__codelineno-90-15"></a><span class="s">所以，可以直接针对这样的请求，return</span><span class="w"> </span><span class="s">403状态码。</span>
</code></pre></div></td></tr></table></div>
<h2 id="14nginx基于user_agent的访问控制">14.Nginx基于$user_agent的访问控制<a class="headerlink" href="#14nginx基于user_agent的访问控制" title="Permanent link">&para;</a></h2>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Nginx Configuration File</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-91-1">1</a></span>
<span class="normal"><a href="#__codelineno-91-2">2</a></span>
<span class="normal"><a href="#__codelineno-91-3">3</a></span>
<span class="normal"><a href="#__codelineno-91-4">4</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-91-1" name="__codelineno-91-1"></a><span class="k">user_agent大家并不陌生，可以简单理解成浏览器标识，包括一些蜘蛛爬虫都可以通过user_agent来辨识。</span>
<a id="__codelineno-91-2" name="__codelineno-91-2"></a><span class="s">通过观察访问日志，可以发现一些搜索引擎的蜘蛛对网站访问特别频繁，它们并不友好。</span>
<a id="__codelineno-91-3" name="__codelineno-91-3"></a><span class="s">为了减少服务器的压力，其实可以把除主流搜索引擎蜘蛛外的其他蜘蛛爬虫全部封掉。</span>
<a id="__codelineno-91-4" name="__codelineno-91-4"></a><span class="s">另外，一些cc攻击，我们也可以通过观察它们的user_agent找到规律。</span>
</code></pre></div></td></tr></table></div>
<h5 id="示例_2">示例<a class="headerlink" href="#示例_2" title="Permanent link">&para;</a></h5>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Nginx Configuration File</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-92-1">1</a></span>
<span class="normal"><a href="#__codelineno-92-2">2</a></span>
<span class="normal"><a href="#__codelineno-92-3">3</a></span>
<span class="normal"><a href="#__codelineno-92-4">4</a></span>
<span class="normal"><a href="#__codelineno-92-5">5</a></span>
<span class="normal"><a href="#__codelineno-92-6">6</a></span>
<span class="normal"><a href="#__codelineno-92-7">7</a></span>
<span class="normal"><a href="#__codelineno-92-8">8</a></span>
<span class="normal"><a href="#__codelineno-92-9">9</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-92-1" name="__codelineno-92-1"></a><span class="k">if</span><span class="w"> </span><span class="s">(</span><span class="nv">$user_agent</span><span class="w"> </span><span class="p">~</span><span class="w"> </span><span class="sr">&#39;YisouSpider|MJ12bot/v1.4.2|YoudaoBot|Tomato&#39;)</span>
<a id="__codelineno-92-2" name="__codelineno-92-2"></a><span class="p">{</span>
<a id="__codelineno-92-3" name="__codelineno-92-3"></a><span class="w">    </span><span class="kn">return</span><span class="w"> </span><span class="mi">403</span><span class="p">;</span>
<a id="__codelineno-92-4" name="__codelineno-92-4"></a><span class="p">}</span>
<a id="__codelineno-92-5" name="__codelineno-92-5"></a><span class="k">说明：user_agent包含以上关键词的请求，全部返回403状态码。</span>
<a id="__codelineno-92-6" name="__codelineno-92-6"></a>
<a id="__codelineno-92-7" name="__codelineno-92-7"></a><span class="s">测试：</span>
<a id="__codelineno-92-8" name="__codelineno-92-8"></a><span class="mi">1</span><span class="s">.</span><span class="w"> </span><span class="s">curl</span><span class="w"> </span><span class="s">-A</span><span class="w"> </span><span class="s">&quot;123YisouSpider1.0&quot;</span>
<a id="__codelineno-92-9" name="__codelineno-92-9"></a><span class="mi">2</span><span class="s">.</span><span class="w"> </span><span class="s">curl</span><span class="w"> </span><span class="s">-A</span><span class="w"> </span><span class="s">&quot;MJ12bot/v1.4.1&quot;</span>
</code></pre></div></td></tr></table></div>
<h2 id="15nginx基于http_referer的访问控制">15.Nginx基于$http_referer的访问控制<a class="headerlink" href="#15nginx基于http_referer的访问控制" title="Permanent link">&para;</a></h2>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Text Only</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-93-1">1</a></span>
<span class="normal"><a href="#__codelineno-93-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-93-1" name="__codelineno-93-1"></a>在前面讲解rewrite时，曾经用过该变量，当时实现了防盗链功能。
<a id="__codelineno-93-2" name="__codelineno-93-2"></a>其实基于该变量，我们也可以做一些特殊的需求。
</code></pre></div></td></tr></table></div>
<h5 id="示例_3">示例<a class="headerlink" href="#示例_3" title="Permanent link">&para;</a></h5>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Nginx Configuration File</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-94-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-94-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-94-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-94-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-94-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-94-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-94-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-94-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-94-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-94-10">10</a></span>
<span class="normal"><a href="#__codelineno-94-11">11</a></span>
<span class="normal"><a href="#__codelineno-94-12">12</a></span>
<span class="normal"><a href="#__codelineno-94-13">13</a></span>
<span class="normal"><a href="#__codelineno-94-14">14</a></span>
<span class="normal"><a href="#__codelineno-94-15">15</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-94-1" name="__codelineno-94-1"></a><span class="k">背景：网站被黑挂马，搜索引擎收录的网页是有问题的，当通过搜索引擎点击到网站时，却显示一个博彩网站。</span>
<a id="__codelineno-94-2" name="__codelineno-94-2"></a><span class="s">由于查找木马需要时间，不能马上解决，为了不影响用户体验，可以针对此类请求做一个特殊操作。</span>
<a id="__codelineno-94-3" name="__codelineno-94-3"></a><span class="s">比如，可以把从百度访问的链接直接返回404状态码，或者返回一段html代码。</span>
<a id="__codelineno-94-4" name="__codelineno-94-4"></a>
<a id="__codelineno-94-5" name="__codelineno-94-5"></a><span class="s">if</span><span class="w"> </span><span class="s">(</span><span class="nv">$http_referer</span><span class="w"> </span><span class="p">~</span><span class="w"> </span><span class="sr">&#39;baidu.com&#39;)</span>
<a id="__codelineno-94-6" name="__codelineno-94-6"></a><span class="p">{</span>
<a id="__codelineno-94-7" name="__codelineno-94-7"></a><span class="w">    </span><span class="kn">return</span><span class="w"> </span><span class="mi">404</span><span class="p">;</span>
<a id="__codelineno-94-8" name="__codelineno-94-8"></a><span class="p">}</span>
<a id="__codelineno-94-9" name="__codelineno-94-9"></a>
<a id="__codelineno-94-10" name="__codelineno-94-10"></a><span class="k">或者</span>
<a id="__codelineno-94-11" name="__codelineno-94-11"></a>
<a id="__codelineno-94-12" name="__codelineno-94-12"></a><span class="s">if</span><span class="w"> </span><span class="s">(</span><span class="nv">$http_referer</span><span class="w"> </span><span class="p">~</span><span class="w"> </span><span class="sr">&#39;baidu.com&#39;)</span>
<a id="__codelineno-94-13" name="__codelineno-94-13"></a><span class="p">{</span>
<a id="__codelineno-94-14" name="__codelineno-94-14"></a><span class="w">    </span><span class="kn">return</span><span class="w"> </span><span class="mi">200</span><span class="w"> </span><span class="s">&quot;&lt;html&gt;&lt;script&gt;window.location.href=&#39;//</span><span class="nv">$host$request_uri&#39;</span><span class="p">;</span><span class="kn">&lt;/script&gt;&lt;/html&gt;&quot;</span><span class="p">;</span>
<a id="__codelineno-94-15" name="__codelineno-94-15"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<h2 id="16nginx的限速">16.Nginx的限速<a class="headerlink" href="#16nginx的限速" title="Permanent link">&para;</a></h2>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Text Only</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-95-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-95-1" name="__codelineno-95-1"></a>可以通过ngx_http_limit_conn_module和ngx_http_limit_req_module模块来实现限速的功能。
</code></pre></div></td></tr></table></div>
<h3 id="ngx_http_limit_conn_module">ngx_http_limit_conn_module<a class="headerlink" href="#ngx_http_limit_conn_module" title="Permanent link">&para;</a></h3>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Text Only</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-96-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-96-1" name="__codelineno-96-1"></a>该模块主要限制下载速度。
</code></pre></div></td></tr></table></div>
<h4 id="1-并发限制">#1. 并发限制<a class="headerlink" href="#1-并发限制" title="Permanent link">&para;</a></h4>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Nginx Configuration File</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-97-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-97-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-97-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-97-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-97-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-97-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-97-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-97-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-97-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-97-10">10</a></span>
<span class="normal"><a href="#__codelineno-97-11">11</a></span>
<span class="normal"><a href="#__codelineno-97-12">12</a></span>
<span class="normal"><a href="#__codelineno-97-13">13</a></span>
<span class="normal"><a href="#__codelineno-97-14">14</a></span>
<span class="normal"><a href="#__codelineno-97-15">15</a></span>
<span class="normal"><a href="#__codelineno-97-16">16</a></span>
<span class="normal"><a href="#__codelineno-97-17">17</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-97-1" name="__codelineno-97-1"></a><span class="k">配置示例</span>
<a id="__codelineno-97-2" name="__codelineno-97-2"></a><span class="s">http</span>
<a id="__codelineno-97-3" name="__codelineno-97-3"></a><span class="p">{</span>
<a id="__codelineno-97-4" name="__codelineno-97-4"></a><span class="w">    </span><span class="kn">...</span>
<a id="__codelineno-97-5" name="__codelineno-97-5"></a><span class="w">    </span><span class="s">limit_conn_zone</span><span class="w"> </span><span class="nv">$binary_remote_addr</span><span class="w"> </span><span class="s">zone=aming:10m</span><span class="p">;</span>
<a id="__codelineno-97-6" name="__codelineno-97-6"></a><span class="w">    </span><span class="kn">...</span>
<a id="__codelineno-97-7" name="__codelineno-97-7"></a><span class="w">    </span><span class="s">server</span>
<a id="__codelineno-97-8" name="__codelineno-97-8"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-97-9" name="__codelineno-97-9"></a><span class="w">        </span><span class="kn">...</span>
<a id="__codelineno-97-10" name="__codelineno-97-10"></a><span class="w">        </span><span class="s">limit_conn</span><span class="w"> </span><span class="s">aming</span><span class="w"> </span><span class="mi">10</span><span class="p">;</span>
<a id="__codelineno-97-11" name="__codelineno-97-11"></a><span class="w">        </span><span class="kn">...</span><span class="w">   </span>
<a id="__codelineno-97-12" name="__codelineno-97-12"></a><span class="w">    </span><span class="err">}</span>
<a id="__codelineno-97-13" name="__codelineno-97-13"></a><span class="err">}</span>
<a id="__codelineno-97-14" name="__codelineno-97-14"></a><span class="s">说明：首先用limit_conn_zone定义了一个内存区块索引aming，大小为10m，它以</span><span class="nv">$binary_remote_addr作为key。</span>
<a id="__codelineno-97-15" name="__codelineno-97-15"></a><span class="s">该配置只能在http里面配置，不支持在server里配置。</span>
<a id="__codelineno-97-16" name="__codelineno-97-16"></a>
<a id="__codelineno-97-17" name="__codelineno-97-17"></a><span class="s">limit_conn</span><span class="w"> </span><span class="s">定义针对aming这个zone，并发连接为10个。在这需要注意一下，这个10指的是单个IP的并发最多为10个。</span>
</code></pre></div></td></tr></table></div>
<h4 id="2-速度限制">#2. 速度限制<a class="headerlink" href="#2-速度限制" title="Permanent link">&para;</a></h4>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Nginx Configuration File</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-98-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-98-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-98-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-98-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-98-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-98-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-98-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-98-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-98-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-98-10">10</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-98-1" name="__codelineno-98-1"></a><span class="k">location</span><span class="w"> </span><span class="p">~</span><span class="w"> </span><span class="sr">/download/</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-98-2" name="__codelineno-98-2"></a><span class="w">    </span><span class="kn">...</span>
<a id="__codelineno-98-3" name="__codelineno-98-3"></a><span class="w">    </span><span class="s">limit_rate_after</span><span class="w"> </span><span class="mi">512k</span><span class="p">;</span>
<a id="__codelineno-98-4" name="__codelineno-98-4"></a><span class="w">    </span><span class="kn">limit_rate</span><span class="w"> </span><span class="mi">150k</span><span class="p">;</span>
<a id="__codelineno-98-5" name="__codelineno-98-5"></a><span class="w">    </span><span class="kn">...</span>
<a id="__codelineno-98-6" name="__codelineno-98-6"></a><span class="err">}</span>
<a id="__codelineno-98-7" name="__codelineno-98-7"></a><span class="s">说明：limit_rate_after定义当一个文件下载到指定大小（本例中为512k）之后开始限速；</span>
<a id="__codelineno-98-8" name="__codelineno-98-8"></a><span class="s">limit_rate</span><span class="w"> </span><span class="s">定义下载速度为150k/s。</span>
<a id="__codelineno-98-9" name="__codelineno-98-9"></a>
<a id="__codelineno-98-10" name="__codelineno-98-10"></a><span class="s">注意：这两个参数针对每个请求限速。</span>
</code></pre></div></td></tr></table></div>
<h3 id="ngx_http_limit_req_module">ngx_http_limit_req_module<a class="headerlink" href="#ngx_http_limit_req_module" title="Permanent link">&para;</a></h3>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Text Only</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-99-1">1</a></span>
<span class="normal"><a href="#__codelineno-99-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-99-1" name="__codelineno-99-1"></a>该模块主要用来限制请求数。
<a id="__codelineno-99-2" name="__codelineno-99-2"></a>可以用来防ddos攻击
</code></pre></div></td></tr></table></div>
<h4 id="1-limit_req_zone">#1. limit_req_zone<a class="headerlink" href="#1-limit_req_zone" title="Permanent link">&para;</a></h4>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Nginx Configuration File</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-100-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-100-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-100-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-100-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-100-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-100-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-100-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-100-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-100-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-100-10">10</a></span>
<span class="normal"><a href="#__codelineno-100-11">11</a></span>
<span class="normal"><a href="#__codelineno-100-12">12</a></span>
<span class="normal"><a href="#__codelineno-100-13">13</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-100-1" name="__codelineno-100-1"></a><span class="k">语法:</span><span class="w"> </span><span class="s">limit_req_zone</span><span class="w"> </span><span class="nv">$variable</span><span class="w"> </span><span class="s">zone=name:size</span><span class="w"> </span><span class="s">rate=rate</span><span class="p">;</span>
<a id="__codelineno-100-2" name="__codelineno-100-2"></a><span class="k">默认值:</span><span class="w"> </span><span class="s">none</span>
<a id="__codelineno-100-3" name="__codelineno-100-3"></a><span class="s">配置段:</span><span class="w"> </span><span class="s">http</span>
<a id="__codelineno-100-4" name="__codelineno-100-4"></a>
<a id="__codelineno-100-5" name="__codelineno-100-5"></a><span class="s">设置一块共享内存限制域用来保存键值的状态参数。</span><span class="w"> </span><span class="s">特别是保存了当前超出请求的数量。</span><span class="w"> </span>
<a id="__codelineno-100-6" name="__codelineno-100-6"></a><span class="s">键的值就是指定的变量（空值不会被计算）。</span>
<a id="__codelineno-100-7" name="__codelineno-100-7"></a><span class="s">如limit_req_zone</span><span class="w"> </span><span class="nv">$binary_remote_addr</span><span class="w"> </span><span class="s">zone=one:10m</span><span class="w"> </span><span class="s">rate=1r/s</span><span class="p">;</span>
<a id="__codelineno-100-8" name="__codelineno-100-8"></a>
<a id="__codelineno-100-9" name="__codelineno-100-9"></a><span class="k">说明：区域名称为one，大小为10m，平均处理的请求频率不能超过每秒一次,键值是客户端IP。</span>
<a id="__codelineno-100-10" name="__codelineno-100-10"></a><span class="s">使用</span><span class="nv">$binary_remote_addr变量，</span><span class="w"> </span><span class="s">可以将每条状态记录的大小减少到64个字节，这样1M的内存可以保存大约1万6千个64字节的记录。</span>
<a id="__codelineno-100-11" name="__codelineno-100-11"></a><span class="s">如果限制域的存储空间耗尽了，对于后续所有请求，服务器都会返回</span><span class="w"> </span><span class="mi">503</span><span class="w"> </span><span class="s">(Service</span><span class="w"> </span><span class="s">Temporarily</span><span class="w"> </span><span class="s">Unavailable)错误。</span>
<a id="__codelineno-100-12" name="__codelineno-100-12"></a><span class="s">速度可以设置为每秒处理请求数和每分钟处理请求数，其值必须是整数，</span>
<a id="__codelineno-100-13" name="__codelineno-100-13"></a><span class="s">所以如果你需要指定每秒处理少于1个的请求，2秒处理一个请求，可以使用</span><span class="w"> </span><span class="s">“30r/m”。</span>
</code></pre></div></td></tr></table></div>
<h4 id="2-limit_req">#2. limit_req<a class="headerlink" href="#2-limit_req" title="Permanent link">&para;</a></h4>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Nginx Configuration File</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-101-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-101-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-101-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-101-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-101-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-101-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-101-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-101-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-101-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-101-10">10</a></span>
<span class="normal"><a href="#__codelineno-101-11">11</a></span>
<span class="normal"><a href="#__codelineno-101-12">12</a></span>
<span class="normal"><a href="#__codelineno-101-13">13</a></span>
<span class="normal"><a href="#__codelineno-101-14">14</a></span>
<span class="normal"><a href="#__codelineno-101-15">15</a></span>
<span class="normal"><a href="#__codelineno-101-16">16</a></span>
<span class="normal"><a href="#__codelineno-101-17">17</a></span>
<span class="normal"><a href="#__codelineno-101-18">18</a></span>
<span class="normal"><a href="#__codelineno-101-19">19</a></span>
<span class="normal"><a href="#__codelineno-101-20">20</a></span>
<span class="normal"><a href="#__codelineno-101-21">21</a></span>
<span class="normal"><a href="#__codelineno-101-22">22</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-101-1" name="__codelineno-101-1"></a><span class="k">语法:</span><span class="w"> </span><span class="s">limit_req</span><span class="w"> </span><span class="s">zone=name</span><span class="w"> </span><span class="s">[burst=number]</span><span class="w"> </span><span class="s">[nodelay]</span><span class="p">;</span>
<a id="__codelineno-101-2" name="__codelineno-101-2"></a><span class="k">默认值:</span><span class="w"> </span><span class="s">—</span>
<a id="__codelineno-101-3" name="__codelineno-101-3"></a><span class="s">配置段:</span><span class="w"> </span><span class="s">http,</span><span class="w"> </span><span class="s">server,</span><span class="w"> </span><span class="s">location</span>
<a id="__codelineno-101-4" name="__codelineno-101-4"></a>
<a id="__codelineno-101-5" name="__codelineno-101-5"></a><span class="s">设置对应的共享内存限制域和允许被处理的最大请求数阈值。</span><span class="w"> </span>
<a id="__codelineno-101-6" name="__codelineno-101-6"></a><span class="s">如果请求的频率超过了限制域配置的值，请求处理会被延迟，所以所有的请求都是以定义的频率被处理的。</span><span class="w"> </span>
<a id="__codelineno-101-7" name="__codelineno-101-7"></a><span class="s">超过频率限制的请求会被延迟，直到被延迟的请求数超过了定义的阈值，</span>
<a id="__codelineno-101-8" name="__codelineno-101-8"></a><span class="s">这时，这个请求会被终止，并返回503</span><span class="w"> </span><span class="s">(Service</span><span class="w"> </span><span class="s">Temporarily</span><span class="w"> </span><span class="s">Unavailable)</span><span class="w"> </span><span class="s">错误。</span>
<a id="__codelineno-101-9" name="__codelineno-101-9"></a>
<a id="__codelineno-101-10" name="__codelineno-101-10"></a><span class="s">这个阈值的默认值为0。如：</span>
<a id="__codelineno-101-11" name="__codelineno-101-11"></a><span class="s">limit_req_zone</span><span class="w"> </span><span class="nv">$binary_remote_addr</span><span class="w"> </span><span class="s">zone=aming:10m</span><span class="w"> </span><span class="s">rate=1r/s</span><span class="p">;</span>
<a id="__codelineno-101-12" name="__codelineno-101-12"></a><span class="k">server</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-101-13" name="__codelineno-101-13"></a><span class="w">    </span><span class="kn">location</span><span class="w"> </span><span class="s">/upload/</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-101-14" name="__codelineno-101-14"></a><span class="w">        </span><span class="kn">limit_req</span><span class="w"> </span><span class="s">zone=aming</span><span class="w"> </span><span class="s">burst=5</span><span class="p">;</span>
<a id="__codelineno-101-15" name="__codelineno-101-15"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-101-16" name="__codelineno-101-16"></a><span class="p">}</span>
<a id="__codelineno-101-17" name="__codelineno-101-17"></a>
<a id="__codelineno-101-18" name="__codelineno-101-18"></a><span class="k">限制平均每秒不超过一个请求，同时允许超过频率限制的请求数不多于5个。</span>
<a id="__codelineno-101-19" name="__codelineno-101-19"></a>
<a id="__codelineno-101-20" name="__codelineno-101-20"></a><span class="s">如果不希望超过的请求被延迟，可以用nodelay参数,如：</span>
<a id="__codelineno-101-21" name="__codelineno-101-21"></a>
<a id="__codelineno-101-22" name="__codelineno-101-22"></a><span class="s">limit_req</span><span class="w"> </span><span class="s">zone=aming</span><span class="w"> </span><span class="s">burst=5</span><span class="w"> </span><span class="s">nodelay</span><span class="p">;</span>
</code></pre></div></td></tr></table></div>
<p>示例</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Nginx Configuration File</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-102-1">1</a></span>
<span class="normal"><a href="#__codelineno-102-2">2</a></span>
<span class="normal"><a href="#__codelineno-102-3">3</a></span>
<span class="normal"><a href="#__codelineno-102-4">4</a></span>
<span class="normal"><a href="#__codelineno-102-5">5</a></span>
<span class="normal"><a href="#__codelineno-102-6">6</a></span>
<span class="normal"><a href="#__codelineno-102-7">7</a></span>
<span class="normal"><a href="#__codelineno-102-8">8</a></span>
<span class="normal"><a href="#__codelineno-102-9">9</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-102-1" name="__codelineno-102-1"></a><span class="k">http</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-102-2" name="__codelineno-102-2"></a><span class="w">    </span><span class="kn">limit_req_zone</span><span class="w"> </span><span class="nv">$binary_remote_addr</span><span class="w"> </span><span class="s">zone=aming:10m</span><span class="w"> </span><span class="s">rate=1r/s</span><span class="p">;</span>
<a id="__codelineno-102-3" name="__codelineno-102-3"></a>
<a id="__codelineno-102-4" name="__codelineno-102-4"></a><span class="w">    </span><span class="kn">server</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-102-5" name="__codelineno-102-5"></a><span class="w">        </span><span class="kn">location</span><span class="w">  </span><span class="s">^~</span><span class="w"> </span><span class="s">/download/</span><span class="w"> </span><span class="p">{</span><span class="w">  </span>
<a id="__codelineno-102-6" name="__codelineno-102-6"></a><span class="w">            </span><span class="kn">limit_req</span><span class="w"> </span><span class="s">zone=aming</span><span class="w"> </span><span class="s">burst=5</span><span class="p">;</span>
<a id="__codelineno-102-7" name="__codelineno-102-7"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-102-8" name="__codelineno-102-8"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-102-9" name="__codelineno-102-9"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<h5 id="设定白名单ip">设定白名单IP<a class="headerlink" href="#设定白名单ip" title="Permanent link">&para;</a></h5>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Nginx Configuration File</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-103-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-103-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-103-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-103-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-103-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-103-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-103-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-103-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-103-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-103-10">10</a></span>
<span class="normal"><a href="#__codelineno-103-11">11</a></span>
<span class="normal"><a href="#__codelineno-103-12">12</a></span>
<span class="normal"><a href="#__codelineno-103-13">13</a></span>
<span class="normal"><a href="#__codelineno-103-14">14</a></span>
<span class="normal"><a href="#__codelineno-103-15">15</a></span>
<span class="normal"><a href="#__codelineno-103-16">16</a></span>
<span class="normal"><a href="#__codelineno-103-17">17</a></span>
<span class="normal"><a href="#__codelineno-103-18">18</a></span>
<span class="normal"><a href="#__codelineno-103-19">19</a></span>
<span class="normal"><a href="#__codelineno-103-20">20</a></span>
<span class="normal"><a href="#__codelineno-103-21">21</a></span>
<span class="normal"><a href="#__codelineno-103-22">22</a></span>
<span class="normal"><a href="#__codelineno-103-23">23</a></span>
<span class="normal"><a href="#__codelineno-103-24">24</a></span>
<span class="normal"><a href="#__codelineno-103-25">25</a></span>
<span class="normal"><a href="#__codelineno-103-26">26</a></span>
<span class="normal"><a href="#__codelineno-103-27">27</a></span>
<span class="normal"><a href="#__codelineno-103-28">28</a></span>
<span class="normal"><a href="#__codelineno-103-29">29</a></span>
<span class="normal"><a href="#__codelineno-103-30">30</a></span>
<span class="normal"><a href="#__codelineno-103-31">31</a></span>
<span class="normal"><a href="#__codelineno-103-32">32</a></span>
<span class="normal"><a href="#__codelineno-103-33">33</a></span>
<span class="normal"><a href="#__codelineno-103-34">34</a></span>
<span class="normal"><a href="#__codelineno-103-35">35</a></span>
<span class="normal"><a href="#__codelineno-103-36">36</a></span>
<span class="normal"><a href="#__codelineno-103-37">37</a></span>
<span class="normal"><a href="#__codelineno-103-38">38</a></span>
<span class="normal"><a href="#__codelineno-103-39">39</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-103-1" name="__codelineno-103-1"></a><span class="k">如果是针对公司内部IP或者lo（127.0.0.1）不进行限速，如何做呢？这就要用到geo模块了。</span>
<a id="__codelineno-103-2" name="__codelineno-103-2"></a>
<a id="__codelineno-103-3" name="__codelineno-103-3"></a><span class="s">假如，预把127.0.0.1和192.168.100.0/24网段设置为白名单，需要这样做。</span>
<a id="__codelineno-103-4" name="__codelineno-103-4"></a><span class="s">在http</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">}</span><span class="k">里面增加：</span>
<a id="__codelineno-103-5" name="__codelineno-103-5"></a><span class="s">geo</span><span class="w"> </span><span class="nv">$limited</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-103-6" name="__codelineno-103-6"></a><span class="w">    </span><span class="kn">default</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<a id="__codelineno-103-7" name="__codelineno-103-7"></a><span class="w">    </span><span class="kn">127.0.0.1/32</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-103-8" name="__codelineno-103-8"></a><span class="w">    </span><span class="kn">192.168.100.0/24</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-103-9" name="__codelineno-103-9"></a><span class="p">}</span>
<a id="__codelineno-103-10" name="__codelineno-103-10"></a>
<a id="__codelineno-103-11" name="__codelineno-103-11"></a><span class="k">map</span><span class="w"> </span><span class="nv">$limited</span><span class="w"> </span><span class="nv">$limit</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-103-12" name="__codelineno-103-12"></a><span class="w">    </span><span class="kn">1</span><span class="w"> </span><span class="nv">$binary_remote_addr</span><span class="p">;</span>
<a id="__codelineno-103-13" name="__codelineno-103-13"></a><span class="w">    </span><span class="kn">0</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="p">;</span>
<a id="__codelineno-103-14" name="__codelineno-103-14"></a><span class="p">}</span>
<a id="__codelineno-103-15" name="__codelineno-103-15"></a>
<a id="__codelineno-103-16" name="__codelineno-103-16"></a><span class="k">原来的</span><span class="w"> </span><span class="s">“limit_req_zone</span><span class="w"> </span><span class="nv">$binary_remote_addr</span><span class="w"> </span><span class="s">”</span><span class="w"> </span><span class="s">改为“limit_req_zone</span><span class="w"> </span><span class="nv">$limit”</span>
<a id="__codelineno-103-17" name="__codelineno-103-17"></a>
<a id="__codelineno-103-18" name="__codelineno-103-18"></a><span class="s">完整示例：</span>
<a id="__codelineno-103-19" name="__codelineno-103-19"></a>
<a id="__codelineno-103-20" name="__codelineno-103-20"></a><span class="s">http</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-103-21" name="__codelineno-103-21"></a><span class="w">    </span><span class="kn">geo</span><span class="w"> </span><span class="nv">$limited</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-103-22" name="__codelineno-103-22"></a><span class="w">        </span><span class="kn">default</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<a id="__codelineno-103-23" name="__codelineno-103-23"></a><span class="w">        </span><span class="kn">127.0.0.1/32</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-103-24" name="__codelineno-103-24"></a><span class="w">        </span><span class="kn">192.168.100.0/24</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-103-25" name="__codelineno-103-25"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-103-26" name="__codelineno-103-26"></a>
<a id="__codelineno-103-27" name="__codelineno-103-27"></a><span class="w">    </span><span class="kn">map</span><span class="w"> </span><span class="nv">$limited</span><span class="w"> </span><span class="nv">$limit</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-103-28" name="__codelineno-103-28"></a><span class="w">        </span><span class="kn">1</span><span class="w"> </span><span class="nv">$binary_remote_addr</span><span class="p">;</span>
<a id="__codelineno-103-29" name="__codelineno-103-29"></a><span class="w">        </span><span class="kn">0</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="p">;</span>
<a id="__codelineno-103-30" name="__codelineno-103-30"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-103-31" name="__codelineno-103-31"></a>
<a id="__codelineno-103-32" name="__codelineno-103-32"></a><span class="w">    </span><span class="kn">limit_req_zone</span><span class="w"> </span><span class="nv">$limit</span><span class="w"> </span><span class="s">zone=aming:10m</span><span class="w"> </span><span class="s">rate=1r/s</span><span class="p">;</span>
<a id="__codelineno-103-33" name="__codelineno-103-33"></a>
<a id="__codelineno-103-34" name="__codelineno-103-34"></a><span class="w">    </span><span class="kn">server</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-103-35" name="__codelineno-103-35"></a><span class="w">        </span><span class="kn">location</span><span class="w">  </span><span class="s">^~</span><span class="w"> </span><span class="s">/download/</span><span class="w"> </span><span class="p">{</span><span class="w">  </span>
<a id="__codelineno-103-36" name="__codelineno-103-36"></a><span class="w">            </span><span class="kn">limit_req</span><span class="w"> </span><span class="s">zone=aming</span><span class="w"> </span><span class="s">burst=5</span><span class="p">;</span>
<a id="__codelineno-103-37" name="__codelineno-103-37"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-103-38" name="__codelineno-103-38"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-103-39" name="__codelineno-103-39"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<h2 id="17nginx的用户认证类似tomcatbasic认证">17.Nginx的用户认证（类似tomcatbasic认证）<a class="headerlink" href="#17nginx的用户认证类似tomcatbasic认证" title="Permanent link">&para;</a></h2>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Text Only</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-104-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-104-1" name="__codelineno-104-1"></a>当访问一些私密资源时，最好配置用户认证，增加安全性。
</code></pre></div></td></tr></table></div>
<h5 id="步骤和示例">步骤和示例<a class="headerlink" href="#步骤和示例" title="Permanent link">&para;</a></h5>
<ul>
<li>安装httpd</li>
</ul>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-105-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-105-1" name="__codelineno-105-1"></a>yum<span class="w"> </span>install<span class="w"> </span>-y<span class="w"> </span>httpd
</code></pre></div></td></tr></table></div>
<ul>
<li>使用htpasswd生产密码文件</li>
</ul>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-106-1">1</a></span>
<span class="normal"><a href="#__codelineno-106-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-106-1" name="__codelineno-106-1"></a>htpasswd<span class="w"> </span>-c<span class="w"> </span>/usr/local/nginx/conf/htpasswd<span class="w"> </span>liyedong<span class="w"> </span><span class="c1">#创建新文件</span>
<a id="__codelineno-106-2" name="__codelineno-106-2"></a>htpasswd<span class="w"> </span>/usr/local/nginx/conf/htpasswd<span class="w"> </span>liyedong1<span class="w"> </span><span class="c1">#追加或者修改</span>
</code></pre></div></td></tr></table></div>
<ul>
<li>配置nginx用户认证</li>
</ul>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Nginx Configuration File</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-107-1">1</a></span>
<span class="normal"><a href="#__codelineno-107-2">2</a></span>
<span class="normal"><a href="#__codelineno-107-3">3</a></span>
<span class="normal"><a href="#__codelineno-107-4">4</a></span>
<span class="normal"><a href="#__codelineno-107-5">5</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-107-1" name="__codelineno-107-1"></a><span class="k">location</span><span class="w">  </span><span class="s">/admin/</span>
<a id="__codelineno-107-2" name="__codelineno-107-2"></a><span class="p">{</span>
<a id="__codelineno-107-3" name="__codelineno-107-3"></a><span class="w">    </span><span class="kn">auth_basic</span><span class="w"> </span><span class="s">&quot;Auth&quot;</span><span class="p">;</span>
<a id="__codelineno-107-4" name="__codelineno-107-4"></a><span class="w">    </span><span class="kn">auth_basic_user_file</span><span class="w"> </span><span class="s">/usr/local/nginx/conf/htpasswd</span><span class="p">;</span>
<a id="__codelineno-107-5" name="__codelineno-107-5"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<ul>
<li>测试</li>
</ul>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-108-1">1</a></span>
<span class="normal"><a href="#__codelineno-108-2">2</a></span>
<span class="normal"><a href="#__codelineno-108-3">3</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-108-1" name="__codelineno-108-1"></a>mkdir<span class="w"> </span>-p<span class="w"> </span>/data/wwwroot/www.1.com/admin
<a id="__codelineno-108-2" name="__codelineno-108-2"></a><span class="nb">echo</span><span class="w"> </span>i<span class="w"> </span>am<span class="w"> </span>admin<span class="w"> </span>&gt;<span class="w"> </span>/data/wwwroot/www.1.com/admin/admin.html
<a id="__codelineno-108-3" name="__codelineno-108-3"></a>http://www.1.com/admin/admin.html
</code></pre></div></td></tr></table></div>
<h2 id="18ca证书">18.CA证书<a class="headerlink" href="#18ca证书" title="Permanent link">&para;</a></h2>
<h3 id="什么是ca">什么是CA？<a class="headerlink" href="#什么是ca" title="Permanent link">&para;</a></h3>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Text Only</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-109-1">1</a></span>
<span class="normal"><a href="#__codelineno-109-2">2</a></span>
<span class="normal"><a href="#__codelineno-109-3">3</a></span>
<span class="normal"><a href="#__codelineno-109-4">4</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-109-1" name="__codelineno-109-1"></a>CA 是“Certificate Authority”的缩写，也叫“证书授权中心”。它是负责管理和签发证书的第三方机构，
<a id="__codelineno-109-2" name="__codelineno-109-2"></a>就好比例子里面的中介C公司。
<a id="__codelineno-109-3" name="__codelineno-109-3"></a>一般来说，CA必须是所有行业和所有公众都信任的、认可的。因此它必须具有足够的权威性。
<a id="__codelineno-109-4" name="__codelineno-109-4"></a>就好比A、B两公司都必须信任C公司，才会找C公司作为公章的中介。
</code></pre></div></td></tr></table></div>
<h3 id="什么是ca证书">什么是CA证书？<a class="headerlink" href="#什么是ca证书" title="Permanent link">&para;</a></h3>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Text Only</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-110-1">1</a></span>
<span class="normal"><a href="#__codelineno-110-2">2</a></span>
<span class="normal"><a href="#__codelineno-110-3">3</a></span>
<span class="normal"><a href="#__codelineno-110-4">4</a></span>
<span class="normal"><a href="#__codelineno-110-5">5</a></span>
<span class="normal"><a href="#__codelineno-110-6">6</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-110-1" name="__codelineno-110-1"></a>CA证书，顾名思义，就是CA颁发的证书。
<a id="__codelineno-110-2" name="__codelineno-110-2"></a>
<a id="__codelineno-110-3" name="__codelineno-110-3"></a>前面已经说了，人人都可以找工具制作证书。但是你一个小破孩制作出来的证书是没啥用处的。
<a id="__codelineno-110-4" name="__codelineno-110-4"></a>因为你不是权威的CA机关，你自己搞的证书不具有权威性。
<a id="__codelineno-110-5" name="__codelineno-110-5"></a>这就好比上述的例子里，某个坏人自己刻了一个公章，盖到介绍信上。但是别人一看，
<a id="__codelineno-110-6" name="__codelineno-110-6"></a>不是受信任的中介公司的公章，就不予理睬。
</code></pre></div></td></tr></table></div>
<h3 id="什么是证书之间的信任关系">什么是证书之间的信任关系？<a class="headerlink" href="#什么是证书之间的信任关系" title="Permanent link">&para;</a></h3>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Text Only</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-111-1">1</a></span>
<span class="normal"><a href="#__codelineno-111-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-111-1" name="__codelineno-111-1"></a>在开篇的例子里谈到，引入中介后，业务员要同时带两个介绍信。第一个介绍信包含了两个公章，并注明，公章C信任公章A。
<a id="__codelineno-111-2" name="__codelineno-111-2"></a>证书间的信任关系，就和这个类似。就是用一个证书来证明另一个证书是真实可信滴。
</code></pre></div></td></tr></table></div>
<h5 id="什么是证书信任链">什么是证书信任链？<a class="headerlink" href="#什么是证书信任链" title="Permanent link">&para;</a></h5>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Text Only</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-112-1">1</a></span>
<span class="normal"><a href="#__codelineno-112-2">2</a></span>
<span class="normal"><a href="#__codelineno-112-3">3</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-112-1" name="__codelineno-112-1"></a>实际上，证书之间的信任关系，是可以嵌套的。
<a id="__codelineno-112-2" name="__codelineno-112-2"></a>比如，C信任A1，A1信任A2，A2信任A3......这个叫做证书的信任链。
<a id="__codelineno-112-3" name="__codelineno-112-3"></a>只要你信任链上的头一个证书，那后续的证书，都是可以信任滴。
</code></pre></div></td></tr></table></div>
<h3 id="什么是根证书">什么是根证书？<a class="headerlink" href="#什么是根证书" title="Permanent link">&para;</a></h3>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Text Only</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-113-1">1</a></span>
<span class="normal"><a href="#__codelineno-113-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-113-1" name="__codelineno-113-1"></a>根证书的洋文叫“root certificate”，为了说清楚根证书是咋回事，再来看个稍微复杂点的例子。
<a id="__codelineno-113-2" name="__codelineno-113-2"></a>假设C证书信任A和B；然后A信任A1和A2；B信任B1和B2。则它们之间，构成如下的一个树形关系（一个倒立的树）。
</code></pre></div></td></tr></table></div>
<p><a href="https://camo.githubusercontent.com/0de3d24f735de21c23f350c55f06b54f23dd51ba04c5ccb32bc33fca1704afff/687474703a2f2f61736b2e6170656c6561726e2e636f6d2f75706c6f6164732f6e67696e782f63615f747265652e706e67"><img alt="img" src="https://camo.githubusercontent.com/0de3d24f735de21c23f350c55f06b54f23dd51ba04c5ccb32bc33fca1704afff/687474703a2f2f61736b2e6170656c6561726e2e636f6d2f75706c6f6164732f6e67696e782f63615f747265652e706e67" /></a></p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Text Only</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-114-1">1</a></span>
<span class="normal"><a href="#__codelineno-114-2">2</a></span>
<span class="normal"><a href="#__codelineno-114-3">3</a></span>
<span class="normal"><a href="#__codelineno-114-4">4</a></span>
<span class="normal"><a href="#__codelineno-114-5">5</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-114-1" name="__codelineno-114-1"></a>处于最顶上的树根位置的那个证书，就是“根证书”。除了根证书，其它证书都要依靠上一级的证书，来证明自己。
<a id="__codelineno-114-2" name="__codelineno-114-2"></a>那谁来证明“根证书”可靠呢？
<a id="__codelineno-114-3" name="__codelineno-114-3"></a>实际上，根证书自己证明自己是可靠滴（或者换句话说，根证书是不需要被证明滴）。
<a id="__codelineno-114-4" name="__codelineno-114-4"></a>聪明的同学此刻应该意识到了：根证书是整个证书体系安全的根本。
<a id="__codelineno-114-5" name="__codelineno-114-5"></a>所以，如果某个证书体系中，根证书出了问题（不再可信了），那么所有被根证书所信任的其它证书，也就不再可信了。
</code></pre></div></td></tr></table></div>
<h3 id="证书有啥用">证书有啥用？<a class="headerlink" href="#证书有啥用" title="Permanent link">&para;</a></h3>
<p>CA证书的作用有很多，只列出常用的几个。</p>
<ul>
<li>验证网站是否可信（针对HTTPS）</li>
</ul>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Text Only</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-115-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-115-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-115-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-115-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-115-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-115-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-115-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-115-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-115-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-115-10">10</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-115-1" name="__codelineno-115-1"></a>通常，我们如果访问某些敏感的网页（比如用户登录的页面），其协议都会使用HTTPS而不是HTTP,因为HTTP协议是明文的，
<a id="__codelineno-115-2" name="__codelineno-115-2"></a>一旦有坏人在偷窥你的网络通讯，他/她就可以看到网络通讯的内容（比如你的密码、银行帐号、等）。
<a id="__codelineno-115-3" name="__codelineno-115-3"></a>而 HTTPS 是加密的协议，可以保证你的传输过程中，坏蛋无法偷窥。
<a id="__codelineno-115-4" name="__codelineno-115-4"></a>但是，千万不要以为，HTTPS协议有了加密，就可高枕无忧了。
<a id="__codelineno-115-5" name="__codelineno-115-5"></a>假设有一个坏人，搞了一个假的网银的站点，然后诱骗你上这个站点。
<a id="__codelineno-115-6" name="__codelineno-115-6"></a>假设你又比较单纯，一不留神，就把你的帐号，口令都输入进去了。那这个坏蛋的阴谋就得逞了。
<a id="__codelineno-115-7" name="__codelineno-115-7"></a>为了防止坏人这么干，HTTPS 协议除了有加密的机制，还有一套证书的机制。通过证书来确保，某个站点确实就是某个站点。
<a id="__codelineno-115-8" name="__codelineno-115-8"></a>有了证书之后，当你的浏览器在访问某个HTTPS网站时，会验证该站点上的CA证书（类似于验证介绍信的公章）。
<a id="__codelineno-115-9" name="__codelineno-115-9"></a>如果浏览器发现该证书没有问题（证书被某个根证书信任、证书上绑定的域名和该网站的域名一致、证书没有过期），
<a id="__codelineno-115-10" name="__codelineno-115-10"></a>那么页面就直接打开，否则的话，浏览器会给出一个警告，告诉你该网站的证书存在某某问题，是否继续访问该站点。
</code></pre></div></td></tr></table></div>
<h2 id="19ssl原理">19.SSL原理<a class="headerlink" href="#19ssl原理" title="Permanent link">&para;</a></h2>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Text Only</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-116-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-116-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-116-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-116-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-116-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-116-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-116-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-116-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-116-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-116-10">10</a></span>
<span class="normal"><a href="#__codelineno-116-11">11</a></span>
<span class="normal"><a href="#__codelineno-116-12">12</a></span>
<span class="normal"><a href="#__codelineno-116-13">13</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-116-1" name="__codelineno-116-1"></a>要想弄明白SSL认证原理，首先要对CA有有所了解，它在SSL认证过程中有非常重要的作用。
<a id="__codelineno-116-2" name="__codelineno-116-2"></a>说白了，CA就是一个组织，专门为网络服务器颁发证书的，国际知名的CA机构有VeriSign、Symantec，国内的有GlobalSign。
<a id="__codelineno-116-3" name="__codelineno-116-3"></a>每一家CA都有自己的根证书，用来对它所签发过的服务器端证书进行验证。
<a id="__codelineno-116-4" name="__codelineno-116-4"></a>
<a id="__codelineno-116-5" name="__codelineno-116-5"></a>如果服务器提供方想为自己的服务器申请证书，它就需要向CA机构提出申请。
<a id="__codelineno-116-6" name="__codelineno-116-6"></a>服务器提供方向CA提供自己的身份信息，CA判明申请者的身份后，就为它分配一个公钥，
<a id="__codelineno-116-7" name="__codelineno-116-7"></a>并且CA将该公钥和服务器身份绑定在一起，并为之签字，这就形成了一个服务器端证书。
<a id="__codelineno-116-8" name="__codelineno-116-8"></a>
<a id="__codelineno-116-9" name="__codelineno-116-9"></a>如果一个用户想鉴别另一个证书的真伪，他就用CA的公钥对那个证书上的签字进行验证，一旦验证通过，该证书就被认为是有效的。
<a id="__codelineno-116-10" name="__codelineno-116-10"></a>证书实际是由证书签证机关（CA）签发的对用户的公钥的认证。
<a id="__codelineno-116-11" name="__codelineno-116-11"></a>
<a id="__codelineno-116-12" name="__codelineno-116-12"></a>证书的内容包括：电子签证机关的信息、公钥用户信息、公钥、权威机构的签字和有效期等等。
<a id="__codelineno-116-13" name="__codelineno-116-13"></a>目前，证书的格式和验证方法普遍遵循X.509国际标准。
</code></pre></div></td></tr></table></div>
<h3 id="申请证书过程">#申请证书过程<a class="headerlink" href="#申请证书过程" title="Permanent link">&para;</a></h3>
<p><a href="https://camo.githubusercontent.com/03bb5f5eebae745f4902bc70ec24d64c552584ff0bf38ceabd8db5df05c15500/687474703a2f2f61736b2e6170656c6561726e2e636f6d2f75706c6f6164732f6e67696e782f73736c5f63612e706e67"><img alt="image" src="https://camo.githubusercontent.com/03bb5f5eebae745f4902bc70ec24d64c552584ff0bf38ceabd8db5df05c15500/687474703a2f2f61736b2e6170656c6561726e2e636f6d2f75706c6f6164732f6e67696e782f73736c5f63612e706e67" /></a></p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Text Only</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-117-1">1</a></span>
<span class="normal"><a href="#__codelineno-117-2">2</a></span>
<span class="normal"><a href="#__codelineno-117-3">3</a></span>
<span class="normal"><a href="#__codelineno-117-4">4</a></span>
<span class="normal"><a href="#__codelineno-117-5">5</a></span>
<span class="normal"><a href="#__codelineno-117-6">6</a></span>
<span class="normal"><a href="#__codelineno-117-7">7</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-117-1" name="__codelineno-117-1"></a>首先要有一个CA根证书，然后用CA根证书来签发用户证书。
<a id="__codelineno-117-2" name="__codelineno-117-2"></a>用户进行证书申请：
<a id="__codelineno-117-3" name="__codelineno-117-3"></a>1. 先生成一个私钥
<a id="__codelineno-117-4" name="__codelineno-117-4"></a>2. 用私钥生成证书请求(证书请求里应含有公钥信息)
<a id="__codelineno-117-5" name="__codelineno-117-5"></a>3. 利用证书服务器的CA根证书来签发证书
<a id="__codelineno-117-6" name="__codelineno-117-6"></a>
<a id="__codelineno-117-7" name="__codelineno-117-7"></a>这样最终拿到一个由CA根证书签发的证书，其实证书里仅有公钥，而私钥是在用户手里的。
</code></pre></div></td></tr></table></div>
<h3 id="ssl工作流程单向">SSL工作流程（单向）<a class="headerlink" href="#ssl工作流程单向" title="Permanent link">&para;</a></h3>
<p><a href="https://camo.githubusercontent.com/a3f0fcfcc2d9ba54cf640fd6200d9eab3dbaa76c894953602ce881030472cc26/687474703a2f2f61736b2e6170656c6561726e2e636f6d2f75706c6f6164732f6e67696e782f73736c5f617574682e6a7067"><img alt="image" src="https://camo.githubusercontent.com/a3f0fcfcc2d9ba54cf640fd6200d9eab3dbaa76c894953602ce881030472cc26/687474703a2f2f61736b2e6170656c6561726e2e636f6d2f75706c6f6164732f6e67696e782f73736c5f617574682e6a7067" /></a></p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Text Only</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-118-1">1</a></span>
<span class="normal"><a href="#__codelineno-118-2">2</a></span>
<span class="normal"><a href="#__codelineno-118-3">3</a></span>
<span class="normal"><a href="#__codelineno-118-4">4</a></span>
<span class="normal"><a href="#__codelineno-118-5">5</a></span>
<span class="normal"><a href="#__codelineno-118-6">6</a></span>
<span class="normal"><a href="#__codelineno-118-7">7</a></span>
<span class="normal"><a href="#__codelineno-118-8">8</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-118-1" name="__codelineno-118-1"></a>1.客户端say hello 服务端
<a id="__codelineno-118-2" name="__codelineno-118-2"></a>2.服务端将证书、公钥等发给客户端
<a id="__codelineno-118-3" name="__codelineno-118-3"></a>3.客户端CA验证证书，成功继续、不成功弹出选择页面
<a id="__codelineno-118-4" name="__codelineno-118-4"></a>4.客户端告知服务端所支持的加密算法
<a id="__codelineno-118-5" name="__codelineno-118-5"></a>5.服务端选择最高级别加密算法明文通知客户端
<a id="__codelineno-118-6" name="__codelineno-118-6"></a>6.客户端生成随机对称密钥key，使用服务端公钥加密发送给服务端
<a id="__codelineno-118-7" name="__codelineno-118-7"></a>7.服务端使用私钥解密，获取对称密钥key
<a id="__codelineno-118-8" name="__codelineno-118-8"></a>8.后续客户端与服务端使用该密钥key进行加密通信
</code></pre></div></td></tr></table></div>
<h3 id="ssl工作流程双向">SSL工作流程（双向）<a class="headerlink" href="#ssl工作流程双向" title="Permanent link">&para;</a></h3>
<p>单向认证，仅仅是客户端需要检验服务端证书是否是正确的，而服务端不会检验客户端证书是否是正确的。 双向认证，指客户端验证服务器端证书，而服务器也需要通过CA的公钥证书来验证客户端证书。</p>
<p>双向验证的过程：</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Text Only</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-119-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-119-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-119-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-119-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-119-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-119-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-119-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-119-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-119-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-119-10">10</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-119-1" name="__codelineno-119-1"></a>1.客户端say hello 服务端
<a id="__codelineno-119-2" name="__codelineno-119-2"></a>2.服务端将证书、公钥等发给客户端
<a id="__codelineno-119-3" name="__codelineno-119-3"></a>3.客户端CA验证证书，成功继续、不成功弹出选择页面
<a id="__codelineno-119-4" name="__codelineno-119-4"></a>4.客户端将自己的证书和公钥发送给服务端
<a id="__codelineno-119-5" name="__codelineno-119-5"></a>5.服务端验证客户端证书，如不通过直接断开连接
<a id="__codelineno-119-6" name="__codelineno-119-6"></a>6.客户端告知服务端所支持的加密算法
<a id="__codelineno-119-7" name="__codelineno-119-7"></a>7.服务端选择最高级别加密算法使用客户端公钥加密后发送给客户端
<a id="__codelineno-119-8" name="__codelineno-119-8"></a>8.客户端收到后使用私钥解密并生成随机对称密钥key，使用服务端公钥加密发送给服务端
<a id="__codelineno-119-9" name="__codelineno-119-9"></a>9.服务端使用私钥解密，获取对称密钥key
<a id="__codelineno-119-10" name="__codelineno-119-10"></a>10.后续客户端与服务端使用该密钥key进行加密通信
</code></pre></div></td></tr></table></div>
<h2 id="20自制ca证书">20.自制ca证书<a class="headerlink" href="#20自制ca证书" title="Permanent link">&para;</a></h2>
<h3 id="生成ca根证书">生成CA根证书<a class="headerlink" href="#生成ca根证书" title="Permanent link">&para;</a></h3>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-120-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-120-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-120-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-120-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-120-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-120-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-120-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-120-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-120-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-120-10">10</a></span>
<span class="normal"><a href="#__codelineno-120-11">11</a></span>
<span class="normal"><a href="#__codelineno-120-12">12</a></span>
<span class="normal"><a href="#__codelineno-120-13">13</a></span>
<span class="normal"><a href="#__codelineno-120-14">14</a></span>
<span class="normal"><a href="#__codelineno-120-15">15</a></span>
<span class="normal"><a href="#__codelineno-120-16">16</a></span>
<span class="normal"><a href="#__codelineno-120-17">17</a></span>
<span class="normal"><a href="#__codelineno-120-18">18</a></span>
<span class="normal"><a href="#__codelineno-120-19">19</a></span>
<span class="normal"><a href="#__codelineno-120-20">20</a></span>
<span class="normal"><a href="#__codelineno-120-21">21</a></span>
<span class="normal"><a href="#__codelineno-120-22">22</a></span>
<span class="normal"><a href="#__codelineno-120-23">23</a></span>
<span class="normal"><a href="#__codelineno-120-24">24</a></span>
<span class="normal"><a href="#__codelineno-120-25">25</a></span>
<span class="normal"><a href="#__codelineno-120-26">26</a></span>
<span class="normal"><a href="#__codelineno-120-27">27</a></span>
<span class="normal"><a href="#__codelineno-120-28">28</a></span>
<span class="normal"><a href="#__codelineno-120-29">29</a></span>
<span class="normal"><a href="#__codelineno-120-30">30</a></span>
<span class="normal"><a href="#__codelineno-120-31">31</a></span>
<span class="normal"><a href="#__codelineno-120-32">32</a></span>
<span class="normal"><a href="#__codelineno-120-33">33</a></span>
<span class="normal"><a href="#__codelineno-120-34">34</a></span>
<span class="normal"><a href="#__codelineno-120-35">35</a></span>
<span class="normal"><a href="#__codelineno-120-36">36</a></span>
<span class="normal"><a href="#__codelineno-120-37">37</a></span>
<span class="normal"><a href="#__codelineno-120-38">38</a></span>
<span class="normal"><a href="#__codelineno-120-39">39</a></span>
<span class="normal"><a href="#__codelineno-120-40">40</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-120-1" name="__codelineno-120-1"></a>mkdir<span class="w"> </span>-p<span class="w"> </span>/etc/pki/ca_test<span class="w"> </span>//创建CA更证书的目录
<a id="__codelineno-120-2" name="__codelineno-120-2"></a>
<a id="__codelineno-120-3" name="__codelineno-120-3"></a><span class="nb">cd</span><span class="w"> </span>/etc/pki/ca_test
<a id="__codelineno-120-4" name="__codelineno-120-4"></a>
<a id="__codelineno-120-5" name="__codelineno-120-5"></a>mkdir<span class="w"> </span>root<span class="w"> </span>server<span class="w"> </span>client<span class="w"> </span>newcerts<span class="w">  </span>//创建几个相关的目录
<a id="__codelineno-120-6" name="__codelineno-120-6"></a>
<a id="__codelineno-120-7" name="__codelineno-120-7"></a><span class="nb">echo</span><span class="w"> </span><span class="m">01</span><span class="w"> </span>&gt;<span class="w"> </span>serial<span class="w">   </span>//定义序列号为01
<a id="__codelineno-120-8" name="__codelineno-120-8"></a>
<a id="__codelineno-120-9" name="__codelineno-120-9"></a><span class="nb">echo</span><span class="w"> </span><span class="m">01</span><span class="w"> </span>&gt;<span class="w"> </span>crlnumber<span class="w">  </span>//定义crl号为01
<a id="__codelineno-120-10" name="__codelineno-120-10"></a>
<a id="__codelineno-120-11" name="__codelineno-120-11"></a>touch<span class="w"> </span>index.txt<span class="w">  </span>//创建index.txt
<a id="__codelineno-120-12" name="__codelineno-120-12"></a>
<a id="__codelineno-120-13" name="__codelineno-120-13"></a><span class="nb">cd</span><span class="w"> </span>..
<a id="__codelineno-120-14" name="__codelineno-120-14"></a>
<a id="__codelineno-120-15" name="__codelineno-120-15"></a>vi<span class="w"> </span>tls/openssl.cnf<span class="w">  </span>//改配置文件
<a id="__codelineno-120-16" name="__codelineno-120-16"></a><span class="nv">default_ca</span><span class="w">     </span><span class="o">=</span><span class="w"> </span>CA_default<span class="w"> </span>改为<span class="w"> </span><span class="nv">default_ca</span><span class="w">     </span><span class="o">=</span><span class="w"> </span>CA_test
<a id="__codelineno-120-17" name="__codelineno-120-17"></a><span class="o">[</span><span class="w"> </span>CA_default<span class="w"> </span><span class="o">]</span><span class="w"> </span>改为<span class="w"> </span><span class="o">[</span><span class="w"> </span>CA_test<span class="w"> </span><span class="o">]</span>
<a id="__codelineno-120-18" name="__codelineno-120-18"></a><span class="nv">dir</span><span class="w">             </span><span class="o">=</span><span class="w"> </span>/etc/pki/CA<span class="w">  </span>改为<span class="w">  </span><span class="nv">dir</span><span class="w">             </span><span class="o">=</span><span class="w"> </span>/etc/pki/ca_test
<a id="__codelineno-120-19" name="__codelineno-120-19"></a><span class="nv">certificate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$dir</span>/cacert.pem<span class="w">  </span>改为<span class="w"> </span><span class="nv">certificate</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="nv">$dir</span>/root/ca.crt
<a id="__codelineno-120-20" name="__codelineno-120-20"></a><span class="nv">private_key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$dir</span>/private/cakey.pe<span class="w"> </span>改为<span class="w">  </span><span class="nv">private_key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$dir</span>/root/ca.key
<a id="__codelineno-120-21" name="__codelineno-120-21"></a>
<a id="__codelineno-120-22" name="__codelineno-120-22"></a>openssl<span class="w"> </span>genrsa<span class="w"> </span>-out<span class="w"> </span>/etc/pki/ca_test/root/ca.key<span class="w">  </span><span class="c1">#生成私钥</span>
<a id="__codelineno-120-23" name="__codelineno-120-23"></a>
<a id="__codelineno-120-24" name="__codelineno-120-24"></a>openssl<span class="w"> </span>req<span class="w"> </span>-new<span class="w"> </span>-key<span class="w"> </span>/etc/pki/ca_test/root/ca.key<span class="w"> </span>-out<span class="w"> </span>/etc/pki/ca_test/root/ca.csr<span class="w">   </span>
<a id="__codelineno-120-25" name="__codelineno-120-25"></a><span class="c1">#生成请求文件，会让我们填写一些指标,这里要注意：如果在这一步填写了相应的指标，</span>
<a id="__codelineno-120-26" name="__codelineno-120-26"></a><span class="c1">#比如Country Name、State or Province Name、hostname。</span>
<a id="__codelineno-120-27" name="__codelineno-120-27"></a>Country<span class="w"> </span>Name<span class="w"> </span><span class="o">(</span><span class="m">2</span><span class="w"> </span>letter<span class="w"> </span>code<span class="o">)</span><span class="w"> </span><span class="o">[</span>XX<span class="o">]</span>:
<a id="__codelineno-120-28" name="__codelineno-120-28"></a>State<span class="w"> </span>or<span class="w"> </span>Province<span class="w"> </span>Name<span class="w"> </span><span class="o">(</span>full<span class="w"> </span>name<span class="o">)</span><span class="w"> </span><span class="o">[]</span>:bj
<a id="__codelineno-120-29" name="__codelineno-120-29"></a>Locality<span class="w"> </span>Name<span class="w"> </span><span class="o">(</span>eg,<span class="w"> </span>city<span class="o">)</span><span class="w"> </span><span class="o">[</span>Default<span class="w"> </span>City<span class="o">]</span>:bj
<a id="__codelineno-120-30" name="__codelineno-120-30"></a>Organization<span class="w"> </span>Name<span class="w"> </span><span class="o">(</span>eg,<span class="w"> </span>company<span class="o">)</span><span class="w"> </span><span class="o">[</span>Default<span class="w"> </span>Company<span class="w"> </span>Ltd<span class="o">]</span>:kehua
<a id="__codelineno-120-31" name="__codelineno-120-31"></a>Organizational<span class="w"> </span>Unit<span class="w"> </span>Name<span class="w"> </span><span class="o">(</span>eg,<span class="w"> </span>section<span class="o">)</span><span class="w"> </span><span class="o">[]</span>:test
<a id="__codelineno-120-32" name="__codelineno-120-32"></a>Common<span class="w"> </span>Name<span class="w"> </span><span class="o">(</span>eg,<span class="w"> </span>your<span class="w"> </span>name<span class="w"> </span>or<span class="w"> </span>your<span class="w"> </span>server<span class="s1">&#39;s hostname) []:www.1.com</span>
<a id="__codelineno-120-33" name="__codelineno-120-33"></a><span class="s1">Email Address []:liyedong@kehua.com</span>
<a id="__codelineno-120-34" name="__codelineno-120-34"></a><span class="s1">Please enter the following &#39;</span>extra<span class="err">&#39;</span><span class="w"> </span>attributes
<a id="__codelineno-120-35" name="__codelineno-120-35"></a>to<span class="w"> </span>be<span class="w"> </span>sent<span class="w"> </span>with<span class="w"> </span>your<span class="w"> </span>certificate<span class="w"> </span>request
<a id="__codelineno-120-36" name="__codelineno-120-36"></a>A<span class="w"> </span>challenge<span class="w"> </span>password<span class="w"> </span><span class="o">[]</span>:123456
<a id="__codelineno-120-37" name="__codelineno-120-37"></a>An<span class="w"> </span>optional<span class="w"> </span>company<span class="w"> </span>name<span class="w"> </span><span class="o">[]</span>:kehua
<a id="__codelineno-120-38" name="__codelineno-120-38"></a>
<a id="__codelineno-120-39" name="__codelineno-120-39"></a>openssl<span class="w"> </span>x509<span class="w"> </span>-req<span class="w"> </span>-days<span class="w"> </span><span class="m">3650</span><span class="w"> </span>-in<span class="w"> </span>/etc/pki/ca_test/root/ca.csr<span class="w"> </span>-signkey<span class="w"> </span>/etc/pki/ca_test/root/ca.key<span class="w"> </span>-out<span class="w"> </span>/etc/pki/ca_test/root/ca.crt<span class="w"> </span>
<a id="__codelineno-120-40" name="__codelineno-120-40"></a><span class="c1">#生成crt文件</span>
</code></pre></div></td></tr></table></div>
<h3 id="生成server端证书">生成server端证书<a class="headerlink" href="#生成server端证书" title="Permanent link">&para;</a></h3>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-121-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-121-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-121-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-121-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-121-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-121-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-121-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-121-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-121-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-121-10">10</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-121-1" name="__codelineno-121-1"></a><span class="nb">cd</span><span class="w"> </span>/etc/pki/ca_test/server
<a id="__codelineno-121-2" name="__codelineno-121-2"></a>
<a id="__codelineno-121-3" name="__codelineno-121-3"></a>openssl<span class="w"> </span>genrsa<span class="w"> </span>-out<span class="w"> </span>server.key<span class="w">   </span><span class="c1">#生成私钥文件</span>
<a id="__codelineno-121-4" name="__codelineno-121-4"></a>
<a id="__codelineno-121-5" name="__codelineno-121-5"></a>openssl<span class="w"> </span>req<span class="w"> </span>-new<span class="w"> </span>-key<span class="w"> </span>server.key<span class="w"> </span>-out<span class="w"> </span>server.csr#生成证书请求文件，填写信息需要和ca.csr中的Organization<span class="w"> </span>Name保持一致
<a id="__codelineno-121-6" name="__codelineno-121-6"></a>
<a id="__codelineno-121-7" name="__codelineno-121-7"></a>openssl<span class="w"> </span>ca<span class="w"> </span>-in<span class="w"> </span>server.csr<span class="w"> </span>-cert<span class="w"> </span>/etc/pki/ca_test/root/ca.crt<span class="w"> </span>-keyfile<span class="w"> </span>/etc/pki/ca_test/root/ca.key<span class="w"> </span>-out<span class="w"> </span>server.crt<span class="w"> </span>-days<span class="w"> </span><span class="m">3650</span><span class="w">  </span>
<a id="__codelineno-121-8" name="__codelineno-121-8"></a><span class="c1">#用根证书签名server.csr，最后生成公钥文件server.crt，此步骤会有两个地方需要输入y</span>
<a id="__codelineno-121-9" name="__codelineno-121-9"></a>Sign<span class="w"> </span>the<span class="w"> </span>certificate?<span class="w"> </span><span class="o">[</span>y/n<span class="o">]</span>:y
<a id="__codelineno-121-10" name="__codelineno-121-10"></a><span class="m">1</span><span class="w"> </span>out<span class="w"> </span>of<span class="w"> </span><span class="m">1</span><span class="w"> </span>certificate<span class="w"> </span>requests<span class="w"> </span>certified,<span class="w"> </span>commit?<span class="w"> </span><span class="o">[</span>y/n<span class="o">]</span>y
</code></pre></div></td></tr></table></div>
<h3 id="生成客户端证书">生成客户端证书<a class="headerlink" href="#生成客户端证书" title="Permanent link">&para;</a></h3>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-122-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-122-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-122-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-122-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-122-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-122-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-122-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-122-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-122-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-122-10">10</a></span>
<span class="normal"><a href="#__codelineno-122-11">11</a></span>
<span class="normal"><a href="#__codelineno-122-12">12</a></span>
<span class="normal"><a href="#__codelineno-122-13">13</a></span>
<span class="normal"><a href="#__codelineno-122-14">14</a></span>
<span class="normal"><a href="#__codelineno-122-15">15</a></span>
<span class="normal"><a href="#__codelineno-122-16">16</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-122-1" name="__codelineno-122-1"></a><span class="c1">#如果做ssl的双向认证，还需要给客户端生成一个证书，步骤和上面的基本一致</span>
<a id="__codelineno-122-2" name="__codelineno-122-2"></a><span class="nb">cd</span><span class="w"> </span>/etc/pki/ca_test/client
<a id="__codelineno-122-3" name="__codelineno-122-3"></a>
<a id="__codelineno-122-4" name="__codelineno-122-4"></a>openssl<span class="w"> </span>genrsa<span class="w"> </span>-out<span class="w">  </span>client.key<span class="w">  </span><span class="c1">#生成私钥文件</span>
<a id="__codelineno-122-5" name="__codelineno-122-5"></a>
<a id="__codelineno-122-6" name="__codelineno-122-6"></a>openssl<span class="w"> </span>req<span class="w"> </span>-new<span class="w">  </span>-key<span class="w"> </span>client.key<span class="w"> </span>-out<span class="w"> </span>client.csr<span class="w">  </span><span class="c1">#生成请求文件，填写信息需要和ca.csr中的Organization Name保持一致</span>
<a id="__codelineno-122-7" name="__codelineno-122-7"></a>
<a id="__codelineno-122-8" name="__codelineno-122-8"></a>openssl<span class="w"> </span>ca<span class="w"> </span>-in<span class="w"> </span>client.csr<span class="w"> </span>-cert<span class="w"> </span>/etc/pki/ca_test/root/ca.crt<span class="w"> </span>-keyfile<span class="w"> </span>/etc/pki/ca_test/root/ca.key<span class="w"> </span>-out<span class="w"> </span>client.crt<span class="w"> </span>-days<span class="w"> </span><span class="m">3650</span><span class="w"> </span>
<a id="__codelineno-122-9" name="__codelineno-122-9"></a><span class="c1">#签名client.csr, 生成client.crt，此步如果出现</span>
<a id="__codelineno-122-10" name="__codelineno-122-10"></a>failed<span class="w"> </span>to<span class="w"> </span>update<span class="w"> </span>database
<a id="__codelineno-122-11" name="__codelineno-122-11"></a>TXT_DB<span class="w"> </span>error<span class="w"> </span>number<span class="w"> </span><span class="m">2</span>
<a id="__codelineno-122-12" name="__codelineno-122-12"></a>
<a id="__codelineno-122-13" name="__codelineno-122-13"></a>需执行：
<a id="__codelineno-122-14" name="__codelineno-122-14"></a>sed<span class="w"> </span>-i<span class="w"> </span><span class="s1">&#39;s/unique_subject = yes/unique_subject = no/&#39;</span><span class="w"> </span>/etc/pki/ca_test/index.txt.attr
<a id="__codelineno-122-15" name="__codelineno-122-15"></a>
<a id="__codelineno-122-16" name="__codelineno-122-16"></a><span class="c1">#执行完，再次重复执行签名client.csr那个操作</span>
</code></pre></div></td></tr></table></div>
<h2 id="21nginx配置ssl">21.Nginx配置SSL<a class="headerlink" href="#21nginx配置ssl" title="Permanent link">&para;</a></h2>
<h3 id="nginx配置示例单向">Nginx配置示例（单向）<a class="headerlink" href="#nginx配置示例单向" title="Permanent link">&para;</a></h3>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-123-1">1</a></span>
<span class="normal"><a href="#__codelineno-123-2">2</a></span>
<span class="normal"><a href="#__codelineno-123-3">3</a></span>
<span class="normal"><a href="#__codelineno-123-4">4</a></span>
<span class="normal"><a href="#__codelineno-123-5">5</a></span>
<span class="normal"><a href="#__codelineno-123-6">6</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-123-1" name="__codelineno-123-1"></a>./configure<span class="w"> </span>--prefix<span class="o">=</span>/usr/local/nginx<span class="w"> </span>--with-http_ssl_module<span class="w"> </span>
<a id="__codelineno-123-2" name="__codelineno-123-2"></a><span class="c1">#出现错误</span>
<a id="__codelineno-123-3" name="__codelineno-123-3"></a><span class="c1">#安装</span>
<a id="__codelineno-123-4" name="__codelineno-123-4"></a>yum<span class="w"> </span>-y<span class="w"> </span>install<span class="w"> </span>openssl<span class="w"> </span>openssl-devel
<a id="__codelineno-123-5" name="__codelineno-123-5"></a>./configure<span class="w"> </span>--prefix<span class="o">=</span>/usr/local/nginx<span class="w"> </span>--with-http_ssl_module<span class="w"> </span>
<a id="__codelineno-123-6" name="__codelineno-123-6"></a>make<span class="w"> </span>install
</code></pre></div></td></tr></table></div>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Nginx Configuration File</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-124-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-124-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-124-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-124-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-124-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-124-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-124-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-124-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-124-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-124-10">10</a></span>
<span class="normal"><a href="#__codelineno-124-11">11</a></span>
<span class="normal"><a href="#__codelineno-124-12">12</a></span>
<span class="normal"><a href="#__codelineno-124-13">13</a></span>
<span class="normal"><a href="#__codelineno-124-14">14</a></span>
<span class="normal"><a href="#__codelineno-124-15">15</a></span>
<span class="normal"><a href="#__codelineno-124-16">16</a></span>
<span class="normal"><a href="#__codelineno-124-17">17</a></span>
<span class="normal"><a href="#__codelineno-124-18">18</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-124-1" name="__codelineno-124-1"></a><span class="k">cp</span><span class="w"> </span><span class="s">/etc/pki/ca_test/server/server.*</span><span class="w"> </span><span class="s">/usr/local/nginx/conf/</span>
<a id="__codelineno-124-2" name="__codelineno-124-2"></a><span class="s">server</span><span class="p">{</span>
<a id="__codelineno-124-3" name="__codelineno-124-3"></a><span class="w">    </span><span class="kn">listen</span><span class="w"> </span><span class="mi">443</span><span class="w"> </span><span class="s">ssl</span><span class="p">;</span>
<a id="__codelineno-124-4" name="__codelineno-124-4"></a><span class="w">    </span><span class="kn">server_name</span><span class="w"> </span><span class="s">www.1.com</span><span class="p">;</span>
<a id="__codelineno-124-5" name="__codelineno-124-5"></a><span class="w">    </span><span class="kn">root</span><span class="w"> </span><span class="s">/data/wwwroot/www.1.com</span><span class="p">;</span>
<a id="__codelineno-124-6" name="__codelineno-124-6"></a><span class="w">    </span><span class="kn">index</span><span class="w"> </span><span class="s">index.html</span><span class="w"> </span><span class="s">index.htm</span><span class="p">;</span>
<a id="__codelineno-124-7" name="__codelineno-124-7"></a><span class="w">    </span><span class="kn">access_log</span><span class="w"> </span><span class="s">/tmp/log</span><span class="p">;</span>
<a id="__codelineno-124-8" name="__codelineno-124-8"></a><span class="w">    </span><span class="kn">ssl_certificate</span><span class="w"> </span><span class="s">server.crt</span><span class="p">;</span>
<a id="__codelineno-124-9" name="__codelineno-124-9"></a><span class="w">    </span><span class="kn">ssl_certificate_key</span><span class="w"> </span><span class="s">server.key</span><span class="p">;</span>
<a id="__codelineno-124-10" name="__codelineno-124-10"></a><span class="w">    </span><span class="kn">ssl_protocols</span><span class="w"> </span><span class="s">TLSv1</span><span class="w"> </span><span class="s">TLSv1.1</span><span class="w"> </span><span class="s">TLSv1.2</span><span class="p">;</span>
<a id="__codelineno-124-11" name="__codelineno-124-11"></a><span class="w">    </span><span class="kn">ssl_ciphers</span><span class="w"> </span><span class="s">ALL:!DH:!EXPORT:!RC4:+HIGH:+MEDIUM:!eNULL</span><span class="p">;</span>
<a id="__codelineno-124-12" name="__codelineno-124-12"></a><span class="w">    </span><span class="kn">ssl_prefer_server_ciphers</span><span class="w"> </span><span class="no">on</span><span class="p">;</span>
<a id="__codelineno-124-13" name="__codelineno-124-13"></a><span class="w">    </span><span class="kn">location</span><span class="w"> </span><span class="s">/admin/</span>
<a id="__codelineno-124-14" name="__codelineno-124-14"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-124-15" name="__codelineno-124-15"></a><span class="w">        </span><span class="kn">auth_basic</span><span class="w"> </span><span class="s">&quot;Auth&quot;</span><span class="p">;</span>
<a id="__codelineno-124-16" name="__codelineno-124-16"></a><span class="w">        </span><span class="kn">auth_basic_user_file</span><span class="w"> </span><span class="s">/usr/local/nginx/conf/htpasswd</span><span class="p">;</span>
<a id="__codelineno-124-17" name="__codelineno-124-17"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-124-18" name="__codelineno-124-18"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p><img alt="image-20230822203334507" src="../Nginx%E5%AD%A6%E4%B9%A0.assets/image-20230822203334507.png" /></p>
<h4 id="配置说明_1">配置说明<a class="headerlink" href="#配置说明_1" title="Permanent link">&para;</a></h4>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Text Only</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-125-1">1</a></span>
<span class="normal"><a href="#__codelineno-125-2">2</a></span>
<span class="normal"><a href="#__codelineno-125-3">3</a></span>
<span class="normal"><a href="#__codelineno-125-4">4</a></span>
<span class="normal"><a href="#__codelineno-125-5">5</a></span>
<span class="normal"><a href="#__codelineno-125-6">6</a></span>
<span class="normal"><a href="#__codelineno-125-7">7</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-125-1" name="__codelineno-125-1"></a>1. 443端口为ssl监听端口。
<a id="__codelineno-125-2" name="__codelineno-125-2"></a>2. ssl on表示打开ssl支持。
<a id="__codelineno-125-3" name="__codelineno-125-3"></a>3. ssl_certificate指定crt文件所在路径，如果写相对路径，必须把该文件和nginx.conf文件放到一个目录下。
<a id="__codelineno-125-4" name="__codelineno-125-4"></a>4. ssl_certificate_key指定key文件所在路径。
<a id="__codelineno-125-5" name="__codelineno-125-5"></a>5. ssl_protocols指定SSL协议。
<a id="__codelineno-125-6" name="__codelineno-125-6"></a>6. ssl_ciphers配置ssl加密算法，多个算法用:分隔，ALL表示全部算法，!表示不启用该算法，+表示将该算法排到最后面去。
<a id="__codelineno-125-7" name="__codelineno-125-7"></a>7. ssl_prefer_server_ciphers 如果不指定默认为off，当为on时，在使用SSLv3和TLS协议时，服务器加密算法将优于客户端加密算法。
</code></pre></div></td></tr></table></div>
<h3 id="nginx配置双向认证">Nginx配置双向认证<a class="headerlink" href="#nginx配置双向认证" title="Permanent link">&para;</a></h3>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Nginx Configuration File</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-126-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-126-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-126-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-126-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-126-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-126-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-126-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-126-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-126-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-126-10">10</a></span>
<span class="normal"><a href="#__codelineno-126-11">11</a></span>
<span class="normal"><a href="#__codelineno-126-12">12</a></span>
<span class="normal"><a href="#__codelineno-126-13">13</a></span>
<span class="normal"><a href="#__codelineno-126-14">14</a></span>
<span class="normal"><a href="#__codelineno-126-15">15</a></span>
<span class="normal"><a href="#__codelineno-126-16">16</a></span>
<span class="normal"><a href="#__codelineno-126-17">17</a></span>
<span class="normal"><a href="#__codelineno-126-18">18</a></span>
<span class="normal"><a href="#__codelineno-126-19">19</a></span>
<span class="normal"><a href="#__codelineno-126-20">20</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-126-1" name="__codelineno-126-1"></a><span class="k">cp</span><span class="w"> </span><span class="s">/etc/pki/ca_test/root/ca.crt</span><span class="w"> </span><span class="s">/usr/local/nginx/conf/</span>
<a id="__codelineno-126-2" name="__codelineno-126-2"></a><span class="s">配置示例：</span>
<a id="__codelineno-126-3" name="__codelineno-126-3"></a><span class="s">server</span><span class="p">{</span>
<a id="__codelineno-126-4" name="__codelineno-126-4"></a><span class="w">    </span><span class="kn">listen</span><span class="w"> </span><span class="mi">443</span><span class="w"> </span><span class="s">ssl</span><span class="p">;</span>
<a id="__codelineno-126-5" name="__codelineno-126-5"></a><span class="w">    </span><span class="kn">server_name</span><span class="w"> </span><span class="s">www.1.com</span><span class="p">;</span>
<a id="__codelineno-126-6" name="__codelineno-126-6"></a><span class="w">    </span><span class="kn">root</span><span class="w"> </span><span class="s">/data/wwwroot/www.1.com</span><span class="p">;</span>
<a id="__codelineno-126-7" name="__codelineno-126-7"></a><span class="w">    </span><span class="kn">index</span><span class="w"> </span><span class="s">index.html</span><span class="w"> </span><span class="s">index.htm</span><span class="p">;</span>
<a id="__codelineno-126-8" name="__codelineno-126-8"></a><span class="w">    </span><span class="kn">ssl_certificate</span><span class="w"> </span><span class="s">server.crt</span><span class="p">;</span>
<a id="__codelineno-126-9" name="__codelineno-126-9"></a><span class="w">    </span><span class="kn">ssl_certificate_key</span><span class="w"> </span><span class="s">server.key</span><span class="p">;</span>
<a id="__codelineno-126-10" name="__codelineno-126-10"></a><span class="w">    </span><span class="kn">ssl_protocols</span><span class="w"> </span><span class="s">TLSv1</span><span class="w"> </span><span class="s">TLSv1.1</span><span class="w"> </span><span class="s">TLSv1.2</span><span class="p">;</span>
<a id="__codelineno-126-11" name="__codelineno-126-11"></a><span class="w">    </span><span class="kn">ssl_ciphers</span><span class="w"> </span><span class="s">ALL:!DH:!EXPORT:!RC4:+HIGH:+MEDIUM:!eNULL</span><span class="p">;</span>
<a id="__codelineno-126-12" name="__codelineno-126-12"></a><span class="w">    </span><span class="kn">ssl_prefer_server_ciphers</span><span class="w"> </span><span class="no">on</span><span class="p">;</span>
<a id="__codelineno-126-13" name="__codelineno-126-13"></a><span class="w">    </span><span class="kn">ssl_client_certificate</span><span class="w"> </span><span class="s">ca.crt</span><span class="p">;</span>
<a id="__codelineno-126-14" name="__codelineno-126-14"></a><span class="w">    </span><span class="kn">ssl_verify_client</span><span class="w"> </span><span class="no">on</span><span class="p">;</span>
<a id="__codelineno-126-15" name="__codelineno-126-15"></a><span class="w">    </span><span class="kn">location</span><span class="w"> </span><span class="s">/admin/</span>
<a id="__codelineno-126-16" name="__codelineno-126-16"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-126-17" name="__codelineno-126-17"></a><span class="w">        </span><span class="kn">auth_basic</span><span class="w"> </span><span class="s">&quot;Auth&quot;</span><span class="p">;</span>
<a id="__codelineno-126-18" name="__codelineno-126-18"></a><span class="w">        </span><span class="kn">auth_basic_user_file</span><span class="w"> </span><span class="s">/usr/local/nginx/conf/htpasswd</span><span class="p">;</span>
<a id="__codelineno-126-19" name="__codelineno-126-19"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-126-20" name="__codelineno-126-20"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p><img alt="image-20230822203657571" src="../Nginx%E5%AD%A6%E4%B9%A0.assets/image-20230822203657571.png" /></p>
<h4 id="客户端浏览器操作">客户端（浏览器）操作<a class="headerlink" href="#客户端浏览器操作" title="Permanent link">&para;</a></h4>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Nginx Configuration File</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-127-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-127-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-127-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-127-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-127-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-127-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-127-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-127-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-127-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-127-10">10</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-127-1" name="__codelineno-127-1"></a><span class="k">如果不进行以下操作，浏览器会出现400错误。400</span><span class="w"> </span><span class="s">Bad</span><span class="w"> </span><span class="s">Request（No</span><span class="w"> </span><span class="s">required</span><span class="w"> </span><span class="s">SSL</span><span class="w"> </span><span class="s">certificate</span><span class="w"> </span><span class="s">was</span><span class="w"> </span><span class="s">sent）</span>
<a id="__codelineno-127-2" name="__codelineno-127-2"></a><span class="s">首先需要将client.key转换为pfx(p12)格式</span>
<a id="__codelineno-127-3" name="__codelineno-127-3"></a>
<a id="__codelineno-127-4" name="__codelineno-127-4"></a><span class="s">cd</span><span class="w"> </span><span class="s">/etc/pki/ca_test/client</span>
<a id="__codelineno-127-5" name="__codelineno-127-5"></a><span class="s">openssl</span><span class="w"> </span><span class="s">pkcs12</span><span class="w"> </span><span class="s">-export</span><span class="w"> </span><span class="s">-inkey</span><span class="w"> </span><span class="s">client.key</span><span class="w"> </span><span class="s">-in</span><span class="w"> </span><span class="s">client.crt</span><span class="w"> </span><span class="s">-out</span><span class="w"> </span><span class="s">client.pfx</span><span class="w"> </span>
<a id="__codelineno-127-6" name="__codelineno-127-6"></a><span class="mi">123456</span>
<a id="__codelineno-127-7" name="__codelineno-127-7"></a><span class="c1">#这一步需要输入一个自定义密码，一会在windows上安装的时候要用到，需要记一下。</span>
<a id="__codelineno-127-8" name="__codelineno-127-8"></a>
<a id="__codelineno-127-9" name="__codelineno-127-9"></a><span class="s">然后将client.pfx拷贝到windows下，双击即可安装。</span>
<a id="__codelineno-127-10" name="__codelineno-127-10"></a><span class="s">在chrome浏览器中可以查看到该证书</span>
</code></pre></div></td></tr></table></div>
<p><img alt="image-20230822204429166" src="../Nginx%E5%AD%A6%E4%B9%A0.assets/image-20230822204429166.png" /></p>
<p><img alt="image-20230822204257603" src="../Nginx%E5%AD%A6%E4%B9%A0.assets/image-20230822204257603.png" /></p>
<h2 id="22nginx的错误日志">22.Nginx的错误日志<a class="headerlink" href="#22nginx的错误日志" title="Permanent link">&para;</a></h2>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Text Only</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-128-1">1</a></span>
<span class="normal"><a href="#__codelineno-128-2">2</a></span>
<span class="normal"><a href="#__codelineno-128-3">3</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-128-1" name="__codelineno-128-1"></a>Nginx错误日志平时不用太关注，但是一旦出了问题，就需要借助错误日志来判断问题所在。
<a id="__codelineno-128-2" name="__codelineno-128-2"></a>
<a id="__codelineno-128-3" name="__codelineno-128-3"></a>配置参数格式：error_log /path/to/log level;
</code></pre></div></td></tr></table></div>
<h3 id="nginx错误日志级别">Nginx错误日志级别<a class="headerlink" href="#nginx错误日志级别" title="Permanent link">&para;</a></h3>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Text Only</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-129-1">1</a></span>
<span class="normal"><a href="#__codelineno-129-2">2</a></span>
<span class="normal"><a href="#__codelineno-129-3">3</a></span>
<span class="normal"><a href="#__codelineno-129-4">4</a></span>
<span class="normal"><a href="#__codelineno-129-5">5</a></span>
<span class="normal"><a href="#__codelineno-129-6">6</a></span>
<span class="normal"><a href="#__codelineno-129-7">7</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-129-1" name="__codelineno-129-1"></a>常见的错误日志级别有debug | info | notice | warn | error | crit | alert | emerg
<a id="__codelineno-129-2" name="__codelineno-129-2"></a>级别越高记录的信息越少，如果不定义，默认级别为error.
<a id="__codelineno-129-3" name="__codelineno-129-3"></a>
<a id="__codelineno-129-4" name="__codelineno-129-4"></a>它可以配置在main、http、server、location段里。
<a id="__codelineno-129-5" name="__codelineno-129-5"></a>
<a id="__codelineno-129-6" name="__codelineno-129-6"></a>如果在配置文件中定义了两个error_log，在同一个配置段里的话会产生冲突，所以同一个段里只允许配置一个error_log。
<a id="__codelineno-129-7" name="__codelineno-129-7"></a>但是，在不同的配置段中出现是没问题的。
</code></pre></div></td></tr></table></div>
<h3 id="nginx错误日志示例">Nginx错误日志示例<a class="headerlink" href="#nginx错误日志示例" title="Permanent link">&para;</a></h3>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Nginx Configuration File</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-130-1">1</a></span>
<span class="normal"><a href="#__codelineno-130-2">2</a></span>
<span class="normal"><a href="#__codelineno-130-3">3</a></span>
<span class="normal"><a href="#__codelineno-130-4">4</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-130-1" name="__codelineno-130-1"></a><span class="k">error_log</span><span class="w">  </span><span class="s">/var/log/nginx/error.log</span><span class="w"> </span><span class="s">crit</span><span class="p">;</span>
<a id="__codelineno-130-2" name="__codelineno-130-2"></a><span class="k">最好每一个server配置一个错误日志文件</span><span class="w"> </span><span class="s">可以方便定位错误，当server段的错误日志配置后，发生错误时就不会再向这个错误日志文件写入日志/usr/local/nginx/logs/error.log</span>
<a id="__codelineno-130-3" name="__codelineno-130-3"></a><span class="s">如果要想彻底关闭error_log，需要这样配置</span>
<a id="__codelineno-130-4" name="__codelineno-130-4"></a><span class="s">error_log</span><span class="w"> </span><span class="s">/dev/null</span><span class="p">;</span>
</code></pre></div></td></tr></table></div>
<h2 id="23nginx访问日志配置">23.Nginx访问日志配置<a class="headerlink" href="#23nginx访问日志配置" title="Permanent link">&para;</a></h2>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Nginx Configuration File</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-131-1">1</a></span>
<span class="normal"><a href="#__codelineno-131-2">2</a></span>
<span class="normal"><a href="#__codelineno-131-3">3</a></span>
<span class="normal"><a href="#__codelineno-131-4">4</a></span>
<span class="normal"><a href="#__codelineno-131-5">5</a></span>
<span class="normal"><a href="#__codelineno-131-6">6</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-131-1" name="__codelineno-131-1"></a><span class="k">web服务器的访问日志是非常重要的，我们可以通过访问日志来分析用户的访问情况，</span>
<a id="__codelineno-131-2" name="__codelineno-131-2"></a><span class="s">也可以通过访问日志发现一些异常访问，比如cc攻击。</span>
<a id="__codelineno-131-3" name="__codelineno-131-3"></a>
<a id="__codelineno-131-4" name="__codelineno-131-4"></a><span class="s">格式：</span><span class="w"> </span><span class="s">access_log</span><span class="w"> </span><span class="s">/path/to/logfile</span><span class="w"> </span><span class="s">format</span><span class="p">;</span>
<a id="__codelineno-131-5" name="__codelineno-131-5"></a>
<a id="__codelineno-131-6" name="__codelineno-131-6"></a><span class="k">access_log可以配置到http,</span><span class="w"> </span><span class="s">server,</span><span class="w"> </span><span class="s">location配置段中。</span>
</code></pre></div></td></tr></table></div>
<h3 id="配置示例">配置示例<a class="headerlink" href="#配置示例" title="Permanent link">&para;</a></h3>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Nginx Configuration File</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-132-1">1</a></span>
<span class="normal"><a href="#__codelineno-132-2">2</a></span>
<span class="normal"><a href="#__codelineno-132-3">3</a></span>
<span class="normal"><a href="#__codelineno-132-4">4</a></span>
<span class="normal"><a href="#__codelineno-132-5">5</a></span>
<span class="normal"><a href="#__codelineno-132-6">6</a></span>
<span class="normal"><a href="#__codelineno-132-7">7</a></span>
<span class="normal"><a href="#__codelineno-132-8">8</a></span>
<span class="normal"><a href="#__codelineno-132-9">9</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-132-1" name="__codelineno-132-1"></a><span class="k">server</span><span class="w"> </span>
<a id="__codelineno-132-2" name="__codelineno-132-2"></a><span class="p">{</span>
<a id="__codelineno-132-3" name="__codelineno-132-3"></a><span class="w">    </span><span class="kn">listen</span><span class="w"> </span><span class="mi">80</span><span class="p">;</span>
<a id="__codelineno-132-4" name="__codelineno-132-4"></a><span class="w">    </span><span class="kn">server_name</span><span class="w"> </span><span class="s">www.aminglinux.com</span><span class="p">;</span>
<a id="__codelineno-132-5" name="__codelineno-132-5"></a><span class="w">    </span><span class="kn">root</span><span class="w"> </span><span class="s">/data/wwwroot/www.aminglinux.com</span><span class="p">;</span>
<a id="__codelineno-132-6" name="__codelineno-132-6"></a><span class="w">    </span><span class="kn">index</span><span class="w"> </span><span class="s">index.html</span><span class="w"> </span><span class="s">index.php</span><span class="p">;</span>
<a id="__codelineno-132-7" name="__codelineno-132-7"></a><span class="w">    </span><span class="kn">access_log</span><span class="w"> </span><span class="s">/data/logs/www.aminglinux.com_access.log</span><span class="p">;</span>
<a id="__codelineno-132-8" name="__codelineno-132-8"></a><span class="p">}</span>
<a id="__codelineno-132-9" name="__codelineno-132-9"></a><span class="k">说明：若不指定log_format，则按照默认的格式写日志。</span>
</code></pre></div></td></tr></table></div>
<h2 id="24nginx访问日志格式">24.Nginx访问日志格式<a class="headerlink" href="#24nginx访问日志格式" title="Permanent link">&para;</a></h2>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Text Only</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-133-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-133-1" name="__codelineno-133-1"></a>Nginx访问日志可以设置自定义的格式，来满足特定的需求。
</code></pre></div></td></tr></table></div>
<h3 id="访问日志格式示例">访问日志格式示例<a class="headerlink" href="#访问日志格式示例" title="Permanent link">&para;</a></h3>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Nginx Configuration File</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-134-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-134-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-134-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-134-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-134-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-134-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-134-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-134-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-134-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-134-10">10</a></span>
<span class="normal"><a href="#__codelineno-134-11">11</a></span>
<span class="normal"><a href="#__codelineno-134-12">12</a></span>
<span class="normal"><a href="#__codelineno-134-13">13</a></span>
<span class="normal"><a href="#__codelineno-134-14">14</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-134-1" name="__codelineno-134-1"></a><span class="k">示例1</span>
<a id="__codelineno-134-2" name="__codelineno-134-2"></a><span class="w">    </span><span class="s">log_format</span><span class="w"> </span><span class="s">combined_realip</span><span class="w"> </span><span class="s">&#39;</span><span class="nv">$remote_addr</span><span class="w"> </span><span class="nv">$http_x_forwarded_for</span><span class="w"> </span><span class="s">[</span><span class="nv">$time_local]&#39;</span>
<a id="__codelineno-134-3" name="__codelineno-134-3"></a><span class="w">    </span><span class="s">&#39;</span><span class="nv">$host</span><span class="w"> </span><span class="s">&quot;</span><span class="nv">$request_uri&quot;</span><span class="w"> </span><span class="nv">$status&#39;</span>
<a id="__codelineno-134-4" name="__codelineno-134-4"></a><span class="w">    </span><span class="s">&#39;&quot;</span><span class="nv">$http_referer&quot;</span><span class="w"> </span><span class="s">&quot;</span><span class="nv">$http_user_agent&quot;&#39;</span><span class="p">;</span>
<a id="__codelineno-134-5" name="__codelineno-134-5"></a>
<a id="__codelineno-134-6" name="__codelineno-134-6"></a><span class="k">示例2</span>
<a id="__codelineno-134-7" name="__codelineno-134-7"></a><span class="w">    </span><span class="s">log_format</span><span class="w"> </span><span class="s">main</span><span class="w"> </span><span class="s">&#39;</span><span class="nv">$remote_addr</span><span class="w"> </span><span class="s">[</span><span class="nv">$time_local]</span><span class="w"> </span><span class="s">&#39;</span>
<a id="__codelineno-134-8" name="__codelineno-134-8"></a><span class="w">    </span><span class="s">&#39;</span><span class="nv">$host</span><span class="w"> </span><span class="s">&quot;</span><span class="nv">$request_uri&quot;</span><span class="w"> </span><span class="nv">$status</span><span class="w"> </span><span class="s">&quot;</span><span class="nv">$request&quot;&#39;</span>
<a id="__codelineno-134-9" name="__codelineno-134-9"></a><span class="w">    </span><span class="s">&#39;&quot;</span><span class="nv">$http_referer&quot;</span><span class="w"> </span><span class="s">&quot;</span><span class="nv">$http_user_agent&quot;</span><span class="w"> </span><span class="s">&quot;</span><span class="nv">$request_time&quot;&#39;</span><span class="p">;</span>
<a id="__codelineno-134-10" name="__codelineno-134-10"></a>
<a id="__codelineno-134-11" name="__codelineno-134-11"></a><span class="k">若不配置log_format或者不在access_log配置中指定log_format，则默认格式为：</span>
<a id="__codelineno-134-12" name="__codelineno-134-12"></a><span class="w">    </span><span class="s">&#39;</span><span class="nv">$remote_addr</span><span class="w"> </span><span class="s">-</span><span class="w"> </span><span class="nv">$remote_user</span><span class="w"> </span><span class="s">[</span><span class="nv">$time_local]</span><span class="w"> </span><span class="s">&quot;</span><span class="nv">$request&quot;</span><span class="w"> </span><span class="s">&#39;</span>
<a id="__codelineno-134-13" name="__codelineno-134-13"></a><span class="w">    </span><span class="s">&#39;</span><span class="nv">$status</span><span class="w"> </span><span class="nv">$body_bytes_sent</span><span class="w"> </span><span class="s">&quot;</span><span class="nv">$http_referer&quot;</span><span class="w"> </span><span class="s">&#39;</span>
<a id="__codelineno-134-14" name="__codelineno-134-14"></a><span class="w">    </span><span class="s">&#39;&quot;</span><span class="nv">$http_user_agent&quot;</span><span class="p">;</span>
</code></pre></div></td></tr></table></div>
<h3 id="配置实例">配置实例<a class="headerlink" href="#配置实例" title="Permanent link">&para;</a></h3>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Nginx Configuration File</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-135-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-135-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-135-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-135-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-135-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-135-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-135-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-135-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-135-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-135-10">10</a></span>
<span class="normal"><a href="#__codelineno-135-11">11</a></span>
<span class="normal"><a href="#__codelineno-135-12">12</a></span>
<span class="normal"><a href="#__codelineno-135-13">13</a></span>
<span class="normal"><a href="#__codelineno-135-14">14</a></span>
<span class="normal"><a href="#__codelineno-135-15">15</a></span>
<span class="normal"><a href="#__codelineno-135-16">16</a></span>
<span class="normal"><a href="#__codelineno-135-17">17</a></span>
<span class="normal"><a href="#__codelineno-135-18">18</a></span>
<span class="normal"><a href="#__codelineno-135-19">19</a></span>
<span class="normal"><a href="#__codelineno-135-20">20</a></span>
<span class="normal"><a href="#__codelineno-135-21">21</a></span>
<span class="normal"><a href="#__codelineno-135-22">22</a></span>
<span class="normal"><a href="#__codelineno-135-23">23</a></span>
<span class="normal"><a href="#__codelineno-135-24">24</a></span>
<span class="normal"><a href="#__codelineno-135-25">25</a></span>
<span class="normal"><a href="#__codelineno-135-26">26</a></span>
<span class="normal"><a href="#__codelineno-135-27">27</a></span>
<span class="normal"><a href="#__codelineno-135-28">28</a></span>
<span class="normal"><a href="#__codelineno-135-29">29</a></span>
<span class="normal"><a href="#__codelineno-135-30">30</a></span>
<span class="normal"><a href="#__codelineno-135-31">31</a></span>
<span class="normal"><a href="#__codelineno-135-32">32</a></span>
<span class="normal"><a href="#__codelineno-135-33">33</a></span>
<span class="normal"><a href="#__codelineno-135-34">34</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-135-1" name="__codelineno-135-1"></a><span class="c1">#server端配置 A.conf</span>
<a id="__codelineno-135-2" name="__codelineno-135-2"></a><span class="k">log_format</span><span class="w"> </span><span class="s">combined_realip</span><span class="w"> </span><span class="s">&#39;</span><span class="nv">$remote_addr</span><span class="w"> </span><span class="nv">$http_x_forwarded_for</span><span class="w"> </span><span class="s">[</span><span class="nv">$time_local]&#39;</span>
<a id="__codelineno-135-3" name="__codelineno-135-3"></a><span class="w">    </span><span class="s">&#39;</span><span class="nv">$host</span><span class="w"> </span><span class="s">&quot;</span><span class="nv">$request_uri&quot;</span><span class="w"> </span><span class="nv">$status&#39;</span>
<a id="__codelineno-135-4" name="__codelineno-135-4"></a><span class="w">    </span><span class="s">&#39;&quot;</span><span class="nv">$http_referer&quot;</span><span class="w"> </span><span class="s">&quot;</span><span class="nv">$http_user_agent&quot;&#39;</span><span class="p">;</span><span class="c1">#定义了一个名为combined_realip的日志格式</span>
<a id="__codelineno-135-5" name="__codelineno-135-5"></a><span class="k">server{</span>
<a id="__codelineno-135-6" name="__codelineno-135-6"></a><span class="w">    </span><span class="s">listen</span><span class="w"> </span><span class="mi">99</span><span class="p">;</span>
<a id="__codelineno-135-7" name="__codelineno-135-7"></a><span class="w">    </span><span class="k">server_name</span><span class="w"> </span><span class="s">localhost</span><span class="p">;</span>
<a id="__codelineno-135-8" name="__codelineno-135-8"></a><span class="w">    </span><span class="k">root</span><span class="w"> </span><span class="s">/usr/local/nginx/html</span><span class="p">;</span>
<a id="__codelineno-135-9" name="__codelineno-135-9"></a><span class="w">    </span><span class="k">index</span><span class="w"> </span><span class="s">index.html</span><span class="w"> </span><span class="s">index.php</span><span class="p">;</span>
<a id="__codelineno-135-10" name="__codelineno-135-10"></a><span class="w">    </span><span class="k">access_log</span><span class="w"> </span><span class="s">/data/logs/localhost.log</span><span class="w"> </span><span class="s">combined_realip</span><span class="p">;</span>
<a id="__codelineno-135-11" name="__codelineno-135-11"></a><span class="k">}</span>
<a id="__codelineno-135-12" name="__codelineno-135-12"></a>
<a id="__codelineno-135-13" name="__codelineno-135-13"></a><span class="c1">#代理端配置 B.conf</span>
<a id="__codelineno-135-14" name="__codelineno-135-14"></a><span class="s">server</span>
<a id="__codelineno-135-15" name="__codelineno-135-15"></a><span class="p">{</span>
<a id="__codelineno-135-16" name="__codelineno-135-16"></a><span class="w">    </span><span class="kn">listen</span><span class="w"> </span><span class="mi">8080</span><span class="p">;</span>
<a id="__codelineno-135-17" name="__codelineno-135-17"></a><span class="w">    </span><span class="kn">server_name</span><span class="w"> </span><span class="s">localhost</span><span class="p">;</span>
<a id="__codelineno-135-18" name="__codelineno-135-18"></a><span class="w">    </span><span class="kn">location</span><span class="w"> </span><span class="s">/</span>
<a id="__codelineno-135-19" name="__codelineno-135-19"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-135-20" name="__codelineno-135-20"></a><span class="w">        </span><span class="kn">proxy_pass</span><span class="w"> </span><span class="s">http://192.168.107.254:99/</span><span class="p">;</span>
<a id="__codelineno-135-21" name="__codelineno-135-21"></a><span class="w">        </span><span class="kn">proxy_set_header</span><span class="w"> </span><span class="s">Host</span><span class="w">   </span><span class="nv">$host</span><span class="p">;</span>
<a id="__codelineno-135-22" name="__codelineno-135-22"></a><span class="w">        </span><span class="kn">proxy_set_header</span><span class="w"> </span><span class="s">X-Real-IP</span><span class="w">      </span><span class="nv">$remote_addr</span><span class="p">;</span>
<a id="__codelineno-135-23" name="__codelineno-135-23"></a><span class="w">        </span><span class="kn">proxy_set_header</span><span class="w"> </span><span class="s">X-Forwarded-For</span><span class="w"> </span><span class="nv">$proxy_add_x_forwarded_for</span><span class="p">;</span>
<a id="__codelineno-135-24" name="__codelineno-135-24"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-135-25" name="__codelineno-135-25"></a><span class="p">}</span>
<a id="__codelineno-135-26" name="__codelineno-135-26"></a>
<a id="__codelineno-135-27" name="__codelineno-135-27"></a>
<a id="__codelineno-135-28" name="__codelineno-135-28"></a><span class="k">tail</span><span class="w"> </span><span class="s">-f</span><span class="w"> </span><span class="s">/data/logs/localhost.log</span>
<a id="__codelineno-135-29" name="__codelineno-135-29"></a><span class="mi">192</span><span class="s">.168.107.254</span><span class="w"> </span><span class="mi">192</span><span class="s">.168.107.1</span><span class="w"> </span><span class="s">[23/Aug/2023:09:28:18</span><span class="w"> </span><span class="s">+0800]192.168.107.254</span><span class="w"> </span><span class="s">&quot;/&quot;</span><span class="w"> </span><span class="mi">200</span><span class="s">&quot;-&quot;</span><span class="w"> </span><span class="s">&quot;Mozilla/5.0</span><span class="w"> </span><span class="s">(Windows</span><span class="w"> </span><span class="s">NT</span><span class="w"> </span><span class="mi">10</span><span class="s">.0</span><span class="p">;</span><span class="w"> </span><span class="k">Win64</span><span class="p">;</span><span class="w"> </span><span class="k">x64)</span><span class="w"> </span><span class="s">AppleWebKit/537.36</span><span class="w"> </span><span class="s">(KHTML,</span><span class="w"> </span><span class="s">like</span><span class="w"> </span><span class="s">Gecko)</span><span class="w"> </span><span class="s">Chrome/116.0.0.0</span><span class="w"> </span><span class="s">Safari/537.36&quot;</span>
<a id="__codelineno-135-30" name="__codelineno-135-30"></a><span class="mi">192</span><span class="s">.168.107.254</span><span class="w"> </span><span class="mi">192</span><span class="s">.168.107.1</span><span class="w"> </span><span class="s">[23/Aug/2023:09:28:18</span><span class="w"> </span><span class="s">+0800]192.168.107.254</span><span class="w"> </span><span class="s">&quot;/favicon.ico&quot;</span><span class="w"> </span><span class="mi">404</span><span class="s">&quot;http://192.168.107.254:8080/&quot;</span><span class="w"> </span><span class="s">&quot;Mozilla/5.0</span><span class="w"> </span><span class="s">(Windows</span><span class="w"> </span><span class="s">NT</span><span class="w"> </span><span class="mi">10</span><span class="s">.0</span><span class="p">;</span><span class="w"> </span><span class="k">Win64</span><span class="p">;</span><span class="w"> </span><span class="k">x64)</span><span class="w"> </span><span class="s">AppleWebKit/537.36</span><span class="w"> </span><span class="s">(KHTML,</span><span class="w"> </span><span class="s">like</span><span class="w"> </span><span class="s">Gecko)</span><span class="w"> </span><span class="s">Chrome/116.0.0.0</span><span class="w"> </span><span class="s">Safari/537.36&quot;</span>
<a id="__codelineno-135-31" name="__codelineno-135-31"></a><span class="mi">192</span><span class="s">.168.107.254</span><span class="w"> </span><span class="mi">192</span><span class="s">.168.107.1</span><span class="w"> </span><span class="s">[23/Aug/2023:09:28:19</span><span class="w"> </span><span class="s">+0800]192.168.107.254</span><span class="w"> </span><span class="s">&quot;/&quot;</span><span class="w"> </span><span class="mi">304</span><span class="s">&quot;-&quot;</span><span class="w"> </span><span class="s">&quot;Mozilla/5.0</span><span class="w"> </span><span class="s">(Windows</span><span class="w"> </span><span class="s">NT</span><span class="w"> </span><span class="mi">10</span><span class="s">.0</span><span class="p">;</span><span class="w"> </span><span class="k">Win64</span><span class="p">;</span><span class="w"> </span><span class="k">x64)</span><span class="w"> </span><span class="s">AppleWebKit/537.36</span><span class="w"> </span><span class="s">(KHTML,</span><span class="w"> </span><span class="s">like</span><span class="w"> </span><span class="s">Gecko)</span><span class="w"> </span><span class="s">Chrome/116.0.0.0</span><span class="w"> </span><span class="s">Safari/537.36&quot;</span>
<a id="__codelineno-135-32" name="__codelineno-135-32"></a><span class="mi">192</span><span class="s">.168.107.254</span><span class="w"> </span><span class="mi">192</span><span class="s">.168.107.1</span><span class="w"> </span><span class="s">[23/Aug/2023:09:28:20</span><span class="w"> </span><span class="s">+0800]192.168.107.254</span><span class="w"> </span><span class="s">&quot;/&quot;</span><span class="w"> </span><span class="mi">304</span><span class="s">&quot;-&quot;</span><span class="w"> </span><span class="s">&quot;Mozilla/5.0</span><span class="w"> </span><span class="s">(Windows</span><span class="w"> </span><span class="s">NT</span><span class="w"> </span><span class="mi">10</span><span class="s">.0</span><span class="p">;</span><span class="w"> </span><span class="k">Win64</span><span class="p">;</span><span class="w"> </span><span class="k">x64)</span><span class="w"> </span><span class="s">AppleWebKit/537.36</span><span class="w"> </span><span class="s">(KHTML,</span><span class="w"> </span><span class="s">like</span><span class="w"> </span><span class="s">Gecko)</span><span class="w"> </span><span class="s">Chrome/116.0.0.0</span><span class="w"> </span><span class="s">Safari/537.36&quot;</span>
<a id="__codelineno-135-33" name="__codelineno-135-33"></a><span class="mi">192</span><span class="s">.168.107.1</span><span class="w"> </span><span class="s">-</span><span class="w"> </span><span class="s">[23/Aug/2023:09:29:15</span><span class="w"> </span><span class="s">+0800]192.168.107.254</span><span class="w"> </span><span class="s">&quot;/&quot;</span><span class="w"> </span><span class="mi">304</span><span class="s">&quot;-&quot;</span><span class="w"> </span><span class="s">&quot;Mozilla/5.0</span><span class="w"> </span><span class="s">(Windows</span><span class="w"> </span><span class="s">NT</span><span class="w"> </span><span class="mi">10</span><span class="s">.0</span><span class="p">;</span><span class="w"> </span><span class="k">Win64</span><span class="p">;</span><span class="w"> </span><span class="k">x64)</span><span class="w"> </span><span class="s">AppleWebKit/537.36</span><span class="w"> </span><span class="s">(KHTML,</span><span class="w"> </span><span class="s">like</span><span class="w"> </span><span class="s">Gecko)</span><span class="w"> </span><span class="s">Chrome/116.0.0.0</span><span class="w"> </span><span class="s">Safari/537.36&quot;</span>
<a id="__codelineno-135-34" name="__codelineno-135-34"></a><span class="mi">192</span><span class="s">.168.107.254</span><span class="w"> </span><span class="mi">192</span><span class="s">.168.107.1</span><span class="w"> </span><span class="s">[23/Aug/2023:09:29:36</span><span class="w"> </span><span class="s">+0800]192.168.107.254</span><span class="w"> </span><span class="s">&quot;/&quot;</span><span class="w"> </span><span class="mi">304</span><span class="s">&quot;-&quot;</span><span class="w"> </span><span class="s">&quot;Mozilla/5.0</span><span class="w"> </span><span class="s">(Windows</span><span class="w"> </span><span class="s">NT</span><span class="w"> </span><span class="mi">10</span><span class="s">.0</span><span class="p">;</span><span class="w"> </span><span class="k">Win64</span><span class="p">;</span><span class="w"> </span><span class="k">x64)</span><span class="w"> </span><span class="s">AppleWebKit/537.36</span><span class="w"> </span><span class="s">(KHTML,</span><span class="w"> </span><span class="s">like</span><span class="w"> </span><span class="s">Gecko)</span><span class="w"> </span><span class="s">Chrome/116.0.0.0</span><span class="w"> </span><span class="s">Safari/537.36&quot;</span>
</code></pre></div></td></tr></table></div>
<h3 id="常见变量">常见变量<a class="headerlink" href="#常见变量" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>变量</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>$time_local</td>
<td>通用日志格式下的本地时间；（服务器时间）</td>
</tr>
<tr>
<td>$remote_addr</td>
<td>客户端（用户）IP地址</td>
</tr>
<tr>
<td>$status</td>
<td>请求状态码，如200，404，301，302等</td>
</tr>
<tr>
<td>$body_bytes_sent</td>
<td>发送给客户端的字节数，不包括响应头的大小</td>
</tr>
<tr>
<td>$bytes_sent</td>
<td>发送给客户端的总字节数</td>
</tr>
<tr>
<td>$request_length</td>
<td>请求的长度（包括请求行，请求头和请求正文）</td>
</tr>
<tr>
<td>$request_time</td>
<td>请求处理时间，单位为秒，小数的形式</td>
</tr>
<tr>
<td>$upstream_addr</td>
<td>集群轮询地址</td>
</tr>
<tr>
<td>$upstream_response_time</td>
<td>指从Nginx向后端（php-cgi)建立连接开始到接受完数据然后关闭连接为止的时间</td>
</tr>
<tr>
<td>$remote_user</td>
<td>用来记录客户端用户名称</td>
</tr>
<tr>
<td>$request</td>
<td>请求方式（GET或者POST等）+URL（包含<span class="arithmatex">\(request_method,\)</span>host,$request_uri）</td>
</tr>
<tr>
<td>$http_user_agent</td>
<td>用户浏览器标识</td>
</tr>
<tr>
<td>$http_host</td>
<td>请求的url地址（目标url地址）的host</td>
</tr>
<tr>
<td>$host</td>
<td>等同于$http_host</td>
</tr>
<tr>
<td>$http_referer</td>
<td>来源页面，即从哪个页面转到本页，如果直接在浏览器输入网址来访问，则referer为空</td>
</tr>
<tr>
<td>$uri</td>
<td>请求中的当前URI(不带请求参数，参数位于<span class="arithmatex">\(args)，不同于浏览器传递的\)</span>request_uri的值，它可以通过内部重定向，或者使用index指令进行修改。</td>
</tr>
<tr>
<td>$document_uri</td>
<td>等同于$uri</td>
</tr>
<tr>
<td>$request_uri</td>
<td>比<span class="arithmatex">\(uri多了参数，即\)</span>uri+$args</td>
</tr>
<tr>
<td>$http_x_forwarded_for</td>
<td>如果使用了代理，这个参数会记录代理服务器的ip和客户端的ip</td>
</tr>
</tbody>
</table>
<h2 id="25nginx访问日志过滤">25.Nginx访问日志过滤<a class="headerlink" href="#25nginx访问日志过滤" title="Permanent link">&para;</a></h2>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Text Only</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-136-1">1</a></span>
<span class="normal"><a href="#__codelineno-136-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-136-1" name="__codelineno-136-1"></a>一个网站，会包含很多元素，尤其是有大量的图片、js、css等静态元素。
<a id="__codelineno-136-2" name="__codelineno-136-2"></a>这样的请求其实可以不用记录日志。
</code></pre></div></td></tr></table></div>
<h5 id="配置示例_1">配置示例<a class="headerlink" href="#配置示例_1" title="Permanent link">&para;</a></h5>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Nginx Configuration File</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-137-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-137-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-137-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-137-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-137-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-137-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-137-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-137-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-137-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-137-10">10</a></span>
<span class="normal"><a href="#__codelineno-137-11">11</a></span>
<span class="normal"><a href="#__codelineno-137-12">12</a></span>
<span class="normal"><a href="#__codelineno-137-13">13</a></span>
<span class="normal"><a href="#__codelineno-137-14">14</a></span>
<span class="normal"><a href="#__codelineno-137-15">15</a></span>
<span class="normal"><a href="#__codelineno-137-16">16</a></span>
<span class="normal"><a href="#__codelineno-137-17">17</a></span>
<span class="normal"><a href="#__codelineno-137-18">18</a></span>
<span class="normal"><a href="#__codelineno-137-19">19</a></span>
<span class="normal"><a href="#__codelineno-137-20">20</a></span>
<span class="normal"><a href="#__codelineno-137-21">21</a></span>
<span class="normal"><a href="#__codelineno-137-22">22</a></span>
<span class="normal"><a href="#__codelineno-137-23">23</a></span>
<span class="normal"><a href="#__codelineno-137-24">24</a></span>
<span class="normal"><a href="#__codelineno-137-25">25</a></span>
<span class="normal"><a href="#__codelineno-137-26">26</a></span>
<span class="normal"><a href="#__codelineno-137-27">27</a></span>
<span class="normal"><a href="#__codelineno-137-28">28</a></span>
<span class="normal"><a href="#__codelineno-137-29">29</a></span>
<span class="normal"><a href="#__codelineno-137-30">30</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-137-1" name="__codelineno-137-1"></a><span class="k">location</span><span class="w"> </span><span class="p">~</span><span class="sr">*</span><span class="w"> </span><span class="s">^.+\.(gif|jpg|png|css|js)</span>$<span class="w"> </span>
<a id="__codelineno-137-2" name="__codelineno-137-2"></a><span class="p">{</span>
<a id="__codelineno-137-3" name="__codelineno-137-3"></a><span class="w">    </span><span class="kn">access_log</span><span class="w"> </span><span class="no">off</span><span class="p">;</span>
<a id="__codelineno-137-4" name="__codelineno-137-4"></a><span class="p">}</span>
<a id="__codelineno-137-5" name="__codelineno-137-5"></a>
<a id="__codelineno-137-6" name="__codelineno-137-6"></a><span class="k">或</span>
<a id="__codelineno-137-7" name="__codelineno-137-7"></a><span class="s">location</span><span class="w"> </span><span class="p">~</span><span class="sr">*</span><span class="w"> </span><span class="s">^.+\.(gif|jpg|png|css|js)</span>$<span class="w">                                      </span>
<a id="__codelineno-137-8" name="__codelineno-137-8"></a><span class="p">{</span>
<a id="__codelineno-137-9" name="__codelineno-137-9"></a><span class="w">    </span><span class="kn">access_log</span><span class="w"> </span><span class="s">/dev/null</span><span class="p">;</span>
<a id="__codelineno-137-10" name="__codelineno-137-10"></a><span class="p">}</span>
<a id="__codelineno-137-11" name="__codelineno-137-11"></a>
<a id="__codelineno-137-12" name="__codelineno-137-12"></a><span class="k">vi</span><span class="w"> </span><span class="s">A.conf</span>
<a id="__codelineno-137-13" name="__codelineno-137-13"></a><span class="w">    </span><span class="s">log_format</span><span class="w"> </span><span class="s">combined_realip</span><span class="w"> </span><span class="s">&#39;</span><span class="nv">$remote_addr</span><span class="w"> </span><span class="nv">$http_x_forwarded_for</span><span class="w"> </span><span class="s">[</span><span class="nv">$time_local]&#39;</span>
<a id="__codelineno-137-14" name="__codelineno-137-14"></a><span class="w">        </span><span class="s">&#39;</span><span class="nv">$host</span><span class="w"> </span><span class="s">&quot;</span><span class="nv">$request_uri&quot;</span><span class="w"> </span><span class="nv">$status&#39;</span>
<a id="__codelineno-137-15" name="__codelineno-137-15"></a><span class="w">        </span><span class="s">&#39;&quot;</span><span class="nv">$http_referer&quot;</span><span class="w"> </span><span class="s">&quot;</span><span class="nv">$http_user_agent&quot;&#39;</span><span class="p">;</span><span class="c1">#定义了一个名为combined_realip的日志格式</span>
<a id="__codelineno-137-16" name="__codelineno-137-16"></a><span class="w">    </span><span class="k">server{</span>
<a id="__codelineno-137-17" name="__codelineno-137-17"></a><span class="w">        </span><span class="s">listen</span><span class="w"> </span><span class="mi">99</span><span class="p">;</span>
<a id="__codelineno-137-18" name="__codelineno-137-18"></a><span class="w">        </span><span class="k">server_name</span><span class="w"> </span><span class="s">localhost</span><span class="p">;</span>
<a id="__codelineno-137-19" name="__codelineno-137-19"></a><span class="w">        </span><span class="k">root</span><span class="w"> </span><span class="s">/usr/local/nginx/html</span><span class="p">;</span>
<a id="__codelineno-137-20" name="__codelineno-137-20"></a><span class="w">        </span><span class="k">index</span><span class="w"> </span><span class="s">index.html</span><span class="w"> </span><span class="s">index.php</span><span class="p">;</span>
<a id="__codelineno-137-21" name="__codelineno-137-21"></a><span class="w">        </span><span class="k">location</span><span class="w"> </span><span class="p">~</span><span class="sr">*</span><span class="w"> </span><span class="s">^.+\.(gif|jpg|png|css|js)</span>$
<a id="__codelineno-137-22" name="__codelineno-137-22"></a><span class="w">        </span><span class="p">{</span>
<a id="__codelineno-137-23" name="__codelineno-137-23"></a><span class="w">            </span><span class="kn">access_log</span><span class="w"> </span><span class="no">off</span><span class="p">;</span>
<a id="__codelineno-137-24" name="__codelineno-137-24"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-137-25" name="__codelineno-137-25"></a><span class="w">        </span><span class="k">access_log</span><span class="w"> </span><span class="s">/data/logs/localhost.log</span><span class="w"> </span><span class="s">combined_realip</span><span class="p">;</span>
<a id="__codelineno-137-26" name="__codelineno-137-26"></a><span class="w">    </span><span class="k">}</span>
<a id="__codelineno-137-27" name="__codelineno-137-27"></a><span class="s">tail</span><span class="w"> </span><span class="s">-f</span><span class="w"> </span><span class="s">/data/logs/localhost.log</span>
<a id="__codelineno-137-28" name="__codelineno-137-28"></a><span class="mi">192</span><span class="s">.168.107.254</span><span class="w"> </span><span class="mi">192</span><span class="s">.168.107.1</span><span class="w"> </span><span class="s">[23/Aug/2023:09:29:36</span><span class="w"> </span><span class="s">+0800]192.168.107.254</span><span class="w"> </span><span class="s">&quot;/&quot;</span><span class="w"> </span><span class="mi">304</span><span class="s">&quot;-&quot;</span><span class="w"> </span><span class="s">&quot;Mozilla/5.0</span><span class="w"> </span><span class="s">(Windows</span><span class="w"> </span><span class="s">NT</span><span class="w"> </span><span class="mi">10</span><span class="s">.0</span><span class="p">;</span><span class="w"> </span><span class="k">Win64</span><span class="p">;</span><span class="w"> </span><span class="k">x64)</span><span class="w"> </span><span class="s">AppleWebKit/537.36</span><span class="w"> </span><span class="s">(KHTML,</span><span class="w"> </span><span class="s">like</span><span class="w"> </span><span class="s">Gecko)</span><span class="w"> </span><span class="s">Chrome/116.0.0.0</span><span class="w"> </span><span class="s">Safari/537.36&quot;</span>
<a id="__codelineno-137-29" name="__codelineno-137-29"></a><span class="mi">192</span><span class="s">.168.107.254</span><span class="w"> </span><span class="mi">192</span><span class="s">.168.107.1</span><span class="w"> </span><span class="s">[23/Aug/2023:09:44:19</span><span class="w"> </span><span class="s">+0800]192.168.107.254</span><span class="w"> </span><span class="s">&quot;/1.css1&quot;</span><span class="w"> </span><span class="mi">404</span><span class="s">&quot;-&quot;</span><span class="w"> </span><span class="s">&quot;Mozilla/5.0</span><span class="w"> </span><span class="s">(Windows</span><span class="w"> </span><span class="s">NT</span><span class="w"> </span><span class="mi">10</span><span class="s">.0</span><span class="p">;</span><span class="w"> </span><span class="k">Win64</span><span class="p">;</span><span class="w"> </span><span class="k">x64)</span><span class="w"> </span><span class="s">AppleWebKit/537.36</span><span class="w"> </span><span class="s">(KHTML,</span><span class="w"> </span><span class="s">like</span><span class="w"> </span><span class="s">Gecko)</span><span class="w"> </span><span class="s">Chrome/116.0.0.0</span><span class="w"> </span><span class="s">Safari/537.36&quot;</span>
<a id="__codelineno-137-30" name="__codelineno-137-30"></a><span class="mi">192</span><span class="s">.168.107.254</span><span class="w"> </span><span class="mi">192</span><span class="s">.168.107.1</span><span class="w"> </span><span class="s">[23/Aug/2023:09:44:35</span><span class="w"> </span><span class="s">+0800]192.168.107.254</span><span class="w"> </span><span class="s">&quot;/1.css2&quot;</span><span class="w"> </span><span class="mi">404</span><span class="s">&quot;-&quot;</span><span class="w"> </span><span class="s">&quot;Mozilla/5.0</span><span class="w"> </span><span class="s">(Windows</span><span class="w"> </span><span class="s">NT</span><span class="w"> </span><span class="mi">10</span><span class="s">.0</span><span class="p">;</span><span class="w"> </span><span class="k">Win64</span><span class="p">;</span><span class="w"> </span><span class="k">x64)</span><span class="w"> </span><span class="s">AppleWebKit/537.36</span><span class="w"> </span><span class="s">(KHTML,</span><span class="w"> </span><span class="s">like</span><span class="w"> </span><span class="s">Gecko)</span><span class="w"> </span><span class="s">Chrome/116.0.0.0</span><span class="w"> </span><span class="s">Safari/537.36&quot;</span>
</code></pre></div></td></tr></table></div>
<h2 id="26nginx访问日志切割">26.Nginx访问日志切割<a class="headerlink" href="#26nginx访问日志切割" title="Permanent link">&para;</a></h2>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Text Only</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-138-1">1</a></span>
<span class="normal"><a href="#__codelineno-138-2">2</a></span>
<span class="normal"><a href="#__codelineno-138-3">3</a></span>
<span class="normal"><a href="#__codelineno-138-4">4</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-138-1" name="__codelineno-138-1"></a>如果任由访问日志写下去，日志文件会变得越来越大，甚至是写满磁盘。
<a id="__codelineno-138-2" name="__codelineno-138-2"></a>所以，我们需要想办法把日志做切割，比如每天生成一个新的日志，旧的日志按规定时间删除即可。
<a id="__codelineno-138-3" name="__codelineno-138-3"></a>
<a id="__codelineno-138-4" name="__codelineno-138-4"></a>实现日志切割可以通过写shell脚本或者系统的日志切割机制实现。
</code></pre></div></td></tr></table></div>
<h3 id="shell脚本切割nginx日志">shell脚本切割Nginx日志<a class="headerlink" href="#shell脚本切割nginx日志" title="Permanent link">&para;</a></h3>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-139-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-139-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-139-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-139-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-139-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-139-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-139-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-139-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-139-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-139-10">10</a></span>
<span class="normal"><a href="#__codelineno-139-11">11</a></span>
<span class="normal"><a href="#__codelineno-139-12">12</a></span>
<span class="normal"><a href="#__codelineno-139-13">13</a></span>
<span class="normal"><a href="#__codelineno-139-14">14</a></span>
<span class="normal"><a href="#__codelineno-139-15">15</a></span>
<span class="normal"><a href="#__codelineno-139-16">16</a></span>
<span class="normal"><a href="#__codelineno-139-17">17</a></span>
<span class="normal"><a href="#__codelineno-139-18">18</a></span>
<span class="normal"><a href="#__codelineno-139-19">19</a></span>
<span class="normal"><a href="#__codelineno-139-20">20</a></span>
<span class="normal"><a href="#__codelineno-139-21">21</a></span>
<span class="normal"><a href="#__codelineno-139-22">22</a></span>
<span class="normal"><a href="#__codelineno-139-23">23</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-139-1" name="__codelineno-139-1"></a>vi<span class="w"> </span>log_rotate.sh
<a id="__codelineno-139-2" name="__codelineno-139-2"></a>
<a id="__codelineno-139-3" name="__codelineno-139-3"></a><span class="c1">#切割脚本内容：</span>
<a id="__codelineno-139-4" name="__codelineno-139-4"></a><span class="c1">#!/bin/bash</span>
<a id="__codelineno-139-5" name="__codelineno-139-5"></a><span class="nv">logdir</span><span class="o">=</span>/data/logs/<span class="w">  </span><span class="c1">#定义日志路径</span>
<a id="__codelineno-139-6" name="__codelineno-139-6"></a><span class="nv">prefix</span><span class="o">=</span><span class="sb">`</span>date<span class="w"> </span>-d<span class="w"> </span><span class="s2">&quot;-1 day&quot;</span><span class="w"> </span>+%y%m%d<span class="sb">`</span><span class="w">  </span><span class="c1">#定义切割后的日志前缀</span>
<a id="__codelineno-139-7" name="__codelineno-139-7"></a><span class="nb">cd</span><span class="w"> </span><span class="nv">$logdir</span>
<a id="__codelineno-139-8" name="__codelineno-139-8"></a><span class="k">for</span><span class="w"> </span>f<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="sb">`</span>ls<span class="w"> </span>*.log<span class="sb">`</span>
<a id="__codelineno-139-9" name="__codelineno-139-9"></a><span class="k">do</span>
<a id="__codelineno-139-10" name="__codelineno-139-10"></a>mv<span class="w"> </span><span class="nv">$f</span><span class="w"> </span><span class="nv">$f</span>-<span class="nv">$prefix</span><span class="w">  </span><span class="c1">#把日志改名</span>
<a id="__codelineno-139-11" name="__codelineno-139-11"></a><span class="k">done</span>
<a id="__codelineno-139-12" name="__codelineno-139-12"></a>/usr/local/nginx/sbin/nginx<span class="w"> </span>-s<span class="w"> </span>reload<span class="w"> </span><span class="c1">#/bin/kill -USR1 $(cat /usr/local/nginx/logs/nginx.pid 2&gt;/dev/null) 2&gt;/dev/null 两句命令效果一样</span>
<a id="__codelineno-139-13" name="__codelineno-139-13"></a>bzip2<span class="w"> </span>*<span class="nv">$prefix</span><span class="w">  </span><span class="c1">#压缩日志</span>
<a id="__codelineno-139-14" name="__codelineno-139-14"></a>find<span class="w"> </span>.<span class="w"> </span>-type<span class="w"> </span>f<span class="w"> </span>-mtime<span class="w"> </span>+180<span class="w"> </span><span class="p">|</span>xargs<span class="w"> </span>/bin/rm<span class="w"> </span>-f<span class="w">  </span><span class="c1">#删除超过180天的老日志</span>
<a id="__codelineno-139-15" name="__codelineno-139-15"></a>
<a id="__codelineno-139-16" name="__codelineno-139-16"></a>
<a id="__codelineno-139-17" name="__codelineno-139-17"></a>
<a id="__codelineno-139-18" name="__codelineno-139-18"></a>sh<span class="w"> </span>-x<span class="w"> </span>log_rotate.sh<span class="w"> </span><span class="c1">#执行脚本并且查看详细信息</span>
<a id="__codelineno-139-19" name="__codelineno-139-19"></a>
<a id="__codelineno-139-20" name="__codelineno-139-20"></a>
<a id="__codelineno-139-21" name="__codelineno-139-21"></a><span class="c1">#添加到每日工作任务中</span>
<a id="__codelineno-139-22" name="__codelineno-139-22"></a>crontab<span class="w"> </span>-e
<a id="__codelineno-139-23" name="__codelineno-139-23"></a><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span>*<span class="w"> </span>*<span class="w"> </span>*<span class="w"> </span>/bin/bash<span class="w"> </span>/usr/local/nginx/sbin/log_rotate.sh
</code></pre></div></td></tr></table></div>
<h3 id="系统日志切割机制">系统日志切割机制<a class="headerlink" href="#系统日志切割机制" title="Permanent link">&para;</a></h3>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-140-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-140-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-140-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-140-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-140-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-140-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-140-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-140-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-140-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-140-10">10</a></span>
<span class="normal"><a href="#__codelineno-140-11">11</a></span>
<span class="normal"><a href="#__codelineno-140-12">12</a></span>
<span class="normal"><a href="#__codelineno-140-13">13</a></span>
<span class="normal"><a href="#__codelineno-140-14">14</a></span>
<span class="normal"><a href="#__codelineno-140-15">15</a></span>
<span class="normal"><a href="#__codelineno-140-16">16</a></span>
<span class="normal"><a href="#__codelineno-140-17">17</a></span>
<span class="normal"><a href="#__codelineno-140-18">18</a></span>
<span class="normal"><a href="#__codelineno-140-19">19</a></span>
<span class="normal"><a href="#__codelineno-140-20">20</a></span>
<span class="normal"><a href="#__codelineno-140-21">21</a></span>
<span class="normal"><a href="#__codelineno-140-22">22</a></span>
<span class="normal"><a href="#__codelineno-140-23">23</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-140-1" name="__codelineno-140-1"></a>在/etc/logrotate.d/下创建nginx文件，内容为：
<a id="__codelineno-140-2" name="__codelineno-140-2"></a>vi<span class="w"> </span>/etc/logrotate.d/nginx
<a id="__codelineno-140-3" name="__codelineno-140-3"></a>/data/logs/*log<span class="w"> </span><span class="o">{</span>
<a id="__codelineno-140-4" name="__codelineno-140-4"></a><span class="w">    </span>daily
<a id="__codelineno-140-5" name="__codelineno-140-5"></a><span class="w">    </span>rotate<span class="w"> </span><span class="m">30</span>
<a id="__codelineno-140-6" name="__codelineno-140-6"></a><span class="w">    </span>missingok
<a id="__codelineno-140-7" name="__codelineno-140-7"></a><span class="w">    </span>notifempty
<a id="__codelineno-140-8" name="__codelineno-140-8"></a><span class="w">    </span>compress
<a id="__codelineno-140-9" name="__codelineno-140-9"></a><span class="w">    </span>sharedscripts
<a id="__codelineno-140-10" name="__codelineno-140-10"></a><span class="w">    </span>postrotate
<a id="__codelineno-140-11" name="__codelineno-140-11"></a><span class="w">        </span>/bin/kill<span class="w"> </span>-USR1<span class="w"> </span><span class="k">$(</span>cat<span class="w"> </span>/usr/local/nginx/logs/nginx.pid<span class="w"> </span><span class="m">2</span>&gt;/dev/null<span class="k">)</span><span class="w"> </span><span class="m">2</span>&gt;/dev/null<span class="w"> </span>
<a id="__codelineno-140-12" name="__codelineno-140-12"></a><span class="w">    </span>endscript
<a id="__codelineno-140-13" name="__codelineno-140-13"></a><span class="o">}</span>
<a id="__codelineno-140-14" name="__codelineno-140-14"></a>
<a id="__codelineno-140-15" name="__codelineno-140-15"></a>说明：
<a id="__codelineno-140-16" name="__codelineno-140-16"></a><span class="m">1</span><span class="w"> </span>nginx日志在/data/logs/目录下面，日志名字以log结尾
<a id="__codelineno-140-17" name="__codelineno-140-17"></a><span class="m">2</span><span class="w"> </span>daily表示每天切割
<a id="__codelineno-140-18" name="__codelineno-140-18"></a><span class="m">3</span><span class="w"> </span>rotate<span class="w"> </span>30表示日志保留30天
<a id="__codelineno-140-19" name="__codelineno-140-19"></a><span class="m">4</span><span class="w"> </span>missingok表示忽略错误
<a id="__codelineno-140-20" name="__codelineno-140-20"></a><span class="m">5</span><span class="w"> </span>notifempty表示如果日志为空，不切割
<a id="__codelineno-140-21" name="__codelineno-140-21"></a><span class="m">6</span><span class="w"> </span>compress表示压缩
<a id="__codelineno-140-22" name="__codelineno-140-22"></a><span class="m">7</span><span class="w"> </span>sharedscripts和endscript中间可以引用系统的命令
<a id="__codelineno-140-23" name="__codelineno-140-23"></a><span class="m">8</span><span class="w"> </span>postrotate表示当切割之后要执行的命令
</code></pre></div></td></tr></table></div>
<h2 id="27nginx配置参数优化">27.Nginx配置参数优化<a class="headerlink" href="#27nginx配置参数优化" title="Permanent link">&para;</a></h2>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Text Only</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-141-1">1</a></span>
<span class="normal"><a href="#__codelineno-141-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-141-1" name="__codelineno-141-1"></a>Nginx作为高性能web服务器，即使不特意调整配置参数也可以处理大量的并发请求。
<a id="__codelineno-141-2" name="__codelineno-141-2"></a>以下的配置参数是借鉴网上的一些调优参数，仅作为参考，不见得适于你的线上业务。
</code></pre></div></td></tr></table></div>
<h3 id="worker进程">worker进程<a class="headerlink" href="#worker进程" title="Permanent link">&para;</a></h3>
<ul>
<li>worker_processes</li>
</ul>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Text Only</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-142-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-142-1" name="__codelineno-142-1"></a>该参数表示启动几个工作进程，建议和本机CPU核数保持一致，每一核CPU处理一个进程。
</code></pre></div></td></tr></table></div>
<ul>
<li>worker_rlimit_nofile</li>
</ul>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Text Only</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-143-1">1</a></span>
<span class="normal"><a href="#__codelineno-143-2">2</a></span>
<span class="normal"><a href="#__codelineno-143-3">3</a></span>
<span class="normal"><a href="#__codelineno-143-4">4</a></span>
<span class="normal"><a href="#__codelineno-143-5">5</a></span>
<span class="normal"><a href="#__codelineno-143-6">6</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-143-1" name="__codelineno-143-1"></a>它表示Nginx最大可用的文件描述符个数，需要配合系统的最大描述符，建议设置为102400。
<a id="__codelineno-143-2" name="__codelineno-143-2"></a>还需要在系统里执行ulimit -n 102400才可以。这个配置只是暂时的。
<a id="__codelineno-143-3" name="__codelineno-143-3"></a>也可以直接修改配置文件/etc/security/limits.conf修改
<a id="__codelineno-143-4" name="__codelineno-143-4"></a>增加：
<a id="__codelineno-143-5" name="__codelineno-143-5"></a>* soft nofile 655350
<a id="__codelineno-143-6" name="__codelineno-143-6"></a>* hard nofile 655350
</code></pre></div></td></tr></table></div>
<ul>
<li>worker_connections</li>
</ul>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Text Only</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-144-1">1</a></span>
<span class="normal"><a href="#__codelineno-144-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-144-1" name="__codelineno-144-1"></a>该参数用来配置每个Nginx worker进程最大处理的连接数，这个参数也决定了该Nginx服务器最多能处理多少客户端请求
<a id="__codelineno-144-2" name="__codelineno-144-2"></a>（worker_processes * worker_connections)，建议把该参数设置为10240，不建议太大。
</code></pre></div></td></tr></table></div>
<h3 id="http和tcp连接">http和tcp连接<a class="headerlink" href="#http和tcp连接" title="Permanent link">&para;</a></h3>
<ul>
<li>use epoll</li>
</ul>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Text Only</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-145-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-145-1" name="__codelineno-145-1"></a>使用epoll模式的事件驱动模型，该模型为Linux系统下最优方式。
</code></pre></div></td></tr></table></div>
<ul>
<li>multi_accept on</li>
</ul>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Text Only</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-146-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-146-1" name="__codelineno-146-1"></a>使每个worker进程可以同时处理多个客户端请求。
</code></pre></div></td></tr></table></div>
<ul>
<li>sendfile on</li>
</ul>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Text Only</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-147-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-147-1" name="__codelineno-147-1"></a>使用内核的FD文件传输功能，可以减少user mode和kernel mode的切换，从而提升服务器性能。
</code></pre></div></td></tr></table></div>
<ul>
<li>tcp_nopush on</li>
</ul>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Text Only</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-148-1">1</a></span>
<span class="normal"><a href="#__codelineno-148-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-148-1" name="__codelineno-148-1"></a>当tcp_nopush设置为on时，会调用tcp_cork方法进行数据传输。
<a id="__codelineno-148-2" name="__codelineno-148-2"></a>使用该方法会产生这样的效果：当应用程序产生数据时，内核不会立马封装包，而是当数据量积累到一定量时才会封装，然后传输。
</code></pre></div></td></tr></table></div>
<ul>
<li>tcp_nodelay on</li>
</ul>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Text Only</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-149-1">1</a></span>
<span class="normal"><a href="#__codelineno-149-2">2</a></span>
<span class="normal"><a href="#__codelineno-149-3">3</a></span>
<span class="normal"><a href="#__codelineno-149-4">4</a></span>
<span class="normal"><a href="#__codelineno-149-5">5</a></span>
<span class="normal"><a href="#__codelineno-149-6">6</a></span>
<span class="normal"><a href="#__codelineno-149-7">7</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-149-1" name="__codelineno-149-1"></a>不缓存data-sends（关闭 Nagle 算法），这个能够提高高频发送小数据报文的实时性。
<a id="__codelineno-149-2" name="__codelineno-149-2"></a>(关于Nagle算法)
<a id="__codelineno-149-3" name="__codelineno-149-3"></a>【假如需要频繁的发送一些小包数据，比如说1个字节，以IPv4为例的话，则每个包都要附带40字节的头，
<a id="__codelineno-149-4" name="__codelineno-149-4"></a>也就是说，总计41个字节的数据里，其中只有1个字节是我们需要的数据。
<a id="__codelineno-149-5" name="__codelineno-149-5"></a>为了解决这个问题，出现了Nagle算法。
<a id="__codelineno-149-6" name="__codelineno-149-6"></a>它规定：如果包的大小满足MSS，那么可以立即发送，否则数据会被放到缓冲区，等到已经发送的包被确认了之后才能继续发送。
<a id="__codelineno-149-7" name="__codelineno-149-7"></a>通过这样的规定，可以降低网络里小包的数量，从而提升网络性能。】
</code></pre></div></td></tr></table></div>
<ul>
<li>keepalive_timeout</li>
</ul>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Text Only</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-150-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-150-1" name="__codelineno-150-1"></a>定义长连接的超时时间，建议30s，太短或者太长都不一定合适，当然，最好是根据业务自身的情况来动态地调整该参数。
</code></pre></div></td></tr></table></div>
<ul>
<li>keepalive_requests</li>
</ul>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Text Only</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-151-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-151-1" name="__codelineno-151-1"></a>定义当客户端和服务端处于长连接的情况下，每个客户端最多可以请求多少次，可以设置很大，比如50000.
</code></pre></div></td></tr></table></div>
<ul>
<li>reset_timeout_connection on</li>
</ul>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Text Only</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-152-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-152-1" name="__codelineno-152-1"></a>设置为on的话，当客户端不再向服务端发送请求时，允许服务端关闭该连接。
</code></pre></div></td></tr></table></div>
<ul>
<li>client_body_timeout</li>
</ul>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Text Only</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-153-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-153-1" name="__codelineno-153-1"></a>客户端如果在该指定时间内没有加载完body数据，则断开连接，单位是秒，默认60，可以设置为10。
</code></pre></div></td></tr></table></div>
<ul>
<li>send_timeout</li>
</ul>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Text Only</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-154-1">1</a></span>
<span class="normal"><a href="#__codelineno-154-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-154-1" name="__codelineno-154-1"></a>这个超时时间是发送响应的超时时间，即Nginx服务器向客户端发送了数据包，但客户端一直没有去接收这个数据包。
<a id="__codelineno-154-2" name="__codelineno-154-2"></a>如果某个连接超过send_timeout定义的超时时间，那么Nginx将会关闭这个连接。单位是秒，可以设置为3。
</code></pre></div></td></tr></table></div>
<h3 id="buffer和cache以下配置都是针对单个请求">buffer和cache(以下配置都是针对单个请求)<a class="headerlink" href="#buffer和cache以下配置都是针对单个请求" title="Permanent link">&para;</a></h3>
<ul>
<li>client_body_buffer_size</li>
</ul>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Text Only</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-155-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-155-1" name="__codelineno-155-1"></a>当客户端以POST方法提交一些数据到服务端时，会先写入到client_body_buffer中，如果buffer写满会写到临时文件里，建议调整为128k。
</code></pre></div></td></tr></table></div>
<ul>
<li>client_max_body_size</li>
</ul>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Text Only</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-156-1">1</a></span>
<span class="normal"><a href="#__codelineno-156-2">2</a></span>
<span class="normal"><a href="#__codelineno-156-3">3</a></span>
<span class="normal"><a href="#__codelineno-156-4">4</a></span>
<span class="normal"><a href="#__codelineno-156-5">5</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-156-1" name="__codelineno-156-1"></a>浏览器在发送含有较大HTTP body的请求时，其头部会有一个Content-Length字段，client_max_body_size是用来限制Content-Length所示值的大小的。
<a id="__codelineno-156-2" name="__codelineno-156-2"></a>这个限制body的配置不用等Nginx接收完所有的HTTP包体，就可以告诉用户请求过大不被接受。会返回413状态码。
<a id="__codelineno-156-3" name="__codelineno-156-3"></a>例如，用户试图上传一个1GB的文件，Nginx在收完包头后，发现Content-Length超过client_max_body_size定义的值，
<a id="__codelineno-156-4" name="__codelineno-156-4"></a>就直接发送413(Request Entity Too Large)响应给客户端。
<a id="__codelineno-156-5" name="__codelineno-156-5"></a>将该数值设置为0，则禁用限制，建议设置为10m。
</code></pre></div></td></tr></table></div>
<ul>
<li>client_header_buffer_size</li>
</ul>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Text Only</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-157-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-157-1" name="__codelineno-157-1"></a>设置客户端header的buffer大小，建议4k。
</code></pre></div></td></tr></table></div>
<ul>
<li>large_client_header_buffers</li>
</ul>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Text Only</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-158-1">1</a></span>
<span class="normal"><a href="#__codelineno-158-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-158-1" name="__codelineno-158-1"></a>对于比较大的header（超过client_header_buffer_size）将会使用该部分buffer，两个数值，第一个是个数，第二个是每个buffer的大小。
<a id="__codelineno-158-2" name="__codelineno-158-2"></a>建议设置为4 8k
</code></pre></div></td></tr></table></div>
<ul>
<li>open_file_cache</li>
</ul>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Text Only</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-159-1">1</a></span>
<span class="normal"><a href="#__codelineno-159-2">2</a></span>
<span class="normal"><a href="#__codelineno-159-3">3</a></span>
<span class="normal"><a href="#__codelineno-159-4">4</a></span>
<span class="normal"><a href="#__codelineno-159-5">5</a></span>
<span class="normal"><a href="#__codelineno-159-6">6</a></span>
<span class="normal"><a href="#__codelineno-159-7">7</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-159-1" name="__codelineno-159-1"></a>该参数会对以下信息进行缓存：
<a id="__codelineno-159-2" name="__codelineno-159-2"></a>打开文件描述符的文件大小和修改时间信息;
<a id="__codelineno-159-3" name="__codelineno-159-3"></a>存在的目录信息;
<a id="__codelineno-159-4" name="__codelineno-159-4"></a>搜索文件的错误信息（文件不存在无权限读取等信息）。
<a id="__codelineno-159-5" name="__codelineno-159-5"></a>格式：open_file_cache max=size inactive=time;
<a id="__codelineno-159-6" name="__codelineno-159-6"></a>max设定缓存文件的数量，inactive设定经过多长时间文件没被请求后删除缓存。
<a id="__codelineno-159-7" name="__codelineno-159-7"></a>建议设置 open_file_cache max=102400 inactive=20s;
</code></pre></div></td></tr></table></div>
<ul>
<li>open_file_cache_valid</li>
</ul>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Text Only</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-160-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-160-1" name="__codelineno-160-1"></a>指多长时间检查一次缓存的有效信息。建议设置为30s。
</code></pre></div></td></tr></table></div>
<ul>
<li>open_file_cache_min_uses</li>
</ul>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Text Only</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-161-1">1</a></span>
<span class="normal"><a href="#__codelineno-161-2">2</a></span>
<span class="normal"><a href="#__codelineno-161-3">3</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-161-1" name="__codelineno-161-1"></a>open_file_cache指令中的inactive参数时间内文件的最少使用次数，
<a id="__codelineno-161-2" name="__codelineno-161-2"></a>如,将该参数设置为1，则表示，如果文件在inactive时间内一次都没被使用，它将被移除。
<a id="__codelineno-161-3" name="__codelineno-161-3"></a>建议设置为2。
</code></pre></div></td></tr></table></div>
<h3 id="压缩">压缩<a class="headerlink" href="#压缩" title="Permanent link">&para;</a></h3>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Nginx Configuration File</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-162-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-162-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-162-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-162-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-162-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-162-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-162-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-162-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-162-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-162-10">10</a></span>
<span class="normal"><a href="#__codelineno-162-11">11</a></span>
<span class="normal"><a href="#__codelineno-162-12">12</a></span>
<span class="normal"><a href="#__codelineno-162-13">13</a></span>
<span class="normal"><a href="#__codelineno-162-14">14</a></span>
<span class="normal"><a href="#__codelineno-162-15">15</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-162-1" name="__codelineno-162-1"></a><span class="k">对于纯文本的内容，Nginx是可以使用gzip压缩的。使用压缩技术可以减少对带宽的消耗。</span>
<a id="__codelineno-162-2" name="__codelineno-162-2"></a><span class="s">由ngx_http_gzip_module模块支持</span>
<a id="__codelineno-162-3" name="__codelineno-162-3"></a>
<a id="__codelineno-162-4" name="__codelineno-162-4"></a><span class="s">配置如下：</span>
<a id="__codelineno-162-5" name="__codelineno-162-5"></a><span class="s">gzip</span><span class="w"> </span><span class="no">on</span><span class="p">;</span><span class="w"> </span><span class="c1">#开启gzip功能</span>
<a id="__codelineno-162-6" name="__codelineno-162-6"></a><span class="k">gzip_min_length</span><span class="w"> </span><span class="mi">1024</span><span class="p">;</span><span class="w"> </span><span class="c1">#设置请求资源超过该数值才进行压缩，单位字节</span>
<a id="__codelineno-162-7" name="__codelineno-162-7"></a><span class="k">gzip_buffers</span><span class="w"> </span><span class="mi">16</span><span class="w"> </span><span class="mi">8k</span><span class="p">;</span><span class="w"> </span><span class="c1">#设置压缩使用的buffer大小，第一个数字为数量，第二个为每个buffer的大小</span>
<a id="__codelineno-162-8" name="__codelineno-162-8"></a><span class="k">gzip_comp_level</span><span class="w"> </span><span class="mi">6</span><span class="p">;</span><span class="w"> </span><span class="c1">#设置压缩级别，范围1-9,9压缩级别最高，也最耗费CPU资源</span>
<a id="__codelineno-162-9" name="__codelineno-162-9"></a><span class="k">gzip_types</span><span class="w"> </span><span class="s">text/plain</span><span class="w"> </span><span class="s">application/x-javascript</span><span class="w"> </span><span class="s">text/css</span><span class="w"> </span><span class="s">application/xml</span><span class="w"> </span><span class="s">image/jpeg</span><span class="w"> </span><span class="s">image/gif</span><span class="w"> </span><span class="s">image/png</span><span class="p">;</span><span class="w"> </span><span class="c1">#指定哪些类型的文件需要压缩</span>
<a id="__codelineno-162-10" name="__codelineno-162-10"></a><span class="k">gzip_disable</span><span class="w"> </span><span class="s">&quot;MSIE</span><span class="w"> </span><span class="mi">6</span><span class="s">\.&quot;</span><span class="p">;</span><span class="w"> </span><span class="c1">#IE6浏览器不启用压缩</span>
<a id="__codelineno-162-11" name="__codelineno-162-11"></a>
<a id="__codelineno-162-12" name="__codelineno-162-12"></a><span class="k">测试：</span>
<a id="__codelineno-162-13" name="__codelineno-162-13"></a><span class="s">du</span><span class="w"> </span><span class="s">-sb</span><span class="w"> </span><span class="s">/usr/local/nginx/html/1.css</span><span class="w"> </span><span class="c1">#查看字节大小 必须超过1024根据上面的设置</span>
<a id="__codelineno-162-14" name="__codelineno-162-14"></a><span class="s">cat</span><span class="w"> </span><span class="s">index.html</span><span class="w"> </span><span class="s">&gt;&gt;</span><span class="w"> </span><span class="mi">1</span><span class="s">.css</span>
<a id="__codelineno-162-15" name="__codelineno-162-15"></a><span class="s">curl</span><span class="w"> </span><span class="s">-I</span><span class="w"> </span><span class="s">-H</span><span class="w"> </span><span class="s">&quot;Accept-Encoding:</span><span class="w"> </span><span class="s">gzip,</span><span class="w"> </span><span class="s">deflate&quot;</span><span class="w"> </span><span class="n">192.168.107.254</span><span class="p">:</span><span class="mi">8080</span><span class="s">/1.css</span>
</code></pre></div></td></tr></table></div>
<h3 id="日志">日志<a class="headerlink" href="#日志" title="Permanent link">&para;</a></h3>
<ul>
<li>错误日志级别调高，比如crit级别，尽量少记录无关紧要的日志。</li>
<li>对于访问日志，如果不要求记录日志，可以关闭，</li>
<li>静态资源的访问日志关闭</li>
</ul>
<h3 id="静态文件过期">静态文件过期<a class="headerlink" href="#静态文件过期" title="Permanent link">&para;</a></h3>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Nginx Configuration File</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-163-1">1</a></span>
<span class="normal"><a href="#__codelineno-163-2">2</a></span>
<span class="normal"><a href="#__codelineno-163-3">3</a></span>
<span class="normal"><a href="#__codelineno-163-4">4</a></span>
<span class="normal"><a href="#__codelineno-163-5">5</a></span>
<span class="normal"><a href="#__codelineno-163-6">6</a></span>
<span class="normal"><a href="#__codelineno-163-7">7</a></span>
<span class="normal"><a href="#__codelineno-163-8">8</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-163-1" name="__codelineno-163-1"></a><span class="c1">#对于静态文件，需要设置一个过期时间，这样可以让这些资源缓存到客户端浏览器，</span>
<a id="__codelineno-163-2" name="__codelineno-163-2"></a><span class="c1">#在缓存未失效前，客户端不再向服务期请求相同的资源，从而节省带宽和资源消耗。</span>
<a id="__codelineno-163-3" name="__codelineno-163-3"></a>
<a id="__codelineno-163-4" name="__codelineno-163-4"></a><span class="c1">#配置示例如下：</span>
<a id="__codelineno-163-5" name="__codelineno-163-5"></a><span class="k">location</span><span class="w"> </span><span class="p">~</span><span class="sr">*</span><span class="w"> </span><span class="s">^.+\.(gif|jpg|png|css|js)</span>$<span class="w">                                      </span>
<a id="__codelineno-163-6" name="__codelineno-163-6"></a><span class="p">{</span>
<a id="__codelineno-163-7" name="__codelineno-163-7"></a><span class="w">    </span><span class="kn">expires</span><span class="w"> </span><span class="s">1d</span><span class="p">;</span><span class="w"> </span><span class="c1">#1d表示1天，也可以用24h表示一天。</span>
<a id="__codelineno-163-8" name="__codelineno-163-8"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<h3 id="作为代理服务器">作为代理服务器<a class="headerlink" href="#作为代理服务器" title="Permanent link">&para;</a></h3>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Nginx Configuration File</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-164-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-164-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-164-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-164-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-164-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-164-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-164-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-164-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-164-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-164-10">10</a></span>
<span class="normal"><a href="#__codelineno-164-11">11</a></span>
<span class="normal"><a href="#__codelineno-164-12">12</a></span>
<span class="normal"><a href="#__codelineno-164-13">13</a></span>
<span class="normal"><a href="#__codelineno-164-14">14</a></span>
<span class="normal"><a href="#__codelineno-164-15">15</a></span>
<span class="normal"><a href="#__codelineno-164-16">16</a></span>
<span class="normal"><a href="#__codelineno-164-17">17</a></span>
<span class="normal"><a href="#__codelineno-164-18">18</a></span>
<span class="normal"><a href="#__codelineno-164-19">19</a></span>
<span class="normal"><a href="#__codelineno-164-20">20</a></span>
<span class="normal"><a href="#__codelineno-164-21">21</a></span>
<span class="normal"><a href="#__codelineno-164-22">22</a></span>
<span class="normal"><a href="#__codelineno-164-23">23</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-164-1" name="__codelineno-164-1"></a><span class="k">Nginx绝大多数情况下都是作为代理或者负载均衡的角色。</span>
<a id="__codelineno-164-2" name="__codelineno-164-2"></a><span class="s">因为前面章节已经介绍过以下参数的含义，在这里只提供对应的配置参数：</span>
<a id="__codelineno-164-3" name="__codelineno-164-3"></a><span class="s">http</span>
<a id="__codelineno-164-4" name="__codelineno-164-4"></a><span class="p">{</span>
<a id="__codelineno-164-5" name="__codelineno-164-5"></a><span class="w">    </span><span class="kn">proxy_cache_path</span><span class="w"> </span><span class="s">/data/nginx_cache/</span><span class="w"> </span><span class="s">levels=1:2</span><span class="w"> </span><span class="s">keys_zone=my_zone:10m</span><span class="w"> </span><span class="s">inactive=300s</span><span class="w"> </span><span class="s">max_size=5g</span><span class="p">;</span>
<a id="__codelineno-164-6" name="__codelineno-164-6"></a><span class="w">    </span><span class="kn">...</span><span class="p">;</span>
<a id="__codelineno-164-7" name="__codelineno-164-7"></a><span class="w">    </span><span class="kn">server</span>
<a id="__codelineno-164-8" name="__codelineno-164-8"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-164-9" name="__codelineno-164-9"></a><span class="w">    </span><span class="kn">proxy_buffering</span><span class="w"> </span><span class="no">on</span><span class="p">;</span>
<a id="__codelineno-164-10" name="__codelineno-164-10"></a><span class="w">    </span><span class="kn">proxy_buffer_size</span><span class="w"> </span><span class="mi">4k</span><span class="p">;</span>
<a id="__codelineno-164-11" name="__codelineno-164-11"></a><span class="w">    </span><span class="kn">proxy_buffers</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">4k</span><span class="p">;</span>
<a id="__codelineno-164-12" name="__codelineno-164-12"></a><span class="w">    </span><span class="kn">proxy_busy_buffers_size</span><span class="w"> </span><span class="mi">4k</span><span class="p">;</span>
<a id="__codelineno-164-13" name="__codelineno-164-13"></a><span class="w">    </span><span class="kn">proxy_temp_path</span><span class="w"> </span><span class="s">/tmp/nginx_proxy_tmp</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span>
<a id="__codelineno-164-14" name="__codelineno-164-14"></a><span class="w">    </span><span class="kn">proxy_max_temp_file_size</span><span class="w"> </span><span class="s">20M</span><span class="p">;</span>
<a id="__codelineno-164-15" name="__codelineno-164-15"></a><span class="w">    </span><span class="kn">proxy_temp_file_write_size</span><span class="w"> </span><span class="mi">8k</span><span class="p">;</span>
<a id="__codelineno-164-16" name="__codelineno-164-16"></a>
<a id="__codelineno-164-17" name="__codelineno-164-17"></a><span class="w">    </span><span class="kn">location</span><span class="w"> </span><span class="s">/</span>
<a id="__codelineno-164-18" name="__codelineno-164-18"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-164-19" name="__codelineno-164-19"></a><span class="w">        </span><span class="kn">proxy_cache</span><span class="w"> </span><span class="s">my_zone</span><span class="p">;</span>
<a id="__codelineno-164-20" name="__codelineno-164-20"></a><span class="w">        </span><span class="kn">...</span><span class="p">;</span>
<a id="__codelineno-164-21" name="__codelineno-164-21"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-164-22" name="__codelineno-164-22"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-164-23" name="__codelineno-164-23"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<h3 id="ssl优化">SSL优化<a class="headerlink" href="#ssl优化" title="Permanent link">&para;</a></h3>
<ul>
<li>适当减少worker_processes数量，因为ssl功能需要使用CPU的计算。</li>
<li>使用长连接，因为每次建立ssl会话，都会耗费一定的资源（加密、解密）</li>
<li>开启ssl缓存，简化服务端和客户端的“握手”过程。</li>
</ul>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Nginx Configuration File</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-165-1">1</a></span>
<span class="normal"><a href="#__codelineno-165-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-165-1" name="__codelineno-165-1"></a><span class="k">ssl_session_cache</span><span class="w">   </span><span class="s">shared:SSL:10m</span><span class="p">;</span><span class="w"> </span><span class="k">//缓存为10M</span>
<a id="__codelineno-165-2" name="__codelineno-165-2"></a><span class="s">ssl_session_timeout</span><span class="w"> </span><span class="mi">10m</span><span class="p">;</span><span class="w"> </span><span class="k">//会话超时时间为10分钟</span>
</code></pre></div></td></tr></table></div>
<h2 id="28调整linux内核参数">28.调整Linux内核参数<a class="headerlink" href="#28调整linux内核参数" title="Permanent link">&para;</a></h2>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Text Only</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-166-1">1</a></span>
<span class="normal"><a href="#__codelineno-166-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-166-1" name="__codelineno-166-1"></a>作为高性能WEB服务器，只调整Nginx本身的参数是不行的，因为Nginx服务依赖于高性能的操作系统。
<a id="__codelineno-166-2" name="__codelineno-166-2"></a>以下为常见的几个Linux内核参数优化方法。
</code></pre></div></td></tr></table></div>
<ul>
<li>1 net.ipv4.tcp_max_tw_buckets</li>
</ul>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Text Only</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-167-1">1</a></span>
<span class="normal"><a href="#__codelineno-167-2">2</a></span>
<span class="normal"><a href="#__codelineno-167-3">3</a></span>
<span class="normal"><a href="#__codelineno-167-4">4</a></span>
<span class="normal"><a href="#__codelineno-167-5">5</a></span>
<span class="normal"><a href="#__codelineno-167-6">6</a></span>
<span class="normal"><a href="#__codelineno-167-7">7</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-167-1" name="__codelineno-167-1"></a>对于tcp连接，服务端和客户端通信完后状态变为timewait，假如某台服务器非常忙，连接数特别多的话，那么这个timewait数量就会越来越大。
<a id="__codelineno-167-2" name="__codelineno-167-2"></a>毕竟它也是会占用一定的资源，所以应该有一个最大值，当超过这个值，系统就会删除最早的连接，这样始终保持在一个数量级。
<a id="__codelineno-167-3" name="__codelineno-167-3"></a>这个数值就是由net.ipv4.tcp_max_tw_buckets这个参数来决定的。
<a id="__codelineno-167-4" name="__codelineno-167-4"></a>CentOS7系统，你可以使用sysctl -a |grep tw_buckets来查看它的值，默认为32768，
<a id="__codelineno-167-5" name="__codelineno-167-5"></a>你可以适当把它调低，比如调整到8000，毕竟这个状态的连接太多也是会消耗资源的。
<a id="__codelineno-167-6" name="__codelineno-167-6"></a>但你不要把它调到几十、几百这样，因为这种状态的tcp连接也是有用的，
<a id="__codelineno-167-7" name="__codelineno-167-7"></a>如果同样的客户端再次和服务端通信，就不用再次建立新的连接了，用这个旧的通道，省时省力。
</code></pre></div></td></tr></table></div>
<ul>
<li>2 net.ipv4.tcp_tw_recycle = 1</li>
</ul>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Text Only</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-168-1">1</a></span>
<span class="normal"><a href="#__codelineno-168-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-168-1" name="__codelineno-168-1"></a>该参数的作用是快速回收timewait状态的连接。上面虽然提到系统会自动删除掉timewait状态的连接，但如果把这样的连接重新利用起来岂不是更好。
<a id="__codelineno-168-2" name="__codelineno-168-2"></a>所以该参数设置为1就可以让timewait状态的连接快速回收，它需要和下面的参数配合一起使用。
</code></pre></div></td></tr></table></div>
<ul>
<li>3 net.ipv4.tcp_tw_reuse = 1</li>
</ul>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Text Only</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-169-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-169-1" name="__codelineno-169-1"></a>该参数设置为1，将timewait状态的连接重新用于新的TCP连接，要结合上面的参数一起使用。
</code></pre></div></td></tr></table></div>
<ul>
<li>4 net.ipv4.tcp_syncookies = 1</li>
</ul>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Text Only</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-170-1">1</a></span>
<span class="normal"><a href="#__codelineno-170-2">2</a></span>
<span class="normal"><a href="#__codelineno-170-3">3</a></span>
<span class="normal"><a href="#__codelineno-170-4">4</a></span>
<span class="normal"><a href="#__codelineno-170-5">5</a></span>
<span class="normal"><a href="#__codelineno-170-6">6</a></span>
<span class="normal"><a href="#__codelineno-170-7">7</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-170-1" name="__codelineno-170-1"></a>tcp三次握手中，客户端向服务端发起syn请求，服务端收到后，也会向客户端发起syn请求同时连带ack确认，
<a id="__codelineno-170-2" name="__codelineno-170-2"></a>假如客户端发送请求后直接断开和服务端的连接，不接收服务端发起的这个请求，服务端会重试多次，
<a id="__codelineno-170-3" name="__codelineno-170-3"></a>这个重试的过程会持续一段时间（通常高于30s），当这种状态的连接数量非常大时，服务器会消耗很大的资源，从而造成瘫痪，
<a id="__codelineno-170-4" name="__codelineno-170-4"></a>正常的连接进不来，这种恶意的半连接行为其实叫做syn flood攻击。
<a id="__codelineno-170-5" name="__codelineno-170-5"></a>设置为1，是开启SYN Cookies，开启后可以避免发生上述的syn flood攻击。
<a id="__codelineno-170-6" name="__codelineno-170-6"></a>开启该参数后，服务端接收客户端的ack后，再向客户端发送ack+syn之前会要求client在短时间内回应一个序号，
<a id="__codelineno-170-7" name="__codelineno-170-7"></a>如果客户端不能提供序号或者提供的序号不对则认为该客户端不合法，于是不会发ack+syn给客户端，更涉及不到重试。
</code></pre></div></td></tr></table></div>
<ul>
<li>5 net.ipv4.tcp_max_syn_backlog</li>
</ul>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Text Only</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-171-1">1</a></span>
<span class="normal"><a href="#__codelineno-171-2">2</a></span>
<span class="normal"><a href="#__codelineno-171-3">3</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-171-1" name="__codelineno-171-1"></a>该参数定义系统能接受的最大半连接状态的tcp连接数。客户端向服务端发送了syn包，服务端收到后，会记录一下，
<a id="__codelineno-171-2" name="__codelineno-171-2"></a>该参数决定最多能记录几个这样的连接。在CentOS7，默认是256，当有syn flood攻击时，这个数值太小则很容易导致服务器瘫痪，
<a id="__codelineno-171-3" name="__codelineno-171-3"></a>实际上此时服务器并没有消耗太多资源（cpu、内存等），所以可以适当调大它，比如调整到30000。
</code></pre></div></td></tr></table></div>
<ul>
<li>6 net.ipv4.tcp_syn_retries</li>
</ul>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Text Only</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-172-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-172-1" name="__codelineno-172-1"></a>该参数适用于客户端，它定义发起syn的最大重试次数，默认为6，建议改为2。
</code></pre></div></td></tr></table></div>
<ul>
<li>7 net.ipv4.tcp_synack_retries</li>
</ul>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Text Only</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-173-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-173-1" name="__codelineno-173-1"></a>该参数适用于服务端，它定义发起syn+ack的最大重试次数，默认为5，建议改为2，可以适当预防syn flood攻击。
</code></pre></div></td></tr></table></div>
<ul>
<li>8 net.ipv4.ip_local_port_range</li>
</ul>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Text Only</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-174-1">1</a></span>
<span class="normal"><a href="#__codelineno-174-2">2</a></span>
<span class="normal"><a href="#__codelineno-174-3">3</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-174-1" name="__codelineno-174-1"></a>该参数定义端口范围，系统默认保留端口为1024及以下，以上部分为自定义端口。这个参数适用于客户端，
<a id="__codelineno-174-2" name="__codelineno-174-2"></a>当客户端和服务端建立连接时，比如说访问服务端的80端口，客户端随机开启了一个端口和服务端发起连接，
<a id="__codelineno-174-3" name="__codelineno-174-3"></a>这个参数定义随机端口的范围。默认为32768    61000，建议调整为1025 61000。
</code></pre></div></td></tr></table></div>
<ul>
<li>9 net.ipv4.tcp_fin_timeout</li>
</ul>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Text Only</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-175-1">1</a></span>
<span class="normal"><a href="#__codelineno-175-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-175-1" name="__codelineno-175-1"></a>tcp连接的状态中，客户端上有一个是FIN-WAIT-2状态，它是状态变迁为timewait前一个状态。
<a id="__codelineno-175-2" name="__codelineno-175-2"></a>该参数定义不属于任何进程的该连接状态的超时时间，默认值为60，建议调整为6。
</code></pre></div></td></tr></table></div>
<ul>
<li>10 net.ipv4.tcp_keepalive_time</li>
</ul>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Text Only</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-176-1">1</a></span>
<span class="normal"><a href="#__codelineno-176-2">2</a></span>
<span class="normal"><a href="#__codelineno-176-3">3</a></span>
<span class="normal"><a href="#__codelineno-176-4">4</a></span>
<span class="normal"><a href="#__codelineno-176-5">5</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-176-1" name="__codelineno-176-1"></a>tcp连接状态里，有一个是established状态，只有在这个状态下，客户端和服务端才能通信。正常情况下，当通信完毕，
<a id="__codelineno-176-2" name="__codelineno-176-2"></a>客户端或服务端会告诉对方要关闭连接，此时状态就会变为timewait，如果客户端没有告诉服务端，
<a id="__codelineno-176-3" name="__codelineno-176-3"></a>并且服务端也没有告诉客户端关闭的话（例如，客户端那边断网了），此时需要该参数来判定。
<a id="__codelineno-176-4" name="__codelineno-176-4"></a>比如客户端已经断网了，但服务端上本次连接的状态依然是established，服务端为了确认客户端是否断网，
<a id="__codelineno-176-5" name="__codelineno-176-5"></a>就需要每隔一段时间去发一个探测包去确认一下看看对方是否在线。这个时间就由该参数决定。它的默认值为7200秒，建议设置为30秒。
</code></pre></div></td></tr></table></div>
<ul>
<li>11 net.ipv4.tcp_keepalive_intvl</li>
</ul>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Text Only</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-177-1">1</a></span>
<span class="normal"><a href="#__codelineno-177-2">2</a></span>
<span class="normal"><a href="#__codelineno-177-3">3</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-177-1" name="__codelineno-177-1"></a>该参数和上面的参数是一起的，服务端在规定时间内发起了探测，查看客户端是否在线，如果客户端并没有确认，
<a id="__codelineno-177-2" name="__codelineno-177-2"></a>此时服务端还不能认定为对方不在线，而是要尝试多次。该参数定义重新发送探测的时间，即第一次发现对方有问题后，过多久再次发起探测。
<a id="__codelineno-177-3" name="__codelineno-177-3"></a>默认值为75秒，可以改为3秒。
</code></pre></div></td></tr></table></div>
<ul>
<li>12 net.ipv4.tcp_keepalive_probes</li>
</ul>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Text Only</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-178-1">1</a></span>
<span class="normal"><a href="#__codelineno-178-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-178-1" name="__codelineno-178-1"></a>第10和第11个参数规定了何时发起探测和探测失败后再过多久再发起探测，但并没有定义一共探测几次才算结束。
<a id="__codelineno-178-2" name="__codelineno-178-2"></a>该参数定义发起探测的包的数量。默认为9，建议设置2。
</code></pre></div></td></tr></table></div>
<h3 id="设置和范例">设置和范例<a class="headerlink" href="#设置和范例" title="Permanent link">&para;</a></h3>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-179-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-179-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-179-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-179-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-179-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-179-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-179-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-179-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-179-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-179-10">10</a></span>
<span class="normal"><a href="#__codelineno-179-11">11</a></span>
<span class="normal"><a href="#__codelineno-179-12">12</a></span>
<span class="normal"><a href="#__codelineno-179-13">13</a></span>
<span class="normal"><a href="#__codelineno-179-14">14</a></span>
<span class="normal"><a href="#__codelineno-179-15">15</a></span>
<span class="normal"><a href="#__codelineno-179-16">16</a></span>
<span class="normal"><a href="#__codelineno-179-17">17</a></span>
<span class="normal"><a href="#__codelineno-179-18">18</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-179-1" name="__codelineno-179-1"></a>在Linux下调整内核参数，可以直接编辑配置文件/etc/sysctl.conf，然后执行sysctl<span class="w"> </span>-p命令生效
<a id="__codelineno-179-2" name="__codelineno-179-2"></a>vi<span class="w"> </span>/etc/sysctl.conf
<a id="__codelineno-179-3" name="__codelineno-179-3"></a>结合以上分析的各内核参数，范例如下
<a id="__codelineno-179-4" name="__codelineno-179-4"></a>net.ipv4.tcp_fin_timeout<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">6</span>
<a id="__codelineno-179-5" name="__codelineno-179-5"></a>net.ipv4.tcp_keepalive_time<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">30</span>
<a id="__codelineno-179-6" name="__codelineno-179-6"></a>net.ipv4.tcp_max_tw_buckets<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">8000</span>
<a id="__codelineno-179-7" name="__codelineno-179-7"></a>net.ipv4.tcp_tw_reuse<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span>
<a id="__codelineno-179-8" name="__codelineno-179-8"></a>net.ipv4.tcp_tw_recycle<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span>
<a id="__codelineno-179-9" name="__codelineno-179-9"></a>net.ipv4.tcp_syncookies<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span>
<a id="__codelineno-179-10" name="__codelineno-179-10"></a>net.ipv4.tcp_max_syn_backlog<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">30000</span>
<a id="__codelineno-179-11" name="__codelineno-179-11"></a>net.ipv4.tcp_syn_retries<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">2</span>
<a id="__codelineno-179-12" name="__codelineno-179-12"></a>net.ipv4.tcp_synack_retries<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">2</span>
<a id="__codelineno-179-13" name="__codelineno-179-13"></a>net.ipv4.ip_local_port_range<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1025</span><span class="w"> </span><span class="m">61000</span>
<a id="__codelineno-179-14" name="__codelineno-179-14"></a>net.ipv4.tcp_keepalive_intvl<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">3</span>
<a id="__codelineno-179-15" name="__codelineno-179-15"></a>net.ipv4.tcp_keepalive_probes<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">2</span>
<a id="__codelineno-179-16" name="__codelineno-179-16"></a>
<a id="__codelineno-179-17" name="__codelineno-179-17"></a>
<a id="__codelineno-179-18" name="__codelineno-179-18"></a>sysctl<span class="w"> </span>-p
</code></pre></div></td></tr></table></div>
<h2 id="29监控nginx">29.监控nginx<a class="headerlink" href="#29监控nginx" title="Permanent link">&para;</a></h2>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Text Only</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-180-1">1</a></span>
<span class="normal"><a href="#__codelineno-180-2">2</a></span>
<span class="normal"><a href="#__codelineno-180-3">3</a></span>
<span class="normal"><a href="#__codelineno-180-4">4</a></span>
<span class="normal"><a href="#__codelineno-180-5">5</a></span>
<span class="normal"><a href="#__codelineno-180-6">6</a></span>
<span class="normal"><a href="#__codelineno-180-7">7</a></span>
<span class="normal"><a href="#__codelineno-180-8">8</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-180-1" name="__codelineno-180-1"></a>top
<a id="__codelineno-180-2" name="__codelineno-180-2"></a>ps
<a id="__codelineno-180-3" name="__codelineno-180-3"></a>netstat
<a id="__codelineno-180-4" name="__codelineno-180-4"></a>ss
<a id="__codelineno-180-5" name="__codelineno-180-5"></a>lsof
<a id="__codelineno-180-6" name="__codelineno-180-6"></a>tcpdump -nn
<a id="__codelineno-180-7" name="__codelineno-180-7"></a>tcpdump -i eth0
<a id="__codelineno-180-8" name="__codelineno-180-8"></a>日志
</code></pre></div></td></tr></table></div>
<h2 id="30配置nginx状态">30.配置Nginx状态<a class="headerlink" href="#30配置nginx状态" title="Permanent link">&para;</a></h2>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-181-1">1</a></span>
<span class="normal"><a href="#__codelineno-181-2">2</a></span>
<span class="normal"><a href="#__codelineno-181-3">3</a></span>
<span class="normal"><a href="#__codelineno-181-4">4</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-181-1" name="__codelineno-181-1"></a><span class="c1">#Nginx有内置一个状态页，需要在编译的时候指定参数--with-http_stub_status_module参数方可打开。</span>
<a id="__codelineno-181-2" name="__codelineno-181-2"></a><span class="c1">#也就是说，该功能是由http_stub_status_module模块提供，默认没有加载。</span>
<a id="__codelineno-181-3" name="__codelineno-181-3"></a><span class="w"> </span>./configure<span class="w"> </span>--with-http_stub_status_module<span class="w"> </span>--with-http_ssl_module<span class="w"> </span>--prefix<span class="o">=</span>/usr/local/nginx
<a id="__codelineno-181-4" name="__codelineno-181-4"></a><span class="w"> </span>make<span class="w"> </span>install<span class="w"> </span>
</code></pre></div></td></tr></table></div>
<h3 id="nginx配置文件示例">Nginx配置文件示例<a class="headerlink" href="#nginx配置文件示例" title="Permanent link">&para;</a></h3>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Nginx Configuration File</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-182-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-182-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-182-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-182-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-182-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-182-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-182-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-182-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-182-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-182-10">10</a></span>
<span class="normal"><a href="#__codelineno-182-11">11</a></span>
<span class="normal"><a href="#__codelineno-182-12">12</a></span>
<span class="normal"><a href="#__codelineno-182-13">13</a></span>
<span class="normal"><a href="#__codelineno-182-14">14</a></span>
<span class="normal"><a href="#__codelineno-182-15">15</a></span>
<span class="normal"><a href="#__codelineno-182-16">16</a></span>
<span class="normal"><a href="#__codelineno-182-17">17</a></span>
<span class="normal"><a href="#__codelineno-182-18">18</a></span>
<span class="normal"><a href="#__codelineno-182-19">19</a></span>
<span class="normal"><a href="#__codelineno-182-20">20</a></span>
<span class="normal"><a href="#__codelineno-182-21">21</a></span>
<span class="normal"><a href="#__codelineno-182-22">22</a></span>
<span class="normal"><a href="#__codelineno-182-23">23</a></span>
<span class="normal"><a href="#__codelineno-182-24">24</a></span>
<span class="normal"><a href="#__codelineno-182-25">25</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-182-1" name="__codelineno-182-1"></a><span class="k">log_format</span><span class="w"> </span><span class="s">combined_realip</span><span class="w"> </span><span class="s">&#39;</span><span class="nv">$remote_addr</span><span class="w"> </span><span class="nv">$http_x_forwarded_for</span><span class="w"> </span><span class="s">[</span><span class="nv">$time_local]&#39;</span>
<a id="__codelineno-182-2" name="__codelineno-182-2"></a><span class="w">    </span><span class="s">&#39;</span><span class="nv">$host</span><span class="w"> </span><span class="s">&quot;</span><span class="nv">$request_uri&quot;</span><span class="w"> </span><span class="nv">$status&#39;</span>
<a id="__codelineno-182-3" name="__codelineno-182-3"></a><span class="w">    </span><span class="s">&#39;&quot;</span><span class="nv">$http_referer&quot;</span><span class="w"> </span><span class="s">&quot;</span><span class="nv">$http_user_agent&quot;&#39;</span><span class="p">;</span><span class="c1">#定义了一个名为combined_realip的日志格式</span>
<a id="__codelineno-182-4" name="__codelineno-182-4"></a><span class="k">server{</span>
<a id="__codelineno-182-5" name="__codelineno-182-5"></a><span class="w">    </span><span class="s">listen</span><span class="w"> </span><span class="mi">99</span><span class="p">;</span>
<a id="__codelineno-182-6" name="__codelineno-182-6"></a><span class="w">    </span><span class="k">server_name</span><span class="w"> </span><span class="s">localhost</span><span class="p">;</span>
<a id="__codelineno-182-7" name="__codelineno-182-7"></a><span class="w">    </span><span class="k">root</span><span class="w"> </span><span class="s">/usr/local/nginx/html</span><span class="p">;</span>
<a id="__codelineno-182-8" name="__codelineno-182-8"></a><span class="w">    </span><span class="k">index</span><span class="w"> </span><span class="s">index.html</span><span class="w"> </span><span class="s">index.php</span><span class="p">;</span>
<a id="__codelineno-182-9" name="__codelineno-182-9"></a><span class="w">    </span><span class="k">error_log</span><span class="w"> </span><span class="s">/data/logs/localhost.err.log</span><span class="w"> </span><span class="s">debug</span><span class="p">;</span>
<a id="__codelineno-182-10" name="__codelineno-182-10"></a><span class="w">    </span><span class="k">location</span><span class="w"> </span><span class="p">~</span><span class="sr">*</span><span class="w"> </span><span class="s">^.+\.(gif|jpg|png|css|js)</span>$
<a id="__codelineno-182-11" name="__codelineno-182-11"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-182-12" name="__codelineno-182-12"></a><span class="w">        </span><span class="kn">expires</span><span class="w"> </span><span class="s">1d</span><span class="p">;</span><span class="w"> </span><span class="c1">#1d表示1天，也可以用24h表示一天。</span>
<a id="__codelineno-182-13" name="__codelineno-182-13"></a><span class="w">        </span><span class="kn">access_log</span><span class="w"> </span><span class="no">off</span><span class="p">;</span>
<a id="__codelineno-182-14" name="__codelineno-182-14"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-182-15" name="__codelineno-182-15"></a><span class="w">    </span><span class="k">location</span><span class="w"> </span><span class="s">/status/</span><span class="c1">#加上这个location模块</span>
<a id="__codelineno-182-16" name="__codelineno-182-16"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-182-17" name="__codelineno-182-17"></a><span class="w">        </span><span class="kn">stub_status</span><span class="w"> </span><span class="no">on</span><span class="p">;</span>
<a id="__codelineno-182-18" name="__codelineno-182-18"></a><span class="w">        </span><span class="kn">access_log</span><span class="w"> </span><span class="no">off</span><span class="p">;</span>
<a id="__codelineno-182-19" name="__codelineno-182-19"></a><span class="w">        </span><span class="kn">allow</span><span class="w"> </span><span class="mi">127</span><span class="s">.0.0.1</span><span class="p">;</span>
<a id="__codelineno-182-20" name="__codelineno-182-20"></a><span class="w">        </span><span class="kn">allow</span><span class="w"> </span><span class="mi">192</span><span class="s">.168.107.0/24</span><span class="p">;</span>
<a id="__codelineno-182-21" name="__codelineno-182-21"></a><span class="w">        </span><span class="kn">deny</span><span class="w"> </span><span class="s">all</span><span class="p">;</span>
<a id="__codelineno-182-22" name="__codelineno-182-22"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-182-23" name="__codelineno-182-23"></a>
<a id="__codelineno-182-24" name="__codelineno-182-24"></a><span class="w">    </span><span class="k">access_log</span><span class="w"> </span><span class="s">/data/logs/localhost.acc.log</span><span class="w"> </span><span class="s">combined_realip</span><span class="p">;</span>
<a id="__codelineno-182-25" name="__codelineno-182-25"></a><span class="k">}</span>
</code></pre></div></td></tr></table></div>
<p><img alt="image-20230823135833868" src="../Nginx%E5%AD%A6%E4%B9%A0.assets/image-20230823135833868.png" /></p>
<h3 id="配置说明_2">配置说明<a class="headerlink" href="#配置说明_2" title="Permanent link">&para;</a></h3>
<ul>
<li>location /status/这样当访问/status/时即可访问到状态页内容。</li>
<li>stub_status on即打开了状态页。</li>
<li>access_log off不记录日志</li>
<li>allow和deny只允许指定IP和IP段访问，因为这个页面需要保护起来，并不公开，当然也可以做用户认证。</li>
</ul>
<h3 id="测试和结果说明">测试和结果说明<a class="headerlink" href="#测试和结果说明" title="Permanent link">&para;</a></h3>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Text Only</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-183-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-183-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-183-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-183-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-183-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-183-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-183-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-183-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-183-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-183-10">10</a></span>
<span class="normal"><a href="#__codelineno-183-11">11</a></span>
<span class="normal"><a href="#__codelineno-183-12">12</a></span>
<span class="normal"><a href="#__codelineno-183-13">13</a></span>
<span class="normal"><a href="#__codelineno-183-14">14</a></span>
<span class="normal"><a href="#__codelineno-183-15">15</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-183-1" name="__codelineno-183-1"></a>测试命令：curl -x127.0.0.1:80 192.168.107.254：8080/status/
<a id="__codelineno-183-2" name="__codelineno-183-2"></a>
<a id="__codelineno-183-3" name="__codelineno-183-3"></a>结果如下：
<a id="__codelineno-183-4" name="__codelineno-183-4"></a>Active connections: 1 
<a id="__codelineno-183-5" name="__codelineno-183-5"></a>server accepts handled requests
<a id="__codelineno-183-6" name="__codelineno-183-6"></a> 11 11 11 
<a id="__codelineno-183-7" name="__codelineno-183-7"></a>Reading: 0 Writing: 1 Waiting: 0 
<a id="__codelineno-183-8" name="__codelineno-183-8"></a>
<a id="__codelineno-183-9" name="__codelineno-183-9"></a>说明：
<a id="__codelineno-183-10" name="__codelineno-183-10"></a>active connections – 活跃的连接数量
<a id="__codelineno-183-11" name="__codelineno-183-11"></a>server accepts handled requests — 总共处理的连接数、成功创建的握手次数、总共处理的请求次数
<a id="__codelineno-183-12" name="__codelineno-183-12"></a>需要注意，一个连接可以有多次请求。
<a id="__codelineno-183-13" name="__codelineno-183-13"></a>reading — 读取客户端的连接数.
<a id="__codelineno-183-14" name="__codelineno-183-14"></a>writing — 响应数据到客户端的数量
<a id="__codelineno-183-15" name="__codelineno-183-15"></a>waiting — 开启 keep-alive 的情况下,这个值等于 active – (reading+writing), 意思就是 Nginx 已经处理完正在等候下一次请求指令的驻留连接.
</code></pre></div></td></tr></table></div>
<h2 id="31nginx架构-lnmp">31.Nginx架构-LNMP<a class="headerlink" href="#31nginx架构-lnmp" title="Permanent link">&para;</a></h2>
<p>Linux：Linux 操作系统</p>
<p>Nginx：Web 服务器</p>
<p>MariaDB：数据库</p>
<p>PHP：脚本语言</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Nginx Configuration File</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-184-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-184-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-184-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-184-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-184-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-184-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-184-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-184-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-184-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-184-10">10</a></span>
<span class="normal"><a href="#__codelineno-184-11">11</a></span>
<span class="normal"><a href="#__codelineno-184-12">12</a></span>
<span class="normal"><a href="#__codelineno-184-13">13</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-184-1" name="__codelineno-184-1"></a><span class="k">配置如下（在server部分添加）：</span>
<a id="__codelineno-184-2" name="__codelineno-184-2"></a><span class="w">    </span><span class="s">location</span><span class="w"> </span><span class="p">~</span><span class="w"> </span><span class="sr">\.php$</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-184-3" name="__codelineno-184-3"></a><span class="w">        </span><span class="kn">include</span><span class="w"> </span><span class="s">fastcgi_params</span><span class="p">;</span>
<a id="__codelineno-184-4" name="__codelineno-184-4"></a><span class="w">        </span><span class="kn">fastcgi_pass</span><span class="w"> </span><span class="s">unix:/tmp/php-fcgi.sock</span><span class="p">;</span>
<a id="__codelineno-184-5" name="__codelineno-184-5"></a><span class="w">        </span><span class="kn">fastcgi_index</span><span class="w"> </span><span class="s">index.php</span><span class="p">;</span>
<a id="__codelineno-184-6" name="__codelineno-184-6"></a><span class="w">        </span><span class="kn">fastcgi_param</span><span class="w"> </span><span class="s">SCRIPT_FILENAME</span><span class="w"> </span><span class="nv">$document_root$fastcgi_script_name</span><span class="p">;</span>
<a id="__codelineno-184-7" name="__codelineno-184-7"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-184-8" name="__codelineno-184-8"></a>
<a id="__codelineno-184-9" name="__codelineno-184-9"></a><span class="k">配置说明：</span>
<a id="__codelineno-184-10" name="__codelineno-184-10"></a><span class="mi">1</span><span class="w"> </span><span class="s">fastcgi_params文件在/usr/local/nginx/conf/下面，其内容为fastcgi相关的变量</span>
<a id="__codelineno-184-11" name="__codelineno-184-11"></a><span class="mi">2</span><span class="w"> </span><span class="s">fastcgi_pass后面跟的是php-fpm服务监听地址，可以是IP:PORT，也可以是unix</span><span class="w"> </span><span class="s">socket地址，也支持upstream的地址</span>
<a id="__codelineno-184-12" name="__codelineno-184-12"></a><span class="mi">3</span><span class="w"> </span><span class="s">fastcgi_index定义索引页，如果在server内其他部分有定义index参数，该配置可以忽略</span>
<a id="__codelineno-184-13" name="__codelineno-184-13"></a><span class="mi">4</span><span class="w"> </span><span class="s">fastcgi_param这行其实可以在fastcgi_params文件里面定义SCRIPT_FILENAME变量，这个变量如果不定义，php的请求是没办法访问的。</span>
</code></pre></div></td></tr></table></div>
<h3 id="安装mysql">安装MySQL<a class="headerlink" href="#安装mysql" title="Permanent link">&para;</a></h3>
<p>执行以下命令，查看系统中是否已安装 MariaDB。 </p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Text Only</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-185-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-185-1" name="__codelineno-185-1"></a>rpm -qa | grep -i mariadb
</code></pre></div></td></tr></table></div>
<p>返回结果类似如下内容，则表示已存在 MariaDB。</p>
<p><img alt="image-20230823142759387" src="../Nginx%E5%AD%A6%E4%B9%A0.assets/image-20230823142759387.png" />  </p>
<p>为避免安装版本不同造成冲突，请执行以下命令移除已安装的 MariaDB。</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Text Only</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-186-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-186-1" name="__codelineno-186-1"></a> yum -y remove mariadb-5.5.68-1.el7.x86_64 mariadb-server-5.5.68-1.el7.x86_64 mariadb-libs-5.5.68-1.el7.x86_64
</code></pre></div></td></tr></table></div>
<p>若返回结果为空，则说明未预先安装，则执行下一步。</p>
<ol>
<li>执行以下命令，在 <code>/etc/yum.repos.d/</code> 下创建 <code>MariaDB.repo</code> 文件。</li>
</ol>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Text Only</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-187-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-187-1" name="__codelineno-187-1"></a>vi /etc/yum.repos.d/MariaDB.repo
</code></pre></div></td></tr></table></div>
<ol>
<li>按 <strong>i</strong> 切换至编辑模式，写入以下内容，添加 MariaDB 软件库。</li>
</ol>
<p><strong>说明</strong></p>
<p>以下配置使用了腾讯云镜像源，腾讯云镜像源同步 MariaDB 官网源进行更新，可能会出现 MariaDB 10.4 版本源失效问题（本文以在 CentOS 7.6 上安装 MariaDB 10.4.22 版本为例），您可前往 <a href="https://downloads.mariadb.org">MariaDB 官网</a> 获取其他版本及操作系统的 MariaDB 软件库安装信息。</p>
<p>若您的云服务器使用了 <a href="https://cloud.tencent.com/document/product/213/5225">内网服务</a>，则可以将 <code>mirrors.cloud.tencent.com</code> 替换为 <code>mirrors.tencentyun.com</code> 内网地址，内网流量不占用公网流量且速度更快。</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-188-1">1</a></span>
<span class="normal"><a href="#__codelineno-188-2">2</a></span>
<span class="normal"><a href="#__codelineno-188-3">3</a></span>
<span class="normal"><a href="#__codelineno-188-4">4</a></span>
<span class="normal"><a href="#__codelineno-188-5">5</a></span>
<span class="normal"><a href="#__codelineno-188-6">6</a></span>
<span class="normal"><a href="#__codelineno-188-7">7</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-188-1" name="__codelineno-188-1"></a><span class="c1"># MariaDB 10.4 CentOS repository list - created 2019-11-05 11:56 UTC</span>
<a id="__codelineno-188-2" name="__codelineno-188-2"></a><span class="c1"># http://downloads.mariadb.org/mariadb/repositories/</span>
<a id="__codelineno-188-3" name="__codelineno-188-3"></a><span class="o">[</span>mariadb<span class="o">]</span>
<a id="__codelineno-188-4" name="__codelineno-188-4"></a><span class="nv">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>MariaDB
<a id="__codelineno-188-5" name="__codelineno-188-5"></a><span class="nv">baseurl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>https://mirrors.cloud.tencent.com/mariadb/yum/10.4/centos7-amd64
<a id="__codelineno-188-6" name="__codelineno-188-6"></a><span class="nv">gpgkey</span><span class="o">=</span>https://mirrors.cloud.tencent.com/mariadb/yum/RPM-GPG-KEY-MariaDB
<a id="__codelineno-188-7" name="__codelineno-188-7"></a><span class="nv">gpgcheck</span><span class="o">=</span><span class="m">1</span>
</code></pre></div></td></tr></table></div>
<ol>
<li>
<p>按 <strong>Esc</strong>，输入 <strong>:wq</strong>，保存文件并返回。</p>
</li>
<li>
<p>执行以下命令，安装 MariaDB。此步骤耗时较长，请关注安装进度，等待安装完毕。</p>
</li>
</ol>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Text Only</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-189-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-189-1" name="__codelineno-189-1"></a>yum -y install MariaDB-client MariaDB-server
</code></pre></div></td></tr></table></div>
<ol>
<li>执行以下命令，启动 MariaDB 服务。</li>
</ol>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Text Only</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-190-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-190-1" name="__codelineno-190-1"></a>systemctl start mariadb
</code></pre></div></td></tr></table></div>
<ol>
<li>执行以下命令，设置 MariaDB 为开机自启动。</li>
</ol>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Text Only</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-191-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-191-1" name="__codelineno-191-1"></a>systemctl enable mariadb
</code></pre></div></td></tr></table></div>
<ol>
<li>执行以下命令，验证 MariaDB 是否安装成功。</li>
</ol>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Text Only</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-192-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-192-1" name="__codelineno-192-1"></a>mysql
</code></pre></div></td></tr></table></div>
<p>显示结果如下，则成功安装</p>
<ol>
<li>执行以下命令，退出 MariaDB。</li>
</ol>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Text Only</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-193-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-193-1" name="__codelineno-193-1"></a>q
</code></pre></div></td></tr></table></div>
<h3 id="安装php">安装php<a class="headerlink" href="#安装php" title="Permanent link">&para;</a></h3>
<ol>
<li>依次执行以下命令，更新 yum 中 PHP 的软件源。</li>
</ol>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Text Only</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-194-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-194-1" name="__codelineno-194-1"></a>rpm -Uvh https://mirrors.cloud.tencent.com/epel/epel-release-latest-7.noarch.rpm
</code></pre></div></td></tr></table></div>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Text Only</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-195-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-195-1" name="__codelineno-195-1"></a>rpm -Uvh https://mirror.webtatic.com/yum/el7/webtatic-release.rpm
</code></pre></div></td></tr></table></div>
<ol>
<li>执行以下命令，安装 PHP 7.2 所需要的包。</li>
</ol>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Text Only</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-196-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-196-1" name="__codelineno-196-1"></a>yum -y install mod_php72w.x86_64 php72w-cli.x86_64 php72w-common.x86_64 php72w-mysqlnd php72w-fpm.x86_64
</code></pre></div></td></tr></table></div>
<ol>
<li>执行以下命令，启动 PHP-FPM 服务。</li>
</ol>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Text Only</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-197-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-197-1" name="__codelineno-197-1"></a>systemctl start php-fpm
</code></pre></div></td></tr></table></div>
<ol>
<li>执行以下命令，设置 PHP-FPM 服务为开机自启动。</li>
</ol>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Text Only</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-198-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-198-1" name="__codelineno-198-1"></a>systemctl enable php-fpm
</code></pre></div></td></tr></table></div>
<h3 id="安装-nginx">安装 Nginx<a class="headerlink" href="#安装-nginx" title="Permanent link">&para;</a></h3>
<ol>
<li>执行以下命令，在 <code>/etc/yum.repos.d/</code> 下创建 <code>nginx.repo</code> 文件。</li>
</ol>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Text Only</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-199-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-199-1" name="__codelineno-199-1"></a>vi /etc/yum.repos.d/nginx.repo
</code></pre></div></td></tr></table></div>
<ol>
<li>按 <strong>i</strong> 切换至编辑模式，写入以下内容。</li>
</ol>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-200-1">1</a></span>
<span class="normal"><a href="#__codelineno-200-2">2</a></span>
<span class="normal"><a href="#__codelineno-200-3">3</a></span>
<span class="normal"><a href="#__codelineno-200-4">4</a></span>
<span class="normal"><a href="#__codelineno-200-5">5</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-200-1" name="__codelineno-200-1"></a><span class="o">[</span>nginx<span class="o">]</span><span class="w"> </span>
<a id="__codelineno-200-2" name="__codelineno-200-2"></a><span class="nv">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>nginx<span class="w"> </span>repo<span class="w"> </span>
<a id="__codelineno-200-3" name="__codelineno-200-3"></a><span class="nv">baseurl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>https://nginx.org/packages/mainline/centos/7/<span class="nv">$basearch</span>/<span class="w"> </span>
<a id="__codelineno-200-4" name="__codelineno-200-4"></a><span class="nv">gpgcheck</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span><span class="w"> </span>
<a id="__codelineno-200-5" name="__codelineno-200-5"></a><span class="nv">enabled</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span>
</code></pre></div></td></tr></table></div>
<ol>
<li>
<p>按 <strong>Esc</strong>，输入 <strong>:wq</strong>，保存文件并返回。</p>
</li>
<li>
<p>执行以下命令，安装 nginx。</p>
</li>
</ol>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Text Only</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-201-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-201-1" name="__codelineno-201-1"></a>yum install -y nginx
</code></pre></div></td></tr></table></div>
<ol>
<li>执行以下命令，打开 <code>default.conf</code> 文件。</li>
</ol>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Text Only</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-202-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-202-1" name="__codelineno-202-1"></a>vim /usr/local/nginx/conf/vhost/A.conf
</code></pre></div></td></tr></table></div>
<ol>
<li>
<p>按 <strong>i</strong> 切换至编辑模式，编辑 <code>default.conf</code> 文件。</p>
</li>
<li>
<p>找到 <code>server{...}</code>，并将 <code>server</code> 大括号中相应的配置信息替换为如下内容。用于取消对 IPv6 地址的监听，同时配置 Nginx，实现与 PHP 的联动。</p>
</li>
</ol>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-203-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-203-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-203-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-203-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-203-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-203-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-203-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-203-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-203-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-203-10">10</a></span>
<span class="normal"><a href="#__codelineno-203-11">11</a></span>
<span class="normal"><a href="#__codelineno-203-12">12</a></span>
<span class="normal"><a href="#__codelineno-203-13">13</a></span>
<span class="normal"><a href="#__codelineno-203-14">14</a></span>
<span class="normal"><a href="#__codelineno-203-15">15</a></span>
<span class="normal"><a href="#__codelineno-203-16">16</a></span>
<span class="normal"><a href="#__codelineno-203-17">17</a></span>
<span class="normal"><a href="#__codelineno-203-18">18</a></span>
<span class="normal"><a href="#__codelineno-203-19">19</a></span>
<span class="normal"><a href="#__codelineno-203-20">20</a></span>
<span class="normal"><a href="#__codelineno-203-21">21</a></span>
<span class="normal"><a href="#__codelineno-203-22">22</a></span>
<span class="normal"><a href="#__codelineno-203-23">23</a></span>
<span class="normal"><a href="#__codelineno-203-24">24</a></span>
<span class="normal"><a href="#__codelineno-203-25">25</a></span>
<span class="normal"><a href="#__codelineno-203-26">26</a></span>
<span class="normal"><a href="#__codelineno-203-27">27</a></span>
<span class="normal"><a href="#__codelineno-203-28">28</a></span>
<span class="normal"><a href="#__codelineno-203-29">29</a></span>
<span class="normal"><a href="#__codelineno-203-30">30</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-203-1" name="__codelineno-203-1"></a>log_format<span class="w"> </span>combined_realip<span class="w"> </span><span class="s1">&#39;$remote_addr $http_x_forwarded_for [$time_local]&#39;</span>
<a id="__codelineno-203-2" name="__codelineno-203-2"></a><span class="w">    </span><span class="s1">&#39;$host &quot;$request_uri&quot; $status&#39;</span>
<a id="__codelineno-203-3" name="__codelineno-203-3"></a><span class="w">    </span><span class="s1">&#39;&quot;$http_referer&quot; &quot;$http_user_agent&quot;&#39;</span><span class="p">;</span><span class="c1">#定义了一个名为combined_realip的日志格式</span>
<a id="__codelineno-203-4" name="__codelineno-203-4"></a>server<span class="o">{</span>
<a id="__codelineno-203-5" name="__codelineno-203-5"></a><span class="w">    </span>listen<span class="w"> </span><span class="m">99</span><span class="p">;</span>
<a id="__codelineno-203-6" name="__codelineno-203-6"></a><span class="w">    </span>server_name<span class="w"> </span>localhost<span class="p">;</span>
<a id="__codelineno-203-7" name="__codelineno-203-7"></a><span class="w">    </span>root<span class="w"> </span>/usr/local/nginx/html<span class="p">;</span>
<a id="__codelineno-203-8" name="__codelineno-203-8"></a><span class="w">    </span>index<span class="w"> </span>index.html<span class="w"> </span>index.php<span class="p">;</span>
<a id="__codelineno-203-9" name="__codelineno-203-9"></a><span class="w">    </span>error_log<span class="w"> </span>/data/logs/localhost.err.log<span class="w"> </span>debug<span class="p">;</span>
<a id="__codelineno-203-10" name="__codelineno-203-10"></a><span class="w">    </span>location<span class="w"> </span>~*<span class="w"> </span>^.+<span class="se">\.</span><span class="o">(</span>gif<span class="p">|</span>jpg<span class="p">|</span>png<span class="p">|</span>css<span class="p">|</span>js<span class="o">)</span>$
<a id="__codelineno-203-11" name="__codelineno-203-11"></a><span class="w">    </span><span class="o">{</span>
<a id="__codelineno-203-12" name="__codelineno-203-12"></a><span class="w">        </span>expires<span class="w"> </span>1d<span class="p">;</span><span class="w"> </span><span class="c1">#1d表示1天，也可以用24h表示一天。</span>
<a id="__codelineno-203-13" name="__codelineno-203-13"></a><span class="w">        </span>access_log<span class="w"> </span>off<span class="p">;</span>
<a id="__codelineno-203-14" name="__codelineno-203-14"></a><span class="w">    </span><span class="o">}</span>
<a id="__codelineno-203-15" name="__codelineno-203-15"></a><span class="w">    </span>location<span class="w"> </span>/status/
<a id="__codelineno-203-16" name="__codelineno-203-16"></a><span class="w">    </span><span class="o">{</span>
<a id="__codelineno-203-17" name="__codelineno-203-17"></a><span class="w">        </span>stub_status<span class="w"> </span>on<span class="p">;</span>
<a id="__codelineno-203-18" name="__codelineno-203-18"></a><span class="w">        </span>access_log<span class="w"> </span>off<span class="p">;</span>
<a id="__codelineno-203-19" name="__codelineno-203-19"></a><span class="w">        </span>allow<span class="w"> </span><span class="m">127</span>.0.0.1<span class="p">;</span>
<a id="__codelineno-203-20" name="__codelineno-203-20"></a><span class="w">        </span>allow<span class="w"> </span><span class="m">192</span>.168.107.0/24<span class="p">;</span>
<a id="__codelineno-203-21" name="__codelineno-203-21"></a><span class="w">        </span>deny<span class="w"> </span>all<span class="p">;</span>
<a id="__codelineno-203-22" name="__codelineno-203-22"></a><span class="w">    </span><span class="o">}</span>
<a id="__codelineno-203-23" name="__codelineno-203-23"></a><span class="w">    </span>location<span class="w"> </span>~<span class="w"> </span>.php$<span class="w"> </span><span class="o">{</span>
<a id="__codelineno-203-24" name="__codelineno-203-24"></a><span class="w">        </span>fastcgi_pass<span class="w">   </span><span class="m">127</span>.0.0.1:9000<span class="p">;</span>
<a id="__codelineno-203-25" name="__codelineno-203-25"></a><span class="w">        </span>fastcgi_index<span class="w">  </span>index.php<span class="p">;</span>
<a id="__codelineno-203-26" name="__codelineno-203-26"></a><span class="w">        </span>fastcgi_param<span class="w">  </span>SCRIPT_FILENAME<span class="w">  </span><span class="nv">$document_root$fastcgi_script_name</span><span class="p">;</span>
<a id="__codelineno-203-27" name="__codelineno-203-27"></a><span class="w">        </span>include<span class="w">        </span>fastcgi_params<span class="p">;</span>
<a id="__codelineno-203-28" name="__codelineno-203-28"></a><span class="w">    </span><span class="o">}</span>
<a id="__codelineno-203-29" name="__codelineno-203-29"></a><span class="w">    </span>access_log<span class="w"> </span>/data/logs/localhost.acc.log<span class="w"> </span>combined_realip<span class="p">;</span>
<a id="__codelineno-203-30" name="__codelineno-203-30"></a><span class="o">}</span>
</code></pre></div></td></tr></table></div>
<ol>
<li>
<p>按 <strong>Esc</strong>，输入 <strong>:wq</strong>，保存文件并返回。</p>
</li>
<li>
<p>执行以下命令启动 Nginx。</p>
</li>
</ol>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Text Only</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-204-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-204-1" name="__codelineno-204-1"></a>/usr/local/nginx/sbin/nginx -s reload
</code></pre></div></td></tr></table></div>
<h3 id="测试是否解析php文件">测试是否解析php文件<a class="headerlink" href="#测试是否解析php文件" title="Permanent link">&para;</a></h3>
<p>创建测试文件:</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-205-1">1</a></span>
<span class="normal"><a href="#__codelineno-205-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-205-1" name="__codelineno-205-1"></a><span class="nb">echo</span><span class="w"> </span><span class="s1">&#39;&lt;?php echo &quot;hello world php世界上最好的语言&quot;; ?&gt;&#39;</span><span class="w"> </span>&gt;<span class="w"> </span>/usr/local/nginx/html/2.php
<a id="__codelineno-205-2" name="__codelineno-205-2"></a>vi<span class="w"> </span>/usr/local/nginx/conf/vhost/A.conf
</code></pre></div></td></tr></table></div>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Nginx Configuration File</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-206-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-206-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-206-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-206-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-206-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-206-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-206-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-206-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-206-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-206-10">10</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-206-1" name="__codelineno-206-1"></a><span class="k">server{</span>
<a id="__codelineno-206-2" name="__codelineno-206-2"></a><span class="w">    </span><span class="s">...</span>
<a id="__codelineno-206-3" name="__codelineno-206-3"></a><span class="w">    </span><span class="s">location</span><span class="w"> </span><span class="p">~</span><span class="w"> </span><span class="sr">.php$</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-206-4" name="__codelineno-206-4"></a><span class="w">        </span><span class="kn">fastcgi_pass</span><span class="w">   </span><span class="n">127.0.0.1</span><span class="p">:</span><span class="mi">9000</span><span class="p">;</span>
<a id="__codelineno-206-5" name="__codelineno-206-5"></a><span class="w">        </span><span class="kn">fastcgi_index</span><span class="w">  </span><span class="s">index.php</span><span class="p">;</span>
<a id="__codelineno-206-6" name="__codelineno-206-6"></a><span class="w">        </span><span class="kn">fastcgi_param</span><span class="w">  </span><span class="s">SCRIPT_FILENAME</span><span class="w">  </span><span class="nv">$document_root$fastcgi_script_name</span><span class="p">;</span>
<a id="__codelineno-206-7" name="__codelineno-206-7"></a><span class="w">        </span><span class="kn">include</span><span class="w">        </span><span class="s">fastcgi_params</span><span class="p">;</span>
<a id="__codelineno-206-8" name="__codelineno-206-8"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-206-9" name="__codelineno-206-9"></a><span class="w">    </span><span class="k">...</span>
<a id="__codelineno-206-10" name="__codelineno-206-10"></a><span class="err">}</span>
</code></pre></div></td></tr></table></div>
<p>测试:</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Text Only</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-207-1">1</a></span>
<span class="normal"><a href="#__codelineno-207-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-207-1" name="__codelineno-207-1"></a>[root@localhost nginx]# curl localhost/2.php
<a id="__codelineno-207-2" name="__codelineno-207-2"></a>测试php是否解析[root@localhost nginx]#
</code></pre></div></td></tr></table></div>
<p><img alt="image-20230823154155297" src="../Nginx%E5%AD%A6%E4%B9%A0.assets/image-20230823154155297.png" /></p>
<h2 id="32nginxtomcat架构">32.Nginx+Tomcat架构<a class="headerlink" href="#32nginxtomcat架构" title="Permanent link">&para;</a></h2>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Nginx Configuration File</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-208-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-208-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-208-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-208-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-208-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-208-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-208-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-208-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-208-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-208-10">10</a></span>
<span class="normal"><a href="#__codelineno-208-11">11</a></span>
<span class="normal"><a href="#__codelineno-208-12">12</a></span>
<span class="normal"><a href="#__codelineno-208-13">13</a></span>
<span class="normal"><a href="#__codelineno-208-14">14</a></span>
<span class="normal"><a href="#__codelineno-208-15">15</a></span>
<span class="normal"><a href="#__codelineno-208-16">16</a></span>
<span class="normal"><a href="#__codelineno-208-17">17</a></span>
<span class="normal"><a href="#__codelineno-208-18">18</a></span>
<span class="normal"><a href="#__codelineno-208-19">19</a></span>
<span class="normal"><a href="#__codelineno-208-20">20</a></span>
<span class="normal"><a href="#__codelineno-208-21">21</a></span>
<span class="normal"><a href="#__codelineno-208-22">22</a></span>
<span class="normal"><a href="#__codelineno-208-23">23</a></span>
<span class="normal"><a href="#__codelineno-208-24">24</a></span>
<span class="normal"><a href="#__codelineno-208-25">25</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-208-1" name="__codelineno-208-1"></a><span class="k">配置文件示例</span>
<a id="__codelineno-208-2" name="__codelineno-208-2"></a><span class="s">server</span>
<a id="__codelineno-208-3" name="__codelineno-208-3"></a><span class="p">{</span>
<a id="__codelineno-208-4" name="__codelineno-208-4"></a><span class="w">    </span><span class="kn">listen</span><span class="w"> </span><span class="mi">80</span><span class="p">;</span>
<a id="__codelineno-208-5" name="__codelineno-208-5"></a><span class="w">    </span><span class="kn">server_name</span><span class="w"> </span><span class="s">www.liyedong.com</span><span class="p">;</span>
<a id="__codelineno-208-6" name="__codelineno-208-6"></a>
<a id="__codelineno-208-7" name="__codelineno-208-7"></a><span class="w">    </span><span class="kn">location</span><span class="w"> </span><span class="p">~</span><span class="sr">*</span><span class="w"> </span><span class="s">&quot;\.(jpg|png|jepg|js|css|xml|bmp|swf|gif|html)</span><span class="nv">$&quot;</span>
<a id="__codelineno-208-8" name="__codelineno-208-8"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-208-9" name="__codelineno-208-9"></a><span class="w">        </span><span class="kn">root</span><span class="w"> </span><span class="s">/data/wwwroot/www.liyedong.com/</span><span class="p">;</span>
<a id="__codelineno-208-10" name="__codelineno-208-10"></a><span class="w">        </span><span class="kn">access_log</span><span class="w"> </span><span class="no">off</span><span class="p">;</span>
<a id="__codelineno-208-11" name="__codelineno-208-11"></a><span class="w">        </span><span class="kn">expire</span><span class="w"> </span><span class="s">7d</span><span class="p">;</span>
<a id="__codelineno-208-12" name="__codelineno-208-12"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-208-13" name="__codelineno-208-13"></a>
<a id="__codelineno-208-14" name="__codelineno-208-14"></a><span class="w">    </span><span class="kn">location</span><span class="w"> </span><span class="s">/</span>
<a id="__codelineno-208-15" name="__codelineno-208-15"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-208-16" name="__codelineno-208-16"></a><span class="w">        </span><span class="kn">proxy_pass</span><span class="w"> </span><span class="s">http://127.0.0.1:8080/</span><span class="p">;</span>
<a id="__codelineno-208-17" name="__codelineno-208-17"></a><span class="w">        </span><span class="kn">proxy_set_header</span><span class="w"> </span><span class="s">Host</span><span class="w"> </span><span class="nv">$host</span><span class="p">;</span>
<a id="__codelineno-208-18" name="__codelineno-208-18"></a><span class="w">        </span><span class="kn">proxy_set_header</span><span class="w"> </span><span class="s">X-Real-IP</span><span class="w">      </span><span class="nv">$remote_addr</span><span class="p">;</span>
<a id="__codelineno-208-19" name="__codelineno-208-19"></a><span class="w">        </span><span class="kn">proxy_set_header</span><span class="w"> </span><span class="s">X-Forwarded-For</span><span class="w"> </span><span class="nv">$proxy_add_x_forwarded_for</span><span class="p">;</span>
<a id="__codelineno-208-20" name="__codelineno-208-20"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-208-21" name="__codelineno-208-21"></a><span class="p">}</span>
<a id="__codelineno-208-22" name="__codelineno-208-22"></a>
<a id="__codelineno-208-23" name="__codelineno-208-23"></a><span class="k">说明：</span>
<a id="__codelineno-208-24" name="__codelineno-208-24"></a><span class="mi">1</span><span class="w"> </span><span class="s">首先，把各种静态文件的请求分离出来，单独由nginx处理。</span>
<a id="__codelineno-208-25" name="__codelineno-208-25"></a><span class="mi">2</span><span class="w"> </span><span class="s">其他请求直接代理8080端口，即tomcat服务,也可使用负载均衡。</span>
</code></pre></div></td></tr></table></div>
<h2 id="33nginxkeepalived高可用架构">33.nginx+keepalived高可用架构<a class="headerlink" href="#33nginxkeepalived高可用架构" title="Permanent link">&para;</a></h2>
<table>
<thead>
<tr>
<th style="text-align: center;">ip</th>
<th style="text-align: center;">192.168.107.254（eth0）</th>
<th style="text-align: center;">192.168.107.253(eth0)</th>
<th style="text-align: center;">192.168.107.188（虚拟ip）</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;">环境</td>
<td style="text-align: center;">centos7+nginx+keepalived</td>
<td style="text-align: center;">centos7+nginx+keepalived</td>
<td style="text-align: center;"></td>
</tr>
</tbody>
</table>
<h3 id="1keepalived">1、keepalived<a class="headerlink" href="#1keepalived" title="Permanent link">&para;</a></h3>
<p>我们可以通过 keepalived 来实现 Nginx 的高可用，keepalived 是集群管理中保证集群高可用的一个服务软件，用来防止单点故障。Keepalived的作用是检测 web 服务器的状态，如果有一台 web 服务器死机或工作出现故障，Keepalived 将能检测到，并将有故障的 web 服务器从系统中剔除，当web服务器工作正常后 Keepalived 会自动将该 web 服务器加入到服务器群中。这些工作全部都会自动完成，不需要人工干涉，需要人工做的只是修复故障的web服务器。keepalived 可以理解为一个健康检查的软件。</p>
<p>高可用至少需要 2 台服务器，主备都得装上keepalived，当请求访问主服务器时，备份服务器会一直检查主服务器的状态。</p>
<p>keepalived 需要绑定一个虚拟地址 vip ( Virtual IP Address ) ，这个虚拟 ip 地址绑定在哪台服务器上请求就会发送到哪台服务器，一开始会绑定在主服务器上。</p>
<p><img alt="image-20230823162104127" src="../Nginx%E5%AD%A6%E4%B9%A0.assets/image-20230823162104127.png" /></p>
<h3 id="2安装-keepalived">2、安装 keepalived<a class="headerlink" href="#2安装-keepalived" title="Permanent link">&para;</a></h3>
<p>首先准备两台服务器，这里我们准备了两台虚拟机。分别在这两台服务器上安装 Nginx 和 keepalived。</p>
<p>安装 keepalived 使用 yum 方式直接安装即可，该方式会自动安装依赖。安装 keepalived 命令：</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-209-1">1</a></span>
<span class="normal"><a href="#__codelineno-209-2">2</a></span>
<span class="normal"><a href="#__codelineno-209-3">3</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-209-1" name="__codelineno-209-1"></a>yum<span class="w"> </span>-y<span class="w"> </span>install<span class="w"> </span>keepalived
<a id="__codelineno-209-2" name="__codelineno-209-2"></a>rpm<span class="w"> </span>-qa<span class="w"> </span>keepalived
<a id="__codelineno-209-3" name="__codelineno-209-3"></a>cat<span class="w"> </span>/etc/keepalived/keepalived.conf<span class="w">  </span><span class="c1">#keepalived 配置文件</span>
</code></pre></div></td></tr></table></div>
<h3 id="3完成高可用配置">3、完成高可用配置<a class="headerlink" href="#3完成高可用配置" title="Permanent link">&para;</a></h3>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Text Only</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-210-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-210-1" name="__codelineno-210-1"></a>vi /etc/keepalived/keepalived.conf
</code></pre></div></td></tr></table></div>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Nginx Configuration File</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-211-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-211-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-211-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-211-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-211-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-211-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-211-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-211-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-211-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-211-10">10</a></span>
<span class="normal"><a href="#__codelineno-211-11">11</a></span>
<span class="normal"><a href="#__codelineno-211-12">12</a></span>
<span class="normal"><a href="#__codelineno-211-13">13</a></span>
<span class="normal"><a href="#__codelineno-211-14">14</a></span>
<span class="normal"><a href="#__codelineno-211-15">15</a></span>
<span class="normal"><a href="#__codelineno-211-16">16</a></span>
<span class="normal"><a href="#__codelineno-211-17">17</a></span>
<span class="normal"><a href="#__codelineno-211-18">18</a></span>
<span class="normal"><a href="#__codelineno-211-19">19</a></span>
<span class="normal"><a href="#__codelineno-211-20">20</a></span>
<span class="normal"><a href="#__codelineno-211-21">21</a></span>
<span class="normal"><a href="#__codelineno-211-22">22</a></span>
<span class="normal"><a href="#__codelineno-211-23">23</a></span>
<span class="normal"><a href="#__codelineno-211-24">24</a></span>
<span class="normal"><a href="#__codelineno-211-25">25</a></span>
<span class="normal"><a href="#__codelineno-211-26">26</a></span>
<span class="normal"><a href="#__codelineno-211-27">27</a></span>
<span class="normal"><a href="#__codelineno-211-28">28</a></span>
<span class="normal"><a href="#__codelineno-211-29">29</a></span>
<span class="normal"><a href="#__codelineno-211-30">30</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-211-1" name="__codelineno-211-1"></a><span class="k">global_defs</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-211-2" name="__codelineno-211-2"></a><span class="w">    </span><span class="kn">notification_email</span><span class="w"> </span><span class="p">{</span><span class="w">   </span><span class="c1"># keepalived服务宕机异常出现的时候，发送通知邮件 可以是多个</span>
<a id="__codelineno-211-3" name="__codelineno-211-3"></a><span class="w">      </span><span class="kn">acassen@firewall.loc</span><span class="w">  </span><span class="c1">#  收件人邮箱1</span>
<a id="__codelineno-211-4" name="__codelineno-211-4"></a><span class="w">      </span><span class="s">failover@firewall.loc</span><span class="w">   </span><span class="c1">#  收件人邮箱2</span>
<a id="__codelineno-211-5" name="__codelineno-211-5"></a><span class="w">      </span><span class="s">sysadmin@firewall.loc</span><span class="w">   </span><span class="c1">#  收件人邮箱3</span>
<a id="__codelineno-211-6" name="__codelineno-211-6"></a><span class="w">    </span><span class="err">}</span>
<a id="__codelineno-211-7" name="__codelineno-211-7"></a><span class="w">    </span><span class="s">notification_email_from</span><span class="w"> </span><span class="s">Alexandre.Cassen@firewall.loc</span><span class="w">   </span><span class="c1">#邮件发件人</span>
<a id="__codelineno-211-8" name="__codelineno-211-8"></a><span class="w">    </span><span class="s">smtp_</span><span class="w"> </span><span class="s">server</span><span class="w"> </span><span class="mi">192</span><span class="s">.168.107.254</span><span class="w">  </span><span class="c1">#主服务器的ip地址。邮件服务器地址</span>
<a id="__codelineno-211-9" name="__codelineno-211-9"></a><span class="w">    </span><span class="s">smtp_connect_timeout</span><span class="w"> </span><span class="mi">30</span><span class="w">    </span><span class="c1"># 超时时间</span>
<a id="__codelineno-211-10" name="__codelineno-211-10"></a><span class="w">    </span><span class="s">router_id</span><span class="w"> </span><span class="s">LVS_DEVEL</span><span class="w">    </span><span class="c1"># 机器标识 局域网内唯一即可。 LVS_DEVEL这字段在/etc/hosts文件中看；通过它访问到主机</span>
<a id="__codelineno-211-11" name="__codelineno-211-11"></a><span class="err">}</span>
<a id="__codelineno-211-12" name="__codelineno-211-12"></a><span class="s">vrrp_script</span><span class="w"> </span><span class="s">chk_http_</span><span class="w"> </span><span class="s">port</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-211-13" name="__codelineno-211-13"></a><span class="w">    </span><span class="kn">script</span><span class="w"> </span><span class="s">&quot;/usr/local/nginx/sbin/nginx_check.sh&quot;</span><span class="w">   </span><span class="c1">#检测脚本</span>
<a id="__codelineno-211-14" name="__codelineno-211-14"></a><span class="w">    </span><span class="s">interval</span><span class="w"> </span><span class="mi">2</span><span class="w">   </span><span class="c1"># 检测脚本执行的间隔，即检测脚本每隔2s会自动执行一次</span>
<a id="__codelineno-211-15" name="__codelineno-211-15"></a><span class="w">    </span><span class="s">weight</span><span class="w"> </span><span class="mi">2</span><span class="w">  </span><span class="c1">#权重，如果这个脚本检测为真，服务器权重+2</span>
<a id="__codelineno-211-16" name="__codelineno-211-16"></a><span class="err">}</span>
<a id="__codelineno-211-17" name="__codelineno-211-17"></a><span class="s">vrrp_instance</span><span class="w"> </span><span class="s">VI_1</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-211-18" name="__codelineno-211-18"></a><span class="w">    </span><span class="kn">state</span><span class="w"> </span><span class="s">MASTER</span><span class="w">    </span><span class="c1"># 指定keepalived的角色，MASTER为主，BACKUP为备。备份服务器上需将MASTER 改为BACKUP</span>
<a id="__codelineno-211-19" name="__codelineno-211-19"></a><span class="w">    </span><span class="s">interface</span><span class="w"> </span><span class="s">eth0</span><span class="w">  </span><span class="c1"># 通信端口 通过ip addr可以看到，根据自己的机器配置</span>
<a id="__codelineno-211-20" name="__codelineno-211-20"></a><span class="w">    </span><span class="s">virtual_router_id</span><span class="w"> </span><span class="mi">51</span><span class="w"> </span><span class="c1"># vrrp实例id  keepalived集群的实例id必须一致，即主、备机的virtual_router_id必须相同</span>
<a id="__codelineno-211-21" name="__codelineno-211-21"></a><span class="w">    </span><span class="s">priority</span><span class="w"> </span><span class="mi">100</span><span class="w">         </span><span class="c1">#优先级，数值越大，获取处理请求的优先级越高。主、备机取不同的优先级，主机值较大，备份机值较小</span>
<a id="__codelineno-211-22" name="__codelineno-211-22"></a><span class="w">    </span><span class="s">advert_int</span><span class="w"> </span><span class="mi">1</span><span class="w">    </span><span class="c1">#心跳间隔，默认为1s。keepalived多机器集群 通过心跳检测当前服务器是否还正常工作，如果发送心跳没反应，备份服务器就会立刻接管；</span>
<a id="__codelineno-211-23" name="__codelineno-211-23"></a><span class="w">    </span><span class="s">authentication</span><span class="w"> </span><span class="p">{</span><span class="w">     </span><span class="c1"># 服务器之间通信密码</span>
<a id="__codelineno-211-24" name="__codelineno-211-24"></a><span class="w">        </span><span class="kn">auth</span><span class="w"> </span><span class="s">type</span><span class="w"> </span><span class="s">PASS</span><span class="w">   </span><span class="c1">#设置验证类型和密码，MASTER和BACKUP必须使用相同的密码才能正常通信</span>
<a id="__codelineno-211-25" name="__codelineno-211-25"></a><span class="w">        </span><span class="s">auth</span><span class="w"> </span><span class="s">pass</span><span class="w"> </span><span class="mi">1111</span>
<a id="__codelineno-211-26" name="__codelineno-211-26"></a><span class="w">    </span><span class="err">}</span>
<a id="__codelineno-211-27" name="__codelineno-211-27"></a><span class="w">    </span><span class="s">virtual_ipaddress</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1"># 自定义虚拟IP。自定义的虚拟ip得根据真实ip设置。比如真实ip是192.168.91.138，那么虚拟ip可以设置为192.168.91.139~255，前面三个数得一致</span>
<a id="__codelineno-211-28" name="__codelineno-211-28"></a><span class="w">        </span><span class="kn">192.168.107.188</span><span class="w"> </span><span class="c1"># 定义虚拟ip(VIP)，可多设，每行一个</span>
<a id="__codelineno-211-29" name="__codelineno-211-29"></a><span class="w">    </span><span class="err">}</span>
<a id="__codelineno-211-30" name="__codelineno-211-30"></a><span class="err">}</span>
</code></pre></div></td></tr></table></div>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Text Only</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-212-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-212-1" name="__codelineno-212-1"></a>vi /etc/keepalived/keepalived.conf
</code></pre></div></td></tr></table></div>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Nginx Configuration File</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-213-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-213-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-213-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-213-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-213-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-213-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-213-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-213-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-213-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-213-10">10</a></span>
<span class="normal"><a href="#__codelineno-213-11">11</a></span>
<span class="normal"><a href="#__codelineno-213-12">12</a></span>
<span class="normal"><a href="#__codelineno-213-13">13</a></span>
<span class="normal"><a href="#__codelineno-213-14">14</a></span>
<span class="normal"><a href="#__codelineno-213-15">15</a></span>
<span class="normal"><a href="#__codelineno-213-16">16</a></span>
<span class="normal"><a href="#__codelineno-213-17">17</a></span>
<span class="normal"><a href="#__codelineno-213-18">18</a></span>
<span class="normal"><a href="#__codelineno-213-19">19</a></span>
<span class="normal"><a href="#__codelineno-213-20">20</a></span>
<span class="normal"><a href="#__codelineno-213-21">21</a></span>
<span class="normal"><a href="#__codelineno-213-22">22</a></span>
<span class="normal"><a href="#__codelineno-213-23">23</a></span>
<span class="normal"><a href="#__codelineno-213-24">24</a></span>
<span class="normal"><a href="#__codelineno-213-25">25</a></span>
<span class="normal"><a href="#__codelineno-213-26">26</a></span>
<span class="normal"><a href="#__codelineno-213-27">27</a></span>
<span class="normal"><a href="#__codelineno-213-28">28</a></span>
<span class="normal"><a href="#__codelineno-213-29">29</a></span>
<span class="normal"><a href="#__codelineno-213-30">30</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-213-1" name="__codelineno-213-1"></a><span class="k">global_defs</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-213-2" name="__codelineno-213-2"></a><span class="w">    </span><span class="kn">notification_email</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-213-3" name="__codelineno-213-3"></a><span class="w">      </span><span class="kn">acassen@firewall.loc</span>
<a id="__codelineno-213-4" name="__codelineno-213-4"></a><span class="w">      </span><span class="s">failover@firewall.loc</span>
<a id="__codelineno-213-5" name="__codelineno-213-5"></a><span class="w">      </span><span class="s">sysadmin@firewall.loc</span>
<a id="__codelineno-213-6" name="__codelineno-213-6"></a><span class="w">    </span><span class="err">}</span>
<a id="__codelineno-213-7" name="__codelineno-213-7"></a><span class="w">    </span><span class="s">notification_email_from</span><span class="w"> </span><span class="s">Alexandre.Cassen@firewall.loc</span>
<a id="__codelineno-213-8" name="__codelineno-213-8"></a><span class="w">    </span><span class="s">smtp_</span><span class="w"> </span><span class="s">server</span><span class="w"> </span><span class="mi">192</span><span class="s">.168.107.253</span><span class="w">    </span><span class="c1">#备份服务器的ip地址</span>
<a id="__codelineno-213-9" name="__codelineno-213-9"></a><span class="w">    </span><span class="s">smtp_connect_timeout</span><span class="w"> </span><span class="mi">30</span>
<a id="__codelineno-213-10" name="__codelineno-213-10"></a><span class="w">    </span><span class="s">router_id</span><span class="w"> </span><span class="s">LVS_DEVEL</span><span class="w">    </span><span class="c1"># LVS_DEVEL这字段在/etc/hosts文件中看；通过它访问到主机</span>
<a id="__codelineno-213-11" name="__codelineno-213-11"></a><span class="err">}</span>
<a id="__codelineno-213-12" name="__codelineno-213-12"></a><span class="s">vrrp_script</span><span class="w"> </span><span class="s">chk_http_</span><span class="w"> </span><span class="s">port</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-213-13" name="__codelineno-213-13"></a><span class="w">    </span><span class="kn">script</span><span class="w"> </span><span class="s">&quot;/usr/local/nginx/sbin/nginx_check.sh&quot;</span><span class="w">   </span><span class="c1">#检测脚本</span>
<a id="__codelineno-213-14" name="__codelineno-213-14"></a><span class="w">    </span><span class="s">interval</span><span class="w"> </span><span class="mi">2</span><span class="w">   </span><span class="c1"># (检测脚本执行的间隔)2s</span>
<a id="__codelineno-213-15" name="__codelineno-213-15"></a><span class="w">    </span><span class="s">weight</span><span class="w"> </span><span class="mi">2</span><span class="w">  </span><span class="c1">#权重，如果这个脚本检测为真，服务器权重+2</span>
<a id="__codelineno-213-16" name="__codelineno-213-16"></a><span class="err">}</span>
<a id="__codelineno-213-17" name="__codelineno-213-17"></a><span class="s">vrrp_instance</span><span class="w"> </span><span class="s">VI_1</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-213-18" name="__codelineno-213-18"></a><span class="w">    </span><span class="kn">state</span><span class="w"> </span><span class="s">BACKUP</span><span class="w">    </span><span class="c1"># 指定keepalived的角色，MASTER为主，BACKUP为备。备份服务器上需将MASTER 改为BACKUP</span>
<a id="__codelineno-213-19" name="__codelineno-213-19"></a><span class="w">    </span><span class="s">interface</span><span class="w"> </span><span class="s">eth0</span><span class="w"> </span><span class="c1"># 当前进行vrrp通讯的网络接口卡(当前centos的网卡) 用ifconfig查看你具体的网卡</span>
<a id="__codelineno-213-20" name="__codelineno-213-20"></a><span class="w">    </span><span class="s">virtual_router_id</span><span class="w"> </span><span class="mi">51</span><span class="w"> </span><span class="c1"># 虚拟路由编号，主、备机的virtual_router_id必须相同</span>
<a id="__codelineno-213-21" name="__codelineno-213-21"></a><span class="w">    </span><span class="s">priority</span><span class="w"> </span><span class="mi">90</span><span class="w">         </span><span class="c1">#优先级，数值越大，获取处理请求的优先级越高。主、备机取不同的优先级，主机值较大，备份机值较小</span>
<a id="__codelineno-213-22" name="__codelineno-213-22"></a><span class="w">    </span><span class="s">advert_int</span><span class="w"> </span><span class="mi">1</span><span class="w">    </span><span class="c1"># 检查间隔，默认为1s(vrrp组播周期秒数)，每隔1s发送一次心跳</span>
<a id="__codelineno-213-23" name="__codelineno-213-23"></a><span class="w">    </span><span class="s">authentication</span><span class="w"> </span><span class="p">{</span><span class="w">     </span><span class="c1"># 校验方式， 类型是密码，密码1111</span>
<a id="__codelineno-213-24" name="__codelineno-213-24"></a><span class="w">        </span><span class="kn">auth</span><span class="w"> </span><span class="s">type</span><span class="w"> </span><span class="s">PASS</span><span class="w">   </span><span class="c1">#设置验证类型和密码，MASTER和BACKUP必须使用相同的密码才能正常通信</span>
<a id="__codelineno-213-25" name="__codelineno-213-25"></a><span class="w">        </span><span class="s">auth</span><span class="w"> </span><span class="s">pass</span><span class="w"> </span><span class="mi">1111</span>
<a id="__codelineno-213-26" name="__codelineno-213-26"></a><span class="w">    </span><span class="err">}</span>
<a id="__codelineno-213-27" name="__codelineno-213-27"></a><span class="w">    </span><span class="s">virtual_ipaddress</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1"># 虛拟ip</span>
<a id="__codelineno-213-28" name="__codelineno-213-28"></a><span class="w">        </span><span class="kn">192.168.107.188</span><span class="w"> </span><span class="c1"># 定义虚拟ip(VIP)，可多设，每行一个</span>
<a id="__codelineno-213-29" name="__codelineno-213-29"></a><span class="w">    </span><span class="err">}</span>
<a id="__codelineno-213-30" name="__codelineno-213-30"></a><span class="err">}</span>
</code></pre></div></td></tr></table></div>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-214-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-214-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-214-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-214-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-214-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-214-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-214-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-214-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-214-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-214-10">10</a></span>
<span class="normal"><a href="#__codelineno-214-11">11</a></span>
<span class="normal"><a href="#__codelineno-214-12">12</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-214-1" name="__codelineno-214-1"></a><span class="c1">#编辑脚本</span>
<a id="__codelineno-214-2" name="__codelineno-214-2"></a>vi<span class="w"> </span>/usr/local/nginx/sbin/nginx_check.sh
<a id="__codelineno-214-3" name="__codelineno-214-3"></a><span class="w">    </span><span class="c1">#! /bin/bash</span>
<a id="__codelineno-214-4" name="__codelineno-214-4"></a><span class="w">    </span><span class="c1">#检测nginx是否启动了</span>
<a id="__codelineno-214-5" name="__codelineno-214-5"></a><span class="w">    </span><span class="nv">A</span><span class="o">=</span><span class="sb">`</span>ps<span class="w"> </span>-C<span class="w"> </span>nginx<span class="w"> </span>-no-header<span class="w"> </span><span class="p">|</span><span class="w"> </span>wc<span class="w"> </span>-<span class="w"> </span><span class="m">1</span><span class="sb">`</span>
<a id="__codelineno-214-6" name="__codelineno-214-6"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="nv">$A</span><span class="w"> </span>-eq<span class="w"> </span><span class="m">0</span><span class="o">]</span><span class="p">;</span><span class="k">then</span><span class="w">    </span><span class="c1">#如果nginx没有启动就启动nginx </span>
<a id="__codelineno-214-7" name="__codelineno-214-7"></a><span class="w">        </span>/usr/local/nginx/sbin/nginx<span class="w">    </span><span class="c1">#通过Nginx的启动脚本来重启nginx</span>
<a id="__codelineno-214-8" name="__codelineno-214-8"></a><span class="w">        </span>sleep<span class="w"> </span><span class="m">2</span>
<a id="__codelineno-214-9" name="__codelineno-214-9"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="sb">`</span>ps<span class="w"> </span>-C<span class="w"> </span>nginx<span class="w"> </span>--no-header<span class="p">|</span><span class="w"> </span>wc<span class="w"> </span>-1<span class="sb">`</span><span class="w"> </span>-eq<span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="k">then</span><span class="w">   </span><span class="c1">#如果nginx重启失败，则下面就会停掉keepalived服务，进行VIP转移</span>
<a id="__codelineno-214-10" name="__codelineno-214-10"></a><span class="w">            </span>killall<span class="w"> </span>keepalived
<a id="__codelineno-214-11" name="__codelineno-214-11"></a><span class="w">        </span><span class="k">fi</span>
<a id="__codelineno-214-12" name="__codelineno-214-12"></a><span class="w">    </span><span class="k">fi</span><span class="w">  </span>
</code></pre></div></td></tr></table></div>
<h3 id="4开启服务并且测试">4、开启服务并且测试<a class="headerlink" href="#4开启服务并且测试" title="Permanent link">&para;</a></h3>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-215-1">1</a></span>
<span class="normal"><a href="#__codelineno-215-2">2</a></span>
<span class="normal"><a href="#__codelineno-215-3">3</a></span>
<span class="normal"><a href="#__codelineno-215-4">4</a></span>
<span class="normal"><a href="#__codelineno-215-5">5</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-215-1" name="__codelineno-215-1"></a>/usr/local/nginx/sbin/nginx<span class="w"> </span>-s<span class="w"> </span>stop<span class="w">   </span><span class="c1">#因为已经启动了，所以先关闭 Nginx</span>
<a id="__codelineno-215-2" name="__codelineno-215-2"></a>/usr/local/nginx/sbin/nginx<span class="w">   </span><span class="c1">#启动Nginx</span>
<a id="__codelineno-215-3" name="__codelineno-215-3"></a>ps<span class="w"> </span>-ef<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>nginx<span class="w">  </span><span class="c1">#查看 Nginx 进程的状态</span>
<a id="__codelineno-215-4" name="__codelineno-215-4"></a>systemctl<span class="w"> </span>start<span class="w"> </span>keepalived.service<span class="w">    </span><span class="c1">#启动keepalived</span>
<a id="__codelineno-215-5" name="__codelineno-215-5"></a>ps<span class="w"> </span>-ef<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>keepalived<span class="w">  </span><span class="c1">#查看 keepalived 进程的状态</span>
</code></pre></div></td></tr></table></div>
<p>开始测试</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Text Only</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-216-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-216-1" name="__codelineno-216-1"></a>ip addr #master启用了虚拟ip backup因为是备用机 所以会在master宕机后才绑定虚拟ip
</code></pre></div></td></tr></table></div>
<p><img alt="image-20230823171057379" src="../Nginx%E5%AD%A6%E4%B9%A0.assets/image-20230823171057379.png" /></p>
<p><img alt="image-20230823171131626" src="../Nginx%E5%AD%A6%E4%B9%A0.assets/image-20230823171131626.png" /></p>
<p>编写两个不一样的php脚本来判断是否会访问到备用机</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Text Only</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-217-1">1</a></span>
<span class="normal"><a href="#__codelineno-217-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-217-1" name="__codelineno-217-1"></a>echo &#39;i am master&#39; &gt; /usr/local/nginx/html/testkeeplived.php
<a id="__codelineno-217-2" name="__codelineno-217-2"></a>echo &#39;i am backup&#39; &gt; /usr/local/nginx/html/testkeeplived.php
</code></pre></div></td></tr></table></div>
<p><img alt="image-20230823171539675" src="../Nginx%E5%AD%A6%E4%B9%A0.assets/image-20230823171539675.png" /></p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-218-1">1</a></span>
<span class="normal"><a href="#__codelineno-218-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-218-1" name="__codelineno-218-1"></a>systemctl<span class="w"> </span>stop<span class="w"> </span>keepalived.service<span class="w">   </span><span class="c1"># 关闭keepalived</span>
<a id="__codelineno-218-2" name="__codelineno-218-2"></a>/usr/local/nginx/sbin/nginx<span class="w"> </span>-s<span class="w"> </span>stop<span class="w">  </span><span class="c1"># 关闭Nginx</span>
</code></pre></div></td></tr></table></div>
<p><img alt="image-20230823173524605" src="../Nginx%E5%AD%A6%E4%B9%A0.assets/image-20230823173524605.png" /></p>
<p><img alt="image-20230823173654144" src="../Nginx%E5%AD%A6%E4%B9%A0.assets/image-20230823173654144.png" /></p>
<p>再次启动master主机服务观察backup备用机状态</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-219-1">1</a></span>
<span class="normal"><a href="#__codelineno-219-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-219-1" name="__codelineno-219-1"></a>/usr/local/nginx/sbin/nginx<span class="w">   </span><span class="c1">#启动Nginx</span>
<a id="__codelineno-219-2" name="__codelineno-219-2"></a>systemctl<span class="w"> </span>start<span class="w"> </span>keepalived.service
</code></pre></div></td></tr></table></div>
<p><img alt="image-20230823173818431" src="../Nginx%E5%AD%A6%E4%B9%A0.assets/image-20230823173818431.png" /></p>
<p><img alt="image-20230823173840441" src="../Nginx%E5%AD%A6%E4%B9%A0.assets/image-20230823173840441.png" /></p>
<h2 id="34nginx运维规范">34.nginx运维规范<a class="headerlink" href="#34nginx运维规范" title="Permanent link">&para;</a></h2>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-220-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-220-1" name="__codelineno-220-1"></a>vi<span class="w"> </span>/etc/init.d/nginx
</code></pre></div></td></tr></table></div>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-221-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-221-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-221-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-221-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-221-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-221-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-221-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-221-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-221-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-221-10">10</a></span>
<span class="normal"><a href="#__codelineno-221-11">11</a></span>
<span class="normal"><a href="#__codelineno-221-12">12</a></span>
<span class="normal"><a href="#__codelineno-221-13">13</a></span>
<span class="normal"><a href="#__codelineno-221-14">14</a></span>
<span class="normal"><a href="#__codelineno-221-15">15</a></span>
<span class="normal"><a href="#__codelineno-221-16">16</a></span>
<span class="normal"><a href="#__codelineno-221-17">17</a></span>
<span class="normal"><a href="#__codelineno-221-18">18</a></span>
<span class="normal"><a href="#__codelineno-221-19">19</a></span>
<span class="normal"><a href="#__codelineno-221-20">20</a></span>
<span class="normal"><a href="#__codelineno-221-21">21</a></span>
<span class="normal"><a href="#__codelineno-221-22">22</a></span>
<span class="normal"><a href="#__codelineno-221-23">23</a></span>
<span class="normal"><a href="#__codelineno-221-24">24</a></span>
<span class="normal"><a href="#__codelineno-221-25">25</a></span>
<span class="normal"><a href="#__codelineno-221-26">26</a></span>
<span class="normal"><a href="#__codelineno-221-27">27</a></span>
<span class="normal"><a href="#__codelineno-221-28">28</a></span>
<span class="normal"><a href="#__codelineno-221-29">29</a></span>
<span class="normal"><a href="#__codelineno-221-30">30</a></span>
<span class="normal"><a href="#__codelineno-221-31">31</a></span>
<span class="normal"><a href="#__codelineno-221-32">32</a></span>
<span class="normal"><a href="#__codelineno-221-33">33</a></span>
<span class="normal"><a href="#__codelineno-221-34">34</a></span>
<span class="normal"><a href="#__codelineno-221-35">35</a></span>
<span class="normal"><a href="#__codelineno-221-36">36</a></span>
<span class="normal"><a href="#__codelineno-221-37">37</a></span>
<span class="normal"><a href="#__codelineno-221-38">38</a></span>
<span class="normal"><a href="#__codelineno-221-39">39</a></span>
<span class="normal"><a href="#__codelineno-221-40">40</a></span>
<span class="normal"><a href="#__codelineno-221-41">41</a></span>
<span class="normal"><a href="#__codelineno-221-42">42</a></span>
<span class="normal"><a href="#__codelineno-221-43">43</a></span>
<span class="normal"><a href="#__codelineno-221-44">44</a></span>
<span class="normal"><a href="#__codelineno-221-45">45</a></span>
<span class="normal"><a href="#__codelineno-221-46">46</a></span>
<span class="normal"><a href="#__codelineno-221-47">47</a></span>
<span class="normal"><a href="#__codelineno-221-48">48</a></span>
<span class="normal"><a href="#__codelineno-221-49">49</a></span>
<span class="normal"><a href="#__codelineno-221-50">50</a></span>
<span class="normal"><a href="#__codelineno-221-51">51</a></span>
<span class="normal"><a href="#__codelineno-221-52">52</a></span>
<span class="normal"><a href="#__codelineno-221-53">53</a></span>
<span class="normal"><a href="#__codelineno-221-54">54</a></span>
<span class="normal"><a href="#__codelineno-221-55">55</a></span>
<span class="normal"><a href="#__codelineno-221-56">56</a></span>
<span class="normal"><a href="#__codelineno-221-57">57</a></span>
<span class="normal"><a href="#__codelineno-221-58">58</a></span>
<span class="normal"><a href="#__codelineno-221-59">59</a></span>
<span class="normal"><a href="#__codelineno-221-60">60</a></span>
<span class="normal"><a href="#__codelineno-221-61">61</a></span>
<span class="normal"><a href="#__codelineno-221-62">62</a></span>
<span class="normal"><a href="#__codelineno-221-63">63</a></span>
<span class="normal"><a href="#__codelineno-221-64">64</a></span>
<span class="normal"><a href="#__codelineno-221-65">65</a></span>
<span class="normal"><a href="#__codelineno-221-66">66</a></span>
<span class="normal"><a href="#__codelineno-221-67">67</a></span>
<span class="normal"><a href="#__codelineno-221-68">68</a></span>
<span class="normal"><a href="#__codelineno-221-69">69</a></span>
<span class="normal"><a href="#__codelineno-221-70">70</a></span>
<span class="normal"><a href="#__codelineno-221-71">71</a></span>
<span class="normal"><a href="#__codelineno-221-72">72</a></span>
<span class="normal"><a href="#__codelineno-221-73">73</a></span>
<span class="normal"><a href="#__codelineno-221-74">74</a></span>
<span class="normal"><a href="#__codelineno-221-75">75</a></span>
<span class="normal"><a href="#__codelineno-221-76">76</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-221-1" name="__codelineno-221-1"></a><span class="ch">#!/bin/bash</span>
<a id="__codelineno-221-2" name="__codelineno-221-2"></a><span class="c1"># chkconfig: - 30 21</span>
<a id="__codelineno-221-3" name="__codelineno-221-3"></a><span class="c1"># description: http service.</span>
<a id="__codelineno-221-4" name="__codelineno-221-4"></a><span class="c1"># Source Function Library</span>
<a id="__codelineno-221-5" name="__codelineno-221-5"></a>.<span class="w"> </span>/etc/init.d/functions
<a id="__codelineno-221-6" name="__codelineno-221-6"></a><span class="c1"># Nginx Settings</span>
<a id="__codelineno-221-7" name="__codelineno-221-7"></a>
<a id="__codelineno-221-8" name="__codelineno-221-8"></a><span class="nv">NGINX_SBIN</span><span class="o">=</span><span class="s2">&quot;/usr/local/nginx/sbin/nginx&quot;</span>
<a id="__codelineno-221-9" name="__codelineno-221-9"></a><span class="nv">NGINX_CONF</span><span class="o">=</span><span class="s2">&quot;/usr/local/nginx/conf/nginx.conf&quot;</span>
<a id="__codelineno-221-10" name="__codelineno-221-10"></a><span class="nv">NGINX_PID</span><span class="o">=</span><span class="s2">&quot;/usr/local/nginx/logs/nginx.pid&quot;</span>
<a id="__codelineno-221-11" name="__codelineno-221-11"></a><span class="nv">RETVAL</span><span class="o">=</span><span class="m">0</span>
<a id="__codelineno-221-12" name="__codelineno-221-12"></a><span class="nv">prog</span><span class="o">=</span><span class="s2">&quot;Nginx&quot;</span>
<a id="__codelineno-221-13" name="__codelineno-221-13"></a>
<a id="__codelineno-221-14" name="__codelineno-221-14"></a>start<span class="o">()</span><span class="w"> </span>
<a id="__codelineno-221-15" name="__codelineno-221-15"></a><span class="o">{</span>
<a id="__codelineno-221-16" name="__codelineno-221-16"></a><span class="w">    </span><span class="nb">echo</span><span class="w"> </span>-n<span class="w"> </span>$<span class="s2">&quot;Starting </span><span class="nv">$prog</span><span class="s2">: &quot;</span>
<a id="__codelineno-221-17" name="__codelineno-221-17"></a><span class="w">    </span>mkdir<span class="w"> </span>-p<span class="w"> </span>/dev/shm/nginx_temp
<a id="__codelineno-221-18" name="__codelineno-221-18"></a><span class="w">    </span>daemon<span class="w"> </span><span class="nv">$NGINX_SBIN</span><span class="w"> </span>-c<span class="w"> </span><span class="nv">$NGINX_CONF</span>
<a id="__codelineno-221-19" name="__codelineno-221-19"></a><span class="w">    </span><span class="nv">RETVAL</span><span class="o">=</span><span class="nv">$?</span>
<a id="__codelineno-221-20" name="__codelineno-221-20"></a><span class="w">    </span><span class="nb">echo</span>
<a id="__codelineno-221-21" name="__codelineno-221-21"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nv">$RETVAL</span>
<a id="__codelineno-221-22" name="__codelineno-221-22"></a><span class="o">}</span>
<a id="__codelineno-221-23" name="__codelineno-221-23"></a>
<a id="__codelineno-221-24" name="__codelineno-221-24"></a>stop<span class="o">()</span><span class="w"> </span>
<a id="__codelineno-221-25" name="__codelineno-221-25"></a><span class="o">{</span>
<a id="__codelineno-221-26" name="__codelineno-221-26"></a><span class="w">    </span><span class="nb">echo</span><span class="w"> </span>-n<span class="w"> </span>$<span class="s2">&quot;Stopping </span><span class="nv">$prog</span><span class="s2">: &quot;</span>
<a id="__codelineno-221-27" name="__codelineno-221-27"></a><span class="w">    </span>killproc<span class="w"> </span>-p<span class="w"> </span><span class="nv">$NGINX_PID</span><span class="w"> </span><span class="nv">$NGINX_SBIN</span><span class="w"> </span>-TERM
<a id="__codelineno-221-28" name="__codelineno-221-28"></a><span class="w">    </span>rm<span class="w"> </span>-rf<span class="w"> </span>/dev/shm/nginx_temp
<a id="__codelineno-221-29" name="__codelineno-221-29"></a><span class="w">    </span><span class="nv">RETVAL</span><span class="o">=</span><span class="nv">$?</span>
<a id="__codelineno-221-30" name="__codelineno-221-30"></a><span class="w">    </span><span class="nb">echo</span>
<a id="__codelineno-221-31" name="__codelineno-221-31"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nv">$RETVAL</span>
<a id="__codelineno-221-32" name="__codelineno-221-32"></a><span class="o">}</span>
<a id="__codelineno-221-33" name="__codelineno-221-33"></a>
<a id="__codelineno-221-34" name="__codelineno-221-34"></a>reload<span class="o">()</span>
<a id="__codelineno-221-35" name="__codelineno-221-35"></a><span class="o">{</span>
<a id="__codelineno-221-36" name="__codelineno-221-36"></a><span class="w">    </span><span class="nb">echo</span><span class="w"> </span>-n<span class="w"> </span>$<span class="s2">&quot;Reloading </span><span class="nv">$prog</span><span class="s2">: &quot;</span>
<a id="__codelineno-221-37" name="__codelineno-221-37"></a><span class="w">    </span>killproc<span class="w"> </span>-p<span class="w"> </span><span class="nv">$NGINX_PID</span><span class="w"> </span><span class="nv">$NGINX_SBIN</span><span class="w"> </span>-HUP
<a id="__codelineno-221-38" name="__codelineno-221-38"></a><span class="w">    </span><span class="nv">RETVAL</span><span class="o">=</span><span class="nv">$?</span>
<a id="__codelineno-221-39" name="__codelineno-221-39"></a><span class="w">    </span><span class="nb">echo</span>
<a id="__codelineno-221-40" name="__codelineno-221-40"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nv">$RETVAL</span>
<a id="__codelineno-221-41" name="__codelineno-221-41"></a><span class="o">}</span>
<a id="__codelineno-221-42" name="__codelineno-221-42"></a>
<a id="__codelineno-221-43" name="__codelineno-221-43"></a>restart<span class="o">()</span>
<a id="__codelineno-221-44" name="__codelineno-221-44"></a><span class="o">{</span>
<a id="__codelineno-221-45" name="__codelineno-221-45"></a><span class="w">    </span>stop
<a id="__codelineno-221-46" name="__codelineno-221-46"></a><span class="w">    </span>start
<a id="__codelineno-221-47" name="__codelineno-221-47"></a><span class="o">}</span>
<a id="__codelineno-221-48" name="__codelineno-221-48"></a>
<a id="__codelineno-221-49" name="__codelineno-221-49"></a>configtest<span class="o">()</span>
<a id="__codelineno-221-50" name="__codelineno-221-50"></a><span class="o">{</span>
<a id="__codelineno-221-51" name="__codelineno-221-51"></a><span class="w">    </span><span class="nv">$NGINX_SBIN</span><span class="w"> </span>-c<span class="w"> </span><span class="nv">$NGINX_CONF</span><span class="w"> </span>-t
<a id="__codelineno-221-52" name="__codelineno-221-52"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="m">0</span>
<a id="__codelineno-221-53" name="__codelineno-221-53"></a><span class="o">}</span>
<a id="__codelineno-221-54" name="__codelineno-221-54"></a>
<a id="__codelineno-221-55" name="__codelineno-221-55"></a><span class="k">case</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span><span class="w"> </span><span class="k">in</span>
<a id="__codelineno-221-56" name="__codelineno-221-56"></a><span class="w">  </span>start<span class="o">)</span>
<a id="__codelineno-221-57" name="__codelineno-221-57"></a><span class="w">        </span>start
<a id="__codelineno-221-58" name="__codelineno-221-58"></a><span class="w">        </span><span class="p">;;</span>
<a id="__codelineno-221-59" name="__codelineno-221-59"></a><span class="w">  </span>stop<span class="o">)</span>
<a id="__codelineno-221-60" name="__codelineno-221-60"></a><span class="w">        </span>stop
<a id="__codelineno-221-61" name="__codelineno-221-61"></a><span class="w">        </span><span class="p">;;</span>
<a id="__codelineno-221-62" name="__codelineno-221-62"></a><span class="w">  </span>reload<span class="o">)</span>
<a id="__codelineno-221-63" name="__codelineno-221-63"></a><span class="w">        </span>reload
<a id="__codelineno-221-64" name="__codelineno-221-64"></a><span class="w">        </span><span class="p">;;</span>
<a id="__codelineno-221-65" name="__codelineno-221-65"></a><span class="w">  </span>restart<span class="o">)</span>
<a id="__codelineno-221-66" name="__codelineno-221-66"></a><span class="w">        </span>restart
<a id="__codelineno-221-67" name="__codelineno-221-67"></a><span class="w">        </span><span class="p">;;</span>
<a id="__codelineno-221-68" name="__codelineno-221-68"></a><span class="w">  </span>configtest<span class="o">)</span>
<a id="__codelineno-221-69" name="__codelineno-221-69"></a><span class="w">        </span>configtest
<a id="__codelineno-221-70" name="__codelineno-221-70"></a><span class="w">        </span><span class="p">;;</span>
<a id="__codelineno-221-71" name="__codelineno-221-71"></a><span class="w">  </span>*<span class="o">)</span>
<a id="__codelineno-221-72" name="__codelineno-221-72"></a><span class="w">        </span><span class="nb">echo</span><span class="w"> </span>$<span class="s2">&quot;Usage: </span><span class="nv">$0</span><span class="s2"> {start|stop|reload|restart|configtest}&quot;</span>
<a id="__codelineno-221-73" name="__codelineno-221-73"></a><span class="w">        </span><span class="nv">RETVAL</span><span class="o">=</span><span class="m">1</span>
<a id="__codelineno-221-74" name="__codelineno-221-74"></a><span class="k">esac</span>
<a id="__codelineno-221-75" name="__codelineno-221-75"></a>
<a id="__codelineno-221-76" name="__codelineno-221-76"></a><span class="nb">exit</span><span class="w"> </span><span class="nv">$RETVAL</span>
</code></pre></div></td></tr></table></div>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-222-1">1</a></span>
<span class="normal"><a href="#__codelineno-222-2">2</a></span>
<span class="normal"><a href="#__codelineno-222-3">3</a></span>
<span class="normal"><a href="#__codelineno-222-4">4</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-222-1" name="__codelineno-222-1"></a>chmod<span class="w"> </span><span class="m">700</span><span class="w"> </span>/etc/init.d/nginx
<a id="__codelineno-222-2" name="__codelineno-222-2"></a>/etc/init.d/nginx<span class="w"> </span>start
<a id="__codelineno-222-3" name="__codelineno-222-3"></a>/etc/init.d/nginx<span class="w"> </span>stop
<a id="__codelineno-222-4" name="__codelineno-222-4"></a>/etc/init.d/nginx<span class="w"> </span>restart
</code></pre></div></td></tr></table></div>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Text Only</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-223-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-223-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-223-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-223-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-223-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-223-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-223-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-223-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-223-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-223-10">10</a></span>
<span class="normal"><a href="#__codelineno-223-11">11</a></span>
<span class="normal"><a href="#__codelineno-223-12">12</a></span>
<span class="normal"><a href="#__codelineno-223-13">13</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-223-1" name="__codelineno-223-1"></a>安装、升级（yum安装or源码安装、编译参数、安装路径等）
<a id="__codelineno-223-2" name="__codelineno-223-2"></a>服务管理（启动脚本、重启、重载、启动用户）
<a id="__codelineno-223-3" name="__codelineno-223-3"></a>配置规范
<a id="__codelineno-223-4" name="__codelineno-223-4"></a>Log格式、路径、命名规则和切割策略
<a id="__codelineno-223-5" name="__codelineno-223-5"></a>Pid路径
<a id="__codelineno-223-6" name="__codelineno-223-6"></a>虚拟主机（默认虚拟主机、虚拟主机独立）
<a id="__codelineno-223-7" name="__codelineno-223-7"></a>静态文件日志和过期缓存时间
<a id="__codelineno-223-8" name="__codelineno-223-8"></a>防盗链
<a id="__codelineno-223-9" name="__codelineno-223-9"></a>更改配置（使用自动化工具更改配置文件）
<a id="__codelineno-223-10" name="__codelineno-223-10"></a>安全规范
<a id="__codelineno-223-11" name="__codelineno-223-11"></a>后台地址加用户认证
<a id="__codelineno-223-12" name="__codelineno-223-12"></a>可写目录禁止解析php
<a id="__codelineno-223-13" name="__codelineno-223-13"></a>禁止访问.bak文件
</code></pre></div></td></tr></table></div>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  回到页面顶部
</button>
        
      </main>
      
        <footer class="md-footer">
  
    
      
      <nav class="md-footer__inner md-grid" aria-label="页脚" >
        
          
          <a href="../../../k8s%E5%92%8C%E5%AE%B9%E5%99%A8/Docker/Dokcer%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86/" class="md-footer__link md-footer__link--prev" aria-label="上一页: Dokcer实现原理">
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
            </div>
            <div class="md-footer__title">
              <span class="md-footer__direction">
                上一页
              </span>
              <div class="md-ellipsis">
                Dokcer实现原理
              </div>
            </div>
          </a>
        
        
          
          <a href="../../haproxy/haproxy%E5%AD%A6%E4%B9%A0/" class="md-footer__link md-footer__link--next" aria-label="下一页: Haproxy+Keeplived实践">
            <div class="md-footer__title">
              <span class="md-footer__direction">
                下一页
              </span>
              <div class="md-ellipsis">
                Haproxy+Keeplived实践
              </div>
            </div>
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11z"/></svg>
            </div>
          </a>
        
      </nav>
    
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy; 2025 李烨栋
    </div>
  
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../../..", "features": ["header.autohide", "announce.dismiss", "navigation.instant", "navigation.tracking", "content.code.annotate", "toc.integrate", "toc.follow", "navigation.path", "navigation.top", "navigation.tabs", "navigation.prune", "navigation.footer", "navigation.tabs.sticky", "navigation.sections", "navigation.expand", "content.code.copy", "navigation.indexes", "search.share", "search.suggest", "search.highlight"], "search": "../../../assets/javascripts/workers/search.f8cc74c7.min.js", "translations": {"clipboard.copied": "\u5df2\u590d\u5236", "clipboard.copy": "\u590d\u5236", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.term.missing": "\u7f3a\u5c11", "select.version": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}}</script>
    
    
      <script src="../../../assets/javascripts/bundle.c8b220af.min.js"></script>
      
    
  </body>
</html>